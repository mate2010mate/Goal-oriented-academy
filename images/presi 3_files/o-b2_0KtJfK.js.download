;/*FB_PKG_DELIM*/

__d("LSQueryBulkUtils",["ReQL"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,b){b=await Promise.all(b.map(function(b){return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a).getKeyRange(b))}));return b.flat()}async function b(a,b){await Promise.all(b.map(function(b){return a.put(b)}));return b}g.bulkGetByIndex=a;g.bulkPut=b}),98);
__d("WAMediaTransport.pb",["WACommon.pb","WAProtoConst"],(function(a,b,c,d,e,f,g){var h;a={NONE:0,LQ_4K:1,HQ_4K:2};b={NONE:0,GIPHY:1,TENOR:2};c={TALKING_A:0,IDLE_A:1,TALKING_B:2,IDLE_B:3,BACKGROUND:4};e={UNKNOWN:0,OPUS:1};f={};var i={},j={},k={},l={},m={},n={},o={},p={},q={},r={},s={},t={},u={},v={},w={},x={},y={},z={},A={},B={},C={},D={},E={},F={};f.internalSpec={integral:[1,(h=d("WAProtoConst")).TYPES.MESSAGE,l],ancillary:[2,h.TYPES.MESSAGE,i]};i.internalSpec={fileLength:[1,h.TYPES.UINT64],mimetype:[2,h.TYPES.STRING],thumbnail:[3,h.TYPES.MESSAGE,j],objectId:[4,h.TYPES.STRING]};j.internalSpec={jpegThumbnail:[1,h.TYPES.BYTES],downloadableThumbnail:[2,h.TYPES.MESSAGE,k],thumbnailWidth:[3,h.TYPES.UINT32],thumbnailHeight:[4,h.TYPES.UINT32]};k.internalSpec={fileSha256:[1,h.TYPES.BYTES],fileEncSha256:[2,h.TYPES.BYTES],directPath:[3,h.TYPES.STRING],mediaKey:[4,h.TYPES.BYTES],mediaKeyTimestamp:[5,h.TYPES.INT64],objectId:[6,h.TYPES.STRING],thumbnailScansSidecar:[7,h.TYPES.BYTES],thumbnailScanLengths:[8,h.FLAGS.REPEATED|h.TYPES.UINT32]};l.internalSpec={fileSha256:[1,h.TYPES.BYTES],mediaKey:[2,h.TYPES.BYTES],fileEncSha256:[3,h.TYPES.BYTES],directPath:[4,h.TYPES.STRING],mediaKeyTimestamp:[5,h.TYPES.INT64]};m.internalSpec={integral:[1,h.TYPES.MESSAGE,o],ancillary:[2,h.TYPES.MESSAGE,n]};n.internalSpec={height:[1,h.TYPES.UINT32],width:[2,h.TYPES.UINT32],scansSidecar:[3,h.TYPES.BYTES],scanLengths:[4,h.FLAGS.REPEATED|h.TYPES.UINT32],midQualityFileSha256:[5,h.TYPES.BYTES],hdType:[6,h.TYPES.ENUM,a]};o.internalSpec={transport:[1,h.TYPES.MESSAGE,f]};p.internalSpec={integral:[1,h.TYPES.MESSAGE,r],ancillary:[2,h.TYPES.MESSAGE,q]};q.internalSpec={seconds:[1,h.TYPES.UINT32],caption:[2,h.TYPES.MESSAGE,d("WACommon.pb").MessageTextSpec],gifPlayback:[3,h.TYPES.BOOL],height:[4,h.TYPES.UINT32],width:[5,h.TYPES.UINT32],sidecar:[6,h.TYPES.BYTES],gifAttribution:[7,h.TYPES.ENUM,b]};r.internalSpec={transport:[1,h.TYPES.MESSAGE,f]};s.internalSpec={integral:[1,h.TYPES.MESSAGE,w],ancillary:[2,h.TYPES.MESSAGE,t]};t.internalSpec={seconds:[1,h.TYPES.UINT32],avatarAudio:[2,h.TYPES.MESSAGE,u]};u.internalSpec={poseId:[1,h.TYPES.UINT32],avatarAnimations:[2,h.FLAGS.REPEATED|h.TYPES.MESSAGE,v]};v.internalSpec={fileSha256:[1,h.TYPES.BYTES],fileEncSha256:[2,h.TYPES.BYTES],directPath:[3,h.TYPES.STRING],mediaKey:[4,h.TYPES.BYTES],mediaKeyTimestamp:[5,h.TYPES.INT64],objectId:[6,h.TYPES.STRING],animationsType:[7,h.TYPES.ENUM,c]};w.internalSpec={transport:[1,h.TYPES.MESSAGE,f],audioFormat:[2,h.TYPES.ENUM,e]};x.internalSpec={integral:[1,h.TYPES.MESSAGE,z],ancillary:[2,h.TYPES.MESSAGE,y]};y.internalSpec={pageCount:[1,h.TYPES.UINT32]};z.internalSpec={transport:[1,h.TYPES.MESSAGE,f]};A.internalSpec={integral:[1,h.TYPES.MESSAGE,C],ancillary:[2,h.TYPES.MESSAGE,B]};B.internalSpec={pageCount:[1,h.TYPES.UINT32],height:[2,h.TYPES.UINT32],width:[3,h.TYPES.UINT32],firstFrameLength:[4,h.TYPES.UINT32],firstFrameSidecar:[5,h.TYPES.BYTES],mustacheText:[6,h.TYPES.STRING],isThirdParty:[7,h.TYPES.BOOL],receiverFetchId:[8,h.TYPES.STRING]};C.internalSpec={transport:[1,h.TYPES.MESSAGE,f],isAnimated:[2,h.TYPES.BOOL],receiverFetchId:[3,h.TYPES.STRING]};D.internalSpec={integral:[1,h.TYPES.MESSAGE,F],ancillary:[2,h.TYPES.MESSAGE,E]};E.internalSpec={displayName:[1,h.TYPES.STRING]};F.internalSpec={vcard:[1,h.TYPES.STRING],downloadableVcard:[2,h.TYPES.MESSAGE,f],__oneofs__:{contact:["vcard","downloadableVcard"]}};g.IMAGE_TRANSPORT_ANCILLARY_HD_TYPE=a;g.VIDEO_TRANSPORT_ANCILLARY_ATTRIBUTION=b;g.AUDIO_TRANSPORT_ANCILLARY_AVATAR_AUDIO_ANIMATIONS_TYPE=c;g.AUDIO_TRANSPORT_INTEGRAL_AUDIO_FORMAT=e;g.WAMediaTransportSpec=f;g.WAMediaTransport$AncillarySpec=i;g.WAMediaTransport$Ancillary$ThumbnailSpec=j;g.WAMediaTransport$Ancillary$Thumbnail$DownloadableThumbnailSpec=k;g.WAMediaTransport$IntegralSpec=l;g.ImageTransportSpec=m;g.ImageTransport$AncillarySpec=n;g.ImageTransport$IntegralSpec=o;g.VideoTransportSpec=p;g.VideoTransport$AncillarySpec=q;g.VideoTransport$IntegralSpec=r;g.AudioTransportSpec=s;g.AudioTransport$AncillarySpec=t;g.AudioTransport$Ancillary$AvatarAudioSpec=u;g.AudioTransport$Ancillary$AvatarAudio$DownloadableAvatarAnimationsSpec=v;g.AudioTransport$IntegralSpec=w;g.DocumentTransportSpec=x;g.DocumentTransport$AncillarySpec=y;g.DocumentTransport$IntegralSpec=z;g.StickerTransportSpec=A;g.StickerTransport$AncillarySpec=B;g.StickerTransport$IntegralSpec=C;g.ContactTransportSpec=D;g.ContactTransport$AncillarySpec=E;g.ContactTransport$IntegralSpec=F}),98);
__d("validateMAWMediaAndComposeEntryForProtoMsg",["WAMediaUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){if(b==null)throw c("err")("DbMedia is null in validateMediaAndComposeEntryForProtoMsg");if(!b.msgIds.includes(a))throw c("err")("the media ("+b.mediaId+") is not linked to the msg ("+a+")");a=b.mediaEntries.get(a);if(a==null)throw c("err")("media entry not found in validateMediaAndComposeEntryForProtoMsg");var e=b.plaintextHash,f=d("WAMediaUtils").mediaEntryDataToRawData(e,a);e=["fileSha256","mediaKey","fileEncSha256","directPath","mediaKeyTimestamp"];a=e.filter(function(a){return f[a]==null});if(a.length>0)throw c("err")("missing fields in mediaEntryData: "+a.toString());return[b,f]}g["default"]=a}),98);
__d("MAWAsConsumerApplication",["I64","LSIntEnum","MAWDbMedia","MAWJids","MAWMsgType","MAWVault","WAAssertUnreachable","WAConsumerApplication.pb","WAGlobals","WAJids","WAMediaTransport.pb","encodeMAWDocumentFileMessage","encodeProtobuf","err","gkx","validateMAWMediaAndComposeEntryForProtoMsg"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j="image/jpeg",k="video/mp4",l="audio/wav",m="image/gif",n="image/webp",o=c("gkx")("4644")?"application/octet-stream":"application/pdf",p=new ArrayBuffer(0);function a(a,b,e){switch(a.type){case d("MAWMsgType").MSG_TYPE.TEXT:return r(a);case d("MAWMsgType").MSG_TYPE.IMAGE:return s(a,b);case d("MAWMsgType").MSG_TYPE.VIDEO:return z(a,b);case d("MAWMsgType").MSG_TYPE.PTT:return C(a,b);case d("MAWMsgType").MSG_TYPE.REVOKED:return F(a);case d("MAWMsgType").MSG_TYPE.GIF:return z(a,b);case d("MAWMsgType").MSG_TYPE.STICKER:return w(a,b);case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return c("encodeMAWDocumentFileMessage")(a,b);case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE:case d("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION:return null;case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:throw c("err")("Implemented ephemeral setting message in MAWAsConsumerApplication");case d("MAWMsgType").MSG_TYPE.XMA:throw c("err")("XMA content message is not consumer application. It should be addressed as ArmadilloApplication");case d("MAWMsgType").MSG_TYPE.FUTUREPROOF:case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:case d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case d("MAWMsgType").MSG_TYPE.ADMIN:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:case d("MAWMsgType").MSG_TYPE.ICDC_ALERT:case d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:throw c("err")("We do not support converting to protoMsg with "+a.type+" type","maw_db");case d("MAWMsgType").MSG_TYPE.RAVEN:case d("MAWMsgType").MSG_TYPE.RAVEN_ACTION:throw c("err")("Raven content message is not consumer application. It should be addressed as ArmadilloApplication");case d("MAWMsgType").MSG_TYPE.EDIT_ACTION:throw c("err")("We do not support editing messages right now since the sending flow is not implemented yet. ");case d("MAWMsgType").MSG_TYPE.GROUP_INVITE:return G(a,e);case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:throw c("err")("Sending bump messages is not supported yet.");case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:throw c("err")("Sending receiver fetch messages is not supported yet.");default:return c("WAAssertUnreachable")(a.type)}}function b(a,b){if(b==null)return q(a);else switch(b.mediaType){case d("MAWDbMedia").MEDIA_TYPE.IMAGE:return t(a.msgId,b);case d("MAWDbMedia").MEDIA_TYPE.VIDEO:return A(a.msgId,b);case d("MAWDbMedia").MEDIA_TYPE.PTT:return D(a.msgId,b);case d("MAWDbMedia").MEDIA_TYPE.GIF:return A(a.msgId,b);case d("MAWDbMedia").MEDIA_TYPE.STICKER:return x(a.msgId,b);default:return null}}function q(a){var b=null;if(a.type===d("MAWMsgType").MSG_TYPE.REVOKED&&a.msgContent!=null&&a.msgContent.content!=null)b=a.msgContent.content;else if(a.type===d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME&&a.msgContent!=null)b=a.msgContent;else return null;return{payload:{content:{messageText:{mentionedJid:[],text:d("MAWVault").unvault(b)}}}}}function r(a){var b={payload:{content:{messageText:{mentionedJid:a.msgContent.mentionedJids,text:d("MAWVault").unvault(a.msgContent.content)}}}};if(a.specialTextSize!=null){a=a.specialTextSize===1?d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.SMALL:a.specialTextSize===2?d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.MEDIUM:d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.LARGE;b.metadata={specialTextSize:a}}return b}function s(a,b){return t(a.msgId,b)}function t(a,b){a=c("validateMAWMediaAndComposeEntryForProtoMsg")(a,b);b=a[0];a=a[1];return v(b,a)}function u(a,b){var c;a={ancillary:{height:(c=a.validatedImageInfo)==null?void 0:c.height,scanLengths:((c=b.progressiveJpegDetails)==null?void 0:c.scanLengths)||[],scansSidecar:(c=b.progressiveJpegDetails)==null?void 0:c.sidecar,width:(c=a.validatedImageInfo)==null?void 0:c.width},integral:{transport:{ancillary:{fileLength:a.size,mimetype:j,objectId:b.objectId,thumbnail:{downloadableThumbnail:b.downloadableThumbnail,jpegThumbnail:void 0,thumbnailHeight:(c=a.validatedImageInfo)==null?void 0:c.jpegThumbnailHeight,thumbnailWidth:(c=a.validatedImageInfo)==null?void 0:c.jpegThumbnailWidth}},integral:{directPath:b.directPath,fileEncSha256:b.fileEncSha256,fileSha256:b.fileSha256,mediaKey:b.mediaKey,mediaKeyTimestamp:b.mediaKeyTimestamp}}}};return d("encodeProtobuf").encodeProtobuf(d("WAMediaTransport.pb").ImageTransportSpec,a).readBuffer()}function v(a,b){a=u(a,b);return{payload:{content:{imageMessage:{caption:{mentionedJid:[]},image:{payload:a,version:1}}}}}}function e(a){return{payload:{content:{editMessage:{key:{fromMe:!0,id:a.originalMsgExternalId,remoteJid:a.threadJid},message:{mentionedJid:a.msgContent.mentionedJids,text:d("MAWVault").unvault(a.msgContent.content)},timestampMs:a.editTs*1e3}}}}}function w(a,b){return x(a.msgId,b)}function x(a,b){a=c("validateMAWMediaAndComposeEntryForProtoMsg")(a,b);b=a[0];a=a[1];return y(b,a)}function y(a,b){var c;a={ancillary:{height:(c=a.validatedImageInfo)==null?void 0:c.height,width:(c=a.validatedImageInfo)==null?void 0:c.width},integral:{transport:{ancillary:{fileLength:a.size,mimetype:n,objectId:b.objectId,thumbnail:{thumbnailHeight:(c=a.validatedImageInfo)==null?void 0:c.jpegThumbnailHeight,thumbnailWidth:(c=a.validatedImageInfo)==null?void 0:c.jpegThumbnailWidth}},integral:{directPath:b.directPath,fileEncSha256:b.fileEncSha256,fileSha256:b.fileSha256,mediaKey:b.mediaKey,mediaKeyTimestamp:b.mediaKeyTimestamp}}}};c=d("encodeProtobuf").encodeProtobuf(d("WAMediaTransport.pb").StickerTransportSpec,a);return{payload:{content:{stickerMessage:{sticker:{payload:c.readBuffer(),version:1}}}}}}function z(a,b){return A(a.msgId,b)}function A(a,b){a=c("validateMAWMediaAndComposeEntryForProtoMsg")(a,b);b=a[0];a=a[1];return B(b,a)}function B(a,b){var c,e=a.mediaType===d("MAWDbMedia").MEDIA_TYPE.GIF,f=e?a.validatedImageInfo:a.validatedVideoInfo;c={ancillary:{gifPlayback:e,height:f==null?void 0:f.height,seconds:e?void 0:(c=a.validatedVideoInfo)==null?void 0:c.duration,sidecar:b.sidecar,width:f==null?void 0:f.width},integral:{transport:{ancillary:{fileLength:a.size,mimetype:e?m:k,objectId:b.objectId,thumbnail:e?{thumbnailHeight:f==null?void 0:f.jpegThumbnailHeight,thumbnailWidth:f==null?void 0:f.jpegThumbnailWidth}:{downloadableThumbnail:b.downloadableThumbnail,jpegThumbnail:void 0,thumbnailHeight:f==null?void 0:f.jpegThumbnailHeight,thumbnailWidth:f==null?void 0:f.jpegThumbnailWidth}},integral:{directPath:b.directPath,fileEncSha256:b.fileEncSha256,fileSha256:b.fileSha256,mediaKey:b.mediaKey,mediaKeyTimestamp:b.mediaKeyTimestamp}}}};a=d("encodeProtobuf").encodeProtobuf(d("WAMediaTransport.pb").VideoTransportSpec,c);return{payload:{content:{videoMessage:{caption:{mentionedJid:[]},video:{payload:a.readBuffer(),version:1}}}}}}function C(a,b){return D(a.msgId,b)}function D(a,b){a=c("validateMAWMediaAndComposeEntryForProtoMsg")(a,b);b=a[0];a=a[1];return E(b,a)}function E(a,b){var e;e={ancillary:{seconds:(e=a.validatedAudioInfo)==null?void 0:e.duration},integral:{audioFormat:c("gkx")("3532")?d("WAMediaTransport.pb").AUDIO_TRANSPORT_INTEGRAL_AUDIO_FORMAT.OPUS:void 0,transport:{ancillary:{fileLength:a.size,mimetype:l,objectId:b.objectId,thumbnail:{jpegThumbnail:p}},integral:{directPath:b.directPath,fileEncSha256:b.fileEncSha256,fileSha256:b.fileSha256,mediaKey:b.mediaKey,mediaKeyTimestamp:b.mediaKeyTimestamp}}}};a=d("encodeProtobuf").encodeProtobuf(d("WAMediaTransport.pb").AudioTransportSpec,e);return{payload:{content:{audioMessage:{audio:{payload:a.readBuffer(),version:1},ptt:!0}}}}}function F(a){return{payload:{applicationData:{revoke:{key:{fromMe:!0,id:a.revokedExternalId}}}}}}function f(a){var b=d("WAJids").isAuthorMe(a.reactToAuthor)||d("WAGlobals").getMyUserJid()===a.reactToAuthor,c=d("WAJids").interpretAsGroupJid(a.threadJid)!=null;c={groupingKey:a.groupingKey==null?void 0:a.groupingKey,key:{fromMe:b,id:a.reactToExternalId,participant:c&&!b?a.reactToAuthor:void 0,remoteJid:a.threadJid},senderTimestampMs:a.ts*1e3,text:a.reaction==null?void 0:a.reaction};return{payload:{content:{reactionMessage:c}}}}function G(a,b){if(a.threadJid==null)throw c("err")("msg threadJid is null in encodeGroupInviteMessage");if(b==null)throw c("err")("DbGroupInvite is null in encodeGroupInviteMessage");var e=d("WAJids").interpretAsGroupJid(a.threadJid);if(e==null)throw c("err")("groupJid is null in encodeGroupInviteMessage");return{payload:{content:{groupInviteMessage:{groupJid:e,groupName:a.groupName,inviteCode:b.inviteCode,inviteExpiration:b.inviteExpirationTs}}}}}function H(a){return(h||(h=d("I64"))).equal(a.displayedContentTypes,(i||(i=d("LSIntEnum"))).ofNumber(1))||(h||(h=d("I64"))).equal(a.displayedContentTypes,(i||(i=d("LSIntEnum"))).ofNumber(256))||a.textHasLinks||a.isUnsent?I(a):null}function I(a){var b;b=(b=a.mentionIds)==null?void 0:(b=b.split(","))==null?void 0:b.map(d("MAWJids").toUserJid);return{payload:{content:{messageText:{mentionedJid:(b=b)!=null?b:[],text:a.text}}}}}g.IMAGE_MIME_TYPE=j;g.VIDEO_MIME_TYPE=k;g.AUDIO_MIME_TYPE=l;g.GIF_MIME_TYPE=m;g.STICKER_MIME_TYPE=n;g.FILE_MIME_TYPE=o;g.emptyAudioFileArrayBuffer=p;g.asConsumerApplication=a;g.deletedMsgAsConsumerApplicationForSpamReporting=b;g.encodeValidatedMediaToImageTransport=u;g.encodeEditMessage=e;g.encodeReactionMessage=f;g.asConsumerApplicationLSDb=H}),98);
__d("encodeMAWDocumentFileMessage",["MAWAsConsumerApplication","WAMediaTransport.pb","encodeProtobuf","validateMAWMediaAndComposeEntryForProtoMsg"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return h(a.msgId,b)}function h(a,b){a=c("validateMAWMediaAndComposeEntryForProtoMsg")(a,b);b=a[0];a=a[1];return i(b,a)}function i(a,b){b={ancillary:{},integral:{transport:{ancillary:{fileLength:a.size,mimetype:d("MAWAsConsumerApplication").FILE_MIME_TYPE,objectId:b.objectId,thumbnail:{jpegThumbnail:new ArrayBuffer(1),thumbnailHeight:1,thumbnailWidth:1}},integral:{directPath:b.directPath,fileEncSha256:b.fileEncSha256,fileSha256:b.fileSha256,mediaKey:b.mediaKey,mediaKeyTimestamp:b.mediaKeyTimestamp}}}};b=d("encodeProtobuf").encodeProtobuf(d("WAMediaTransport.pb").DocumentTransportSpec,b);return{payload:{content:{documentMessage:{document:{payload:b.readBuffer(),version:1},fileName:(b=a.validatedDocumentFileInfo)==null?void 0:b.filename}}}}}g["default"]=a}),98);
__d("MAWBridgeXMA",["MAWBridgeUIEventDataValidation","MAWDbMedia","WALogger","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWBridge - createBridgeXMA received unexpected media type - ",""]);h=function(){return a};return a}function i(a){if(a==null)return void 0;switch(a){case"Image":case"Sticker":return"image/png";case"Gif":return"image/gif";case"Video":return"video/mp4";case"Ptt":return"audio/wav"}}function a(a,b,e){var f=b.contentRef,g=b.ctas,j=b.defaultCTA,k=b.defaultPreviewMediaId,l=b.faviconMediaId,m=b.headerMediaId,n=b.headerTitle,o=b.maxSubtitleNumOfLines,p=b.maxTitleNumOfLines,q=b.msgId,r=b.offlineAttachmentId,s=b.overlayIconGlyph,t=b.overlayTitle,u=b.subtitleText,v=b.targetId,w=b.targetType,x=b.targetUsername,y=b.threadJid,z=b.titleText,A=b.xmaId;b=b.xmaLayoutType;a!=null&&a.mediaType!==d("MAWDbMedia").IMAGE&&d("WALogger").WARN(h(),a.mediaType);v!=null&&d("MAWBridgeUIEventDataValidation").stringToI64Opt(v);return{contentRef:f,ctas:g,defaultCTA:j,defaultPreviewMediaId:k,duration:null,faviconMediaId:l,filesize:a==null?void 0:a.size,hasMedia:c("gkx")("821")?e:void 0,headerMediaId:m,headerTitle:n,maxSubtitleNumOfLines:o,maxTitleNumOfLines:p,mediaType:a==null?void 0:a.mediaType,msgId:q,offlineAttachmentId:r,overlayIconGlyph:s,overlayTitle:t,playableUrlMimeType:i(a==null?void 0:a.mediaType),previewHeight:a==null?void 0:(f=a.validatedImageInfo)==null?void 0:f.jpegThumbnailHeight,previewHeightLarge:a==null?void 0:(g=a.validatedImageInfo)==null?void 0:g.height,previewUrlMimeType:i(a==null?void 0:a.mediaType),previewWidth:a==null?void 0:(j=a.validatedImageInfo)==null?void 0:j.jpegThumbnailWidth,previewWidthLarge:a==null?void 0:(k=a.validatedImageInfo)==null?void 0:k.width,subtitleText:u,targetId:v,targetType:w,targetUsername:x,threadJid:y,titleText:z,ts:a==null?void 0:a.ts,xmaId:A,xmaLayoutType:b}}function b(a,b){var c=a.msgId;a=a.threadJid;return{msgId:c,threadJid:a,xmaId:b}}function e(a,b){var c=a.msgId;a=a.threadJid;return{msgId:c,threadJid:a,xmaId:b}}g.createBridgeXMA=a;g.createBridgeXMAShareExpired=b;g.createBridgeXMAShareTombstoned=e}),98);
__d("MAWUnsafeCoerce",[],(function(a,b,c,d,e,f){"use strict";function a(a){return a}f.unsafeCoerce=a}),66);
__d("MAWBulkEditMsgsTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbEditMsgHistory","MAWDbEditMsgHistoryTxns","MAWDbMessageHandler","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWThreadSnippetForTextMsg","MAWUnsafeCoerce","WAGlobals","WAJids","WAMsgMap","WAMsgType","err"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,e){var f=[];for(var g=0;g<a.length;g++){var h=a[g],i=d("MAWJidUtils").maybeToProtocolMsgId(h.author,h.threadJid,h.originalMsgExternalId);if(i!=null){i=(i=e.get(i))==null?void 0:i.msgId;i!=null?f.push(babelHelpers["extends"]({},h,{editMsgHistoryId:d("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(b[g]),originalMsgId:i})):c("FBLogger")("messenger_e2ee_web").warn("[edit messagehistory] Failed to get the original msgId for a msg that has been edited.")}}d("MAWIndexedDb").afterTransaction({tag:"EditMsgHistoryAdded",value:f})}function a(a,b){var c=new Set(),e=[];b.forEach(function(a){var b=a.chatJid;a=a.msg;c.add(b);e.push(a.originalMsgExternalId)});return d("MAWDexieTable").dexieAll([a.messages.where("externalId").anyOf(e).toArray(),a.messages.where("quoteExternalId").anyOf(e).toArray(),a.editMsgHistory.where("originalMsgExternalId").anyOf(e).toArray(),a.threads.where("jid").anyOf(Array.from(c)).toArray()]).then(function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return{editMsgHistory:d,originalMsgs:b,quoteMessages:c,threads:a}})}function i(a,b,e){var f=new Map();b.values().forEach(function(a){var b;b=(b=a.threadJid)!=null?b:d("WAJids").unsafeCoerceToChatJid("");if(f.has(b)){var c;(c=f.get(b))==null?void 0:c.push(a)}else f.set(b,[a])});b=e.map(function(b){return d("MAWDbMsgTxns").getThreadNewestMessageId(a,b.jid).then(function(a){return{editedMsgsInThread:f.get(b.jid),newestMsgId:a,thread:b}})});return d("MAWDexieTable").dexieAll(b).then(function(a){a.forEach(function(a){var b=a.editedMsgsInThread,e=a.newestMsgId;a=a.thread;if(a==null||b==null)return;b=b.filter(function(a){return a.msgId===e})[0];if(b!=null&&!d("MAWDbMessageHandler").isThreadUpdateEnabledViaMiddlewareForMsgType(b.type)){var f=b.author;if(f==="@system")throw c("err")("[edit message] author should not be @system.");f=d("WAJids").userIdFromJid(f==="@me"?d("WAGlobals").getMyUserJid():f);b=c("MAWThreadSnippetForTextMsg")(b,f,d("WAJids").interpretAsGroupJid(a.jid)!=null);var g=b.snippetParams;b=b.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:g,snippetSenderContactId:f,snippetType:b,threadJid:a.jid})})}})})}function b(a,b,e){var f=e.editMsgHistory,g=e.originalMsgs,j=e.quoteMessages,l=e.threads,m=g.reduce(function(a,b){var c=d("MAWJidUtils").toProtocolMsgId(b);return c==null?a:a.set(c,b)},new(d("WAMsgMap").MsgMap)());e=f.reduce(function(a,b){var c=d("MAWJidUtils").toProtocolMsgId(b);return c==null?a:a.set(c,b)},new(d("WAMsgMap").MsgMap)());g=k(b,{messageHistoriesToEdit:e,messagesToEdit:m});var n=g[0],o=g[1],p=g[2];return d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,n,!1).then(function(b){h(n,b,m);var e=new(d("WAMsgMap").MsgMap)();o.entries().forEach(function(a){var b=a[0];a=a[1];var f=m.get(b);if(f==null){c("FBLogger")("messenger_e2ee_web").warn("Cannot find the original msg for the edit action.");return}if(f.type!==d("WAMsgType").MSG_TYPE.TEXT&&f.type!==d("WAMsgType").MSG_TYPE.CIPHERTEXT)throw c("err")("Only text or cipher text can be edited. Original msg type: %s",f.type);f=babelHelpers["extends"]({},f,{editCount:((f=f.editCount)!=null?f:0)+((f=p.get(b))!=null?f:0),msgContent:a.editMsgContent,type:d("WAMsgType").MSG_TYPE.TEXT});e.set(b,f)});return i(a,e,l).then(function(){var b=j.map(function(a){var b=a.quote,f=a.quoteExternalId,g=a.threadJid;if(b==null){c("FBLogger")("messenger_e2ee_web").warn("[edit message] Failed to get the quoted content for a msg that has been quoted.",a.externalId);return}g=d("MAWJidUtils").maybeToProtocolMsgId(b.content.author,g,f);if(g==null)return;f=e.get(g);if(f==null)return;return babelHelpers["extends"]({},a,{quote:babelHelpers["extends"]({},b,{content:babelHelpers["extends"]({},b.content,{msgContent:babelHelpers["extends"]({},f.msgContent)})})})}).filter(Boolean);return a.messages.bulkPut(e.values().concat(b)).then(function(){e.values().forEach(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,void 0,a)})})})}).then(function(){b.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a)})})})})})}function j(a,b){var e;switch(a.type){case d("WAMsgType").MSG_TYPE.TEXT:case d("WAMsgType").MSG_TYPE.EDIT_ACTION:return{author:a.author,editExternalId:a.externalId,editTs:(e=a.serverTs)!=null?e:a.ts,msgContent:(e=a.editMsgContent)!=null?e:d("MAWUnsafeCoerce").unsafeCoerce(a.msgContent),originalMsgExternalId:(e=a.originalMsgExternalId)!=null?e:a.externalId,sendStatus:d("MAWAckLevel").ACK.sent,specialTextSize:a.specialTextSize,threadJid:b};case d("WAMsgType").MSG_TYPE.CIPHERTEXT:return{author:a.author,editExternalId:a.externalId,editTs:(e=a.serverTs)!=null?e:a.ts,msgContent:{content:""},originalMsgExternalId:a.externalId,sendStatus:d("MAWAckLevel").ACK.sent,specialTextSize:a.specialTextSize,threadJid:b};default:a.type;throw c("err")("MAWBulkEditMsgsTxns::getMessageHistory: Unexpected msg type")}}function k(a,b){var e=b.messageHistoriesToEdit,f=b.messagesToEdit,g=[],h=new(d("WAMsgMap").MsgMap)(),i=new(d("WAMsgMap").MsgMap)();a.forEach(function(a){var b=a.chatJid;a=a.msg;var k=d("MAWJidUtils").maybeToProtocolMsgId(a.author,b,a.originalMsgExternalId);if(k==null)throw c("err")("[protocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",d("WAJids").isAuthorSystem(a.author),!!b,!!a.originalMsgExternalId);var l=d("MAWJidUtils").maybeToProtocolMsgId(a.author,b,a.externalId);if(l==null)throw c("err")("[editMsgProtocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",d("WAJids").isAuthorSystem(a.author),!!b,!!a.externalId);if(e.get(l)==null){g.push(j(a,b));l=(l=i.get(k))!=null?l:0;var m=f.get(k);i.set(k,l+1);if(e.get(k)==null&&l===0&&m!=null){if(m.type!==d("WAMsgType").MSG_TYPE.TEXT&&m.type!==d("WAMsgType").MSG_TYPE.CIPHERTEXT)throw c("err")("Only text or cipher text can be edited. Original msg type: %s",m.type);g.push(j(m,b))}}l=h.get(k);m=l==null?void 0:l.serverTs;b=a==null?void 0:a.serverTs;(m==null||b==null||m<b)&&h.set(k,a)});return[g,h,i]}g.prepareDataForMessageEdit=a;g.bulkEditMsgs=b;g.getMessageHistory=j}),98);
__d("MAWDbReactionUtils",["MAWBridgeTypesCreators","MAWIndexedDb"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.author,c=a.reaction,e=a.reactToMsgId,f=a.threadJid;a=a.ts;if(e==null)return;d("MAWIndexedDb").afterTransaction(c==null?{tag:"DeleteReaction",value:d("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:b,chatJid:f,reactToMsgId:e})}:{tag:"UpsertReaction",value:d("MAWBridgeTypesCreators").createBridgeUpsertReaction({author:b,chatJid:f,reaction:c||"",reactToMsgId:e,ts:a})})}g.dispatchReaction=a}),98);
__d("WAArrayGroupBy",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c=new Map();for(var d=0;d<a.length;d++){var e=b(a[d]),f=c.get(e);f==null?c.set(e,[a[d]]):f.push(a[d])}return Array.from(c.entries())}f.groupBy=a}),66);
__d("MAWBulkPutReactionsWithThreadUpdateTxn",["MAWBridgeBuildThreadSnippet","MAWBridgeTypesCreators","MAWBridgeUIEventDataValidation","MAWDbReaction","MAWDbReactionUtils","MAWDbReactionsTxns","MAWDexieTable","MAWJidUtils","MAWThreadSnippetBuildTxns","MAWTransactor","Promise","WAArrayGroupBy","WAJids","WAMsgMap","asyncToGeneratorRuntime","cr:3061","err","qex"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){return a.reduce(function(a,b){var c=d("MAWJidUtils").maybeToProtocolMsgId(b.author,b.threadJid,b.reactToExternalId);if(c==null)return a;a.set(c,d("MAWDbReactionsTxns").coerceToReaction(b));return a},new(d("WAMsgMap").MsgMap)()).values()}function a(a,e,f){if(e.length===0)return d("MAWDexieTable").dexieResolve();e=i(e);var g=e.map(function(a){var b=f.get(a.threadJid);if(b==null)throw c("err")("Should not have got here - expect thread to exist for flow");c("qex")._("1215")!==!0&&d("MAWDbReactionUtils").dispatchReaction(a);return a});e=d("WAArrayGroupBy").groupBy(g,function(a){a=a.threadJid;return a});e=e.map(function(b){var c=b[0];b=b[1];c=f.get(c);if(c==null||b.length===0)return null;var e=null;for(var g=b.length-1;g>=0;g--){e=d("MAWDbReaction").castToIncomingDbReaction(b[g]);if(e!=null)break}g=b.filter(function(a){return a.reaction==null});b=d("WAJids").interpretAsGroupJid(c.jid)!=null;return d("MAWThreadSnippetBuildTxns").getThreadChangesetForReactionChanges(a,c,{newestReaction:e,reactionsToClear:g},b)}).filter(Boolean);return d("MAWDexieTable").dexieAll(e).then(function(e){return d("MAWDexieTable").dexieAll([a.threads.bulkPut(e.map(function(a){a=a.thread;return a})),a.reactions.bulkPut(g)]).then(function(){if(c("qex")._("1215")===!0&&b("cr:3061")!=null)return d("MAWTransactor").runInLSDB(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield (h||(h=b("Promise"))).all(e.map(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(c){var e=c.newestReaction;c=c.thread;var f=(yield b("cr:3061").getOrCreateOptimisticThreadKey(a,c.jid));f=(yield a.threads.get(f));if(f!=null&&e!=null&&c.snippetMsg!=null&&e.author!=null){var g=d("WAJids").interpretAsGroupJid(c.jid)!=null;e=d("MAWThreadSnippetBuildTxns").getReactionSnippetParams(e.author,e.reaction,g);g=e.snippetParams;var h=e.snippetSenderContactId;e=e.snippetType;g=d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:g,snippetSenderContactId:h,snippetType:e,threadJid:c.jid});h=(yield d("MAWBridgeBuildThreadSnippet").buildBridgeThreadSnippet(g,f.snippet));yield a.threads.put(babelHelpers["extends"]({},f,{snippet:h,snippetSenderContactId:g.snippetSenderContactId!=null?d("MAWBridgeUIEventDataValidation").stringToI64Opt(g.snippetSenderContactId):void 0}))}});return function(a){return c.apply(this,arguments)}}()))});return function(b){return a.apply(this,arguments)}}())}).then(function(){})})}g.bulkPutReactionsWithThreadUpdates=a}),98);
__d("MAWBulkWriteReactionsTxns",["LSMEBTaskCreationSource","MAWAuthor","MAWBridgeEventTransmitter","MAWBulkPutReactionsWithThreadUpdateTxn","MAWDbMsg","MAWDbReaction","MAWDbReactionsTxns","MAWDexieTable","MAWEncryptedBackupCacheManager","WAArrayGroupBy","WAJids","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var e=[],f=[];b.forEach(function(a){var b=a.chatJid;a=a.unstoredReaction;a=a.reactToExternalId;e.push(b);f.push(a)});return d("MAWDexieTable").dexieAll([a.threads.where("jid").anyOf(e).toArray(),a.messages.where("externalId").anyOf(f).toArray(),a.reactions.where("reactToExternalId").anyOf(f).toArray()]).then(function(e){var f=e[0],g=e[1];e=e[2];var h=new Map(f.map(function(a){return[a.jid,a]})),i=new Map(d("WAArrayGroupBy").groupBy(g,function(a){return a.externalId})),j=new Map(d("WAArrayGroupBy").groupBy(e,function(a){return a.reactToExternalId})),k=[];g=f.map(function(b){return d("MAWDbReactionsTxns").getNextReactionIdNumberForThread(a,b).then(function(a){return[b.jid,a]})});return d("MAWDexieTable").dexieAll(g).then(function(a){var e=new Map(a);b.forEach(function(a){var b=a.chatJid;a=a.unstoredReaction;var f=a.author,g=a.externalId,l=a.groupingKey,m=a.reaction,n=a.reactToAuthor,o=a.reactToExternalId,p=a.senderTimestampMs,q=a.ts,r=h.get(b);if(r==null)return"missing_thread";b=e.get(r.jid);if(b==null)throw c("err")("nextInChatReactionId should not be null");e.set(r.jid,b+1);var s=j.get(a.reactToExternalId)||[];s=d("MAWDbReaction").findMatchingReaction(s,r.jid,f);if(s!=null&&d("MAWDbReaction").getReactionTimeMs(s)>d("MAWDbReaction").getReactionTimeMs(a))return"newer_reaction_exists";var t=d("MAWAuthor").getAuthorUserJid(n),u=i.get(a.reactToExternalId);if(u==null&&!d("MAWEncryptedBackupCacheManager").peekRestoreCache(a.reactToExternalId)){var v=d("WAJids").threadIdForChatJid(r.jid);d("MAWEncryptedBackupCacheManager").addMsgEntryToReuploadCache(r.jid,a.reactToExternalId);d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(a.reactToExternalId,v,void 0,c("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT,r.jid)}a=u==null?void 0:u.find(function(a){return a.threadJid===r.jid&&t===d("MAWAuthor").getAuthorUserJid(a.author)});u=d("MAWDbReaction").formatReactionForDb(r.jid,g,d("MAWDbMsg").craftReactionId(r.chatId,b),o,m,l,n,a==null?void 0:a.msgId,q,(v=f)!=null?v:d("WAJids").AUTHOR_ME,s==null?void 0:s.rowId,void 0,p);k.push(u)});return{chatJidToDbThread:h,unstoredDbReactionsForInsertion:k}})})}function b(a,b){var c=b.chatJidToDbThread;b=b.unstoredDbReactionsForInsertion;return d("MAWBulkPutReactionsWithThreadUpdateTxn").bulkPutReactionsWithThreadUpdates(a,b,c)}g.prepareReactionsData=a;g.bulkWriteReactions=b}),98);
__d("MAWHIMLogger",["WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";a=d("WATagsLogger").TAGS(["HandleIncomingMessage"]);g["default"]=a}),98);
__d("MAWDbRavenActionTxns",["MAWBridgeTypesCreators","MAWDbMsg","MAWIndexedDb","MAWMsg","MAWRavenUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e){return a.messages.where("externalId").equals(b.ravenActionToMsgExternalId).filter(function(a){return a.threadJid===e.jid}).first().then(function(f){var g=f==null?void 0:f.msgId;if(g==null)throw c("err")("Cannot Write Raven Action without ID of Raven Message");return h(a,f).then(function(c){var d=babelHelpers["extends"]({msgId:g,threadJid:e.jid},b);return a.unrenderedMessages.add(d).then(function(a){return babelHelpers["extends"]({rowId:a},d)})}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"RavenActionUpdate",value:d("MAWBridgeTypesCreators").createBridgeRavenAction(a)});return})})}function h(a,b){if((b==null?void 0:b.type)!=="Raven")throw c("err")("Cannot Modify Message because Message is not Raven Message");var e=[d("MAWMsg").MAWRavenMsgEphemeralMediaState.cast(Number(b.ravenEphemeralMediaState)),d("MAWMsg").MAWRavenMsgEphemeralType.cast(Number(b.ravenEphemeralType))],f=e[0];e=e[1];if(f==null||e==null)throw c("err")("ravenEphemeralMediaStateEnum or ravenEphemeralTypeEnum is null");f=d("MAWRavenUtils").getNextRavenMessageEphemeralState(f,e);return a.messages.put(babelHelpers["extends"]({},b,{ravenEphemeralMediaState:f}))}function b(a,b,c){c=d("MAWDbMsg").isRavenActionMsgType(c)&&(b==null?void 0:b.externalId)!=null?[b.externalId]:[];return a.messages.where("externalId").anyOf(c).filter(function(a){return a.author===(b==null?void 0:b.author)&&a.threadJid===(b==null?void 0:b.chat)}).first()}g.writeRavenActionMsg=a;g.modifyRavenMsgWithActionMsg=h;g.maybeGetRavenMsgQueryByProtocolMsgId=b}),98);
__d("MAWEphemeralUtils",["MAWLocalizationType","WAArmadilloApplication.pb","WAGlobals","WAJids","err"],(function(a,b,c,d,e,f,g){"use strict";var h=60,i=60*h,j=24*i;function a(a,b,c,e){var f=[],g=b===j,k=a===d("WAGlobals").getMyUserJid();if(e)e=d("MAWLocalizationType").LOCALIZATION_TYPE.EPHEMERAL_SETTINGS_AUTO_RESET;else if(!k||a==null)b===0?e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_OFF:b<h?(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_ON_SECONDS:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_CHANGE_SECONDS,f.push(b.toString())):b<i?(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_ON_MINUTES:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_CHANGE_MINUTES,f.push((b/h).toString())):b<j||g?(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_ON_HOURS:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_CHANGE_HOURS,f.push((b/i).toString())):(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_ON_DAYS:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_CHANGE_DAYS,f.push((b/j).toString()));else{a=d("WAJids").extractUserId(a).toString();b===0?k?e=d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_OFF:(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_OFF,f.push(a)):b<h?(k?e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_ON_SECONDS:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_SECONDS:(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_SECONDS:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_SECONDS,f.push(a)),f.push(b.toString())):b<i?(k?e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_ON_MINUTES:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_MINUTES:(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_MINUTES:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_MINUTES,f.push(a)),f.push((b/h).toString())):b<j||g?(k?e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_ON_HOURS:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_HOURS:(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_HOURS:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_HOURS,f.push(a)),f.push((b/i).toString())):(k?e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_ON_DAYS:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_DAYS:(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_DAYS:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_DAYS,f.push(a)),f.push((b/j).toString()))}return{ephemeralSettingChangeContent:f,ephemeralSettingChangeType:e}}function b(a,b,e){var f,g=[];b=d("WAJids").extractUserId(b).toString();switch(a){case d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE:e?f=d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_TAKE_SCREENSHOT:(f=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_TAKE_SCREENSHOT,g.push(b));break;case d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING:e?f=d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_RECORD_SCREEN:(f=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_RECORD_SCREEN,g.push(b));break;default:throw c("err")("Received unexpected screenshot action type")}return{ephemeralScreenshotActionContent:g,ephemeralScreenshotActionType:f}}g.getEphemeralSettingChangeData=a;g.getEphemeralScreenshotActionData=b}),98);
__d("MAWEphemeralAdminMsgBuildTxns",["MAWAckLevel","MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbMessageHandler","MAWDbMsgTxns","MAWDexieTable","MAWEphemeralUtils","MAWExternalId","MAWIndexedDb","MAWMsgType","MAWThreadSnippetBuildTxns","MAWWriteMsgTxns","WAGlobals","WAJids","WATimeUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g,h,i,j){if(e<0)throw c("err")("Received unexpected ephemeral time setting");e=d("MAWEphemeralUtils").getEphemeralSettingChangeData(b,e,h,i);h=e.ephemeralSettingChangeContent;i=e.ephemeralSettingChangeType;var k={ack:d("MAWAckLevel").ACK.sent,altIndex:void 0,author:(e=b)!=null?e:d("WAJids").AUTHOR_SYSTEM,msgContent:{adminMsgContent:h,adminType:i,version:1},type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN};e=j!=null&&b!=null?d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,j,g.jid,b):d("MAWDexieTable").dexieResolve();return e.then(function(b){if(b==null){var c,e=babelHelpers["extends"]({},k,{externalId:(c=j)!=null?c:d("MAWExternalId").generateExternalId(),sortOrderMs:d("WATimeUtils").castUnixTimeToMillisTime(f),threadJid:g.jid,ts:f});return d("MAWWriteMsgTxns").writeDedupedEphemeralSettingAdminMessage(a,e,g,d("WATimeUtils").castUnixTimeToMillisTime(f)).then(function(a){return babelHelpers["extends"]({},e,{msgId:a.msgId,rowId:a.rowId})})}else if(b.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT){var h=babelHelpers["extends"]({},b,k);return a.messages.put(h).then(function(){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.threadJid,[b])});d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(h)});return d("MAWDbMsgTxns").getThreadNewestMessageId(a,g.jid).then(function(b){return h.msgId===b&&!d("MAWDbMessageHandler").isThreadUpdateEnabledViaMiddlewareForMsgType(h.type)?d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,h).then(function(a){var b=a.snippetParams,c=a.snippetSenderContactId;a=a.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:b,snippetSenderContactId:c,snippetType:a,threadJid:g.jid})});return h}):h})})}else return null})}function b(a,b,c,e,f,g,h){var i=b===d("WAGlobals").getMyUserJid(),j=d("MAWEphemeralUtils").getEphemeralScreenshotActionData(f,b,i),k=j.ephemeralScreenshotActionContent;j=j.ephemeralScreenshotActionType;if(h==null){var l={ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:i?d("WAJids").AUTHOR_ME:b,externalId:g,msgContent:{adminMsgContent:k,adminType:j,screenshotActionType:f,version:1},sortOrderMs:d("WATimeUtils").castUnixTimeToMillisTime(e),threadJid:c.jid,ts:e,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION};return d("MAWWriteMsgTxns").writeDedupedEphemeralSettingAdminMessage(a,l,c,d("WATimeUtils").castUnixTimeToMillisTime(e)).then(function(a){return babelHelpers["extends"]({},l,{msgId:a.msgId,rowId:a.rowId})})}else if(h.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT){var m=babelHelpers["extends"]({},h,{ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:i?d("WAJids").AUTHOR_ME:b,msgContent:{adminMsgContent:k,adminType:j,screenshotActionType:f,version:1},type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION});return a.messages.put(m).then(function(){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(h.threadJid,[h])});d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(m)});return d("MAWDbMsgTxns").getThreadNewestMessageId(a,c.jid).then(function(b){return m.msgId===b&&!d("MAWDbMessageHandler").isThreadUpdateEnabledViaMiddlewareForMsgType(m.type)?d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,m).then(function(a){var b=a.snippetParams,e=a.snippetSenderContactId;a=a.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:b,snippetSenderContactId:e,snippetType:a,threadJid:c.jid})});return m}):m})})}else return d("MAWDexieTable").dexieResolve(null)}g.writeEphemeralSettingAdminMsg=a;g.writeEphemeralScreenshotActionMsg=b}),98);
__d("MAWCastToMsgrServerMediaType",["MAWDbMedia","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["invalid client mediaType: "," for castClientMediaTypeToServerMediaType method"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["invalid mediaType: "," for castToMsgrServerMediaType method"]);i=function(){return a};return a}function a(a,b){b===void 0&&(b=!1);if(b&&a==="image")return"xma";switch(a){case"image":case"video":case"gif":case"sticker":return a;case"document":return"file";case"ptt":return"audio";case"xma-image":return"xma";default:d("WALogger").ERROR(i(),a);return null}}function b(a,b){b===void 0&&(b=!1);if(b&&a===d("MAWDbMedia").MEDIA_TYPE.IMAGE)return"xma";switch(a){case"Image":return"image";case"Video":return"video";case"Gif":return"gif";case"Sticker":return"sticker";case"DocumentFile":return"document";case"Ptt":return"audio";default:d("WALogger").ERROR(h(),a);return null}}g.castToMsgrServerMediaType=a;g.castClientMediaTypeToServerMediaType=b}),98);
__d("WADbDeviceRegistration",[],(function(a,b,c,d,e,f){"use strict";a=25;b=6;c=100;d="https://reg-e2ee.facebook.com";e=d;var g="https://v.whatsapp.net",h="https://reg-e2ee.instagram.com",i="/v2/fb_icdc_fetch",j="/v2/fb_register_v2",k="Device has already been registered to WA servers",l="Device registration finished successfully",m="Device registration retries failed "+b+" times. No longer attempting registration.",n="Device registration response was null",o="Current user id is zero",p="CryptoAuthToken is empty",q="CryptoAuthToken is expired",r={failed:"failed",finished:"finished"};f.MAX_USERS_FOR_NOTIFY_DEVICE_CHANGE=a;f.MAX_DEVICE_REGISTRATION_RETRIES=b;f.MAX_ROTATE_CRYPTO_AUTH_TOKEN_RETRIES=c;f.REG_FB_DOMAIN=d;f.REG_MSGR_DOMAIN=e;f.REG_WA_DOMAIN=g;f.REG_IGD_DOMAIN=h;f.ICDC_ENDPOINT=i;f.REGISTRATION_ENDPOINT=j;f.DEVICE_ALREADY_REGISTERED=k;f.DEVICE_SUCCESSFULLY_REGISTERED=l;f.FAILED_REGISTRATION_RETRIES=m;f.NULL_RESPONSE_FROM_SERVER=n;f.DEVICE_REGISTER_ERROR_ZERO_AS_USER_ID=o;f.DEVICE_REGISTER_ERROR_EMPTY_CAT_TOKEN=p;f.DEVICE_REGISTER_ERROR_EXPIRED_CAT_TOKEN=q;f.RegistrationStatesEnum=r}),66);
__d("getOrchestratorVersion",["qex"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a;return(a=c("qex")._("263"))!=null?a:"default"}g["default"]=a}),98);
__d("MAWMainWebWorkerConfig",["MAWGK","MAWParseXMAFBConfig","WADbDeviceRegistration","WorkerUtils","getOrchestratorVersion","gkx","justknobx","qex"],(function(a,b,c,d,e,f,g){"use strict";var h,i=1;a={armadilloWebProcessFutureproof:function(){return c("MAWGK").armadillo_web_process_futureproof},batchSize:function(){return c("justknobx")._("1866")},getDevicesV2:function(){return c("gkx")("4551")},getSignalFutureMessagesMax:function(){return c("gkx")("4280")?c("justknobx")._("847"):2e3},icdcAlertTriggerFailureCounter:function(){return c("justknobx")._("1970")},icdcCooldownIntervalInMinutes:function(){return c("justknobx")._("1971")},icdcIntervalInMinutes:function(){return c("justknobx")._("1972")},ignoreReadReceipts:function(){return c("gkx")("2855")},isDocumentReceiveEnabled:function(){return!c("gkx")("23924")},isEphemeralMessagesEnabled:function(){return!0},isFrankingDropOnInvalid:function(){return c("gkx")("23973")},isFrankingDropOnMissing:function(){return c("gkx")("23974")},isFrankingEnabled:function(){return c("justknobx")._("1347")},isGifEnabled:function(){return c("justknobx")._("1147")},isHttpFetchCacheEnabled:function(){return c("gkx")("5483")},isICDCErrorEnabled:function(){return c("gkx")("23975")},isMediaFallbackToAlternativeHmacSaltsEnabled:function(){return c("gkx")("23976")},isMediaStreamingForProgressiveJpegEnabled:function(){return c("gkx")("2325")},isOctetStreamAttachmentMimeTypeEnabled:function(){return c("gkx")("4644")},isPollsFallbackExperienceEnabled:function(){return c("gkx")("23978")},isPreEstablishSessionEnabled:function(){return c("gkx")("23979")},isProgressiveJpegEnabledForDownload:function(){return c("justknobx")._("2411")},isProgressiveJpegSendEnabled:function(){return c("justknobx")._("2412")},isSenderKeyPredistributionEnabled:function(){return c("gkx")("23981")},isSharedWorkerContext:function(){return(h||(h=d("WorkerUtils"))).isSharedWorkerContext()},isStickerEnabled:function(){return c("justknobx")._("2618")},isStickerReceiverFetchDualSendEnabled:function(){return c("qex")._("1265")===!0},isStickerReceiverFetchEnabled:function(){return c("gkx")("5177")},isStoryMentionXMAEnabled:function(){return c("gkx")("5307")},isUnsupportedMessagesRedesignEnabled:function(){return c("gkx")("1564")},jpegThumbnailTargetByteSizeKB:function(){return c("justknobx")._("2338")},maxPrekeysToUpload:function(){return 200},maxUsersForNotifyDeviceChange:function(){return d("WADbDeviceRegistration").MAX_USERS_FOR_NOTIFY_DEVICE_CHANGE},mediaDownloadDeduplication:function(){return c("gkx")("33150")},mediaRejectPreviewResolvable:function(){return c("gkx")("6031")},mediaTtlOnWhatsAppInfraInDays:function(){return c("justknobx")._("2715")},oneQueueTimeoutMs:function(){return c("justknobx")._("2583")},orchestratorVersion:function(){return c("getOrchestratorVersion")()},pjpegPreviewAvoidLastScan:function(){return c("justknobx")._("67")},sessionDropIfTooOld:function(){return c("justknobx")._("2240")},shouldCommsWait:function(){return c("gkx")("6068")},shouldDeviceStateTimesout:function(){return c("justknobx")._("2592")},shouldWaitForConnection:function(){return c("gkx")("5594")},skipDownloadablePreviewForProgressiveJpeg:function(){return c("justknobx")._("2371")},skipExpiredDownload:function(){return c("gkx")("3981")},uiLayoutTriggeredMediaDownload:function(){return c("gkx")("4137")},useLongSessionDrop:function(){return c("gkx")("1244")},useProtocolMediaKey:function(){return c("gkx")("3718")},useTightenBackoff:function(){return c("gkx")("6110")},useUpdatedSenderKeySession:function(){return c("gkx")("23937")},waDanglingQueue:function(){return c("justknobx")._("1921")},workerScheduler:function(){return c("gkx")("5801")}};b={enableDocumentBackupAndRestore:function(){return c("gkx")("4805")},encryptForwardedMedia:function(){return c("gkx")("2983")},isMediaAssociatedXMAsEnabled:function(){return c("gkx")("4379")},isRavenMessagesEnabled:function(){return c("qex")._("565")===!0},productTypeForEBAttachments:"msgr",skipPreviewUploadForImages:function(){return c("gkx")("4951")},supportedTypesVersion:function(){return c("MAWGK").armadillo_web_process_futureproof?i+1:i},supportedXMATargetTypes:function(){return d("MAWParseXMAFBConfig").FB_SUPPORTED_TARGET_TYPES}};g.waConfig=a;g.mawConfig=b}),98);
__d("MAWConfig",["MAWMainWebWorkerConfig"],(function(a,b,c,d,e,f,g){"use strict";var h=d("MAWMainWebWorkerConfig").mawConfig;function a(){return h}function b(a){h=a}g.getConfig=a;g.setConfig=b}),98);
__d("MAWDexieCastToPromise",["Promise"],(function(a,b,c,d,e,f){"use strict";var g;function a(a){return(g||(g=b("Promise"))).resolve(a)}function c(a){return a}f.dexieCastToPromise=a;f.promiseCastToDexiePromise_I_KNOW_WHAT_I_AM_DOING=c}),66);
__d("MAWMediaAfterTxns",["MAWBridgeTypesCreators","MAWDbMedia","MAWDexieCastToPromise","MAWIndexedDb","MAWMediaUtils","MAWRavenUtils","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g){c("promiseDone")(d("MAWDexieCastToPromise").dexieCastToPromise(f.messages.where("msgId").anyOf(b.msgIds).toArray().then(function(i){var j=a.threadJid;i=d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(i,j);j=a.ravenEphemeralType!=null&&a.ravenEphemeralMediaState!=null?d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:j,filteredMsgIds:i,hasMediaForUI:e,media:b,ravenSettings:d("MAWRavenUtils").deriveRavenSettings(a.ravenEphemeralType,a.ravenEphemeralMediaState),sortOrderMs:a.sortOrderMs}):d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:j,filteredMsgIds:i,hasMediaForUI:e,media:b,sortOrderMs:a.sortOrderMs});c("gkx")("2616")===!0?h(f,babelHelpers["extends"]({},j,{skipShouldUpdateHasMore:g})):d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:j})})))}function h(a,b,e){if(!i(b))return d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:b});c("promiseDone")(d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWMediaUtils").getBridgeMediaAnnotatedForDisplay(a,b,e).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:a})})))}function i(a){if(a.ephemeralMediaState!=null||a.ephemeralMediaViewMode!=null)return!1;switch(a.mediaType){case d("MAWDbMedia").MEDIA_TYPE.IMAGE:case d("MAWDbMedia").MEDIA_TYPE.VIDEO:case d("MAWDbMedia").MEDIA_TYPE.GIF:case d("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE:return!0;default:return!1}}g.handleNewMediaAfterTxn=a;g.handleNewMediaAfterTxnWithBridgeMedia=h}),98);
__d("MAWMediaBackupTxns",["MAWDbMediaTxns","MAWDexieTable","Promise","WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fbid already exists for objectId"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mediaId or msgId cannot differ for an objectId in mediaBackup"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] ObjectId already shared by different msgId"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fbid already exists for objectId"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mediaId or msgId cannot differ for an objectId in mediaBackup"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry. Will attempt a retry. Error: ",""]);o=function(){return a};return a}var p=1;function q(a,b,e,f,g,h){h===void 0&&(h=0);return f==null?d("MAWDexieTable").dexieResolve():d("MAWDbMediaTxns").maybeGetMediaBackupRowFromObjectId(a,f).then(function(i){if(i==null){var j={mediaId:b,msgId:e,objectId:f};g!=null&&(j=babelHelpers["extends"]({},j,{fbid:g}));return a.mediaBackup.add(j).then(function(a){return babelHelpers["extends"]({},j,{mediaBackupId:a})})["catch"](function(i){if(i.name==="ConstraintError"){if(h<p){d("WALogger").WARN(o(),i);return q(a,b,e,f,g,h+1)}throw c("err")("Failed to add mediaBackup entry. Original error: %s, %s",i.name,i.message)}d("WALogger").ERROR(n(),i);throw i})}else if(i.mediaId!==b||i.msgId!==e){d("WALogger").ERROR(m());return i}else{if(i.fbid==null&&g!=null){var k=babelHelpers["extends"]({},i,{fbid:g});return a.mediaBackup.put(k).then(function(a){return k})}else d("WALogger").WARN(l());return i}})}function a(a,c){if(c==null)return d("MAWDexieTable").dexieResolve();var e=[];c.forEach(function(a){a=a.objectId;a!=null&&e.push(a)});return d("MAWDbMediaTxns").maybeGetMediaBackupRowsFromObjectIds(a,e).then(function(e){var f=new Map(),g=[];c.forEach(function(a){var b=a.objectId;if(b!=null){var c=e.get(b);if(c==null){var h={mediaId:a.mediaId,msgId:a.msgId,objectId:b},l=a.fbid;h=babelHelpers["extends"]({},h,{fbid:l});f.get(b)!=null&&((l=f.get(b))==null?void 0:l.msgId)!==a.msgId&&d("WALogger").ERROR(k());f.set(b,h)}else{c.mediaId!==a.mediaId&&d("WALogger").ERROR(j());l=a.fbid;if(c.fbid==null&&l!=null){b=babelHelpers["extends"]({},c,{fbid:l});g.push(b)}else d("WALogger").WARN(i())}}});return(h||(h=b("Promise"))).all([a.mediaBackup.bulkAdd([].concat(Array.from(f.values()))),a.mediaBackup.bulkPut(g)]).then(function(){})}).then(function(){})}g.linkMediaBackup=q;g.bulkLinkMediaBackup=a}),98);
__d("MAWMediaManagementTxns",["FBLogger","MAWBridgeTypesCreators","MAWBridgeUpload","MAWCastToMsgrServerMediaType","MAWConfig","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieCastToPromise","MAWDexieTable","MAWIndexedDb","MAWMediaAfterTxns","MAWMediaBackupTxns","MAWMediaUtils","MAWMsgType","MAWSupportedDocumentTypes","MAWWriteMsgTxns","WAErrorMessage","WAHashUtils","WAJids","WALogger","WAMediaUtils","WASortedLists","WATagsLogger","WATimeUtils","err","gkx","isInstamadilloEB","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mediaBackup entry already exists for objectId ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same FBId assigned for different mediaIds. fbId: "," - shared by hashedPlaintextHashes: "," ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same objectId assigned for different mediaIds. objectId: "," shared by  hashedPlaintextHashes: "," ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][updateMediaWithEncodedMediaEntryData] media entry is missing, can't upate media with encoded data"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media entry is missing, can't update media info"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link. Possible duplicate? Will attempt a retry. Error: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link. Possible duplicate? Will attempt a retry. For plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry. Error: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry. For plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media found after retry for plaintextHash: ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missing mandatory args for incoming media msg"]);r=function(){return a};return a}var s=d("WATagsLogger").TAGS(["MAWMediaManagementTxns"]),t=c("gkx")("23924");function a(a,b,c,e){var f=c==null||b.type===d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE&&(t||!d("MAWSupportedDocumentTypes").isAllowedType((c=c.validatedDocumentFileInfo)==null?void 0:c.filename));return d("MAWWriteMsgTxns").prepareMsgWriteData(a,b,e).then(function(a){return babelHelpers["extends"]({},a,{shouldDropDocument:f})})}function b(a,b,e,f,g){f===void 0&&(f=!1);g===void 0&&(g=!1);var h={validatedAudioInfo:b.validatedAudioInfo,validatedDocumentFileInfo:b.validatedDocumentFileInfo,validatedImageInfo:b.validatedImageInfo,validatedVideoInfo:b.validatedVideoInfo},i=d("MAWMediaUtils").genHMACPlaintextHash(b.plaintextHash),j=d("WAMediaUtils").decodeMediaEntryData(b.mediaEntry),k=j.objectId!=null?d("WAMediaUtils").stringToDeliveryObjectId(j.objectId):null;return d("MAWDexieTable").dexieAll([u(a,e,b.plaintextHash,b.mediaType,b.size,b.mediaEntry,h,k,void 0,f),d("MAWDbChunkTxns").hasMediaChunk(a,i)]).then(function(b){var c=b[0];b=b[1];e.type!==d("MAWMsgType").MSG_TYPE.REVOKED&&!f&&d("MAWMediaAfterTxns").handleNewMediaAfterTxn(e,c,b,a);return c}).then(function(a){var b=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(j.serverMediaType,f),h=j.mediaKeyTimestamp;if(d("MAWMsgType").isMAWSupportedMediaType(e.type)&&!c("isInstamadilloEB")()&&!g){var i=e.threadJid;k!=null&&b!=null&&i!=null&&h!=null&&(b!=="document"||d("MAWConfig").getConfig().enableDocumentBackupAndRestore())?d("MAWIndexedDb").afterTransaction({tag:"UploadAttachment",value:d("MAWBridgeUpload").createBridgeUploadAttachment(k,b,e.externalId,d("MAWConfig").getConfig().productTypeForEBAttachments,d("WAJids").threadIdForChatJid(i),i,h)}):d("WALogger").WARN(r())}return a})}function u(a,b,c,e,f,g,h,i,j,k){k===void 0&&(k=!1);return v(a,b,c,e,f,g,h,i,j,k).then(function(c){var e=k?d("MAWDexieTable").dexieResolve():d("MAWDbMsgTxns").updateMediaId(a,b,c.mediaId,c.plaintextHash);return e.then(function(){return d("MAWMediaBackupTxns").linkMediaBackup(a,c.mediaId,b.msgId,i,j).then(function(){return c})})})}function v(a,b,e,f,g,h,i,j,k,l,r){l===void 0&&(l=!1);r===void 0&&(r=0);return d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,e).then(function(t){var u=new Map(t==null?void 0:t.mediaEntries),w=z(h,j,k);w!=null&&u.set(b.msgId,w);if(t){r>0&&s.LOG(q(),d("WAHashUtils").sanitisePlaintextHash(e));t.msgIds||c("FBLogger")("messenger_e2ee_web").mustfix("Media missing msgIds: media type=%s",t.mediaType);t.mediaType||c("FBLogger")("messenger_e2ee_web").mustfix("Media missing mediaType: type=%s ; msg type=%s",f,b.type);var x=babelHelpers["extends"]({},t,i,{mediaEntries:u,mediaType:(w=t.mediaType)!=null?w:f,msgIds:d("WASortedLists").addToSet(t.msgIds||d("WASortedLists").emptySet(),b.msgId)});return a.media.put(x).then(function(){return x})}else{var y=d("MAWMediaUtils").genHMACPlaintextHash(e),A=babelHelpers["extends"]({fbid:(w=k)!=null?w:void 0,hashedPlaintextHash:y,mediaEntries:u,mediaType:f,msgIds:d("WASortedLists").singleElement(b.msgId),objectId:(t=j)!=null?t:void 0,plaintextHash:e,size:g,ts:d("WATimeUtils").unixTime()},i);return a.media.add(A).then(function(a){return babelHelpers["extends"]({},A,{mediaId:a})})["catch"](function(c){var q=d("WAErrorMessage").maybeGetMessageFromError(c);if(r>0){s.WARN(p(),d("WAHashUtils").sanitisePlaintextHash(e),y,q);s.ERROR(o(),q);throw c}else{s.WARN(n(),d("WAHashUtils").sanitisePlaintextHash(e),y,q);s.ERROR(m(),q);return v(a,b,e,f,g,h,i,j,k,l,r+1)}})}})}var w=function(a,b,e,f,g,h,i,j,k){k===void 0&&(k=!1);return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(b){if(b==null)throw c("err")("Do not have the media message in db when attachHashToMediaMsg");else return u(a,b,e,h,i,void 0,j,f,g,k)})},x=function(a,b,c){return d("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(a,b).then(function(b){if(b!=null){var d=babelHelpers["extends"]({},b);c.validatedAudioInfo!=null&&(d.validatedAudioInfo=babelHelpers["extends"]({},b.validatedAudioInfo,c.validatedAudioInfo));c.validatedVideoInfo!=null&&(d.validatedVideoInfo=babelHelpers["extends"]({},b.validatedVideoInfo,c.validatedVideoInfo));c.validatedImageInfo!=null&&(d.validatedImageInfo=babelHelpers["extends"]({},b.validatedImageInfo,c.validatedImageInfo));c.validatedDocumentFileInfo!=null&&(d.validatedDocumentFileInfo=babelHelpers["extends"]({},b.validatedDocumentFileInfo,c.validatedDocumentFileInfo));return a.media.update(d.mediaId,d).then(function(){})}else s.WARN(l())})},y=function(a,b,c,e){return d("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(a,b).then(function(b){if(b!=null){var f=e?b.mediaEntries.set(c,e):b.mediaEntries;b=babelHelpers["extends"]({},b,{mediaEntries:f});return a.media.update(b.mediaId,b)}else{s.ERROR(k());return d("MAWDexieTable").dexieResolve()}})};function e(a,b,c,e,f,g,h,i,j,k){k===void 0&&(k=!1);return d("MAWDexieTable").dexieAll([w(a,b,e,f,g,h,j.size,i,k),d("MAWDbChunkTxns").getOrCreateMediaChunk(a,e,c,j.type)]).then(function(a){a=a[0];return a})}function z(a,b,c){var e;a=a;a!=null&&b!=null&&(e=d("WAMediaUtils").decodeMediaEntryData(a),a=d("WAMediaUtils").encodeMediaEntryWithUpdatedObjectId(e,b));a!=null&&c!=null&&(e=d("WAMediaUtils").decodeMediaEntryData(a),a=d("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(e,c));return a}function f(a,b,c){var e=new Map();a.mediaEntries.forEach(function(a,f){var g=d("WAMediaUtils").decodeMediaEntryData(a);g=g.objectId===b?d("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(g,c):a;e.set(f,g)});return e}function A(a,b,c){var e=new Map();b.forEach(function(a){var b;b=(b=e.get(a.hashedPlaintextHash))!=null?b:[];b.push(a);e.set(a.hashedPlaintextHash,b)});return d("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(a,[].concat(Array.from(e.keys()))).then(function(f){var g=new Map(f.map(function(a){return[a.hashedPlaintextHash,a]})),h=new Map();b.forEach(function(a){var b=g.get(a.hashedPlaintextHash);if(a==null)return;var c=z(a==null?void 0:a.entry,a==null?void 0:a.objectId,a==null?void 0:a.fbId);if(b){var e=c?b.mediaEntries.set(a.msgId,c):b.mediaEntries;e=babelHelpers["extends"]({},b,{mediaEntries:e,msgIds:d("WASortedLists").addToSet(b.msgIds,a.msgId)});g.set(a.hashedPlaintextHash,e)}else I(h,a,c)});var i=new Map(),j=new Map();f=Array.from(h.values()).filter(function(a){return B(a,i,j)});return d("MAWDexieTable").dexieAll([a.media.bulkAdd(f),a.media.bulkPut(Array.from(g.values()))]).then(function(){return C(a,[].concat(Array.from(e.keys())),e,c)})})}function B(a,b,c){if(a.objectId!=null){var d=b.get(a.objectId);if(d!=null&&d!==a.hashedPlaintextHash){s.ERROR(j(),a.objectId,d,a.hashedPlaintextHash);return!1}}if(a.fbid!=null){d=c.get(a.fbid);if(d!=null&&d!==a.hashedPlaintextHash){s.ERROR(i(),a.fbid,d,a.hashedPlaintextHash);return!1}}a.objectId!=null&&b.set(a.objectId,a.hashedPlaintextHash);a.fbid!=null&&c.set(a.fbid,a.hashedPlaintextHash);return!0}function C(a,b,c,e){return d("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(a,b).then(function(b){return d("MAWDexieTable").dexieAll([F(a,b,c),d("MAWMediaBackupTxns").bulkLinkMediaBackup(a,G(b,c))]).then(function(){D(b,c,e,a);return b})})}function D(a,b,e,f){a.forEach(function(a){var g=b.get(a.hashedPlaintextHash);g!=null&&!E(g)&&c("promiseDone")(d("MAWDexieCastToPromise").dexieCastToPromise(f.messages.where("msgId").anyOf(a.msgIds).toArray().then(function(b){b=d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:e,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(b,e),hasMediaForUI:!1,media:a});c("gkx")("2616")===!0?d("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(f,b):d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:b})})))})}function E(a){return a.reduce(function(a,b){return a||b.isXMAShare},!1)}function F(a,b,c){b=b.reduce(function(a,b){var d;(d=c.get(b.hashedPlaintextHash))==null?void 0:d.filter(function(a){return a!=null&&!a.isXMAShare}).forEach(function(c){return a.set(c.msgId,b.mediaId)});return a},new Map());return d("MAWDbMsgTxns").bulkUpdateMediaId(a,b)}function G(a,b){var c=new Map();a.forEach(function(a){var d;d=(d=b.get(a.hashedPlaintextHash))!=null?d:[];d.forEach(function(b){c.has(b.objectId)?s.WARN(h(),b.objectId):b.objectId!=null&&c.set(b.objectId,{fbid:b.fbId,mediaId:a.mediaId,msgId:b.msgId,objectId:b.objectId})})});return Array.from(c.values())}function H(a,b){var c;a=a?new Map([[b.msgId,a]]):new Map();return babelHelpers["extends"]({fbid:(c=b.fbId)!=null?c:void 0,hashedPlaintextHash:b.hashedPlaintextHash,mediaEntries:a,mediaType:b.mediaType,msgIds:d("WASortedLists").singleElement(b.msgId),objectId:(c=b.objectId)!=null?c:void 0,plaintextHash:b.plaintextHash,size:b.size,ts:d("WATimeUtils").unixTime()},b.mediaInfo)}function I(a,b,c){var d=a.get(b.hashedPlaintextHash);d==null?a.set(b.hashedPlaintextHash,H(c,b)):(c!=null&&d.mediaEntries.set(b.msgId,c),d.msgIds.push(b.msgId))}g.prepareMediaWriteData=a;g.handleUnstoredDbMedia=b;g.linkMedia=u;g.createOrUpdateMediaRow=v;g.attachHashToMediaMsg=w;g.updateMediaEntryWithValidatedMediaInfo=x;g.updateMediaWithEncodedMediaEntryData=y;g.attachHashAndSaveMedia=e;g.updateBackupFbidInMediaEntries=f;g.bulkLinkMedia=A;g.linkMessageAndMediaBackupForMediaList=C}),98);
__d("MAWMsgActionType",[],(function(a,b,c,d,e,f){"use strict";a={DELETE_FOR_ME:"DELETE_FOR_ME",NO_ACTION:"NO_ACTION",REVOKE:"REVOKE",UPDATE_CIPHERTEXT:"UPDATE_CIPHERTEXT",UPDATE_CIPHERTEXT_WITH_ASSOCIATED:"UPDATE_CIPHERTEXT_WITH_ASSOCIATED",WRITE:"WRITE",WRITE_WITH_ASSOCIATED:"WRITE_WITH_ASSOCIATED"};f.MSG_ACTION=a}),66);
__d("MAWDbReceiptTxns",["MAWDexieTable","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpectedly fetched null data from a msgIdToReceiptData map"]);h=function(){return a};return a}function a(a,b,c){return i([{deliveryReceipts:b==="delivered"?c:[],msgId:a,readReceipts:b==="read"?c:[],senderReceipts:b==="sender"?c:[]}]).then(function(a){return a[0]||{type:"missing"}})}function i(a){var b=a.map(function(a){return a.msgId}),c=new Map();a.forEach(function(a){c.set(a.msgId,a)});a=b.map(function(a){var b=c.get(a);if(b==null){d("WALogger").ERROR(h());return null}var e=new Set(),f=new Map(),g=b.deliveryReceipts,i=b.readReceipts;b=b.senderReceipts;[{receiptType:"delivered",receivers:g},{receiptType:"read",receivers:i},{receiptType:"sender",receivers:b}].forEach(function(a){var b=a.receiptType;a=a.receivers;a.forEach(function(a){var c=a.device;a=a.ts;c=d("WAJids").extractUserJid(c);var g=!1;if(b!=="sender"){var h=f.get(c);a=j(h,b,a);f.set(c,a);g=k(h,a)}g&&e.add(c)})});return{affectedUserJids:e,receipt:{msgId:a,statusTsPerUser:f}}}).filter(Boolean);return d("MAWDexieTable").dexieResolve(a.map(function(a){return{affectedUserJids:a.affectedUserJids,receipt:a.receipt}}))}function j(a,b,c){var d;d=(d=a==null?void 0:a.deliveredTs)!=null?d:c;a=a==null?void 0:a.readTs;b==="read"&&a==null&&(a=c);return{deliveredTs:d,readTs:a}}function k(a,b){return((b==null?void 0:b.deliveredTs)||0)>((a==null?void 0:a.deliveredTs)||0)||((b==null?void 0:b.readTs)||0)>((a==null?void 0:a.readTs)||0)}function b(a,b){return a.receipts.bulkDelete(b)}g.writeReceiptsForDevices=a;g.bulkWriteReceiptsForDevices=i;g.bulkDeleteAllReceiptsForMessages=b}),98);
__d("MAWMessageRequestUtils",["MAWFolderTypes","WADbContact"],(function(a,b,c,d,e,f,g){"use strict";function a(a){a=a===d("MAWFolderTypes").FOLDER_ID.PENDING||a===d("MAWFolderTypes").FOLDER_ID.OTHER;return a}function b(a,b){return(a===null||a===d("MAWFolderTypes").FOLDER_ID.INBOX)&&(b===d("WADbContact").REVERSED_ONE_WAY_CONTACT||b===d("WADbContact").NON_CONTACT)}g.isMessageRequestOrSpamThread=a;g.isInboxRequest=b}),98);
__d("MAWMarkThreadAsReadTxns",["FBLogger","MAWBridgeThread","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWMessageRequestUtils","MAWTimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,d,e,f){f===void 0&&(f=!1);var g=new Map();g.set(b,{msgId:d,sortOrderMs:e});return h(a,g,f).then(function(a){a=a.get(b);if(a==null)throw c("FBLogger")("messenger_web_devx","maw_mark_thread_as_read").warn("ThreadReadReceiptInfo unexpectedly unavailable for thread\n         in markThreadAsReadUpToMsgSortOrderMs()");return a})}function h(a,b,c){c===void 0&&(c=!1);return j(a,b).then(function(e){var f=e.threadJidToReadReceiptInfo,g=e.updatedThreads;return a.threads.bulkPut(g).then(function(){g.forEach(function(a){var e;e=(e=b.get(a.jid))==null?void 0:e.sortOrderMs;e!=null&&!c&&d("MAWIndexedDb").afterTransaction({tag:"ThreadTimestampsUpdated",value:d("MAWBridgeThread").createBridgeThreadTimestampsUpdated(a.jid,e,e,!1)});f.set(a.jid,{isReadReceiptExpectedToBeSent:(a=(e=f.get(a.jid))==null?void 0:e.isReadReceiptExpectedToBeSent)!=null?a:!1,type:"success"})});return f})})}function i(a,b,c){return d("MAWDbMsgTxns").getThreadOldestMessageId(a,b.jid).then(function(a){if(a==null)return null;a=d("MAWTimeUtils").ensureValidMillisTime(b.newestMsgTs);return babelHelpers["extends"]({},b,{lastReadMsg:c.msgId,newestMsgTs:a})})}function j(a,b){var e=new Map(),f=Array.from(b.keys()),g=[];return a.threads.where("jid").anyOf(f).toArray().then(function(h){var j=new Map();h.forEach(function(a){return j.set(a.jid,a)});f.forEach(function(a){j.has(a)||j.set(a,null)});h=Array.from(j).map(function(d){var f=d[0];d=d[1];if(d==null){e.set(f,{isReadReceiptExpectedToBeSent:!1,type:"missing"});return}f=k(d.folder);e.set(d.jid,{isReadReceiptExpectedToBeSent:f,type:"success"});f=b.get(d.jid);if(f==null)throw c("FBLogger")("maw_threads","maw_mark_thread_as_read").warn("ThreadReadReceiptInfo unexpectedly unavailable for thread\n            in getThreadJidToReadReceiptInfo()");return i(a,d,f).then(function(a){a!=null&&g.push(a)})});return d("MAWDexieTable").dexieAll(h).then(function(){return{threadJidToReadReceiptInfo:e,updatedThreads:g}})})}function k(a){return!d("MAWMessageRequestUtils").isMessageRequestOrSpamThread(a)}g.markThreadAsReadUpToMsgSortOrderMs=a;g.bulkMarkThreadAsReadUpToMsgSortOrderMs=h;g.isReadReceiptExpectedToBeSentFor=k}),98);
__d("MAWPendingReceiptProcessingTxns",["MAWDbMsg","MAWDbParticipantTxns","MAWDbReceiptTxns","MAWDexieTable","MAWMarkThreadAsReadTxns","WAJids","WALogger","WAMsg","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processing pending receipts for "," from ",""]);h=function(){return a};return a}function a(a,b,c){var e=d("WAMsg").craftWAMsgIdString({author:c.author,chat:b,externalId:c.externalId});return a.pendingReceipts.get(e).then(function(b){if(b==null)return;d("WALogger").LOG(h(),c.externalId,c.author);if(b.author===d("WAJids").AUTHOR_ME){var f=d("MAWDexieTable").dexieResolve();b.deliveryReceipts.length>0&&(f=f.then(function(){return d("MAWDbReceiptTxns").writeReceiptsForDevices(c.msgId,"delivered",b.deliveryReceipts)}));b.readReceipts.length>0&&(f=f.then(function(){return d("MAWDbReceiptTxns").writeReceiptsForDevices(c.msgId,"read",b.readReceipts)}));return f.then(function(b){var f=[];b!=null&&b.type!=="missing"&&b.receipt.statusTsPerUser.forEach(function(b,e){var g=b.deliveredTs!=null?c.ts:d("WATimeUtils").castToUnixTime(0),h=b.readTs!=null?c.ts:d("WATimeUtils").castToUnixTime(0);b=(b=b.readTs)!=null?b:d("WATimeUtils").castToUnixTime(0);f.push(d("MAWDbParticipantTxns").updateParticipantTimestamps(a,[c.threadJid,e],g,h,b))});return d("MAWDexieTable").dexieAll(f).then(function(){a.pendingReceipts["delete"](e)})})}else return d("MAWDexieTable").dexieAll([d("MAWMarkThreadAsReadTxns").markThreadAsReadUpToMsgSortOrderMs(a,c.threadJid,c.msgId,d("WATimeUtils").castToMillisTime(d("MAWDbMsg").getSortOrderWithFallback(c)))]).then(function(){return a.pendingReceipts["delete"](e)})})}g.processPendingReceipts=a}),98);
__d("MAWWriteEditTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWBridgeTypesCreators","MAWBulkEditMsgsTxns","MAWDbEditMsgHistoryTxns","MAWDbMessageHandler","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWThreadSnippetForTextMsg","MAWUnsafeCoerce","MAWWriteMsgTxns","WAGlobals","WAJids","WAMsgType","WAResultOrError","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var e=b.args,f=b.externalId,g=e.editMsgContent;e=e.originalProtocolMsgId;var i=e.chat,j=e.externalId;return d("MAWDexieTable").dexieAll([a.threads.get({jid:i}),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,e)]).then(function(e){var k=e[0],l=e[1];if(k==null)return d("WAResultOrError").makeError("missing_thread");if(l==null)return d("WAResultOrError").makeError("missing_msg");if(l.type!==d("WAMsgType").MSG_TYPE.TEXT)throw c("err")("Only text or cipher text can be edited. Original msg type: %s",l.type);return d("MAWDexieTable").dexieAll([a.messages.where("quoteExternalId").equals(j).toArray(),a.editMsgHistory.where("originalMsgExternalId").equals(j).toArray(),d("MAWDbMsgTxns").getThreadNewestMessageId(a,k.jid)]).then(function(e){var m=e[0],n=e[1],o=e[2];e=n.find(function(a){return a.author===d("WAJids").AUTHOR_ME&&a.threadJid===i&&a.editExternalId===f});if((e==null?void 0:e.sendStatus)!=null&&e.sendStatus>d("MAWAckLevel").ACK.clock)return d("WAResultOrError").makeError("already_sent");e=[];e.push(h(b,i,j));n=n.find(function(a){return a.author===d("WAJids").AUTHOR_ME&&a.threadJid===i&&a.editExternalId===j});n==null&&(l.editCount==null||l.editCount===0)&&e.push(h(l,i,j));return d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,e,!1).then(function(){var b,e=babelHelpers["extends"]({},l,{ack:d("MAWAckLevel").ACK.clock,editCount:((b=l.editCount)!=null?b:0)+1,msgContent:g});if(o!=null&&o===e.msgId&&!d("MAWDbMessageHandler").isThreadUpdateEnabledViaMiddlewareForMsgType(e.type)){b=d("WAJids").userIdFromJid(d("WAGlobals").getMyUserJid());var h=c("MAWThreadSnippetForTextMsg")(e,b,d("WAJids").interpretAsGroupJid(k.jid)!=null),n=h.snippetParams;h=h.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:n,snippetSenderContactId:b,snippetType:h,threadJid:k.jid})})}var p=[],q=d("WAGlobals").getMyUserJid();n=m.find(function(a){var b;return(((b=a.quote)==null?void 0:b.content.author)===d("WAJids").AUTHOR_ME||((b=a.quote)==null?void 0:b.content.author)===q)&&a.threadJid===i});if(n!=null){b=n.quote;h=n.quoteExternalId;if(b==null)c("FBLogger")("messenger_e2ee_web").warn("[edit message] Failed to get the quoted content for a msg that has been quoted.",h);else{h=babelHelpers["extends"]({},n,{quote:babelHelpers["extends"]({},b,{content:babelHelpers["extends"]({},b.content,{msgContent:babelHelpers["extends"]({},e.msgContent)})})});p.push(h)}}return a.messages.bulkPut([e].concat(p)).then(function(){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,l)}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(e,void 0,a)})}).then(function(){p.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a)})});return d("WAResultOrError").makeResult({originalMsgExternalId:j,originalMsgId:l.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:i,externalId:f}})})})})})}function h(a,b,c){var e;return{author:d("WAJids").AUTHOR_ME,editExternalId:a.externalId,editTs:(e=a.serverTs)!=null?e:a.ts,msgContent:(e=(e=a.args)==null?void 0:e.editMsgContent)!=null?e:d("MAWUnsafeCoerce").unsafeCoerce(a.msgContent),originalMsgExternalId:c,sendStatus:d("MAWAckLevel").ACK.clock,specialTextSize:a.specialTextSize,threadJid:b}}function b(a,b,c,e){if(b.type!==d("WAMsgType").MSG_TYPE.TEXT||!e||e.length===0)return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b,c);var f=e.sort(function(a,b){return b.editTs-a.editTs})[0].msgContent;e=e.length;return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,babelHelpers["extends"]({},b,{editCount:e,msgContent:f}),c).then(function(c){return(c.type===d("WAMsgType").MSG_TYPE.TEXT?d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,[d("MAWBulkEditMsgsTxns").getMessageHistory(babelHelpers["extends"]({},c,{msgContent:b.msgContent}),c.threadJid)]):d("MAWDexieTable").dexieResolve()).then(function(){return c})})}g.writeEdit=a;g.writeNewIncomingMsgAndEditHistory=b}),98);
__d("MAWDbGroupInviteTxns",["MAWDexieTable","MAWMsgType"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return a.groupInvites.put(b).then(function(){return b})}function b(a,b,c){return a.groupInvites.where(["threadJid","inviteeJid"]).anyOf([[b,c]])["delete"]()}function h(a,b,c){return a.groupInvites.where(["threadJid","inviteeJid"]).equals([b,c]).first()}function c(a,b,c){return a.groupInvites.where(["threadJid","inviteeJid"]).anyOf([[b,c]]).toArray()}function e(a,b){return b.type===d("MAWMsgType").MSG_TYPE.GROUP_INVITE?b.invitedParticipantUserJid==null?d("MAWDexieTable").dexieResolve():h(a,b.threadJid,b.invitedParticipantUserJid):d("MAWDexieTable").dexieResolve()}g.putGroupInvite=a;g.deleteGroupInvitesByThreadAndInvitedParticipant=b;g.maybeGetGroupInvite=h;g.getGroupInvitesByThreadAndInvitedParticipant=c;g.getAndCheckGroupInviteFromMsg=e}),98);
__d("MAWGroupInviteManagementTxns",["MAWDbGroupInviteTxns","MAWDbParticipantTxns","MAWDexieTable","WAGlobals"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=!1;return d("MAWDbParticipantTxns").getInvitedParticipantsInThread(a,b).then(function(e){if(e.length===0){c=!0;var f=d("WAGlobals").getMyUserJid();return d("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(a,b,f).then(function(){return c})}else{var g=[];e.forEach(function(c){g.push(d("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(a,b,c.userJid))});return d("MAWDexieTable").dexieAll(g).then(function(){return c})}})}g.deleteGroupInvitesByThread=a}),98);
__d("MAWLoadMessageRequestCapabilitiesTxns",["MAWDexieTable","MAWIndexedDb","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a){for(var b=0;b<a.length;b++){var c=a[b],e=d("WAJids").interpretAsUserJid(c.jid);if(e==null)continue;d("MAWIndexedDb").afterTransaction({tag:"OneToOneMessageRequestLoaded",value:{fbid:d("WAJids").extractUserId(e),threadJid:c.jid}})}return d("MAWDexieTable").dexieResolve()}g.loadMessageRequestDataForThreads=a}),98);
__d("MAWThreadManagementTxns",["MAWBridgeEventTransmitter","MAWBridgeParticipants","MAWBridgeTypesCreators","MAWDbGroupInfoTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbParticipantTxns","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDexieTable","MAWGetOrCreateThreadTxns","MAWGroupInviteManagementTxns","MAWIndexedDb","MAWLoadMessageRequestCapabilitiesTxns","WAGlobals","WAJids","WALogger","WAMsgType","WASortedLists","WATimeUtils","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["metaSyncChatDeleteThread: message.originalTs less than lastMessageTimestamp but message.ts greater than lastMessageTimestamp"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted "," media rows and "," chunk rows"]);i=function(){return a};return a}function a(a,b){var c=b.authoritativeThreadKey,e=b.createTs,f=b.description,g=b.folder,h=b.lastActivityTimestamp,i=b.lastReadWatermarkTimestamp,j=b.offlineThreadingId,k=b.userJid;return d("MAWGetOrCreateThreadTxns").getOrCreateThread(a,{authoritativeThreadKey:c,clientThreadKey:j,createTs:e,description:f,folder:g,jid:k,lastActivityTimestamp:h,lastReadWatermarkTimestamp:i}).then(function(b){var c=b.created;b=b.thread;return n(a,k,c,b)})}function b(a,b){return d("MAWGetOrCreateThreadTxns").bulkGetOrCreateThread(a,b.map(function(a){var b=a.authoritativeThreadKey,c=a.createTs,d=a.description,e=a.folder,f=a.lastActivityTimestamp,g=a.lastReadWatermarkTimestamp,h=a.offlineThreadingId;a=a.userJid;return{authoritativeThreadKey:b,clientThreadKey:h,createTs:c,description:d,folder:e,jid:a,lastActivityTimestamp:f,lastReadWatermarkTimestamp:g}})).then(function(c){return d("MAWDexieTable").dexieAll(c.map(function(c,d){var e=c.created;c=c.thread;return n(a,b[d].userJid,e,c)}))})}function e(a,b,c,e){return d("MAWDbGroupInfoTxns").getGroupInfo(a,b).then(function(b){if(!b.success)return null;var f=b.value;return d("MAWGetOrCreateThreadTxns").getOrCreateThread(a,{createTs:d("WATimeUtils").castUnixTimeToMillisTime(f.creationTs),description:"getOrRepairGroupThread",folder:c,jid:f.groupJid,skipVerifyThread:e}).then(function(a){var b=a.created;a=a.thread;return{created:b,groupInfo:f,thread:a}})})}function j(a,b){var c=[],e=[];b.forEach(function(a){d("MAWDbMsg").isMediaMsg(a)&&a.mediaId!=null&&(c.push(a.mediaId),e.push(a.msgId))});return a.media.bulkGet(c).then(function(b){var c=[],f=[];b.forEach(function(a,b){if(a!=null){var g=e[b];a.msgIds=d("WASortedLists").filter(a.msgIds,function(a){return a!==g});a.mediaEntries["delete"](g);a.msgIds.length===0&&a.mediaEntries.size===0&&(a.plaintextHash!=null&&c.push(a.hashedPlaintextHash),f.push(a.mediaId))}});b=a.media.bulkDelete(f);var g=a.chunk.where("hashedPlaintextHash").anyOf(c)["delete"]();return d("MAWDexieTable").dexieAll([b,g]).then(function(){d("WALogger").LOG(i(),f.length,c.length)})})}function k(a,b){return d("MAWDbMsgTxns").getThreadNewestMessageTs(a,b).then(function(c){return a.messages.where("threadJid").equals(b.jid).toArray().then(function(d){return l(a,b,c,d,!0)})})}function f(a,b,c,e){var f=c==null?void 0:c.lastMessageTimestamp;if(c==null)return k(a,b);var g=a.messages.where("threadJid").equals(b.jid).toArray(),i=d("MAWDbMsgTxns").getThreadNewestMessageTs(a,b);return d("MAWDexieTable").dexieAll([g,i]).then(function(g){var i=g[0];g=g[1];var j=[],k=new Set();f!=null&&i.forEach(function(a){var b;b=(b=a.originalTs)!=null?b:a.ts;b<=f+1&&(k.add(a.msgId),j.push(a));b<=f+1&&a.ts>f&&d("WALogger").LOG(h())});if((c==null?void 0:c.messages.length)!==0){var m=new Set();c.messages.forEach(function(a){m.add((a=a.key)==null?void 0:a.id)});i.forEach(function(a){m.has(a.externalId)&&!k.has(a.msgId)&&(k.add(a.msgId),j.push(a))})}if(j.length!==i.length)for(var n=i,o=Array.isArray(n),p=0,n=o?n:n[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var q;if(o){if(p>=n.length)break;q=n[p++]}else{p=n.next();if(p.done)break;q=p.value}q=q;if(!k.has(q.msgId)&&q.type!==d("WAMsgType").ADMIN)return l(a,b,g,j,!1,e)}return l(a,b,g,i,!0,e)})}function l(a,b,c,e,f,g){var h=d("WAJids").interpretAsGroupJid(b.jid),i=f?d("MAWDbThreadTxns").deleteThreadRow(a,b.jid):d("MAWDexieTable").dexieResolve(),k=f?d("MAWDbParticipantTxns").deleteAllParticipantsForThread(a,b.jid):d("MAWDexieTable").dexieResolve(),l=d("MAWDexieTable").dexieResolve(!1),m=d("MAWDexieTable").dexieResolve();h!=null&&f&&(l=d("MAWGroupInviteManagementTxns").deleteGroupInvitesByThread(a,h),m=d("MAWDbGroupInfoTxns").deleteGroupInfo(a,h));return d("MAWDexieTable").dexieAll([j(a,e),d("MAWDbReactionsTxns").deleteAllReactionsForMessages(a,e),d("MAWDbMsgTxns").deleteMessages(a,e,g),i,k,m,l]).then(function(a){a[0];a[1];a[2];a[3];a[4];a[5];a=a[6];f?(d("MAWBridgeEventTransmitter").deleteMessagesOfThreadAfterTxn(b,c),h!=null&&a&&d("MAWIndexedDb").afterTransaction({tag:"DeleteGroupInvite",value:d("MAWBridgeTypesCreators").createBridgeDeleteGroupInvite(b.jid)}),d("MAWIndexedDb").afterTransaction({tag:"ThreadHiddenV2",value:b.jid})):d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.jid,e)});return{deletedMessages:e.map(function(a){return d("MAWDbMsg").getWAMsgId(a)})}})}function m(a,b){var c=b.offlineThreadingId,e=b.userJid;return d("MAWGetOrCreateThreadTxns").createThread(a,{clientThreadKey:c,description:"setupOneToOneThread",jid:e}).then(function(b){return n(a,e,!0,b)})}function n(a,b,e,f){var g=[d("MAWLoadMessageRequestCapabilitiesTxns").loadMessageRequestDataForThreads([f])];b=[{type:"participant",userJid:b}];var h=d("WAGlobals").getMyUserJid();h!==f.jid&&b.push({type:"participant",userJid:h});if(c("gkx")("23923")){g.push(d("MAWDbParticipantTxns").bulkUpsertParticiantsInThread(a,f.jid,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(a)})}));return d("MAWDexieTable").dexieAll(g).then(function(){return{created:e,thread:f}})}e?g.push(d("MAWDbParticipantTxns").bulkAddParticipants(a,f.jid,b).then(function(){})):g.push(d("MAWDbParticipantTxns").getParticipantsInThread(a,f.jid).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(a)})}));return d("MAWDexieTable").dexieAll(g).then(function(){return{created:e,thread:f}})}function o(a,b){var c=[d("MAWLoadMessageRequestCapabilitiesTxns").loadMessageRequestDataForThreads([b])];c.push(d("MAWDbParticipantTxns").getParticipantsInThread(a,b.jid).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(a)})}));return d("MAWDexieTable").dexieAll(c).then(function(){return b})}g.getOrSetupOneToOneThread=a;g.bukGetOrSetupOneToOneThread=b;g.getGroupThread=e;g.deleteAllThreadData=k;g.metaSyncChatDeleteThread=f;g.setupOneToOneThread=m;g.processSetupThreadResponseReadOnly=o}),98);
__d("MAWWriteGroupInviteTxns",["MAWBridgeTypesCreators","MAWDbGroupInviteTxns","MAWDbParticipant","MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWLowLevelApiTypes","MAWThreadManagementTxns","WAGlobals","WAGroupInviteUtils","WAJids","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){return d("MAWDbThreadTxns").getThread(a,c).then(function(c){return!c.success?d("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.MISSING_GROUP:d("MAWDbGroupInviteTxns").maybeGetGroupInvite(a,b.threadJid,b.inviteeJid).then(function(c){return c&&!d("WATimeUtils").isInFuture(c.inviteExpirationTs)?d("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.EXISTING_GROUP_INVITE:d("MAWDbGroupInviteTxns").putGroupInvite(a,b)})})}function b(a,b,c,e){var f=b.caption,g=b.groupJid,h=b.inviteCode;b=b.inviteExpiration;var i=d("WAJids").interpretAsUserJid(c);if(g==null||b==null||h==null||i==null)return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError({type:"invalid_args"}));c=[d("WATimeUtils").castLongIntToUnixTime(b),d("WAJids").toGroupJid(g),d("WAGroupInviteUtils").toInviteCode(h)];var j=c[0];b=c[1];var k=c[2],l={folder:e,groupJid:b,inviteCode:k,inviteExpireTs:j,inviterJid:i,type:"group_invite"};return d("MAWThreadManagementTxns").getGroupThread(a,b,e,!0).then(function(b){return b==null?d("WAResultOrError").makeError(l):d("MAWDbParticipantTxns").getParticipant(a,b.thread.jid,i)}).then(function(b){if(!b.success)return d("WAResultOrError").makeError(l);var c=d("WAGlobals").getMyUserJid(),e=d("MAWDbParticipant").craftParticipantId(b.value.threadJid,c);return d("MAWDbGroupInviteTxns").putGroupInvite(a,{caption:f==null?void 0:f.text,inviteCode:k,invitedParticipantId:e,inviteeJid:c,inviteExpirationTs:j,inviterJid:i,threadJid:b.value.threadJid}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"GroupInviteUpdate",value:d("MAWBridgeTypesCreators").createBridgeGroupInvite(a)});return d("WAResultOrError").makeResult()})})}g.writeGroupInvite=a;g.writeIncomingGroupInviteMsg=b}),98);
__d("MAWWriteReceiverFetchTxns",["FBLogger","MAWBridgeReceiverFetchInfo","MAWDbReceiverFetchTxns","MAWDexieTable","MAWIndexedDb","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Receiver fetch info not found for receiver fetch id: ",""]);h=function(){return a};return a}function a(a,b,e){return d("MAWDbReceiverFetchTxns").maybeGetReceiverFetchInfoFromReceiverFetchId(a,e.receiverFetchId).then(function(f){if(f==null)return a.receiverFetchInfo.add(e).then(function(){d("MAWIndexedDb").afterTransaction({tag:"NewReceiverFetchInfo",value:d("MAWBridgeReceiverFetchInfo").createBridgeReceiverFetchInfoPayloadFromUnstoredInfo(b,e)})})["catch"](function(a){c("FBLogger")("messenger_web_media").mustfix("Failed to add receiver fetch info to db, error: %s",a.message)});else{var g=babelHelpers["extends"]({},f,e);return a.receiverFetchInfo.update(e.receiverFetchId,g).then(function(){d("MAWIndexedDb").afterTransaction({tag:"NewReceiverFetchInfo",value:d("MAWBridgeReceiverFetchInfo").createBridgeReceiverFetchInfoPayloadFromDbInfo(b,g)})})["catch"](function(a){c("FBLogger")("messenger_web_media").mustfix("Failed to update receiver fetch info in db, error: %s",a.message)})}})}function b(a,b,e,f){return d("MAWDbReceiverFetchTxns").maybeGetReceiverFetchInfoFromReceiverFetchId(a,f).then(function(g){if(g==null){d("WALogger").ERROR(h(),f);return d("MAWDexieTable").dexieResolve()}else{g=babelHelpers["extends"]({},g,{previewUrl:b,previewUrlExpirationTimestampMs:e});return a.receiverFetchInfo.update(f,g).then(function(){})["catch"](function(a){c("FBLogger")("messenger_web_media").mustfix("Failed to update receiver fetch info in db, error: %s",a.message)})}})}g.handleUnstoredReceiverFetchInfo=a;g.updateReceiverFetchInfoWithPreviewUrl=b}),98);
__d("MAWExpiredXMACleaner",["MAWMsgCleaner","WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["ExpiredXMACleaner: Adding timestamps backend(",")"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["startExpiredXMACleaner invoked"]);j=function(){return a};return a}var k=null;function a(a){d("WALogger").LOG(j()),k==null&&(k=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.XMA))}function b(a){if(k==null){var b="Trying to add new addNewExpiredXMACleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(i(),b);throw c("err")(b)}else d("WALogger").DEV(h(),a),k.update(a)}function e(){return k}function f(){k=null}g.startExpiredXMACleaner=a;g.addNewExpiredXMACleanerTimestamp=b;g.getExpiredXMACleaner_FOR_TESTING_ONLY=e;g.resetExpiredXMACleaner_FOR_TESTING_ONLY=f}),98);
__d("MAWHandleXmaTransactionUtil",["MAWBridgeXMA","MAWDbChunkTxns","MAWDexieCastToPromise","MAWIndexedDb","MAWTransactionMode","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=!1;a!=null&&b.defaultPreviewMediaId===a.mediaId&&(c=(yield l(a)));return d("MAWBridgeXMA").createBridgeXMA(a,b,c)});return h.apply(this,arguments)}function c(a,b,c){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){a=(yield j(a,b,c));d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:a})});return i.apply(this,arguments)}function j(a,b,c){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){var e=!1;a!=null&&(e=(yield d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDbChunkTxns").hasMediaChunk(c,a.hashedPlaintextHash))));return d("MAWBridgeXMA").createBridgeXMA(a,b,e)});return k.apply(this,arguments)}var l=d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY},"MAWHandleXmaTransactionUtil.hasMediaChunkTransaction",function(a){return function(b){return d("MAWDbChunkTxns").hasMediaChunk(a,b.hashedPlaintextHash)}});g.checkMediaChunkTransactionAndCreatedBridgeXma=a;g.checkMediaChunkAndHandleXmaAfterTransaction=c;g.checkMediaChunkAndCreatedBridgeXma=j}),98);
__d("MAWXMAManagementTxns",["MAWDexieTable","MAWMediaManagementTxns","MAWXMAUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){var g=b.unstoredDbXMA,i=b.unstoredFavicon,j=b.unstoredHeaderMedia,k=b.unstoredPreviews;f===void 0&&(f=!1);var l=new Map(),m=function(b){return b!=null?d("MAWMediaManagementTxns").handleUnstoredDbMedia(a,b,c,!0).then(function(a){return[b.plaintextHash,a]}):d("MAWDexieTable").dexieResolve([void 0,void 0])};f||(l.set(i==null?void 0:i.plaintextHash,m(i)).set(j==null?void 0:j.plaintextHash,m(j)),k==null?void 0:k.forEach(function(a){l.set(a==null?void 0:a.plaintextHash,m(a))}));b=Array.from(l.values());return d("MAWDexieTable").dexieAll(b).then(function(b){var l,m=new Map(b),n=((l=k)!=null?l:[]).map(function(a){return m.get(a.plaintextHash)}).filter(Boolean);return h(a,f?d("MAWXMAUtils").buildUnstoredTombstonedXMA(g):g,(l=m.get(i==null?void 0:i.plaintextHash))==null?void 0:l.mediaId,(l=m.get(j==null?void 0:j.plaintextHash))==null?void 0:l.mediaId,n.map(function(a){return a.mediaId}),c,e).then(function(a){return{dbMedias:b.map(function(a){a[0];a=a[1];return a}).filter(Boolean),dbXMA:a,firstPreview:n[0]}})})}function h(a,b,d,e,f,g,h){h=babelHelpers["extends"]({},b,{associatedMessageId:(b=h)!=null?b:void 0,defaultPreviewMediaId:f[0],faviconMediaId:d,headerMediaId:e,msgId:g.msgId,previewMediaIds:f});return a.xma.add(h).then(function(b){return a.xma.get(b)}).then(function(a){if(a==null)throw c("err")("Failed to write XMA to db");return a})}function b(a,b,c,e,f,g,h,i,j,k){var l=d("MAWXMAUtils").isXMAExpired(!1,j.targetExpiringAtSec);h=babelHelpers["extends"]({},j,{associatedMessageId:(j=h)!=null?j:void 0,author:i.author,externalId:i.externalId,isTombstoned:l,msgId:g,offlineAttachmentId:k,targetType:f,threadJid:i.chat});var m=l?h:babelHelpers["extends"]({},h,{defaultPreviewMediaId:(j=b)!=null?j:void 0,faviconMediaId:(g=e)!=null?g:void 0,headerMediaId:(k=c)!=null?k:void 0,previewMediaIds:b!=null?[b]:[]});return a.xma.add(m).then(function(a){return babelHelpers["extends"]({},m,{xmaId:a})})}g.handleUnstoredXMAContent=a;g.saveXMA=b}),98);
__d("MAWWriteXMAMessageTxns",["MAWBridgeMsg","MAWBridgeXMA","MAWDbXMATxns","MAWDexieTable","MAWExpiredXMACleaner","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWMsgType","MAWWriteMsgTxns","MAWXMAManagementTxns","MAWXMAUtils","WAJids","WATimeUtils","err","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";f=6*d("WATimeUtils").HOUR_SECONDS;var h=new Set([d("MAWMsgType").MSG_TYPE.TEXT,d("MAWMsgType").MSG_TYPE.GIF,d("MAWMsgType").MSG_TYPE.STICKER]);function a(a,b,c,e){var f=c.unstoredAssociatedMedia,g=c.unstoredAssociatedMsg,h=c.unstoredDbXMA;return d("MAWDbXMATxns").maybeGetAssociatedXMAMsg(a,g,e.jid).then(function(c){var i=b;if(c!=null&&c.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT){var j=c.serverTs,k=c.sortOrderMs;c=c.ts;i=babelHelpers["extends"]({},b,{serverTs:j,sortOrderMs:k!=null?k-1:k,ts:c})}j=[h.targetExpiringAtSec,h.targetType];k=j[0];c=j[1];d("MAWXMAUtils").isXMAStoryReaction(c)&&(g==null?void 0:g.msgContent)!=null&&(i=babelHelpers["extends"]({},b,{msgContent:g.msgContent}));j=d("MAWXMAUtils").isXMAExpired(h.isTombstoned,k);i.isExpiredXmaMsg=j;k=!d("MAWXMAUtils").isXMAStoryReaction(c)&&g!=null?d("MAWWriteMsgTxns").prepareMsgWriteData(a,g,e):d("MAWDexieTable").dexieResolve(null);return d("MAWDexieTable").dexieAll([d("MAWWriteMsgTxns").prepareMsgWriteData(a,i,e),k]).then(function(a){var b=a[0];a=a[1];return{associatedData:a,associatedMedia:f,associatedMsg:g,xmaData:b,xmaMsg:i}})})}function b(a,b,e,f){var g=e.unstoredDbXMA,h=[g.targetExpiringAtSec,g.targetType],i=h[0];h=h[1];if(b==null||b.type===d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME)return d("MAWDexieTable").dexieResolve({dbMedias:null,dbXMA:null});b.isExpiredXmaMsg!==!0&&i!=null&&d("MAWExpiredXMACleaner").addNewExpiredXMACleanerTimestamp(i);d("MAWXMAUtils").isXMAStoryReaction(h)&&d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b)});return d("MAWXMAManagementTxns").handleUnstoredXMAContent(a,babelHelpers["extends"]({},e,{unstoredDbXMA:g}),b,f,b.isExpiredXmaMsg===!0).then(function(e){var f=e.dbMedias,g=e.dbXMA;e=e.firstPreview;g!=null&&!d("MAWXMAUtils").isXMAStoryReply(g.targetType)&&(b.isExpiredXmaMsg!==!0&&(c("gkx")("821")?c("promiseDone")(d("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(e,g,a)):d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:d("MAWBridgeXMA").createBridgeXMA(e,g,!1)})));return{dbMedias:f,dbXMA:g}})}function e(a,b,e,f,g,i,j){if(!h.has(g.type))throw c("err")("flow check, this message type is not supported for XMA replies: "+g.type);var k=b.author;if(k==="@system")throw c("err")("wrong author of story reply");var l=d("WAJids").interpretAsUserJid(f);if(l==null)throw c("err")("this is a flow check, participant jid can not be null");k={author:k===d("WAJids").AUTHOR_ME?l:d("WAJids").AUTHOR_ME,externalId:e.externalId,mediaId:i?void 0:e==null?void 0:e.defaultPreviewMediaId,msgId:c("gkx")("458")?e.msgId:void 0,sourceId:(l=(k=e.defaultCTA)==null?void 0:k.nativeUrl)!=null?l:(i=e.defaultCTA)==null?void 0:i.actionUrl,ts:b.ts,type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:e.targetType};var m=babelHelpers["extends"]({},g,{mediaId:(l=j==null?void 0:j.mediaId)!=null?l:g.mediaId,quote:{content:k,remoteJid:f}});return a.messages.put(m).then(function(){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(m)})})}g.REVOKE_CONTENT_EXPIRATION_IN_SEC=f;g.XMA_REPLY_MSG_SUPPORTED_TYPES=h;g.prepareXMAWriteData=a;g.handleIncomingXMA=b;g.handleXMAReplyMsg=e}),98);
__d("MAWHandleIncomingMsgApi",["MAWDbMsgTxns","MAWDbRavenActionTxns","MAWDexieTable","MAWEBSwitch","MAWEphemeralAdminMsgBuildTxns","MAWEphemeralMsgTxns","MAWEphemeralSettingsTxns","MAWHIMLogger","MAWJidUtils","MAWMediaManagementTxns","MAWMsgActionType","MAWMsgType","MAWPendingReceiptProcessingTxns","MAWUpdateQuotedMsgTxns","MAWWriteEditTxns","MAWWriteGroupInviteTxns","MAWWriteMsgTxns","MAWWriteReceiverFetchTxns","MAWWriteRevokeMessageTxns","MAWWriteXMAMessageTxns","MAWXMAUtils","WAJids","WAResultOrError","err","justknobx","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Could not write dbAssociatedMsg but it exists: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleIncomingMsgInternal: Finished writing the incoming message"]);i=function(){return a};return a}var j=c("requireDeferred")("ArmadilloReceiveWriteDbSuccessFalcoEvent").__setRef("MAWHandleIncomingMsgApi"),k=c("requireDeferred")("EncryptedBackupTaskSkippedFalcoEvent").__setRef("MAWHandleIncomingMsgApi"),l=d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult(void 0));function a(a,b){b.receiveFlow.addPoint("him_write_message_start");return m(a,b).then(function(a){var c;b.receiveFlow.addPoint("him_write_message_end",{bool:{outOfSync:(a==null?void 0:(c=a.value)==null?void 0:c.outOfSyncEphemeralSetting)!=null},string:{msgWrittenResultType:(c=a==null?void 0:(c=a.value)==null?void 0:c.msgType)!=null?c:"unknown"}});return a})["catch"](function(a){var c;a.message="[handleIncomingMsg] ["+((c=b.type)!=null?c:"")+"/"+b.action+"] "+a.message;throw a})}function m(a,b){if(b.action===d("MAWMsgActionType").MSG_ACTION.NO_ACTION)return l;var e=function(c,e,f){return d("MAWEphemeralMsgTxns").syncEphemeralSettingOnIncomingMsg(a,c,e,b.thread,b.device,f)};switch(b.type){case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b.msg,b.thread).then(function(){return d("WAResultOrError").makeResult(null)});case d("MAWMsgType").MSG_TYPE.RAVEN_ACTION:return d("MAWDbRavenActionTxns").writeRavenActionMsg(a,b.msg,b.thread).then(function(){return d("WAResultOrError").makeResult(null)});case d("MAWMsgType").MSG_TYPE.REACTION:return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult({reactToExternalId:b.msg.reactToExternalId}));case d("MAWMsgType").MSG_TYPE.GROUP_INVITE:return d("WAJids").isAuthorMe(b.id.author)?l:d("MAWWriteGroupInviteTxns").writeIncomingGroupInviteMsg(a,b.msg,b.thread.jid,b.folder);case d("MAWMsgType").MSG_TYPE.TEXT:case d("MAWMsgType").MSG_TYPE.FUTUREPROOF:case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:case d("MAWMsgType").MSG_TYPE.RAVEN:case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:if(b.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME)return d("MAWWriteMsgTxns").handleDeleteForMeMessage(a,b.msg,b.thread,b.pendingDeleteForMeStanza).then(function(a){return o(a)});var f=b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT?d("MAWWriteMsgTxns").writeCiphertextUpdate(a,b.msg,b.existingMsg,b.thread,b.existingEditMsgHistory):b.action===d("MAWMsgActionType").MSG_ACTION.REVOKE?d("MAWWriteMsgTxns").handleOutOfOrderRevokedMessage(a,b.msg,b.thread,b.pendingRevokedStanza):d("MAWWriteEditTxns").writeNewIncomingMsgAndEditHistory(a,b.msg,b.thread,b.editMsgHistories);return f.then(function(c){var f=b.type===d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH?d("MAWWriteReceiverFetchTxns").handleUnstoredReceiverFetchInfo(a,c,b.receiverFetchInfo):d("MAWDexieTable").dexieResolve(),g=b.media!=null?d("MAWMediaManagementTxns").handleUnstoredDbMedia(a,b.media,c):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([f,g]).then(function(f){f[0];var g=f[1];return d("MAWDexieTable").dexieAll([p(a,b.id,c,c.type!==d("MAWMsgType").MSG_TYPE.FUTUREPROOF),e(c,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(a){a[0];a=a[1];return o(c,a,g==null?null:[g])})}).then(function(e){var f={author:c.author,chat:c.threadJid,externalId:c.externalId};return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,f).then(function(c){if(c!=null)return d("MAWUpdateQuotedMsgTxns").associateAllReplies(a,c,b.thread.jid)}).then(function(){return e})})});case d("MAWMsgType").MSG_TYPE.REVOKED:return d("MAWWriteRevokeMessageTxns").writeIncomingRevokeMsg(a,b.msg,b.thread,b.originalMsg,b.previousRevokeMsg,b.ebTimestampMs).then(function(c){return d("MAWDexieTable").dexieAll([p(a,b.id,c),e(c,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(a){a[0];a=a[1];return o(c,a)})});case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return d("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(a,d("MAWJidUtils").getAuthorJid(b.id.author),b.device,b.msg.ephemeralExpirationInSec,b.msg.ephemeralLastUpdatedOrSetTimestamp,b.msg.isEphemeralSettingReset,b.thread,b.ts,b.id.externalId,!0).then(function(c){return p(a,b.id,c==null?void 0:c.dbMsg).then(function(){return o(c==null?void 0:c.dbMsg,c==null?void 0:c.outOfSyncEphemeralSetting)})});case d("MAWMsgType").MSG_TYPE.ICDC_ALERT:return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult({msgType:void 0,outOfSyncEphemeralSetting:void 0,plaintextHashs:void 0}));case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return d("MAWEphemeralAdminMsgBuildTxns").writeEphemeralScreenshotActionMsg(a,d("MAWJidUtils").getAuthorJid(b.id.author),b.thread,b.ts,b.screenshotActionType,b.id.externalId,b.existingMsg).then(function(c){return d("MAWDexieTable").dexieAll([p(a,b.id,c),e(c,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(a){a[0];a=a[1];return o(c,a)})});case d("MAWMsgType").MSG_TYPE.XMA:if(b.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME)return d("MAWWriteMsgTxns").handleDeleteForMeMessage(a,b.msg,b.thread,b.pendingDeleteForMeStanza).then(function(a){return o(a)});f=b.action===d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED||b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED?q(a,b):b.action===d("MAWMsgActionType").MSG_ACTION.REVOKE?n(a,b):n(a,b).then(function(c){return d("MAWWriteXMAMessageTxns").handleIncomingXMA(a,c,b.xma,null).then(function(a){return babelHelpers["extends"]({},a,{dbMsg:c})})});return f.then(function(c){var f=c.dbAssociatedMsg,g=c.dbMedias,h=c.dbMsg;return d("MAWDexieTable").dexieAll([p(a,b.id,h,!0,f),e(h,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(c){c[0];var e=c[1];return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b.id).then(function(c){if(c!=null)return d("MAWUpdateQuotedMsgTxns").associateAllReplies(a,c,b.thread.jid)}).then(function(){return e})}).then(function(a){return o(h,a,g)})});default:throw c("err")("We do not support handleIncomingMsgInternal with type: "+((f=b.type)!=null?f:""))}}function n(a,b){return b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT||b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED?d("MAWWriteMsgTxns").writeCiphertextUpdate(a,b.msg,b.existingMsg,b.thread,null):b.action===d("MAWMsgActionType").MSG_ACTION.REVOKE?d("MAWWriteMsgTxns").handleOutOfOrderRevokedMessage(a,b.msg,b.thread,b.pendingRevokedStanza):d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b.msg,b.thread)}function o(a,b,c){return d("WAResultOrError").makeResult({msgType:a==null?void 0:a.type,outOfSyncEphemeralSetting:(a=b)!=null?a:void 0,plaintextHashs:c==null?void 0:c.map(function(a){return a.plaintextHash})})}function p(a,b,e,f,g){var h=b.author,l=b.chat,m=b.externalId;f===void 0&&(f=!1);if(e==null)return d("MAWDexieTable").dexieResolve();void j.load().then(function(a){return a.log(function(){return{encrypted_backup_enable:c("MAWEBSwitch").isEnabled(),message_id:m}})});(!f||!c("MAWEBSwitch").isEnabled())&&void k.load().then(function(a){return a.log(function(){return{message_id:m,skipped_reason:"Msg type: "+e.type+", EB enabled: "+c("MAWEBSwitch").isEnabled().toString()}})});if(e==null)return d("MAWDexieTable").dexieResolve();b=d("MAWPendingReceiptProcessingTxns").processPendingReceipts(a,l,e);f=h===d("WAJids").AUTHOR_ME&&g!=null&&g.type!==d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME?d("MAWPendingReceiptProcessingTxns").processPendingReceipts(a,l,g):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([b,f]).then(function(){c("MAWHIMLogger").LOG(i())})}function q(a,b){return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b.associatedMsg,b.thread).then(function(e){return e.type===d("MAWMsgType").MSG_TYPE.REVOKED&&c("justknobx")._("2848")?d("MAWDexieTable").dexieResolve({dbAssociatedMsg:null,dbMedias:null,dbMsg:null}):n(a,b).then(function(c){if(b.associatedMedia!=null)return d("MAWMediaManagementTxns").handleUnstoredDbMedia(a,b.associatedMedia,e).then(function(d){return r(a,c,e,b.xma,b.msg,b.associatedMsg,b.thread.jid,d)});else return r(a,c,e,b.xma,b.msg,b.associatedMsg,b.thread.jid)})})}function r(a,b,e,f,g,i,j,k){return d("MAWWriteXMAMessageTxns").handleIncomingXMA(a,b,f,e.msgId).then(function(f){var l=f.dbMedias;f=f.dbXMA;e==null&&c("MAWHIMLogger").ERROR(h(),i.externalId);return(e!=null&&f!=null&&d("MAWXMAUtils").isXMAStoryReply(f.targetType)?d("MAWWriteXMAMessageTxns").handleXMAReplyMsg(a,g,f,j,e,g.isExpiredXmaMsg===!0,k):d("MAWDexieTable").dexieResolve()).then(function(){return k!=null?{dbAssociatedMsg:e,dbMedias:l!=null?[].concat(l,[k]):[k],dbMsg:b}:{dbAssociatedMsg:e,dbMedias:l,dbMsg:b}})})}g.handleIncomingMsg=a;g.processReceipts=p}),98);
__d("MAWLinkReactionsToMsgsTxns",["LSQueryBulkUtils","MAWDbMsgTxns","MAWDbReactionUtils","MAWDexieCastToPromise","MAWRestoreDbState","MAWTransactor","WAMsgMap","asyncToGeneratorRuntime","qex"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a.reduce(function(a,b){var c,d={author:b.reactToAuthor,chat:b.threadJid,externalId:b.reactToExternalId};c=(c=a.get(d))!=null?c:[];c.push(b);return a.set(d,c)},new(d("WAMsgMap").MsgMap)())}function i(a){a.forEach(function(a){d("MAWDbReactionUtils").dispatchReaction(a)})}function j(a,b){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){a=(yield d("MAWTransactor").runInLSDB(function(a){return d("LSQueryBulkUtils").bulkGetByIndex(a.e2ee_reactions.index("reactToExternalId"),b)}));return a});return k.apply(this,arguments)}function l(a,b){return a.reactions.where("reactToExternalId").anyOf(b).toArray()}function m(a,b){var e=d("MAWRestoreDbState").isUsingShim_UNSAFE()&&c("qex")._("1016")?function(){return d("MAWDexieCastToPromise").promiseCastToDexiePromise_I_KNOW_WHAT_I_AM_DOING(j(a,b))}:function(){return l(a,b)};return e().then(function(a){return h(a.filter(function(a){return a.reactToMsgId==null}))})}function a(a,b){return m(a,b).then(function(b){return d("MAWDbMsgTxns").getMsgsByProtocolMsgId(a,b.keys()).then(function(a){return a.flatMap(function(a){var c={author:a.author,chat:a.threadJid,externalId:a.externalId};c=(c=b.get(c))!=null?c:[];return c.map(function(b){b.reactToMsgId=a.msgId;return b})})})})}function n(a,b){return a.reactions.bulkPut(b).then(function(){i(b)})}function o(a,b){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c){yield d("MAWTransactor").runInLSDB(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=a.e2ee_reactions;yield d("LSQueryBulkUtils").bulkPut(a,c)});return function(b){return a.apply(this,arguments)}}())});return p.apply(this,arguments)}function e(a,b){return d("MAWRestoreDbState").isUsingShim_UNSAFE()&&c("qex")._("1016")?d("MAWDexieCastToPromise").promiseCastToDexiePromise_I_KNOW_WHAT_I_AM_DOING(o(a,b)):n(a,b)}g.getReactionLinkUpdatesForExternalIds=a;g.updateReactionLinks=e}),98);
__d("MAWLinkReactionsToMsgsApi",["MAWIndexedDb","MAWLinkReactionsToMsgsTxns","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";var h=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READONLY},"linkReactionsToMsgs",function(a){return function(b){return d("MAWLinkReactionsToMsgsTxns").getReactionLinkUpdatesForExternalIds(a,b).then(function(b){return d("MAWLinkReactionsToMsgsTxns").updateReactionLinks(a,b)})}});function a(a){return h(a)}g.linkReactionsToMsgs=a}),98);
__d("MAWOfflineThreadTxns",["MAWBridgeThread","MAWDbGroupInfoTxns","MAWDbParticipantTxns","MAWDbThread","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWLoadMessageRequestCapabilitiesTxns","MAWWriteBulkWriteIncomingAdminMsgTxns","WAArrayZip","WAGlobals","WAJids","WATagsLogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Duplicated thread creation for ",""]);h=function(){return a};return a}var i=new Set();function a(a,b,c){var e=new Set(b),f=new Map(),g=new Map();c.forEach(function(a){g.set(a.jid,"exists"),f.set(a.jid,a),e["delete"](a.jid)});if(e.size===0)return d("MAWDexieTable").dexieResolve({threadCreationResult:g,threads:f});e.forEach(function(a){i.has(a)&&d("WATagsLogger").TAGS(["occamadillo","incoming_processing"]).LOG(h(),a)});return n(a,e).then(function(b){b.oneToOneThreadsCreationData.forEach(function(a){i.add(a.thread.jid)});b.groupThreadsCreationData.forEach(function(a,b){i.add(b),a.groupInfo==null&&g.set(b,"missing")});return a.threads.bulkAdd(o(b),{allKeys:!0}).then(function(b){return d("MAWDbThreadTxns").getThreads(a,Array.from(e.values())).then(function(b){l(b);var c=p(b);return d("MAWDexieTable").dexieAll([j(a,c),d("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreads(a,b)]).then(function(){b.forEach(function(a){return f.set(a.jid,a)});return{threadCreationResult:g,threads:f}})})})})}function j(a,b){return d("MAWDexieTable").dexieAll([k(a,b),d("MAWLoadMessageRequestCapabilitiesTxns").loadMessageRequestDataForThreads(Array.from(b.values()))])}function k(a,b){var c=[],e=d("WAGlobals").getMyUserJid();b.forEach(function(a,b){c.push({threadJid:b,type:"participant",userJid:b}),e!==b&&c.push({threadJid:b,type:"participant",userJid:e})});return d("MAWDbParticipantTxns").bulkAddParticipantsInThreads(a,c).then(function(){})}function l(a){a.forEach(function(a){return d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(a,a.optimisticThreadKey,void 0,"createAllThreadsForOfflineMsgs")})})}function m(a,b){return{folder:null,jid:a,lastReadMsg:null,lastReadMsgReceiptSent:null,lastReadMsgTs:null,newestMsg:null,newestMsgTs:b!=null?d("WATimeUtils").castUnixTimeToMillisTime(b):null,oldestMsg:null,optimisticThreadKey:void 0,threadOrder:d("MAWDbThread").craftThreadOrder(d("WATimeUtils").millisTime(),a)}}function n(a,b){var c=[],e=[];b.forEach(function(a){d("WAJids").switchOnMsgrChatJidType(a,{group:function(a){return c.push(a)},user:function(a){return e.push(a)}})});return d("MAWDbGroupInfoTxns").getGroupInfos(a,c).then(function(a){var b=new Map(d("WAArrayZip").zip(c,a));a=new Map(c.map(function(a){var c=b.get(a);return[a,{groupInfo:c,thread:m(a,c==null?void 0:c.creationTs)}]}));var f=new Map(e.map(function(a){return[a,{thread:m(a,null)}]}));return{groupThreadsCreationData:a,oneToOneThreadsCreationData:f}})}function o(a){var b=a.groupThreadsCreationData;a=a.oneToOneThreadsCreationData;return Array.from(b.values()).map(function(a){a=a.thread;return a}).concat(Array.from(a.values()).map(function(a){a=a.thread;return a}))}function p(a){var b=new Map();a.forEach(function(a){d("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(a){},user:function(c){return b.set(c,a)}})});return b}g.createAllThreadsForOfflineMsgs=a}),98);
__d("MAWPreprocessMsgs",["MAWBuildIncomingMsgs","MAWDbMsgTxns","MAWDexieTable","MAWHIMLogger","MAWMediaManagementTxns","MAWMsgActionType","MAWMsgType","MAWWriteMsgTxns","MAWWriteXMAMessageTxns","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unsupported message type on preprocessing ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media is null for StanzaID ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Preparing media for msg with StanzaID ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpected msg type when writing ephemeral setting message. Should not happen"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["No unstored content for incoming message: SHOULD NEVER HAPPEN"]);l=function(){return a};return a}var m=c("MAWHIMLogger").TAGS(["MAWPreprocessMsgs"]);function a(a){var b=[],c=[];a.forEach(function(a){var d=a.msgData;a=a.unstoredContent;switch(d.type){case"IncomingMsg":if(a==null){m.ERROR(l());return}var e=a.unstoredDbEditActionMsg;a=a.unstoredDbReaction;if(a!=null){a={chatJid:d.id.chat,unstoredReaction:a};b.push(a)}e!=null&&c.push({chatJid:d.id.chat,msg:e});break;case"IncomingCiphertextMsg":default:break}});return{editActionMsgs:c,reactionMsgs:b}}function b(a,b,c){b.receiveFlow.addPoint("him_get_preprocessing_data_start");return n(a,b,c).then(function(a){var c;b.receiveFlow.addPoint("him_get_preprocessing_data_end",{string:{action:a.action,type:(c=a.type)!=null?c:""}});return a})}function n(a,b,c){var e=b.msgData,f=b.receiveFlow,g=b.unstoredContent;b=e.folder;var l=e.id,n=e.ts,p={id:l,receiveFlow:f,thread:c,ts:n},q=d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.NO_ACTION,msg:null,type:null}));switch(e.type){case"IncomingMsg":if(g==null)return q;var r=e.device,s=g.unstoredDbMsg;f=g.unstoredDbRavenActionMsg;var t=g.unstoredDbReaction,u=g.unstoredDbReceiverFetchInfo,v=g.unstoredIncomingDbGroupInvite;if(f!=null)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:f,type:d("MAWMsgType").MSG_TYPE.RAVEN_ACTION}));else if(t!=null)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:t,type:d("MAWMsgType").MSG_TYPE.REACTION}));else if(v!=null)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,folder:b,msg:v,type:d("MAWMsgType").MSG_TYPE.GROUP_INVITE}));else if(s==null)return q;else if(s.type===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN){f=e.msg;if(f.version==="v3"&&f.type==="ephemeral")return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,msg:f,type:s.type}));else{m.ERROR(k());return q}}else if(s.type===d("MAWMsgType").MSG_TYPE.ICDC_ALERT)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,data:null,device:r,folder:b,type:s.type}));else if(s.type===d("MAWMsgType").MSG_TYPE.TEXT||s.type===d("MAWMsgType").MSG_TYPE.FUTUREPROOF)return d("MAWWriteMsgTxns").prepareTextMsgWriteData(a,s,c).then(function(a){var b=a.editMsgHistories,c=a.existingEditMsgHistory,e=a.existingMsg,f=a.isDeletedWithThread,g=a.isDeleteForMeOrRevoked,h=a.pendingDeleteForMeStanza;a=a.pendingRevokedStanza;var i=o(e,s,c);if(g||f||e!=null&&i!==!0)return q;if(i&&e!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,device:r,existingEditMsgHistory:c,existingMsg:e,msg:s,type:s.type});if(h!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:s,pendingDeleteForMeStanza:h,type:s.type});return a!=null?babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.REVOKE,device:r,msg:s,pendingRevokedStanza:a,type:s.type}):babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,editMsgHistories:b,msg:s,type:s.type})});else if(s.type===d("MAWMsgType").MSG_TYPE.IMAGE||s.type===d("MAWMsgType").MSG_TYPE.VIDEO||s.type===d("MAWMsgType").MSG_TYPE.PTT||s.type===d("MAWMsgType").MSG_TYPE.GIF||s.type===d("MAWMsgType").MSG_TYPE.STICKER||s.type===d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE||s.type===d("MAWMsgType").MSG_TYPE.RAVEN){s.type===d("MAWMsgType").MSG_TYPE.IMAGE&&((t=e.msg.metadata)==null?void 0:t.groupId)!=null&&(s.groupId=e.msg.metadata.groupId,s.groupIndex=e.msg.metadata.groupIndex,s.groupSize=e.msg.metadata.groupSize);m.LOG(j(),s.externalId);return d("MAWMediaManagementTxns").prepareMediaWriteData(a,s,g==null?void 0:g.unstoredDbMedia,c).then(function(a){var b=a.existingMsg,c=a.isDeletedWithThread,e=a.isDeleteForMeOrRevoked,f=a.pendingDeleteForMeStanza,h=a.pendingRevokedStanza;a=a.shouldDropDocument;var j=[g==null?void 0:g.unstoredDbMedia,o(b,s)],k=j[0];j=j[1];k==null&&m.LOG(i(),s.externalId);if(a===!0||e||c||k==null||b!=null&&!j)return q;if(j&&b!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,device:r,existingMsg:b,media:k,msg:s,type:s.type});if(f!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:s,pendingDeleteForMeStanza:f,type:s.type});return h!=null?babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.REVOKE,device:r,msg:s,pendingRevokedStanza:h,type:s.type}):babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,media:k,msg:s,type:s.type})})}else if(s.type===d("MAWMsgType").MSG_TYPE.XMA){var w=g==null?void 0:g.unstoredXMA;return w==null?q:d("MAWWriteXMAMessageTxns").prepareXMAWriteData(a,s,w,c).then(function(a){var b=a.xmaData.existingMsg,c=o(b,s);if(a.associatedMsg!=null&&a.associatedData!=null&&!a.associatedData.isDeletedWithThread&&!a.associatedData.isDeleteForMeOrRevoked)if(c&&b!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED,associatedMsg:a.associatedMsg,device:r,existingMsg:b,msg:a.xmaMsg,type:s.type,xma:w});else return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED,associatedMedia:a.associatedMedia,associatedMsg:a.associatedMsg,device:r,msg:a.xmaMsg,type:s.type,xma:w});if(c&&b!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,device:r,existingMsg:b,msg:a.xmaMsg,type:s.type,xma:w});c=a.xmaData;var e=c.isDeletedWithThread,f=c.isDeleteForMeOrRevoked,g=c.pendingDeleteForMeStanza;c=c.pendingRevokedStanza;if(e||f||b!=null)return q;if(g!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:a.xmaMsg,pendingDeleteForMeStanza:g,type:s.type});return c!=null?babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.REVOKE,device:r,msg:a.xmaMsg,pendingRevokedStanza:c,type:s.type}):babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,msg:a.xmaMsg,type:s.type,xma:w})})}else if(s.type===d("MAWMsgType").MSG_TYPE.REVOKED)return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,s.revokedExternalId,c.jid,l.author),d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,s.externalId,c.jid,l.author)]).then(function(a){var b=a[0];a=a[1];return a!=null?q:babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,ebTimestampMs:s.ebTimestampMs,msg:s,originalMsg:b,previousRevokeMsg:a,type:s.type})});else if(s.type===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION){v=d("WAJids").isAuthorMe(l.author)?d("WAGlobals").getMyUserJid():l.author;return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,l.externalId,c.jid,v)]).then(function(a){a=a[0];return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,existingMsg:a,screenshotActionType:s.msgContent.screenshotActionType,type:s.type})})}else if(s.type===d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE)return d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,l.externalId,c.jid,l.author).then(function(a){return a!=null?q:babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,msg:s,type:s.type})});else if(s.type===d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH&&u!=null)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,msg:s,receiverFetchInfo:u,type:s.type}));else{m.ERROR(h(),s.type);return q}case"IncomingCiphertextMsg":if(!((f=e==null?void 0:e.createPlaceholder)!=null?f:!1))return q;var x=d("MAWBuildIncomingMsgs").buildUnstoredCiphertextMsg(l,n);return d("MAWWriteMsgTxns").prepareMsgWriteData(a,x,c).then(function(a){var b=a.existingMsg,c=a.isDeletedWithThread;a=a.isDeleteForMeOrRevoked;return a||c||b!=null?q:babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:x,type:d("MAWMsgType").MSG_TYPE.CIPHERTEXT})});case"UnavailableMsg":case"FrankingInvalidMsg":var y=d("MAWBuildIncomingMsgs").buildUnstoredUnavailableMsg(l,n);return d("MAWWriteMsgTxns").prepareMsgWriteData(a,y,c).then(function(a){var b=a.existingMsg,c=a.isDeletedWithThread;a=a.isDeleteForMeOrRevoked;return a||c||b!=null?q:babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:y,type:d("MAWMsgType").MSG_TYPE.UNAVAILABLE})})}}function o(a,b,c){if(a==null&&c==null)return!1;return b.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?!1:(a==null?void 0:a.type)===d("MAWMsgType").MSG_TYPE.CIPHERTEXT||(c==null?void 0:c.msgContent.content)===""}g.classifyIncomingMsgs=a;g.getMessageDataByType=b;g.isCiphertextUpdate=o}),98);
__d("MAWSharedOfflineQueueMetric",["$InternalEnum","FBLogger","WAGlobals","WAPREList","WATagsLogger","WATimeUtils","WAWaterFlow"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["New mailbox age is ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["New mailbox age is ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Waterflow should start before the start of the processing"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Possible stuck reason: ",""]);k=function(){return a};return a}var l=d("WATagsLogger").TAGS(["offline-resume"]);f=b("$InternalEnum").Mirrored(["OFFLINE","ONLINE"]);var m=b("$InternalEnum").Mirrored(["WA_CLIENT_INFRA","WA_CLIENT_INFRA_DUPLICATED_START","WA_PASSIVE_MODE","WA_PASSIVE_MODE_FAIL","MAW_INFRA","MAW_NOT_IDLE_OQ"]),n=function(){function a(a,b,c,e){this.$1=0,this.$3=c,this.$2=d("WAWaterFlow").makeWaterflow("offline-resume",d("WAPREList").PRE_METRIC.OFFLINE_QUEUE),this.$6(a),this.$7(),this.$8(b),this.$9(e),this.$4=Math.round(d("WATimeUtils").performanceAbsoluteNow()/1e3)}var b=a.prototype;b.$8=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"passive-mode-start":b.$2.isOnGoing()||b.$2.startMetric();b.$2.startPoint(m.WA_PASSIVE_MODE,{passiveModeAcks:a.count});b.$10("passive");break;case"passive-mode-end":b.$2.endPoint(m.WA_PASSIVE_MODE);b.$10("passive-end");break;default:a.type,b.$2.addPoint(m.WA_PASSIVE_MODE_FAIL),b.$10("passive-end")}})};b.$9=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"new-message":if(a.commonMessageBase.offline==null)return;b.addWAMessage();b.$10("wa");break}})};b.$6=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"offline-start":b.$11(a.offlineStats);b.$10("wa-start");break;case"offline-end":b.$2.isOnGoing()&&(b.$2.endPoint(m.WA_CLIENT_INFRA),b.$10("maw"));break;case"offline-entity":b.$12(a.serverTs,a.offline);b.$10("wa");break;case"offline-processed":b.$13(a.count);b.$10("wa");break;case"connection-lost":b.$2.isOnGoing()&&b.$2.endFail("connection-lost");b.$14();break;default:a}})};b.$10=function(a,b){var c=this;b===void 0&&(b=15e3);clearTimeout(this.$5);this.$2.isOnGoing()&&(this.$5=setTimeout(function(){c.$2.isOnGoing()&&(c.$2.endFail(a+"-stuck"),l.WARN(k(),a))},b))};b.$14=function(){clearTimeout(this.$5)};b.$7=function(){var a=this;this.$3.subscribe(function(b){switch(b.type){case"idle-oq-safe-guard":if(!a.$2.isOnGoing())break;a.$2.addPoint(m.MAW_NOT_IDLE_OQ);break;case"maw-infra-start":if(!a.$2.isOnGoing())break;a.$10("maw");a.$2.startPoint(m.MAW_INFRA);break;case"maw-infra-batch":a.$2.isOnGoing()||(a.$2.startMetric(),a.$2.startPoint(m.MAW_INFRA));a.$10("maw");break;case"maw-infra-end":if(!a.$2.isOnGoing())break;a.$2.endPoint(m.MAW_INFRA);a.$14();b.success?a.$2.endSuccess():a.$2.endFail("fail");break;default:b}})};b.addWAMessage=function(){this.$2.isOnGoing()&&(this.$2.reAnnotate(function(a){a=a.waMessage;return{waMessage:((a=a)!=null?a:0)+1}}),this.$10("wa"))};b.addMAWEntity=function(a){this.$2.isOnGoing()&&(this.$2.reAnnotate(function(b){b=b.mawProcessedCount;return{mawProcessedCount:((b=b)!=null?b:0)+a}}),this.$10("maw"))};b.$11=function(a){this.$2.isOnGoing()?this.$2.addPoint(m.WA_CLIENT_INFRA_DUPLICATED_START):(this.$1++,this.$2.startMetric(),this.$4=Math.round(d("WATimeUtils").performanceAbsoluteNow()/1e3)),this.$2.startPoint(m.WA_CLIENT_INFRA,{batchSize:d("WAGlobals").getConfig().batchSize(),expectedAppdata:a.appdata,expectedCount:a.count,expectedMessage:a.message,expectedNotification:a.notification,expectedReceipt:a.receipt,offlineResumeCount:this.$1,useIncreasedSignalFutureMessagesMax:d("WAGlobals").getConfig().getSignalFutureMessagesMax()>2e3,waDanglingQueue:d("WAGlobals").getConfig().waDanglingQueue()})};b.getDetails=function(){var a;return((a=this.$2)==null?void 0:a.getAnnotations())||{}};b.$13=function(a){var b;(b=this.$2)==null?void 0:b.reAnnotate(function(b){return{waProcessed:((b=b.waProcessed)!=null?b:0)+a}})};b.addRuntimeErrorDuringOffflineQueue=function(){if(this.$2.isOnGoing()){var a;(a=this.$2)==null?void 0:a.reAnnotate(function(a){return{runtimeErrors:((a=a.runtimeErrors)!=null?a:0)+1}})}};b.addDecryptionError=function(){if(this.$2.isOnGoing()){var a;(a=this.$2)==null?void 0:a.reAnnotate(function(a){return{decryptErrors:((a=a.decryptErrors)!=null?a:0)+1}})}};b.addRetriesTrack=function(a){if(this.$2.isOnGoing()){var b;(b=this.$2)==null?void 0:b.reAnnotate(function(b){return{retries:((b=b.retries)!=null?b:0)+a}})}};b.$12=function(a,b){var c=this;if(!this.$2.isOnGoing()){l.WARN(j());return}this.$2.reAnnotate(function(d){var e=d.mailboxAgeSec,f=d.maxOffline;d=d.waDownloaded;e=e;e==null&&a!=null&&(e=c.$4-a,l.LOG(i(),e));e!=null&&a!=null&&(c.$4-a>e&&(e=c.$4-a,l.LOG(h(),e)));return{mailboxAgeSec:e,maxOffline:Math.max((e=f)!=null?e:0,b),waDownloaded:((f=d)!=null?f:0)+1}})};return a}(),o;function a(a,b,d,e){if(o!=null){var f=o;c("FBLogger")("messenger_e2ee_web").mustfix("Offline sync reported is inited twice");return f}o=new n(a,b,d,e);return o}function e(){if(o==null){c("FBLogger")("messenger_e2ee_web").mustfix("Offline sync reported is not inited");return null}return o}g.OfflineMode=f;g.OfflineStages=m;g.makeOfflineQueueMetric=a;g.getOfflineQueueMetric=e}),98);
__d("WAThrottle",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c=0,d=null,e;function f(){var f=Date.now(),g=f-c;for(var h=arguments.length,i=new Array(h),j=0;j<h;j++)i[j]=arguments[j];e=i;g>=b?(clearTimeout(d),d=null,a.apply(void 0,i),c=Date.now()):d==null&&(d=setTimeout(function(){return a.apply(void 0,e)},b-g))}return f}f.throttle=a}),66);
__d("MAWSharedOfflineResumeUINotifier",["MAWBridge","MAWQplProxy","MAWSharedProtocolQueueConst","WAOfflineUtils","WATagsLogger","WAThrottle","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose([' -> Unable to send "Offline Complete" event ',""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose([' -> "Offline Complete" bridge event sent']);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAW UI: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Set thread metadata: ",", ",""]);k=function(){return a};return a}var l=1e3/3,m=d("WATagsLogger").TAGS(["ProtocolQueue","MAWConsumer"]);a=function(){function a(){var a=this;this.$1={};this.$2={};this.$3=0;this.$4="wa";this.$5=!1;this.$6=0;this.$7=0;this.$8=0;this.$9=0;this.$10=null;this.$16=d("WAThrottle").throttle(function(){if(a.$5)return;a.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing)},l);this.$12=d("WAThrottle").throttle(function(){a.$4==="wa"&&a.$5===!1&&a.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Processing)},l)}var b=a.prototype;b.subscribeToWAEvents=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"offline-start":b.$10=d("MAWQplProxy").performanceAbsoluteNow();b.$6=a.offlineStats.count;b.$8=a.offlineStats.message;b.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Initializing,b.$10);b.$5=!1;b.$4="wa";break;case"offline-processed":break;case"offline-entity":b.$7++;b.$12();break;case"offline-end":b.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Complete);b.$4="maw";break;case"connection-lost":b.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Failed);break;default:a}})};b.subscribeToMawEvents=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"maw-infra-start":b.$10==null&&(b.$10=d("MAWQplProxy").performanceAbsoluteNow());b.$13();break;case"maw-infra-end":a.success?b.notifyUICurrentProcessingSucceeded():b.$14();b.$10=null;break}})};b.subscribeToMessageEvents=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"new-message":if(a.commonMessageBase.offline==null)return;b.addWAMessage();break}})};b.addWAMessage=function(){this.$9++,this.$12()};b.$13=function(){this.$3=0,this.$5=!1,this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Initializing)};b.setThreadMetadata=function(a){var b=a.reduce(function(a,b){a[b.from]=b.t;return a},{});a=a.reduce(function(a,b){b=b.from;a[b]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing};return a},{});m.DEV(k(),JSON.stringify(b),JSON.stringify(a));this.$1=b;this.$2=a};b.notifyUIChatReady=function(a){this.$2[a]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete},this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing)};b.updateChatState=function(a){var b=this;Object.entries(a).forEach(function(a){var c=a[0];a=a[1];if(b.$1[c]!=null){var e=b.$1[c];a>=e&&(b.$2[c]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete})}});this.$16()};b.addMAWEntity=function(a){this.$3+=a,this.$16()};b.notifyUICurrentProcessingSucceeded=function(){var a=this;Object.keys(this.$2).forEach(function(b){a.$2[b]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete}});this.$5=!0;this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete);this.$1={};this.$2={}};b.$14=function(){var a=this;Object.keys(this.$2).forEach(function(b){a.$2[b]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete}});this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Failed);this.$1={};this.$2={}};b.maybeNotifyUI=function(){this.$16()};b.$11=function(a,b){d("MAWBridge").getBridge().fireAndForget("event","offlineSnapshot",{downloaded:{count:this.$7,message:this.$9},expected:{count:this.$6,message:this.$8},status:a,timestamp:b!=null?b:d("MAWQplProxy").performanceAbsoluteNow()})};b.$15=function(a){var b=d("MAWQplProxy").performanceAbsoluteNow();b={chatJidStatus:this.$2,startTime:this.$10!=null?this.$10:null,status:a,timestamp:b,totalExpectedCount:this.$6,totalProcessedCount:this.$3};m.LOG(j(),JSON.stringify(b));a===d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete?c("promiseDone")(d("MAWBridge").getBridge().sendAndReceive("event","offlineConsumerProgress",b),function(){m.LOG(i())},function(a){m.ERROR(h(),a)}):d("MAWBridge").getBridge().fireAndForget("event","offlineConsumerProgress",b)};return a}();b=new a();g.ConsumerUINotifier=a;g.offlineResumeUINotifier=b}),98);
__d("MAWLoadGroupInvitesTxns",["MAWBridgeTypesCreators","MAWDbGroupInviteTxns","MAWDexieTable","MAWIndexedDb","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=[],e=d("WAGlobals").getMyUserJid();b.forEach(function(b){return d("WAJids").switchOnMsgrChatJidType(b.jid,{group:function(){c.push(d("MAWDbGroupInviteTxns").getGroupInvitesByThreadAndInvitedParticipant(a,b.jid,e))},user:function(){}})});return d("MAWDexieTable").dexieAll(c).then(function(a){a.forEach(function(a,b){a.forEach(function(b,a){d("MAWIndexedDb").afterTransaction({tag:"GroupInviteUpdate",value:d("MAWBridgeTypesCreators").createBridgeGroupInvite(b)})})})})}g.loadGroupInvites=a}),98);
__d("MAWLoadMsgsTxns",["MAWBridgeMsg","MAWBridgeMsgCountdown","MAWBridgeTypesCreators","MAWBridgeXMA","MAWDbChunkTxns","MAWDbEditMsgHistoryTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDbReactionUtils","MAWDbReactionsTxns","MAWDbXMATxns","MAWDexieTable","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWLoggerUtils","MAWMediaAfterTxns","MAWXMAUtils","WATagsLogger","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCounter: Showing UI counter for ",""]);h=function(){return a};return a}function i(a,b){return d("MAWDbMediaTxns").getMsgMediaPairFromMsgs(a,b).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b[0],e=b[1];return d("MAWDbChunkTxns").hasMediaChunk(a,e.hashedPlaintextHash).then(function(b){d("MAWMediaAfterTxns").handleNewMediaAfterTxn(c,e,b,a)})}))})}function j(a,b){return d("MAWDbXMATxns").getXMAFromMsgs(a,b).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){if(d("MAWXMAUtils").isXMAStoryReply(b.targetType))return;return d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,b.defaultPreviewMediaId).then(function(e){c("gkx")("821")?c("promiseDone")(d("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(e,b,a)):d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:d("MAWBridgeXMA").createBridgeXMA(e,b,!1)})})}))})}function k(a,b){return d("MAWDbReactionsTxns").getReactionsFromMessages(a,b).then(function(a){a.forEach(function(a){return d("MAWDbReactionUtils").dispatchReaction(a)});return a})}function a(a,b,c,e,f,g){f===void 0&&(f=!1);return d("MAWDbMsgTxns").getMsgsFromOffset(a,b,c,e,f,!1,g).then(function(b){var c=b.msgs,e=babelHelpers.objectWithoutPropertiesLoose(b,["msgs"]);return d("MAWDexieTable").dexieAll(c.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b)})).then(function(a){return babelHelpers["extends"]({msgs:c,replyMediaInfo:a},e)})}).then(function(e){var l=e.hasMoreAfter,m=e.hasMoreBefore,n=e.msgs,o=e.replyMediaInfo;e=n.map(function(a,b){if(d("MAWXMAUtils").isXMAStoryReply(a.xmaMessageType))return;return d("MAWBridgeMsg").createBridgeMsg(a,void 0,(o||[])[b])}).filter(Boolean);e.length>0&&d("MAWIndexedDb").afterTransaction({tag:"NewMsgs",value:{msgs:e}});e=n.filter(function(a){return a.ephemeralCounterStarted});e.length>0&&(d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.Countdown,d("MAWLoggerUtils").Tag.OnLoad]).LOG(h(),e.map(function(a){return a.msgId})),d("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:d("MAWBridgeMsgCountdown").createBridgeMsgsStartCountdown(e)}));(n.length>0||c==null)&&d("MAWIndexedDb").afterTransaction({tag:"MsgsLoaded",value:d("MAWBridgeTypesCreators").createBridgeMsgsLoadedInfo(b,n,f,m,l,g)});return d("MAWDexieTable").dexieAll([k(a,n),d("MAWDbEditMsgHistoryTxns").loadEditMsgHistory(a,n),i(a,n),j(a,n)]).then(function(a){a=a[0];return{hasMoreAfter:l,hasMoreBefore:m,msgs:n,reactions:a}})})}g.loadMsgsAndMediaFromOffset=a}),98);
__d("MAWLoadThreadsTxns",["FBLogger","MAWBridgeParticipants","MAWBridgeThread","MAWBridgeTypesCreators","MAWDbParticipantTxns","MAWDexieTable","MAWIndexedDb","MAWLoadGroupInvitesTxns","MAWLoadMessageRequestCapabilitiesTxns","MAWLoadMsgsTxns","MAWThreadSnippetUtils","MAWTransactionMode","MAWUserJidWrapper","WAJids","WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){f===void 0&&(f="loadContentsForThreads");b.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(a,e==null?void 0:e.get(a.jid),void 0,f)})});return d("MAWDexieTable").dexieAll([].concat(b.map(function(b){return i(a,b,c)}),[h(a,b),j(a,b),d("MAWLoadMessageRequestCapabilitiesTxns").loadMessageRequestDataForThreads(b),d("MAWLoadGroupInvitesTxns").loadGroupInvites(a,b)])).then(function(){return b})}function b(a,b,c,e){return d("MAWDexieTable").dexieAll([h(a,[c]),i(a,c,e),d("MAWThreadSnippetUtils").updateExistingSnippetToUI(a,c)]).then(function(e){e=e[0];b||l(a,c.jid,d("WAJids").interpretAsGroupJid(c.jid)!=null,!1,c.cannotReplyReason,c.archived);return e})}function h(a,b){return b.length===0?d("MAWDexieTable").dexieResolve([]):d("MAWDbParticipantTxns").getParticipantsInThreads(a,b.map(function(a){return a.jid})).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(a)});return a})}function i(a,b,c){return d("MAWLoadMsgsTxns").loadMsgsAndMediaFromOffset(a,b.jid,null,c,!0)}function j(a,b){var c=[];b.forEach(function(a){return d("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(a){return c.push(a)},user:function(){}})});return a.groupInfo.bulkGet(c).then(function(a){a.forEach(function(a){a!=null&&d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(a)})})})}e=function(a){a=a.threadJid;return k(a)};var k=d("MAWIndexedDb").makeMsgrTransactor({participants:d("MAWTransactionMode").READONLY},"checkIfGroupParticipant",function(a){return function(){for(var b=arguments.length,c=new Array(b),d=0;d<b;d++)c[d]=arguments[d];return l.apply(void 0,[a].concat(c))}});function l(a,b,e,f,g,h){e===void 0&&(e=!0);f===void 0&&(f=!0);var i=d("MAWUserJidWrapper").getMyUserJid();return d("MAWDbParticipantTxns").getParticipant(a,b,i).then(function(a){if(!a.success){var j=e?"group":"one_to_one";d("WALogger").LOG(["[Occamadillo] User is not a participant of "+j+" thread\n        "+b.toString()+", showing a VIEWER_NOT_SUBSCRIBED composer blocker"]);if(g==null){var k;c("FBLogger")("maw_db","checkIfParticipant").catching((k=a.payload)!=null?k:c("err")(a.error)).warn("[Occamdillo] User %s is not a participant of %s thread %s, occam: %s, archived: %s, cannotReplyReason null.",i,j,b.toString(),f,h)}c("FBLogger")("labyrinth_web","checkIfParticipant").warn("[Occamdillo] User not a participant from checkIfParticipant");k={cannotReplyReason:"viewer_not_subscribed",threadJid:b};d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread(k)})}})}g.loadContentsForThreads=a;g.loadParticipantsAndMsgs=b;g.loadParticipants=h;g.loadGroups=j;g.checkIfGroupParticipant=e}),98);
__d("MAWThreadFetchAndEmitTxns",["MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLoadGroupInvitesTxns","MAWLoadMessageRequestCapabilitiesTxns","MAWLoadThreadsTxns","MAWThreadManagementTxns","WAJids","WATimeUtils","gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){f===void 0&&(f="fetchAndEmitThread");return d("WAJids").switchOnMsgrChatJidType(b,{group:function(b){return d("MAWThreadManagementTxns").getGroupThread(a,b,c).then(function(a){return a==null?null:{created:a.created,thread:a.thread}})},user:function(b){var g;return d("MAWThreadManagementTxns").getOrSetupOneToOneThread(a,{createTs:e==null?void 0:d("WATimeUtils").castUnixTimeToMillisTime(e),description:f,folder:(g=c)!=null?g:void 0,userJid:b})}}).then(function(b){return b==null||b.thread==null?null:d("MAWLoadThreadsTxns").loadContentsForThreads(a,[b.thread],1,null,f).then(function(){return b})})}function h(a,b){if(!c("gkx")("23922"))return d("MAWDexieTable").dexieResolve();b=b.map(function(b){return d("MAWDbMsgTxns").getThreadOldestMessageId(a,b.jid).then(function(a){return{oldestMsgId:a,thread:b}})});return d("MAWDexieTable").dexieAll(b).then(function(a){a.forEach(function(a){var b=a.oldestMsgId;a=a.thread;return d("MAWIndexedDb").afterTransaction({tag:"UpdateMessageRange",value:d("MAWBridgeTypesCreators").createBridgeUpdateMessageRange({newestMsgId:null,newestMsgTs:null,oldestMsgId:b,thread:a})})})})}function b(a,b){if(b.size===0)return d("MAWDexieTable").dexieResolve();b=Array.from(b);return a.threads.where("jid").anyOf(b).toArray().then(function(b){return h(a,b).then(function(){var c=b.filter(Boolean);return d("MAWDexieTable").dexieAll([d("MAWLoadThreadsTxns").loadParticipants(a,c),d("MAWLoadThreadsTxns").loadGroups(a,c),d("MAWLoadMessageRequestCapabilitiesTxns").loadMessageRequestDataForThreads(c),d("MAWLoadGroupInvitesTxns").loadGroupInvites(a,c)])})}).then(function(){})}g.fetchAndEmitThread=a;g.emitThreadContents=b}),98);
__d("MAWBulkHandleIncomingMsgApi",["MAWBulkEditMsgsTxns","MAWBulkWriteReactionsTxns","MAWDbThreadTxns","MAWDexieTable","MAWHIMLogger","MAWHandleIncomingMsgApi","MAWIndexedDb","MAWLinkReactionsToMsgsApi","MAWMsgActionType","MAWMsgType","MAWODSProxy","MAWOfflineThreadTxns","MAWPreprocessMsgs","MAWSharedOfflineQueueMetric","MAWSharedOfflineResumeUINotifier","MAWThreadFetchAndEmitTxns","MAWTransactionMode","WAMsgMap","WAOdsEnums","WAResultOrError","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Should never have 'write' and 'delete' in same OQ batch"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Should never have 'update ciphertext' and 'delete' in same OQ batch"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handling message with StanzaID ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handling "," messages"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot create thread for message. Reason: ",". StanzaID ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot create thread for message. Reason: ","."]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Previous message processing action failed so subsequent one can't succeed"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["ERROR!!! At this point we must have fields in the map, ",""]);o=function(){return a};return a}var p=c("gkx")("2014");function a(a){var b;return d("MAWIndexedDb").makeMsgrTransactor({chunk:(b=d("MAWTransactionMode")).READWRITE,deletedMessages:b.READWRITE,deviceChangeAlerts:b.READWRITE,editMsgHistory:b.READWRITE,ephemeralSettings:b.READWRITE,existingUsers:b.READWRITE,ftsBackloggedMessages:b.READWRITE,ftsPurgeBacklog:b.READWRITE,groupInfo:b.READWRITE,groupInvites:b.READWRITE,media:b.READWRITE,mediaBackup:b.READWRITE,messages:b.READWRITE,participants:b.READWRITE,pendingReceipts:b.READWRITE,pendingStanzas:b.READWRITE,reactions:b.READWRITE,receiverFetchInfo:b.READWRITE,threads:b.READWRITE,unrenderedMessages:b.READWRITE,xma:b.READWRITE},"bulkHandleIncomingMsgs",function(b){return function(){var e=d("MAWDexieTable").dexieResolve(),f=new(d("WAMsgMap").MsgMap)();d("MAWODSProxy").odsBumpEntityKey({amount:a.length,entity:d("WAOdsEnums").Entity.TOTAL_INCOMING_MESSAGE,key:"msgs"});d("MAWDexieTable").setDexiePSDItem("offlineQueueSize",a.length);var g=new Set(a.map(function(a){a=a.msgData;return a.id.chat})),h=d("MAWPreprocessMsgs").classifyIncomingMsgs(a),i=h.editActionMsgs,j=h.reactionMsgs,k=function(a,b){var e=f.get(a);if(!b.success)f.set(a,b);else if(e==null)c("MAWHIMLogger").ERROR(o(),b);else if(!e.success)c("MAWHIMLogger").WARN(n());else if(p)f.set(a,d("WAResultOrError").makeResult(babelHelpers["extends"]({},e.value,b.value)));else{e=e.value;b=b.value;(b==null?void 0:b.outOfSyncEphemeralSetting)!=null&&(e=babelHelpers["extends"]({},e,{outOfSyncEphemeralSetting:b.outOfSyncEphemeralSetting}));if((b==null?void 0:b.plaintextHashs)!=null){var g;e=babelHelpers["extends"]({},e,{plaintextHashs:(g=e.plaintextHashs)!=null?g:b.plaintextHashs})}(b==null?void 0:b.reactToExternalId)!=null&&(e=babelHelpers["extends"]({},e,{reactToExternalId:b.reactToExternalId}));e=babelHelpers["extends"]({},e,{msgType:(g=(g=e)==null?void 0:g.msgType)!=null?g:b==null?void 0:b.msgType});f.set(a,d("WAResultOrError").makeResult(e))}};return q(b,g).then(function(h){var n=h.threadCreationResult,o=h.threads,q=function(a,b){f.set(a,d("WAResultOrError").makeResult({protocolMsgId:a,unknownGroup:b==="missing"}))};h=d("MAWDexieTable").dexieAll(a.map(function(a){var e;e=[o.get(a.msgData.id.chat),(e=n.get(a.msgData.id.chat))!=null?e:"missing"];var f=e[0];e=e[1];if(f==null){c("MAWHIMLogger").ERROR(m(),e);c("MAWHIMLogger").WARN(l(),e,a.msgData.id.externalId);return}q(a.msgData.id,e);return d("MAWPreprocessMsgs").getMessageDataByType(b,a,f)}).filter(Boolean))["catch"](function(a){a.message="[getAllMessagesProcessingData] "+a.message;throw a});return d("MAWDexieTable").dexieAll([d("MAWBulkWriteReactionsTxns").prepareReactionsData(b,j),h]).then(function(a){var c=a[0],h=a[1];return d("MAWBulkWriteReactionsTxns").bulkWriteReactions(b,c).then(function(){var a=p?t(h):h;a.forEach(function(a){e=e.then(function(){return d("MAWHandleIncomingMsgApi").handleIncomingMsg(b,a)}).then(function(b){k(a.id,b),r(a.id,a.ts)})});e["catch"](function(a){a.message="[writeIncomingMsgs] "+a.message;throw a});return e}).then(function(){var a=i.length===0?d("MAWDexieTable").dexieResolve():d("MAWBulkEditMsgsTxns").prepareDataForMessageEdit(b,i).then(function(a){return d("MAWBulkEditMsgsTxns").bulkEditMsgs(b,i,a)});return a.then(function(){return d("MAWThreadFetchAndEmitTxns").emitThreadContents(b,g).then(function(){return{msgResults:f}})})})})})}})().then(function(a){var b=new Set();a.msgResults.values().forEach(function(a){if(a.success){a=a.value;(a==null?void 0:a.reactToExternalId)!=null?b.add(a.reactToExternalId):(a==null?void 0:a.protocolMsgId)!=null&&b.add(a.protocolMsgId.externalId)}});return d("MAWLinkReactionsToMsgsApi").linkReactionsToMsgs(Array.from(b)).then(function(){return a})})}function q(a,b){var c=Array.from(b);return d("MAWDbThreadTxns").getThreads(a,c).then(function(b){return d("MAWOfflineThreadTxns").createAllThreadsForOfflineMsgs(a,c,b)})}function r(a,b){var c;a=a.chat.toString();d("MAWSharedOfflineResumeUINotifier").offlineResumeUINotifier.updateChatState((c={},c[a]=b,c));d("MAWSharedOfflineResumeUINotifier").offlineResumeUINotifier.addMAWEntity(1);(a=d("MAWSharedOfflineQueueMetric").getOfflineQueueMetric())==null?void 0:a.addMAWEntity(1)}var s=c("MAWHIMLogger").TAGS(["MergeActions"]);function t(a){s.LOG(k(),a.length);var b=new(d("WAMsgMap").MsgMap)();for(var c=0;c<a.length;c++){var e=a[c];s.LOG(j(),e.id.externalId);e.receiveFlow.addPoint("him_merge_actions");var f=b.get(e.id);if(f==null){b.set(e.id,e);continue}if(f.action===e.action&&f.type===e.type){e.receiveFlow.addAnnotations({bool:{merge_actions_duplicate:!0}});continue}switch(e.action){case d("MAWMsgActionType").MSG_ACTION.NO_ACTION:continue;case d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT:case d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED:if(f.action===d("MAWMsgActionType").MSG_ACTION.REVOKE||f.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME){s.ERROR(i());continue}b.set(e.id,e);continue;case d("MAWMsgActionType").MSG_ACTION.WRITE:case d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED:if(f.action===d("MAWMsgActionType").MSG_ACTION.REVOKE||f.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME){s.ERROR(h());continue}switch(e.type){case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:break;case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:f.type===d("MAWMsgType").MSG_TYPE.UNAVAILABLE&&b.set(e.id,e);break;default:b.set(e.id,e)}break;case d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME:case d("MAWMsgActionType").MSG_ACTION.REVOKE:f.action!==d("MAWMsgActionType").MSG_ACTION.REVOKE&&b.set(e.id,e);break}}f=[];for(e=0;e<a.length;e++){var g;c=a[e];var l=b.get(c.id);c.receiveFlow.addAnnotations({string:{final_action:(g=l==null?void 0:l.action)!=null?g:"undefined",initial_action:c.action}});if(l==null||l.action===d("MAWMsgActionType").MSG_ACTION.NO_ACTION)continue;f.push(l);b["delete"](c.id)}return f}g.bulkHandleIncomingMsgs=a}),98);
__d("MAWCastToServerMediaType",[],(function(a,b,c,d,e,f){"use strict";function a(a){switch(a){case"document":case"image":case"xma-image":case"video":case"ptt":case"gif":case"sticker":return a;default:return null}}f.castToServerMediaType=a}),66);
__d("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaGatingType: ",""]);h=function(){return a};return a}function a(a){switch(a){case d("EchoMessageXMAFieldUtils").XMAGatingType.INFO:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.INFO;case d("EchoMessageXMAFieldUtils").XMAGatingType.EYE_OFF:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.EYE_OFF;case d("EchoMessageXMAFieldUtils").XMAGatingType.NEWS_OFF:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NEWS_OFF;case d("EchoMessageXMAFieldUtils").XMAGatingType.WARNING:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.WARNING;case d("EchoMessageXMAFieldUtils").XMAGatingType.PRIVATE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.PRIVATE;case d("EchoMessageXMAFieldUtils").XMAGatingType.NONE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE;default:d("WALogger").ERROR(h(),a);return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE}}g.convertXMAGatingTypeToExtendedContentOverlayIconGlyph=a}),98);
__d("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaLayoutType: ",""]);h=function(){return a};return a}function a(a){switch(a){case d("EchoMessageXMAFieldUtils").XMALayoutType.SINGLE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE;case d("EchoMessageXMAFieldUtils").XMALayoutType.PORTRAIT:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.PORTRAIT;default:d("WALogger").ERROR(h(),a);return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE}}g.convertXMALayoutTypeToExtendedContentXMLLayoutType=a}),98);
__d("MAWConvertXMATargetTypeToExtendedContentTargetType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaTargetType: ",""]);h=function(){return a};return a}function a(a){switch(a){case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_MENTION:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_IMAGE_POST_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_MULTIPOST_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_VIDEO_POST_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_CLIPS_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_IGTV_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_SHOP_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_PROFILE_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_HIGHLIGHT_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_HIGHLIGHT_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REPLY:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REACTION:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_REPLY:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_MENTION:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_VIDEO_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_GAMING_CUSTOM_UPDATE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_PRODUCER_STORY_REPLY:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY;case d("EchoMessageXMAFieldUtils").XMAContentType.MSG_EXTERNAL_LINK_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_AUDIO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_VIDEO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_AUDIO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_VIDEO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_AUDIO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_VIDEO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_EVENT:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT;case d("EchoMessageXMAFieldUtils").XMAContentType.MSG_RECEIVER_FETCH:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH;default:d("WALogger").ERROR(h(),a);return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE}}g.convertXMATargetTypeToExtendedContentTargetType=a}),98);
__d("MAWJobsIndexedDb",["MAWCurrentUser","MAWErrorObject","MAWGetWorkerStatusApi","MAWIndexedDbMetadata","MAWLowLevelApiTypes","MAWQplProxy","MAWTransactionMode","Promise","WAExceededStorageQuota","WALogger","WAWorkerGlobalScope","err","promiseDone","qex","unrecoverableViolation"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[JobsDb initialization] upgradeneeded is triggered in another worker. This should not happen."]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[JOB] Setting up the jobs database"]);j=function(){return a};return a}var k=null,l=null,m="jobs";function n(){return c("qex")._("940")}function o(){if(k==null)throw c("err")("JobDB IndexDB should've been initialized");return k}function p(){if(l==null)throw c("err")("JobDB IndexDB should've been initialized");return l.then(function(){return o()})}function a(){return k!=null}var q=[function(a){a=a.target.result;a=a.createObjectStore(m,{autoIncrement:!0,keyPath:"jobId"});a.createIndex("uniqKey","uniqKey")},function(){},function(){}];function e(a){l=null;k=null;return r(a).then(function(){return k.version})}function r(a){if(l!=null)return l;if(k!=null)return(h||(h=b("Promise"))).resolve();var c=d("MAWCurrentUser").getID(),e=d("MAWIndexedDbMetadata").jobsDbName(c),f=(a=(c=a)!=null?c:n())!=null?a:q.length;d("MAWGetWorkerStatusApi").setDatabaseStatus(e,d("MAWLowLevelApiTypes").DatabaseState.Initializing);d("MAWGetWorkerStatusApi").setDatabaseApi(e,"native");l=new(h||(h=b("Promise")))(function(a,b){d("WALogger").LOG(j());var c=indexedDB.open(e,f);c.onupgradeneeded=function(a){d("MAWGetWorkerStatusApi").setDatabaseStatus(e,d("MAWLowLevelApiTypes").DatabaseState.Upgrading);for(var b=0;b<q.length;b++){var c=q[b],f=b+1;s(a,f)&&c(a)}};c.onsuccess=function(b){var c=b.target.result;d("MAWGetWorkerStatusApi").setDatabaseStatus(e,d("MAWLowLevelApiTypes").DatabaseState.Open);c.onversionchange=function(){var a;d("WALogger").ERROR(i());c.close();(a=d("WAWorkerGlobalScope").workerGlobalScope.location)==null?void 0:a.reload==null?void 0:a.reload()};k=c;a()};c.onerror=function(){d("MAWGetWorkerStatusApi").setDatabaseStatus(e,d("MAWLowLevelApiTypes").DatabaseState.Error),b(c.error)}});return l}function s(a,b){var c=a.newVersion;a=a.oldVersion;return a<b&&c>=b}function t(a){return a===d("MAWTransactionMode").READWRITE?"readwrite":"readonly"}function f(a,b,e,f){var g=t(b);return function(b){return function(){for(var h=arguments.length,i=new Array(h),j=0;j<h;j++)i[j]=arguments[j];var m=f!=null?d("MAWQplProxy").startQplUserFlow(f):null,n=function f(h){return p().then(function(c){var e=function(b){b=c.transaction(a,b!=null?t(b):g,{durability:"relaxed"});d("WAExceededStorageQuota").listenToQuotaExceededError(b);return b.objectStore(a)};return b.apply(void 0,[e].concat(i))}).then(function(a){m==null?void 0:m.endSuccess();return a})["catch"](function(b){m==null?void 0:m.endFail("job_transaction_fail");b=d("MAWErrorObject").getErrorObject(b);if((b==null?void 0:b.name)==="InvalidStateError"&&h===1){l=null;k=null;c("promiseDone")(r());return f(h-1)}throw c("unrecoverableViolation")(e+":"+a+" - Error performing transaction in jobDB transactor v2","maw_db",b?{error:b}:{})})};return n(1)}}}g.getJobsDbVersion=n;g.getJobDB=o;g.isJobDBInitted=a;g.dbMigrations=q;g.makeJobsDbIgnoringPreviousCreations=e;g.makeJobsDb=r;g.makeJobsTransactor=f}),98);
__d("MAWJobPersistenceAccessorsApi",["MAWJobActionsV2","MAWJobsIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a,b,c;return{deletePersistedJob:(a=d("MAWJobsIndexedDb")).makeJobsTransactor("jobs",(b=d("MAWTransactionMode")).READWRITE,"deletePersistedJob")((c=d("MAWJobActionsV2")).deletePersistedJob),loadAllJobs:a.makeJobsTransactor("jobs",b.READONLY,"loadAllJobs")(c.readAllPersistedJobs),maybeCreateJob:a.makeJobsTransactor("jobs",b.READWRITE,"maybeCreateJob")(c.maybeCreateJob),readPersistedJob:a.makeJobsTransactor("jobs",b.READONLY,"readPersistedJob")(c.readPersistedJob),updatePersistedJob:a.makeJobsTransactor("jobs",b.READWRITE,"updatePersistedJob")(c.updatePersistedJob)}}g.getJobPersistenceAccessors=a}),98);
__d("WAJobPriorityBucket",["WAJobOrchestratorTypes","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskDone found jobId: "," in scheduled tasks"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskPending found jobId: "," in pending tasks"]);i=function(){return a};return a}a=function(){function a(a){this.tasks=[];this.pendingTasks=[];this.lastJobStartedTimestampMs=null;this.jobMaxConcurrency=(a=a.jobMaxConcurrencyMap)!=null?a:{}}var b=a.prototype;b.updateConfig=function(a){this.jobMaxConcurrency=(a=a.jobMaxConcurrencyMap)!=null?a:{}};b.getStats=function(){return[].concat(this.tasks,this.pendingTasks).reduce(function(a,b){var c;c=(c=a[b.jobName])!=null?c:0;a[b.jobName]=c+1;return a},{})};b.next=function(){var a=this;if(this.tasks.length===0)return null;var b=this.pendingTasks.reduce(function(a,b){var c;c=(c=a.get(b.jobName))!=null?c:0;a.set(b.jobName,c+1);return a},new Map()),c=this.tasks.filter(function(c){var e;return((e=b.get(c.jobName))!=null?e:0)<((e=a.jobMaxConcurrency[c.jobName])!=null?e:d("WAJobOrchestratorTypes").DEFAULT_CONCURRENCY)});return c.length>0?[c[0]]:null};b.add=function(a,b,c,d){c={jobId:c,jobInfo:b,jobName:a,run:d};this.tasks.push(c);return c};b.markJobTaskPending=function(a){this.pendingTasks.includes(function(b){return b.jobId===a.jobId})&&d("WALogger").ERROR(i(),a.jobId).sendLogs("JobOrchestrator::markJobTaskPending"),this.lastJobStartedTimestampMs=Date.now(),this.pendingTasks.push(a),this.tasks=this.tasks.filter(function(b){return b.jobId!==a.jobId})};b.markJobTaskDone=function(a){this.pendingTasks=this.pendingTasks.filter(function(b){return b.jobId!==a}),this.tasks.includes(function(b){return b.jobId===a})&&d("WALogger").ERROR(h(),a).sendLogs("JobOrchestrator::markJobTaskDone")};b.count=function(){return this.tasks.length};b.pendingCount=function(){return this.pendingTasks.length};b.clearWaitingTasks=function(){this.tasks=[]};b.clear=function(){this.tasks=[],this.pendingTasks=[]};b.getLastJobStartedTimestamp=function(){return this.lastJobStartedTimestampMs};return a}();b=function(a){babelHelpers.inheritsLoose(b,a);function b(){return a.apply(this,arguments)||this}var c=b.prototype;c.next=function(){var a=this,b,c;if(this.tasks.length===0)return null;var d=this.pendingTasks.reduce(function(a,b){var c;c=(c=a.get(b.jobName))!=null?c:0;a.set(b.jobName,c+1);return a},new Map()),e=this.tasks.filter(function(b){var c;return((c=d.get(b.jobName))!=null?c:0)<((c=a.jobMaxConcurrency[b.jobName])!=null?c:1)});if(e.length===0)return null;b=(b=this.jobMaxConcurrency[e[0].jobName])!=null?b:1;c=(c=d.get(e[0].jobName))!=null?c:0;if(b>1&&c<b){var f=e.filter(function(a){return a.jobName===e[0].jobName});b=Math.min(f.length,b-c);return f.slice(0,b)}return[e[0]]};return b}(a);g.BaseJobBucket=a;g.LowJobBucket=b}),98);
__d("WAMetrics",["Promise","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){var a=d("WATimeUtils").performanceAbsoluteNow();return new(h||(h=b("Promise")))(function(b){setTimeout(function(){b(d("WATimeUtils").performanceAbsoluteNow()-a)},0)})}g.getEventLoopDelay=a}),98);
__d("WAConcurrentBucketJobQueue",["Promise","WABase64","WACustomError","WAErr","WAJobOrchestratorTypes","WAJobPriorityBucket","WALogger","WAMetrics","WANullthrows","WAPromiseTimeout","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: "," exceeding the timeout, release the thread."]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: updated WAConcurrentBucketJobQueue config"]);j=function(){return a};return a}var k=30,l=new Map([[d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,5],[d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,1]]);a=function(){function a(){this.$1=!1,this.$2=0,this.$3=0,this.$4=0,this.$5=new Map(),this.$6=new Map(),this.$7=new Map(),this.$9=0}var e=a.prototype;e.init=function(a,b){var e,f,g;if(this.$1)throw c("WAErr")("WAConcurrentBucketJobQueue has already initialized");this.$4=(e=a==null?void 0:a.bestEffortWaitTimeoutSec)!=null?e:k;this.$2=a.maxConcurrency;this.$3=a.maxConcurrency;this.$8=b;this.$7=this.$11(a==null?void 0:a.jobPrioritiesQuota);this.$6=new Map(this.$7);this.$5=new Map();this.$9=Date.now();b=new(d("WAJobPriorityBucket").BaseJobBucket)({jobMaxConcurrencyMap:(e=a.maxConcurrencyPerJob)!=null?e:{}});e=new(d("WAJobPriorityBucket").LowJobBucket)({jobMaxConcurrencyMap:(e=a.maxConcurrencyPerJob)!=null?e:{}});f=new(d("WAJobPriorityBucket").LowJobBucket)({jobMaxConcurrencyMap:(f=a.maxConcurrencyPerJob)!=null?f:{}});g=new(d("WAJobPriorityBucket").BaseJobBucket)({jobMaxConcurrencyMap:(g=a.maxConcurrencyPerJob)!=null?g:{}});a=new(d("WAJobPriorityBucket").BaseJobBucket)({jobMaxConcurrencyMap:(a=a.maxConcurrencyPerJob)!=null?a:{}});this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION,b);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,b);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.OFFLINE,g);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.HISTORY_SYNC,a);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,e);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT,f);this.$1=!0};e.updateConfig=function(a){this.$3+=a.maxConcurrency-this.$2,this.$2=a.maxConcurrency,this.$5.forEach(function(b){return b.updateConfig({jobMaxConcurrencyMap:(b=a.maxConcurrencyPerJob)!=null?b:{}})}),this.$7=this.$11(a==null?void 0:a.jobPrioritiesQuota),d("WALogger").LOG(j())};e.isInitialized=function(){return this.$1};e.clearQueue=function(){if(!this.$1)throw c("WAErr")("WAConcurrentBucketJobQueue not initialized");this.$5.forEach(function(a){return a.clear()})};e.clearQueueByPriority=function(a){if(!this.$1)throw c("WAErr")("WAConcurrentBucketJobQueue not initialized");(a=this.$5.get(a))==null?void 0:a.clearWaitingTasks()};e.getIntStats=function(){var a=this,b=function(b){var c;b=a.$5.get(b);return((c=b==null?void 0:b.count())!=null?c:0)+((c=b==null?void 0:b.pendingCount())!=null?c:0)};return{highPriorityBucketSize:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH),lowPriorityBucketSize:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW),bestEffortPriorityBucketSize:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT)}};e.getStringStats=function(){var a=this,b=function(b){var c=(b=(b=a.$5.get(b))==null?void 0:b.getStats())!=null?b:{};b=Object.keys(c).reduce(function(a,b){var d=a[0];a=a[1];var e=c[b];return e>d?[e,b]:[d,a]},[0,null]);b=b[1];return b};return{highPriorityMaxJob:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH),lowPriorityMaxJob:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW),bestEffortPriorityMaxJob:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT)}};e.enqueue=function(a,e,f,g){var i,j=this;if(!this.$1)return(h||(h=b("Promise"))).reject(c("WAErr")("WAConcurrentBucketJobQueue not initialized"));var k,l,m=new(h||(h=b("Promise")))(function(a,b){k=a,l=b}),n=babelHelpers["extends"]({priority:d("WAJobOrchestratorTypes").DEFAULT_JOB_PRIORITY},f),o=this.getJobBucketByType(n.priority);if(!o)return(h||(h=b("Promise"))).reject(c("WAErr")("WAConcurrentBucketJobQueue no bucket for job with name "+a+" was found."));void d("WAMetrics").getEventLoopDelay().then(function(a){(g==null?void 0:g.isActive())&&(g==null?void 0:g.addPoint("measure_event_loop_delay",{"int":{eventLoopDelay:a}}))});g==null?void 0:g.addPoint("scheduling_job",{string:babelHelpers["extends"]({},this.getStringStats(),{priority:n.priority}),"int":babelHelpers["extends"]({},this.getIntStats(),{maxTimeoutMs:(i=f==null?void 0:f.maxTimeoutMs)!=null?i:0})});var p=n.priority+"-"+a+"-"+((i=f==null?void 0:f.jobId)!=null?i:d("WABase64").randomBase64(8));i=o.add(a,n,p,function(){var a;return b("regeneratorRuntime").async(function(c){while(1)switch(c.prev=c.next){case 0:c.prev=0;j.$8.logJobStarted(p);c.next=4;return b("regeneratorRuntime").awrap(j.$12(e(),f==null?void 0:f.maxTimeoutMs));case 4:a=c.sent;j.$8.logJobCompleted(p);k(a);c.next=13;break;case 9:c.prev=9,c.t0=c["catch"](0),c.t0 instanceof d("WACustomError").TimeoutError?j.$8.logJobTimeout(p):j.$8.logJobError(p),l(c.t0);case 13:case"end":return c.stop()}},null,this,[[0,9]])});this.$8.logJobCreated({jobId:p,jobName:a,jobPriority:n.priority,pendingJobsCount:o.count()});f&&f.priority===d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION&&void this.$13(i);this.$14();return m};e.getAvailableThreadsCount=function(){return this.$3};e.getJobQuotaConfig=function(){return this.$7};e.getRemainingJobCountMap=function(){return this.$6};e.getJobBucketByType=function(a){return this.$5.get(a)};e.getSnapshot=function(a){a=this.getJobBucketByType(a);return!a?null:a.getStats()};e.$11=function(a){var b;!a?b=new Map(l):b=new Map(a);b.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT,0);return b};e.$15=function(a){return(a=this.$6.get(a))!=null?a:0};e.$16=function(){this.$6=new Map(this.$7)};e.$17=function(a){var b=this;a===void 0&&(a=!0);var c=0,e=null,f=0;this.$5.forEach(function(a,d){c+=a==null?void 0:a.count();f+=b.$15(d);if(e!=null)return;a.count()>0&&b.$15(d)>0&&(e=a)});var g=e==null||f===0;g&&this.$16();if(this.$18(c,g))return this.getJobBucketByType(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT);return e==null&&a?this.$17(!1):e};e.$18=function(a,b){var c=this;function e(a,b){var c=Date.now();return a>c?!1:c-a<b*1e3}function f(a,b){a=Math.ceil(a-Date.now())+b*1e3;return a>0?a:0}var g=this.getJobBucketByType(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT);a=a-((a=g==null?void 0:g.count())!=null?a:0);var h=g==null?void 0:g.getLastJobStartedTimestamp();if((g==null?void 0:g.count())===0)return!1;if(h==null&&e(this.$9,this.$4)){if(this.$10==null){g=f(this.$9,this.$4);this.$10=setTimeout(function(){c.$14(),c.$10=null},g)}return!1}return a>0&&h!=null&&e(h,this.$4)?!1:b};e.$19=function(a){a=this.$20(a);return c("WANullthrows")(this.$5.get(a))};e.$20=function(a){var b=a.split("-")[0];b=d("WAJobOrchestratorTypes").JOB_PRIORITY.cast(b);if(!b)throw c("WAErr")("ConcurrentBucketQueue cannot extract known job priority type from id: "+a);return b};e.$21=function(a){a=this.$20(a);this.$15(a)>0?this.$6.set(a,this.$15(a)-1):this.$6.set(a,0)};e.$14=function(){var a=this;while(this.$3>0){var b=this.$17();b=b==null?void 0:b.next();if(b==null)break;b.forEach(function(b){a.$21(b.jobId),void a.$13(b)})}};e.$12=function(a,b){return b!==void 0?d("WAPromiseTimeout").promiseTimeout(a,b):a};e.$13=function(a){var c=this,e,f,g,h,j;return b("regeneratorRuntime").async(function(k){while(1)switch(k.prev=k.next){case 0:e=this.$19(a.jobId);this.$3--;e.markJobTaskPending(a);f=a.run,g=a.jobId,h=a.jobName;k.prev=4;k.next=7;return b("regeneratorRuntime").awrap(this.$12(f(),((j=a.jobInfo)==null?void 0:j.maxTimeoutMs)===void 0?d("WAJobOrchestratorTypes").DEFAULT_JOB_TIMEOUT_MS:void 0));case 7:k.next=17;break;case 9:k.prev=9;k.t0=k["catch"](4);if(!(k.t0 instanceof d("WACustomError").TimeoutError)){k.next=16;break}this.$8.logJobTimeout(g);d("WALogger").LOG(i(),h);k.next=17;break;case 16:throw k.t0;case 17:k.prev=17;this.$3++;e.markJobTaskDone(g);this.$3>0&&setTimeout(function(){return c.$14()},0);return k.finish(17);case 22:case"end":return k.stop()}},null,this,[[4,9,17,22]])};return a}();g.WAConcurrentBucketJobQueue=a}),98);
__d("WAConcurrentPreemptiveJobQueue",["Promise","WACustomError","WAErr","WAHex","WAJobOrchestratorTypes","WALogger","WAPromiseTimeout","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskDone found jobId: "," in scheduled tasks"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskPending found jobId: "," in pending tasks"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: "," exceeding the timeout, release the thread."]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: updated ConcurrentPreemptiveJobQueue config"]);l=function(){return a};return a}a=function(){function a(){this.$1=!1,this.$2=0,this.$3=0,this.$4={},this.$5=[],this.$6=[]}var e=a.prototype;e.init=function(a,b){if(this.$1)throw c("WAErr")("ConcurrentPreemptiveJobQueue has already initialized");this.$2=a.maxConcurrency;this.$3=a.maxConcurrency;this.$4=(a=a.maxConcurrencyPerJob)!=null?a:{};this.$7=b;this.$1=!0};e.updateConfig=function(a){this.$3+=a.maxConcurrency-this.$2;this.$2=a.maxConcurrency;this.$4=(a=a.maxConcurrencyPerJob)!=null?a:{};d("WALogger").LOG(l())};e.isInitialized=function(){return this.$1};e.clearQueueByPriority=function(a){if(!this.$1)throw c("WAErr")("ConcurrentPreemptiveJobQueue not initialized");this.$5=this.$5.filter(function(b){return((b=b.jobInfo)==null?void 0:b.priority)!==a})};e.clearQueue=function(){if(!this.$1)throw c("WAErr")("ConcurrentPreemptiveJobQueue not initialized");this.$5=[];this.$6=[]};e.enqueue=function(a,e,f){var g,i=this;if(!this.$1)return(h||(h=b("Promise"))).reject(c("WAErr")("ConcurrentPreemptiveJobQueue not initialized"));var j,k,l=new(h||(h=b("Promise")))(function(a,b){j=a,k=b}),m=babelHelpers["extends"]({priority:d("WAJobOrchestratorTypes").DEFAULT_JOB_PRIORITY},f),n=(g=f==null?void 0:f.jobId)!=null?g:d("WAHex").randomHex(8).substr(0,64);g=this.$8(a,m,n,function(){var a;return b("regeneratorRuntime").async(function(c){while(1)switch(c.prev=c.next){case 0:c.prev=0;i.$7.logJobStarted(n);c.next=4;return b("regeneratorRuntime").awrap(i.$9(e(),f==null?void 0:f.maxTimeoutMs));case 4:a=c.sent;i.$7.logJobCompleted(n);j(a);c.next=13;break;case 9:c.prev=9,c.t0=c["catch"](0),c.t0 instanceof d("WACustomError").TimeoutError?i.$7.logJobTimeout(n):i.$7.logJobError(n),k(c.t0);case 13:case"end":return c.stop()}},null,this,[[0,9]])});f&&f.priority===d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION&&this.$10(g);this.$11();return l};e.getAvailableThreadsCount=function(){return this.$3};e.getJobMaxConcurrency=function(){return this.$4};e.getSnapshot=function(a){};e.$11=function(){while(this.$3>0){var a=this.$12();if(a==null)break;this.$10(a)}};e.$9=function(a,b){return b!==void 0?d("WAPromiseTimeout").promiseTimeout(a,b):a};e.$10=function(a){var c=this,e,f,g,h;return b("regeneratorRuntime").async(function(i){while(1)switch(i.prev=i.next){case 0:this.$3--;this.$13(a);e=a.run,f=a.jobId,g=a.jobName;i.prev=3;i.next=6;return b("regeneratorRuntime").awrap(this.$9(e(),((h=a.jobInfo)==null?void 0:h.maxTimeoutMs)===void 0?d("WAJobOrchestratorTypes").DEFAULT_JOB_TIMEOUT_MS:void 0));case 6:i.next=16;break;case 8:i.prev=8;i.t0=i["catch"](3);if(!(i.t0 instanceof d("WACustomError").TimeoutError)){i.next=15;break}this.$7.logJobTimeout(f);d("WALogger").LOG(k(),g);i.next=16;break;case 15:throw i.t0;case 16:i.prev=16;this.$3++;this.$14(f);setTimeout(function(){return c.$11()},0);return i.finish(16);case 21:case"end":return i.stop()}},null,this,[[3,8,16,21]])};e.$8=function(a,b,c,d){d={jobId:c,jobInfo:b,jobName:a,run:d};this.$7.logJobCreated({jobId:c,jobName:a,jobPriority:b.priority,pendingJobsCount:this.$5.length});this.$5.push(d);return d};e.$13=function(a){this.$6.includes(function(b){return b.jobId===a.jobId})&&d("WALogger").ERROR(j(),a.jobId).sendLogs("JobOrchestrator::markJobTaskPending"),this.$6.push(a),this.$5=this.$5.filter(function(b){return b.jobId!==a.jobId})};e.$14=function(a){this.$6=this.$6.filter(function(b){return b.jobId!==a}),this.$5.includes(function(b){return b.jobId===a})&&d("WALogger").ERROR(i(),a).sendLogs("JobOrchestrator::markJobTaskDone")};e.$12=function(){var a=this;if(this.$5.length===0)return null;var b=this.$6.reduce(function(a,b){var c;c=(c=a.get(b.jobName))!=null?c:0;a.set(b.jobName,c+1);return a},new Map()),c=this.$5.filter(function(c){var d;return((d=b.get(c.jobName))!=null?d:0)<((d=a.$4[c.jobName])!=null?d:1)});return c[0]};return a}();g.WAConcurrentPreemptiveJobQueue=a}),98);
__d("WADefaultJobNoQueue",["WAErr","WAHex","WAJobOrchestratorTypes","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(){function a(){this.$2=!1}var e=a.prototype;e.init=function(a,b){if(this.$2)throw c("WAErr")("DefaultNoQueue has already initialized");this.$1=b;this.$2=!0};e.updateConfig=function(a){};e.isInitialized=function(){return this.$2};e.clearQueue=function(){};e.clearQueueByPriority=function(a){};e.getSnapshot=function(){throw c("WAErr")("getSnapshot is not implemented for DefaultNoQueue")};e.enqueue=function(a,c,e){var f,g,h,i;return b("regeneratorRuntime").async(function(j){while(1)switch(j.prev=j.next){case 0:h=(f=e==null?void 0:e.jobId)!=null?f:d("WAHex").randomHex(8).substr(0,64);this.$1.logJobCreated({jobId:h,jobName:a,jobPriority:(g=e==null?void 0:e.priority)!=null?g:d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,pendingJobsCount:0});j.prev=2;this.$1.logJobStarted(h);j.next=6;return b("regeneratorRuntime").awrap(c());case 6:i=j.sent;this.$1.logJobCompleted(h);return j.abrupt("return",i);case 11:j.prev=11;j.t0=j["catch"](2);this.$1.logJobError(h);throw j.t0;case 15:case"end":return j.stop()}},null,this,[[2,11]])};return a}();g.WADefaultJobNoQueue=a}),98);
__d("WAOrchestratorJobStatsLogger",["WAGlobals","WAPREList","WAPREMetrics"],(function(a,b,c,d,e,f,g){"use strict";var h=function(){function a(a,b,c){this.jobName=a,this.pendingJobsCount=c,this.jobPriority=b}var b=a.prototype;b.logJobAdded=function(){this.webcJobAddedT=Date.now(),this.eventFlow=d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.WA_JOBS_ORCHESTRATOR,{string:{name:this.jobName,jobPriority:this.jobPriority,orchestratorVersion:d("WAGlobals").getConfig().orchestratorVersion()},"int":{pendingJobsCount:this.pendingJobsCount,addedAt:this.webcJobAddedT}})};b.logJobStarted=function(){this.webcJobStartedT=Date.now(),this.eventFlow.addPoint("start_job",{"int":{startedAt:this.webcJobStartedT}})};b.logJobCompleted=function(a){this.webcJobCompletedT=Date.now();this.jobResultType=a;var b={"int":{pendingJobsCount:this.pendingJobsCount,completedAt:this.webcJobCompletedT}};a==="completed"?this.eventFlow.endSuccess(b):this.eventFlow.endFail(a,b)};return a}();a=function(){function a(){this.$1=new Map()}var b=a.prototype;b.logJobCreated=function(a){var b=a.jobName,c=a.jobId,d=a.jobPriority;a=a.pendingJobsCount;b=new h(b,d,a);b.logJobAdded();this.$1.set(c,b)};b.logJobStarted=function(a){a=this.$1.get(a);a==null?void 0:a.logJobStarted()};b.logJobCompleted=function(a){this.$2(a,"completed")};b.logJobError=function(a){this.$2(a,"error")};b.logJobTimeout=function(a){this.$2(a,"timeout")};b.logJobAborted=function(a){this.$2(a,"aborted")};b.$2=function(a,b){var c=this.$1.get(a);c==null?void 0:c.logJobCompleted(b);this.$1["delete"](a)};return a}();g.JobInfoEvent=h;g.JobStatsLogger=a}),98);
__d("WAOrchestrator",["WAConcurrentBucketJobQueue","WAConcurrentPreemptiveJobQueue","WADefaultJobNoQueue","WAGlobals","WAJobOrchestratorTypes","WAOrchestratorJobStatsLogger"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a={maxConcurrency:1},b="default",c={},e=a,f=new(d("WAOrchestratorJobStatsLogger").JobStatsLogger)();return function(g,j){var k;g===void 0&&(g=!1);g=g?b:d("WAGlobals").getConfig().orchestratorVersion();k=(k=i())!=null?k:a;var l;j==null?void 0:j.addPoint("get_orchestrator",{string:{orchestrator:g},"int":{maxConcurrency:k.maxConcurrency,highPriorityQuota:(j=(j=k.jobPrioritiesQuota)==null?void 0:j.get(d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH))!=null?j:0,lowPriorityQuota:(j=(j=k.jobPrioritiesQuota)==null?void 0:j.get(d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW))!=null?j:0}});if(c[g]){h(e,k)&&(e=k,c[g].updateConfig(k));return c[g]}switch(g){case"preemptive":l=new(d("WAConcurrentPreemptiveJobQueue").WAConcurrentPreemptiveJobQueue)();break;case"bucket":l=new(d("WAConcurrentBucketJobQueue").WAConcurrentBucketJobQueue)();break;default:l=new(d("WADefaultJobNoQueue").WADefaultJobNoQueue)();break}l.init(k,f);c[g]=l;e=k;return l}}function h(a,b){var c;if(a.maxConcurrency!==b.maxConcurrency)return!0;if(((c=a.jobPrioritiesQuota)==null?void 0:c.size)!==((c=b.jobPrioritiesQuota)==null?void 0:c.size))return!0;return Object.keys((c=a.maxConcurrencyPerJob)!=null?c:{}).length!==Object.keys((c=b.maxConcurrencyPerJob)!=null?c:{}).length?!0:JSON.stringify(a)!==JSON.stringify(b)}function i(){var a={jobPrioritiesQuota:new Map([[d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,5],[d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,1]]),maxConcurrency:5,maxConcurrencyPerJob:{}};return a}g.getInstanceDelegate=a}),98);
__d("WaJobInMemoryAccessors",["Promise","WAHex","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){var a=-1,c=new Map();return{deletePersistedJob:function(a){return(h||(h=b("Promise"))).resolve(c["delete"](a))},loadAllJobs:function(){return(h||(h=b("Promise"))).resolve(Array.from(c.values()))},maybeCreateJob:function(e){var f,g=JSON.stringify([e.type,(f=e.uniqKey)!=null?f:d("WAHex").randomHex(32)]),i={backedOffCount:0,current:e.args,original:e.args,startTime:d("WATimeUtils").unixTime(),step:"$unstarted",stepFirstStartTime:null,stepHardStartCountAfterTimeout:0,stepUnexpectedErrorCount:0,type:e.type,uniqKey:g,version:e.version,waitUntil:null,scheduleConfig:e.scheduleConfig};f=function(){var d=a--,e=babelHelpers["extends"]({},i,{jobId:d});c.set(d,e);return(h||(h=b("Promise"))).resolve({id:d,newlyCreated:!0})};if(e.uniqKey!=null){e=Array.from(c.values()).filter(function(a){return a.uniqKey===g});if(e.length===0)return f();var j=null;e.forEach(function(a){a.step!=="$finished"?j=a:c["delete"](a.jobId)});return j!=null?(h||(h=b("Promise"))).resolve({id:j.jobId,newlyCreated:!1}):f()}return f()},readPersistedJob:function(a){a=c.get(a);return(h||(h=b("Promise"))).resolve(a&&babelHelpers["extends"]({},a))},updatePersistedJob:function(a){return(h||(h=b("Promise"))).resolve(c.set(a.jobId,babelHelpers["extends"]({},a)))}}}g.getJobInMemoryAccessors=a}),98);
__d("WAPersistedJobManagerV2",["Promise","WAErr","WAGlobals","WAJids","WAJobOrchestratorTypes","WAJobRequirement","WALogger","WAOrchestrator","WAPREList","WAPREMetrics","WAPersistedJobManager","WAPromiseBackoffs","WAResolvable","WATimeUtils","WaJobInMemoryAccessors","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose([""," waiting on ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose([""," halting because of ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose([""," has been loaded and is marked as deprecated"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["addPersistedJobImplementation called twice for ",""]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["onJobStarted for "," threw exception ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": "," step not found"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose([""," failed with error ",""]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["onJobFinished for "," threw exception ",""]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": finished job"]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception: ",""]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception. Tried "," times"]);y=function(){return a};return a}function z(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": RetryOnBackoff"]);z=function(){return a};return a}function A(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": delaying until ",""]);A=function(){return a};return a}function B(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": trim wait from "," to ",""]);B=function(){return a};return a}function C(){var a=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",".",""]);C=function(){return a};return a}function D(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": removing completed, expired job from db"]);D=function(){return a};return a}function E(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": skew detected, adjusting accordingly"]);E=function(){return a};return a}function F(){var a=babelHelpers.taggedTemplateLiteralLoose(["Running deprecated job ",""]);F=function(){return a};return a}function G(){var a=babelHelpers.taggedTemplateLiteralLoose(["No implementation for deprecated ",", job deleted"]);G=function(){return a};return a}function H(){var a=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",". Maybe it should have been put to the deprecated list?"]);H=function(){return a};return a}function I(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": InterruptJob"]);I=function(){return a};return a}function J(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": running step"]);J=function(){return a};return a}function K(){var a=babelHelpers.taggedTemplateLiteralLoose(["Persisted job missing for given ID"]);K=function(){return a};return a}function L(){var a=babelHelpers.taggedTemplateLiteralLoose(["[JOB MANAGER] Restarting job with the same id"]);L=function(){return a};return a}function M(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": stuck on the step ",", aborting the job"]);M=function(){return a};return a}var N=1;function O(a){var b=a.code,c=a.annotations;c=c===void 0?{}:c;a=a.eventFlow;var d=a===void 0?P(c):a;return b(d).then(function(a){d.endSuccess();return a})["catch"](function(a){d.endFail("error",{string:{error:""+a}});throw a})}function P(a){a===void 0&&(a={});return d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.WA_JOB_MANAGER,babelHelpers["extends"]({},a,{string:babelHelpers["extends"]({},(a=(a=a)==null?void 0:a.string)!=null?a:{},{userHash:d("WAGlobals").getDependencies().isEmployee()&&d("WAGlobals").getDependencies().isUseridAnnotationEnabled()?d("WAJids").extractUserId(d("WAGlobals").getMyUserJid()).slice(-5):null})}))}a=function(){function a(a){var c=this;this.$1=[];var e=a.isRestartAfterCrash,f=a.accessors,g=a.unfinishedJobEntries,i=a.ignoreForceNonPersistedJobList;this.getOrchestratorDelegate=d("WAOrchestrator").getInstanceDelegate();this.activeJobs=new Map();this.implementationLoaders=new Map();this.implementations=new Map();this.stepBlockers=new WeakMap();this.accessors=f;this.isRestartAfterCrash=e||!1;this.listeners=a.listeners;this.deprecatedJobs=a.deprecatedJobs;this.inMemoryAccessors=d("WaJobInMemoryAccessors").getJobInMemoryAccessors();this.offlineQueueMode=!0;this.$1=i;a.offlineQueueCompletePromise!=null?a.offlineQueueCompletePromise["finally"](function(){c.offlineQueueMode=!1}):this.offlineQueueMode=!1;this.initialJobsPromise=g.then(function(a){var e=[],f=[];a.forEach(function(a){a.stepHardStartCountAfterTimeout>=5?e.push(a):f.push(a)});return(h||(h=b("Promise"))).all(e.map(function(a){d("WALogger").ERROR(M(),R(a),a.step).devConsole(Q(a)).sendLogs("job-stuck-"+a.type);return c.accessors.deletePersistedJob(a.jobId)})).then(function(){f.forEach(function(a){var b=c.$2(a.jobId);if(b.alreadyActive===!0){d("WALogger").ERROR(L());return}b.deferred.resolve(O({code:function(b){return c.$3(a,c.accessors,{eventFlow:b})},annotations:{string:{name:a.type},bool:{offlineQueueMode:c.offlineQueueMode}}}))})})})}var e=a.prototype;e.$4=function(a,e,f){var g,h,i;return b("regeneratorRuntime").async(function(j){while(1)switch(j.prev=j.next){case 0:f===void 0&&(f={});h=this.$2(a);(g=f.eventFlow)==null?void 0:g.addPoint("start_load_and_run",{bool:{skipped:h.alreadyActive}});if(!(h.alreadyActive===!0)){j.next=5;break}return j.abrupt("return",h.deferred);case 5:j.next=7;return b("regeneratorRuntime").awrap(e.readPersistedJob(a));case 7:i=j.sent;if(!(i==null)){j.next=11;break}d("WALogger").ERROR(K()).sendLogs("missing-job-entry");throw c("WAErr")("Persisted job missing for given ID "+a);case 11:h.deferred.resolve(this.$3(i,e,f));return j.abrupt("return",h.deferred.promise);case 13:case"end":return j.stop()}},null,this)};e.$3=function(a,b,c){var e;c===void 0&&(c={});(e=c.eventFlow)==null?void 0:e.addPoint("enqueueing_job",{string:{name:a.type}});return this.getOrchestratorDelegate(((e=a.scheduleConfig)==null?void 0:e.priority)===d("WAJobOrchestratorTypes").JOB_PRIORITY.SKIP,c.eventFlow).enqueue(a.type,this.$5(a,b,c),a.scheduleConfig,c.eventFlow)};e.$6=function(a,b,c){var d=this;c===void 0&&(c={});return b.maybeCreateJob(a).then(function(a){var e;a=a.id;(e=c.eventFlow)==null?void 0:e.addPoint("job_persisted",{"int":{jobId:a},bool:{nonPersisted:b===d.inMemoryAccessors}});return a})};e.$2=function(a){var b=this.activeJobs.get(a);if(b!=null)return{alreadyActive:!0,deferred:b};b=new(d("WAResolvable").Resolvable)();this.activeJobs.set(a,b.promise);return{alreadyActive:!1,deferred:b}};e.$5=function(a,b,c){var d=this;return function(){return d.$7(a,b,c)}};e.$8=function(a){var b=this.implementations,c=this.implementationLoaders,d=b.get(a);if(d)return d;d=c.get(a);if(!d)return null;c=d();b.set(a,c);return c};e.$9=function(a,c){if(c==null||c.length===0)return(h||(h=b("Promise"))).resolve();var e=this.stepBlockers,f=e.get(c);f==null&&(f=d("WAJobRequirement").joinRequirements(c.map(function(a){return a()}),T),e.set(c,f));return f(a)};e.$10=function(a,b,c,e,f){var g,h=this;f===void 0&&(f={});var i=a.step;(g=f.eventFlow)==null?void 0:g.addPoint("start_step");var j=b.findIndex(function(a){return a.stepName===i});g=b[j].info(a.current,a.original,U(a,this.isRestartAfterCrash));var k=g.requirements,l=g.code;g=this.$9(a,k);e&&(g=g.then(e));return g.then(function(){var b;d("WALogger").LOG(J(),S(a));(b=f.eventFlow)==null?void 0:b.addPoint("run_step");return l(a.current,a.original,U(a,h.isRestartAfterCrash,f.eventFlow))}).then(function(e){var g;(g=f.eventFlow)==null?void 0:g.addPoint("step_is_complete");if(e instanceof d("WAPersistedJobManager").InterruptJob){d("WALogger").LOG(I(),S(a));return e.result}g=j+1;if(g>=b.length)return e;g=b[g];a.step=g.stepName;a.current=e;a.stepHardStartCountAfterTimeout=0;a.stepFirstStartTime=d("WATimeUtils").unixTime();a.stepUnexpectedErrorCount=0;a.waitUntil=null;a.backedOffCount=0;return c.updatePersistedJob(a).then(function(){return h.$10(a,b,c,void 0,f)})})};e.$7=function(a,c,e){var f,g,i=this,j,k,l,m,n,o,p,q,r,I,J,K,L,M,O;return b("regeneratorRuntime").async(function(P){while(1)switch(P.prev=P.next){case 0:e===void 0&&(e={});j=this.activeJobs,k=this.deprecatedJobs,l=this.listeners,m=l.onJobFinished,n=l.onJobStarted;(f=e.eventFlow)==null?void 0:f.addPoint("run_job");P.next=5;return b("regeneratorRuntime").awrap(this.$8(a.type));case 5:o=P.sent;p=k[a.type];if(o){P.next=23;break}if(p){P.next=15;break}d("WALogger").ERROR(H(),a.type).sendLogs("missing-job-implementation");P.next=12;return b("regeneratorRuntime").awrap(c.deletePersistedJob(a.jobId));case 12:return P.abrupt("return",null);case 15:if(!(p==="NOOP")){P.next=20;break}d("WALogger").WARN(G(),a.type);P.next=19;return b("regeneratorRuntime").awrap(c.deletePersistedJob(a.jobId));case 19:return P.abrupt("return",null);case 20:P.next=22;return b("regeneratorRuntime").awrap(p());case 22:o=P.sent;case 23:q=o;p&&d("WALogger").LOG(F(),a.type);r=(g=a.stepFirstStartTime)!=null?g:d("WATimeUtils").unixTime();a.stepFirstStartTime=r;a.stepUnexpectedErrorCount=a.stepUnexpectedErrorCount||0;a.backedOffCount=a.backedOffCount||0;if(!(a.step===d("WAPersistedJobManager").FINISHED_JOB)){P.next=46;break}I=a.waitUntil;J=d("WATimeUtils").secondsUntil(r);if(!(I!=null&&d("WATimeUtils").isInFuture(I)&&J>0)){P.next=40;break}d("WALogger").LOG(E(),Q(a));I=d("WATimeUtils").castToUnixTime(I-J);if(!d("WATimeUtils").isInFuture(I)){P.next=40;break}a.stepFirstStartTime=d("WATimeUtils").castToUnixTime(r-J);a.waitUntil=I;P.next=40;return b("regeneratorRuntime").awrap(c.updatePersistedJob(a));case 40:if(!(I==null||!d("WATimeUtils").isInFuture(I))){P.next=44;break}d("WALogger").LOG(D(),Q(a));P.next=44;return b("regeneratorRuntime").awrap(c.deletePersistedJob(a.jobId));case 44:j["delete"](a.jobId);return P.abrupt("return",a.current);case 46:K=a.step!==d("WAPersistedJobManager").UNSTARTED_JOB?o.find(function(b){return b.stepName===a.step}):o[0];if(K){P.next=52;break}d("WALogger").ERROR(C(),a.type,a.step).sendLogs("missing-job-step");P.next=51;return b("regeneratorRuntime").awrap(c.deletePersistedJob(a.jobId));case 51:return P.abrupt("return",null);case 52:a.step=K.stepName;L=function f(){var g=a.waitUntil,j=(h||(h=b("Promise"))).resolve();if(g!=null){var k=d("WATimeUtils").futureUnixTime(d("WATimeUtils").DAY_SECONDS);g>k?(d("WALogger").LOG(B(),S(a),g,k),a.waitUntil=k,j=c.updatePersistedJob(a).then(function(){return d("WATimeUtils").delayUntil(k)})):(d("WALogger").LOG(A(),S(a),g),j=d("WATimeUtils").delayUntil(g))}return j.then(function(){var b=function(){a.waitUntil=null;d("WATimeUtils").happenedWithin(r,d("WATimeUtils").DAY_SECONDS)||a.stepHardStartCountAfterTimeout++;return c.updatePersistedJob(a)};return i.$10(a,q,c,b,e)["catch"](function(b){if(b instanceof d("WAPersistedJobManager").RetryOnBackoff){var g;d("WALogger").LOG(z(),S(a));(g=e.eventFlow)==null?void 0:g.addPoint("retry_on_backoff");g=d("WAPromiseBackoffs").getDelay(++a.backedOffCount,b.backoffOptions);a.waitUntil=d("WATimeUtils").futureUnixTime(Math.ceil(g/1e3));a.stepHardStartCountAfterTimeout>0&&--a.stepHardStartCountAfterTimeout;return c.updatePersistedJob(a).then(f)}else{if(!(b instanceof d("WAPersistedJobManager").NonRetryableError)&&a.stepUnexpectedErrorCount<N){(g=e.eventFlow)==null?void 0:g.addPoint("retry_on_unexpected_error");d("WALogger").WARN(y(),S(a),a.stepUnexpectedErrorCount);d("WALogger").WARN(x(),S(a),b);a.stepUnexpectedErrorCount++;return c.updatePersistedJob(a).then(f)}throw b}})})};M=L();O=M.then(function(e){var f;return b("regeneratorRuntime").async(function(g){while(1)switch(g.prev=g.next){case 0:d("WALogger").LOG(w(),S(a));f=null;try{f=m(a.jobId,a.type,a.original,e)}catch(b){d("WALogger").ERROR(v(),a.type,b).sendLogs("onJobFinished-threw")}if(!(f!=null&&f>0)){g.next=12;break}a.waitUntil=d("WATimeUtils").futureUnixTime(Math.ceil(f/1e3));a.step=d("WAPersistedJobManager").FINISHED_JOB;a.current=e;a.stepFirstStartTime=d("WATimeUtils").unixTime();g.next=10;return b("regeneratorRuntime").awrap(c.updatePersistedJob(a));case 10:g.next=15;break;case 12:g.next=14;return b("regeneratorRuntime").awrap(c.deletePersistedJob(a.jobId));case 14:j["delete"](a.jobId);case 15:case"end":return g.stop()}},null,this)},function(e){var f,g;return b("regeneratorRuntime").async(function(h){while(1)switch(h.prev=h.next){case 0:d("WALogger").ERROR(u(),a.type,e).sendLogs("job-threw-exception-"+a.type);f=q.find(function(b){return b.stepName===a.step});if(f){h.next=6;break}d("WALogger").ERROR(t(),a.type,a.step);h.next=10;break;case 6:g=f.info(a.current,a.original,U(a,i.isRestartAfterCrash));if(!(g.stopRetryIf!=null)){h.next=10;break}h.next=10;return b("regeneratorRuntime").awrap(g.stopRetryIf.onStopRetry(a.current,a.original,U(a,i.isRestartAfterCrash)));case 10:h.next=12;return b("regeneratorRuntime").awrap(c.deletePersistedJob(a.jobId));case 12:j["delete"](a.jobId);case 13:case"end":return h.stop()}},null,this)});try{n(a.jobId,a.type,a.original)}catch(b){d("WALogger").ERROR(s(),a.type,b).sendLogs("onJobStarted-threw")}return P.abrupt("return",O.then(function(){return M}));case 58:case"end":return P.stop()}},null,this)};e.addPersistedJobImplementation=function(a,b){var c=this.implementationLoaders,e=this.deprecatedJobs;if(c.has(a)){d("WALogger").ERROR(r(),a).sendLogs("repeat-job-loader");return}e&&e[a]&&d("WALogger").DEV(q(),a);c.set(a,b)};e.fireAndForget=function(a){var c=this;if(this.$1.indexOf(a.type)===-1){d("WALogger").LOG(p(),a.type);this.fireAndForgetNonPersisted(a);return}d("WALogger").LOG(o(),a.type);O({code:function(d){var e;return b("regeneratorRuntime").async(function(f){while(1)switch(f.prev=f.next){case 0:e={eventFlow:d};f.next=3;return b("regeneratorRuntime").awrap(c.initialJobsPromise);case 3:d.addPoint("initial_jobs_promise_fulfilled");return f.abrupt("return",c.$6(a,c.accessors,e).then(function(a){return c.$4(a,c.accessors,e)}));case 5:case"end":return f.stop()}},null,this)},annotations:{string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}}})};e.waitUntilPersisted=function(a){var c=this,e;return b("regeneratorRuntime").async(function(f){while(1)switch(f.prev=f.next){case 0:if(!(this.$1.indexOf(a.type)===-1)){f.next=4;break}d("WALogger").LOG(n(),a.type);this.fireAndForgetNonPersisted(a);return f.abrupt("return",(h||(h=b("Promise"))).resolve());case 4:d("WALogger").LOG(m(),a.type);e=P({string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}});f.next=8;return b("regeneratorRuntime").awrap(this.initialJobsPromise);case 8:e.addPoint("initial_jobs_promise_fulfilled");return f.abrupt("return",this.$6(a,this.accessors,{eventFlow:e}).then(function(a){O({code:function(b){b={eventFlow:b};return c.$4(a,c.accessors,b)},eventFlow:e})})["catch"](function(a){e.endFail("error",{string:{error:""+a}});throw a}));case 10:case"end":return f.stop()}},null,this)};e.waitUntilCompleted=function(a){var c=this;if(this.$1.indexOf(a.type)===-1){d("WALogger").LOG(l(),a.type);return this.waitUntilCompletedNonPersisted(a)}d("WALogger").LOG(k(),a.type);return O({code:function(d){var e;return b("regeneratorRuntime").async(function(f){while(1)switch(f.prev=f.next){case 0:e={eventFlow:d};f.next=3;return b("regeneratorRuntime").awrap(c.initialJobsPromise);case 3:d.addPoint("initial_jobs_promise_fulfilled");return f.abrupt("return",c.$6(a,c.accessors,e).then(function(a){return c.$4(a,c.accessors,e)}));case 5:case"end":return f.stop()}},null,this)},annotations:{string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}}})};e.fireAndForgetNonPersisted=function(a){var c=this;O({code:function(d){var e;return b("regeneratorRuntime").async(function(f){while(1)switch(f.prev=f.next){case 0:e={eventFlow:d};f.next=3;return b("regeneratorRuntime").awrap(c.initialJobsPromise);case 3:d.addPoint("initial_jobs_promise_fulfilled");return f.abrupt("return",c.$6(a,c.inMemoryAccessors,e).then(function(a){return c.$4(a,c.inMemoryAccessors,e)}));case 5:case"end":return f.stop()}},null,this)},annotations:{string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}}})};e.waitUntilCompletedNonPersisted=function(a){var c=this;return O({code:function(d){var e;return b("regeneratorRuntime").async(function(f){while(1)switch(f.prev=f.next){case 0:e={eventFlow:d};f.next=3;return b("regeneratorRuntime").awrap(c.initialJobsPromise);case 3:d.addPoint("initial_jobs_promise_fulfilled");return f.abrupt("return",c.$6(a,c.inMemoryAccessors,e).then(function(a){return c.$4(a,c.inMemoryAccessors,e)}));case 5:case"end":return f.stop()}},null,this)},annotations:{string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}}})};return a}();function Q(a){return"Job["+a.jobId+"] ("+a.type+")"}function R(a){return"[Job "+a.type+"] "}function S(a){return"Job["+a.jobId+"] ("+a.type+"."+a.step+")"}function T(a,b,c){a==="unsatisfiable"?d("WALogger").LOG(j(),S(c),b):a==="unsatisfied"?d("WALogger").LOG(i(),S(c),b):a}function U(a,b,c){b===void 0&&(b=!1);return{jobStartTime:a.startTime,afterCrash:b,interruptJob:V,eventFlow:c}}function V(a){return new(d("WAPersistedJobManager").InterruptJob)(a)}g.PersistedJobManager=a}),98);
__d("WAWaitForComms",["WAResolvable"],(function(a,b,c,d,e,f,g){"use strict";var h=new(d("WAResolvable").Resolvable)();function a(){return h.promise}function b(){h.isSettled&&(h=new(d("WAResolvable").Resolvable)())}function c(){h.resolve()}function e(){return!h.resolveWasCalled()}function f(a){return h.reject(a)}g.waitForComms=a;g.commsConnectionLost=b;g.unblockComms=c;g.isStillWaitingForComms=e;g.failComms=f}),98);
__d("MAWJobManager",["MAWBridge","MAWDefinePersistedJob","MAWJobPersistenceAccessorsApi","WAPersistedJobManagerV2","WAWaitForComms","WAWaitForUserUnblocked"],(function(a,b,c,d,e,f,g){"use strict";var h=new(d("WAPersistedJobManagerV2").PersistedJobManager)({accessors:d("MAWJobPersistenceAccessorsApi").getJobPersistenceAccessors(),deprecatedJobs:{removeCurrentDevice:"NOOP"},ignoreForceNonPersistedJobList:["sendMsg","sendReactionMsg","sendMediaMsg","sendWrittenMsg","linkReactionsToMsgs","downloadAndHandleMedia"],isRestartAfterCrash:!1,listeners:{onJobFinished:function(a,b,c,e){d("MAWBridge").getBridge().fireAndForget("event","onJobFinished",{id:a,originalArgs:c,result:e,type:b},!0);return null},onJobStarted:function(){}},offlineQueueCompletePromise:d("WAWaitForUserUnblocked").waitForUserUnblocked(),unfinishedJobEntries:d("WAWaitForComms").waitForComms().then(function(){return d("MAWJobPersistenceAccessorsApi").getJobPersistenceAccessors().loadAllJobs()})});function a(){return d("MAWDefinePersistedJob").persistedJobsApi}function b(){return h}g.getPersistedJobsApi=a;g.getJobManager=b}),98);
__d("WAJobBuilder",["Promise","WAPersistedJobManager","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i=function(){function a(a){this.steps=a}var b=a.prototype;b.step=function(a,b){return this.$1(a,typeof b==="function"?{code:b}:b)};b.$1=function(b,c){var e=c.stopRetryIf,f=c.requirements;c=c.code;f=k(f,c,e);if(e){var g=e.timePassedSeconds;c=e.appCrashed;var h=e.onStopRetry;h=k(null,l(h),e);g!=null&&(f=j(function(a,b,c){a=c.jobStartTime;return d("WATimeUtils").happenedWithin(a,g)},f,h));c&&(f=j(function(a,b,c){a=c.afterCrash;return!a},f,h))}return new a([].concat(this.steps,[{stepName:b,info:f}]))};b.finalStep=function(a,b){var c=this.step(a,b);return{end:function(){return c.steps}}};return a}();function a(){return new i([])}function j(a,b,c){return function(d,e,f){return a(d,e,f)?b(d,e,f):c(d,e,f)}}function k(a,b,c){var d={requirements:a,code:b,stopRetryIf:c};return function(){return d}}function l(a){return function(c,e,f){return(h||(h=b("Promise"))).resolve(a(c,e,f)).then(function(a){return a instanceof d("WAPersistedJobManager").InterruptJob?a:new(d("WAPersistedJobManager").InterruptJob)(a)})}}g.JobBuilder=i;g.definePersistedJob=a}),98);
__d("MAWDefinePersistedJob",["MAWJobManager","Promise","WAJobBuilder"],(function(a,b,c,d,e,f,g){"use strict";var h;e={definePersistedJob:function(){return d("WAJobBuilder").definePersistedJob()}};function a(a){var c=d("MAWJobManager").getJobManager();Object.keys(a).forEach(function(d){var e=a[d];c.addPersistedJobImplementation(d,function(){return(h||(h=b("Promise"))).resolve(e)})})}function c(a){var b=d("MAWJobManager").getJobManager();Object.keys(a).forEach(function(c){var d=a[c];b.addPersistedJobImplementation(c,d)})}g.persistedJobsApi=e;g.setMsgrJobImplementations=a;g.setMsgrDeferredJobImplementations=c}),98);
__d("MAWDownloadManager",[],(function(a,b,c,d,e,f){"use strict";var g=1e4;a=function(){function a(){this.$1=[],this.$2=new Map()}var b=a.prototype;b.setToDownloadManager=function(a,b){this.$3(),this.$2.set(a,b),this.$1.push(a)};b.getFromDownloadManager=function(a){return this.$2.get(a)};b.removeFromMediaDownloadManager=function(a){this.$2["delete"](a);var b=this.$1.filter(function(b){return b!==a});this.setDownloadManagerQueue(b)};b.setDownloadManagerQueue=function(a){this.$1=a};b.$3=function(){if(this.$1.length>=g){var a=this.$1.shift();this.$2["delete"](a)}};return a}();f.DownloadManager=a}),66);
__d("MAWOptimisticUploadManager",[],(function(a,b,c,d,e,f){"use strict";var g=new Map();function a(){return g}function b(){g.clear()}f.getOptimisticUploadManager=a;f.clearOptimisticUploadManager=b}),66);
__d("MAWGetMediaPlaintextApi",["MAWIndexedDb","MAWMediaUtils","MAWOptimisticUploadManager","MAWTransactionMode","Promise","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media blob does not exist for the given hashedPlaintextHash"]);i=function(){return a};return a}a=function(a){var c=d("MAWOptimisticUploadManager").getOptimisticUploadManager();c=c.get(a);if(c==null)return j(a);else return(h||(h=b("Promise"))).resolve(c.file)};function j(a){return d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY},"getMediaPlaintextFromDb",function(a){return function(b){b=d("MAWMediaUtils").genHMACPlaintextHash(b);return a.chunk.where("hashedPlaintextHash").equals(b).first().then(function(a){if(!a){d("WALogger").WARN(i());return null}return new Blob([a.blobData],{type:a.mimetype})})}})(a)}g.getMediaPlaintext=a}),98);
__d("MAWGetMsgForProtocolMsgIdTxn",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY},"getMsgForProtocolMsgIdTxn",function(a){return function(b){return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(a){return a!=null?d("WAResultOrError").makeResult(a):d("WAResultOrError").makeError("message-not-found")})}});g.getMsgForProtocolMsgIdTxn=a}),98);
__d("MAWMediaDownloadManager",["MAWDownloadManager"],(function(a,b,c,d,e,f,g){"use strict";var h=new(d("MAWDownloadManager").DownloadManager)(),i=new(d("MAWDownloadManager").DownloadManager)();function a(a,b){h.setToDownloadManager(a,b)}function b(a){return h.getFromDownloadManager(a)}function c(a){h.removeFromMediaDownloadManager(a)}function e(a,b){i.setToDownloadManager(a,b)}function f(a){return i.getFromDownloadManager(a)}function j(a){i.removeFromMediaDownloadManager(a)}g.setToMediaDownloadManager=a;g.getFromMediaDownloadManager=b;g.removeFromMediaDownloadManager=c;g.setToMediaPlaintextDownloadManager=e;g.getFromMediaPlaintextDownloadManager=f;g.removeFromMediaPlaintextDownloadManager=j}),98);
__d("MAWHandleMediaDownloadApi",["MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWGetMsgQuoteTxn","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWLoggerUtils","MAWMediaAfterTxns","MAWMediaDownloadManager","MAWMediaUtils","MAWMsgType","MAWTransactionMode","MAWXMAUtils","Promise","WAArmadilloXMA.pb","WAResultOrError","WATagsLogger","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media is null when storing downloaded blob"]);i=function(){return a};return a}var j=d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.MediaDownload,d("MAWLoggerUtils").Tag.MessageReceive]);e=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READWRITE,media:a.READWRITE,messages:a.READONLY,receiverFetchInfo:a.READONLY,threads:a.READONLY,xma:a.READONLY},"handleMediaDownload",function(a){return function(e,f,g,m){var n=d("MAWMediaUtils").genHMACPlaintextHash(e);return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,m),a.media.where("hashedPlaintextHash").equals(n).first(),d("MAWDbChunkTxns").getOrCreateMediaChunk(a,e,g,f)]).then(function(m){var n=m[0],o=m[1];m[2];if(o==null){j.ERROR(i());return d("WAResultOrError").makeError("missing-media-on-save")}c("gkx")("2419")?m=d("MAWMediaDownloadManager").getFromMediaPlaintextDownloadManager(e):m=d("MAWMediaDownloadManager").getFromMediaDownloadManager(o.mediaId);m!=null&&(m((h||(h=b("Promise"))).resolve(new Blob([g],{type:f}))),c("gkx")("2419")?d("MAWMediaDownloadManager").removeFromMediaPlaintextDownloadManager(e):d("MAWMediaDownloadManager").removeFromMediaDownloadManager(o.mediaId));return k(a,n).then(function(b){if(!b)return a.messages.where("msgId").anyOf(o.msgIds).toArray().then(function(b){a.threads.where("jid").anyOf(b.map(function(a){return a.threadJid})).toArray().then(function(e){e.forEach(function(e){if(e!=null){e=d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:e.jid,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(b,e.jid),hasMediaForUI:!0,media:o,sortOrderMs:n==null?void 0:n.sortOrderMs});c("gkx")("2616")===!0?d("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(a,e,b):d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:e})}})});return b}).then(function(b){return l(a,b)});else if(c("gkx")("821"))return a.messages.where("msgId").anyOf(o.msgIds).toArray().then(function(b){a.threads.where("jid").anyOf(b.map(function(a){return a.threadJid})).toArray().then(function(e){e.forEach(function(e){if(e!=null)return d("MAWDbXMATxns").getXMAFromMsgs(a,b).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){if(d("MAWXMAUtils").isXMAStoryReply(b.targetType))return;if(b.defaultPreviewMediaId!==o.mediaId)return;c("promiseDone")(d("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(o,b,a))}))})})});return b}).then(function(b){return l(a,b)})}).then(function(){return d("MAWDbMediaTxns").updateMedia(a,o,{size:g.byteLength})}).then(function(){return d("WAResultOrError").makeResult()})})}});function k(a,b){var c;if(b==null)return d("MAWDexieTable").dexieResolve(!1);if(b.type===d("MAWMsgType").MSG_TYPE.XMA)return d("MAWDexieTable").dexieResolve(!0);return((c=b.quote)==null?void 0:c.content.xmaMessageType)===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY?d("MAWDexieTable").dexieResolve(b.type===d("MAWMsgType").MSG_TYPE.TEXT):d("MAWDbXMATxns").maybeGetXMAFromAssociatedMsgId(a,b.msgId).then(function(a){return a!=null})}function l(a,b){return d("MAWGetMsgQuoteTxn").maybeBatchGetMsgsByQuoteExternalId(a,b.map(function(a){return a.externalId})).then(function(b){return b.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,void 0,a,"EncryptedBackups")})})})})}g.handleMediaDownload=e}),98);
__d("MAWMediaPreviewDownloadManager",["WAResolvable","WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Expected preview resolvable to be present"]);h=function(){return a};return a}var i=d("WATagsLogger").TAGS(["MAWMediaPreviewDownloadManager"]),j=1e4,k=[],l=new Map();function a(a){if(l.has(a))return;n();var b=new(d("WAResolvable").Resolvable)();l.set(a,b);k.push(a)}function b(a,b){var c=l.get(a);if(c==null){i.ERROR(h());return}c.reject(b);m(a)}function c(a){return l.get(a)}function m(a){l["delete"](a)}function n(){if(k.length>=j){var a=k.shift();l["delete"](a)}}function e(){k=[],l.clear()}g.markMediaPreviewAsDownloading=a;g.markMediaPreviewAsFailed=b;g.getMediaPreviewDownloadingResolvable=c;g.removeMediaPreviewDownloadingResolvable=m;g.clear=e}),98);
__d("MAWHandleMediaPreviewBeforeDownloadApi",["MAWMediaPreviewDownloadManager","Promise"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(a){d("MAWMediaPreviewDownloadManager").markMediaPreviewAsDownloading(a);return(h||(h=b("Promise"))).resolve()};g.handleMediaPreviewBeforeDownload=a}),98);
__d("MAWMediaDownloadStatusForUI",["MAWBridge","MAWDbMediaTxns","MAWGetIsMediaDownloadStatusEnabled","MAWIndexedDb","MAWLoggerUtils","MAWMediaDownloadStatus","MAWTransactionMode","Promise","WATagsLogger","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["getStatusTypeFromWAAPIDownloadMediaError: Unknown error type ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[sendMediaDownloadStatusToUIWithMediaId] No media found - PlaintextHash: ",""]);j=function(){return a};return a}var k=d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.MediaDownload,d("MAWLoggerUtils").Tag.MessageReceive]);function a(a){var b=a.hash,e=a.mediaId,f=a.status;a=a.type;if(!d("MAWGetIsMediaDownloadStatusEnabled").getIsMediaDownloadStatusEnabled())return;c("gkx")("2419")?l({hash:b,status:f,type:a}):m({hash:b,mediaId:e,status:f,type:a})}function l(a){var b=a.hash,c=a.status;a=a.type;d("MAWBridge").getBridge().fireAndForget("event","updateMediaStatus",{key:b,status:c,type:a})}function m(a){var e=a.hash,f=a.mediaId,g=a.status,i=a.type;c("promiseDone")((f==null?n(e):new(h||(h=b("Promise")))(function(a){return a(f)})).then(function(a){a!=null?d("MAWBridge").getBridge().fireAndForget("event","updateMediaStatus",{key:a,status:g,type:i}):k.ERROR(j(),e)}))}var n=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY},"maybeGetMediaByPlaintextHashForDownloadStauts",function(a){return function(b){return d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,b).then(function(a){return a==null?void 0:a.mediaId})}});function e(a){switch(a){case"disconnected":case"backoff":case"body-network-error":case"no-host":case"download-throttled":case"max-attempts-exceeded":case"runtime-error":return c("MAWMediaDownloadStatus").MANUAL_RETRYABLE_FAILURE;case"request-error":case"media-not-found":case"media-entry-invalid":case"decryption-error":case"enc-hash-mismatch":case"hash-mismatch":case"ciphertext-hash-mismatch":case"media-key-expired":case"missing-media-key-timestamp":case"signature-expired":case"signature-expired-and-resign-failed-cdn-url":case"signature-expired-and-resign-failed-no-ids":return c("MAWMediaDownloadStatus").NOT_MANUAL_RETRYABLE_FAILURE;default:a;k.ERROR(i(),a);return c("MAWMediaDownloadStatus").MANUAL_RETRYABLE_FAILURE}}g.sendMediaDownloadStatusToUI=a;g.getStatusFromWAAPIDownloadMediaError=e}),98);
__d("MAWHandleMediaPreviewDownloadApi",["MAWBridgeTypesCreators","MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLoggerUtils","MAWMediaAfterTxns","MAWMediaDownloadStatus","MAWMediaDownloadStatusForUI","MAWMediaPreviewDownloadManager","MAWTransactionMode","WACryptoSha256","WAHashUtils","WALoggerTag","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Main media for preview is null. Type: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handling preview for main hash ","... preview hash ","..."]);i=function(){return a};return a}var j=d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.MediaDownload,d("MAWLoggerUtils").Tag.MessageReceive,c("WALoggerTag").MediaPreview]);a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){var g=d("WAHashUtils").toPlaintextHash(yield d("WACryptoSha256").sha256(b));d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({hash:a,status:c("MAWMediaDownloadStatus").DOWNLOADING,type:"preview"});var h=d("MAWMediaPreviewDownloadManager").getMediaPreviewDownloadingResolvable(a);h!=null&&(h.resolve(new Blob([b],{type:"image/jpeg"})),d("MAWMediaPreviewDownloadManager").removeMediaPreviewDownloadingResolvable(a));return k(a,g,b,e,f)});return function(b,c,d,e){return a.apply(this,arguments)}}();var k=d("MAWIndexedDb").makeMsgrTransactor({chunk:(e=d("MAWTransactionMode")).READWRITE,media:e.READWRITE,messages:e.READONLY,threads:e.READONLY},"handleMediaPreviewDownload",function(a){return function(b,e,f,g,k){return d("MAWDexieTable").dexieAll([d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,b),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,k)]).then(function(k){var l=k[0],m=k[1];j.LOG(i(),d("WAHashUtils").sanitisePlaintextHash(b),d("WAHashUtils").sanitisePlaintextHash(e));if(l==null){c("gkx")("2419")&&d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({hash:b,status:c("MAWMediaDownloadStatus").MANUAL_RETRYABLE_FAILURE,type:"preview"});j.WARN(h(),g);return d("WAResultOrError").makeError("missing-media-on-save")}switch(g){case"image":a.media.update(l.mediaId,babelHelpers["extends"]({},l,{validatedImageInfo:babelHelpers["extends"]({},l.validatedImageInfo,{jpegThumbnail:f})}));break;case"video":a.media.update(l.mediaId,babelHelpers["extends"]({},l,{validatedVideoInfo:babelHelpers["extends"]({},l.validatedVideoInfo,{jpegThumbnail:f})}));break;default:g;break}d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({hash:b,mediaId:l.mediaId,status:c("MAWMediaDownloadStatus").SUCCESS,type:"preview"});return a.messages.where("msgId").anyOf(l.msgIds).toArray().then(function(b){return a.threads.where("jid").anyOf(b.map(function(a){return a.threadJid})).toArray().then(function(e){e.forEach(function(e){if(e!=null){e=d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:e.jid,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(b,e.jid),hasMediaForUI:!0,media:l,sortOrderMs:m==null?void 0:m.sortOrderMs});c("gkx")("2616")===!0?d("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(a,e,b):d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:e})}});return d("WAResultOrError").makeResult()})})})}});g.handleMediaPreviewDownload=a}),98);
__d("MAWHandleMediaPreviewDownloadAsFailedApi",["MAWMediaPreviewDownloadManager","Promise"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(a,c){d("MAWMediaPreviewDownloadManager").markMediaPreviewAsFailed(a,c);return(h||(h=b("Promise"))).resolve()};g.handleMediaPreviewDownloadFailed=a}),98);
__d("MAWMediaRetryInfo",[],(function(a,b,c,d,e,f){"use strict";var g=new Map();function a(a,b){g.set(a,b)}function b(a){return g.get(a)}function c(a){g.has(a)&&g["delete"](a)}f.setRetriedMediaInfo=a;f.getRetriedMediaInfo=b;f.clearRetriedMediaInfo=c}),66);
__d("MAWUpdateMediaEntryForMsgApi",["FBLogger","MAWBridgeUpload","MAWCastToMsgrServerMediaType","MAWCastToServerMediaType","MAWConfig","MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWMediaBackupTxns","MAWOptimisticUploadManager","MAWTransactionMode","WAJids","WALogger","WAMediaUtils","err","isInstamadilloEB"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missing required arguments for media backup"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Nothing to update if updatedMediaEntry is null"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose([""," msgId does not exist within media entries"]);j=function(){return a};return a}var k=d("MAWIndexedDb").makeMsgrTransactor({media:(a=d("MAWTransactionMode")).READWRITE,mediaBackup:a.READWRITE,messages:a.READONLY,threads:a.READONLY},"updateMediaEntryForMsg",function(a){return function(b,e,f,g,k){var l=d("MAWCastToServerMediaType").castToServerMediaType(k);if(!l){c("FBLogger")("labyrinth_web","unsupported_media").mustfix("unsupported media type");throw c("err")("Media type unsupported: "+((l=k)!=null?l:""))}return d("MAWDexieTable").dexieAll([d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,b),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,e)]).then(function(b){var l=b[0],m=b[1];if(!m)throw c("err")("Message does not exist for the given protocolMsgId");if(!l)throw c("err")("Media does not exist for the given hashedPlaintextHash");if(!l.msgIds.includes(m.msgId)){d("WALogger").LOG(j(),m.msgId);return}b=l.mediaEntries;var n=b.get(m.msgId);n=f(n);if(n==null){d("WALogger").LOG(i());return}b=babelHelpers["extends"]({},l,{mediaEntries:b.set(m.msgId,n)});g!=null&&(b=babelHelpers["extends"]({},b,{objectId:d("WAMediaUtils").stringToDeliveryObjectId(g)}));var o=d("WAMediaUtils").decodeMediaEntryData(n);return a.media.put(b).then(function(b){return g!=null?d("MAWMediaBackupTxns").linkMediaBackup(a,l.mediaId,m.msgId,d("WAMediaUtils").stringToDeliveryObjectId(g)):d("MAWDexieTable").dexieResolve()}).then(function(){var a=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(k),b=o.mediaKeyTimestamp;g!=null&&a!=null&&b!=null&&(a!=="document"||d("MAWConfig").getConfig().enableDocumentBackupAndRestore())&&!c("isInstamadilloEB")()?d("MAWIndexedDb").afterTransaction({tag:"UploadAttachment",value:d("MAWBridgeUpload").createBridgeUploadAttachment(g,a,e.externalId,d("MAWConfig").getConfig().productTypeForEBAttachments,d("WAJids").threadIdForChatJid(e.chat),m.threadJid,b)}):d("WALogger").WARN(h())})})}});b=function(a,b,c,d,e){l(a,c);return k(a,b,c,d,e)};function l(a,b){var c=d("MAWOptimisticUploadManager").getOptimisticUploadManager(),e=c.get(a);if(e==null)return;b=b();if(b==null)return;c.set(a,babelHelpers["extends"]({},e,{mediaEntry:b}))}g.updateMediaEntryForMsg=b}),98);
__d("WAAPI",["cr:9751"],(function(a,b,c,d,e,f,g){"use strict";g["default"]=b("cr:9751")}),98);
__d("WAIsMediaExpiredError",[],(function(a,b,c,d,e,f){"use strict";a=function(a){switch(a){case"media-key-expired":case"signature-expired":case"signature-expired-and-resign-failed-no-ids":case"signature-expired-and-resign-failed-cdn-url":return!0;case"missing-media-key-timestamp":case"hash-mismatch":case"ciphertext-hash-mismatch":case"enc-hash-mismatch":case"decryption-error":case"max-attempts-exceeded":case"request-error":case"download-throttled":case"media-not-found":case"media-entry-invalid":case"no-host":case"backoff":case"body-network-error":case"disconnected":case"runtime-error":return!1;default:a;return!0}};f.isMediaExpiredError=a}),66);
__d("MAWHandleEchoMediaMsgsRestoreV2",["EchoMessage","EchoMessageMediaFieldUtils","LSDataTraceCheckPoint","LSDataTraceType","LSIntEnum","MAWAsConsumerApplication","MAWBridge","MAWBridgeTypesCreators","MAWCastToMsgrServerMediaType","MAWConfig","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWEBBackendQPLUtils","MAWFrontendMediaUtils","MAWGetMediaPlaintextApi","MAWGetMsgForProtocolMsgIdTxn","MAWHandleMediaDownloadApi","MAWHandleMediaPreviewBeforeDownloadApi","MAWHandleMediaPreviewDownloadApi","MAWHandleMediaPreviewDownloadAsFailedApi","MAWIndexedDb","MAWJids","MAWJobDefinitions","MAWJobManager","MAWMediaDownloadStatus","MAWMediaDownloadStatusForUI","MAWMediaManagementTxns","MAWMediaRetryInfo","MAWMediaUtils","MAWSupportedDocumentTypes","MAWTraceUtils","MAWTransactionMode","MAWUpdateMediaEntryForMsgApi","Promise","WAAPI","WAArmadilloXMA.pb","WABase64","WAGetAgeBucketForMediaKeyTimestamp","WAGetStorageQplAnnotations","WAGlobals","WAHashUtils","WAIsMediaExpiredError","WAJids","WAJobOrchestratorTypes","WALogger","WAMediaUtils","WAStartMediaDownloadQplFlow","WATagsLogger","WATimeUtils","asyncToGeneratorRuntime","cr:10071","gkx","qex"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql error: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql success. hash: ",". externalId ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql failed: ",". hash: ",". externalId ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql start. hash: ",". msgId: ",". traceId: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["start restore media from backup. hash: ",". msgId: ",". traceId: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Skipping media restore for expirable XMA. externalId ",". xmamessageType: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot find the media entry for message with mediaKey ",", msg id: ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot find the media entry for message with mediaKey ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media for message: "," is already downloaded on the device"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to construct downloadableThumbnail from previewMediaData: ",", msg id: ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Encrypted hash cannot be null for non-XMA attachments, msg id: ",""]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot download media - document extension is disallowed, msg id: ",""]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot download media - media content type null, msg id: ",""]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media entry is missing from index db. It is required to retry download by resigning cdn url: externalId: ",". traceId: ",""]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["start resign cdn url through sproc"]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media download failed with error: "," "," when downloading. Message timestamp: ",". traceId: ",""]);y=function(){return a};return a}function z(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Retry download media as signature has expired and should be renewed. externalId ",". traceId: ",""]);z=function(){return a};return a}function A(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media download complete. externalId ",". traceId: ",""]);A=function(){return a};return a}function B(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] downloading media from MI directly. externalId ","."]);B=function(){return a};return a}function C(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] start media download from whatsapp infra. traceId: ",""]);C=function(){return a};return a}function D(){var a=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash is null - unable to download thumbnail"]);D=function(){return a};return a}var E="media_restore";function F(a){var c=J(a);return c.then(function(c){var d=new Map();a.forEach(function(a){var b=c.get(a);b=b==null?void 0:b.blobData;d.set(a,b)});return(i||(i=b("Promise"))).resolve(d)})}function G(a){switch(a){case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG:return"image/jpeg";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_PNG:return"image/png";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.STICKER:return"image/webp";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.GIF:return"image/gif";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_MP4:return"audio/mp4";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_WAV:return"audio/wav";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.XMA:return"xma"}}function a(a,b,c){return H.apply(this,arguments)}function H(){H=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f){if(a.length===0)return(i||(i=b("Promise"))).resolve();var g=[],j=[],k=new Map(),l=new Map();a.map(function(a){var c=a.mediaData,e=a.messageTimestamp,f=L(c.plaintextHash),h=c.attachmentObjectId,m=c.attachmentType,n=c.backupEntFbid,o=c.directPath,p=c.filename,q=c.height,r=c.mediaContentType,w=c.mediaKeyTimestamp,x=c.mediaPlayableDuration,y=c.previewContentHeight,z=c.previewContentType,A=c.previewContentWidth,B=c.size;c=c.width;var C=d("WAHashUtils").stringToPlaintextHash(f),D=d("MAWMediaUtils").genHMACPlaintextHash(C);j.push(D);r=r!=null?d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(r,a.isXMA):z!=null?d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(G(z)):null;if(r==null){d("WALogger").ERROR(v(),a.externalId);return(i||(i=b("Promise"))).resolve()}if(m===d("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT&&!d("MAWSupportedDocumentTypes").isAllowedType(p)){d("WALogger").LOG(u(),a.externalId);return(i||(i=b("Promise"))).resolve()}z=a.mediaData.encryptedHash;if(z==null&&!a.isXMA){d("WALogger").ERROR(t(),a.externalId);return(i||(i=b("Promise"))).resolve()}m=r.mediaType;r=r.serverMediaType;h=d("WAMediaUtils").stringToDeliveryObjectId(h);n=n!=null?d("WAMediaUtils").stringToBackupEntFbid(n):void 0;var E=a.threadJId,F=M({filename:p,height:q,mediaPlayableDuration:x,mediaType:m,previewContentHeight:y,previewContentWidth:A,width:c});l.set(h,{filename:p,height:q,mediaPlayableDuration:x,mediaType:m,messageTimestamp:e,plaintextHash:C,previewContentHeight:y,previewContentWidth:A,serverMediaType:r,threadJId:E,width:c});q=null;if(a.previewMediaData!=null)try{q=O(a.previewMediaData)}catch(b){d("WALogger").ERROR(s(),b,a.externalId)}if(z!=null){x=N(f,z,a.mediaData.mediaKey,o,w,r,p,n,h,q,B);g.push({entry:x,fbId:n,hashedPlaintextHash:D,isXMAShare:a.isXMA,mediaInfo:F,mediaType:m,msgId:a.msgId,objectId:h,plaintextHash:C,size:(e=B)!=null?e:0})}A=(y=k.get(D))!=null?y:[];A.push(a);k.set(D,A)});var m=(yield I(g,e));a=(yield F(j));var n=[];a.forEach(function(a,b){var i=k.get(b);i==null?void 0:i.forEach(function(i){if(i==null)return;if(a!=null){d("WALogger").LOG(r(),i.externalId);var j=m.find(function(a){return a.plaintextHash===i.mediaData.plaintextHash});if(j==null){d("WALogger").LOG(q(),i.mediaData.mediaKey);return}return K(j.msgIds).then(function(a){if(c("gkx")("5301")){var b=a.filter(function(a){return d("MAWDbMsg").isMediaMsg(a)});b.length>0&&d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewMedia",value:d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:i.threadJId,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(b,e),hasMediaForUI:!0,media:j})}]})}else d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewMedia",value:d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:i.threadJId,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(a,e),hasMediaForUI:!0,media:j})}]})})}var k=d("MAWTraceUtils").startNewTrace((h||(h=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_MEDIA_RESTORE),E);d("MAWTraceUtils").recordCheckpointForTrace(k,h.ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_MEDIA_RESTORE_START),[],!1);var o=l.get(d("WAMediaUtils").stringToDeliveryObjectId(i.mediaData.attachmentObjectId));if(i==null||o==null)return;var s=o.filename,t=o.height,u=o.mediaPlayableDuration,v=o.mediaType,w=o.messageTimestamp,x=o.plaintextHash,y=o.previewContentHeight,z=o.previewContentWidth,A=o.serverMediaType,B=o.threadJId;o=o.width;var C=d("WAJids").extractUserId(d("MAWJids").toUserJid(i.threadJId));A=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(A,i.isXMA);if(A!=null){A={attachmentFbId:i.mediaData.backupEntFbid,attachmentObjectId:d("WAMediaUtils").stringToDeliveryObjectId(i.mediaData.attachmentObjectId),mediaType:A,messageId:i.externalId,messageTimeStamp:i.messageTimestamp,msgId:i.msgId,plaintextHash:x,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,threadId:C,threadJid:B};C=g.find(function(a){return a.hashedPlaintextHash===b});C=C==null?void 0:C.entry;if(C==null){d("WALogger").ERROR(p(),i.mediaData.mediaKey,i.externalId);return}if(f===!0&&c("qex")._("1483")===!0)return;n.push(P({author:i.author,directPath:i.mediaData.directPath,echoMsg:i.echoMsg,externalId:i.externalId,filename:s,hashedPlaintextHash:b,height:t,isXMA:i.isXMA,mediaPlayableDuration:u,mediaType:v,messageTimestamp:w,plaintextHash:x,previewContentHeight:y,previewContentWidth:z,threadJId:B,width:o},k,A,void 0,d("WAMediaUtils").decodeMediaEntryData(C)))}})});yield (i||(i=b("Promise"))).all(n)});return H.apply(this,arguments)}var I=(e=d("MAWIndexedDb")).makeMsgrTransactor({media:(f=d("MAWTransactionMode")).READWRITE,mediaBackup:f.READWRITE,messages:f.READWRITE},"restoreLinkMedias",function(a){return function(b,c){return d("MAWMediaManagementTxns").bulkLinkMedia(a,b,c)}}),J=e.makeMsgrTransactor({chunk:f.READONLY},"getChunksByHash",function(a){return function(b){return d("MAWDbChunkTxns").maybeBulkGetChunksFromHash(a,b)}}),K=e.makeMsgrTransactor({messages:f.READONLY},"getMessagesForMsgIds",function(a){return function(b){return a.messages.where("msgId").anyOf(b).toArray()}});function L(a){if(a.endsWith("=")){var b="";for(var c=0;c<a.length;c++){var d=a.charAt(c);if(d==="=")return b;b+=d}}return a}function M(a){var b=a.height,c=a.mediaType,e=a.width,f=a.previewContentHeight,g=a.previewContentWidth,h=a.mediaPlayableDuration;a=a.filename;return{validatedAudioInfo:c==="Ptt"&&h!=null?{duration:S(h),mimetype:d("MAWAsConsumerApplication").AUDIO_MIME_TYPE,played:!1}:null,validatedDocumentFileInfo:c==="DocumentFile"?{filename:a,mimetype:d("MAWAsConsumerApplication").FILE_MIME_TYPE}:null,validatedImageInfo:c==="Image"?{height:b,jpegThumbnailHeight:f,jpegThumbnailWidth:g,width:e}:c==="Gif"||c==="Sticker"?{height:b,jpegThumbnailHeight:b,jpegThumbnailWidth:e,width:e}:null,validatedVideoInfo:c==="Video"?{height:b,jpegThumbnailHeight:f,jpegThumbnailWidth:g,mimetype:d("MAWAsConsumerApplication").VIDEO_MIME_TYPE,width:e}:null}}function N(a,b,c,e,f,g,h,i,j,k,l){a=d("WABase64").decodeB64UrlSafe(a,!0);b=d("WABase64").decodeB64UrlSafe(b,!0);c=c!=null?d("WABase64").decodeB64UrlSafe(c,!0):void 0;return d("WAMediaUtils").rawDataToMediaEntry({directPath:e,downloadableThumbnail:k!=null?k:void 0,fbid:i!=null?i:void 0,fileEncSha256:b,filename:h,fileSha256:a,mediaKey:c,mediaKeyTimestamp:f!=null?d("WATimeUtils").castToUnixTime(f):void 0,objectId:j!=null?j:void 0,serverMediaType:g,size:l!=null?l:void 0})}function O(a){var b=a.attachmentObjectId,c=a.directPath,e=a.encryptedHash,f=a.mediaKey,g=a.mediaKeyTimestamp;a=a.plaintextHash;if(e==null){d("WALogger").ERROR(D());return}else{g=g!=null?d("WATimeUtils").castToUnixTime(g):void 0;f=f!=null?d("WAMediaUtils").castToMediaKey(d("WABase64").decodeB64UrlSafe(f,!0)):void 0;a=d("WABase64").decodeB64UrlSafe(a,!0);e=d("WABase64").decodeB64UrlSafe(e,!0);return{directPath:c,fileEncSha256:e,fileSha256:a,mediaKey:f,mediaKeyTimestamp:g,objectId:b}}}var P=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g){var i,j;d("WALogger").LOG(C(),b);var k=a.author,l=a.externalId,m=a.filename,n=a.hashedPlaintextHash,o=a.height,p=a.mediaPlayableDuration,q=a.mediaType,r=a.messageTimestamp,s=a.plaintextHash,t=a.previewContentHeight,u=a.previewContentWidth,v=a.threadJId,w=a.width;d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({hash:s,status:c("MAWMediaDownloadStatus").DOWNLOADING,type:"main"});i=((i=(i=d("MAWMediaRetryInfo").getRetriedMediaInfo(l))==null?void 0:i.isXMA)!=null?i:!1)||((i=a==null?void 0:a.isXMA)!=null?i:!1);j=((j=d("MAWMediaRetryInfo").getRetriedMediaInfo(l))==null?void 0:(j=j.echoMsg)==null?void 0:j.serializationOrigin)||(a==null?void 0:(j=a.echoMsg)==null?void 0:j.serializationOrigin)||d("EchoMessage").EchoSerializationOriginType.UNKNOWN;k={author:k,chat:v,externalId:l};d("MAWEBBackendQPLUtils").logMediaRestoreFromMIQPLPoint(b,"download_media_start");v=c("gkx")("23960");var x=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:k});x.addAnnotations({bool:{isEBDownloadEnforced:e==null&&v,isRetryFromMI:e==null,isXMA:i,pathMismatch:f!==g.directPath},"int":{mediaEntrySize:g.size},string:{oldDirectPath:(i=a==null?void 0:a.oldDirectPath)!=null?i:"",origin:j,restorationCdnUrl:(i=f)!=null?i:""}});void d("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(a){x.addAnnotations(a)});if(e!=null&&v){d("WALogger").LOG(B(),k.externalId);return U({decodedMediaEntry:g,isEBDownloadEnforced:v,mediaDownloadRequest:a,protocolMsgId:k,retryPayload:e})}j=f==null?d("WAGlobals").getConfig().skipExpiredDownload():!1;i=d("WAGlobals").getConfig().uiLayoutTriggeredMediaDownload()?yield c("WAAPI").cachedDownloadFullMediaOnly({downloadMediaMetric:x,getMediaPlaintext:d("MAWGetMediaPlaintextApi").getMediaPlaintext,hash:s,mediaEntry:g,onlyIfMediaTTLIsValid:j,protocolMsgId:k,updateMediaEntryForMsg:d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg}):yield c("WAAPI").downloadMedia({downloadMediaMetric:x,getMediaPlaintext:d("MAWGetMediaPlaintextApi").getMediaPlaintext,handleMediaPreviewBeforeDownload:d("MAWHandleMediaPreviewBeforeDownloadApi").handleMediaPreviewBeforeDownload,handleMediaPreviewDownload:d("MAWHandleMediaPreviewDownloadApi").handleMediaPreviewDownload,handleMediaPreviewDownloadFailed:d("MAWHandleMediaPreviewDownloadAsFailedApi").handleMediaPreviewDownloadFailed,hash:s,mediaEntry:g,onlyIfMediaTTLIsValid:j,protocolMsgId:k,updateMediaEntryForMsg:d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg});if(i.success){d("MAWEBBackendQPLUtils").logMediaRestoreFromMIQPLPoint(b,"download_media_end");v=i.value;f=v.mimeType;j=v.plaintext;yield d("MAWHandleMediaDownloadApi").handleMediaDownload(s,f,j,k);x.endSuccess();d("MAWMediaRetryInfo").clearRetriedMediaInfo(l);v=M({filename:m,height:o,mediaPlayableDuration:p,mediaType:q,previewContentHeight:t,previewContentWidth:u,width:w});yield R(n,v);d("WALogger").LOG(A(),k.externalId,b);d("MAWTraceUtils").recordSuccessAndFlushForTraceId(b,(h||(h=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_MEDIA_RESTORE_SUCCESS),[]);d("MAWEBBackendQPLUtils").logMediaRestoreFromMIQPLEndSuccess(b);d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({hash:s,status:c("MAWMediaDownloadStatus").SUCCESS,type:"main"})}else{d("MAWEBBackendQPLUtils").logMediaRestoreFromMIQPLPoint(b,"download_media_fail");f=i.error;d("WAIsMediaExpiredError").isMediaExpiredError(f)&&e?(x.addPoint("eb_resign_requested"),x.endSuccess(),d("WALogger").WARN(z(),k.externalId,b),yield U({decodedMediaEntry:g,isEBDownloadEnforced:!1,mediaDownloadRequest:a,protocolMsgId:k,retryPayload:e})):(d("WALogger").ERROR(y(),l,f,r,b),x.endFail(f),d("MAWEBBackendQPLUtils").logMediaRestoreFromMIQPLEndFailure(b,"media_download_failure"),d("MAWMediaRetryInfo").clearRetriedMediaInfo(l),d("MAWTraceUtils").recordFailureAndFlushForTraceId(b,(h||(h=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_MEDIA_RESTORE_FAILURE),[],"media download failed with error: "+f),d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({hash:s,status:d("MAWMediaDownloadStatusForUI").getStatusFromWAAPIDownloadMediaError(f),type:"main"}))}});return function(b,c,d,e,f){return a.apply(this,arguments)}}(),Q=e.makeMsgrTransactor({media:f.READONLY,mediaBackup:f.READONLY,messages:f.READONLY},"invokeRestoreAccessCheckSprocToDownloadAttachment",function(a){return function(b,e,f){var g=d("WAMediaUtils").stringToDeliveryObjectId(e.attachmentObjectId);g=c("gkx")("4663")?d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,e.plaintextHash):d("MAWDbMediaTxns").maybeGetMediaFromObjectId(a,g);return g.then(function(g){if(g){d("WATagsLogger").TAGS(["labyrinth_web","media_restore",f]).LOG(x());var i=W(g,e.attachmentObjectId);return d("MAWDbMsgTxns").getMsgsByMsgIds(a,i).then(function(a){var c,h=a.find(function(a){return a.externalId===b});d("MAWEBBackendQPLUtils").logMediaRestoreFromMIQPLPoint(f,"resign_cdn_url_bridge_call",{bool:{isForwarded:(c=h==null?void 0:h.isForwarded)!=null?c:!1},"int":{duplicateMsgsCount:a.length,msgXMAType:h==null?void 0:h.xmaMessageType,totalMediaEntries:g.mediaEntries.size},int_array:{duplicateXMATypes:a.map(function(a){return(a=a.xmaMessageType)!=null?a:0})},string:{msgType:h==null?void 0:h.type},string_array:{duplicateMsgs:a.map(function(a){return a.externalId}),duplicateMsgTypes:a.map(function(a){return a.type})}});d("MAWIndexedDb").afterTransaction({tag:"ResignAttachmentCDNUrl",value:{backupEntFbid:e.attachmentFbId,chatId:e.chatId==null?void 0:e.chatId.toString(),deliveryObjectId:e.attachmentObjectId,mediaType:e.mediaType,messageId:b,msgId:e.msgId,plaintextHash:e.plaintextHash,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,sortOrder:e.messageTimeStamp,threadId:e.threadId,threadJid:e.threadJid,traceId:f}})})}else d("WALogger").ERROR(w(),b,f),d("MAWEBBackendQPLUtils").logMediaRestoreFromMIQPLEndFailure(f,"missing-media"),d("MAWTraceUtils").recordFailureAndFlushForTraceId(f,(h||(h=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_MEDIA_RESTORE_FAILURE),[],"media entry is missing from index db. It is required to retry download by resigning cdn url")})}}),R=e.makeMsgrTransactor({media:f.READWRITE,messages:f.READWRITE},"updateMediaWithDownloadedChunkBlob",function(a){return function(b,c){return d("MAWMediaManagementTxns").updateMediaEntryWithValidatedMediaInfo(a,b,c)}});function S(a){var b=Math.floor(a/1e3);if(b>0)return b;else return a}function T(a){return a==null?!1:a===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY||a===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION}function U(a){return V.apply(this,arguments)}function V(){V=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=a.decodedMediaEntry,e=a.isEBDownloadEnforced,f=a.mediaDownloadRequest,g=a.protocolMsgId,h=a.retryPayload;a=(yield d("MAWGetMsgForProtocolMsgIdTxn").getMsgForProtocolMsgIdTxn(g));if(a.success===!0&&T(a.value.xmaMessageType)){d("WALogger").LOG(o(),g.externalId,a.value.xmaMessageType);return(i||(i=b("Promise"))).resolve()}var p=d("MAWTraceUtils").createTraceId(),q=g.externalId;d("WALogger").LOG(n(),d("WAHashUtils").sanitisePlaintextHash(h.plaintextHash),q,p);d("MAWMediaRetryInfo").setRetriedMediaInfo(g.externalId,f);f=((a=c.mediaKeyTimestamp)!=null?a:0)>1725105600;a={bool:{is_after_S441705_fix:f,isEBDownloadEnforced:e},"int":{mediaKeyTimestamp:c.mediaKeyTimestamp},string:{externalId:q,mediaKeyAge:d("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(c.mediaKeyTimestamp),mediaType:h.mediaType,objectId:h.attachmentObjectId,restoreEntry:"EB",restoreMethod:b("cr:10071")==null?"sproc":"gql",traceId:p}};var r=d("MAWEBBackendQPLUtils").startMediaRestoreQPLFlow({annotations:a,traceId:p});b("cr:10071")!=null&&(d("WALogger").LOG(m(),d("WAHashUtils").sanitisePlaintextHash(h.plaintextHash),q,p),void b("cr:10071").eblsResignCdnUrlWithGraphQL({chatJid:g.chat,deliveryObjectId:h.attachmentObjectId,externalId:q,mediaType:h.mediaType,plaintextHash:h.plaintextHash,sortOrderMs:h.messageTimeStamp}).then(function(a){if(a.success===!1){d("WALogger").LOG(l(),a.error,d("WAHashUtils").sanitisePlaintextHash(h.plaintextHash),q);r.endFail(a.error);return}d("WALogger").LOG(k(),d("WAHashUtils").sanitisePlaintextHash(h.plaintextHash),q);a=d("MAWJobDefinitions").createStartJobInfo("downloadAndRestoreMedia",{deliveryObjectId:h.attachmentObjectId,msgId:h.msgId,plaintextHash:h.plaintextHash,restorationCdnUrl:a.value,scheduleConfig:{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW},traceId:p});return d("MAWJobManager").getJobManager().fireAndForget(a)})["catch"](function(a){d("WALogger").ERROR(j(),a),r.endFail("runtime-error",{string:{restoreError:a.toString()}})}));return Q(q,h,p)});return V.apply(this,arguments)}function W(a,b){var c=[];(a=a.mediaEntries)==null?void 0:a.forEach(function(a,e){a=d("WAMediaUtils").decodeMediaEntryData(a);a.objectId===b&&c.push(e)});return c}g.downloadMediaAndWriteToMediaStore=a;g.getBase64WithoutPadding=L;g.constructMediaEntry=N;g.handleDownloadMedia=P;g.invokeRestoreAccessCheckSprocToDownloadAttachment=Q}),98);
__d("MAWHandleEchoMsgsRestoreApiUtils",["$InternalEnum","EchoMessage","EchoMessageMediaFieldUtils","MAWAckLevel","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWJids","MAWMsgType","MAWRepliesRestoreUtils","WAJids","WAStanzaUtils","WATagsLogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Message content is empty for the message: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Author info is missing from msg: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] thread has unsupported message type: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] thread has unsupported message content type: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] thread has unsupported message content type: ",", xContentType: ",",\n      subcontent type: "," ,\n      origin: ",""]);l=function(){return a};return a}c=b("$InternalEnum")({INITIAL_RESTORE:"initial_restore",POINT_RESTORE:"point_restore",PAGINATED_RESTORE:"paginated_restore"});function m(a,b){var c,e=a.contentType;switch(e){case d("EchoMessage").EchoMessageContentType.TEXT:return a.xContentType===d("EchoMessage").EchoXMessageContentType.BUMP?d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:d("MAWMsgType").MSG_TYPE.TEXT;case d("EchoMessage").EchoMessageContentType.MEDIA:return a.receiverFetchId!=null&&a.receiverFetchData!=null?d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:n(a);case d("EchoMessage").EchoMessageContentType.PLACEHOLDER:if(a.contentSubtype===d("EchoMessage").EchoMessageContentSubtype.UNSEND)return d("MAWMsgType").MSG_TYPE.REVOKED;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(c=b)!=null?c:""]).ERROR(l(),d("EchoMessage").EchoMessageContentType.getName(e),a.xContentType!=null?d("EchoMessage").EchoXMessageContentType.getName(a.xContentType):"unknown",d("EchoMessage").EchoMessageContentSubtype.getName(a.contentSubtype),a.serializationOrigin!=null?d("EchoMessage").EchoSerializationOriginType.getName(a.serializationOrigin):"unknown");break;case d("EchoMessage").EchoMessageContentType.XMA:return d("MAWMsgType").MSG_TYPE.XMA;case d("EchoMessage").EchoMessageContentType.DECRYPTION_FAILURE:return d("MAWMsgType").MSG_TYPE.CIPHERTEXT;default:d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(c=b)!=null?c:""]).ERROR(k(),d("EchoMessage").EchoMessageContentType.getName(e))}return null}function n(a,b){a=a.mediaData;if(a!=null){switch(a.attachmentType){case d("EchoMessageMediaFieldUtils").AttachmentType.IMAGE:return d("MAWMsgType").MSG_TYPE.IMAGE;case d("EchoMessageMediaFieldUtils").AttachmentType.STICKER:return d("MAWMsgType").MSG_TYPE.STICKER;case d("EchoMessageMediaFieldUtils").AttachmentType.VIDEO:return d("MAWMsgType").MSG_TYPE.VIDEO;case d("EchoMessageMediaFieldUtils").AttachmentType.GIF:return d("MAWMsgType").MSG_TYPE.GIF;case d("EchoMessageMediaFieldUtils").AttachmentType.PTT:return d("MAWMsgType").MSG_TYPE.PTT;case d("EchoMessageMediaFieldUtils").AttachmentType.XMA:return d("MAWMsgType").MSG_TYPE.XMA;case d("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT:return d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE}d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(b=b)!=null?b:""]).ERROR(j(),d("EchoMessageMediaFieldUtils").AttachmentType.getName(a.attachmentType))}return null}function a(a,b,c,e,f){var g=a.from;if(g==null){var h;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(h=f)!=null?h:""]).ERROR(i(),e);return null}h=m(a,f);if(h==null||a.isTombstoned!=null&&a.isTombstoned)return null;switch(h){case d("MAWMsgType").MSG_TYPE.TEXT:case d("MAWMsgType").MSG_TYPE.REVOKED:case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:return t(a,b,c,g,h,e,f);case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return o(a,b,c,g,h,e);case d("MAWMsgType").MSG_TYPE.XMA:return q(a,b,c,g,h,e);case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return w(a,b,c,g,h,e);case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return r(a,b,c,g,h,e)}return null}function o(a,b,c,d,e,f){a=u(a,b,c,d,e,f);return p(e,a)}function p(a,b){switch(a){case d("MAWMsgType").MSG_TYPE.IMAGE:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.IMAGE});case d("MAWMsgType").MSG_TYPE.STICKER:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.STICKER});case d("MAWMsgType").MSG_TYPE.VIDEO:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.VIDEO});case d("MAWMsgType").MSG_TYPE.GIF:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.GIF});case d("MAWMsgType").MSG_TYPE.PTT:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.PTT});case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE})}}function q(a,b,c,e,f,g){b=u(a,b,c,e,f,g);c=a.text;if(a.xmaData!=null&&a.xmaData.xmaTargetType!=null){e=babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:d("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(a.xmaData.xmaTargetType)});c!=null&&(e.msgContent={content:c});return e}return null}function r(a,b,c,e,f,g){b=u(a,b,c,e,f,g);if(a.receiverFetchData!=null){c=babelHelpers["extends"]({},b,{receiverFetchId:a.receiverFetchId,type:d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH});return c}return null}function s(a){if(a==null)return void 0;else switch(a){case d("EchoMessage").MessageTextSize.SMALL:return 1;case d("EchoMessage").MessageTextSize.MEDIUM:return 2;case d("EchoMessage").MessageTextSize.LARGE:return 3;default:return void 0}}function t(a,b,c,e,f,g,i){var j=a.text;if(j==null){var k;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(k=i)!=null?k:""]).ERROR(h(),g);return null}k=u(a,b,c,e,f,g,i);if(f===d("MAWMsgType").MSG_TYPE.REVOKED){j!=null&&(k.msgContent={content:j});a.revokeSentTimestampMs!=null&&(k.originalTs=d("WATimeUtils").castToUnixTime(a.revokeSentTimestampMs));return babelHelpers["extends"]({},k,{revokedExternalId:d("WAStanzaUtils").toStanzaId("0"),type:d("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:a.revokeUnsentTimestampMS!=null?d("WATimeUtils").castToUnixTime(a.revokeUnsentTimestampMS):k.ts})}else if(f===d("MAWMsgType").MSG_TYPE.CIPHERTEXT)return babelHelpers["extends"]({},k,{msgContent:{content:j},specialTextSize:s(a.textSize),type:d("MAWMsgType").MSG_TYPE.CIPHERTEXT});else{b=babelHelpers["extends"]({},k,{msgContent:{content:j},specialTextSize:s(a.textSize),type:d("MAWMsgType").MSG_TYPE.TEXT});return babelHelpers["extends"]({},b,{editCount:Math.max(a.editHistory.length-1,0),groupId:a.groupId,groupIndex:a.groupIndex,groupSize:a.groupSize})}}function u(a,b,c,e,f,g,h){h=v(e,c);e={ack:h===d("WAJids").AUTHOR_ME?d("MAWAckLevel").ACK.sent:d("MAWAckLevel").ACK.received,altIndex:void 0,author:h,externalId:g,groupId:a.groupId,groupIndex:a.groupIndex,groupSize:a.groupSize,isForwarded:a.isForwarded,sortOrderMs:a.sortOrderMs,threadJid:b,ts:d("WATimeUtils").castToUnixTime(a.displayTimestampMs/1e3),type:f};a.authoritativeTimestampMs!=null?e.serverTs=d("WATimeUtils").castToUnixTime(a.authoritativeTimestampMs/1e3):e.serverTs=d("WATimeUtils").castToUnixTime(a.sortOrderMs/1e3);if(a.quoteData!=null){h=d("MAWRepliesRestoreUtils").getQuoteDataFromEchoMessage(a,c);h!=null&&(e.quote=h,e.quoteExternalId=h.content.externalId)}return e}function v(a,b){a=d("MAWJids").toUserJid(a.localKey);return a===b?d("WAJids").AUTHOR_ME:a}function w(a,b,c,e,f,g){a=u(a,b,c,e,f,g);return babelHelpers["extends"]({},a,{type:d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE})}g.MAWRestoreType=c;g.getDbMsgTypeFromEchoMessage=m;g.getUnstoredDbMessageFromEchoMessage=a;g.resolveAuthorFromEchoAddress=v}),98);
__d("MAWRepliesRestoreUtils",["EchoEncodingUtils","FBLogger","MAWBridgeMsg","MAWDexieTable","MAWGetMsgQuoteTxn","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","MAWTransactionMode","MAWUpdateQuotedMsgTxns","WALogger","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Quote data is missing for message: ",""]);h=function(){return a};return a}function a(a,b){if(b==null||!d("MAWMsgType").isQuotedMsgType(b.type))return a;else{b={author:b.author,externalId:b.externalId,ts:b.ts,type:b.type};b={content:b,remoteJid:null};return babelHelpers["extends"]({},a,{quote:b})}}function b(a,b){if(a.quoteData!=null&&a.quoteData.quoteMessageId!=null&&a.quoteData.quoteMessageSender!=null){b={author:d("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(a.quoteData.quoteMessageSender,b),externalId:(b=a.quoteData)==null?void 0:b.quoteMessageId,ts:a.displayTimestampMs,type:c("gkx")("458")?(b=d("EchoEncodingUtils").convertXMessageContentTypeToDbMsgType(a.xContentType))!=null?b:d("MAWMsgType").MSG_TYPE.TEXT:d("MAWMsgType").MSG_TYPE.TEXT};return{content:b,remoteJid:null}}else d("WALogger").ERROR(h(),a.messageId);return null}f=d("MAWIndexedDb").makeMsgrTransactor({chunk:(e=d("MAWTransactionMode")).READONLY,media:e.READONLY,messages:e.READWRITE,threads:e.READWRITE,xma:e.READONLY},"updateQuoteDataForReplyMessages",function(a){return function(b,c){c==null?void 0:c.addPoint("replies_restore_start");b=b.restoredMsgsData;if(b){var e=b.existingMsgs;b=b.newlyAddedMsgs;b=b.concat(e);return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWUpdateQuotedMsgTxns").associateQuotedMessage(a,b.threadJid,b).then(function(a){var c=[];b.quoteExternalId!=null&&c.push(b);a!=null&&c.push.apply(c,a);return c})})).then(function(b){b=b.flat();return i(a,b)}).then(function(a){c==null?void 0:c.addPoint("replies_restore_end",{"int":{replies:a}});return a})}return d("MAWDexieTable").dexieResolve(0)}});function i(a,b){return d("MAWDexieTable").dexieAll(b.map(function(b){var e=j(b);if(b.threadJid!=null)return d("MAWGetMsgQuoteTxn").enhanceMsgWithQuoteInfo(a,e,b.threadJid).then(function(a){return babelHelpers["extends"]({},a,{msgId:b.msgId,originalTs:b.originalTs,rowId:b.rowId,threadJid:b.threadJid,unsendMsgContentDeleteTs:b.unsendMsgContentDeleteTs})});else c("FBLogger")("labyrinth_web","thread_id_absent").mustfix("Reply restore: threadId cannot be null for a restored msg")})).then(function(a){return a.filter(Boolean).filter(function(a){return a.quote!=null})}).then(function(b){return a.messages.bulkPut(b).then(function(c){return b.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,void 0,a,"EncryptedBackups")})})})}).then(function(a){return(a=b==null?void 0:b.length)!=null?a:0})})}function j(a){a.msgId;a.originalTs;a.rowId;a.threadJid;a.unsendMsgContentDeleteTs;a=babelHelpers.objectWithoutPropertiesLoose(a,["msgId","originalTs","rowId","threadJid","unsendMsgContentDeleteTs"]);return a}g.addQuoteDataToReplyMessage=a;g.getQuoteDataFromEchoMessage=b;g.updateQuoteDataForReplyMessages=f;g.enhanceAndPersistReplyMessagesWithQuoteData=i}),98);
__d("MAWHandleEchoReactionsRestore",["MAWAckLevel","MAWAuthor","MAWBulkWriteReactionsTxns","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWTransactionMode","Promise","WAJids","WALogger","WAStanzaUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction fields in backup data uneven in length"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reactToAuthor field is null"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction external id missing"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction string is not a single character"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions empty author"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions for system author"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] echo document is absent for a restored msg"]);o=function(){return a};return a}function a(a,c,d){d==null?void 0:d.addPoint("reactions_restore_start");var e=a.echoMsgMap,f=a.restoredMsgsData,g=0;if(f){a=f.existingMsgs;var i=f.newlyAddedMsgs;i=i.concat(a);var j=f.threadJid;a=i.filter(function(a){var b=e.get(a.externalId);return q(e,a)&&b!=null&&r(b)});if(a.length===0)return(h||(h=b("Promise"))).resolve();var k=a.flatMap(function(a){var b=e.get(a.externalId);a=u(f.threadJid,c,a.externalId,a.msgId,a.author,b);return a.map(function(a){return{chatJid:j,unstoredReaction:a}})});return k.length===0?(h||(h=b("Promise"))).resolve():p(k).then(function(a){g+=k.length,d==null?void 0:d.addPoint("reactions_restore_end",{"int":{reactions:g}})})}return(h||(h=b("Promise"))).resolve()}var p=d("MAWIndexedDb").makeMsgrTransactor({groupInfo:(c=d("MAWTransactionMode")).READWRITE,messages:c.READWRITE,reactions:c.READWRITE,threads:c.READWRITE},"restoreWriteReactionsToDb",function(a){return function(b){return d("MAWBulkWriteReactionsTxns").prepareReactionsData(a,b).then(function(b){return d("MAWBulkWriteReactionsTxns").bulkWriteReactions(a,b)})}});function q(a,b){a=a.get(b.externalId);if(a==null){d("WALogger").ERROR(o());return!1}if(d("WAJids").isAuthorSystem(b.author)){d("WALogger").ERROR(n());return!1}if(d("MAWAuthor").getAuthorUserJid(b.author)==null){d("WALogger").ERROR(m());return!1}return!0}function r(a){return a.reactions!=null&&a.reactions.length!==0&&a.reactionXOfflineThreadingIds!=null&&a.reactionXOfflineThreadingIds.length!==0&&a.reactionAuthoritativeTimestampMs!=null&&a.reactionAuthoritativeTimestampMs.length!==0}function s(a,b,c){if((a==null?void 0:a.length)===0){d("WALogger").ERROR(l());return!1}if(b==null){d("WALogger").ERROR(k());return!1}if(c==null){d("WALogger").ERROR(j());return!1}return!0}function t(a,b,c){return(a||[]).map(function(a,e){if(c==null||b==null||(c==null?void 0:c.length)<=e||(b==null?void 0:b.length)<=e){d("WALogger").WARN(i());return[]}return[a,b[e],c[e]]})}function u(a,b,c,e,f,g){var h=d("MAWAuthor").getAuthorUserJid(f);if(g==null||h==null)return[];var i=g.reactionAuthoritativeTimestampMs;i=i===void 0?[]:i;var j=g.reactionXOfflineThreadingIds;j=j===void 0?[]:j;g=g.reactions;return t(g,j,i).filter(function(a){var b=a[0];a=a[1];return a!=null&&s(b.displayName,a.displayName,d("MAWAuthor").getAuthorUserJid(f))}).map(function(f){var g=f[0],i=f[1];f=f[2];var j=g.displayName;g=d("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(g,b);g={ack:g===d("WAJids").AUTHOR_ME?d("MAWAckLevel").ACK.sent:d("MAWAckLevel").ACK.received,author:g,externalId:d("WAStanzaUtils").toStanzaId(i.displayName||""),groupingKey:j,reaction:j,reactToAuthor:h,reactToExternalId:c,senderTimestampMs:null,threadJid:a,ts:d("WATimeUtils").castToUnixTime(Number(f.displayName)/1e3)};return e!=null?babelHelpers["extends"]({},g,{reactToMsgId:e}):g})}g.writeEchoReactionsToReactionsStore=a;g.getReactionsForReactionStore=u}),98);
__d("WAMessageKey",["WAErr","WAGlobals","WAJids","WAStanzaUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a===d("WAJids").AUTHOR_ME||a==d("WAGlobals").getMyUserJid()}function a(a,b,e){if(e==null)throw c("WAErr")("messageKey is null");var f=e.id,g=e.remoteJid;if(f==null)throw c("WAErr")("messageKey.id is null");else if(g==null)throw c("WAErr")("messageKey.remoteJid is null");g=d("WAJids").interpretAndValidateJid(g);if(g.jidType==="unknown")throw c("WAErr")("messageKey.remoteJid is invalid");var i,j=d("WAJids").AUTHOR_ME;if(g.jidType==="group"){i=g.groupJid;if(h(b)&&e.fromMe===!0)j=d("WAJids").AUTHOR_ME;else if(e.fromMe==!0)j=b;else{var k=e.participant;if(k==null)throw c("WAErr")("key.participant is null");k=d("WAJids").interpretAndValidateJid(k);if(k.jidType==="msgrUser")j=k.userJid;else throw c("WAErr")("key.participant is invalid")}}else if(g.jidType==="msgrUser"||g.jidType==="msgrDevice"){k=d("WAJids").interpretAndValidateJid(a);if(k.jidType!=="msgrUser")throw c("WAErr")("expected user type jid.");i=k.userJid;h(b)?e.fromMe===!0?j=d("WAJids").AUTHOR_ME:j=k.userJid:e.fromMe===!0&&(j=k.userJid)}else throw c("WAErr")("Unsupported jidtype type");return{chat:i,author:h(j)?d("WAJids").AUTHOR_ME:j,externalId:d("WAStanzaUtils").toStanzaId(f)}}g.extractProtocolMessageId=a}),98);
__d("WAParseConsumerMessagePollCreation",["WAGlobals","WAHex","WAMsgType"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e){a={unstoredMsg:{type:d("WAMsgType").MSG_TYPE.FUTUREPROOF,msgContent:{protobuf:d("WAHex").bytesToBuffer(a),subtype:d("WAGlobals").getConfig().isUnsupportedMessagesRedesignEnabled()?"pollCreationMessage":null},id:b.id,ts:b.ts,sentTs:b.sentTs,serverTs:b.serverTs,ack:b.ack,reportingMeta:c},unstoredMedia:null,unstoredQuotedMedia:null};return!e||!d("WAGlobals").getConfig().isPollsFallbackExperienceEnabled()?a:a}g["default"]=a}),98);
__d("WAParseProtocolUtils",["WAGlobals","WALogger","WALongInt","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unsupported franking version ",""]);h=function(){return a};return a}function a(a,b){b=i(b,a.serverTs);a=b==null?void 0:b.expirationTs;var c=b==null?void 0:b.deleteTs;b=b==null?void 0:b.ephemeralSetting;return{expirationTs:a,deleteTs:c,ephemeralSetting:b}}function b(a,b){b=j(b);b!=null&&(a.reportingMeta=b);return b}function i(a,b){var c;c=a==null?void 0:(c=a.chatEphemeralSetting)==null?void 0:c.ephemeralExpiration;a=a==null?void 0:(a=a.chatEphemeralSetting)==null?void 0:a.ephemeralSettingTimestamp;if(c==null||a==null||c===0||!d("WAGlobals").getConfig().isEphemeralMessagesEnabled())return null;b=d("WATimeUtils").castToUnixTime(b+d("WAGlobals").getDependencies().ephemeralMaxDeletionWindowForUnseenMessage());var e=b,f=null;try{a=d("WALongInt").numberOrThrowIfTooLarge(a)/1e3;f=d("WATimeUtils").castToUnixTime(a)}catch(a){return null}return{expirationTs:b,deleteTs:e,ephemeralSetting:{expirationTs:c,updatedTs:f}}}function j(a){a=a==null?void 0:a.frankingVersion;a!=null&&a!==0&&d("WALogger").ERROR(h(),a);return{frankingKey:void 0,frankingTag:void 0,frankingVersion:a,reportingContent:void 0,reportingTag:void 0}}g.parseEphemerality=a;g.enhanceReportingMeta=b}),98);
__d("WAParseConsumerMessageProtocol",["WACommon.pb","WAConsumerApplication.pb","WAErr","WAGlobals","WAHex","WAJids","WALogger","WAMediaTransport.pb","WAMessageKey","WAMsgType","WAParseConsumerMessagePollCreation","WAParseMediaTransportProtocol","WAParseProtocolUtils","WAResultOrError","WAStanzaUtils","WATimeUtils","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["parseConsumerMessageProtocol error :",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["WAParseConsumerMessageProtocol - ephemeralSetting duration is invalid ",", jidType: ",""]);i=function(){return a};return a}var j=90*d("WATimeUtils").DAY_SECONDS;b=1;e=0;f=1;f=d("WAGlobals").getConfig().armadilloWebProcessFutureproof()?f+1:f;function a(a,b,e,f,g,k){var l;b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAConsumerApplication.pb").ConsumerApplicationSpec,b);l=(l=b.payload)==null?void 0:(l=l.applicationData)==null?void 0:(l=l.revoke)==null?void 0:(l=l.key)==null?void 0:l.id;if(l!=null)return{unstoredMsg:{type:d("WAMsgType").MSG_TYPE.REVOKED,id:e.id,ts:e.ts,sentTs:e.sentTs,serverTs:e.serverTs,ack:e.ack,reportingMeta:e.reportingMeta,revokedExternalId:d("WAStanzaUtils").toStanzaId(l),unsendMsgContentDeleteTs:null,msgContent:null,ebTimestampMs:k},unstoredMedia:null,unstoredQuotedMedia:null};var m=(g==null?void 0:g.isForwarded)||!1;l=d("WAParseProtocolUtils").parseEphemerality(e,g);var w=l.expirationTs,x=l.deleteTs,y=l.ephemeralSetting;if(y!=null&&(y.expirationTs<0||y.expirationTs>j)){k=d("WAJids").interpretAndValidateJid(a);l=k.jidType;k=y.expirationTs;d("WALogger").ERROR(i(),k,l)}var z=d("WAParseProtocolUtils").enhanceReportingMeta(e,g),A=(k=o(g))!=null?k:void 0,B=(l=b.payload)==null?void 0:l.content;if(!B)return{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null};var C=(k=b.metadata)==null?void 0:k.specialTextSize,D=t(B),E={contentTypeForLogging:D,unstoredMsg:{type:d("WAMsgType").MSG_TYPE.FUTUREPROOF,msgContent:{protobuf:d("WAHex").bytesToBuffer(f),subtype:null},id:e.id,ts:e.ts,sentTs:e.sentTs,serverTs:e.serverTs,ack:e.ack,reportingMeta:z},unstoredMedia:null,unstoredQuotedMedia:null};l=function(){try{switch(D){case"messageText":var b,i=B[D];if(i==null)throw c("WAErr")("consumerMessage has no messageText");b=((b=i.commands)==null?void 0:b.some(function(a){return a.commandType===d("WACommon.pb").COMMAND_COMMAND_TYPE.AI}))===!0;if(b)return babelHelpers["extends"]({},E,{unstoredMsg:babelHelpers["extends"]({},E.unstoredMsg,{msgContent:babelHelpers["extends"]({},E.unstoredMsg.msgContent,{subtype:d("WAGlobals").getConfig().isUnsupportedMessagesRedesignEnabled()?"metaAiMessage":null})})});if(i.text==null)throw c("WAErr")("consumerMessage has no messageText");return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.TEXT,msgContent:{content:i.text,mentionedJids:i.mentionedJid.map(d("WAJids").validateUserJid).filter(Boolean)},quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m},e,{specialTextSize:C}),unstoredMedia:null,unstoredQuotedMedia:null};case"reactionMessage":return{unstoredMsg:n(a,e,B[D]),unstoredMedia:null,unstoredQuotedMedia:null};case"imageMessage":b=p(B,e.ts);return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.IMAGE,quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m,mediaId:b.plaintextHash},e),unstoredMedia:b,unstoredQuotedMedia:null};case"videoMessage":var j,k;i=B[D];if(i==null)throw c("WAErr")("consumerMessage has no videoMessage");b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").VideoTransportSpec,i==null?void 0:(b=i.video)==null?void 0:b.payload);j=b==null?void 0:(j=b.integral)==null?void 0:(j=j.transport)==null?void 0:(j=j.ancillary)==null?void 0:j.mimetype;k=(b==null?void 0:(k=b.ancillary)==null?void 0:k.gifPlayback)===!0&&j==="image/gif";if(k&&!d("WAGlobals").getConfig().isGifEnabled())return E;j=d("WAParseMediaTransportProtocol").parseVideoMsg(b,e.ts,k);if(j==null)throw c("WAErr")("consumerMessage has no video media info");if(v(g)&&((b=i.caption)==null?void 0:b.text)!=null){return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.TEXT,msgContent:{content:(b=i.caption)==null?void 0:b.text,mentionedJids:i.caption.mentionedJid.map(d("WAJids").validateUserJid).filter(Boolean)},quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m},e,{specialTextSize:C}),unstoredMedia:null,unstoredQuotedMedia:null}}return{unstoredMsg:k?babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.GIF},e,{quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m,reportingMeta:z,mediaId:j.plaintextHash}):babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.VIDEO},e,{quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m,mediaId:j.plaintextHash}),unstoredMedia:j,unstoredQuotedMedia:null};case"audioMessage":b=q(B,e.ts);return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.PTT,quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m,mediaId:b.plaintextHash},e),unstoredMedia:b,unstoredQuotedMedia:null};case"stickerMessage":if(d("WAGlobals").getConfig().isStickerEnabled()){i=r(B);k=d("WAParseMediaTransportProtocol").parseStickerMsg(i,e.ts);j=((j=i.integral)==null?void 0:j.receiverFetchId)!=null||((b=i.ancillary)==null?void 0:b.receiverFetchId)!=null;b=d("WAGlobals").getConfig().isStickerReceiverFetchEnabled();if(k!=null&&j&&(d("WAGlobals").getConfig().isStickerReceiverFetchDualSendEnabled()&&b)){var l=d("WAParseMediaTransportProtocol").parseStickerReceiverFetchInfo(i);if(l==null)throw c("WAErr")("consumerMessage has no sticker receiver fetch info");return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.RECEIVER_FETCH,quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m,reportingMeta:z},e),unstoredMedia:null,unstoredQuotedMedia:null,unstoredReceiverFetchInfo:l}}if(k==null){if(j){if(b){l=d("WAParseMediaTransportProtocol").parseStickerReceiverFetchInfo(i);if(l==null)throw c("WAErr")("consumerMessage has no sticker receiver fetch info");return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.RECEIVER_FETCH,quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m,reportingMeta:z},e),unstoredMedia:null,unstoredQuotedMedia:null,unstoredReceiverFetchInfo:l}}return babelHelpers["extends"]({},E,{unstoredMsg:babelHelpers["extends"]({},E.unstoredMsg,{msgContent:babelHelpers["extends"]({},E.unstoredMsg.msgContent,{subtype:"stickerReceiverFetchMessage"})})})}throw c("WAErr")("consumerMessage has no sticker media info")}return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.STICKER,quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m,reportingMeta:z,mediaId:k.plaintextHash},e),unstoredMedia:k,unstoredQuotedMedia:null}}return E;case"documentMessage":if(d("WAGlobals").getConfig().isDocumentReceiveEnabled()){j=s(B,e.ts);return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.DOCUMENT_FILE,quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m,reportingMeta:z,mediaId:j.plaintextHash},e),unstoredMedia:j,unstoredQuotedMedia:null}}return E;case"groupInviteMessage":return{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null,unstoredIncomingGroupInvite:u(e,B)};case"editMessage":b=B[D];i=b==null?void 0:b.message;l=i==null?void 0:i.text;j=b==null?void 0:(k=b.key)==null?void 0:k.id;if(b==null||i==null||l==null)throw c("WAErr")("consumerMessage with editMessage type has no editMessage");if(j==null)throw c("WAErr")("consumerMessage with editMessage type has no original Msg External Id.");k=d("WAStanzaUtils").toStanzaId(j);return{unstoredEditMsg:{type:d("WAMsgType").MSG_TYPE.EDIT_ACTION,editMsgContent:{content:l,mentionedJids:i.mentionedJid.map(d("WAJids").validateUserJid).filter(Boolean)},originalMsgExternalId:k,id:e.id,ts:e.ts,sentTs:e.sentTs,serverTs:e.serverTs,ack:e.ack,reportingMeta:z,specialTextSize:C},unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null};case"pollCreationMessage":return c("WAParseConsumerMessagePollCreation")(f,e,z,B[D]);case"pollUpdateMessage":return d("WAGlobals").getConfig().isUnsupportedMessagesRedesignEnabled()?{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null}:E;case"contactMessage":case"locationMessage":case"extendedTextMessage":case"statusTextMessage":case"contactsArrayMessage":case"liveLocationMessage":case"viewOnceMessage":default:return E}}catch(a){d("WALogger").ERROR(h(),a);return{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null}}}();return babelHelpers["extends"]({},l,{contentTypeForLogging:D})}function k(a){if(d("WAJids").isAuthorSystem(a))throw c("WAErr")("Got system author");return a}var l=30;function m(a){if(a==null)return d("WAResultOrError").makeResult(null);return a.length>l?d("WAResultOrError").makeError("invalid-reaction-text-length"):d("WAResultOrError").makeResult(a)}function n(a,b,e){if(e==null)throw c("WAErr")("consumerMessage has no reactionMessage");var f=k(b.id.author);a=d("WAMessageKey").extractProtocolMessageId(a,f,e.key);f=e.text;var g=e.groupingKey;e=e.senderTimestampMs;var h=m(f);if(!h.success){throw c("WAErr")('"'+((f=f)!=null?f:"")+'" is not a valid reaction ['+h.error+"]")}return{type:d("WAMsgType").MSG_TYPE.REACTION,ack:b.ack,id:b.id,reactToExternalId:a.externalId,reactToAuthor:a.author,reaction:h.value,groupingKey:g,ts:b.ts,senderTimestampMs:e}}function o(a){var b,e;b=a==null?void 0:(b=a.quotedMessage)==null?void 0:b.stanzaId;e=a==null?void 0:(e=a.quotedMessage)==null?void 0:e.participant;a=a==null?void 0:(a=a.quotedMessage)==null?void 0:a.remoteJid;e=e!=null?d("WAJids").interpretAndValidateJid(e):null;var f;(e==null?void 0:e.jidType)==="msgrUser"&&e.userJid===d("WAGlobals").getMyUserJid()?f=d("WAJids").AUTHOR_ME:(e==null?void 0:e.jidType)==="msgrUser"?f=e.userJid:f=d("WAJids").AUTHOR_ME;if(b==null)return null;e={type:d("WAMsgType").MSG_TYPE.UNAVAILABLE,author:f,externalId:d("WAStanzaUtils").toStanzaId(b),ts:null};if(a!=null){f=d("WAJids").interpretAndValidateJid(a);if(f.jidType==="group")return{remoteJid:f.groupJid,content:e};else throw c("WAErr")("not supported")}else return{remoteJid:null,content:e}}function p(a,b){a=a.imageMessage;if(a==null)throw c("WAErr")("consumerMessage has no imageMessage");return d("WAParseMediaTransportProtocol").decodeImageTransport(a==null?void 0:(a=a.image)==null?void 0:a.payload,b)}function q(a,b){var e;a=a.audioMessage;if(a==null)throw c("WAErr")("consumerMessage has no audioMessage");e=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").AudioTransportSpec,a==null?void 0:(e=a.audio)==null?void 0:e.payload);e=d("WAParseMediaTransportProtocol").parseAudioMsg(e,(a==null?void 0:a.ptt)||!1,b);if(e==null)throw c("WAErr")("consumerMessage has no audio media info");return e}function r(a){a=a.stickerMessage;if(a==null)throw c("WAErr")("consumerMessage has no stickerMessage");return d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").StickerTransportSpec,a==null?void 0:(a=a.sticker)==null?void 0:a.payload)}function s(a,b){var e;a=a.documentMessage;if(a==null)throw c("WAErr")("consumerMessage has no documentMessage");e=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").DocumentTransportSpec,a==null?void 0:(e=a.document)==null?void 0:e.payload);a=a==null?void 0:a.fileName;e=d("WAParseMediaTransportProtocol").parseDocumentMsg(e,a,b);if(e==null)throw c("WAErr")("consumerMessage has no document media info");return e}function t(a){var b=Object.keys(a).filter(function(a){return a!=="$$unknownFieldCount"});if(b.length!==1)throw c("WAErr")(JSON.stringify(a)+" consumerMessage payload content should have exactly one field, instead found "+JSON.stringify(b));return b[0]}function u(a,b){b=b.groupInviteMessage;if(b==null)throw c("WAErr")("consumerMessage has no GroupInvite Data");return babelHelpers["extends"]({ack:a.ack,author:a.id.author,externalId:a.id.externalId,ts:a.ts},b)}function v(a){if((a==null?void 0:a.readonlyMetadataDataclass)!=null)try{a=JSON.parse(a==null?void 0:a.readonlyMetadataDataclass);return(a==null?void 0:(a=a.power_up)==null?void 0:a.power_up_style)!=null}catch(a){throw c("WAErr")("Failed to parse readonly metadata dataclass JSON")}return!1}g.MINIMAL_MEDIA_DURATION=b;g.DEFAULT_FILE_SIZE=e;g.SUPPORTED_TYPES_VERSION=f;g.parseConsumerMessageProtocol=a;g.interpretAsNonSystemAuthor=k;g.validReactionMessageText=m;g.parseReactionMessage=n;g.parsedQuotedConsumerMessage=o;g.parseOneOfContentType=t}),98);
__d("WAMedia",[],(function(a,b,c,d,e,f){"use strict";a="Image";b="Video";c="Ptt";d="Gif";e="Sticker";var g="DocumentFile",h={IMAGE:a,VIDEO:b,PTT:c,GIF:d,STICKER:e,DOCUMENT_FILE:g};f.IMAGE=a;f.VIDEO=b;f.PTT=c;f.GIF=d;f.STICKER=e;f.DOCUMENT_FILE=g;f.MEDIA_TYPE=h}),66);
__d("WAParseMediaTransportProtocol",["WAConsumerApplication.pb","WAErr","WAHashUtils","WALogger","WALongInt","WAMedia","WAMediaTransport.pb","WAMediaUtils","WAMsgMap","WAParseConsumerMessageProtocol","WAProgressiveJpegGetScanLengths","WATimeUtils","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["downloadableThumbnail is missing some required fields"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["cannot compose mediaEntry with the media message"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["parseMediaKey error :",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["cannot compose mediaEntry with the media message"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["protobuf msg with no plaintext hash"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["There is unknown fileds in integral of VideoTransport"]);m=function(){return a};return a}function n(a,b,c,e){var f,g,h;if(!((f=a.integral)==null?void 0:f.transport))return null;f=(f=a.integral)==null?void 0:f.transport;if(d("decodeProtobuf").getUnknownFields(f.integral)!=null){d("WALogger").ERROR(m());return null}g=(g=f.integral)==null?void 0:g.fileSha256;if(!g){c||d("WALogger").ERROR(l());return null}c=null;if(((h=a.ancillary)==null?void 0:h.scansSidecar)!=null&&((h=a.ancillary)==null?void 0:h.scanLengths)!=null){c={sidecar:(h=a.ancillary)==null?void 0:h.scansSidecar,scanLengths:(h=a.ancillary)==null?void 0:(a=h.scanLengths)==null?void 0:a.map(d("WAProgressiveJpegGetScanLengths").asProgressiveJpegScanLength)}}if(((h=f.integral)==null?void 0:h.fileSha256)==null||((a=f.integral)==null?void 0:a.fileEncSha256)==null||((h=f.integral)==null?void 0:h.mediaKey)==null||((a=f.integral)==null?void 0:a.directPath)==null||((h=f.integral)==null?void 0:h.mediaKeyTimestamp)==null||((a=f.ancillary)==null?void 0:a.objectId)==null){d("WALogger").ERROR(k());return null}a=(h=f.ancillary)==null?void 0:h.fileLength;h=(h=f.ancillary.thumbnail)==null?void 0:h.downloadableThumbnail;f=d("WAMediaUtils").rawDataToMediaEntry({fileSha256:f.integral.fileSha256,fileEncSha256:f.integral.fileEncSha256,mediaKey:f.integral.mediaKey,directPath:f.integral.directPath,mediaKeyTimestamp:d("WATimeUtils").castLongIntToUnixTime(f.integral.mediaKeyTimestamp),serverMediaType:b,objectId:(b=f.ancillary)==null?void 0:b.objectId,fbid:void 0,downloadableThumbnail:{directPath:h==null?void 0:h.directPath,fileEncSha256:h==null?void 0:h.fileEncSha256,fileSha256:h==null?void 0:h.fileSha256,mediaKey:h==null?void 0:h.mediaKey,mediaKeyTimestamp:(h==null?void 0:h.mediaKeyTimestamp)==null?null:d("WATimeUtils").castLongIntToUnixTime(h==null?void 0:h.mediaKeyTimestamp),objectId:h==null?void 0:h.objectId},filename:e,progressiveJpegDetails:c,size:a==null?a:d("WALongInt").numberOrThrowIfTooLarge(a)});return{size:a==null?d("WAParseConsumerMessageProtocol").DEFAULT_FILE_SIZE:d("WALongInt").numberOrThrowIfTooLarge(a),plaintextHash:d("WAHashUtils").toPlaintextHash(new Uint8Array(g)),mediaEntry:f}}function o(a,b){var c,e=n(a,"image",!1);if(!e)return null;e=r(e,b);b=(b=a.ancillary)==null?void 0:b.width;c=(c=a.ancillary)==null?void 0:c.height;a.ancillary!=null&&(a.ancillary.width!=null&&a.ancillary.width===4294967295&&(b=void 0),a.ancillary.height!=null&&a.ancillary.height===4294967295&&(c=void 0));c=babelHelpers["extends"]({},e,{mediaType:d("WAMedia").MEDIA_TYPE.IMAGE,validatedVideoInfo:null,validatedImageInfo:{width:b,height:c,jpegThumbnail:(e=a.integral)==null?void 0:(b=e.transport)==null?void 0:(c=b.ancillary)==null?void 0:(e=c.thumbnail)==null?void 0:e.jpegThumbnail,jpegThumbnailHeight:(b=a.integral)==null?void 0:(c=b.transport)==null?void 0:(e=c.ancillary)==null?void 0:(b=e.thumbnail)==null?void 0:b.thumbnailHeight,jpegThumbnailWidth:(c=a.integral)==null?void 0:(e=c.transport)==null?void 0:(b=e.ancillary)==null?void 0:(a=b.thumbnail)==null?void 0:a.thumbnailWidth},validatedAudioInfo:null,validatedDocumentFileInfo:null});return c}function a(a,b){a=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").ImageTransportSpec,a);a=o(a,b);if(a==null)throw c("WAErr")("consumerMessage has no image media info");return a}function b(a,b,c){var e;if(!((e=a.integral)==null?void 0:e.transport))return null;e=n(a,c?"gif":"video",!1);if(!e)return null;e=r(e,b);e=babelHelpers["extends"]({},e,{mediaType:c?d("WAMedia").MEDIA_TYPE.GIF:d("WAMedia").MEDIA_TYPE.VIDEO,validatedVideoInfo:c?null:{duration:(a==null?void 0:(b=a.ancillary)==null?void 0:b.seconds)!=null&&(a==null?void 0:(e=a.ancillary)==null?void 0:e.seconds)>d("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION?a==null?void 0:(b=a.ancillary)==null?void 0:b.seconds:d("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION,width:a==null?void 0:(e=a.ancillary)==null?void 0:e.width,height:a==null?void 0:(b=a.ancillary)==null?void 0:b.height,mimetype:a==null?void 0:(e=a.integral)==null?void 0:(b=e.transport)==null?void 0:(e=b.ancillary)==null?void 0:e.mimetype,jpegThumbnail:(b=a.integral)==null?void 0:(e=b.transport)==null?void 0:(b=e.ancillary)==null?void 0:(e=b.thumbnail)==null?void 0:e.jpegThumbnail,jpegThumbnailHeight:(b=a.integral)==null?void 0:(e=b.transport)==null?void 0:(b=e.ancillary)==null?void 0:(e=b.thumbnail)==null?void 0:e.thumbnailHeight,jpegThumbnailWidth:(b=a.integral)==null?void 0:(e=b.transport)==null?void 0:(b=e.ancillary)==null?void 0:(e=b.thumbnail)==null?void 0:e.thumbnailWidth},validatedImageInfo:c?{width:(b=a.ancillary)==null?void 0:b.width,height:(e=a.ancillary)==null?void 0:e.height,jpegThumbnail:(c=a.integral)==null?void 0:(b=c.transport)==null?void 0:(e=b.ancillary)==null?void 0:(c=e.thumbnail)==null?void 0:c.jpegThumbnail,jpegThumbnailHeight:(b=a.integral)==null?void 0:(e=b.transport)==null?void 0:(c=e.ancillary)==null?void 0:(b=c.thumbnail)==null?void 0:b.thumbnailHeight,jpegThumbnailWidth:(e=a.integral)==null?void 0:(c=e.transport)==null?void 0:(b=c.ancillary)==null?void 0:(a=b.thumbnail)==null?void 0:a.thumbnailWidth}:null,validatedAudioInfo:null,validatedDocumentFileInfo:null});return e}function e(a,b,c){if(!((b=a.integral)==null?void 0:b.transport))return null;b=n(a,"ptt",!1);if(!b)return null;b=r(b,c);b=babelHelpers["extends"]({},b,{mediaType:d("WAMedia").MEDIA_TYPE.PTT,validatedVideoInfo:null,validatedImageInfo:null,validatedDocumentFileInfo:null,validatedAudioInfo:{duration:(a==null?void 0:(c=a.ancillary)==null?void 0:c.seconds)!=null&&(a==null?void 0:(b=a.ancillary)==null?void 0:b.seconds)>d("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION?a==null?void 0:(c=a.ancillary)==null?void 0:c.seconds:d("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION,mimetype:a==null?void 0:(b=a.integral)==null?void 0:(c=b.transport)==null?void 0:(a=c.ancillary)==null?void 0:a.mimetype,played:!1}});return b}function f(a,b){var c;if(!((c=a.integral)==null?void 0:c.transport))return null;c=((c=a.integral)==null?void 0:c.receiverFetchId)!=null;c=n(a,"sticker",c);if(!c)return null;c=r(c,b);c=babelHelpers["extends"]({},c,{mediaType:d("WAMedia").MEDIA_TYPE.STICKER,validatedVideoInfo:null,validatedImageInfo:{width:(b=a.ancillary)==null?void 0:b.width,height:(c=a.ancillary)==null?void 0:c.height,jpegThumbnail:(b=a.integral)==null?void 0:(c=b.transport)==null?void 0:(b=c.ancillary)==null?void 0:(c=b.thumbnail)==null?void 0:c.jpegThumbnail,jpegThumbnailHeight:(b=a.integral)==null?void 0:(c=b.transport)==null?void 0:(b=c.ancillary)==null?void 0:(c=b.thumbnail)==null?void 0:c.thumbnailHeight,jpegThumbnailWidth:(b=a.integral)==null?void 0:(c=b.transport)==null?void 0:(a=c.ancillary)==null?void 0:(b=a.thumbnail)==null?void 0:b.thumbnailWidth},validatedAudioInfo:null,validatedDocumentFileInfo:null});return c}function p(a){var b,c,d;if(!((b=a.integral)==null?void 0:b.transport))return null;b=(b=a.ancillary)==null?void 0:b.width;c=(c=a.ancillary)==null?void 0:c.height;d=(d=(d=a.integral)==null?void 0:d.receiverFetchId)!=null?d:(d=a.ancillary)==null?void 0:d.receiverFetchId;a=a==null?void 0:(a=a.integral)==null?void 0:(a=a.transport)==null?void 0:(a=a.ancillary)==null?void 0:a.mimetype;if(b==null||c==null||d==null||a==null)return null;d={receiverFetchId:d,previewWidth:b,previewHeight:c,mimetype:a,type:"sticker"};return d}function q(a,b,c){var e;if(!((e=a.integral)==null?void 0:e.transport))return null;e=n(a,"document",!1,b);if(!e)return null;e=r(e,c);return babelHelpers["extends"]({},e,{mediaType:d("WAMedia").MEDIA_TYPE.DOCUMENT_FILE,validatedVideoInfo:null,validatedImageInfo:null,validatedAudioInfo:null,validatedDocumentFileInfo:{mimetype:a==null?void 0:(c=a.integral)==null?void 0:(e=c.transport)==null?void 0:(a=e.ancillary)==null?void 0:a.mimetype,filename:(c=b)!=null?c:void 0}})}function r(a,b){return{mediaEntry:a.mediaEntry,plaintextHash:a.plaintextHash,size:a.size,msgIds:[],mediaEntries:new(d("WAMsgMap").MsgMap)(),ts:b}}function s(a){a=a.msg;if(a.subprotocolType!=="consumerMessage")return[];a=d("decodeProtobuf").decodeProtobuf(d("WAConsumerApplication.pb").ConsumerApplicationSpec,a.subprotocol);if(a.payload==null||a.payload.content==null)return[];var b=a.payload.content;a=d("WAParseConsumerMessageProtocol").parseOneOfContentType(a.payload.content);try{switch(a){case"imageMessage":a=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").ImageTransportSpec,(a=b.imageMessage)==null?void 0:(a=a.image)==null?void 0:a.payload);return t(a,"image");case"videoMessage":a=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").VideoTransportSpec,(a=b.videoMessage)==null?void 0:(a=a.video)==null?void 0:a.payload);return t(a,"video");case"audioMessage":a=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").AudioTransportSpec,(a=b.audioMessage)==null?void 0:(a=a.audio)==null?void 0:a.payload);return t(a,"ptt");case"stickerMessage":a=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").StickerTransportSpec,(a=b.stickerMessage)==null?void 0:(a=a.sticker)==null?void 0:a.payload);return t(a,"sticker");case"documentMessage":a=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").DocumentTransportSpec,(a=b.documentMessage)==null?void 0:(b=a.document)==null?void 0:b.payload);return t(a,"document");case"groupInviteMessage":case"editMessage":case"pollCreationMessage":case"pollUpdateMessage":case"messageText":case"reactionMessage":case"contactMessage":case"locationMessage":case"extendedTextMessage":case"statusTextMessage":case"contactsArrayMessage":case"liveLocationMessage":case"viewOnceMessage":default:return[]}}catch(a){d("WALogger").ERROR(j(),a);return[]}}function t(a,b){var c,e;if(!((c=a.integral)==null?void 0:c.transport))return[];c=(c=a.integral)==null?void 0:c.transport;if(c.integral==null||((e=c.integral)==null?void 0:e.fileSha256)==null||((e=c.integral)==null?void 0:e.fileEncSha256)==null||((e=c.integral)==null?void 0:e.mediaKey)==null||((e=c.integral)==null?void 0:e.directPath)==null||((e=c.integral)==null?void 0:e.mediaKeyTimestamp)==null||((e=c.ancillary)==null?void 0:e.objectId)==null){d("WALogger").ERROR(i());return[]}e=c.integral;var f=e.fileSha256,g=e.fileEncSha256,j=e.mediaKey,k=e.directPath;e=e.mediaKeyTimestamp;b={directPath:k,plaintextHash:d("WAHashUtils").toPlaintextHash(f),ciphertextHash:d("WAHashUtils").toCiphertextHash(g),fbid:void 0,fileEncSha256:g,fileSha256:f,mediaKey:j,mediaKeyTimestamp:d("WATimeUtils").castLongIntToUnixTime(e),objectId:(k=c.ancillary)==null?void 0:k.objectId,serverMediaType:b,sidecar:((g=a.ancillary)==null?void 0:g.scansSidecar)||((f=a.ancillary)==null?void 0:f.sidecar),size:d("WALongInt").maybeNumberOrThrowIfTooLarge((j=c.ancillary)==null?void 0:j.fileLength),scanLengths:(e=a.ancillary)==null?void 0:(k=e.scanLengths)==null?void 0:k.map(d("WAProgressiveJpegGetScanLengths").asProgressiveJpegScanLength),uploadToken:void 0};j=(g=c.ancillary)==null?void 0:(f=g.thumbnail)==null?void 0:f.downloadableThumbnail;a=null;if(j!=null&&(j==null?void 0:j.fileSha256)!=null&&(j==null?void 0:j.fileEncSha256)!=null&&(j==null?void 0:j.mediaKey)!=null&&(j==null?void 0:j.directPath)!=null&&(j==null?void 0:j.mediaKeyTimestamp)!=null&&(j==null?void 0:j.objectId)!=null){e=j.fileSha256;k=j.fileEncSha256;c=j.mediaKey;g=j.directPath;f=j.mediaKeyTimestamp;var l=j.objectId;a={ciphertextHash:d("WAHashUtils").toCiphertextHash(k),directPath:g,fileEncSha256:k,fileSha256:e,mediaKey:c,mediaKeyTimestamp:d("WATimeUtils").castLongIntToUnixTime(f),objectId:l,plaintextHash:d("WAHashUtils").toPlaintextHash(e),scanLengths:void 0,serverMediaType:"preview",sidecar:void 0,uploadToken:void 0,size:void 0}}else j!=null&&d("WALogger").ERROR(h());return[b,a].filter(Boolean)}g.getMediaMeta=n;g.parseImageMsg=o;g.decodeImageTransport=a;g.parseVideoMsg=b;g.parseAudioMsg=e;g.parseStickerMsg=f;g.parseStickerReceiverFetchInfo=p;g.parseDocumentMsg=q;g.parseMediaKey=s}),98);
__d("MAWParseBumpExistingMessageMsg",["WAMessageKey","WAParseConsumerMessageProtocol","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.chat,e=a.content;a=a.meta;e=e.bumpExistingMessage;if(e==null)throw c("err")("bumpExistingMessage has no content");e=e.key;if(e==null)throw c("err")("bumpExistingMessage has no message key");var f=d("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(a.id.author);f=d("WAMessageKey").extractProtocolMessageId(b,f,e);e=f.author;f=f.externalId;e={ack:a.ack,id:{author:a.id.author,chat:a.id.chat,externalId:a.id.externalId},quote:{content:{author:e,externalId:f,ts:null,type:"Unavailable"},remoteJid:b},reportingMeta:a.reportingMeta,sentTs:a.sentTs,serverTs:a.serverTs,ts:a.serverTs,type:"BumpExistingMessage"};return{contentTypeForLogging:"bumpExistingMessage",unstoredMedia:null,unstoredMsg:e,unstoredQuotedMedia:null,unstoredXMA:null}}g["default"]=a}),98);
__d("MAWParseNoteReplyMsg",["MAWJids","MAWMsgType","WAGlobals","WAJids","WAMediaTransport.pb","WAMsgType","WAParseMediaTransportProtocol","WAParseProtocolUtils","decodeProtobuf","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b,e=a.content,f=a.meta;a=a.metadata;e=e.noteReplyMessage;if(e==null)throw c("err")("noteReplyMessage has no content");b=(b=e.noteText)==null?void 0:b.text;if(b==null)throw c("err")("noteReplyMessage has no note text");var g=d("MAWJids").toUserJid(f.id.author),h=d("MAWJids").toUserJid(f.id.chat);g=h===g?d("WAJids").AUTHOR_ME:h;h=d("WAParseProtocolUtils").parseEphemerality(f,a);a=h.deleteTs;var i=h.ephemeralSetting;h=h.expirationTs;a={ack:f.ack,deleteTs:a,ephemeralSetting:i,expirationTs:h,forwardingScore:f.forwardingScore,id:{author:f.id.author,chat:f.id.chat,externalId:f.id.externalId},quote:{content:{author:g,externalId:f.id.externalId,msgContent:{content:b},ts:f.serverTs,type:d("WAMsgType").NOTE_REPLY},remoteJid:f.id.chat},ts:f.serverTs};var j,k;h=(i=e.textContent)==null?void 0:i.text;g=e.stickerContent;b=e.videoContent;if(h!=null){i=babelHelpers["extends"]({msgContent:{content:h},type:d("MAWMsgType").MSG_TYPE.TEXT},a);e=i}else if(g!=null){h=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").StickerTransportSpec,g==null?void 0:g.payload);j=d("WAParseMediaTransportProtocol").parseStickerMsg(h,f.ts);if(j){i=babelHelpers["extends"]({mediaId:j.plaintextHash,type:d("MAWMsgType").MSG_TYPE.STICKER},a);e=i}else{if(((g=h.integral)==null?void 0:g.receiverFetchId)!=null)if(d("WAGlobals").getConfig().isStickerReceiverFetchEnabled()){k=d("WAParseMediaTransportProtocol").parseStickerReceiverFetchInfo(h);if(k==null)throw c("err")("consumerMessage has no sticker receiver fetch info");i=babelHelpers["extends"]({type:d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH},a);e=i}else throw c("err")("noteReplyMessage sticker receiver fetch is not enabled");else throw c("err")("noteReplyMessage sticker has no media")}}else if(b!=null){g=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").VideoTransportSpec,b==null?void 0:b.payload);h=g==null?void 0:(h=g.integral)==null?void 0:(i=h.transport)==null?void 0:(b=i.ancillary)==null?void 0:b.mimetype;b=(g==null?void 0:(i=g.ancillary)==null?void 0:i.gifPlayback)===!0&&h==="image/gif";j=d("WAParseMediaTransportProtocol").parseVideoMsg(g,f.ts,b);if(j&&b){i=babelHelpers["extends"]({mediaId:j.plaintextHash,type:d("MAWMsgType").MSG_TYPE.GIF},a);e=i}else if(!j)throw c("err")("noteReplyMessage video has no media");else throw c("err")("noteReplyMessage video is not a gif")}else throw c("err")("noteReplyMessage has no valid content");return{contentTypeForLogging:"noteReplyMessage",unstoredMedia:j,unstoredMsg:e,unstoredQuotedMedia:null,unstoredReceiverFetchInfo:k,unstoredXMA:null}}g["default"]=a}),98);
__d("MAWParseRavenActionNotificationMsg",["MAWConfig","MAWMsg","WAStanzaUtils","WATimeUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b,e,f=a.content;a=a.meta;if(!d("MAWConfig").getConfig().isRavenMessagesEnabled())return{unstoredMedia:null,unstoredMsg:null,unstoredQuotedMedia:null,unstoredXMA:null};b=(b=f.ravenActionNotifMessage)==null?void 0:b.actionType;b=d("MAWMsg").MAWRavenActionNotifType.cast(b);e=(e=f.ravenActionNotifMessage)==null?void 0:e.actionTimestamp;var g;if(e!=null){e=Number(e);e>d("WATimeUtils").MAX_INT?g=d("WATimeUtils").castMilliSecondsToUnixTime(e):g=d("WATimeUtils").castToUnixTime(e)}e=((e=f.ravenActionNotifMessage)==null?void 0:(e=e.key)==null?void 0:e.id)!=null?d("WAStanzaUtils").toStanzaId((e=f.ravenActionNotifMessage)==null?void 0:(f=e.key)==null?void 0:f.id):null;if(b==null)throw c("err")("Error when getting actionType for RavenNotificationMessage "+a.id.externalId);if(g==null)throw c("err")("Error when getting actionTimestamp for RavenNotificationMessage "+a.id.externalId);if(e==null)throw c("err")("Error when getting ravenActionToMsgExternalId for RavenNotificationMessage "+a.id.externalId);f={ack:a.ack,actionTimestamp:g,actionType:b,id:a.id,ravenActionToMsgExternalId:e,sentTs:a.sentTs,serverTs:a.serverTs,ts:a.serverTs,type:"RavenAction"};return{unstoredMedia:null,unstoredMsg:f,unstoredQuotedMedia:null,unstoredXMA:null}}g.parseRavenActionNotificationMessage=a}),98);
__d("MAWParseSubprotocolVersionConsts",[],(function(a,b,c,d,e,f){"use strict";a=2;b=2;c=1;d=2;e=1;var g=1;f.ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION=a;f.XMA_PREVIEW_SUBPROTOCOL_VERSION=b;f.XMA_FAVICON_SUBPROTOCOL_VERSION=c;f.XMA_HEADER_SUBPROTOCOL_VERSION=d;f.RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION=e;f.RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION=g}),66);
__d("MAWParseRavenMsg",["MAWConfig","MAWMsg","MAWMsgType","MAWParseSubprotocolVersionConsts","WALogger","WAMediaTransport.pb","WAParseMediaTransportProtocol","decodeProtobuf","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n        received video messsage version is older than expected ",". "]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n        received image messsage version is older than expected ",". "]);i=function(){return a};return a}function a(a){var b=a.content;a=a.meta;if(!d("MAWConfig").getConfig().isRavenMessagesEnabled())return{unstoredMedia:null,unstoredMsg:null,unstoredQuotedMedia:null,unstoredXMA:null};b=b.ravenMessageMsgr;if(b==null)throw c("err")("Raven message payload has no content");var e=d("MAWMsg").MAWRavenMsgEphemeralType.cast(b.ephemeralType);if(e==null)throw c("err")("Error when casting ephemeralType for Raven message");var f=void 0,g=void 0;if(b.imageMessage)(b.imageMessage.version==null||b.imageMessage.version<d("MAWParseSubprotocolVersionConsts").RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(i(),d("MAWParseSubprotocolVersionConsts").RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION),f=d("WAParseMediaTransportProtocol").decodeImageTransport(b.imageMessage.payload,a.ts),g=d("MAWMsg").MAWRavenMsgMediaType.IMAGE;else if(b.videoMessage){(b.videoMessage.version==null||b.videoMessage.version<d("MAWParseSubprotocolVersionConsts").RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(h(),d("MAWParseSubprotocolVersionConsts").RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION);b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").VideoTransportSpec,b.videoMessage.payload);f=d("WAParseMediaTransportProtocol").parseVideoMsg(b,a.ts,!1);g=d("MAWMsg").MAWRavenMsgMediaType.VIDEO}else throw c("err")("Error unsupported Raven message type");if(f==null)throw c("err")("Error Raven message has no associated image or video");b={ack:a.ack,id:a.id,mediaId:f.plaintextHash,ravenEphemeralMediaState:e===d("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT?d("MAWMsg").MAWRavenMsgEphemeralMediaState.PERMANENT:d("MAWMsg").MAWRavenMsgEphemeralMediaState.UNSEEN,ravenEphemeralType:e,ravenMediaType:g,reportingMeta:a.reportingMeta,sentTs:a.sentTs,serverTs:a.serverTs,ts:a.ts,type:d("MAWMsgType").MSG_TYPE.RAVEN};return{unstoredMedia:f,unstoredMsg:b,unstoredQuotedMedia:null,unstoredXMA:null}}g.parseRavenMessage=a}),98);
__d("WAAckLevel",[],(function(a,b,c,d,e,f){"use strict";a={SENDER_BACKFILL_SENT:-7,INACTIVE_RECEIVED:-6,CONTENT_UNUPLOADABLE:-5,CONTENT_TOO_BIG:-4,CONTENT_GONE:-3,EXPIRED:-2,FAILED:-1,CLOCK:0,SENT:1,RECEIVED:2,READ:3,PLAYED:4};f.ACK=a}),66);
__d("MAWParseScreenshotActionMsg",["MAWExternalId","MAWMsgType","WAAckLevel","WAArmadilloApplication.pb","WAJids","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.content;a=a.meta;b=b.screenshotAction;if(b==null)throw c("err")("screenshotAction has no content");b=b.screenshotType;if(b==null)throw c("err")("Missing screenshot type in payload");if(![d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE,d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING].includes(b))throw c("err")("Received unexpected screenshot action type");b={ack:d("WAAckLevel").ACK.SENT,id:{author:d("WAJids").AUTHOR_SYSTEM,chat:a.id.chat,externalId:d("MAWExternalId").generateExternalId()},msgContent:{adminMsgContent:[],adminType:"youEphemeralTakeScreenshot",screenshotActionType:b},ts:a.serverTs,type:d("MAWMsgType").EPHEMERAL_SCREENSHOT_ACTION};return{contentTypeForLogging:"screenshotAction",unstoredMedia:null,unstoredMsg:b,unstoredQuotedMedia:null,unstoredXMA:null}}g.parseEphemeralScreenshotActionProtocol=a}),98);
__d("MAWParseArmadilloProtocol",["MAWConfig","MAWMsgType","MAWParseBumpExistingMessageMsg","MAWParseNoteReplyMsg","MAWParseRavenActionNotificationMsg","MAWParseRavenMsg","MAWParseScreenshotActionMsg","MAWParseXMAProtocol","WAArmadilloApplication.pb","WAGlobals","WAHex","WALogger","decodeProtobuf","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWParseArmadilloProtocol - Dropping message. contentType: ",", reason: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWParseArmadilloProtocol - handling futureproof message for contentType: ",""]);i=function(){return a};return a}var j={unstoredMedia:null,unstoredMsg:null,unstoredQuotedMedia:null,unstoredXMA:null},k=new Map([["screenshotAction",d("MAWParseScreenshotActionMsg").parseEphemeralScreenshotActionProtocol],["extendedContentMessage",d("MAWParseXMAProtocol").parseXMAProtocol],["noteReplyMessage",c("MAWParseNoteReplyMsg")],["bumpExistingMessage",c("MAWParseBumpExistingMessageMsg")]]);function a(a,b,c,e,f,g){b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAArmadilloApplication.pb").ArmadilloSpec,b);b=(b=b.payload)==null?void 0:b.content;if(!b)return j;var n=m(b);d("MAWConfig").getConfig().isRavenMessagesEnabled()&&(k.set("ravenMessageMsgr",d("MAWParseRavenMsg").parseRavenMessage),k.set("ravenActionNotifMessage",d("MAWParseRavenActionNotificationMsg").parseRavenActionNotificationMessage));try{var o=k.get(n);if(o!=null)return o({chat:a,content:b,meta:c,metadata:g,protobuf:e},f);d("WALogger").LOG(i(),n);return{contentTypeForLogging:n,unstoredMedia:null,unstoredMsg:{ack:c.ack,id:c.id,msgContent:{protobuf:d("WAHex").bytesToBuffer(e),subtype:l(n)},reportingMeta:c.reportingMeta,sentTs:c.sentTs,serverTs:c.serverTs,ts:c.ts,type:d("MAWMsgType").MSG_TYPE.FUTUREPROOF},unstoredQuotedMedia:null,unstoredXMA:null}}catch(a){d("WALogger").ERROR(h(),n,a);return j}}function l(a){if(!d("WAGlobals").getConfig().isUnsupportedMessagesRedesignEnabled())return null;switch(a){case"bumpExistingMessage":return"bumpMessage";default:return null}}function m(a){var b=Object.keys(a).filter(function(a){return a!=="$$unknownFieldCount"});if(b.length!==1)throw c("err")(JSON.stringify(a)+" armadillo payload content should only have one field");a=b[0];return a}g.EMPTY_CONTENT=j;g.parseArmadilloProtocol=a}),98);
__d("WAParseMessageApplication",["decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b,c,e=a.payload;if(e==null)return{version:"v3",type:"error",error:"The messageApplication has no payload"};if(d("decodeProtobuf").getUnknownFields(a.payload)!=null)return{version:"v3",type:"error",error:"There are unknown fields in the message application payload"};e=e.subProtocol;if(e==null)return{version:"v3",type:"error",error:"The messageApplication payload has no subProtocol"};if(d("decodeProtobuf").getUnknownFields(e)!=null)return{version:"v3",type:"error",error:"messageApplication subProtocol has unknown fields",futureProof:e.futureProof};e=[];b=(b=a.payload)==null?void 0:(b=b.subProtocol)==null?void 0:b.consumerMessage;c=(c=a.payload)==null?void 0:(c=c.subProtocol)==null?void 0:c.armadillo;a=(a=a.payload)==null?void 0:(a=a.subProtocol)==null?void 0:a.multiDevice;if(b!=null){if(b.payload==null)return{version:"v3",type:"error",error:"subprotocol of type consumerMessage has no payload"};e.push({payload:new Uint8Array(b.payload),type:"success",subprotocolType:"consumerMessage"})}if(c!=null){if(c.payload==null)return{version:"v3",type:"error",error:"subprotocol of type armadillo has no payload"};e.push({payload:new Uint8Array(c.payload),type:"success",subprotocolType:"armadillo"})}if(a!=null){if(a.payload==null)return{version:"v3",type:"error",error:"subprotocol of type multiDevice has no payload"};e.push({payload:new Uint8Array(a.payload),type:"success",subprotocolType:"multiDevice"})}return e.length!==1?{version:"v3",type:"error",error:"Wrong number of subprotocols: "+e.length}:e[0]}g.parseMessageApplication=a}),98);
__d("MAWParseXMAProtocol",["ACTSanitizerApiTypes","MAWConfig","MAWMsgType","MAWODSProxy","MAWParseArmadilloProtocol","MAWParseSubprotocolVersionConsts","MAWParseXMAFBConfig","MAWXMALoggingUtils","WAArmadilloXMA.pb","WAHex","WALogger","WAMedia","WAMsgApplication.pb","WAOdsEnums","WAParseConsumerMessageProtocol","WAParseMediaTransportProtocol","WAParseMessageApplication","WAParseProtocolUtils","WAStanzaUtils","WATimeUtils","decodeProtobuf","err","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["S410301 The url contains RTL characters"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(['S410301 The url is invalid. It contains a colon separator, but not "://"']);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid message text during XMA restore"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid url prefix during XMA restore"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid native URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid action URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid action and native URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["ExternalId: "," textId: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n      received previews version is older than expected ",". "]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n    received favicon version is older than expected ",". "]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n    received headerImage version is older than expected ",". "]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n      received associatedMessage version is older than expected "," as expected. "]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["extendedContentMessage does not have valid XMA content, dropping message"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[XMA] received associated message with incorrect version ",""]);u=function(){return a};return a}var aa=new Set([d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY]);function v(a,b){return a==null||a.payload==null?void 0:d("WAParseMediaTransportProtocol").decodeImageTransport(a.payload,b)}function ba(a,b,e,f,g){if(b==null||b.payload==null)return null;b.version!==d("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION&&d("WALogger").ERROR(u(),b.version);b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMsgApplication.pb").MessageApplicationSpec,b.payload);b=d("WAParseMessageApplication").parseMessageApplication(b);if(b.type==="error")throw c("err")("XMA contains unparseable message application.");b=b;if(b.subprotocolType!=="consumerMessage")throw c("err")("XMA contains incorrect message application type: "+b.subprotocolType);return d("WAParseConsumerMessageProtocol").parseConsumerMessageProtocol(a,b.payload,e,f,g)}var w="https://www.instagram.com/stories/",x="https://www.instagram.com/reel/",y="https://www.instagram.com/tv/",z="https://www.instagram.com/_n/profile_shop?",A="https://www.instagram.com/",B="https://www.alpha.facebook.com/share/",C="https://m.facebook.com/share/",D="https://www.facebook.com/share/",E="https://m.alpha.facebook.com/share/",F="https://facebook.com/share/",G="https://www.alpha.facebook.com/stories/",H="https://www.facebook.com/stories/",I="https://fb.gg/",J="https://www.facebook.com/",K="https://m.facebook.com/",L="https://www.alpha.facebook.com/",M="https://m.alpha.facebook.com/",N="https://facebook.com/",O="https://fb.watch/",P="https://www.facebook.com/l.php",Q="https://m.facebook.com/l.php",R="https://www.alpha.facebook.com/l.php",S="https://m.alpha.facebook.com/l.php",ca="https://facebook.com/l.php",da="https://l.facebook.com/l.php",T="https://facebook.com/events/",ea="https://www.facebook.com/events/",fa="https://www.alpha.facebook.com/events/",ga="https://m.facebook.com/events/",ha="https://m.alpha.facebook.com/events/",U="fb-messenger://payments/receipt?product_id=",V="messenger://location_share",ia="http://m.me/",ja=":",W="http://",ka="https://";function a(a,b){var e=a.chat,f=a.content,g=a.meta,h=a.metadata;a=a.protobuf;f=f.extendedContentMessage;if(f==null)throw c("err")("extendedContentMessage has no content");var i=f.targetType;try{b=b(f);if(b===d("ACTSanitizerApiTypes").ACTSanitizerValidationResult.Valid)d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"xma_validation.valid"});else{d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"xma_validation.invalid"});d("WALogger").WARN(t());return d("MAWParseArmadilloProtocol").EMPTY_CONTENT}}catch(a){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"xma_validation.error"});throw c("err")("Unexpected error trying to validate XMA content: "+a.message)}if(i==null||!d("MAWParseXMAFBConfig").isFBSupportedTargetType(i))return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:{ack:g.ack,id:g.id,msgContent:{protobuf:d("WAHex").bytesToBuffer(a),subtype:ma(i)},reportingMeta:g.reportingMeta,sentTs:g.sentTs,serverTs:g.serverTs,ts:g.ts,type:d("MAWMsgType").MSG_TYPE.FUTUREPROOF},unstoredQuotedMedia:null,unstoredXMA:null,xmaTargetTypeForLogging:i};b=d("WAParseProtocolUtils").parseEphemerality(g,h);var j=b.deleteTs,k=b.ephemeralSetting;b=b.expirationTs;var l=d("WAParseProtocolUtils").enhanceReportingMeta(g,h),m=f.associatedMessage,n=f.contentRef,u=f.ctas,w=f.favicon,x=f.headerImage,y=f.headerTitle,z=f.maxSubtitleNumOfLines,A=f.maxTitleNumOfLines,B=f.messageText,C=f.overlayDescription,D=f.overlayIconGlyph,E=f.overlayTitle,F=f.previews,G=f.sentWithMessageId,H=f.subtitleText,I=f.targetId,J=f.targetUsername,K=f.titleText,L=f.xmaLayoutType;m!=null&&(m.version==null||m.version<d("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(s(),d("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION);x!=null&&(x.version==null||x.version<d("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(r(),d("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION);w!=null&&(w.version==null||w.version<d("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(q(),d("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION);F.every(function(a){(a.version==null||a.version<d("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(p(),d("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION)});f=f.targetExpiringAtSec!=null?d("WATimeUtils").castLongIntToUnixTime(f.targetExpiringAtSec):void 0;var M=m!=null&&G!=null?[d("WAStanzaUtils").toStanzaId(G),g.id.externalId]:[g.id.externalId,void 0],N=M[0];M=M[1];var O=[];if(F!=null)for(var P=0;P<F.length;P++){var Q,R=v(F[P],g.ts);R!=null&&!((i===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE||i===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE)&&R.mediaType===d("WAMedia").MEDIA_TYPE.IMAGE&&((Q=R.validatedImageInfo)==null?void 0:Q.height)===1&&((Q=R.validatedImageInfo)==null?void 0:Q.width)===1)&&O.push(R)}Q=v(x,g.ts);R=v(w,g.ts);F=(P=d("WAParseConsumerMessageProtocol").parsedQuotedConsumerMessage(h))!=null?P:void 0;x=babelHelpers["extends"]({deleteTs:j,ephemeralSetting:k,expirationTs:b,id:babelHelpers["extends"]({},g.id,{externalId:N}),quote:F,reportingMeta:l,type:d("MAWMsgType").MSG_TYPE.XMA},g);w=u.map(function(a){a.actionContentBlob;a=babelHelpers.objectWithoutPropertiesLoose(a,["actionContentBlob"]);return a});P=w.slice(1);i===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE&&u.length===1&&(P=w);b={author:g.id.author,contentRef:n,ctas:P,defaultCTA:w[0],externalId:N,faviconMediaId:(j=R==null?void 0:R.plaintextHash)!=null?j:void 0,headerMediaId:(k=Q==null?void 0:Q.plaintextHash)!=null?k:void 0,headerTitle:y,isTombstoned:f!=null?d("WATimeUtils").unixTime()>f:!1,maxSubtitleNumOfLines:z,maxTitleNumOfLines:A,overlayDescription:C,overlayIconGlyph:D,overlayTitle:E,previewMediaIds:O.length>0?O.map(function(a){return a.plaintextHash}):void 0,sentWithMessage:B,subtitleText:H,targetExpiringAtSec:f,targetId:I,targetType:i,targetUsername:J,threadJid:e,titleText:K,xmaLayoutType:L};var S;if(m!=null&&G==null)throw c("err")("XMA associatedMessage cannot be received without sentWithMessageId field");m!=null&&M!=null&&(S=ba(e,m,g,a,h));u=(l=(F=S)==null?void 0:F.unstoredMedia)!=null?l:null;n=d("MAWConfig").getConfig().isMediaAssociatedXMAsEnabled()===!0&&aa.has(i);if(u!=null&&!n){P=d("MAWXMALoggingUtils").getXmaTargetTypeStringFromEnum(i);d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"assoc_msg_media_"+((w=P)!=null?w:"unknown")});throw c("err")("XMA associated msg cannot have additioinal dbMedia")}y=(k=(j=S)==null?void 0:j.unstoredMsg)!=null?k:null;M!=null&&y!=null&&(d("WALogger").DEV(o(),N,M),y.id=babelHelpers["extends"]({},y.id,{externalId:M}),x.id=babelHelpers["extends"]({},y.id,{externalId:N}),b.externalId=N);if(n&&u!=null&&((y==null?void 0:y.type)==="Gif"||(y==null?void 0:y.type)==="Sticker"))return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:x,unstoredQuotedMedia:null,unstoredXMA:{unstoredAssociatedMedia:u!=null?u:void 0,unstoredAssociatedMsg:y!=null?y:void 0,unstoredFavicon:R,unstoredHeaderMedia:Q,unstoredPreviews:O.length>0?O:void 0,xma:b},xmaTargetTypeForLogging:i};if(y!=null&&y.type!=="Text")throw c("err")('XMA associated msg cannot have type different from "Text". Received type: '+y.type);return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:x,unstoredQuotedMedia:null,unstoredXMA:{unstoredAssociatedMedia:void 0,unstoredAssociatedMsg:y!=null?y:void 0,unstoredFavicon:R,unstoredHeaderMedia:Q,unstoredPreviews:O.length>0?O:void 0,xma:b},xmaTargetTypeForLogging:i}}function b(a){var b=a.ctas,d=a.targetType;if(d==null)throw c("err")("extendedContentMessage does not have a targetType");var e=!0;b.forEach(function(a){a.actionContentBlob;a=babelHelpers.objectWithoutPropertiesLoose(a,["actionContentBlob"]);e=e&&X(a,d)});return e}function la(a){var b=a.ebRestore,c=a.hasActionUrl,e=a.hasNativeUrl,f=a.isActionUrlValid,g=a.isNativeUrlValid;a=a.targetType;!g&&!f?d("WALogger").ERROR(n(),b!=null&&b?"[labyrinth_web]":"[S410301][transport]",a,e,c):g&&!f?d("WALogger").ERROR(m(),b!=null&&b?"[labyrinth_web]":"[S410301][transport]",a,e,c):f&&!g&&d("WALogger").ERROR(l(),b!=null&&b?"[labyrinth_web]":"[S410301][transport]",a,e,c)}function X(a,b,c){var d=a.nativeUrl;a=a.actionUrl;var e=Y(d,b,c),f=Y(a,b,c);la({ebRestore:c,hasActionUrl:a!=null,hasNativeUrl:d!=null,isActionUrlValid:f,isNativeUrlValid:e,targetType:b});return e&&f}function ma(a){if(!c("gkx")("1564"))return null;switch(a){case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2:return"locationMessage";case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_CONTACT:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_AI_CONTACT:return"contactShareMessage";case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION:return"storyMentionMessage";default:return null}}function Y(a,b,c){if(a==null)return!0;if(pa(a,b)===!1){c!=null&&c&&d("WALogger").ERROR(k());return!1}if(!qa(a)){c!=null&&c&&d("WALogger").ERROR(j());return!1}return!0}function Z(a){return a.startsWith(B)||a.startsWith(C)||a.startsWith(D)||a.startsWith(E)||a.startsWith(F)}function na(a){return a.startsWith(P)||a.startsWith(Q)||a.startsWith(R)||a.startsWith(S)||a.startsWith(ca)||a.startsWith(da)}function $(a){return a.startsWith(J)||a.startsWith(K)||a.startsWith(L)||a.startsWith(M)||a.startsWith(N)}function oa(a){return a.startsWith(T)||a.startsWith(ea)||a.startsWith(fa)||a.startsWith(ga)||a.startsWith(ha)}function pa(a,b){if(a==null)return!0;switch(b){case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_HIGHLIGHT_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_HIGHLIGHT_REACTION:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_MENTION:return a.startsWith(w);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE:return a.startsWith(x);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE:return a.startsWith(y);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE:return a.startsWith(z);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_IG_MEDIA_SHARE:return a.startsWith(A);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION:return a.startsWith(H)||a.startsWith(G)||Z(a);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE:return a.startsWith(I);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_PRIVATE_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_HIGHLIGHTS_TAB_FRIEND_UPDATES_REPLY:return($(a)||a.startsWith(O))&&!na(a);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2:return a.startsWith(V);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_HIGHLIGHTS_TAB_LOCAL_EVENT_REPLY:return oa(a);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT:return oa(a)||Z(a);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_CONTACT:return $(a)||a.startsWith(ia);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_EXTERNAL_LINK:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_AUDIO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_VIDEO_CALL:if(a.includes(ja)&&(!a.startsWith(W)&&!a.startsWith(ka))){b=a.indexOf("://");b===-1&&d("WALogger").ERROR(i());return!1}break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_RECEIVER_FETCH:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.DATACLASS_SENDER_COPY:return!0;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_P2P_PAYMENT:return a.startsWith(U)}return!0}function qa(a){for(var b=0;b<a.length;b++){var c=a.charAt(b);switch(c){case"\u202c":case"\u202d":case"\u202e":d("WALogger").ERROR(h());return!1;default:break}}return!0}g.kIGStoryCtaPrefix=w;g.kIGClipsCtaPrefix=x;g.kIGTVCtaPrefix=y;g.kIGShopCtaPrefix=z;g.kIGDefaultCtaPrefix=A;g.kFBStoryCtaPrefix=H;g.kFBGamingCustomUpdateCtaPrefix=I;g.kFBDefaultWWWCtaPrefix=J;g.kFBEventCtaPrefix=T;g.kMSGP2PPaymentUrlPrefix=U;g.kMessengerLocationSharePrefix=V;g.kHttpPrefix=W;g.parseXMAProtocol=a;g.isXMAContentValid=b;g.isValidCTA=X}),98);
__d("MAWHandleEchoXMARestoreV2",["EchoMessage","LSDataTraceCheckPoint","LSIntEnum","MAWBridge","MAWBridgeXMA","MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph","MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWDbMediaTxns","MAWDbMsg","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWODSProxy","MAWParseXMAProtocol","MAWTraceUtils","MAWTransactionMode","Promise","WAArmadilloXMA.pb","WAHashUtils","WALogger","WAMediaUtils","WAOdsEnums","WATimeUtils","asyncToGeneratorRuntime","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid CTA observed while restoring XMA. Echo message origin ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] threadJid field is not present in the restoredMsg. Echo message origin ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaLayoutType field is not present in the echo doc. Echo message origin ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaGatingType field is not present in the echo doc. Echo message origin ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaTargetType field is not present in the echo doc. Echo message origin ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaDefaultCTA field is not present in the echo doc. Echo message origin ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaData is missing in the echo doc. Echo message origin ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][getMediaForXMAByObjectIds] mediaEntry is null for media restore"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] msgContent is null for external link share XMA on Restore. Echo message origin ",""]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] dbXMA is null. EchoMessage origin ",""]);s=function(){return a};return a}a=function(a,e,f,g){f==null?void 0:f.addPoint("xma_restore_start");d("MAWTraceUtils").recordCheckpointForTrace(g,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_XMA_RESTORE_STARTED),[],!1);var j=a.restoredMsgsData;if(j){var k=j.newlyAddedMsgs;k=k.concat(j.existingMsgs);var l=[];k.map(function(b){var c=b.externalId;c=a.echoMsgMap.get(c);c!=null&&(c.contentType===d("EchoMessage").EchoMessageContentType.XMA&&l.push(b))});return l.length===0?(h||(h=b("Promise"))).resolve():t(l,a.echoMsgMap,e,g).then(function(a){f==null?void 0:f.addPoint("xma_restore_end",{"int":{xma:a.length}});d("MAWTraceUtils").recordCheckpointForTrace(g,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_XMA_RESTORE_ENDED),[],!1);return(h||(h=b("Promise"))).resolve()})}f==null?void 0:f.addPoint("xma_restore_end",{"int":{xma:0}});return(h||(h=b("Promise"))).resolve()};function t(a,e,f,g){var h=new Map(),j=new Map();a.forEach(function(a){var b,c=e.get(a.externalId);b=c==null?void 0:(b=c.mediaData)==null?void 0:b.attachmentObjectId;b!=null&&h.set(d("WAMediaUtils").stringToDeliveryObjectId(b),a);c=c==null?void 0:(b=c.mediaData)==null?void 0:b.plaintextHash;if(c!=null){b=d("WAHashUtils").stringToPlaintextHash(d("MAWHandleEchoMediaMsgsRestoreV2").getBase64WithoutPadding(c));c=j.get(b);j.set(b,c!=null?[].concat(c,[a.msgId]):[a.msgId])}});var k=Array.from(h.keys()),l=new Map();return u(k,j).then(function(j){var m=[];k.forEach(function(a){var b;b=(b=h.get(a))==null?void 0:b.externalId;b!=null&&l.set(b,a)});a.filter(function(a){return d("MAWDbMsg").isXMAMsg(a)}).forEach(function(a){var b=e.get(a.externalId);if(b){var f=l.get(a.externalId),h;if(f!=null){f=j.get(f);f!=null&&(h=f.mediaId)}f=b.serializationOrigin;f==null&&(f=d("EchoMessage").EchoSerializationOriginType.UNKNOWN);b=w(a,b,h,f);b==null?(d("WALogger").ERROR(s(),f),d("MAWTraceUtils").recordCheckpointForTrace(g,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_XMA_RESTORE_DBXMA_NULL),[],!1)):(b.targetType===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE&&a.msgContent==null&&(d("WALogger").WARN(r(),f),d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.EB_RESTORE,key:"missing_msg_content_external_link_xma"})),m.push(b))}});return v(m).then(function(a){if(a.length>0){a.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=l.get(a.externalId);if(f!=null){var e;b!=null&&(e=j.get(b));c("gkx")("821")?b=(yield d("MAWHandleXmaTransactionUtil").checkMediaChunkTransactionAndCreatedBridgeXma(e,a)):b=d("MAWBridgeXMA").createBridgeXMA(e,a,!1);d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewXMA",value:b}]})}});return function(b){return a.apply(this,arguments)}}());return a}return a})})}var u=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY,mediaBackup:d("MAWTransactionMode").READONLY},"restoreGetMediaForXMAByObjectIds",function(a){return function(b,e){if(c("gkx")("4663")){var f=Array.from(e.keys());return d("MAWDbMediaTxns").maybeBulkGetMediaFromPlaintextHash(a,f).then(function(a){var b=new Map();a.forEach(function(a){var c=e.get(a.plaintextHash);c==null?void 0:c.forEach(function(c){c=a==null?void 0:a.mediaEntries.get(c);if(a!=null&&c!=null){c=d("WAMediaUtils").decodeMediaEntryData(c);c.objectId!=null&&b.set(d("WAMediaUtils").stringToDeliveryObjectId(c.objectId),a)}else d("WALogger").ERROR(q())})});return b})}return d("MAWDbMediaTxns").maybeGetMediaBackupRowsFromObjectIds(a,b).then(function(b){var c=Array.from(b.values()).map(function(a){return a.mediaId});return a.media.bulkGet(c).then(function(a){var c=new Map();a!=null&&a.forEach(function(a){a!=null&&c.set(a.mediaId,a)});var d=new Map();b.forEach(function(a,b){a=c.get(a.mediaId);a!=null&&d.set(b,a)});return d})})}}),v=d("MAWIndexedDb").makeMsgrTransactor({xma:d("MAWTransactionMode").READWRITE},"restoreWriteXMAsToDb",function(a){return function(b){return a.xma.bulkAdd(b,{allKeys:!0}).then(function(a){return a.map(function(a,c){return babelHelpers["extends"]({},b[c],{xmaId:a})})})}});function w(a,b,c,e){var f;if(b.xmaData==null){d("WALogger").ERROR(p(),e);return null}var g;if(b.xmaData.xmaDefaultCTA!=null){var h;g=x((h=b.xmaData)==null?void 0:h.xmaDefaultCTA)}else d("WALogger").WARN(o(),e);if(((h=b.xmaData)==null?void 0:h.xmaTargetType)!=null)h=d("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(b.xmaData.xmaTargetType);else{d("WALogger").ERROR(n(),e);return null}var i;((f=b.xmaData)==null?void 0:f.xmaGatingType)!=null?i=d("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph").convertXMAGatingTypeToExtendedContentOverlayIconGlyph(b.xmaData.xmaGatingType):d("WALogger").WARN(m(),e);var q;((f=b.xmaData)==null?void 0:f.xmaLayoutType)!=null?q=d("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType").convertXMALayoutTypeToExtendedContentXMLLayoutType(b.xmaData.xmaLayoutType):d("WALogger").WARN(l(),e);if(a.threadJid!=null)f=a.threadJid;else{d("WALogger").ERROR(k(),e);return null}if(g!=null&&!d("MAWParseXMAProtocol").isValidCTA(g,h,!0)){d("WALogger").ERROR(j(),e);return null}var r;((e=b.xmaData)==null?void 0:e.xmaContentRef)!=null&&(r=b.xmaData.xmaContentRef);return{author:a.author,contentRef:r,ctas:[],defaultCTA:g,defaultPreviewMediaId:(e=c)!=null?e:void 0,externalId:a.externalId,headerTitle:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaHeaderTitle,isTombstoned:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaIsTombstoned,maxSubtitleNumOfLines:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaMaxSubtitleNumLines,maxTitleNumOfLines:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaMaxTitleNumLines,msgId:a.msgId,overlayIconGlyph:i,overlayTitle:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaHeaderSubtitle,previewMediaIds:c!=null?[c]:[],subtitleText:b==null?void 0:(a=b.xmaData)==null?void 0:a.xmaSubtitleText,targetExpiringAtSec:((e=b.xmaData)==null?void 0:e.xmaTargetExpiry)!=null?d("WATimeUtils").castToUnixTime(Number((c=b.xmaData)==null?void 0:c.xmaTargetExpiry)):void 0,targetId:b==null?void 0:(a=b.xmaData)==null?void 0:a.xmaTargetId,targetType:h,targetUsername:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaTargetUsername,threadJid:f,titleText:(c=b.xmaData)==null?void 0:c.xmaTitleText,xmaLayoutType:q}}function x(a){return{actionUrl:a,buttonType:d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_CTA_BUTTON_TYPE.OPEN_NATIVE,nativeUrl:a}}g.writeXMAToXMAStore=a;g.getMediaForXMAByObjectIds=u;g.writeXMAsToDb=v}),98);
__d("MAWHandlePointRestoredMsgV2",["EBUploadMessages","MAWEBUploadTrackingUtils","MAWEncryptedBackupCacheManager","MAWGetMsgQuoteTxn","Promise","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Completed handling of point restored message"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Completed handling of point restored message"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Started handling of point restored message"]);k=function(){return a};return a}function a(a){d("WALogger").LOG(k());a=a.restoredMsgsData;if(a){var c=a.existingMsgs;a=a.newlyAddedMsgs;a=a.concat(c);var e=[],f=new Map(),g=[],l=new Map();a.filter(function(a){return d("MAWEncryptedBackupCacheManager").checkForMsgEntryInReuploadCache(a.threadJid,a.externalId)}).forEach(function(a){e.push(a);g.push(a.externalId);var b=d("MAWEBUploadTrackingUtils").genInstanceKeyOnly();l.set(a.externalId,b);d("MAWEBUploadTrackingUtils").startUploadTracking(a.externalId,a.type,"pointrestore",b)});c=d("MAWGetMsgQuoteTxn").maybeBatchGetMsgsByQuoteExternalIdWithTransaction(g);return c.then(function(a){a.forEach(function(a){var b=a.quoteExternalId;b!=null&&f.set(b,a)});return e.length>0?d("EBUploadMessages").uploadUniqueMessage(e,f,void 0,void 0,l).then(function(a){e.forEach(function(a){d("MAWEncryptedBackupCacheManager").removeMsgEntryFromReuploadCache(a.threadJid,a.externalId)})}):(h||(h=b("Promise"))).resolve()}).then(function(a){d("WALogger").LOG(j())})}d("WALogger").LOG(i());return(h||(h=b("Promise"))).resolve()}g.uploadPointRestoredMessageIfRequired=a}),98);
__d("MAWRestoreMsgsUiUpdator",["MAWBridgeEventTransmitter","MAWDbMsg","MAWDbThread","MAWDexieTable","MAWFolderTypes","MAWThreadSnippetBuildTxns","gkx","qex"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f,g,j,l,m,n,o,p,q){g=h(a,g,c,e,f,l,m);return g.then(function(c){if(m==null||j){var e=k(c);e&&d("MAWBridgeEventTransmitter").updateThreadOutsideTxn(c.cannotReplyReason,d("MAWFolderTypes").FOLDER_ID.INBOX,c.chatId,c.jid);return i(a,b,c,n,o,p,m).then(function(){return c})}return c}).then(function(b){return d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,b,q)}).then(function(){})}function h(a,b,c,e,f,g,h){var i=babelHelpers["extends"]({},b,{lastReadMsg:g,lastReadMsgTs:f,newestMsg:c,newestMsgTs:e,oldestMsg:h,threadOrder:d("MAWDbThread").craftThreadOrder(e,b.jid)});return a.threads.put(i).then(function(){return i})}function i(a,b,e,f,g,h,i){var k=b.map(function(a){return a}).reverse(),l=e.chatId,m=e.jid;if(f!=null){f=d("MAWDbMsg").toMsgId(f);if(f!=null)return a.messages.get({msgId:f}).then(function(f){if(f!=null){f=f.sortOrderMs;var n;c("gkx")("23906")||c("qex")._("1016")?n=d("MAWDexieTable").dexieResolve(0):n=a.messages.where(["threadJid","sortOrderMs"]).between([m,k[0].sortOrderMs],[m,f],!1,!1).count();return n.then(function(a){a===0&&(j(k,g,e),d("MAWBridgeEventTransmitter").issueMsgLoadedEventAfterTxn(l,e.jid,k,i===null,h,!1));return{chatId:l,restoredMessages:b}})}return{chatId:l,restoredMessages:b}})}d("MAWBridgeEventTransmitter").issueMsgLoadedEventAfterTxn(l,e.jid,k,i===null,h,!1);return d("MAWDexieTable").dexieResolve({chatId:l,restoredMessages:b})}function j(a,b,c){var e=b==null?void 0:b.sortOrderMs,f=a[a.length-1],g=f.sortOrderMs;b!=null&&f!=null&&e!=null&&g!=null&&e<g&&(a.push(b),d("MAWBridgeEventTransmitter").deleteMessageRangesV2AfterTxn(b.msgId,d("MAWDbMsg").getSortOrderWithFallback(b),c.jid))}function k(a){return a.archived===!0&&a.cannotReplyReason!=="viewer_not_subscribed"}g.updateThreadAndMessages=a;g.shouldThreadBeUnarchived=k}),98);
__d("MAWRestoreMsgsTxns",["ArmadilloDataTraceType","FBLogger","LSMEBTaskCreationSource","MAWBridgeEventTransmitter","MAWBridgeTypesCreators","MAWDbMsg","MAWDbMsgTxns","MAWDexieTable","MAWFTSTxns","MAWIndexedDb","MAWLocalizationType","MAWMessageHasUniqueExternalIdValidator","MAWMsgType","MAWQplProxy","MAWRestoreMsgsUiUpdator","MAWTimeUtils","MAWTransactionMode","WAHashStringToNumber","WAJids","WALogger","WATimeUtils","gkx","qpl"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to create restored messages and update thread metadata ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Thread with jid "," does not exist for restore"]);i=function(){return a};return a}function j(a,b,c){return c!=null?a.messages.where(["threadJid","sortOrderMs"]).between([b.jid,c.ts],[b.jid,d("MAWDbMsg").MAX_MSG_SORT_ORDER],!1,!0).limit(1).first():d("MAWDexieTable").dexieResolve()}function a(a,b,c){return d("MAWDbMsgTxns").maybeGetMsg(a,c).then(function(c){if(c!=null)return a.messages.where(["threadJid","sortOrderMs"]).between([b.jid,c.sortOrderMs],[b.jid,d("MAWDbMsg").MAX_MSG_SORT_ORDER],!1,!0).limit(1).first();else return d("MAWDexieTable").dexieResolve()})}function k(a){return a!=null&&a.type===d("MAWMsgType").MSG_TYPE.ADMIN&&(a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION||a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_THREAD_ADMIN_MESSAGE||a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_IGD_THREAD_ADMIN_MESSAGE||a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.DUAL_THREAD_CUTOVER_ADMIN_MESSAGE)}var l=(e=d("MAWIndexedDb")).makeMsgrTransactor({messages:(f=d("MAWTransactionMode")).READONLY},"checkForDecryptionFailuresToPointRestore",function(a){return function(){return a.messages.filter(function(a){return a.type===d("MAWMsgType").MSG_TYPE.UNAVAILABLE||a.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT}).toArray().then(function(a){a.forEach(function(a){a.threadJid!=null&&d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(a.externalId,d("WAJids").threadIdForChatJid(a.threadJid),void 0,c("LSMEBTaskCreationSource").EB_POINT_QUERY_RETRY_DECRYPTION_FAILURES,a.threadJid)})})}});function m(a,b,c,e,f,g,h,i,j,k){var l=g.isOldestMsgUpdated,m=g.lastReadMsg,n=g.lastReadMsgTs,p=g.newestMsgId,q=g.newestMsgTs;g=g.oldestMsgId;var r=!0;b&&(r=o(p,q,e));b=d("MAWDexieTable").dexieResolve();r&&(f.length>0&&(b=d("MAWRestoreMsgsUiUpdator").updateThreadAndMessages(a,f,p,q,n,c,l,m,g,h,i,j,k)));return b.then(function(){return d("MAWDexieTable").dexieResolve()})}function b(a){var b=a.bumpMessageAuthorMap,e=a.existingMsgs,f=a.hasMoreBefore,g=a.instanceKey,h=a.isPointRestore,i=a.maybeNewestMsg,j=a.maybeOldestAdminMsg,k=a.maybeOldestMsg,l=a.minMsgId,m=a.newMsgs,n=a.optimisticMsgs,o=a.taskSource;a=a.thread;o=o===c("LSMEBTaskCreationSource").EB_POINT_QUERY_RETRY_DECRYPTION_FAILURES;var p=new Map(),q=[];e.map(function(a){a.type===d("MAWMsgType").MSG_TYPE.UNAVAILABLE||a.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?q.push(a):p.set(a.externalId,a)});var r=[];return w(m,e,a.jid,p,i,h,j,k,r,n,g,f,l,o,q,b).then(function(a){return a})}function n(a,b,c){a.altIndex!==d("MAWDbMsg").SPAM_ALT_INDEX&&a.altIndex!==d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX&&(d("MAWBridgeEventTransmitter").startTraceOutsideTxn(a,b,d("ArmadilloDataTraceType").armadilloMessageSend),d("MAWBridgeEventTransmitter").issueNewMsgUiEventOutsideTxn(a,c))}function o(a,b,e){if(c("gkx")("5871"))return b==null?!0:e.some(function(a){return a.sortOrderMs!=null&&a.sortOrderMs>=b});else{if(a==null)return!0;var f=!1;for(var g=0;g<e.length;g++){var h=e[g];d("MAWDbMsg").getInChatMsgIdFromMsgId(a)<=d("MAWDbMsg").getInChatMsgIdFromMsgId(h.msgId)&&(f=!0)}return f}}var p=e.makeMsgrTransactor({messages:f.READONLY},"getMsgsByProtocolMsgIds",function(a){return function(){for(var b=arguments.length,c=new Array(b),e=0;e<b;e++)c[e]=arguments[e];return d("MAWDbMsgTxns").getMsgsByProtocolMsgId.apply(void 0,[a].concat(c))}}),q=e.makeMsgrTransactor({messages:f.READONLY},"restoreGetMsg",function(a){return function(b){return d("MAWDbMsgTxns").maybeGetMsg(a,b)}}),r=e.makeMsgrTransactor({messages:f.READONLY},"restoreGetThreadNewestMessage",function(a){return function(b){return d("MAWDbMsgTxns").getThreadNewestMessageBySortOrder(a,b.jid)}}),s=e.makeMsgrTransactor({messages:f.READONLY},"restoreMaybeGetOldestNonAdminMessage",function(a){return function(b){return d("MAWDbMsgTxns").getThreadOldestMessageBySortOrder(a,b.jid).then(function(c){if(c==null)return d("MAWDexieTable").dexieResolve({maybeOldestAdminMsg:null,maybeOldestMsg:null});else if(k(c))return j(a,b,c).then(function(a){return{maybeOldestAdminMsg:c,maybeOldestMsg:a}});return{maybeOldestAdminMsg:null,maybeOldestMsg:c}})}});function t(a,b,c,e,f,g,h,i,j){return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,b.externalId,c.jid,b.author).then(function(a){if(a!=null)return;a=e.get(b.externalId);if(a==null){a=d("WATimeUtils").castUnixTimeToMillisTime(b.ts);i.newestMsgTs=a>i.newestMsgTs?a:i.newestMsgTs;var l=d("MAWDbMsg").craftMsgIdV2(c.chatId,i.msgNextInChatMsgId,b);i.msgNextInChatMsgId+=1;(i.oldestMsgId==null||!g&&a<i.oldestMsgTs)&&(i.isOldestMsgUpdated=!0,i.oldestMsgId=h!=null&&d("WATimeUtils").castUnixTimeToMillisTime(h.ts)<a?h.msgId:l,i.oldestMsgTs=h!=null&&d("WATimeUtils").castUnixTimeToMillisTime(h.ts)<a?d("WATimeUtils").castUnixTimeToMillisTime(h.ts):a);(i.newestMsgTs===a||k(f))&&(i.newestMsgId=l);b.author===d("WAJids").AUTHOR_ME&&(i.lastReadMsgTs==null||a>i.lastReadMsgTs)&&(i.lastReadMsg=l,i.lastReadMsgTs=a);a=babelHelpers["extends"]({},b,{msgId:l,sortOrderMs:d("MAWDbMsg").getSortOrderWithFallback(b)});j.push(a)}})})).then(function(){})}function u(a,b){return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").getThreadNewestMessageId(a,b.jid),d("MAWDbMsgTxns").getThreadNewestMessageTs(a,b),d("MAWDbMsgTxns").getNextMsgIdNumberForThread(a,b)]).then(function(a){var b=a[0],c=a[1];a=a[2];return{newestMsgId:b,newestMsgTs:c,nextInChatMsgId:a}})}function v(a,b,c,e,f,g,h,i,j,k){return t(a,b,c,e,f,g,h,i,j).then(function(b){if(k!=null)for(b=0;b<j.length;b++){var e=j[b],f=e.externalId;f=k.get(f);f!=null&&(e.ts=d("WATimeUtils").castMilliSecondsToUnixTime(f.ts))}d("MAWMessageHasUniqueExternalIdValidator").logMessageAddSource(j.map(function(a){return a.externalId}),"MAWRestoreMsgsTxns.js::createRestoredMessages isPointRestore: "+(g?1:0));return a.messages.bulkAdd(j,{allKeys:!0}).then(function(a){return a.map(function(a,b){return babelHelpers["extends"]({},j[b],{rowId:a})})}).then(function(b){return a.threads.put(c).then(function(){return b})})})}var w=e.makeMsgrTransactor({ftsBackloggedMessages:f.READWRITE,groupInfo:f.READWRITE,messages:f.READWRITE,threads:f.READWRITE},"createRestoredMessagesAndUpdateThread",function(a){return function(b,c,e,f,g,j,k,l,o,p,q,r,s,t,w,x){return a.threads.get({jid:e}).then(function(q){if(q==null){d("WALogger").ERROR(i(),e);return d("MAWDexieTable").dexieResolve()}return u(a,q).then(function(e){var i=e.newestMsgId,t=e.newestMsgTs;e=e.nextInChatMsgId;var u={isOldestMsgUpdated:!1,lastReadMsg:q.lastReadMsg,lastReadMsgTs:d("MAWTimeUtils").ensureValidMillisTime(q.lastReadMsgTs),msgNextInChatMsgId:e,newestMsgId:i,newestMsgTs:d("MAWTimeUtils").ensureValidMillisTime(t)||d("WATimeUtils").castToMillisTime(0),oldestMsgId:l==null?void 0:l.msgId,oldestMsgTs:d("WATimeUtils").castUnixTimeToMillisTime((e=l==null?void 0:l.ts)!=null?e:d("WATimeUtils").castToUnixTime(0))};i=d("MAWDexieTable").dexieResolve();return i.then(function(){return d("MAWDexieTable").dexieAll([v(a,b,q,f,g,j,k,u,o,p),d("MAWFTSTxns").maybePutMessagesToBacklog(a,b.map(function(a){return a.externalId}))]).then(function(b){b=b[0];for(var d=b,e=Array.isArray(d),f=0,d=e?d:d[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var g;if(e){if(f>=d.length)break;g=d[f++]}else{f=d.next();if(f.done)break;g=f.value}g=g;n(g,q.jid,p)}g=c.concat(b);var h={existingMsgs:c,newlyAddedMsgs:b,threadJid:q.jid};return m(a,j,q,g,b,u,s,k,r,x).then(function(){return h})})["catch"](function(a){d("WALogger").ERROR(h(),a)})})})})}});g.getNextMsgBasedOnSortOrderMs=a;g.isE2eeOrCutoverAdminMsg=k;g.checkForDecryptionFailuresToPointRestore=l;g.restoreMsgsForThread=b;g.getMsgsByProtocolMsgIds=p;g.getMsg=q;g.maybeGetThreadNewestMessage=r;g.maybeGetOldestNonAdminMessage=s;g.prepareUnstoredMsgArrayAndUpdateKeyVariables=t}),98);
__d("MAWRestoreValidationUtils",[],(function(a,b,c,d,e,f){"use strict";function g(a){return a.reduce(function(a,b){if(b.externalId!=null){a[b.externalId]=((b=a[b.externalId])!=null?b:0)+1;return a}return a},{})}function a(a,b,c,d,e){var f=g(a),h=g(b);if(c==null&&d==null)return;a=c!=null?c.map(function(a){return{externalId:a.otid}}):d!=null?d:[];b=g(a);c=Object.keys(f).filter(function(a){return!h[a]});d=Object.keys(h).filter(function(a){return!f[a]});a=Object.keys(b).filter(function(a){return!f[a]});var i=Object.entries(f).filter(function(a){a[0];a=a[1];return a>1}),j=Object.entries(h).filter(function(a){a[0];a=a[1];return a>1});b=Object.entries(b).filter(function(a){a[0];a=a[1];return a>1});j={"int":{duplicates_in_deanon_reference:j.length,duplicates_in_restore_request:b.length,duplicates_in_restored_messages:i.length,missing_in_deanon_reference:c.length,missing_in_restore_request:a.length,missing_in_restored_messages:d.length}};e==null?void 0:e.addPoint("restore_validation",j);return j}f.compareRestoredMsgstoDeanonData=a}),66);
__d("MAWHandleEchoMsgsRestoreApiV2",["EchoBackupCompareUtils","EchoMessage","LSDataTraceCheckPoint","LSIntEnum","LSMEBTaskCreationSource","MAWAckLevel","MAWBridgeEventTransmitter","MAWDbEditMsgHistoryTxns","MAWDbMsg","MAWDbThreadTxns","MAWDexieTable","MAWEncryptedBackupCacheManager","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleEchoMsgsRestoreApiUtils","MAWHandleEchoReactionsRestore","MAWHandleEchoXMARestoreV2","MAWHandlePendingStanzasInRestoreV2","MAWHandlePointRestoredMsgV2","MAWIndexedDb","MAWJids","MAWMsgType","MAWQplProxy","MAWRepliesRestoreUtils","MAWRestoreMsgsTxns","MAWRestoreValidationUtils","MAWTraceUtils","MAWTransactionMode","MAWWriteReceiverFetchTxns","Promise","WAGlobals","WAJids","WAResultOrError","WAStanzaUtils","WATagsLogger","WATimeUtils","asyncToGeneratorRuntime","gkx","promiseDone","qpl","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Oldest message timestamp: "," and newest message timestamp: "," of the batch for thread: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No more messages to restore for thread: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Ignore duplicate restore request of an existing message"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Message ID must not be null"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decode the message"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No messages to be restored for thread: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a supported receiver fetch type: ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] timestamp field should not be null as it is required for attachment download retry: ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] timestamp field should not be null as it is required for attachment download retry: ",""]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] from field is missing from media message: ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] from field is missing from media message: ",""]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Media data is null for the message: ",""]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Media data is null for the message: ",""]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Echo message is missing from the map: ",""]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Echo message is missing from the map: ",""]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missed restoring optimistic messages for thread: "," count: "," }"]);y=function(){return a};return a}function z(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] threadJidPrimaryId "," missing from index db"]);z=function(){return a};return a}function A(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing thread for thread jid: ",""]);A=function(){return a};return a}function B(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error while restoring media/reaction: ",""]);B=function(){return a};return a}function C(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] handleEchoMsgsRestore v2 completed. newlyAdded: "," existing: "," isPointRestore: ",""]);C=function(){return a};return a}function D(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error while deleting point restored messages: ",""]);D=function(){return a};return a}function E(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Message creation complete. MessagesCreated: "," isPointRestore: "," startSortKey: "," taskSource: ",""]);E=function(){return a};return a}function F(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Low level api handleEchoMsgsRestore v2 initiated restore of "," messages. isPointRestore: "," startSortKey: "," taskSource: ",""]);F=function(){return a};return a}var G=c("requireDeferred")("MAWHandleEBRestoreWithHIM").__setRef("MAWHandleEchoMsgsRestoreApiV2");a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,j,k,l,m,n,o,p,q,r,s,t){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(j=l)!=null?j:""]).LOG(F(),e.length,f,m,p);j=f?d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.POINT_RESTORE:m!=null?d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.PAGINATED_RESTORE:d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.INITIAL_RESTORE;j=j;var u=q!=null?q:d("MAWQplProxy").startQplUserFlow(c("qpl")._(521486220,"827"),{bool:{uploadedFromEBQueue:s},"int":{messages:e.length},string:{message_backup_type:"echo",restore_type:j,trace_id:(q=l)!=null?q:""}},void 0,3e5);d("MAWTraceUtils").recordCheckpointForTrace(l,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_ECHO_MESSAGE_RESTORE_BEGIN),[],!1);var v=(yield M(a,l)),w={messageIds:[],pendingRestoreSortKeys:[]};if(v){s=H(v,e,f,g,u,k,n,o,l,p,r);var x=a;return s.then(function(g){var j,k=((j=g.restoredMsgsData)==null?void 0:j.newlyAddedMsgs)?(j=g.restoredMsgsData)==null?void 0:j.newlyAddedMsgs.length:0;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(j=l)!=null?j:""]).LOG(E(),k,f,m,p);P(a,g,n,o);return(h||(h=b("Promise"))).all([N(g,u),O(g,u,l,t),d("MAWHandleEchoReactionsRestore").writeEchoReactionsToReactionsStore(g,d("WAGlobals").getMyUserJid(),u),S(x,g,v==null?void 0:v.jid)]).then(function(j){d("MAWEncryptedBackupCacheManager").setRestoredCacheStatusAsDone(Array.from(g.echoMsgMap.keys()));return(h||(h=b("Promise"))).all([d("MAWRepliesRestoreUtils").updateQuoteDataForReplyMessages(g,u),d("MAWHandleEchoXMARestoreV2").writeXMAToXMAStore(g,v.chatId,u,l),c("gkx")("2251")?d("MAWHandlePendingStanzasInRestoreV2").applyPendingStanzas(g,f,u):d("MAWDexieTable").dexieResolve(),c("gkx")("5624")?T(g,u):d("MAWDexieTable").dexieResolve()]).then(function(){c("promiseDone")(d("MAWHandlePointRestoredMsgV2").uploadPointRestoredMessageIfRequired(g));var j=g.restoredMsgsData;if(f&&j!=null){var m=p===c("LSMEBTaskCreationSource").EB_POINT_QUERY_RETRY_DECRYPTION_FAILURES||c("gkx")("1560")||c("gkx")("4991");m||J(j.newlyAddedMsgs)["catch"](function(a){var b;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(b=l)!=null?b:""]).ERROR(D(),a)})}m=g.restoredMsgsData;j=(m==null?void 0:m.existingMsgs)?m==null?void 0:m.existingMsgs.length:0;m=e.length;u.endSuccess({"int":{existingMsgs:j,messages_lost:e.length-j-k,newlyAddedMsgs:k,restoredMsgs:j+k,totalMsgsToRestore:m},string:{threadJidPrimaryId:a}});d("MAWTraceUtils").recordCheckpointForTrace(l,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_RESTORE_MESSAGES_SUCCESS),[],!1);d("MAWTraceUtils").recordCheckpointForTrace(l,i.ofNumber(c("LSDataTraceCheckPoint").FLOW_END_AND_FLUSH),[],!0);g.quotesToBeRestored.forEach(function(a){w.messageIds.push(a.messageId),w.pendingRestoreSortKeys.push(a.sortOrderMs)});d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(m=l)!=null?m:""]).LOG(C(),k,j,f);return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult(w))})})["catch"](function(a){var c;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(c=l)!=null?c:""]).ERROR(B(),a);u.endFail("error_in_handle_media_or_reaction");return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult(w))})})}else{u.endFail("missing_thread_for_thread_jid");d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(j=l)!=null?j:""]).ERROR(A(),a);P(a,null,n,o)}return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult(w))});return function(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){return a.apply(this,arguments)}}();function H(a,b,c,d,e,f,g,h,i,j,k){return I.apply(this,arguments)}function I(){I=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e,f,g,i,j,k,l,m,n){g==null?void 0:g.addPoint("message_restore_start");var o=new Map(),p=[];c=(yield K(c,e,a,o,f,g,l));var q=c.dbThread,r=c.hasMoreBefore,s=c.messagesToAdd;f=c.quotesToBeRestoredForThread;p.push.apply(p,f);c=s.map(function(b){return{author:b.author,chat:a.jid,externalId:d("WAStanzaUtils").toStanzaId(b.externalId)}});return(h||(h=b("Promise"))).all([d("MAWRestoreMsgsTxns").maybeGetThreadNewestMessage(a),d("MAWRestoreMsgsTxns").maybeGetOldestNonAdminMessage(a),d("MAWRestoreMsgsTxns").getMsgsByProtocolMsgIds(c)]).then(function(a){var b=a[0],c=a[1],f=c.maybeOldestAdminMsg;c=c.maybeOldestMsg;a=a[2];var h=new Set(a.map(function(a){return a.externalId})),t=s.filter(function(a){return!h.has(a.externalId)});b={existingMsgs:a,hasMoreBefore:r,instanceKey:j,isPointRestore:e,maybeNewestMsg:b,maybeOldestAdminMsg:f,maybeOldestMsg:c,minMsgId:i,newMsgs:t,optimisticMsgs:k,taskSource:m,thread:q,traceId:l};var u=[];a.forEach(function(a){return u.push({externalId:a.externalId})});t.forEach(function(a){return u.push({externalId:a.externalId})});return d("MAWRestoreMsgsTxns").restoreMsgsForThread(b).then(function(a){var b=[];(a==null?void 0:a.existingMsgs)!=null&&(b=b.concat(a==null?void 0:a.existingMsgs));(a==null?void 0:a.newlyAddedMsgs)!=null&&(b=b.concat(a==null?void 0:a.newlyAddedMsgs));g==null?void 0:g.addPoint("message_restore_end");n!=null&&!e&&d("MAWRestoreValidationUtils").compareRestoredMsgstoDeanonData(b,n,void 0,u,g);return{echoMsgMap:o,quotesToBeRestored:p,restoredMsgsData:a,thread:q}})})});return I.apply(this,arguments)}var J=(e=d("MAWIndexedDb")).makeMsgrTransactor({messages:(f=d("MAWTransactionMode")).READWRITE},"restoreDeleteMessages",function(a){return function(b){var c=[];for(var d=0;d<b.length;d++)c.push(b[d].rowId);return a.messages.bulkDelete(c)}});function K(a,b,c,d,e,f,g){return L.apply(this,arguments)}function L(){L=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g,h){var i=new Set(),p=new Map(),q=[];if(a==null||a.length===0){var r;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(r=h)!=null?r:""]).WARN(o(),c.jid);return{dbThread:c,hasMoreBefore:!1,messagesToAdd:[],quotesToBeRestoredForThread:q}}var s=0,t=[];a.forEach(function(a){a=d("EchoMessage").decodeEchoMessage(a);if(a==null){var b;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(b=h)!=null?b:""]).ERROR(n());return}a.contentType===d("EchoMessage").EchoMessageContentType.DECRYPTION_FAILURE&&s++;b=a.xOfflineThreadingId;if(b==null){var c;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(c=h)!=null?c:""]).ERROR(m());return}if(i.has(b)){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(c=h)!=null?c:""]).WARN(l());return}i.add(b);t.push(a)});s===a.length&&(g==null?void 0:g.addPoint("decryption_failure_batch",{"int":{decryptionFailuresCount:s}}));r=(yield G.load());a=r.restoreWithHIM;g=(yield a(t,c.jid,d("WAGlobals").getMyUserJid()));g.forEach(function(a){if(a.xOfflineThreadingId==null)return;var b=d("WAStanzaUtils").toStanzaId(a.xOfflineThreadingId),f=d("MAWHandleEchoMsgsRestoreApiUtils").getUnstoredDbMessageFromEchoMessage(a,c.jid,d("WAGlobals").getMyUserJid(),b,h);if(f!=null){d("MAWEncryptedBackupCacheManager").addMsgEntryToRestoredCache(b,d("EchoBackupCompareUtils").buildEchoDocCacheValue(a));p.set(b,f);e.set(b,a);a=a==null?void 0:a.quoteData;if(a!=null){var g=d("WAStanzaUtils").toStanzaId(a.quoteMessageId);if(g!=null&&!p.has(g))q.push({messageId:a.quoteMessageId,sortOrderMs:a.quoteSortOrderInMs.toString()});else{a=d("MAWRepliesRestoreUtils").addQuoteDataToReplyMessage(f,p.get(g));p.set(b,a)}}}});r=Array.from(p.values());r.sort(function(a,b){return((a=a.sortOrderMs)!=null?a:0)-((a=b.sortOrderMs)!=null?a:0)});a=b||f!==!1;if(!a){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(g=h)!=null?g:""]).LOG(k(),c.jid)}if(r.length>0){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(b=h)!=null?b:""]).LOG(j(),r[0].sortOrderMs,r[r.length-1].sortOrderMs,c.jid)}return{dbThread:c,hasMoreBefore:a,messagesToAdd:r,quotesToBeRestoredForThread:q}});return L.apply(this,arguments)}var M=e.makeMsgrTransactor({threads:f.READONLY},"restoreGetThread",function(a){return function(b,c){return d("MAWDbThreadTxns").getThreadPrimaryId(a,b).then(function(a){if(a.success)return a.value;else{d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(a=c)!=null?a:""]).ERROR(z(),b);return d("MAWDexieTable").dexieResolve()}})}}),N=e.makeMsgrTransactor({editMsgHistory:f.READWRITE,messages:f.READWRITE},"restoreEditMsgHistory",function(a){return function(b,c){c==null?void 0:c.addPoint("msg_history_start");var e=b.restoredMsgsData;if(e!=null){var f=e.newlyAddedMsgs.map(function(c){var f=[],g=c.externalId,h=c.author,i=e.threadJid;c=b.echoMsgMap.get(g);if(c!=null){var j=c.editHistory;return d("MAWDbEditMsgHistoryTxns").getEditHistoryAsEcho(a,g,h,i).then(function(b){if(b.length>=j.length)return d("MAWDexieTable").dexieResolve([]);j.forEach(function(a){return f.push({author:h,editExternalId:a.messageId!=null?d("WAStanzaUtils").toStanzaId(a.messageId):null,editTs:d("WATimeUtils").castToUnixTime(a.timestamp),msgContent:{content:a.text},originalMsgExternalId:g,sendStatus:d("MAWAckLevel").ACK.sent,threadJid:i})});b.length>0&&d("MAWDbEditMsgHistoryTxns").bulkRemoveEditHistory(a,g,h,i);return d("MAWDexieTable").dexieResolve(f)})}else return d("MAWDexieTable").dexieResolve([])});return d("MAWDexieTable").dexieAll(f).then(function(b){return d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,b.flat(),!0).then(function(a){return c==null?void 0:c.addPoint("msg_history_end")})})}else{c==null?void 0:c.addPoint("msg_history_end");return d("MAWDexieTable").dexieResolve()}}}),O=function(a,c,d,e){c==null?void 0:c.addPoint("media_restore_start");return Q(a,d,e).then(function(a){c==null?void 0:c.addPoint("media_restore_end",{"int":{media:a}});return(h||(h=b("Promise"))).resolve()})};function P(a,b,e,f,g){if(e!=null&&c("gkx")("23961")){var h,i;h=(h=b==null?void 0:(h=b.restoredMsgsData)==null?void 0:h.newlyAddedMsgs.length)!=null?h:0;i=(i=b==null?void 0:(i=b.restoredMsgsData)==null?void 0:i.existingMsgs.length)!=null?i:0;if(f!=null&&f.size>0){var j,k=new Set([].concat((b==null?void 0:(j=b.restoredMsgsData)==null?void 0:(j=j.newlyAddedMsgs)==null?void 0:j.map(function(a){return a.externalId}))||[],(b==null?void 0:(j=b.restoredMsgsData)==null?void 0:(b=j.existingMsgs)==null?void 0:b.map(function(a){return a.externalId}))||[]));j=Array.from(f.keys()).reduce(function(a,b){return a+(k.has(b)?0:1)},0);if(j>0){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(b=g)!=null?b:""]).WARN(y(),a,j);d("MAWQplProxy").sendQPLFailThroughBridge(c("qpl")._(521482576,"1069"),"optimistic_msgs_missed_restore",{"int":{messages_backend_existing:i,messages_backend_restored:h,missed_message_count:j,optimistic_msgs_count:f.size}},e)}else d("MAWQplProxy").sendQPLSuccessThroughBridge(c("qpl")._(521482576,"1069"),{"int":{messages_backend_existing:i,messages_backend_restored:h,optimistic_msgs_count:f.size}},e)}else d("MAWQplProxy").sendQPLSuccessThroughBridge(c("qpl")._(521482576,"1069"),{"int":{messages_backend_existing:i,messages_backend_restored:h,optimistic_msgs_count:0}},e)}}function Q(a,c,e){var f=a.restoredMsgsData,g=0;if(f){var i=f.existingMsgs.filter(function(a){return d("MAWDbMsg").isMediaMsg(a)&&a.mediaId==null}),j=f.newlyAddedMsgs;i=[].concat(i,j);var k=f.threadJid,l=[];i.map(function(b){var e=b.externalId;e=a.echoMsgMap.get(e);if(b.type!==d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH&&(e==null?void 0:e.contentType)===d("EchoMessage").EchoMessageContentType.MEDIA||(e==null?void 0:e.contentType)===d("EchoMessage").EchoMessageContentType.XMA){b=R(k,b,a.echoMsgMap,(e==null?void 0:e.contentType)===d("EchoMessage").EchoMessageContentType.XMA,c);b!=null&&(g+=1,l.push(b))}});return d("MAWHandleEchoMediaMsgsRestoreV2").downloadMediaAndWriteToMediaStore(l,a.thread.jid,e).then(function(a){return g})}return(h||(h=b("Promise"))).resolve(g)}function R(a,b,e,f,g){e=e.get(b.externalId);if(e==null){if(f){var h;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore","xma",(h=g)!=null?h:""]).WARN(x(),b.externalId)}else{d("WATagsLogger").TAGS(["labyrinth_web","eb_restore","xma",(h=g)!=null?h:""]).ERROR(w(),b.externalId)}return null}h=e.mediaData;if(h==null){if(f){var i;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore","media",(i=g)!=null?i:""]).WARN(v(),e.messageId)}else{d("WATagsLogger").TAGS(["labyrinth_web","eb_restore","media",(i=g)!=null?i:""]).ERROR(u(),e.messageId)}return null}i=e.from;if(i==null){if(f){var j;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore","media",(j=g)!=null?j:""]).WARN(t(),e.messageId)}else{d("WATagsLogger").TAGS(["labyrinth_web","eb_restore","media",(j=g)!=null?j:""]).ERROR(s(),e.messageId)}return null}j=e.sortOrderMs;if(j==null){if(f){var k;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore","media",(k=g)!=null?k:""]).WARN(r(),e.messageId)}else{d("WATagsLogger").TAGS(["labyrinth_web","eb_restore","media",(k=g)!=null?k:""]).ERROR(q(),e.messageId)}return null}g=d("MAWJids").toUserJid(i.localKey);k=g===d("WAGlobals").getMyUserJid()?d("WAJids").AUTHOR_ME:g;i=b.externalId;g=b.msgId;b={author:k,echoMsg:e,externalId:i,isXMA:f,messageTimestamp:j,msgId:g,threadJId:a};k=c("gkx")("23925");i=Date.now()-j<1e3*60*60*24*30;return babelHelpers["extends"]({},b,{mediaData:h,previewMediaData:k&&i?e.previewMediaData:null})}function S(a,b,e){a!=null&&e!=null&&b.quotesToBeRestored.map(function(b){d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(b.messageId,a,b.sortOrderMs,c("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT,e)})}function T(a,c,e){c==null?void 0:c.addPoint("receiver_fetch_restore_start");var f=a.restoredMsgsData;if(f==null){c==null?void 0:c.addPoint("receiver_fetch_restore_end");return(h||(h=b("Promise"))).resolve()}var g=f.newlyAddedMsgs;g=g.concat(f.existingMsgs);var i=g.filter(function(a){return a.type===d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH}).map(function(b){var c=b.externalId;c=a.echoMsgMap.get(c);c=c==null?void 0:c.receiverFetchData;if(c==null||b.receiverFetchId==null)return null;if(c.type!=="sticker"){var f;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(f=e)!=null?f:""]).WARN(p(),c.type);return null}f={mimetype:c.mimetype,previewHeight:c.previewHeight,previewWidth:c.previewWidth,receiverFetchId:b.receiverFetchId,type:c.type};return{dbMsg:b,unstoredDbReceiverFetchInfo:f}}).filter(Boolean);if(i.length>0)return U(i).then(function(a){c==null?void 0:c.addPoint("receiver_fetch_restore_end",{"int":{receiver_fetch:i.length}});return(h||(h=b("Promise"))).resolve()});c==null?void 0:c.addPoint("receiver_fetch_restore_end",{"int":{receiver_fetch:0}});return(h||(h=b("Promise"))).resolve()}var U=e.makeMsgrTransactor({receiverFetchInfo:f.READWRITE},"restoreWriteReceiverFetchInfosToDb",function(a){return function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.dbMsg;b=b.unstoredDbReceiverFetchInfo;return d("MAWWriteReceiverFetchTxns").handleUnstoredReceiverFetchInfo(a,c,b)}))}});g.handleEchoMsgsBulkRestore=a;g.deleteMessages=J;g.getThread=M;g.getMediaMetadataForDownload=R;g.writeReceiverFetchInfosToDb=U}),98);
__d("MAWUnstoredQuotedMsgUtils",["MAWMsgType","WAErr","WAJids","WAMsgType"],(function(a,b,c,d,e,f,g){"use strict";function h(a){if(a==null)return;var b=a.content;a=a.remoteJid;var e;switch(b.type){case d("MAWMsgType").MSG_TYPE.TEXT:e=j(b);break;case d("MAWMsgType").MSG_TYPE.IMAGE:e=k(b);break;case d("MAWMsgType").MSG_TYPE.VIDEO:e=l(b);break;case d("MAWMsgType").MSG_TYPE.PTT:e=m(b);break;case d("MAWMsgType").MSG_TYPE.GIF:e=n(b);break;case d("MAWMsgType").MSG_TYPE.STICKER:e=o(b);break;case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:e=q(b);break;case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:e=r(b);break;case d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:e=s(b);break;case d("WAMsgType").NOTE_REPLY:e=p(b);break;case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:e=t(b);break;default:b.type;throw c("WAErr")("For flow")}return{content:e,remoteJid:a}}function i(a){if(d("WAJids").isAuthorSystem(a.author))throw c("WAErr")("A system message cannot be quoted");return{author:a.author,externalId:a.externalId,ts:a.ts}}function j(a){return babelHelpers["extends"]({},i(a),{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.TEXT})}function k(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.IMAGE})}function l(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.VIDEO})}function m(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.PTT})}function n(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.GIF})}function o(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.STICKER})}function p(a){return babelHelpers["extends"]({},i(a),{msgContent:a.msgContent,type:d("WAMsgType").NOTE_REPLY})}function q(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE})}function r(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.UNAVAILABLE})}function s(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL})}function t(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH})}function a(a){return{quote:h(a.quote)}}g.getWithQuoteMsg=a}),98);
__d("MAWUnstoredTypedMsgUtils",["MAWDbMsg","MAWMsgType","MAWRavenUtils","MAWUnstoredQuotedMsgUtils","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return{ack:a.ack,author:a.id.author,externalId:a.id.externalId,reportingMeta:a.reportingMeta,serverTs:a.serverTs,ts:a.ts}}function i(a){return{forwardingScore:a.forwardingScore,isForwarded:a.isForwarded}}function j(a){return{ephemeralSetting:k(a.ephemeralSetting),messageDeleteTs:a.deleteTs,messageExpirationTs:a.expirationTs}}function k(a){if(a==null)return;return{ephemeralExpirationInSec:a.expirationTs,ephemeralLastUpdatedOrSetTimestamp:a.updatedTs}}function a(a,b){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,msgContent:{content:(a=b.sentWithMessage)!=null?a:"",mentionedJids:void 0},type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:b.targetType})}function b(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,editCount:0,msgContent:a.msgContent,specialTextSize:a.specialTextSize,type:d("MAWMsgType").MSG_TYPE.TEXT})}function c(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,plaintextHash:(a=a.mediaId)!=null?a:void 0,type:d("MAWMsgType").MSG_TYPE.IMAGE})}function e(a){return babelHelpers["extends"]({},h(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,ravenEphemeralMediaState:d("MAWRavenUtils").getEphemeralMediaState(a.ravenEphemeralMediaState),ravenEphemeralType:a.ravenEphemeralType,ravenMediaType:a.ravenMediaType,type:d("MAWMsgType").MSG_TYPE.RAVEN})}function f(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,plaintextHash:(a=a.mediaId)!=null?a:void 0,type:d("MAWMsgType").MSG_TYPE.VIDEO})}function l(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,type:d("MAWMsgType").MSG_TYPE.PTT})}function m(a){return{adminMsgContent:a.adminMsgContent,adminType:a.adminType}}function n(a){return babelHelpers["extends"]({},h(a),{altIndex:void 0,author:d("WAJids").AUTHOR_SYSTEM,msgContent:m(a.msgContent),type:d("MAWMsgType").MSG_TYPE.ADMIN})}function o(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,plaintextHash:(a=a.mediaId)!=null?a:void 0,type:d("MAWMsgType").MSG_TYPE.GIF})}function p(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,plaintextHash:(a=a.mediaId)!=null?a:void 0,type:d("MAWMsgType").MSG_TYPE.STICKER})}function q(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE})}function r(a){return babelHelpers["extends"]({},h(a),{altIndex:d("MAWDbMsg").FUTUREPROOF_ALT_INDEX,msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.FUTUREPROOF})}function s(a){return babelHelpers["extends"]({},h(a),{altIndex:void 0,ebTimestampMs:a.ebTimestampMs,revokedExternalId:a.revokedExternalId,type:d("MAWMsgType").MSG_TYPE.REVOKED})}function t(a){return{adminMsgContent:a.adminMsgContent,adminType:a.adminType}}function u(a){return babelHelpers["extends"]({},h(a),{altIndex:void 0,msgContent:t(a.msgContent),type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN})}function v(a){return{adminMsgContent:a.adminMsgContent,adminType:a.adminType,screenshotActionType:a.screenshotActionType,version:a.version}}function w(a){return babelHelpers["extends"]({},h(a),{altIndex:void 0,msgContent:v(a.msgContent),type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION})}function x(a){return{adminType:a.adminType,authorName:a.authorName}}function y(a){return babelHelpers["extends"]({},h(a),{altIndex:void 0,msgContent:x(a.msgContent),type:d("MAWMsgType").MSG_TYPE.ICDC_ALERT})}function z(a){return babelHelpers["extends"]({},h(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),{altIndex:void 0,type:d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE})}function A(a,b){b=b.receiverFetchId;return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,receiverFetchId:b,type:d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH})}g.getXMAMsg=a;g.getTextMsg=b;g.getImageMsg=c;g.getRavenMsg=e;g.getVideoMsg=f;g.getPttMsg=l;g.getAdminMsg=n;g.getGifMsg=o;g.getStickerMsg=p;g.getDocumentFileMsg=q;g.getFutureproofMsg=r;g.getRevokedMsg=s;g.getEphemeralSettingAdminMsg=u;g.getEphemeralScreenshotActionMsg=w;g.getICDCAlertMsg=y;g.getBumpExistingMessageMsg=z;g.getReceiverFetchMsg=A}),98);
__d("MAWUnstoredMsgUtils",["MAWMsgType","MAWUnstoredTypedMsgUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.unstoredMsg,e=a.unstoredReceiverFetchInfo;a=a.unstoredXMA;if(b==null)return null;switch(b.type){case d("MAWMsgType").MSG_TYPE.TEXT:return d("MAWUnstoredTypedMsgUtils").getTextMsg(b);case d("MAWMsgType").MSG_TYPE.IMAGE:return d("MAWUnstoredTypedMsgUtils").getImageMsg(b);case d("MAWMsgType").MSG_TYPE.VIDEO:return d("MAWUnstoredTypedMsgUtils").getVideoMsg(b);case d("MAWMsgType").MSG_TYPE.PTT:return d("MAWUnstoredTypedMsgUtils").getPttMsg(b);case d("MAWMsgType").MSG_TYPE.ADMIN:return d("MAWUnstoredTypedMsgUtils").getAdminMsg(b);case d("MAWMsgType").MSG_TYPE.FUTUREPROOF:return d("MAWUnstoredTypedMsgUtils").getFutureproofMsg(b);case d("MAWMsgType").MSG_TYPE.REVOKED:return d("MAWUnstoredTypedMsgUtils").getRevokedMsg(b);case d("MAWMsgType").MSG_TYPE.GIF:return d("MAWUnstoredTypedMsgUtils").getGifMsg(b);case d("MAWMsgType").MSG_TYPE.STICKER:return d("MAWUnstoredTypedMsgUtils").getStickerMsg(b);case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return d("MAWUnstoredTypedMsgUtils").getDocumentFileMsg(b);case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return d("MAWUnstoredTypedMsgUtils").getEphemeralSettingAdminMsg(b);case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return d("MAWUnstoredTypedMsgUtils").getEphemeralScreenshotActionMsg(b);case d("MAWMsgType").MSG_TYPE.ICDC_ALERT:return d("MAWUnstoredTypedMsgUtils").getICDCAlertMsg(b);case d("MAWMsgType").MSG_TYPE.XMA:if((a==null?void 0:a.xma)==null)throw c("err")("XMA content cannot be parsed without XMA payload");return d("MAWUnstoredTypedMsgUtils").getXMAMsg(b,a==null?void 0:a.xma);case d("MAWMsgType").MSG_TYPE.RAVEN:return d("MAWUnstoredTypedMsgUtils").getRavenMsg(b);case d("MAWMsgType").MSG_TYPE.RAVEN_ACTION:case d("MAWMsgType").MSG_TYPE.REACTION:case d("MAWMsgType").MSG_TYPE.EDIT_ACTION:return null;case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return d("MAWUnstoredTypedMsgUtils").getBumpExistingMessageMsg(b);case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:if(e==null)throw c("err")("Receiver Fetch Info cannot be null for Receiver Fetch Msg");return d("MAWUnstoredTypedMsgUtils").getReceiverFetchMsg(b,e);default:b.type;return null}}function b(a){if(a==null)return null;switch(a.type){case d("MAWMsgType").MSG_TYPE.TEXT:return d("MAWUnstoredTypedMsgUtils").getTextMsg(a);case d("MAWMsgType").MSG_TYPE.GIF:return d("MAWUnstoredTypedMsgUtils").getGifMsg(a);case d("MAWMsgType").MSG_TYPE.STICKER:return d("MAWUnstoredTypedMsgUtils").getStickerMsg(a);default:return null}}function e(a){a=a.unstoredMsg;if(!a||a.type!==d("MAWMsgType").MSG_TYPE.REACTION)return null;a=a;return{ack:a.ack,author:a.id.author,externalId:a.id.externalId,groupingKey:a.groupingKey,reaction:a.reaction,reactToAuthor:a.reactToAuthor,reactToExternalId:a.reactToExternalId,senderTimestampMs:a.senderTimestampMs,threadJid:a.id.chat,ts:a.ts}}function f(a){a=a.unstoredMsg;if(!a||a.type!==d("MAWMsgType").MSG_TYPE.RAVEN_ACTION)return null;a=a;return{ack:a.ack,actionTimestamp:a.actionTimestamp,actionType:a.actionType,author:a.id.author,externalId:a.id.externalId,ravenActionToMsgExternalId:a.ravenActionToMsgExternalId,ts:a.ts,type:a.type}}function h(a){a=a.unstoredIncomingGroupInvite;return!a?null:babelHelpers["extends"]({},a)}function i(a){return a==null?null:{ack:a.ack,author:a.id.author,editMsgContent:a.editMsgContent,externalId:a.id.externalId,originalMsgExternalId:a.originalMsgExternalId,reportingMeta:a.reportingMeta,serverTs:a.serverTs,specialTextSize:a.specialTextSize,ts:a.ts,type:a.type}}function j(a){a=a.unstoredReceiverFetchInfo;return a==null?null:babelHelpers["extends"]({},a,{type:"sticker"})}g.getUnstoredMsg=a;g.getUnstoredAssociatedMsg=b;g.getUnstoredReaction=e;g.getUnstoredRavenActionMsg=f;g.getGroupInvite=h;g.getUnstoredEditActionMsg=i;g.getUnstoredReceiverFetchInfo=j}),98);
__d("MAWUnstoredMediaUtils",["MAWUnstoredMsgUtils","WASortedLists"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a==null?null:{mediaEntry:a.mediaEntry,mediaType:a.mediaType,msgIds:d("WASortedLists").emptySet(),plaintextHash:a.plaintextHash,size:a.size,ts:a.ts,validatedAudioInfo:a.validatedAudioInfo,validatedDocumentFileInfo:a.validatedDocumentFileInfo,validatedImageInfo:a.validatedImageInfo,validatedVideoInfo:a.validatedVideoInfo}}function a(a){a=a.unstoredXMA;if(a==null)return;var b=a.unstoredAssociatedMedia,c=a.unstoredAssociatedMsg,e=a.unstoredFavicon,f=a.unstoredHeaderMedia,g=a.unstoredPreviews;a=a.xma;return{unstoredAssociatedMedia:(b=h(b))!=null?b:void 0,unstoredAssociatedMsg:(b=d("MAWUnstoredMsgUtils").getUnstoredAssociatedMsg(c))!=null?b:void 0,unstoredDbXMA:{author:a.author,contentRef:a.contentRef,ctas:a.ctas,defaultCTA:a.defaultCTA,externalId:a.externalId,headerTitle:a.headerTitle,isTombstoned:a.isTombstoned,maxSubtitleNumOfLines:a.maxSubtitleNumOfLines,maxTitleNumOfLines:a.maxTitleNumOfLines,overlayDescription:a.overlayDescription,overlayIconGlyph:a.overlayIconGlyph,overlayTitle:a.overlayTitle,subtitleText:a.subtitleText,targetExpiringAtSec:a.targetExpiringAtSec,targetId:a.targetId,targetType:a.targetType,targetUsername:a.targetUsername,threadJid:a.threadJid,titleText:a.titleText,xmaLayoutType:a.xmaLayoutType},unstoredFavicon:(c=h(e))!=null?c:void 0,unstoredHeaderMedia:(b=h(f))!=null?b:void 0,unstoredPreviews:g?g.map(function(a){return h(a)}).filter(Boolean):void 0}}g.getUnstoredMedia=h;g.getUnstoredXMA=a}),98);
__d("MAWUnstoredContentToUnstoredDbContentUtils",["MAWUnstoredMediaUtils","MAWUnstoredMsgUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b,c=(b=d("MAWUnstoredMsgUtils")).getUnstoredMsg(a),e=d("MAWUnstoredMediaUtils").getUnstoredMedia(a.unstoredMedia),f=b.getUnstoredReaction(a),g=b.getUnstoredRavenActionMsg(a),h=d("MAWUnstoredMediaUtils").getUnstoredXMA(a),i=b.getGroupInvite(a),j=b.getUnstoredEditActionMsg(a.unstoredEditMsg);b=b.getUnstoredReceiverFetchInfo(a);if(i==null)return{contentTypeForLogging:a.contentTypeForLogging,unstoredDbEditActionMsg:j,unstoredDbMedia:e,unstoredDbMsg:c,unstoredDbRavenActionMsg:g,unstoredDbReaction:f,unstoredDbReceiverFetchInfo:b,unstoredXMA:h,xmaTargetTypeForLogging:a.xmaTargetTypeForLogging};else return{contentTypeForLogging:a.contentTypeForLogging,unstoredDbEditActionMsg:j,unstoredDbMedia:e,unstoredDbMsg:c,unstoredDbRavenActionMsg:g,unstoredDbReaction:f,unstoredDbReceiverFetchInfo:b,unstoredIncomingDbGroupInvite:i,unstoredXMA:h,xmaTargetTypeForLogging:a.xmaTargetTypeForLogging}}g.unstoredContentToUnstoredDbContent=a}),98);
__d("MAWWriteReactionTxns",["MAWAuthor","MAWDbMsg","MAWDbReaction","MAWDbReactionUtils","MAWDbReactionsTxns","MAWDexieTable","qex"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e){var f=b.author,g=b.externalId,h=b.groupingKey,i=b.reaction,j=b.reactToAuthor,k=b.reactToExternalId,l=b.senderTimestampMs,m=b.ts;return d("MAWDexieTable").dexieAll([a.messages.where("externalId").equals(k).toArray(),a.reactions.where("reactToExternalId").equals(k).toArray(),d("MAWDbReactionsTxns").getNextReactionIdNumberForThread(a,e)]).then(function(b){var n=b[0],o=b[1];b=b[2];o=d("MAWDbReaction").findMatchingReaction(o,e.jid,f);var p=d("MAWAuthor").getAuthorUserJid(j);n=n.find(function(a){return a.threadJid===e.jid&&p===d("MAWAuthor").getAuthorUserJid(a.author)});var q=d("MAWDbReaction").formatReactionForDb(e.jid,g,d("MAWDbMsg").craftReactionId(e.chatId,b),k,i,h,j,n==null?void 0:n.msgId,m,f,o==null?void 0:o.rowId,void 0,l);return d("MAWDbReactionsTxns").putReaction(a,q).then(function(a){a=babelHelpers["extends"]({},q,{rowId:a});c("qex")._("1016")!==!0&&d("MAWDbReactionUtils").dispatchReaction(a);return a})})}g.writeReaction=a}),98);
__d("MAWWriteReactionMsgApi",["MAWDexieTable","MAWIndexedDb","MAWTransactionMode","MAWWriteReactionTxns","WAJids"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a,b,c,e,f,g){g===void 0&&(g=d("WAJids").AUTHOR_ME);var h=e.groupingKey,i=e.reaction,j=e.reactToAuthor,k=e.reactToExternalId;e=e.senderTimestampMs;var l={author:g,externalId:b,groupingKey:h,reaction:i,reactToAuthor:j,reactToExternalId:k,senderTimestampMs:e,ts:f};return a.threads.get({jid:c}).then(function(b){return b==null?"missing_thread":d("MAWWriteReactionTxns").writeReaction(a,l,b)}).then(function(a){return a==="missing_thread"?{type:"missing_thread"}:{msgId:a.reactionId,protocolMsgId:{author:g,chat:c,externalId:a.externalId},type:"not_sent"}})};b=d("MAWIndexedDb").makeMsgrTransactor({messages:(a=d("MAWTransactionMode")).READONLY,reactions:a.READWRITE,threads:a.READONLY},"writeReactionMsg",function(a){return function(b,c,e,f,g){g===void 0&&(g=d("WAJids").AUTHOR_ME);return h(a,b,c,e,f,g)}});c=d("MAWIndexedDb").makeMsgrTransactor({messages:a.READONLY,reactions:a.READWRITE,threads:a.READONLY},"bulkWriteReactionMsg",function(a){return function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){return h(a,b.externalId,b.chatJid,b.args,b.ts,b.author)}))}});g.writeReactionMsg=b;g.bulkWriteReactionMsg=c}),98);
__d("MessageBackupSupplementalKeyGenerator",["$InternalEnum"],(function(a,b,c,d,e,f){"use strict";b=b("$InternalEnum")({REACTION:"reaction",EDIT:"edit"});var g=":";function a(a,b){return""+a+g+b}function c(a){return a.split(g)[1]}function h(a,b){b=b.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");b=new RegExp("^"+b,"i");return b.test(a)}function d(a){return h(a,"reaction")}function e(a){return h(a,"edit")}function i(a){return h(a,"raven_action_message")}f.SupplementalKeyPrefix=b;f.SUPPLEMENTAL_KEY_DELIMITER=g;f.createMessageSupplementalKey=a;f.getSupplementalSenderId=c;f.isSupplementalProtobufAReaction=d;f.isSupplementalProtobufAnEdit=e;f.isSupplementalProtobufARavenAction=i}),66);
__d("MAWHandleEchoProtobufsRestoreApi",["EchoMessageMediaFieldUtils","LSDataTraceCheckPoint","LSIntEnum","LSMEBTaskCreationSource","MAWBridge","MAWBridgeEventTransmitter","MAWBridgeMsg","MAWBridgeXMA","MAWDbEditMsgHistoryTxns","MAWDbMsg","MAWDbRavenActionTxns","MAWDexieTable","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleEchoMsgsRestoreApiUtils","MAWHandleEchoMsgsRestoreApiV2","MAWHandleEchoXMARestoreV2","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWJids","MAWLoadReplyMediaTxns","MAWMediaManagementTxns","MAWMsg","MAWMsgType","MAWQplProxy","MAWRestoreMsgsTxns","MAWRestoreValidationUtils","MAWTraceUtils","MAWTransactionMode","MAWUnstoredContentToUnstoredDbContentUtils","MAWUpdateQuotedMsgTxns","MAWWriteReactionMsgApi","MAWWriteReceiverFetchTxns","MessageBackupSupplementalKeyGenerator","Promise","WAAckLevel","WAArmadilloApplication.pb","WAArmadilloBackupMessage.pb","WABase64","WAConsumerApplication.pb","WAGlobals","WAHashUtils","WAJids","WALogger","WAMediaTransport.pb","WAMediaUtils","WAMsgApplication.pb","WAMsgType","WAParseConsumerMessageProtocol","WAParseMediaTransportProtocol","WAParseMessageApplication","WAStanzaUtils","WATimeUtils","asyncToGeneratorRuntime","decodeProtobuf","gkx","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Cannot download media - timestamp cannot be null"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] cannot support message type for protobuf restore - reverting to echo restore"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Protobuf restore initiated for "," messages. isPointRestore: "," referenceTimestamp: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] No text content found in edit msg"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Unable to parse edit msg, missing either timestamp or msg id"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Message contains unparseable message application - unable to restore message"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Unable to retrieve decoded protobuf from backup message - unsupported message type"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Decoded raven video unstored message is null - unable to restore"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] No author found for original message that was bumped - unable to restore"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Unable to retrieve revoked message external id"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[MAWHandleEchoProtobufsRestoreApi] consumerMessage has no sticker receiver fetch info"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Invalid attachment type, cannot restore attachment"]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Unsupported media type, cannot get mimetype for attachment"]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Failed to create db msg from protobuf"]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Missing required fields, unable to create db msg from protobuf for thread jid "," and otid ",""]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] No target type found for XMA - unable to extract XMA content for message"]);y=function(){return a};return a}function z(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] XMA data is null - unable to extract XMA content for message"]);z=function(){return a};return a}function A(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] No raven msg media type found for raven msg"]);A=function(){return a};return a}function B(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] No raven msg ephemeral type found for raven msg"]);B=function(){return a};return a}function C(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] No revoked msg external id found for revoked msg"]);C=function(){return a};return a}function D(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] text content cannot be null for msg type text - unable to restore msg"]);D=function(){return a};return a}var E=(e=d("MAWIndexedDb")).makeMsgrTransactor({chunk:(f=d("MAWTransactionMode")).READONLY,media:f.READONLY,messages:f.READWRITE,receiverFetchInfo:f.READONLY,xma:f.READONLY},"associateQuotedMessagesForRestoredDbMsgs",function(a){return function(b,c,e){var f=0;return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWUpdateQuotedMsgTxns").associateQuotedMessage(a,c,b,!0).then(function(b){b!=null&&b.length>0&&(f+=b.length,b.forEach(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,void 0,a)})})}))})})).then(function(){e==null?void 0:e.addPoint("replies_restore_end",{"int":{replies:f}});return d("MAWDexieTable").dexieResolve()})}});function F(a,b,c){c={author:c,chat:b,externalId:a};return c}function G(a,b,c){var e=new Map(),f=a.metadata;a=a.reactionData;if(f!=null&&a!=null){var g=f.senderId,h=f.messageId;if(g!=null&&h!=null){a.forEach(function(a){var f=a.ts,i=a.senderId,j=a.reactionExternalId,k=d("WAStanzaUtils").toStanzaId(h);if(i==null||j==null)return;j=d("WAStanzaUtils").toStanzaId(j);i=d("MAWJids").toUserJid(i);var l=d("MAWJids").toUserJid(g);i=i===c?d("WAJids").AUTHOR_ME:i;l=l===c?d("WAJids").AUTHOR_ME:l;var m=i===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED;m={ack:m,chatJid:b,reaction:a.reaction,reactionAuthor:i,reactionExternalId:j,reactToExternalId:k,reactToMsgAuthor:l,ts:f};e.set(j,m)});return e}}}function H(a,b,c,e,f,g,h,i,j,k,l,m){if(a===d("MAWMsgType").MSG_TYPE.TEXT)if(h==null){d("WALogger").ERROR(D());return}else{h={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,msgContent:{content:h,mentionedJids:i!=null?i.map(d("WAJids").validateUserJid).filter(Boolean):void 0},ts:b,type:d("MAWMsgType").MSG_TYPE.TEXT};return h}else if(a===d("MAWMsgType").MSG_TYPE.VIDEO){i={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.VIDEO};return i}else if(a===d("MAWMsgType").MSG_TYPE.GIF){h={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.GIF};return h}else if(a===d("MAWMsgType").MSG_TYPE.IMAGE){i={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.IMAGE};return i}else if(a===d("MAWMsgType").MSG_TYPE.STICKER){h={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.STICKER};return h}else if(a===d("MAWMsgType").MSG_TYPE.PTT){i={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.PTT};return i}else if(a===d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE){h={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE};return h}else if(a===d("MAWMsgType").MSG_TYPE.XMA){i={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,ts:b,type:d("MAWMsgType").MSG_TYPE.XMA};return i}else if(a===d("MAWMsgType").MSG_TYPE.REVOKED){if(j==null){d("WALogger").ERROR(C());return}h={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,ebTimestampMs:null,id:e,msgContent:void 0,revokedExternalId:j,ts:b,type:d("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:b};return h}else if(a===d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE){i={ack:d("WAAckLevel").ACK.SENT,id:e,ts:b,type:d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE};return i}else if(a===d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH){j={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,ts:b,type:d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH};return j}else if(a===d("MAWMsgType").MSG_TYPE.RAVEN){if(k==null){d("WALogger").ERROR(B());return}if(l==null){d("WALogger").ERROR(A());return}h={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,id:e,mediaId:m,ravenEphemeralMediaState:d("MAWMsg").MAWRavenMsgEphemeralMediaState.UNSEEN,ravenEphemeralType:k,ravenMediaType:l,ts:b,type:d("MAWMsgType").MSG_TYPE.RAVEN};return h}}function I(a,b,c,e,f){if(f==null){d("WALogger").ERROR(z());return}var g=f==null?void 0:f.ctas.map(function(a){return{actionUrl:a.actionUrl,buttonType:a.buttonType,ctaType:a.ctaType,nativeUrl:a.nativeUrl,title:a.title}}),h=f.targetType;if(h==null){d("WALogger").ERROR(y());return}var i;f.targetExpiringAtSec!=null&&typeof f.targetExpiringAtSec==="number"&&(i=d("WATimeUtils").castToUnixTime(f.targetExpiringAtSec));a={author:a,contentRef:f.contentRef,ctas:g,defaultCTA:g.length>0?g[0]:void 0,externalId:b,headerTitle:f.headerTitle,maxSubtitleNumOfLines:f.maxSubtitleNumOfLines,maxTitleNumOfLines:f.maxTitleNumOfLines,msgId:c,overlayDescription:f.overlayDescription,overlayIconGlyph:f.overlayIconGlyph,overlayTitle:f.overlayTitle,subtitleText:f.subtitleText,targetExpiringAtSec:i,targetId:f.targetId,targetType:h,targetUsername:f.targetUsername,threadJid:e,titleText:f.titleText,xmaLayoutType:f.xmaLayoutType};return a}function J(a,b,c,e,f){var g=a.metadata,h=a.msgType;if(g!=null&&h!=null){var i,j,k=g.messageId;g=g.senderId;i=(i=a.decodedPayload)==null?void 0:i.text;j=(j=a.decodedPayload)==null?void 0:j.mentionedJid;if(k!=null&&g!=null){var l=d("WATimeUtils").castMilliSecondsToUnixTime(a.sortOrderMs);g=d("MAWJids").toUserJid(g);var m=d("WAStanzaUtils").toStanzaId(k),n=g===c?d("WAJids").AUTHOR_ME:g,o=F(m,b,g);if(a.editMsgData.length>0){var p=l;a.editMsgData.forEach(function(a){var b;if(a.ts>p&&((b=a.editMsgContent.message)==null?void 0:b.text)!=null){p=a.ts;i=(b=a.editMsgContent.message)==null?void 0:b.text;j=(b=a.editMsgContent.message)==null?void 0:b.mentionedJid}})}n=H(h,l,n,o,a.isForwarded,a.forwardingScore,i,j,a.revokedMsgExternalId,a.ravenMsgEphemeralType,a.ravenMsgMediaType,(l=a.ravenUnstoredMedia)==null?void 0:l.plaintextHash);if(n==null){d("WALogger").ERROR(x(),b,m);return}var q;if(a.xmaData!=null&&((o=a.xmaData)==null?void 0:o.targetType)!=null){o={author:g,externalId:m,targetType:(l=a.xmaData)==null?void 0:l.targetType,threadJid:b};q={unstoredAssociatedMedia:void 0,unstoredAssociatedMsg:void 0,unstoredFavicon:void 0,unstoredHeaderMedia:void 0,unstoredPreviews:void 0,xma:o}}g={unstoredMedia:void 0,unstoredMsg:n,unstoredQuotedMedia:void 0,unstoredReceiverFetchInfo:a.receiverFetchInfo,unstoredXMA:q};n.type===d("MAWMsgType").MSG_TYPE.RAVEN&&a.ravenUnstoredMedia!=null&&(g.unstoredMedia=a.ravenUnstoredMedia);l=d("MAWUnstoredContentToUnstoredDbContentUtils").unstoredContentToUnstoredDbContent(g);if(l.unstoredDbMsg!=null){b=l.unstoredDbMsg;b.sortOrderMs=a.sortOrderMs;b.serverTs=d("WATimeUtils").castToUnixTime(a.sortOrderMs/1e3);a.noteReply!=null&&(b.quote={content:a.noteReply,remoteJid:void 0});o=e.get(k);b.author!=null&&c===b.author&&b.author!==d("WAJids").AUTHOR_SYSTEM&&(b.author=d("WAJids").AUTHOR_ME);o!=null&&(b.quoteExternalId=d("WAStanzaUtils").toStanzaId(o));h===d("MAWMsgType").MSG_TYPE.TEXT&&(b.editCount=a.editMsgData.length);n={author:b.author,stanzaId:m,unstoredDbContent:l};l.unstoredDbMedia!=null&&f!=null&&f.set(m,l.unstoredDbMedia);return n}}}d("WALogger").ERROR(w())}function K(a){switch(a){case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.GIF;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.STICKER;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_MP4;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.AUDIO:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_WAV;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.XMA_IMAGE:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG;default:return null}}function L(a){switch(a){case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE:return d("EchoMessageMediaFieldUtils").AttachmentType.IMAGE;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF:return d("EchoMessageMediaFieldUtils").AttachmentType.GIF;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER:return d("EchoMessageMediaFieldUtils").AttachmentType.STICKER;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO:return d("EchoMessageMediaFieldUtils").AttachmentType.VIDEO;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.AUDIO:return d("EchoMessageMediaFieldUtils").AttachmentType.PTT;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.XMA_IMAGE:return d("EchoMessageMediaFieldUtils").AttachmentType.XMA;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.DOCUMENT:return d("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT;default:return null}}function M(){try{return WorkerGlobalScope!==void 0&&self instanceof WorkerGlobalScope}catch(a){return!1}}function N(a){var b,e=M()?d("WAGlobals").getConfig().isOctetStreamAttachmentMimeTypeEnabled():c("gkx")("4644");switch(a){case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE:b="image/jpeg";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.AUDIO:b="audio/wav";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO:b="video/mp4";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF:b="image/gif";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER:b="image/webp";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.XMA_IMAGE:b="image/jpeg";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.DOCUMENT:b=e?"application/octet-stream":"application/pdf";break;default:d("WALogger").ERROR(v())}return b}function O(a,b,c){var e,f,g,h,i,j;b=b;var k=a.ancillary;a=a.integral;e=a==null?void 0:(e=a.transport)==null?void 0:(e=e.integral)==null?void 0:e.fileSha256;f=a==null?void 0:(f=a.transport)==null?void 0:(f=f.integral)==null?void 0:f.fileEncSha256;g=a==null?void 0:(g=a.transport)==null?void 0:(g=g.integral)==null?void 0:g.mediaKey;h=(a==null?void 0:(h=a.transport)==null?void 0:(h=h.integral)==null?void 0:h.mediaKeyTimestamp)!=null?typeof (a==null?void 0:(h=a.transport)==null?void 0:h.integral.mediaKeyTimestamp)==="number"?a==null?void 0:(h=a.transport)==null?void 0:h.integral.mediaKeyTimestamp:void 0:void 0;var l=k==null?void 0:k.gifPlayback;l!=null&&l&&(b=d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF);l=a==null?void 0:(l=a.transport)==null?void 0:(l=l.ancillary)==null?void 0:(l=l.thumbnail)==null?void 0:l.thumbnailHeight;i=a==null?void 0:(i=a.transport)==null?void 0:(i=i.ancillary)==null?void 0:(i=i.thumbnail)==null?void 0:i.thumbnailWidth;var m=K(b),n=L(b);if(n===null){d("WALogger").ERROR(u());return}a={attachmentObjectId:a==null?void 0:(j=a.transport)==null?void 0:(j=j.ancillary)==null?void 0:j.objectId,attachmentType:n,directPath:a==null?void 0:(j=a.transport)==null?void 0:(n=j.integral)==null?void 0:n.directPath,encryptedHash:f!=null?d("WAHashUtils").toPlaintextHash(f):void 0,filename:c,height:k==null?void 0:k.height,mediaKey:g!=null?d("WABase64").encodeB64UrlSafe(g):void 0,mediaKeyTimestamp:h,mediaPlayableDuration:k==null?void 0:k.seconds,plaintextHash:e!=null?d("WAHashUtils").toPlaintextHash(e):void 0,width:k==null?void 0:k.width,xAttachmentType:b,xContentType:"full"};j=N(b);j!=null&&(a.mediaContentType=j);m!=null&&(a.previewContentType=m,a.previewContentHeight=l,a.previewContentWidth=i);return d("EchoMessageMediaFieldUtils").convertMediaMetadataDetailsToMediaMetadata(a,"protobuf")}function P(a,b,e){b=O(a,b,e);if(b==null)return{mediaMetadata:void 0,previewMetadata:null};e=a.integral;a=null;e=e==null?void 0:(e=e.transport)==null?void 0:(e=e.ancillary)==null?void 0:(e=e.thumbnail)==null?void 0:e.downloadableThumbnail;if(e!=null&&c("gkx")("6038")){var f=e.fileSha256,g=e.fileEncSha256,h=e.mediaKey,i=typeof e.mediaKeyTimestamp==="number"?e.mediaKeyTimestamp:void 0;a={attachmentObjectId:e.objectId,attachmentType:d("EchoMessageMediaFieldUtils").AttachmentType.IMAGE,directPath:e.directPath,encryptedHash:g!=null?d("WAHashUtils").toPlaintextHash(g):void 0,filename:void 0,height:void 0,mediaKey:h!=null?d("WABase64").encodeB64UrlSafe(h):void 0,mediaKeyTimestamp:i,mediaPlayableDuration:void 0,plaintextHash:f!=null?d("WAHashUtils").toPlaintextHash(f):void 0,width:void 0,xAttachmentType:d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.MESSENGER_PREVIEW,xContentType:"preview"};return{mediaMetadata:b,previewMetadata:d("EchoMessageMediaFieldUtils").convertMediaMetadataDetailsToMediaMetadata(a,"protobuf")}}return{mediaMetadata:b,previewMetadata:null}}function Q(a,b,c,e,f,g){g===void 0&&(g=null),b!=null&&a!=null&&(c.push({mediaMetadata:b,mediaRestoreType:e,previewMetadata:g}),f.set(d("WAStanzaUtils").toStanzaId(a),c))}function R(a){switch(a){case 0:return d("MAWMsg").MAWRavenMsgEphemeralType.VIEW_ONCE;case 1:return d("MAWMsg").MAWRavenMsgEphemeralType.ALLOW_REPLAY;case 2:return d("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT;default:return void 0}}function S(a,b,c,e,f,g,h,i,j,k,l){var m,n,o=T(a,g,h,i);m=o==null?void 0:(m=o.obj.payload)==null?void 0:m.content;var u={editMsgData:[],externalId:e,forwardingScore:(n=o==null?void 0:(n=o.metadata)==null?void 0:n.forwardingScore)!=null?n:0,isForwarded:(n=o==null?void 0:(n=o.metadata)==null?void 0:n.isForwarded)!=null?n:!1,metadata:a.metadata,reactionData:[],sortOrderMs:b,unknownFieldCount:a.$$unknownFieldCount},v=[];if(m!=null){if(m.messageText!=null){u.msgType=d("MAWMsgType").MSG_TYPE.TEXT;u.decodedPayload=m.messageText;return u}else if(m.extendedContentMessage!=null){u.msgType=d("MAWMsgType").MSG_TYPE.XMA;u.xmaData=m.extendedContentMessage;if(((n=m.extendedContentMessage)==null?void 0:n.headerImage)!=null){n=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").ImageTransportSpec,(b=m.extendedContentMessage)==null?void 0:b.headerImage.payload);b=O(n,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE);Q(e,b,v,"xma_header",j)}if(((n=m.extendedContentMessage)==null?void 0:n.favicon)!=null){n=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").ImageTransportSpec,(b=m.extendedContentMessage)==null?void 0:b.favicon.payload);b=O(n,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE);Q(e,b,v,"xma_favicon",j)}if(((n=m.extendedContentMessage)==null?void 0:n.previews)!=null){(b=m.extendedContentMessage)==null?void 0:b.previews.forEach(function(a){a=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").ImageTransportSpec,a.payload);a=O(a,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE);u.mediaMetadata=a;Q(e,a,v,"xma_preview",j)})}return u}else if(m.audioMessage!=null){n=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").AudioTransportSpec,(n=m.audioMessage)==null?void 0:(b=n.audio)==null?void 0:b.payload);b=O(n,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.AUDIO);u.msgType=d("MAWMsgType").MSG_TYPE.PTT;u.mediaMetadata=b;Q(e,b,v,"attachment",j);return u}else if(m.videoMessage!=null){n=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").VideoTransportSpec,(n=m.videoMessage)==null?void 0:(n=n.video)==null?void 0:n.payload);n=P(n,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO);var w=n.mediaMetadata;n=n.previewMetadata;b=w;b!=null&&b.xAttachmentType===d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF?u.msgType=d("MAWMsgType").MSG_TYPE.GIF:u.msgType=d("MAWMsgType").MSG_TYPE.VIDEO;u.mediaMetadata=b;Q(e,b,v,"attachment",j,n);return u}else if(m.imageMessage!=null){w=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").ImageTransportSpec,(w=m.imageMessage)==null?void 0:(n=w.image)==null?void 0:n.payload);n=P(w,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE);w=n.mediaMetadata;n=n.previewMetadata;b=w;u.msgType=d("MAWMsgType").MSG_TYPE.IMAGE;u.mediaMetadata=b;Q(e,b,v,"attachment",j,n);return u}else if(m.stickerMessage!=null){w=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").StickerTransportSpec,(w=m.stickerMessage)==null?void 0:(n=w.sticker)==null?void 0:n.payload);if(((n=w.integral)==null?void 0:n.receiverFetchId)!=null){n=d("WAParseMediaTransportProtocol").parseStickerReceiverFetchInfo(w);if(n==null){d("WALogger").ERROR(t());return u}u.msgType=d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH;u.receiverFetchInfo=n;return u}b=O(w,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER);u.msgType=d("MAWMsgType").MSG_TYPE.STICKER;u.mediaMetadata=b;Q(e,b,v,"attachment",j);return u}else if(m.documentMessage!=null){n=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").DocumentTransportSpec,(n=m.documentMessage)==null?void 0:(w=n.document)==null?void 0:w.payload);b=O(n,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.DOCUMENT,(w=m.documentMessage)==null?void 0:w.fileName);u.msgType=d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE;u.mediaMetadata=b;Q(e,b,v,"attachment",j);return u}}else if((o==null?void 0:(n=o.obj.payload)==null?void 0:(m=n.applicationData)==null?void 0:m.revoke)!=null){n=o==null?void 0:(w=o.obj.payload)==null?void 0:(n=w.applicationData)==null?void 0:(m=n.revoke)==null?void 0:(w=m.key)==null?void 0:w.id;if(n==null)d("WALogger").ERROR(s());else{u.revokedMsgExternalId=d("WAStanzaUtils").toStanzaId(n);u.msgType=d("MAWMsgType").MSG_TYPE.REVOKED;return u}}if((o==null?void 0:(m=o.obj.payload)==null?void 0:(w=m.content)==null?void 0:w.bumpExistingMessage)!=null){w=o==null?void 0:(n=o.obj.payload)==null?void 0:(m=n.content)==null?void 0:m.bumpExistingMessage;m=(n=w.key)==null?void 0:n.id;m!=null&&(h.has(m)||g.add(m),i.set(e,m));h=(n=w.key)==null?void 0:n.participant;if(h==null){h=(g=w.key)==null?void 0:g.remoteJid}if(h==null)d("WALogger").ERROR(r());else{i=d("WAJids").unsafeCoerceToUserJid(h);m=i===c?d("WAJids").AUTHOR_ME:i;k.set(d("WAStanzaUtils").toStanzaId(e),m);u.msgType=d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE;return u}}if((o==null?void 0:(n=o.obj)==null?void 0:(w=n.payload)==null?void 0:(g=w.content)==null?void 0:g.noteReplyMessage)!=null){m=o==null?void 0:(h=o.obj)==null?void 0:(i=h.payload)==null?void 0:(k=i.content)==null?void 0:k.noteReplyMessage;n=m.noteTimestampMs;w=m.noteText;h=(g=a.metadata)==null?void 0:g.senderId;if(n!=null&&typeof n==="number"&&h!=null&&f!=null){i=d("MAWJids").toUserJid(h);k=d("MAWJids").toUserJid(f);a=k===i?c:k;g={author:a===c?d("WAJids").AUTHOR_ME:a,externalId:d("WAStanzaUtils").toStanzaId(e),ts:d("WATimeUtils").castMilliSecondsToUnixTime(n),type:d("WAMsgType").NOTE_REPLY};if((w==null?void 0:w.text)!=null){h={content:w==null?void 0:w.text,mentionedJids:w==null?void 0:w.mentionedJid.map(function(a){return d("MAWJids").toUserJid(a)})};g.msgContent=h}u.noteReply=g}if(m.textContent!=null){u.msgType=d("MAWMsgType").MSG_TYPE.TEXT;u.decodedPayload=m.textContent;return u}else if(m.stickerContent!=null){f=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").StickerTransportSpec,m.stickerContent.payload);b=O(f,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER);u.msgType=d("MAWMsgType").MSG_TYPE.STICKER;u.mediaMetadata=b;Q(e,b,v,"attachment",j);return u}else if(m.videoContent!=null){i=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").VideoTransportSpec,m.videoContent.payload);b=O(i,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO);b!=null&&b.xAttachmentType===d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF?u.msgType=d("MAWMsgType").MSG_TYPE.GIF:u.msgType=d("MAWMsgType").MSG_TYPE.VIDEO;u.mediaMetadata=b;Q(e,b,v,"attachment",j);return u}}if((o==null?void 0:(k=o.obj)==null?void 0:(c=k.payload)==null?void 0:(a=c.content)==null?void 0:a.ravenMessageMsgr)!=null){u.ravenMsgEphemeralType=R(o==null?void 0:(n=o.obj)==null?void 0:(w=n.payload)==null?void 0:(h=w.content)==null?void 0:(g=h.ravenMessageMsgr)==null?void 0:g.ephemeralType);if((o==null?void 0:(f=o.obj)==null?void 0:(m=f.payload)==null?void 0:(i=m.content)==null?void 0:(b=i.ravenMessageMsgr)==null?void 0:b.imageMessage)!=null){if(l==null||!l){u.ravenUnstoredMedia=d("WAParseMediaTransportProtocol").decodeImageTransport(o==null?void 0:(k=o.obj)==null?void 0:(c=k.payload)==null?void 0:(a=c.content)==null?void 0:(n=a.ravenMessageMsgr)==null?void 0:(w=n.imageMessage)==null?void 0:w.payload,d("WATimeUtils").castMilliSecondsToUnixTime(u.sortOrderMs))}u.ravenMsgMediaType=d("MAWMsg").MAWRavenMsgMediaType.IMAGE}else if((o==null?void 0:(h=o.obj)==null?void 0:(g=h.payload)==null?void 0:(f=g.content)==null?void 0:(m=f.ravenMessageMsgr)==null?void 0:m.videoMessage)!=null){if(l==null||!l){n=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").VideoTransportSpec,o==null?void 0:(i=o.obj)==null?void 0:(b=i.payload)==null?void 0:(k=b.content)==null?void 0:(c=k.ravenMessageMsgr)==null?void 0:(a=c.videoMessage)==null?void 0:a.payload);w=d("WAParseMediaTransportProtocol").parseVideoMsg(n,d("WATimeUtils").castMilliSecondsToUnixTime(u.sortOrderMs),!1);w!=null?u.ravenUnstoredMedia=w:d("WALogger").ERROR(q())}u.ravenMsgMediaType=d("MAWMsg").MAWRavenMsgMediaType.VIDEO}u.msgType=d("MAWMsgType").MSG_TYPE.RAVEN;return u}o!=null&&aa(u,o.obj);d("WALogger").ERROR(p());return u}function aa(a,b){var c;(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.locationMessage)!=null&&(a.futureProofMessageType="locationMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.liveLocationMessage)!=null&&(a.futureProofMessageType="liveLocationMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.pollCreationMessage)!=null&&(a.futureProofMessageType="pollCreationMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.pollUpdateMessage)!=null&&(a.futureProofMessageType="pollUpdateMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.viewOnceMessage)!=null&&(a.futureProofMessageType="viewOnceMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.contactMessage)!=null&&(a.futureProofMessageType="contactMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.extendedTextMessage)!=null&&(a.futureProofMessageType="extendedTextMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.groupInviteMessage)!=null&&(a.futureProofMessageType="groupInviteMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.commonSticker)!=null&&(a.futureProofMessageType="commonSticker");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.screenshotAction)!=null&&(a.futureProofMessageType="screenshotAction");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.extendedMessageContentWithSear)!=null&&(a.futureProofMessageType="extendedMessageContentWithSear");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.imageGalleryMessage)!=null&&(a.futureProofMessageType="imageGalleryMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.paymentsTransactionMessage)!=null&&(a.futureProofMessageType="paymentsTransactionMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.applicationData)==null?void 0:c.metadataSync)!=null&&(a.futureProofMessageType="metadataSync");(b==null?void 0:(c=b.payload)==null?void 0:(b=c.applicationData)==null?void 0:b.aiBotResponse)!=null&&(a.futureProofMessageType="aiBotResponse")}function T(a,b,c,e){var f;f=(f=a.metadata)==null?void 0:f.messageId;a=d("decodeProtobuf").decodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,a.payload);var g=d("WAParseMessageApplication").parseMessageApplication(a);if(g.type==="error"){d("WALogger").ERROR(o());return}a=a.metadata;var h=a==null?void 0:a.quotedMessage;h=h==null?void 0:h.stanzaId;f!=null&&h!=null&&(c.has(h)||b.add(h),e.set(f,h));if(g.subprotocolType==="armadillo"){c=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAArmadilloApplication.pb").ArmadilloSpec,g.payload);return{metadata:a,obj:c}}else if(g.subprotocolType==="consumerMessage")return{metadata:a,obj:d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAConsumerApplication.pb").ConsumerApplicationSpec,g.payload)}}function U(a,b,c,d,e,f,g,h,i){return a.map(function(a){return V(a,b,c,d,e,f,g,h,i)})}function V(a,b,c,e,f,g,h,i,j){g===void 0&&(g=new Map());var k=d("decodeProtobuf").decodeProtobuf(d("WAArmadilloBackupMessage.pb").BackupMessageSpec,a.toplevelProtobuf.decryptedProtobuf);k=S(k,a.toplevelProtobuf.protobufTimestampMS,b,a.otid,c,e,f,g,h,i,j);c=a.supplementalProtobufs;for(h of c){i=h[0];j=h[1];c=d("decodeProtobuf").decodeProtobuf(d("WAArmadilloBackupMessage.pb").BackupMessageSpec,j.decryptedProtobuf);if(!d("MessageBackupSupplementalKeyGenerator").isSupplementalProtobufAReaction(i)&&!d("MessageBackupSupplementalKeyGenerator").isSupplementalProtobufAnEdit(i)&&!d("MessageBackupSupplementalKeyGenerator").isSupplementalProtobufARavenAction(i))continue;if(d("MessageBackupSupplementalKeyGenerator").isSupplementalProtobufARavenAction(i)&&c.payload!=null){var l=T(c,e,f,g),m=i.split(":")[1];m=d("MAWJids").toUserJid(m);m=m===b?d("WAJids").AUTHOR_ME:m;if(l!=null){var o,p,q;l=l.obj;o=(o=l.payload)==null?void 0:(o=o.content)==null?void 0:(o=o.ravenActionNotifMessage)==null?void 0:o.actionTimestamp;p=(p=l.payload)==null?void 0:(p=p.content)==null?void 0:(p=p.ravenActionNotifMessage)==null?void 0:p.actionType;if(o!=null&&p!=null&&typeof o==="number"&&((q=l.payload)==null?void 0:(q=q.content)==null?void 0:(q=q.ravenActionNotifMessage)==null?void 0:(q=q.key)==null?void 0:q.id)!=null){q=d("WAStanzaUtils").toStanzaId((q=l.payload)==null?void 0:(l=q.content)==null?void 0:(q=l.ravenActionNotifMessage)==null?void 0:(l=q.key)==null?void 0:l.id);if(((l=c.metadata)==null?void 0:l.timestampMs)!=null&&typeof ((l=c.metadata)==null?void 0:l.timestampMs)==="number"&&((l=c.metadata)==null?void 0:l.messageId)!=null){var r;l=(l=c.metadata)==null?void 0:l.messageId;r=d("WATimeUtils").castMilliSecondsToUnixTime((r=c.metadata)==null?void 0:r.timestampMs);l=d("WAStanzaUtils").toStanzaId(l);p=p===0?d("MAWMsg").MAWRavenActionNotifType.PLAYED:p===1?d("MAWMsg").MAWRavenActionNotifType.SCREENSHOTTED:d("MAWMsg").MAWRavenActionNotifType.FORCE_DISABLED;o={ack:d("WAAckLevel").ACK.RECEIVED,actionTimestamp:d("WATimeUtils").castMilliSecondsToUnixTime(o),actionType:p,author:m,externalId:l,ravenActionToMsgExternalId:q,ts:r,type:d("MAWMsgType").MSG_TYPE.RAVEN_ACTION};k.ravenActionUnstoredMsg=o}}}}if(d("MessageBackupSupplementalKeyGenerator").isSupplementalProtobufAReaction(i)&&c.payload!=null){m=(p=c.metadata)==null?void 0:p.messageId;o=(l=T(c,e,f,g))==null?void 0:(q=l.obj.payload)==null?void 0:(r=q.content)==null?void 0:r.reactionMessage;p=d("MessageBackupSupplementalKeyGenerator").getSupplementalSenderId(i);o!=null&&p!=null&&k.reactionData.push({reaction:o,reactionExternalId:m,senderId:p,ts:d("WATimeUtils").castMilliSecondsToUnixTime(j.protobufTimestampMS)})}else if(d("MessageBackupSupplementalKeyGenerator").isSupplementalProtobufAnEdit(i)&&c.payload!=null){l=i.split(":");l.length!==3&&d("WALogger").ERROR(n());q=d("WAStanzaUtils").toStanzaId(l[1]);p=(r=T(c,e,f,g))==null?void 0:(o=r.obj.payload)==null?void 0:(m=o.content)==null?void 0:m.editMessage;i=(j=c.metadata)==null?void 0:j.senderId;if(p!=null){r=(l=p.key)==null?void 0:l.id;o=p.timestampMs;if(r!=null&&o!=null&&i!=null&&typeof o==="number"){m=d("MAWJids").toUserJid(i);c=m===b?d("WAJids").AUTHOR_ME:m;k.editMsgData.push({author:c,editMsgContent:p,externalId:q,originalMsgExternalId:d("WAStanzaUtils").toStanzaId(r),ts:d("WATimeUtils").castMilliSecondsToUnixTime(o)})}}}}f.add(a.otid);return k}function ba(a,b,e,f,g,h,i){h==null?void 0:h.addPoint("replies_restore_start");return E(a,g,h).then(function(){b!=null&&(i.forEach(function(a){d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(a,b,void 0,c("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT,g)}),i.clear())})}function ca(a,e,f,g){f==null?void 0:f.addPoint("xma_restore_start");var h=[],j=new Map();return(i||(i=b("Promise"))).all(a.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(d("MAWDbMsg").isXMAMsg(a)){var b=a.externalId,c=e.get(b);if(c!=null&&c.xmaData!=null){c=I(a.author,a.externalId,a.msgId,a.threadJid,c.xmaData);if(c!=null){var f,i,k=[],l=[],m=[],n=new Map();b=g.get(b);b!=null&&b.forEach(function(b){var c=d("WAMediaUtils").stringToDeliveryObjectId(b.mediaMetadata.attachmentObjectId),e=d("WAHashUtils").stringToPlaintextHash(d("MAWHandleEchoMediaMsgsRestoreV2").getBase64WithoutPadding(b.mediaMetadata.plaintextHash)),g=n.get(e);n.set(e,g!=null?[].concat(g,[a.msgId]):[a.msgId]);m.push(c);b.mediaRestoreType==="xma_header"&&(f=c);b.mediaRestoreType==="xma_favicon"&&(i=c);b.mediaRestoreType==="xma_preview"&&k.push(c)});var o=(yield d("MAWHandleEchoXMARestoreV2").getMediaForXMAByObjectIds(m,n));o.forEach(function(a,b){j.set(a.mediaId,a)});if(f!=null){c.headerMediaId=(b=o.get(f))==null?void 0:b.mediaId}if(i!=null){c.faviconMediaId=(b=o.get(i))==null?void 0:b.mediaId}k.forEach(function(a){a=(a=o.get(a))==null?void 0:a.mediaId;a!=null&&l.push(a)});c.previewMediaIds=l;l.length>0&&(c.defaultPreviewMediaId=l[0]);h.push(c)}}}});return function(b){return a.apply(this,arguments)}}())).then(function(){return d("MAWHandleEchoXMARestoreV2").writeXMAsToDb(h).then(function(a){a.forEach(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b;a.previewMediaIds!=null&&a.previewMediaIds.length>0&&(b=j.get(a.previewMediaIds[0]));var e;c("gkx")("821")?e=(yield d("MAWHandleXmaTransactionUtil").checkMediaChunkTransactionAndCreatedBridgeXma(b,a)):e=d("MAWBridgeXMA").createBridgeXMA(b,a,!1);d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewXMA",value:e}]})});return function(b){return a.apply(this,arguments)}}()),f==null?void 0:f.addPoint("xma_restore_end",{"int":{xma:a.length}})})})}function a(a){return W.apply(this,arguments)}function W(){W=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.currentUserJid,f=a.deanonApiPayload,g=a.decryptedMessagesProtobufs,m=a.echoMessages,n=a.hasMoreAfter,o=a.hasMoreBefore,p=a.instanceKey,q=a.isPointRestore,r=a.minMsgId,s=a.referenceTimestamp,t=a.requestId,u=a.skipMediaDownload,v=a.threadJidPrimaryId;a=a.uploadedFromEbQueue;if(g.length===0)return(i||(i=b("Promise"))).resolve();d("WALogger").LOG(l(),g.length,q,s);var w=new Set(),x=new Set(),y=new Map(),z=new Map(),A=new Map(),B=v,C=(yield d("MAWHandleEchoMsgsRestoreApiV2").getThread(v,t));s=q?d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.POINT_RESTORE:s!=null?d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.PAGINATED_RESTORE:d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.INITIAL_RESTORE;s=s;var D=d("MAWQplProxy").startQplUserFlow(c("qpl")._(521486220,"827"),{bool:{isPointRestore:q,uploadedFromEbQueue:a},"int":{messages:g.length},string:{message_backup_type:"protobuf",restore_type:s}},void 0,3e5);d("MAWTraceUtils").recordCheckpointForTrace(t,(h||(h=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_ECHO_MESSAGE_RESTORE_BEGIN),[],!1);try{if(C){s=U(g,e,v,w,x,y,A,z);var E=C.jid,F=new Set(),G=new Map(),H=new Map(),I=s.map(function(a){G.set(d("WAStanzaUtils").toStanzaId(a.externalId),a);var b=J(a,E,e,y,H);b==null&&F.add(a.externalId);return b}).filter(Boolean),K=s.filter(function(a){return F.has(a==null?void 0:a.externalId)});m!=null&&m.length>0&&m.length!==g.length&&(D==null?void 0:D.addPoint("mismatch_between_echo_and_protobuf_payload_from_server",{"int":{echoMessagesLength:m.length,protobufMessagesLength:g.length}}));if(K.length>0){var L=new Map();K.forEach(function(a){var b="unknown";a.msgType!=null?b=a.msgType:a.futureProofMessageType!=null&&(b=a.futureProofMessageType);a=L.get(b);a!=null?L.set(b,a+1):L.set(b,1)});var M={};L.forEach(function(a,b){b="protobuf_restore_failure_"+b;M[b]=a});D==null?void 0:D.addPoint("protobuf_restore_failed_count_by_msg_type",{"int":M});if(m!=null&&m.length===g.length){d("WALogger").LOG(k());x.clear();D==null?void 0:D.addPoint("reverting_to_echo_restore");yield d("MAWHandleEchoMsgsRestoreApiV2").handleEchoMsgsBulkRestore(v,m,!1,o,n,r,void 0,void 0,p,void 0,void 0,D,void 0,a);return}}K=I.map(function(a){return{author:a.author,chat:C.jid,externalId:a.stanzaId}});var N=new Set();m=I.map(function(a){N.add(a.stanzaId);return babelHelpers["extends"]({},babelHelpers["extends"]({},a.unstoredDbContent.unstoredDbMsg,{threadJid:C.jid}))});var O=new Map();f!=null&&f.forEach(function(a){O.set(a.externalId,a.sortOrderMs)});s.forEach(function(a){var b=a.sortOrderMs;a=a.externalId;if(O.size>0&&b!=null){a=O.get(a);a!=null&&(a!==b&&(D==null?void 0:D.addPoint("protobuf_restore_toplevel_ts_mismatch")))}});m.sort(function(a,b){return((a=a.sortOrderMs)!=null?a:0)-((a=b.sortOrderMs)!=null?a:0)});n=(yield (i||(i=b("Promise"))).all([d("MAWRestoreMsgsTxns").maybeGetThreadNewestMessage(C),d("MAWRestoreMsgsTxns").maybeGetOldestNonAdminMessage(C),d("MAWRestoreMsgsTxns").getMsgsByProtocolMsgIds(K)]));a=n[0];I=n[1];s=I.maybeOldestAdminMsg;K=I.maybeOldestMsg;I=n[2];var P=new Set(I.map(function(a){return a.externalId}));n=m.filter(function(a){return!P.has(a.externalId)});m=q||o;z={bumpMessageAuthorMap:z,existingMsgs:I,hasMoreBefore:(o=m)!=null?o:!0,instanceKey:p,isPointRestore:q,maybeNewestMsg:a,maybeOldestAdminMsg:s,maybeOldestMsg:K,minMsgId:r,newMsgs:n,thread:C};D==null?void 0:D.addPoint("message_restore_start");I=(yield d("MAWRestoreMsgsTxns").restoreMsgsForThread(z));m=0;o=0;D==null?void 0:D.addPoint("message_restore_end");p=[];(I==null?void 0:I.existingMsgs)!=null&&(p=p.concat(I==null?void 0:I.existingMsgs),m=I==null?void 0:I.existingMsgs.length);(I==null?void 0:I.newlyAddedMsgs)!=null&&(p=p.concat(I==null?void 0:I.newlyAddedMsgs),o=I==null?void 0:I.newlyAddedMsgs.length);f!=null&&!q&&d("MAWRestoreValidationUtils").compareRestoredMsgstoDeanonData(p,f,g,void 0,D);var Q=[];yield i.all(p.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a!=null)if(A.has(a.externalId)){var b=a.sortOrderMs,c=d("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(a.author),e=A.get(a.externalId);b==null?d("WALogger").ERROR(j()):e!=null&&a.mediaId==null&&e.map(function(e){e={author:c,echoMsg:void 0,externalId:a.externalId,isXMA:d("MAWDbMsg").isXMAMsg(a),mediaData:e.mediaMetadata,messageTimestamp:b,msgId:a.msgId,previewMediaData:e.previewMetadata,threadJId:a.threadJid};Q.push(e)})}else if(a.type===d("MAWMsgType").MSG_TYPE.RAVEN){e=H.get(a.externalId);e!=null&&(yield ga(a,e))}});return function(b){return a.apply(this,arguments)}}()));a=d("MAWHandleEchoMediaMsgsRestoreV2").downloadMediaAndWriteToMediaStore(Q,E,u);s=i.all(p.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=G.get(a.externalId);a!=null&&(yield da(a,E,D,e),yield ea(a,E,e,D),a.ravenActionUnstoredMsg!=null&&(yield ha(a.ravenActionUnstoredMsg,C)))});return function(b){return a.apply(this,arguments)}}()));D==null?void 0:D.addPoint("media_restore_start");yield i.all([a,s]);D==null?void 0:D.addPoint("media_restore_end",{"int":{media:Q.length}});yield ca(p,G,D,A);yield ia(p,G,D);yield ba(p,B,C.chatId,q,E,D,w);D.endSuccess({"int":{existingMsgs:m,messages_lost:g.length-m-o,newlyAddedMsgs:o,restoredMsgs:m+o,totalMsgsToRestore:g.length},string:{threadJidPrimaryId:v}});d("MAWTraceUtils").recordCheckpointForTrace(t,(h||(h=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_RESTORE_MESSAGES_SUCCESS),[],!1);d("MAWTraceUtils").recordCheckpointForTrace(t,h.ofNumber(c("LSDataTraceCheckPoint").FLOW_END_AND_FLUSH),[],!0)}}finally{A.clear(),x.clear()}});return W.apply(this,arguments)}function da(a,b,c,d){return X.apply(this,arguments)}function X(){X=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e){c.addPoint("msg_history_start");if(a.editMsgData.length>0){var f,g,h,i=[],j=a.sortOrderMs;f=(f=a.metadata)==null?void 0:f.messageId;g=(g=a.metadata)==null?void 0:g.senderId;h=(h=a.decodedPayload)==null?void 0:h.text;if(f!=null&&g!=null){j=d("WATimeUtils").castMilliSecondsToUnixTime(j);g=d("MAWJids").toUserJid(g);f=d("WAStanzaUtils").toStanzaId(f);e=g===e?d("WAJids").AUTHOR_ME:g;g=Y(e,h,f,f,j,b);g!=null&&i.push(g);a.editMsgData.forEach(function(a){var c;c=Y(a.author,(c=a.editMsgContent.message)==null?void 0:c.text,a.externalId,a.originalMsgExternalId,a.ts,b);c!=null&&i.push(c)});yield fa(i);c.addPoint("msg_history_end")}}});return X.apply(this,arguments)}function Y(a,b,c,e,f,g){var h=a===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED;if(b!=null)return{author:a,editExternalId:c,editTs:f,msgContent:{content:b},originalMsgExternalId:e,sendStatus:h,threadJid:g};d("WALogger").ERROR(m());return void 0}function ea(a,b,c,d){return Z.apply(this,arguments)}function Z(){Z=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g){f=G(a,e,f);a=a.metadata;if(f!=null&&a!=null){g.addPoint("reactions_restore_start");var h=a.messageId,j=[];f.forEach(function(a,b){return j.push({stanzaId:b,waReactionMsg:a})});if(c("gkx")("4219")){a=j.filter(function(a){a=a.waReactionMsg;return h!=null&&a.ts!=null}).map(function(a){var b=a.stanzaId;a=a.waReactionMsg;return{args:{groupingKey:a.reaction.groupingKey,reaction:a.reaction.text,reactToAuthor:d("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(a.reactToMsgAuthor),reactToExternalId:a.reactToExternalId,senderTimestampMs:a.reaction.senderTimestampMs},author:d("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(a.reactionAuthor),chatJid:e,externalId:b,ts:a.ts}});yield d("MAWWriteReactionMsgApi").bulkWriteReactionMsg(a)}else{f=(i||(i=b("Promise"))).all(j.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.waReactionMsg,c=b.ts;c!=null&&h!=null&&(yield d("MAWWriteReactionMsgApi").writeReactionMsg(a.stanzaId,e,{groupingKey:b.reaction.groupingKey,reaction:b.reaction.text,reactToAuthor:d("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(b.reactToMsgAuthor),reactToExternalId:b.reactToExternalId,senderTimestampMs:b.reaction.senderTimestampMs},c,d("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(b.reactionAuthor)))});return function(b){return a.apply(this,arguments)}}()));yield f}g.addPoint("reactions_restore_end")}});return Z.apply(this,arguments)}var fa=e.makeMsgrTransactor({editMsgHistory:f.READWRITE,messages:f.READWRITE},"bulkAddEditMsgHistory",function(a){return function(b){return d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,b).then(function(){})}}),ga=e.makeMsgrTransactor({chunk:f.READWRITE,media:f.READWRITE,mediaBackup:f.READWRITE,messages:f.READWRITE},"handleUnstoredMedia",function(a){return function(b,c){return d("MAWMediaManagementTxns").handleUnstoredDbMedia(a,c,b,!1,!1)}}),ha=e.makeMsgrTransactor({messages:f.READWRITE,unrenderedMessages:f.READWRITE},"writeRavenActinomsg",function(a){return function(b,c){return d("MAWDbRavenActionTxns").writeRavenActionMsg(a,b,c)}});function ia(a,b,e){if(!c("gkx")("5624"))return;e==null?void 0:e.addPoint("receiver_fetch_restore_start");var f=[];a.forEach(function(a){if(a.type===d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH&&a.receiverFetchId!=null){var c=b.get(a.externalId);if(c!=null&&c.receiverFetchInfo!=null){c=babelHelpers["extends"]({},c.receiverFetchInfo,{type:"sticker"});f.push({dbMsg:a,unstoredDbReceiverFetchInfo:c})}}});return $(f).then(function(){e==null?void 0:e.addPoint("receiver_fetch_restore_end")})["catch"](function(a){e==null?void 0:e.addPoint("receiver_fetch_restore_failure")})}var $=e.makeMsgrTransactor({receiverFetchInfo:f.READWRITE},"restoreWriteReceiverFetchInfosToTb",function(a){return function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.dbMsg;b=b.unstoredDbReceiverFetchInfo;return d("MAWWriteReceiverFetchTxns").handleUnstoredReceiverFetchInfo(a,c,b)}))}});g.associateQuotedMessagesForRestoredDbMsgsTransactor=E;g.createUnstoredDbContentFromProtobufObject=J;g.decodeProtobufArray=U;g.decodeDecryptedMessageProtobuf=V;g.handleProtobufsRestore=a;g.writeReceiverFetchInfosToTb=$}),98);
__d("isUseridAnnotationEnabled",["gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(){return c("gkx")("24163")}g["default"]=a}),98);
__d("MAWUserHash",["MAWCurrentUser","WAGlobals","WAJids","isUseridAnnotationEnabled"],(function(a,b,c,d,e,f,g){"use strict";function a(){return d("MAWCurrentUser").isEmployee()&&c("isUseridAnnotationEnabled")()?d("WAJids").extractUserId(d("WAGlobals").getMyUserJid()).slice(-5):null}g.getUserHash=a}),98);
__d("WAServerRPCLogger",["WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";a=d("WATagsLogger").TAGS(["ServerRPC"]);g.logger=a}),98);
__d("MAWIncomingMsg",["MAWUserHash","WAGetPlatformFromStanzaId","WAHashStringToNumber","WAServerRPCLogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";a=d("WAServerRPCLogger").logger.TAGS(["HandleIncomingMsg"]);b=function(a){var b=a.encTypes,c=a.incomingType,e=a.msg,f=a.queueType;a=a.retryCount;return{"int":{messageAge:d("WATimeUtils").unixTime()-e.ts,msgId:d("WAHashStringToNumber").hashStringToNumber(e.externalId.toString()),offlineDelivery:e.offline,retryCount:a},string:{e2eePlatform:d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(e.externalId),incomingType:c,jid:e.from.chat,msgType:e.type,queueType:f,threadType:e.from.type,userHash:d("MAWUserHash").getUserHash()},string_array:{encTypes:b}}};g.logger=a;g.prepareAnnotationsForIncomingMessage=b}),98);
__d("MAWProtocolQueueMsg",["MAWBulkHandleIncomingMsgApi","MAWHIMLogger","MAWMsgType","MAWXMALoggingUtils","MAWXMAUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot have null result for non-invisible msgs"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handle: "," msgs: done"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handle: "," msgs"]);j=function(){return a};return a}function a(a){var b=new Set(),e=a.map(function(a){var c,e=a.decodedMsg,f=a.receiveFlow;a=a.stanza;var g=a.message.decrypted,h=d("MAWXMALoggingUtils").getXmaTargetTypeStringFromEnum(e==null?void 0:e.xmaTargetTypeForLogging);f.addAnnotations({bool:{furuteproof:(e==null?void 0:(c=e.unstoredDbMsg)==null?void 0:c.type)===d("MAWMsgType").MSG_TYPE.FUTUREPROOF},"int":{xmaTargetType:(c=e==null?void 0:e.xmaTargetTypeForLogging)!=null?c:-1},string:{contentType:(c=e==null?void 0:e.contentTypeForLogging)!=null?c:"",xmaTargetTypeString:h}});if(d("MAWXMAUtils").isRtcXMA(e==null?void 0:(c=e.unstoredXMA)==null?void 0:(h=c.unstoredDbXMA)==null?void 0:h.targetType)){f.endFail("rtc_xma_not_supported");b.add(a.stanzaQueueId);return null}if(g.type==="InstamadilloMsg"){f.endFail("instamadillo_not_supported");b.add(a.stanzaQueueId);return null}if(g.type==="InvisibleMsg"){b.add(a.stanzaQueueId);return null}return{msgData:g,receiveFlow:f,unstoredContent:e}}).filter(Boolean);c("MAWHIMLogger").LOG(j(),e.length);return d("MAWBulkHandleIncomingMsgApi").bulkHandleIncomingMsgs(e).then(function(d){var f=d.msgResults;c("MAWHIMLogger").LOG(i(),e.length);a.map(function(a){a=a.stanza;var d=f.get(a.message.decrypted.id);if(d==null){b.has(a.stanzaQueueId)||c("MAWHIMLogger").ERROR(h());return}d.success===!0&&b.add(a.stanzaQueueId)});return{followUpParams:{incomingMsgResults:f,incomingMsgs:a},toAck:Array.from(b)}})["catch"](function(b){var c="Not an Error instance",d="N/A";typeof b.message==="string"&&(c=b.message);typeof b.stack==="string"&&(d=b.stack);a.forEach(function(a){a.receiveFlow.endFail("consumer_handle_message_transaction_error",{string:{errorDescription:c,errorStack:d}})});throw b})}g.handleIncomingMessagesStanzas=a}),98);
__d("MAWProtocolQueueUtils",["MAWIncomingMsg","WAGetStorageQplAnnotations","WAHashStringToNumber","WAPREList","WAPREMetrics","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){b===void 0&&(b=d("WAPREList").PRE_METRIC.RECEIVE_MESSAGE);var e=a.stanza,f=d("WAPREMetrics").startMetric(b,d("MAWIncomingMsg").prepareAnnotationsForIncomingMessage({incomingType:e.incomingType,msg:e.message.details,queueType:e.message.details.offline!=null?"offline":"online",retryCount:e.message.details.retryCount}),d("WAHashStringToNumber").hashStringToNumber(e.stanzaId.toString()),d("WAPREMetrics").QPL_RECEIVE_MESSAGE_TIMEOUT_IN_MS);c("promiseDone")(d("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(a){f.addAnnotations(a)}));f.addPoint("consumer_handle_message_stanza_start");return babelHelpers["extends"]({},a,{receiveFlow:f})}function a(a){return h({decodedMsg:void 0,stanza:a})}g.addMetricToMessage=h;g.addMetricToProtocolMessage=a}),98);
__d("MAWSharedCOPLogger",["WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";a=d("WATagsLogger").TAGS(["COP"]);g["default"]=a}),98);