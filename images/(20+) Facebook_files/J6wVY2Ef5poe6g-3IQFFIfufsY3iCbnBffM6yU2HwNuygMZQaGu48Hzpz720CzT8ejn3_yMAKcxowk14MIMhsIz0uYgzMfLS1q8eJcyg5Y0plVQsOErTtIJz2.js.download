;/*FB_PKG_DELIM*/

__d("EchoBackupCompareUtils",[],(function(a,b,c,d,e,f){"use strict";function a(a){var b;return{contentSubtype:a.contentSubtype,contentType:a.contentType,reactionTsList:(b=a.reactionAuthoritativeTimestampMs)==null?void 0:b.map(function(a){return a.displayName==null?null:Number(a.displayName)/1e3}).filter(Boolean).sort(),receiptTsList:(b=a.receiptStatusList)==null?void 0:b.map(function(a){return a.timestampMs==null?null:a.timestampMs/1e3}).filter(Boolean).sort()}}function g(a,b){if(a==null&&b==null)return!0;if(a!=null&&b!=null)return a.length===b.length&&a.every(function(a,c){return a===b[c]});return a==null&&(b==null?void 0:b.length)===0||b==null&&(a==null?void 0:a.length)===0?!0:!1}function b(a,b){return b!=null&&a.contentSubtype===b.contentSubtype&&a.contentType===b.contentType&&g(a.reactionTsList,b.reactionTsList)}f.buildEchoDocCacheValue=a;f.echoEquals=b}),66);
__d("EchoConstants",[],(function(a,b,c,d,e,f){"use strict";a=new Set(["\0","\x01","\x02","\x03","\x04","\x05","\x06","\x07","\b","\t","\n","\v","\f","\r","\x0e","\x0f","\x10","\x11","\x12","\x13","\x14","\x15","\x16","\x17","\x18","\x19","\x1a","\x1b","\x1c","\x1d","\x1e","\x1f",'"'," ","(",")",",",":",";","<",">","@","[","]","\\"]);f.ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE=a}),66);
__d("EchoEncodingUtils",["EchoConstants","EchoMessage","MAWMsgType","WABase64","unrecoverableViolation"],(function(a,b,c,d,e,f,g){"use strict";var h=new Set(['"',"\\","\n","\r","\0"]),i=new Set(["\0","\x01","\x02","\x03","\x04","\x05","\x06","\x07","\b","\t","\n","\v","\f","\r","\x0e","\x0f","\x10","\x11","\x12","\x13","\x14","\x15","\x16","\x17","\x18","\x19","\x1a","\x1b","\x1c","\x1d","\x1e","\x1f",'"',"\\"]);function j(a,b){for(var b=b,c=Array.isArray(b),d=0,b=c?b:b[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var e;if(c){if(d>=b.length)break;e=b[d++]}else{d=b.next();if(d.done)break;e=d.value}e=e;if(a.indexOf(e)>=0)return!0}return!1}function k(a,b,d){d===void 0&&(d=new Set());if(a.length<=0)throw c("unrecoverableViolation")("The input string must be non-empty","labyrinth_web");var e=b;b==="conditional"&&(j(a,d)?e="always":e="never");if(e==="never")return a;b='"';for(d=0;d<a.length;d++){e=a[d];h.has(e)?(b+="\\",e==="\r"?b+="r":e==="\n"?b+="n":b+=e):b+=e}return b+'"'}function l(a){if(!Number.isSafeInteger(a))throw c("unrecoverableViolation")("The input value must be a safe integer","labyrinth_web");return a.toString()}function m(a){var b="",c=a.displayName,e=a.localKey;a=a.transportKey;c!=null&&c.length>0&&(b+=k(c,"always")+" <");b+=k(e,"conditional",d("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE)+"@"+a;c!=null&&c.length>0&&(b+=">");return b}function n(a,b,c){c!=null&&c.length!==0&&a.set(b,k(c,"conditional",i))}function a(a,b,c){if(c!=null){c=l(c);n(a,b,c)}}function b(a,b,c){if(c!=null){c=l(c?1:0);n(a,b,c)}}function e(a,b,c){c!=null&&a.set(b,m(c))}function f(a,b,c){if(c!=null){var d="";c.forEach(function(a,b){d+=m(a),b<c.length-1&&(d+=", ")});a.set(b,d)}}function o(a){var b="";a.forEach(function(a,c){b=b+c+": "+a+"\r\n"});return b}function p(a){return d("WABase64").encodeB64UrlSafe(a)}function q(a){switch(a){case d("MAWMsgType").MSG_TYPE.TEXT:return d("EchoMessage").EchoXMessageContentType.TEXT;case d("MAWMsgType").MSG_TYPE.IMAGE:return d("EchoMessage").EchoXMessageContentType.IMAGE;case d("MAWMsgType").MSG_TYPE.VIDEO:return d("EchoMessage").EchoXMessageContentType.VIDEO;case d("MAWMsgType").MSG_TYPE.PTT:return d("EchoMessage").EchoXMessageContentType.AUDIO;case d("MAWMsgType").MSG_TYPE.STICKER:return d("EchoMessage").EchoXMessageContentType.STICKER;case d("MAWMsgType").MSG_TYPE.GIF:return d("EchoMessage").EchoXMessageContentType.GIF;case d("MAWMsgType").MSG_TYPE.XMA:return d("EchoMessage").EchoXMessageContentType.XMA;case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return d("EchoMessage").EchoXMessageContentType.DOCUMENT;case d("MAWMsgType").MSG_TYPE.REACTION:return d("EchoMessage").EchoXMessageContentType.REACTION;case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return d("EchoMessage").EchoXMessageContentType.EPHEMERAL_SETTINGS;case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:return d("EchoMessage").EchoXMessageContentType.EPHEMERAL_SYNC_RESPONSE;case d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:return d("EchoMessage").EchoXMessageContentType.MESSAGE_DELETE_FOR_ME;case d("MAWMsgType").MSG_TYPE.REVOKED:return d("EchoMessage").EchoXMessageContentType.UNSEND;case d("MAWMsgType").MSG_TYPE.GROUP_INVITE:return d("EchoMessage").EchoXMessageContentType.GROUP_INVITES;case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return d("EchoMessage").EchoXMessageContentType.BUMP;default:return d("EchoMessage").EchoXMessageContentType.UNKNOWN}}function r(a){if(a==null)return void 0;switch(a){case d("EchoMessage").EchoXMessageContentType.TEXT:return d("MAWMsgType").MSG_TYPE.TEXT;case d("EchoMessage").EchoXMessageContentType.IMAGE:return d("MAWMsgType").MSG_TYPE.IMAGE;case d("EchoMessage").EchoXMessageContentType.VIDEO:return d("MAWMsgType").MSG_TYPE.VIDEO;case d("EchoMessage").EchoXMessageContentType.AUDIO:return d("MAWMsgType").MSG_TYPE.PTT;case d("EchoMessage").EchoXMessageContentType.STICKER:return d("MAWMsgType").MSG_TYPE.STICKER;case d("EchoMessage").EchoXMessageContentType.GIF:return d("MAWMsgType").MSG_TYPE.GIF;case d("EchoMessage").EchoXMessageContentType.XMA:return d("MAWMsgType").MSG_TYPE.XMA;case d("EchoMessage").EchoXMessageContentType.DOCUMENT:return d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE;case d("EchoMessage").EchoXMessageContentType.REACTION:return d("MAWMsgType").MSG_TYPE.REACTION;case d("EchoMessage").EchoXMessageContentType.EPHEMERAL_SETTINGS:return d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN;case d("EchoMessage").EchoXMessageContentType.EPHEMERAL_SYNC_RESPONSE:return d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE;case d("EchoMessage").EchoXMessageContentType.MESSAGE_DELETE_FOR_ME:return d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME;case d("EchoMessage").EchoXMessageContentType.UNSEND:return d("MAWMsgType").MSG_TYPE.REVOKED;case d("EchoMessage").EchoXMessageContentType.GROUP_INVITES:return d("MAWMsgType").MSG_TYPE.GROUP_INVITE;case d("EchoMessage").EchoXMessageContentType.BUMP:return d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE;default:return void 0}}g.echoSetStringField=n;g.echoSetIntField=a;g.echoSetBooleanField=b;g.echoSetAddressField=e;g.echoSetAddressListField=f;g.echoEncodeFields=o;g.convertMediaKeyToString=p;g.convertDbMsgTypeToXMessageContentType=q;g.convertXMessageContentTypeToDbMsgType=r}),98);
__d("EchoCommonUtils",[],(function(a,b,c,d,e,f){"use strict";c="Echo-Doc-Version";function a(a,b){var c=a.localKey;a=a.transportKey;return c+"@"+a+"-"+b}function b(a,b,c){return a==null?{localKey:b,transportKey:c}:{displayName:a,localKey:b,transportKey:c}}f.ECHO_COMMON_FIELD_DOCUMENT_VERSION=c;f.getEchoAddressFieldNameWithSuffix=a;f.craftEchoAddress=b}),66);
__d("EchoDecodingUtils",["invariant","EchoConstants","WALogger"],(function(a,b,c,d,e,f,g,h){"use strict";function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] "," not a valid number in echo message"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Fail to decode if the input string does not have CRLF"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Address  decode failed with value: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid input to echoDecodeAddressList detected"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid transportKey in address detected"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid localKey in address detected"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] parse localKey in address failed"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] echoDecodeAddress failed"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] conditional quote mode decode failed"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid input to echoDecodeAddress"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Fail decoding because we didn't have a closing quote. Error Field: ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Field name is blank"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] This is a raw line and we cannot decode its field name and value."]);u=function(){return a};return a}var v=new Set([]);function w(a,b){if(a.length===0)return;var c=a.indexOf(":");if(c===-1){d("WALogger").ERROR(u());return}var e=a.substring(0,c).trim();a=a.substring(c+1).trim();if(e.length===0){d("WALogger").ERROR(t());return}if(a.length===0){b.has(e)&&b["delete"](e);return}b.set(e,a)}function x(a,b,c,e){c===void 0&&(c=new Set());var f=!1,g=b==="conditional"&&a[0]==='"',h="",i=g?1:0;while(i<a.length){var j=a[i];if(b==="conditional"&&!g&&j==='"')break;if(!g&&c.has(j))break;if(g&&!f&&j==='"'){g=!1;i++;break}if(g&&!f&&j==="\\"){if(i===a.length-1)break;f=!0}else f&&j==="r"?h+="\r":f&&j==="n"?h+="\n":h+=j,f=!1;i++}if(g||h.length===0){c=(j=e)!=null?j:"unknown";d("WALogger").ERROR(s(),c);return{remainder:a,result:null,success:!1}}return{remainder:a.substring(i),result:h,success:!0}}function y(a,b){if(a.length===0){d("WALogger").ERROR(r());return{remainder:a,result:null,success:!1}}var c=a.trimLeft();c=x(c,"conditional",d("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,b);if(!c.success){d("WALogger").ERROR(q());return{remainder:a,result:null,success:!1}}c.result!=null||h(0,47923);if(c.remainder[0]==="@"){var e=z(c.remainder,c.result,b);return{remainder:e.remainder,result:e.result,success:e.success}}e=c.result;c=c.remainder.trimLeft();if(c.startsWith("<")){c=z(c.substring(1),void 0,b);b=c.result;var f=c.remainder;if(c.success&&b!=null&&f.startsWith(">"))if(e.length===0)return{remainder:f.substring(1),result:b,success:!0};else return{remainder:f.substring(1),result:babelHelpers["extends"]({},b,{displayName:e}),success:!0}}d("WALogger").ERROR(p());return{remainder:a,result:null,success:!1}}function z(a,b,c){var e=b==null?a.trimLeft():a;b=b;if(b==null){var f=x(e,"conditional",d("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,c);if(!f.success){d("WALogger").ERROR(o());return{remainder:a,result:null,success:!1}}b=f.result;e=f.remainder}if(b==null||b.length===0||e[0]!=="@"){d("WALogger").ERROR(n());return{remainder:a,result:null,success:!1}}f=x(e.substring(1),"never",d("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,c);e=f.result;if(f.success&&e!=null&&e.length>0)return{remainder:f.remainder,result:{localKey:b,transportKey:e},success:!0};else{d("WALogger").ERROR(m());return{remainder:a,result:null,success:!1}}}function A(a,b){if(a.length===0){d("WALogger").ERROR(l());return{result:null,success:!1}}var c=y(a,b);if(!c.success){d("WALogger").ERROR(k(),a);return{result:null,success:!1}}c.result!=null||h(0,47927);a=[c.result];c=c.remainder;while(c.startsWith(",")){var e=y(c.substring(1).trimLeft(),b);if(e.success)e.result!=null&&a.push(e.result),c=e.remainder;else break}return{result:a,success:!0}}function a(a){var b=new Map(),c=a.split("\r\n");if(c.length===1&&c[0]===a){d("WALogger").ERROR(j());return b}c.forEach(function(a){return w(a,b)});return b}function b(a,b){a=a.get(b);if(a==null||a.length===0||a==='""')return{result:null,success:!1};a=x(a,"conditional",v,b);b=a.result;a=a.success;return{result:b,success:a}}function c(a,b){a=B(a,b);return{result:(b=a.result)!=null?b:0,success:a.success}}function B(a,b){a=a.get(b);if(a==null||a.length===0)return{result:null,success:!1};a=parseInt(a,10);if(isNaN(a)){d("WALogger").ERROR(i(),b);return{result:null,success:!1}}else return Number.isSafeInteger(a)?{result:a,success:!0}:{result:a>Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER,success:!0}}function e(a,b){a=C(a,b);return{result:(b=a.result)!=null?b:!1,success:a.success}}function C(a,b){a=B(a,b);return!a.success||a.result!==0&&a.result!==1?{result:null,success:!1}:{result:a.result===1,success:!0}}function f(a,b){a=a.get(b);if(a==null||a.length===0)return{result:null,success:!1};a=y(a,b);b=a.result;a=a.success;return{result:b,success:a}}function D(a,b){a=a.get(b);return a==null||a.length===0?{result:null,success:!1}:A(a,b)}function E(a,b){a=a.get(b);if(a==null||a.length===0)return{result:null,success:!1};b=a.split(",").map(function(a){return a.trim()}).filter(Boolean);return b.length===0?{result:null,success:!1}:{result:b,success:!0}}g.echoDecodeFields=a;g.echoDecodeStringField=b;g.echoDecodeIntField=c;g.echoDecodeNullableIntField=B;g.echoDecodeBooleanField=e;g.echoDecodeNullableBooleanField=C;g.echoDecodeAddressField=f;g.echoDecodeAddressListField=D;g.echoDecodeObjectIdListField=E}),98);
__d("EchoMessage",["$InternalEnum","EchoCommonUtils","EchoDecodingUtils","EchoEncodingUtils","EchoMessageMediaFieldUtils","EchoMessageMediaGroupFieldUtil","EchoMessageQuoteFieldUtils","EchoMessageReceiptStatusFieldUtils","EchoMessageXMAFieldUtils","FBLogger","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mandatory xma data is missing from xma message, msgId: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fieldsMap is empty for the echo message"]);m=function(){return a};return a}var n="Message-ID",o="Thread-ID",p="Sort-Order",q="Display-Timestamp",r="Authoritative-Timestamp",s="From",t="Text",u="Text-Size",v="Send-Error",w="Is-Tombstoned",x="Expire-Timestamp",y="Delete-Timestamp",z="Ephemeral-Duration",A="Message-Content-Type",B="X-Message-Content-Type",C="Message-Content-Subtype",D="Is-Forwarded",E="X-Offline-Threading-ID",F="X-Thread-ID",G="X-Message-Placeholder-Type",H="Reactions",I="Reaction-Authoritative-Timestamps",J="X-Reaction-Offline-Threading-IDs",K="Echo-Serialization-Origin",L="Revoke-Sent-Timestamp",M="Revoke-Unsent-Timestamp",N="Edit-Count",O="Edit-Contents-",P="Edit-Timestamps-";f="Group-ID";var Q="Group-Index",R="Group-Size",S=1,T=(b=b("$InternalEnum"))({NONE:"none",SMALL:"small",MEDIUM:"medium",LARGE:"large"}),U=b({NONE:"none",UNSEND:"unsend"}),V=b({DECRYPTION_FAILURE:"decryption_failure",UNSUPPORTED_NEEDS_UPDATE:"unsupported_needs_update",TEXT:"text",ADMIN_MESSAGE:"admin_message",MEDIA:"media",XMA:"xma",NULL_STATE:"null_state",PLACEHOLDER:"placeholder"}),W=b({UNKNOWN:"unknown",TEXT:"text",IMAGE:"image",VIDEO:"video",AUDIO:"audio",STICKER:"sticker",GIF:"gif",URL:"url",EPHEMERAL_SETTINGS:"ephemeral_settings",LOCATION:"location",DOCUMENT:"document",UNSEND:"unsend",SCREENSHOT_ACTION:"screenshot_action",REACTION:"reaction",XMA:"xma",VISUAL_MESSAGE_VIDEO:"visual_message_video",VISUAL_MESSAGE_IMAGE:"visual_message_image",VISUAL_MESSAGE_ACTION:"visual_message_action",SCREEN_RECORDING_ACTION:"screen_recording_action",MESSAGE_DELETE_FOR_ME:"message_delete_for_me",ENCRYPTED_BACKUP_NEW_DEVICE_ENROLLMENT:"encrypted_backup_new_device_enrollment",SENDER_KEY:"sender_key",DELETE_THREAD:"delete_thread",READ_THREAD:"read_thread",UNREAD_THREAD:"unread_thread",REACTION_UNSEND:"reaction_unsend",GROUP_INVITES:"group_invites",EPHEMERAL_SYNC_RESPONSE:"ephemeral_sync_response",BUMP:"bump"}),X=b({NO_PLACEHOLDER:"0",DECRYPTION_FAILURE:"-1",CLIENT_NOT_SUPPORTED_NEED_UPDATE:"-2",UNAVIALABLE_DEVICE:"-3"}),Y=b({UNKNOWN:"Unknown",WEB:"Web",MOBILE:"Mobile"});function a(a){var b=new Map();fa(b,a);"mediaData"in a&&a.mediaData&&d("EchoMessageMediaFieldUtils").echoMessageSetMediaMetadataFields(b,a.mediaData);return d("EchoEncodingUtils").echoEncodeFields(b)}function Z(a,b){var c,e=[],f=new Set();b.forEach(function(c,g,h){c=g.startsWith(O);h=g.startsWith(P);if(c||h){h=g.slice(c?O.length:P.length);if(!f.has(h)){f.add(h);c=(g=d("EchoDecodingUtils").echoDecodeStringField(b,""+O+h).result)!=null?g:"";g=((g=d("EchoDecodingUtils").echoDecodeIntField(b,""+P+h).result)!=null?g:0)/1e3;e.push({messageId:h,originalMessageId:a,text:c,timestamp:g})}}});c=(c=d("EchoDecodingUtils").echoDecodeIntField(b,N).result)!=null?c:0;return{editCount:c,editHistory:e}}function e(a){a=d("EchoDecodingUtils").echoDecodeFields(a);if(a.size===0){d("WALogger").ERROR(m());return null}var b=d("EchoDecodingUtils").echoDecodeStringField(a,n),e=d("EchoDecodingUtils").echoDecodeStringField(a,o),f=d("EchoDecodingUtils").echoDecodeIntField(a,p),g=d("EchoDecodingUtils").echoDecodeIntField(a,q),N=d("EchoDecodingUtils").echoDecodeStringField(a,A),O=d("EchoDecodingUtils").echoDecodeStringField(a,B),P=d("EchoDecodingUtils").echoDecodeStringField(a,C);if(b.success&&e.success&&f.success){b=b.result;if(b==null)throw c("FBLogger")("messenger_e2ee_web").mustfixThrow("The decoded messageId cannot be null");e=e.result;if(e==null)throw c("FBLogger")("messenger_e2ee_web").mustfixThrow("The decoded threadId cannot be null");N=N==null?void 0:N.result;if(N==null)throw c("FBLogger")("messenger_e2ee_web").mustfixThrow("The decoded contentTypeString cannot be null");var Q=Z(b,a),R=Q.editCount;Q=Q.editHistory;P={contentSubtype:ca(P.result),contentType:aa(N),displayTimestampMs:g.success?g.result:f.result,editCount:R,editHistory:Q,messageId:b,sortOrderMs:f.result,threadId:e};N=ba(O.result);N!=null&&(P.xContentType=N);g=d("EchoDecodingUtils").echoDecodeAddressField(a,s);g.success&&g.result!=null&&(P.from=g.result);R=d("EchoDecodingUtils").echoDecodeNullableBooleanField(a,w);R.success&&R.result!=null&&(P.isTombstoned=R.result);Q=d("EchoDecodingUtils").echoDecodeStringField(a,t);Q.success&&Q.result!=null&&(P.text=Q.result);b=d("EchoDecodingUtils").echoDecodeStringField(a,u);if(b.success&&b.result!=null){f=$(b.result);P.textSize=f}e=d("EchoDecodingUtils").echoDecodeStringField(a,G);if(e.success&&e.result!=null){O=da(e.result);P.xMessagePlaceholderType=O}N=d("EchoDecodingUtils").echoDecodeStringField(a,v);N.success&&N.result!=null&&(P.sendError=N.result);g=d("EchoDecodingUtils").echoDecodeNullableIntField(a,x);g.success&&g.result!=null&&(P.expireTimestampMs=g.result);R=d("EchoDecodingUtils").echoDecodeNullableIntField(a,y);R.success&&R.result!=null&&(P.deleteTimestampMs=R.result);Q=d("EchoDecodingUtils").echoDecodeNullableIntField(a,z);Q.success&&Q.result!=null&&(P.ephemeralDurationInSec=Q.result);b=d("EchoDecodingUtils").echoDecodeNullableIntField(a,r);b.success&&b.result!=null&&(P.authoritativeTimestampMs=b.result);f=d("EchoMessageReceiptStatusFieldUtils").echoMessageDecodeReceiptStatusDataFields(a);f.length>0&&(P.receiptStatusList=f);e=d("EchoDecodingUtils").echoDecodeNullableBooleanField(a,D);e.success&&e.result!=null&&(P.isForwarded=e.result);d("EchoMessageMediaGroupFieldUtil").decodeMessageMediaGroupFields(a,P);O=d("EchoDecodingUtils").echoDecodeStringField(a,E);O.success&&O.result!=null&&(P.xOfflineThreadingId=O.result);N=d("EchoDecodingUtils").echoDecodeStringField(a,F);N.success&&N.result!=null&&(P.xThreadId=N.result);g=d("EchoDecodingUtils").echoDecodeStringField(a,K);g.success&&g.result!=null&&(P.serializationOrigin=ea(g.result));R=d("EchoDecodingUtils").echoDecodeNullableIntField(a,d("EchoCommonUtils").ECHO_COMMON_FIELD_DOCUMENT_VERSION);P.version=R.success&&R.result!=null?R.result:S;Q=d("EchoDecodingUtils").echoDecodeAddressListField(a,H);Q.success&&Q.result!=null&&(P.reactions=Q.result);b=d("EchoDecodingUtils").echoDecodeAddressListField(a,I);b.success&&b.result!=null&&(P.reactionAuthoritativeTimestampMs=b.result);f=d("EchoDecodingUtils").echoDecodeAddressListField(a,J);f.success&&f.result!=null&&(P.reactionXOfflineThreadingIds=f.result);e=d("EchoMessageQuoteFieldUtils").echoMessageDecodeQuoteFields(a);e!=null&&(P.quoteData=e);O=(P==null?void 0:P.contentType)===V.XMA&&a.has(d("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_TYPE)&&(a.has(d("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_ID)||a.has(d("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_IDS));if((P==null?void 0:P.contentType)===V.MEDIA||O){N=d("EchoMessageMediaFieldUtils").echoMessageDecodeMediaDataFields(a,P==null?void 0:P.contentType,P==null?void 0:P.xContentType);g="[labyrinth_web] mandatory media data is missing from media message, msgId: "+P.messageId+".";N!=null?(N.length!==1&&N.length!==2&&((P==null?void 0:P.contentType)===V.MEDIA&&d("WALogger").ERROR(l(),g,P.serializationOrigin),(P==null?void 0:P.contentType)===V.XMA&&d("WALogger").WARN(k(),g,P.serializationOrigin)),P.mediaData=N[0],N.length===2&&(P.previewMediaData=N[1])):((P==null?void 0:P.contentType)===V.MEDIA&&d("WALogger").ERROR(j(),g,P.serializationOrigin),(P==null?void 0:P.contentType)===V.XMA&&d("WALogger").WARN(i(),g,P.serializationOrigin))}if(P.contentType===V.PLACEHOLDER&&P.contentSubtype===U.UNSEND){R=d("EchoDecodingUtils").echoDecodeNullableIntField(a,L);R.success&&R.result!=null&&(P.revokeSentTimestampMs=R.result);Q=d("EchoDecodingUtils").echoDecodeNullableIntField(a,M);Q.success&&Q.result!=null&&(P.revokeUnsentTimestampMS=Q.result)}if(P.contentType===V.XMA){b=d("EchoMessageXMAFieldUtils").decodeXMAFields(a);if(b!=null)P.xmaData=b;else{d("WALogger").ERROR(h(),P.messageId);return null}}return P}else return null}function $(a){return(a=T.cast(a))!=null?a:T.NONE}function aa(a){return(a=V.cast(a))!=null?a:V.TEXT}function ba(a){return W.cast(a)}function ca(a){return(a=U.cast(a))!=null?a:U.NONE}function da(a){return(a=X.cast(a))!=null?a:X.NO_PLACEHOLDER}function ea(a){return(a=Y.cast(a))!=null?a:Y.UNKNOWN}function fa(a,b){var c;(c=d("EchoEncodingUtils")).echoSetStringField(a,n,b.messageId);c.echoSetStringField(a,o,b.threadId);c.echoSetIntField(a,p,b.sortOrderMs);c.echoSetIntField(a,q,b.displayTimestampMs);c.echoSetIntField(a,r,b.authoritativeTimestampMs);c.echoSetAddressField(a,s,b.from);c.echoSetStringField(a,t,b.text);b.textSize!=null&&d("EchoEncodingUtils").echoSetStringField(a,u,b.textSize);b.xMessagePlaceholderType!=null&&d("EchoEncodingUtils").echoSetStringField(a,G,b.xMessagePlaceholderType);d("EchoEncodingUtils").echoSetStringField(a,v,b.sendError);d("EchoEncodingUtils").echoSetBooleanField(a,w,b.isTombstoned);d("EchoEncodingUtils").echoSetIntField(a,x,b.expireTimestampMs);d("EchoEncodingUtils").echoSetIntField(a,y,b.deleteTimestampMs);d("EchoEncodingUtils").echoSetIntField(a,z,b.ephemeralDurationInSec);b.contentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,A,b.contentType);b.xContentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,B,b.xContentType);d("EchoMessageReceiptStatusFieldUtils").echoMessageSetReceiptStatusDataFields(a,b.receiptStatusList);d("EchoEncodingUtils").echoSetBooleanField(a,D,b.isForwarded);d("EchoEncodingUtils").echoSetStringField(a,E,b.xOfflineThreadingId);d("EchoEncodingUtils").echoSetStringField(a,F,b.xThreadId);d("EchoEncodingUtils").echoSetIntField(a,d("EchoCommonUtils").ECHO_COMMON_FIELD_DOCUMENT_VERSION,b.version);b.contentSubtype!=null&&d("EchoEncodingUtils").echoSetStringField(a,C,b.contentSubtype);d("EchoEncodingUtils").echoSetAddressListField(a,H,b.reactions);d("EchoEncodingUtils").echoSetAddressListField(a,I,b.reactionAuthoritativeTimestampMs);d("EchoEncodingUtils").echoSetAddressListField(a,J,b.reactionXOfflineThreadingIds);d("EchoMessageQuoteFieldUtils").echoMessageSetQuoteFields(a,b);b.serializationOrigin!=null&&d("EchoEncodingUtils").echoSetStringField(a,K,b.serializationOrigin);b.revokeSentTimestampMs!=null&&d("EchoEncodingUtils").echoSetIntField(a,L,b.revokeSentTimestampMs);b.revokeUnsentTimestampMS!=null&&d("EchoEncodingUtils").echoSetIntField(a,M,b.revokeUnsentTimestampMS);d("EchoMessageMediaGroupFieldUtil").echoMessageSetMediaGroupFields(a,b);c=b.xmaData;c!=null&&d("EchoMessageXMAFieldUtils").echoMessageSetXMAFields(a,c);((c=b.editHistory)==null?void 0:c.length)>0&&(d("EchoEncodingUtils").echoSetIntField(a,N,b.editCount),b.editHistory.forEach(function(b){var c=b.messageId;c!=null&&(d("EchoEncodingUtils").echoSetStringField(a,O+c,b.text),d("EchoEncodingUtils").echoSetIntField(a,P+c,b.timestamp*1e3))}))}g.ECHO_SERIALIZATION_ORIGIN=K;g.ECHO_MESSAGE_FIELD_NAME_EDIT_COUNT=N;g.ECHO_MESSAGE_FIELD_NAME_EDIT_CONTENT_PREFIX=O;g.ECHO_MESSAGE_FIELD_NAME_EDIT_TS_PREFIX=P;g.ECHO_MESSAGE_FIELD_GROUP_ID=f;g.ECHO_MESSAGE_FIELD_GROUP_INDEX=Q;g.ECHO_MESSAGE_FIELD_GROUP_SIZE=R;g.ECHO_MESSAGE_MIGRATION_DOCUMENT_VERSION=S;g.MessageTextSize=T;g.EchoMessageContentSubtype=U;g.EchoMessageContentType=V;g.EchoXMessageContentType=W;g.EchoMessagePlaceholderType=X;g.EchoSerializationOriginType=Y;g.encodeEchoMessage=a;g.decodeEchoMessage=e}),98);
__d("EchoMessageMediaFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils","EchoMessage","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid media attachment type: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] multi blob media message: can not parse objects ids. "," msgType: "," mediaType: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing enum fields from media fields: attachmentType: "," mediaPreviewContentType: "," mediaAttachmentType: "," EchoOrigin: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. AttachmentType: "," EchoOrigin: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. AttachmentType: "," EchoOrigin: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. xAttachmentType: ",", AttachmentType: ",". EchoOrigin: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to get primary and secondary attachment object ids"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] multi blob media message: primary attachment object id is null. msgType: "," mediaType: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xAttachmentType field from required media metadata fields"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xContentType field from required media metadata fields"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing plaintextHash field from required media metadata fields"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing direct path field from required media metadata fields"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing attachment type from required media metadata fields"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing attachment object id from required media metadata fields"]);u=function(){return a};return a}var v="X-Object-Id",w="X-Attachment-Object-Ids",x="Attachment-Type",y="Content-Type",z="X-Encrypted-Hash",A="X-Attachment-Type",B="X-Backup-Ent-Fbid",C="X-Backup-Status",D="X-Content-Type",E="X-Direct-Path",F="Height",G="X-Media-Key",H="X-Media-Key-Timestamp",I="Playable-Duration",J="Preview-Height",K="Preview-Content-Type",L="Preview-Width",M="Size",N="Width",O="X-Plaintext-Hash",P="File-Name",Q="Header-Attribution-Content-Type",R=(e=b("$InternalEnum"))({IMAGE:"image",STICKER:"sticker",VIDEO:"video",GIF:"animated_image",PTT:"audio",XMA:"xma",DOCUMENT:"document"}),S=e({IMAGE_JPEG:"image/jpeg",IMAGE_PNG:"image/png",STICKER:"image/webp",GIF:"image/gif",AUDIO_MP4:"audio/mp4",AUDIO_WAV:"audio/wav",XMA:"xma"}),T=e({INVALID:"-1",IMAGE:"0",PTT:"1",AUDIO:"2",DOCUMENT:"3",VIDEO:"4",GIF:"5",STICKER:"6",PROFILE_PICTURE:"7",APP_STATE:"8",HISTORY_SYNC:"9",THUMBNAIL_IMAGE:"10",THUMBNAIL_VIDEO:"11",THUMBNAIL_GIF:"12",THUMBNAIL_DOCUMENT:"13",THUMBNAIL_LINK:"14",NOVI_IMAGE:"15",NOVI_VIDEO:"16",KYCID:"17",WAFFLE_IMAGE:"18",WAFFLE_VIDEO:"19",WAFFLE_GIF:"20",PAYMENT_BG_IMAGE:"21",XMA_IMAGE:"22",PAYMENT_BR_DOCUMENT:"23",BIZ_COVER_PHOTO:"24",MESSENGER_PREVIEW:"25"}),U=e({FULL:"full",PREVIEW:"preview"});function V(a){var b=a.attachmentObjectId,c=a.attachmentType,e=a.backupEntFbid,f=a.directPath,g=a.filename,h=a.encryptedHash,i=a.height,j=a.mediaBackupStatus,k=a.mediaContentType,l=a.mediaKey,m=a.mediaKeyTimestamp,n=a.mediaPlayableDuration,o=a.plaintextHash,v=a.previewContentHeight,w=a.previewContentType,x=a.previewContentWidth,y=a.size,z=a.width,A=a.xAttachmentType,B=a.xContentType;a=a.xmaData;if(b==null)d("WALogger").ERROR(u());else if(c==null)d("WALogger").ERROR(t());else if(f==null)d("WALogger").ERROR(s());else if(o==null)d("WALogger").ERROR(r());else if(B==null)d("WALogger").ERROR(q());else if(A==null)d("WALogger").ERROR(p());else return{attachmentObjectId:b,attachmentType:c,backupEntFbid:e,directPath:f,encryptedHash:h,filename:g,height:i,mediaBackupStatus:j,mediaContentType:k,mediaKey:l,mediaKeyTimestamp:m,mediaPlayableDuration:n,plaintextHash:o,previewContentHeight:v,previewContentType:w,previewContentWidth:x,size:y,width:z,xAttachmentType:A,xContentType:B,xmaData:a}}function a(a,b){var c;(c=d("EchoEncodingUtils")).echoSetStringField(a,v,b.attachmentObjectId);c.echoSetStringField(a,x,b.attachmentType);c.echoSetStringField(a,O,b.plaintextHash);c.echoSetStringField(a,z,b.encryptedHash);c.echoSetIntField(a,M,b.size);c.echoSetStringField(a,G,b.mediaKey);c.echoSetIntField(a,H,b.mediaKeyTimestamp);c.echoSetStringField(a,E,b.directPath);b.mediaContentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,y,b.mediaContentType);d("EchoEncodingUtils").echoSetIntField(a,N,b.width);d("EchoEncodingUtils").echoSetIntField(a,F,b.height);b.previewContentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,K,b.previewContentType);b.headerAttributionContentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,Q,b.headerAttributionContentType);d("EchoEncodingUtils").echoSetIntField(a,L,b.previewContentWidth);d("EchoEncodingUtils").echoSetIntField(a,J,b.previewContentHeight);d("EchoEncodingUtils").echoSetIntField(a,I,b.mediaPlayableDuration);b.xAttachmentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,A,b.xAttachmentType);d("EchoEncodingUtils").echoSetStringField(a,D,b.xContentType);d("EchoEncodingUtils").echoSetStringField(a,B,b.backupEntFbid);d("EchoEncodingUtils").echoSetStringField(a,C,b.mediaBackupStatus);d("EchoEncodingUtils").echoSetStringField(a,P,b.filename)}function c(a,b,c){var e={},f=!1,g=!1,h=!1;if(aa(a)){var i=$(a,b,c);if(i==null){d("WALogger").ERROR(o(),b,c);return null}i.length!==2&&d("WALogger").ERROR(n());c=!1;var j=!1,k=i[0];i=i[1];var l={};f=Y(a,e,k);c=Y(a,l,i);g=X(a,e,b,k,k);j=X(a,l,b,i,k);h=W(a,e,k);k=W(a,l,i);if(!f||!g||!h||!c||!j||!k)return null;i=V(e);c=V(l);if(i!=null&&c!=null)return[i,c]}else{f=Y(a,e);g=X(a,e,b);h=W(a,e);if(!f||!g||!h)return null;j=V(e);if(j!=null)return[j]}return null}function W(a,b,c){var e;e=(e=a.get(d("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?e:"";c=[{fieldName:"height",id:F},{fieldName:"width",id:N},{fieldName:"size",id:M},{fieldName:"previewContentHeight",id:J},{fieldName:"previewContentWidth",id:L},{fieldName:"mediaKeyTimestamp",id:c!=null?c+"-"+H:H}];var f=[{attachmentTypes:[T.VIDEO,T.AUDIO],fieldName:"mediaPlayableDuration",id:I}];for(var g=0;g<f.length;g++){var h=f[g],i=h.attachmentTypes,j=h.fieldName;h=h.id;h=d("EchoDecodingUtils").echoDecodeIntField(a,h);var k=h.result;h=h.success;if(h&&k!=null)b[j]=k;else if(!(b.xAttachmentType!=null&&!Z(i,b.xAttachmentType)||b.attachmentType===R.XMA)){d("WALogger").ERROR(m(),j,b.xAttachmentType,b.attachmentType,e);return!1}}c.map(function(f){var c=f.fieldName;f=f.id;f=d("EchoDecodingUtils").echoDecodeIntField(a,f);var e=f.result;f=f.success;f&&e!=null&&(b[c]=e)});return!0}function X(a,b,c,e,f){var g,h,i;g=(g=a.get(d("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?g:"";var j=[{fieldName:"filename",id:P}];e!=null&&f!=null?(b.attachmentObjectId=e,h=[{fieldName:"plaintextHash",id:e+"-"+O},{fieldName:"directPath",id:e+"-"+E},{fieldName:"xContentType",id:e+"-"+D}],j.push({fieldName:"mediaKey",id:e+"-"+G}),i=f+"-"+B,e=e+"-"+z):(h=[{fieldName:"attachmentObjectId",id:v},{fieldName:"plaintextHash",id:O},{fieldName:"directPath",id:E},{fieldName:"xContentType",id:D}],j.push({fieldName:"mediaKey",id:G}),i=B,e=z);j.push({fieldName:"backupEntFbid",id:i});j.push({fieldName:"mediaContentType",id:y});j.push({fieldName:"encryptedHash",id:e});i=f!=null?f+"-"+C:C;j.push({fieldName:"mediaBackupStatus",id:i});e=[];for(f=h,i=Array.isArray(f),h=0,f=i?f:f[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var m;if(i){if(h>=f.length)break;m=f[h++]}else{h=f.next();if(h.done)break;m=h.value}m=m;var n=m.fieldName;m=m.id;m=d("EchoDecodingUtils").echoDecodeStringField(a,m);var o=m.result;m=m.success;m&&o!=null?b[n]=o:e.push(n)}if(e.length>0){m=e.join(", ");c===d("EchoMessage").EchoMessageContentType.XMA?d("WALogger").WARN(l(),m,b.attachmentType,g):d("WALogger").ERROR(k(),m,b.attachmentType,g);return!1}j.map(function(f){var c=f.fieldName;f=f.id;f=d("EchoDecodingUtils").echoDecodeStringField(a,f);var e=f.result;f=f.success;f&&e!=null&&(b[c]=e)});return!0}function Y(a,b,c){var e;e=(e=a.get(d("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?e:"";var f=d("EchoDecodingUtils").echoDecodeStringField(a,x);f=f.result==="file"?R.DOCUMENT:R.cast(f.result);f!=null&&(b.attachmentType=f);var g=d("EchoDecodingUtils").echoDecodeStringField(a,K);g=S.cast(g.result);g!=null&&(b.previewContentType=g);var h=d("EchoDecodingUtils").echoDecodeStringField(a,Q);h=h.result;h!=null&&(b.headerAttributionContentType=h);h=d("EchoDecodingUtils").echoDecodeStringField(a,c!=null?c+"-"+A:A);h.success&&h.result!=null&&(a=ba(h.result),a!=null&&(b.xAttachmentType=a));if(f!=null&&(g!=null||f===R.DOCUMENT||f===R.PTT))return!0;else d("WALogger").ERROR(j(),f,g,h,e);return!1}function Z(a,b){return a.reduce(function(a,c){return a||c===b},!1)}function aa(a){return a.has(w)}function $(a,b,c){var e=d("EchoDecodingUtils").echoDecodeObjectIdListField(a,w),f=e.result;e=e.success;if(!e||f==null||f.length!==2){d("WALogger").ERROR(i(),f,b,c);return null}e=f.find(function(b){b=b+"-"+C;b=d("EchoDecodingUtils").echoDecodeStringField(a,b);var c=b.result;b=b.success;if(b&&c!=null)return!0});if(e!=null){b=e===f[0]?f[1]:f[0];return[e,b]}e=f.find(function(b){b=b+"-"+D;b=d("EchoDecodingUtils").echoDecodeStringField(a,b);var c=b.result;b=b.success;if(b&&c!=null&&U.cast(c)===U.FULL)return!0});if(e!=null){c=e===f[0]?f[1]:f[0];return[e,c]}return f}function ba(a){var b=T.cast(a);b==null&&d("WALogger").ERROR(h(),a);return(a=b)!=null?a:T.INVALID}g.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_ID=v;g.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_IDS=w;g.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_TYPE=x;g.AttachmentType=R;g.EchoMessageMediaPreviewType=S;g.EchoMessageActMediaAttachmentType=T;g.convertMediaMetadataDetailsToMediaMetadata=V;g.echoMessageSetMediaMetadataFields=a;g.echoMessageDecodeMediaDataFields=c;g.setMediaIntFields=W;g.setMediaEnumFields=Y;g.getAttachmentObjectIdsFromMultiBlobMediaMsg=$}),98);
__d("EchoMessageMediaGroupFieldUtil",["EchoDecodingUtils","EchoEncodingUtils","EchoMessage"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){b.groupId!=null&&d("EchoEncodingUtils").echoSetStringField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_ID,b.groupId),b.groupIndex!=null&&d("EchoEncodingUtils").echoSetIntField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_INDEX,b.groupIndex),b.groupSize!=null&&d("EchoEncodingUtils").echoSetIntField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_SIZE,b.groupSize)}function b(a,b){var c=d("EchoDecodingUtils").echoDecodeStringField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_ID);c.success&&c.result!=null&&(b.groupId=c.result);c=d("EchoDecodingUtils").echoDecodeIntField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_INDEX);c.success&&c.result!=null&&(b.groupIndex=c.result);c=d("EchoDecodingUtils").echoDecodeIntField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_SIZE);c.success&&c.result!=null&&(b.groupSize=c.result)}g.echoMessageSetMediaGroupFields=a;g.decodeMessageMediaGroupFields=b}),98);
__d("EchoMessageQuoteFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils"],(function(a,b,c,d,e,f,g){"use strict";var h="Reply-Message-Id",i="Reply-Message-Sender",j="Reply-Sort-Order",k="Reply-Type",l="Reply-Status",m=b("$InternalEnum").Mirrored(["BUMP"]),n=b("$InternalEnum")({VALID:"valid"});function a(a){var b={quoteMessageId:"<not set>",quoteMessageSender:{localKey:"<not set>",transportKey:"<not set>"},quoteSortOrderInMs:0},c=o(a,b),d=p(a,b),e=q(a,b);a=r(a,b);return!c||!d||!e||!a?null:b}function c(a,b){b=b.quoteData;if(b==null)return;d("EchoEncodingUtils").echoSetStringField(a,h,b.quoteMessageId);d("EchoEncodingUtils").echoSetAddressField(a,i,b.quoteMessageSender);d("EchoEncodingUtils").echoSetIntField(a,j,b.quoteSortOrderInMs);b.status!=null&&d("EchoEncodingUtils").echoSetStringField(a,l,b.status);b.replyType!=null&&d("EchoEncodingUtils").echoSetStringField(a,k,b.replyType)}function o(a,b){var c=[{fieldName:"quoteMessageSender",id:i}];for(var e=0;e<c.length;e++){var f=c[e],g=f.fieldName;f=f.id;f=d("EchoDecodingUtils").echoDecodeAddressField(a,f);var h=f.result;f=f.success;if(f&&h!=null)b[g]=h;else return!1}return!0}function p(a,b){var c=[{fieldName:"quoteMessageId",id:h}];for(var e=0;e<c.length;e++){var f=c[e],g=f.fieldName;f=f.id;f=d("EchoDecodingUtils").echoDecodeStringField(a,f);var i=f.result;f=f.success;if(f&&i!=null)b[g]=i;else return!1}return!0}function q(a,b){var c=[{fieldName:"quoteSortOrderInMs",id:j}];for(var e=0;e<c.length;e++){var f=c[e],g=f.fieldName;f=f.id;f=d("EchoDecodingUtils").echoDecodeIntField(a,f);var h=f.result;f=f.success;if(f&&h!=null)b[g]=h;else return!1}return!0}function r(a,b){var c=d("EchoDecodingUtils").echoDecodeStringField(a,k);c=m.cast(c.result);c!=null&&(b.replyType=c);c=d("EchoDecodingUtils").echoDecodeStringField(a,l);a=n.cast(c.result);a!=null&&(b.status=a);return!0}g.EchoMessageQuoteReplyType=m;g.EchoMessageQuoteStatus=n;g.echoMessageDecodeQuoteFields=a;g.echoMessageSetQuoteFields=c}),98);
__d("EchoMessageReceiptStatusFieldUtils",["$InternalEnum","EchoCommonUtils","EchoDecodingUtils","EchoEncodingUtils","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error occurred while decoding participants from echo doc, error: ",""]);h=function(){return a};return a}var i="Receipt-Status",j="Receipt-Timestamp",k=b("$InternalEnum")({UNKNOWN:"unknown",SENDING:"sending",SERVER_RECEIVED:"server_received",DELIVERED:"delivered",READ:"read",ERROR:"error",NON_RETRYABLE_ERROR:"non_retryable_error"});function a(a,b){if(b==null||b.length===0)return;b.forEach(function(b){d("EchoEncodingUtils").echoSetStringField(a,d("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(b.address,i),b.status),b.timestampMs!=null&&d("EchoEncodingUtils").echoSetIntField(a,d("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(b.address,j),b.timestampMs)})}function c(a){var b=[];l(a).forEach(function(c){var e=d("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(c,i);e=d("EchoDecodingUtils").echoDecodeStringField(a,e);if(e.success){e=(e=k.cast(e.result))!=null?e:k.UNKNOWN;var f=d("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(c,j);f=d("EchoDecodingUtils").echoDecodeNullableIntField(a,f);f.result!=null?b.push({address:c,status:e,timestampMs:f.result}):b.push({address:c,status:e})}});return b}function l(a){var b=new Set();for(var a=a.keys(),c=Array.isArray(a),e=0,a=c?a:a[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var f;if(c){if(e>=a.length)break;f=a[e++]}else{e=a.next();if(e.done)break;f=e.value}f=f;if(f.includes(i))try{f=f.split("@");var g=f[0];f=m(f[1]);b.add({localKey:g,transportKey:f})}catch(a){d("WALogger").ERROR(h(),a)}}return Array.from(b)}function m(a){a=a.split(i);return a[0].split("-")[0]}g.MessageReceiptStatus=k;g.echoMessageSetReceiptStatusDataFields=a;g.echoMessageDecodeReceiptStatusDataFields=c}),98);
__d("EchoMessageXMAFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from xma fields"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from xma fields"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xmaIsTombstoned from xma fields"]);k=function(){return a};return a}var l="XMA-Default-CTA",m="XMA-Gating-Type",n="XMA-Header-Subtitle",o="XMA-Header-Title",p="XMA-Is-Tombstoned",q="XMA-Layout-Type",r="XMA-Max-Subtitle-Num-Lines",s="XMA-Max-Title-Num-Lines",t="XMA-Subtitle-Text",u="XMA-Target-Expiry",v="XMA-Target-ID",w="XMA-Target-Type",x="XMA-Target-Username",y="XMA-Title-Text",z="XMA-Content-Ref",A=b("$InternalEnum").Mirrored(["SINGLE","HSCROLL","VSTACK","PORTRAIT"]),B=b("$InternalEnum").Mirrored(["NONE","IG_STORY_PHOTO_MENTION","IG_SINGLE_IMAGE_POST_SHARE","IG_MULTIPOST_SHARE","IG_SINGLE_VIDEO_POST_SHARE","IG_STORY_PHOTO_SHARE","IG_STORY_VIDEO_SHARE","IG_CLIPS_SHARE","IG_IGTV_SHARE","IG_SHOP_SHARE","IG_PROFILE_SHARE","IG_STORY_PHOTO_HIGHLIGHT_SHARE","IG_STORY_VIDEO_HIGHLIGHT_SHARE","IG_STORY_REPLY","IG_STORY_REACTION","FB_FEED_SHARE","FB_STORY_REPLY","FB_STORY_SHARE","FB_STORY_MENTION","FB_FEED_VIDEO_SHARE","FB_GAMING_CUSTOM_UPDATE","FB_PRODUCER_STORY_REPLY","MSG_EXTERNAL_LINK_SHARE","MSG_RECEIVER_FETCH","RTC_AUDIO_CALL","RTC_VIDEO_CALL","RTC_MISSED_AUDIO_CALL","RTC_MISSED_VIDEO_CALL","RTC_GROUP_AUDIO_CALL","RTC_GROUP_VIDEO_CALL","FB_EVENT"]),C=b("$InternalEnum").Mirrored(["NONE","PRIVATE","SENSITIVE","MISINFORMATION","MEDIA_LABEL","POST_COVER","POST_LABEL","WARNING_SCREENS","INFO","EYE_OFF","NEWS_OFF","WARNING"]);function a(a,b){b.xmaLayoutType!=null&&d("EchoEncodingUtils").echoSetStringField(a,q,b.xmaLayoutType),b.xmaTargetType!=null&&d("EchoEncodingUtils").echoSetStringField(a,w,b.xmaTargetType),d("EchoEncodingUtils").echoSetStringField(a,x,b.xmaTargetUsername),d("EchoEncodingUtils").echoSetStringField(a,v,b.xmaTargetId),b.xmaTargetExpiry!=null&&d("EchoEncodingUtils").echoSetIntField(a,u,b.xmaTargetExpiry),d("EchoEncodingUtils").echoSetStringField(a,l,b.xmaDefaultCTA),d("EchoEncodingUtils").echoSetStringField(a,o,b.xmaHeaderTitle),d("EchoEncodingUtils").echoSetStringField(a,n,b.xmaHeaderSubtitle),d("EchoEncodingUtils").echoSetStringField(a,y,b.xmaTitleText),d("EchoEncodingUtils").echoSetStringField(a,t,b.xmaSubtitleText),b.xmaMaxTitleNumLines!=null&&d("EchoEncodingUtils").echoSetIntField(a,s,b.xmaMaxTitleNumLines),b.xmaMaxSubtitleNumLines!=null&&d("EchoEncodingUtils").echoSetIntField(a,r,b.xmaMaxSubtitleNumLines),b.xmaGatingType!=null&&d("EchoEncodingUtils").echoSetStringField(a,m,b.xmaGatingType),d("EchoEncodingUtils").echoSetBooleanField(a,p,b.xmaIsTombstoned),b.xmaContentRef!=null&&d("EchoEncodingUtils").echoSetStringField(a,z,b.xmaContentRef)}function c(a){var b=F(a,p);if(b==null){d("WALogger").ERROR(k());return null}var c=C.cast(d("EchoDecodingUtils").echoDecodeStringField(a,m).result),e=A.cast(d("EchoDecodingUtils").echoDecodeStringField(a,q).result),f=B.cast(d("EchoDecodingUtils").echoDecodeStringField(a,w).result);return{xmaContentRef:D(a,z),xmaDefaultCTA:D(a,l),xmaGatingType:c,xmaHeaderSubtitle:D(a,n),xmaHeaderTitle:D(a,o),xmaIsTombstoned:b,xmaLayoutType:e,xmaMaxSubtitleNumLines:E(a,r),xmaMaxTitleNumLines:E(a,s),xmaSubtitleText:D(a,t),xmaTargetExpiry:E(a,u),xmaTargetId:D(a,v),xmaTargetType:f,xmaTargetUsername:D(a,x),xmaTitleText:D(a,y)}}function D(a,b){a=d("EchoDecodingUtils").echoDecodeStringField(a,b);var c=a.result;a=a.success;if(a&&c!=null)return c;else d("WALogger").WARN(j(),b)}function E(a,b){a=d("EchoDecodingUtils").echoDecodeIntField(a,b);var c=a.result;a=a.success;if(a&&c!=null)return c;else d("WALogger").WARN(i(),b)}function F(a,b){a=d("EchoDecodingUtils").echoDecodeBooleanField(a,b);var c=a.result;a=a.success;if(a&&c!=null)return c;else d("WALogger").WARN(h(),b)}g.XMALayoutType=A;g.XMAContentType=B;g.XMAGatingType=C;g.echoMessageSetXMAFields=a;g.decodeXMAFields=c}),98);
__d("LSEBPayloadSerializerError",[],(function(a,b,c,d,e,f){a=Object.freeze({INVALID_BACKUP_OPERATION:-7,INVALID_CONTENT_TYPE:-6,INVALID_PAYLOAD_FORMAT:-5,CQL_DB_ERROR:-4,REQUIRED_COLUMN_NOT_PRESENT_ON_CLIENT:-3,DEPRECATED_SPROC:-2,UNKNOWN_ERROR:-1,NOT_AN_ERROR:0,BACKUP_NOT_FOUND:1,REQUIRED_TABLE_NOT_FOUND:2,NATIVE_OP_NOT_FOUND:3,BACKUP_UPLOAD_KILLSWITCHED:4,TASK_ID_NOT_FOUND:5,NOT_IMPLEMENTED:6,NOT_SUPPORTED_ON_WEB:7,DUPLICATE_TASK:8,CLIENT_STATE_NOT_LOADED:9,RECOVERY_CODE_NOT_FOUND:10,EPOCH_KEYS_NOT_FOUND:11,DEVICE_PAYLOAD_NOT_CREATED:12,NULL_DEVICE_PAYLOAD:13,EPOCH_PAYLOAD_NOT_CREATED:14,NULL_EPOCH_PAYLOAD:15,VIRTUAL_DEVICE_PAYLOAD_NOT_CREATED:16,NULL_VIRTUAL_DEVICE_PAYLOAD:17,DEVICE_METADATA_NOT_FOUND:18,NO_MATCHING_DEVICE_PUBLIC_KEY:19,NULL_MAILBOX_ROOT_KEY:20,NULL_ENCRYPTION_VERSION:21,NULL_OCMF_KEY:22,NULL_EPOCH_KEYS:23,NULL_DEVICE_ID:24,OPE_KEY_DERIVATION_FAILED:25,MESSAGE_KEY_DERIVATION_FAILED:26,NULL_MAILBOX_ROOT_KEY_V2:27,ECHO_DOCUMENT_ENCODING_FAILED:30,ECHO_PAYLOAD_CREATION_DISABLED:31,MESSAGE_PAYLOAD_ENCRYPTION_FAILED:40,SERVER_THREAD_ID_NOT_FOUND_FOR_JID:52,UNKNOWN_PROTOBUF_TYPE:60,SUPPLEMENTARY_DATA_KEY_UNEXPECTED:61,PROTOBUF_ENCRYPTION_FAILED:62,PROTOBUF_NOT_FOUND_IN_TOPLEVEL_TABLE:63,PROTOBUF_NOT_FOUND_IN_SUPPLEMENTAL_TABLE:64,SUPPLEMENTAL_KEY_NOT_SET_IN_CONTEXT_TABLE:65,SUPPLEMENTAL_ENCRYPTION_FAILED:66,PROTOBUF_CONTEXT_ROW_NOT_FOUND:67,PROTOBUF_FORMATTING_FAILED:68,SUPPLEMENTAL_FORMATTING_FAILED:69,PROTOBUF_ALREADY_DELETED:70,THREAD_PK_NOT_FOUND_FOR_JID:100,MESSAGE_DECRYPTION_FAILED:101,EPOCH_KEY_FETCH_FAILED:102,TOO_MANY_OPEN_EPOCHS:103,MESSAGE_RANGE_PREPARE_FAILURE:104,ECHO_DOCUMENT_RESTORE_FAILED:105,MISMATCH_POINT_QUERY_MESSAGE_AND_RANGE_LENGTH:106,INITIAL_THREADS_FETCH_FOR_RESTORE_FAILED:107,MISSING_SUPPLEMENTAL_KEY_CIPHERTEXT:108,SUPPLEMENTAL_KEY_DECRYPTION_FAILURE:109,DEVICE_ID_MISMATCH:110,RESTORE_TO_TAM_INFO:111,MISSING_SERVER_THREAD_KEY:112,EB_ADD_DEVICE_FOUND_NO_LOCAL_THREADS:113,EB_MORE_THREADS_IN_MAPPING_TABLE:114,MESSAGE_PK_NOT_FOUND_IN_CLIENT_MESSAGES:200,OTID_NOT_FOUND_IN_ACT_MESSAGES:201,THREAD_ID_NOT_FOUND_IN_ACT_THREADS:202,THREAD_PK_NOT_FOUND_IN_CLIENT_THREADS:203,FAILED_TO_GET_THREAD_SORT_KEY:204,MEDIA_INFO_INVALID:205,REVERB_DB_NOT_ENABLED_FOR_INSTAMADILLO:206,SKIPPED_EB_DISABLED:300,SKIPPED_THREAD_NOT_ELIGIBLE:301,SKIPPED_MESSAGE_NOT_ELIGIBLE:302,NO_EPOCHS_FOUND:400,LATEST_EPOCH_QUERY_BY_ID_FAILED:401,FOUND_EPOCH_WITH_NULL_ROOT_KEY:402,FOUND_EPOCH_WITH_NULL_ANON_ID:403,NO_RECOVERY_CODE:501,NO_ERROR:601,ERROR_GENERAL:602,UNKNOWN:603,ONBOARDING_MATERIAL_DERIVATION_FAILURE:604,NULL_DEVICE_HMAC:605,MISSING_LATEST_EPOCH_AT_ONBOARDING:606,NO_THREADS_TO_COMPARE:701,START_SORT_KEY_FAILURE:702,END_SORT_KEY_FAILURE:703,LOOPING_UPLOAD_PAYLOAD_NOT_FOUND:704,NULL_ECHO_IDENTIFIERS:705,ECHO_TIMESTAMP_CONVERSION_FAILED:706,ECHO_PROTOBUF_THREAD_ID_MISMATCH:707,ECHO_PROTOBUF_TIMESTAMP_MISMATCH:708,ECHO_PROTOBUF_OTID_MISMATCH:709,NULL_ECHO_DOCUMENT:710,INVALID_PROTOBUF_BACKUP_ACTION:711,EMPTY_ENCODED_ECHO_DOCUMENT:712,ECHO_DOCUMENT_ENCODING_UNKNOWN_ENCODING_ERROR:750,ECHO_DOCUMENT_ENCODING_MESSAGE_PK_NOT_FOUND_ERROR:751,ECHO_DOCUMENT_ENCODING_DISK_WRITE_CHECK_FAILED:752,ECHO_DOCUMENT_ENCODING_THREAD_TRANSPORT_ID_FETCH_FAILED:753,ECHO_DOCUMENT_ENCODING_FILE_WRITE_FAILED:754,ECHO_DOCUMENT_ENCODING_DISK_WRITE_DISABLED:755,ECHO_DOCUMENT_ENCODING_SHOULD_NOT_PERSIST:756,MISSING_SUPPLEMENTAL_DATA:757,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_REPLY_PROXY_ERROR:758,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_EDIT_MESSAGE_QUERY_ERROR:759,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_EDIT_MESSAGE_ERROR:760,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_RECEIPTS_ERROR:761,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_REACTIONS_ERROR:762,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_VISUAL_MESSAGE_ACTIONS_ERROR:763,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_POLLS_ERROR:764});f["default"]=a}),66);
__d("MAWBridgeTypesCreators",["I64","MAWDbMsg","MAWImageUtils","MAWMsgType","WAGlobals","WAJids","WAMediaUtils","WATimeUtils","err","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return{threadJid:a}}function i(a){var b,c=a.ts;switch(a.type){case d("MAWMsgType").MSG_TYPE.REVOKED:c=(b=a.originalTs)!=null?b:a.ts;break;default:c=d("MAWDbMsg").getCanonicalTsFromMsg(a)}return{msgId:a.msgId,ts:c}}function b(a,b){b=b.map(i);return{messages:b,threadJid:a}}function e(a){return{ravenMsgId:a.msgId,threadJid:a.threadJid}}function f(a,b){return a.filter(function(a){return b===a.threadJid}).map(function(a){return a.msgId})}function j(a){var b,e=a.chatJid,f=a.filteredMsgIds,g=a.hasMediaForUI,h=a.media,i=a.offlineAttachmentId,j=a.ravenSettings;a=a.sortOrderMs;switch(h.mediaType){case"Image":return{duration:null,ephemeralMediaState:j==null?void 0:j.ephemeralMediaState,ephemeralMediaViewMode:j==null?void 0:j.ephemeralMediaViewMode,filesize:h.size,hasMedia:g,mediaId:h.mediaId,mediaType:h.mediaType,msgIds:f,offlineAttachmentId:i,plaintextHash:h.plaintextHash,previewHeight:(b=h.validatedImageInfo)==null?void 0:b.jpegThumbnailHeight,previewHeightLarge:(b=h.validatedImageInfo)==null?void 0:b.height,previewWidth:(b=h.validatedImageInfo)==null?void 0:b.jpegThumbnailWidth,previewWidthLarge:(b=h.validatedImageInfo)==null?void 0:b.width,sortOrderMs:d("WATimeUtils").castToMillisTime(a!=null?a:h.ts*1e3),threadJid:e,ts:d("WATimeUtils").castToUnixTime(a!=null?a/1e3:h.ts)};case"Video":return{duration:((b=h.validatedVideoInfo)==null?void 0:b.duration)!=null?((b=h.validatedVideoInfo)==null?void 0:b.duration)*1e3:0,ephemeralMediaState:j==null?void 0:j.ephemeralMediaState,ephemeralMediaViewMode:j==null?void 0:j.ephemeralMediaViewMode,filesize:h.size,hasMedia:g,mediaId:h.mediaId,mediaType:h.mediaType,msgIds:f,offlineAttachmentId:i,plaintextHash:h.plaintextHash,previewHeight:(b=h.validatedVideoInfo)==null?void 0:b.jpegThumbnailHeight,previewHeightLarge:(j=h.validatedVideoInfo)==null?void 0:j.height,previewWidth:(b=h.validatedVideoInfo)==null?void 0:b.jpegThumbnailWidth,previewWidthLarge:(j=h.validatedVideoInfo)==null?void 0:j.width,sortOrderMs:d("WATimeUtils").castToMillisTime(a!=null?a:h.ts*1e3),threadJid:e,ts:d("WATimeUtils").castToUnixTime(a!=null?a/1e3:h.ts)};case"Ptt":return{duration:((b=h.validatedAudioInfo)==null?void 0:b.duration)?h.validatedAudioInfo.duration*1e3:null,filesize:h.size,hasMedia:g,mediaId:h.mediaId,mediaType:h.mediaType,msgIds:f,offlineAttachmentId:i,plaintextHash:h.plaintextHash,previewHeight:null,previewHeightLarge:null,previewWidth:null,previewWidthLarge:null,sortOrderMs:d("WATimeUtils").castToMillisTime(a!=null?a:h.ts*1e3),threadJid:e,ts:d("WATimeUtils").castToUnixTime(a!=null?a/1e3:h.ts)};case"Gif":return{duration:null,filesize:h.size,hasMedia:g,mediaId:h.mediaId,mediaType:h.mediaType,msgIds:h.msgIds,offlineAttachmentId:i,plaintextHash:h.plaintextHash,previewHeight:(j=h.validatedImageInfo)==null?void 0:j.jpegThumbnailHeight,previewHeightLarge:(b=h.validatedImageInfo)==null?void 0:b.height,previewWidth:(j=h.validatedImageInfo)==null?void 0:j.jpegThumbnailWidth,previewWidthLarge:(b=h.validatedImageInfo)==null?void 0:b.width,sortOrderMs:d("WATimeUtils").castToMillisTime(a!=null?a:h.ts*1e3),threadJid:e,ts:d("WATimeUtils").castToUnixTime(a!=null?a/1e3:h.ts)};case"Sticker":j=d("MAWImageUtils").boundHeightWidth((j=h.validatedImageInfo)==null?void 0:j.jpegThumbnailHeight,(b=h.validatedImageInfo)==null?void 0:b.jpegThumbnailWidth,128);b=j.height;j=j.width;return{duration:null,filesize:h.size,hasMedia:g,mediaId:h.mediaId,mediaType:h.mediaType,msgIds:h.msgIds,offlineAttachmentId:i,plaintextHash:h.plaintextHash,previewHeight:b,previewHeightLarge:b,previewWidth:j,previewWidthLarge:j,sortOrderMs:d("WATimeUtils").castToMillisTime(a!=null?a:h.ts*1e3),threadJid:e,ts:d("WATimeUtils").castToUnixTime(a!=null?a/1e3:h.ts)};case"DocumentFile":b={};for(var j=h.mediaEntries,k=Array.isArray(j),l=0,j=k?j:j[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var m;if(k){if(l>=j.length)break;m=j[l++]}else{l=j.next();if(l.done)break;m=l.value}m=m;var n=m[0];m=m[1];m=d("WAMediaUtils").mediaEntryDataToRawData(h.plaintextHash,m);m=m.filename;m!=null&&(b[n]=m)}return{defaultFilename:(n=h.validatedDocumentFileInfo)==null?void 0:n.filename,duration:null,filenames:b,filesize:h.size,hasMedia:g,mediaId:h.mediaId,mediaType:h.mediaType,msgIds:f,offlineAttachmentId:i,plaintextHash:h.plaintextHash,previewHeight:null,previewHeightLarge:null,previewWidth:null,previewWidthLarge:null,sortOrderMs:d("WATimeUtils").castToMillisTime(a!=null?a:h.ts*1e3),threadJid:e,ts:d("WATimeUtils").castToUnixTime(a!=null?a/1e3:h.ts)};default:h.mediaType;throw c("err")("[createBridgeMedia] Unsupported media type: "+h.mediaType)}}function k(a,b,c,e,f){return{chatJid:a,deliveredWatermarkTs:(a=c)!=null?a:d("WATimeUtils").castToUnixTime(0),fbid:b,lastReadActionTs:(c=f)!=null?c:d("WATimeUtils").castToUnixTime(0),lastReadWatermarkTs:(a=e)!=null?a:d("WATimeUtils").castToUnixTime(0)}}function l(a){var b=a.cannotReplyReason,c=a.folder,d=a.muteExpireTimeMs,e=a.snippetParams,f=a.snippetSenderContactId,g=a.snippetType;a=a.threadJid;return{cannotReplyReason:b,folder:c,muteExpireTimeMs:d,snippetContactIDs:e==null?void 0:e.contactIDs,snippetMentionJIDs:e==null?void 0:e.mentionJIDs,snippetParams:e==null?void 0:e.strings,snippetSenderContactId:f,snippetType:g,threadJid:a}}function m(a){return{chatJid:a.groupJid,memberAddMode:a.memberAddMode,threadName:a.name}}function n(a,b,c,e,f,g,i,j){return{description:i,lastActivityTs:b,lastMsgExternalId:j!==void 0?(h||(h=d("I64"))).of_string_opt(j):void 0,lastReadTs:(i=c)!=null?i:d("WATimeUtils").castToMillisTime(0),snippetContactIDs:f.contactIDs,snippetMentionJIDs:(b=f.mentionJIDs)!=null?b:[],snippetParams:f.strings,snippetSenderContactId:g,snippetType:e,threadJid:a}}function o(a){var b=a.bumpTimestampMs,c=a.description,d=a.isMessageAuthorMe,e=a.isUnbump,f=a.shouldMarkThreadAsUnread,g=a.skipBumpTimestampValidation,h=a.skipServerThreadBump,i=a.snippetParams,j=a.snippetSenderContactId,k=a.snippetType;a=a.threadJid;return{bumpTimestampMs:b,description:c,isMessageAuthorMe:d,isUnbump:e,shouldMarkThreadAsUnread:f,skipBumpTimestampValidation:(b=g)!=null?b:!1,skipServerThreadBump:(c=h)!=null?c:!1,snippetContactIDs:(d=i==null?void 0:i.contactIDs)!=null?d:[],snippetMentionJIDs:(e=i==null?void 0:i.mentionJIDs)!=null?e:[],snippetParams:(f=i==null?void 0:i.strings)!=null?f:[],snippetSenderContactId:(g=j)!=null?g:null,snippetType:(b=k)!=null?b:null,threadJid:a}}function p(a){var b;if(c("gkx")("239"))return 0;return!c("justknobx")._("2319")?d("MAWDbMsg").getOriginalTsFromMsg(a)*1e3:(b=a.sortOrderMs)!=null?b:d("MAWDbMsg").getOriginalTsFromMsg(a)*1e3}function q(a,b,d,e,f,g){g===void 0&&(g="before");b=b;if(b.length===0)return{chatJid:a,rangeExtensionType:null};if(d)return{chatJid:a,rangeExtensionType:{hasMoreBefore:e,maxMsgId:b[0].msgId,minMsgId:b[b.length-1].msgId,minMsgTs:p(b[b.length-1]),rangeKind:"initial"}};return c("gkx")("23927")?{chatJid:a,rangeExtensionType:{hasMoreAfter:f,hasMoreBefore:e,maxMsgId:b[0].msgId,maxMsgTs:p(b[0]),minMsgId:b[b.length-1].msgId,minMsgTs:p(b[b.length-1]),rangeKind:g==="before"?"before":"after"}}:{chatJid:a,rangeExtensionType:{hasMoreBefore:e,minMsgId:b[b.length-1].msgId,minMsgTs:p(b[b.length-1]),rangeKind:"extensionBefore"}}}function r(a){var b=d("WAJids").extractDeviceIDParts(d("WAGlobals").getMyDeviceJid()).userId;return s(a,b)}function s(a,b){var c=a.author,e=a.chatJid,f=a.reaction,g=a.reactToMsgId;a=a.ts;return{actorId:d("WAJids").authorToUserId(c,b),chatJid:e,messageId:g,reaction:f,ts:a}}function t(a){var b=a.newestMsgId,c=a.newestMsgTs,e=a.oldestMsgId;a=a.thread;return{hasMoreAfter:!1,hasMoreBefore:!1,maxMsgId:b,maxMsgTs:c,minMsgId:e,minMsgTs:d("WATimeUtils").castToMillisTime(0),threadJid:a.jid}}function u(a){var b=d("WAJids").extractDeviceIDParts(d("WAGlobals").getMyDeviceJid()).userId,c=a.author,e=a.chatJid;a=a.reactToMsgId;return{actorId:d("WAJids").authorToUserId(c,b),chatJid:e,messageId:a}}function v(a){return{creationTs:a.creationTs,creator:a.creator,groupJid:a.groupJid,msgExpiration:a.msgExpiration,name:a.name,nameOwner:a.nameOwner,nameTs:a.nameTs,participantVersion:a.participantVersion}}function w(a){var b=a.threadJid,c=a.inviteeJid;return{caption:a.caption,inviteCode:a.inviteCode,inviteeId:c,inviteExpireTs:a.inviteExpirationTs,inviterId:d("WAJids").extractUserId(a.inviterJid),threadJid:b}}function x(a){return{threadJid:a}}function y(a,b,c){return{senderId:d("WAJids").extractUserId(b),state:c,threadJid:a}}g.createBridgeUpdateE2EEMetadataParticipants=a;g.createBridgeDeleteMessages=b;g.createBridgeRavenAction=e;g.getMsgIdsFilteredByJid=f;g.createBridgeMedia=j;g.createBridgeReceivedReceipt=k;g.createBridgeUpdatedThread=l;g.createBridgeUpdatedGroupInfo=m;g.createBridgeBumpedThread=n;g.createBridgeBumpedThreadV2=o;g.createBridgeMsgsLoadedInfo=q;g.createBridgeUpsertReaction=r;g.createBridgeUpsertReactionWithMyUserId=s;g.createBridgeUpdateMessageRange=t;g.createBridgeDeleteReaction=u;g.createBridgeGroupInfo=v;g.createBridgeGroupInvite=w;g.createBridgeDeleteGroupInvite=x;g.createBridgeReceivedChatState=y}),98);
__d("EncryptedBackupsAttachmentProductType",["$InternalEnum"],(function(a,b,c,d,e,f){a=b("$InternalEnum")({MSGR:"msgr",IGD:"igd"});c=a;f["default"]=c}),66);
__d("MAWBridgeUpload",["MAWMainTraceUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.actionType,c=a.attachmentContext,d=a.authTs,e=a.echoDocument,f=a.echoEncodingLatencyNs,g=a.errorCode,i=a.errorMessage,j=a.messageId,k=a.messageType,l=a.productType,m=a.protoMsg,n=a.sortOrderMs,o=a.threadId,p=a.traceId;a=a.uploadTrackingInstanceKey;c=h(c,l!=null?l:"msgr");return{actionType:b,attachmentBackupContext:c,authTs:d,echoDocument:e,echoEncodingLatencyNs:f,errorCode:g,errorMessage:i,messageId:j,messageType:k,protoMsg:m,sortOrderMs:n,threadId:o,traceId:p,uploadTrackingInstanceKey:a}}function b(a,b,c,d,e,f){return{actionType:f,echoDocument:e,folderType:b,threadId:a,transportKey:c,ts:d}}function c(a,b,c,d,e,f,g,h){return{deliveryObjectId:a,mediaType:b,messageId:c,productType:d,threadId:e,threadJid:f,traceId:h,ts:g}}function h(a,b){if(a==null)return void 0;else{a={attachmentTraceId:d("MAWMainTraceUtils").createTraceId(),mediaType:a.mediaType,zippyObjectId:a.mediaObjectId};a={attachmentInfos:[a],productType:b};return a}}g.createBridgeUploadMessage=a;g.createBridgeDeleteMessagesOfThread=b;g.createBridgeUploadAttachment=c;g.createBridgeUploadAttachmentBackupContext=h}),98);
__d("MAWUploadThreadTxns",["$InternalEnum","MAWFolderTypes"],(function(a,b,c,d,e,f,g){"use strict";var h=b("$InternalEnum")({INBOX:0,PENDING:1,OTHER:2,SPAM:3,ARCHIVED:4,HIDDEN:5});function i(a){switch(a){case d("MAWFolderTypes").FOLDER_ID.INBOX:return h.INBOX;case d("MAWFolderTypes").FOLDER_ID.PENDING:return h.PENDING;case d("MAWFolderTypes").FOLDER_ID.ARCHIVED:return h.ARCHIVED;default:return h.INBOX}}function a(a){return i(a).toString()}g.FolderType=h;g.getFolderTypeAsText=a}),98);
__d("MAWBridgeEventTransmitter",["MAWBridge","MAWBridgeMsg","MAWBridgeTrace","MAWBridgeTypesCreators","MAWBridgeUpload","MAWIndexedDb","MAWUploadThreadTxns","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"IssuePointQuery",value:{jid:f,messageId:a,startSortKey:c,taskSource:e,threadId:b}}]})}function b(a,b){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessagesOfThread",value:d("MAWBridgeUpload").createBridgeDeleteMessagesOfThread(d("WAJids").threadIdForChatJid(a.jid),d("MAWUploadThreadTxns").getFolderTypeAsText(a.folder),"AdvancedCrypto",(a=b)!=null?a:d("WATimeUtils").castToMillisTime(1),null,2)})}function c(a,b,c,e,f,g){d("MAWIndexedDb").afterTransaction({tag:"MsgsLoaded",value:d("MAWBridgeTypesCreators").createBridgeMsgsLoadedInfo(b,c,e,f,g)})}function e(a,b,c){d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"StartTrace",value:d("MAWBridgeTrace").createBridgeStartTraceData(a,b,c)}]})}function f(a,b){(b==null?void 0:b.get(a.externalId))!=null?d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(a,b.get(a.externalId),void 0,"EncryptedBackups")}]}):d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(a,void 0,void 0,"EncryptedBackups")}]})}function h(a,b,c,e){d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:a,folder:b,threadJid:e})}]})}function i(a,b,c){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessageRangesV2",value:{minMsgId:a,minTimestampMs:b,threadJid:c}})}g.issuePointQueryOutsideTxn=a;g.deleteMessagesOfThreadAfterTxn=b;g.issueMsgLoadedEventAfterTxn=c;g.startTraceOutsideTxn=e;g.issueNewMsgUiEventOutsideTxn=f;g.updateThreadOutsideTxn=h;g.deleteMessageRangesV2AfterTxn=i}),98);
__d("MAWConstants",[],(function(a,b,c,d,e,f){"use strict";a=5;b="Facebook user";c="Instagram user";d=3;e=50;f.MESSAGE_RETRY_COUNT_LIMIT=a;f.FB_UNKNOWN_USER=b;f.INS_UNKNOWN_USER=c;f.CURRENT_REGISTRATION_VERSION=d;f.BRIDGE_UPLOAD_BATCH_SIZE=e}),66);
__d("WAErrorMessage",[],(function(a,b,c,d,e,f){"use strict";var g="NoErrorMessageProvided";function a(a){var b;a instanceof Error?b=a.message:typeof a==="string"?b=a:typeof a==="object"?typeof (a==null?void 0:a.description)==="string"?b=a.description:typeof (a==null?void 0:a.message)==="string"?b=a.message:b=g:b=g;return b}f.NO_ERROR_MESSAGE_PROVIDED=g;f.maybeGetMessageFromError=a}),66);
__d("MAWDbChunkTxns",["MAWMediaUtils","WAErrorMessage","WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to add chunk. Possible duplicate? Will attempt a retry. Error: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to add chunk. Possible duplicate? Will attempt a retry. For hashedPlaintextHash: ",". Error: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to add chunk after retry. Error: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to add chunk for hashedPlaintextHash: ",". Error: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Chunk found after retry for hashedPlaintextHash: ",""]);l=function(){return a};return a}var m=d("WATagsLogger").TAGS(["MAWDbChunkTxns"]);b=function a(b,c,e,f,g){g===void 0&&(g=0);var n=d("MAWMediaUtils").genHMACPlaintextHash(c);return b.chunk.where("hashedPlaintextHash").equals(n).first().then(function(o){if(o){g>0&&m.LOG(l(),n);return o}else{var p={blobData:e,hashedPlaintextHash:n,mimetype:f,plaintextHash:c};return b.chunk.add(p).then(function(a){return babelHelpers["extends"]({},p,{chunkId:a})})["catch"](function(l){var o=d("WAErrorMessage").maybeGetMessageFromError(l);if(g>0){m.WARN(k(),n,o);m.ERROR(j(),o);throw l}else{m.WARN(i(),n,o);m.ERROR(h(),o);return a(b,c,e,f,g+1)}})}})};c=function(a,b){return n(a,b).then(function(a){return a!=null})};var n=function(a,b){return a.chunk.where("hashedPlaintextHash").equals(b).first()};e=function(a,b){return a.chunk.where("hashedPlaintextHash").anyOf(b).toArray().then(function(a){return new Map(a.map(function(a){return[a.hashedPlaintextHash,a]}))})};function a(a,b){return a.chunk.bulkGet(b)}f=function(a,b){b=d("MAWMediaUtils").genHMACPlaintextHash(b);return a.chunk.get({hashedPlaintextHash:b})};g.getOrCreateMediaChunk=b;g.hasMediaChunk=c;g.maybeGetChunkFromHash=n;g.maybeBulkGetChunksFromHash=e;g.bulkGetChunks=a;g.maybeGetChunkByPlaintextHash=f}),98);
__d("MAWJidUtils",["FBLogger","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,e){if(d("WAJids").isAuthorSystem(a)||b==null||e==null){c("FBLogger")("messenger_e2ee_web").warn("Failed to create protocolMsgId with externalId %s for a msg to edit",e);return}return{author:a,chat:b,externalId:e}}function a(a){var b;return h(a.author,a.threadJid,(b=a.externalId)!=null?b:a.editExternalId)}function b(a){return d("WAJids").isAuthorMe(a)?d("WAGlobals").getMyUserJid():a}g.maybeToProtocolMsgId=h;g.toProtocolMsgId=a;g.getAuthorJid=b}),98);
__d("MAWLoadReplyMediaTxns",["MAWDbChunkTxns","MAWDbMedia","MAWDbMsg","MAWDbXMATxns","MAWDexieTable","MAWJidUtils","MAWMediaUtils","MAWMsgType","MAWXMAUtils","WAAssertUnreachable","WAGlobals","WAJids","WALogger","WAMsgType","WAResultOrError","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unable to fetch reply media XMA with id ",": ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unable to fetch reply media with id ",": ",""]);i=function(){return a};return a}function j(a,b,e){if(c("gkx")("2419")&&e!=null){e=d("MAWMediaUtils").genHMACPlaintextHash(e);return a.media.where("hashedPlaintextHash").equals(e).first().then(function(b){return b==null?[void 0,void 0]:d("MAWDbChunkTxns").maybeGetChunkFromHash(a,b.hashedPlaintextHash).then(function(a){return a==null?[void 0,b]:[a,b]})})}else return a.media.get(b).then(function(b){return b==null?[void 0,void 0]:d("MAWDbChunkTxns").maybeGetChunkFromHash(a,b.hashedPlaintextHash).then(function(a){return a==null?[void 0,b]:[a,b]})})}var k=new Set([(e=d("MAWDbMedia")).MEDIA_TYPE.IMAGE,e.MEDIA_TYPE.GIF,e.MEDIA_TYPE.PTT,e.MEDIA_TYPE.STICKER,e.MEDIA_TYPE.VIDEO,e.MEDIA_TYPE.DOCUMENT_FILE]);function l(a){var b;switch(a.mediaType){case d("MAWDbMedia").MEDIA_TYPE.IMAGE:case d("MAWDbMedia").MEDIA_TYPE.GIF:case d("MAWDbMedia").MEDIA_TYPE.STICKER:b=a.validatedImageInfo;break;case d("MAWDbMedia").MEDIA_TYPE.VIDEO:b=a.validatedVideoInfo;break}a=b||{};var c=a.jpegThumbnailHeight;a=a.jpegThumbnailWidth;return{replyMediaPreviewHeight:c,replyMediaPreviewWidth:a}}function m(a){switch(a.type){case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return!0;case d("MAWMsgType").MSG_TYPE.XMA:return d("MAWXMAUtils").isXMAShare(a.xmaMessageType);case d("MAWMsgType").MSG_TYPE.TEXT:case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:case d("MAWMsgType").MSG_TYPE.REVOKED:case d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case d("MAWMsgType").MSG_TYPE.GROUP_INVITE:case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:case d("WAMsgType").NOTE_REPLY:case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return!1;default:return c("WAAssertUnreachable")(a.type)}}function n(a,b,c){return b==null?d("MAWDexieTable").dexieResolve():j(a,b,c).then(function(a){var c=a[0];a=a[1];if(a==null)return d("WAResultOrError").makeError("reply_media_not_found");if(!k.has(a.mediaType))return d("WAResultOrError").makeError("reply_media_type_unknown");var e=l(a),f=e.replyMediaPreviewHeight;e=e.replyMediaPreviewWidth;var g;c!=null&&(g=c.mimetype);return d("WAResultOrError").makeResult({replyMediaId:b,replyMediaPreviewHeight:f,replyMediaPreviewWidth:e,replyMediaUrlMimeType:g,replyPlaintextHash:a.plaintextHash})}).then(function(a){if(a.success!==!0){d("WALogger").ERROR(i(),b,a.error);return}return a.value})}function o(a,b){var c=b.defaultPreviewMediaId;return c==null?d("MAWDexieTable").dexieResolve({replyXMAId:b.xmaId}):j(a,c).then(function(a){var c=a[0];a=a[1];if(c==null||a==null)return d("WAResultOrError").makeError("reply_xma_media_not_found");if(!k.has(a.mediaType))return d("WAResultOrError").makeError("reply_xma_media_type_unknown");a=l(a);var e=a.replyMediaPreviewHeight;a=a.replyMediaPreviewWidth;return d("WAResultOrError").makeResult({replyMediaPreviewHeight:e,replyMediaPreviewWidth:a,replyMediaUrlMimeType:c.mimetype,replyXMAId:b.xmaId})}).then(function(a){if(a.success!==!0){d("WALogger").ERROR(h(),b.xmaId,a.error);return}return a.value})}function a(a,b){return p(a,b,d("WAGlobals").getMyUserJid)}function p(a,b,c){var e,f;e=((e=b.quote)==null?void 0:e.content)||{};var g=e.author,h=e.externalId,i=e.mediaId,j=e.plaintextHash;e=e.xmaMessageType;if(((f=b.quote)==null?void 0:f.content)==null||!m((f=b.quote)==null?void 0:f.content))return d("MAWDexieTable").dexieResolve();f=b.threadJid;b=g===c();c=b?d("WAJids").AUTHOR_ME:g;return d("MAWXMAUtils").isXMAShare(e)?q(a,d("MAWJidUtils").maybeToProtocolMsgId(c,f,h)):n(a,i,j)}function q(a,b){return b==null?d("MAWDexieTable").dexieResolve():d("MAWDbXMATxns").maybeGetXMAFromProtocolMsgId(a,b).then(function(b){if(b==null||d("MAWXMAUtils").isXMAExpired(b.isTombstoned,b.targetExpiringAtSec))return;return o(a,b)})}function b(a,b){var c=b.author,e=b.externalId,f=b.mediaId,g=b.plaintextHash,h=b.threadJid,i=b.xmaMessageType;i=d("MAWXMAUtils").isXMAShare(i);return!d("MAWDbMsg").isMediaMsg(b)&&!i?d("MAWDexieTable").dexieResolve():i?q(a,d("MAWJidUtils").maybeToProtocolMsgId(c,h,e)):n(a,f,g)}g.getMediaAndChunk=j;g.MSG_MEDIA_TYPE=k;g.getImageAttributes=l;g.isMediaReplyContent=m;g.getReplyMediaForMsgQuote=a;g.getReplyMediaForMsgQuoteWithMyUserId=p;g.getReplyMediaForMsg=b}),98);
__d("WAMsgMap",[],(function(a,b,c,d,e,f){"use strict";a=function(){function a(a){var b=this;this.$1=new Map();a==null?void 0:a.forEach(function(a){var c=a[0];a=a[1];b.set(c,a)})}var b=a.prototype;b.clear=function(){this.$1.clear()};b["delete"]=function(a){var b;(b=this.$1.get(a.externalId))==null?void 0:(b=b.get(a.author))==null?void 0:b["delete"](a.chat)};b.get=function(a){var b;return(b=this.$1.get(a.externalId))==null?void 0:(b=b.get(a.author))==null?void 0:b.get(a.chat)};b.has=function(a){var b;return(b=(b=this.$1.get(a.externalId))==null?void 0:(b=b.get(a.author))==null?void 0:b.has(a.chat))!=null?b:!1};b.set=function(a,b){var c,d;c=(c=this.$1.get(a.externalId))!=null?c:new Map();this.$1.has(a.externalId)||this.$1.set(a.externalId,c);d=(d=c.get(a.author))!=null?d:new Map();c.has(a.author)||c.set(a.author,d);d.set(a.chat,b);return this};b.keys=function(){var a=[],b=this.$1;for(var c=b.keys(),d=Array.isArray(c),e=0,c=d?c:c[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var f,g;if(d){if(e>=c.length)break;g=c[e++]}else{e=c.next();if(e.done)break;g=e.value}g=g;f=(f=b.get(g))!=null?f:new Map();for(var h=f.keys(),i=Array.isArray(h),j=0,h=i?h:h[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var k,l;if(i){if(j>=h.length)break;l=h[j++]}else{j=h.next();if(j.done)break;l=j.value}l=l;k=(k=f.get(l))!=null?k:new Map();for(var k=k.keys(),m=Array.isArray(k),n=0,k=m?k:k[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var o;if(m){if(n>=k.length)break;o=k[n++]}else{n=k.next();if(n.done)break;o=n.value}o=o;a.push({externalId:g,author:l,chat:o})}}}return a};b.entries=function(){var a=[],b=this.$1;for(var c=b.keys(),d=Array.isArray(c),e=0,c=d?c:c[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var f,g;if(d){if(e>=c.length)break;g=c[e++]}else{e=c.next();if(e.done)break;g=e.value}g=g;f=(f=b.get(g))!=null?f:new Map();for(var h=f.keys(),i=Array.isArray(h),j=0,h=i?h:h[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var k,l;if(i){if(j>=h.length)break;l=h[j++]}else{j=h.next();if(j.done)break;l=j.value}l=l;k=(k=f.get(l))!=null?k:new Map();for(var m=k.keys(),n=Array.isArray(m),o=0,m=n?m:m[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var p;if(n){if(o>=m.length)break;p=m[o++]}else{o=m.next();if(o.done)break;p=o.value}p=p;var q=k.get(p);q!=null&&a.push([{externalId:g,author:l,chat:p},q])}}}return a};b.values=function(){return this.entries().map(function(a){return a[1]})};return a}();f.MsgMap=a}),66);
__d("MAWDbMsgUtil",["WAJids","WALogger","WAMsgMap"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Invalid author when converting msg array to map"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missing jid prevents adding message to array map"]);i=function(){return a};return a}function a(a){return a.reduce(function(a,b){var c=b.threadJid;if(c==null){d("WALogger").ERROR(i());return a}if(b.author==="@system"){d("WALogger").ERROR(h());return a}a.set({author:b.author,chat:c,externalId:b.externalId},b);return a},new(d("WAMsgMap").MsgMap)())}function b(a){return d("WAJids").isAuthorSystem(a.author)||a.threadJid==null?null:{author:a.author,chat:a.threadJid,externalId:a.externalId}}g.convertMsgArrayToMap=a;g.getProtocolMsgIdFromDbMsg=b}),98);
__d("MAWDbUnrenderedMsgTxns",["MAWAckLevel","MAWDbMsg","MAWDbMsgUtil","MAWDexieTable","WAJids","WALogger","WAMsgMap","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateSystemAck on sent message"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateSystemAck on incoming message"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["updateSystemAckForUnrenderedMsg on non existing message"]);j=function(){return a};return a}function a(a,b){var c=b.author,e=b.chat,f=b.externalId;return a.threads.get({jid:e}).then(function(b){return b==null?d("WAResultOrError").makeError("missing_thread_unrendered_msg"):k(a,f,e,c).then(function(a){return a==null?d("WAResultOrError").makeError("missing_unrendered_msg"):d("WAResultOrError").makeResult(a)})})}function b(a,b){var c=b.map(function(a){a=a.externalId;return a});return a.unrenderedMessages.where("externalId").anyOf(c).toArray().then(function(a){var c=d("MAWDbMsgUtil").convertMsgArrayToMap(a),e=new(d("WAMsgMap").MsgMap)();b.forEach(function(a){var b=c.get(a);b!=null&&e.set(a,b)});return e})}function k(a,b,c,d){return a.unrenderedMessages.where("externalId").equals(b).filter(function(a){return a.author===d&&a.threadJid===c}).first()}function l(a,b){return a+"_"+b}function c(a,b){var c=b.map(function(a){a=a.externalId;return a}),e=Array.from(new Set(b.map(function(a){return a.chat})));return d("MAWDexieTable").dexieAll([a.threads.where("jid").anyOf(e).toArray(),a.unrenderedMessages.where("externalId").anyOf(c).toArray()]).then(function(a){var c=a[0];a=a[1];if(a.length===0||c.length===0)return[];var d=new Map();b.forEach(function(a){var b=a.author,c=a.chat;a=a.externalId;var e=d.get(a)||new Set();e.add(l(b,c));d.set(a,e)});return a.filter(function(a){var b=a.author,c=a.externalId;a=a.threadJid;c=d.get(c);return c!=null&&a!=null&&c.has(l(b,a))})})}function e(a,b,c){return m(a,[{ack:c,msgId:b}]).then(function(a){a=a[0];if(a==null){d("WALogger").LOG(j());return null}return a})}function m(a,b){var c=b.map(function(a){return a.msgId}),e=new Map();b.forEach(function(a){return e.set(a.msgId,{ack:a.ack})});return a.unrenderedMessages.where("msgId").anyOf(c).toArray().then(function(b){if(b.length===0)return b;var c=[],f=[];b.forEach(function(a){var b;if(a.author!==d("WAJids").AUTHOR_ME){d("WALogger").ERROR(i());c.push(a);return}if(a.ack>d("MAWAckLevel").ACK.clock){d("WALogger").LOG(h());c.push(a);return}b=(b=e.get(a.msgId))==null?void 0:b.ack;if(b==null)return null;a=babelHelpers["extends"]({},a,{ack:b});b===d("MAWAckLevel").ACK.sent&&delete a.resendCount;f.push(a)});return a.unrenderedMessages.bulkPut(f).then(function(){return[].concat(f,c)})})}function f(a,b){b=b.map(function(b){return a.unrenderedMessages.get({msgId:b})});return d("MAWDexieTable").dexieAll(b)}function n(a,b){return a.unrenderedMessages.where("msgId").between(d("MAWDbMsg").msgIdsInChatLowerBound(b.chatId),d("MAWDbMsg").msgIdsInChatUpperBound(b.chatId)).last().then(function(a){a=a==null?0:d("MAWDbMsg").getInChatMsgIdFromMsgId(a.msgId);return a+1})}g.maybeGetUnrenderedMsgByProtocolMsgId=a;g.getUnrenderedMsgMapByProtocolMsgId=b;g.maybeGetUnrenderedMsgByExternalId=k;g.getUnrenderedMsgsByProtocolMsgId=c;g.updateSystemAckForUnrenderedMsg=e;g.bulkUpdateSystemAckForUnrenderedMsgs=m;g.getUnrenderedMsgsByMsgIds=f;g.getNextUnrenderedMsgIdNumberForThread=n}),98);
__d("MAWDbMsgTxns",["MAWAckLevel","MAWBridgeMsg","MAWDbMsg","MAWDbMsgUtil","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWMsgType","MAWSharedMsgIdUtil","MAWUpdateThreadMsgMetadataApi","Random","WAJids","WALogger","WAMsgMap","WAResultOrError","WATimeUtils","err","gkx","justknobx","promiseDone","qex"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Successfull deleted "," messages"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["updateMediaId on message "," that already has this mediaId ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Replacing mediaId for message with pre-existing media. type=",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["updateMediaId on message "," that already has this mediaId ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["getFutureproofMsg gets a message "," with unsupported type ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["getMsgsFromOffset() newest msg thread jid is not equal to thread jid.\n            msg.threadJid: ",",\n            thread.jid: ",",\n            thread.chatId: ",",\n            offsetMsgId: ","."]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["getMsgsFromOffset, fetched msgs length: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["getMsgsFromOffset input: offsetMsgId: ",", numMsgs: ",", includeOffset: ",", includeExpired: ",", direction: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateSystemAck on sent message"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateSystemAck on incoming message"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["updateSystemAck on non existing message"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[maybeGetMsgByExternalId] Found "," messages with external id ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[maybeGetMsgByProtocolMsgId] Suspected multiple instances of same message!"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[maybeGetMsgByProtocolMsgId] Can't have "," messages with the same protocolMsgId!"]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["[CacheDiscrepancy] Thread "," has a discrepancy between the cached and uncached values for field: ",". Cached value: ",", uncached value: ",".\n        Cached msgType: ",", uncached msgType: ",".\n        Cached ts: ",", uncached sortOrderMs: ","."]);v=function(){return a};return a}function w(a,b){return b==null?d("MAWDexieTable").dexieResolve():a.messages.get({msgId:b})}function a(a,b){var c="newestMsg",e=E("query_by_sortOrderMs",c),f=e.isCacheBypassed;e=e.isLoggingExpected;var g=b.newestMsg==null;a=a.messages.where("threadJid").equals(b.jid).count().then(function(a){return a===0});e&&y(b,c,g,a);return f?a:d("MAWDexieTable").dexieResolve(g)}function x(a,b,c,e,f,g){d("WALogger").LOG(v(),a.jid,b,c,e,f==null?void 0:f.type,g==null?void 0:g.type,a.newestMsgTs,g==null?void 0:g.sortOrderMs)}function y(a,b,c,d){return d.then(function(d){if(c===d)return;x(a,b,c,d,null,null)})}function z(a,b,c,e){return d("MAWDexieTable").dexieAll([c,e]).then(function(c){var d=c[0];c=c[1];if((d==null?void 0:d.msgId)===(c==null?void 0:c.msgId))return;x(a,b,d==null?void 0:d.msgId,c==null?void 0:c.msgId,d,c)})}function A(a,b,c,e,f){return f.then(function(f){if(e===f)return;return d("MAWDexieTable").dexieAll([w(a,e),w(a,f)]).then(function(a){var d=a[0];a=a[1];x(b,c,e,f,d,a)})})}function B(a,b,c,e){return e.then(function(e){if(e==null&&c==null||e===d("WATimeUtils").castToMillisTime(0)||e!=null&&c!=null&&Math.floor(e/1e3)===c/1e3)return;x(a,b,c,e,null,null)})}function C(a,b){if(b)switch(a){case"newestMsg":return c("qex")._("961")===!0;case"newestMsgTs":return c("qex")._("962")===!0}else switch(a){case"newestMsg":return c("qex")._("928")===!0;case"newestMsgTs":return c("qex")._("944")===!0}}function D(a){switch(a){case"newestMsg":case"newestMsgTs":return d("Random").coinflip(c("justknobx")._("2537"))}}function E(a,b){var c=D(b),d=!1;switch(a){case"defer_to_qe":d=C(b,c);break;case"query_by_sortOrderMs":d=!0;break;case"use_cached_fields":d=!1;break}return{isCacheBypassed:d,isLoggingExpected:c}}function F(a,b,c,d){return a.messages.where(["threadJid","sortOrderMs"]).between([b,Number.MIN_SAFE_INTEGER],[b,Number.MAX_SAFE_INTEGER],c,d)}function G(a,b){return F(a,b,!1,!1).last()}function b(a,b,c){c===void 0&&(c="query_by_sortOrderMs");var d="newestMsg";c=E(c,d);var e=c.isCacheBypassed;c=c.isLoggingExpected;var f=w(a,b.newestMsg);a=G(a,b.jid).then(function(a){return a});c&&z(b,d,f,a);return e?a:f}function e(a,b,c){c===void 0&&(c="query_by_sortOrderMs");var e="newestMsg";c=E(c,e);var f=c.isCacheBypassed;c=c.isLoggingExpected;var g=b.newestMsg,h=G(a,b.jid).then(function(a){return a==null?void 0:a.msgId});c&&A(a,b,e,g,h);return f?h:d("MAWDexieTable").dexieResolve(g)}function f(a,b,c){c===void 0&&(c="defer_to_qe");var e="newestMsgTs";c=E(c,e);var f=c.isCacheBypassed;c=c.isLoggingExpected;var g=b.newestMsgTs;a=G(a,b.jid).then(function(a){return(a==null?void 0:a.sortOrderMs)==null?null:d("WATimeUtils").castToMillisTime(a.sortOrderMs)});c&&B(b,e,g,a);return f?a:d("MAWDexieTable").dexieResolve(g)}function H(a,b,c){return F(a,b,!1,!1).reverse().limit(c).toArray()}function I(a,b){return F(a,b,!1,!1).first()}function J(a,b){return I(a,b).then(function(a){return a==null?void 0:a.msgId})}function K(a,b){return a.messages.where("externalId").equals(b.externalId).filter(function(a){return a.author===b.author&&a.threadJid===b.chat}).toArray().then(function(a){if(a.length>1){var b=a.map(function(a){var b;return a.type+":"+((b=a.serverTs)!=null?b:0).toString()+":"+((b=a.ts)!=null?b:0).toString()});b=new Set(b).size===1;!b?d("WALogger").ERROR(u(),a.length):d("WALogger").ERROR(t())}return a[0]})}function L(a,b){return a.messages.where("msgId").equals(b).toArray()}function M(a,b){return P(a,b).then(function(a){return a.success?a:a})}function N(a,b){var c=b.map(function(a){a=a.externalId;return a});return a.messages.where("externalId").anyOf(c).toArray().then(function(a){var c=d("MAWDbMsgUtil").convertMsgArrayToMap(a),e=new(d("WAMsgMap").MsgMap)();b.forEach(function(a){var b=c.get(a);b!=null&&e.set(a,b)});return e})}function O(a,b){return a.messages.where("msgId").equals(b).first().then(function(a){return a==null?void 0:a.sortOrderMs})}function P(a,b){var c=b.author,e=b.chat,f=b.externalId;return a.threads.get({jid:e}).then(function(b){return b==null?d("WAResultOrError").makeError("missing_thread_msg"):R(a,f,b.jid,c).then(function(a){return a==null?d("WAResultOrError").makeError("missing_msg"):d("WAResultOrError").makeResult(a)})})}function Q(a,b){var c=b.author,d=b.chat,e=b.externalId;return a.threads.get({jid:d}).then(function(b){if(b==null)return;return a.messages.where("revokedExternalId").equals(e).filter(function(a){return a.author===c&&a.threadJid===b.jid&&a.type==="Revoked"}).first()})}function R(a,b,c,e){return a.messages.where("externalId").equals(b).filter(function(a){return a.author===e&&a.threadJid===c}).toArray().then(function(a){a.length>1&&d("WALogger").ERROR(s(),a.length,b);return a[0]})}function S(a,b,c,e){var f=a.messages.where("revokedExternalId").equals(b).filter(function(a){return a.author===e&&a.threadJid===c&&a.type===d("MAWMsgType").MSG_TYPE.REVOKED}).first();a=d("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByExternalId(a,b,c,e).then(function(a){if((a==null?void 0:a.type)===d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME)return a});return d("MAWDexieTable").dexieAll([f,a]).then(function(a){var b=a[0];a=a[1];return b!=null||a!=null})}function T(a,b){var c=new Array(b.length),e=new Set();b.forEach(function(a){c.push(a.externalId),e.add(d("MAWSharedMsgIdUtil").convertWAMsgIdToStringId(a))});return a.messages.where("externalId").anyOf(c).filter(function(a){return e.has(d("MAWSharedMsgIdUtil").convertWAMsgIdToStringId({author:a.author,chat:a.threadJid,externalId:a.externalId}))}).toArray()}function U(a,b,c,e,f,g){return V(a,[{ack:c,msgId:b,reportingMeta:f,serverTs:e}],g).then(function(a){a=a.find(function(a){return a.msgId===b});if(a==null){d("WALogger").LOG(r());return null}return a})}function V(a,b,c){c==null?void 0:c.addPoint("bulk_update_system_ack_start");var e=b.map(function(a){return a.msgId});return d("MAWDbXMATxns").getXMAMsgIdsFromAssociatedMsgIds(a,e).then(function(f){var g=new Map();b.forEach(function(a){g.set(a.msgId,{ack:a.ack,reportingMeta:a.reportingMeta,serverTs:a.serverTs});var b=f.get(a.msgId);b!=null&&g.set(b,{ack:a.ack,reportingMeta:a.reportingMeta,serverTs:a.serverTs})});var h=Array.from(new Set(e.concat(Array.from(f.values()))));return a.messages.where("msgId").anyOf(h).toArray().then(function(b){c==null?void 0:c.addPoint("bulk_update_fetched_msgs",{"int":{debugMsgsLength:b.length}});if(b.length===0)return b;var e=[],f=[];b.forEach(function(a){var b,c;if(a.author!==d("WAJids").AUTHOR_ME){d("WALogger").ERROR(q());e.push(a);return}if(a.ack>d("MAWAckLevel").ACK.clock){d("WALogger").LOG(p());e.push(a);return}b=(b=g.get(a.msgId))==null?void 0:b.ack;c=(c=g.get(a.msgId))==null?void 0:c.serverTs;if(b==null)return null;var h=babelHelpers["extends"]({},a,{ack:b});c!=null&&(h.serverTs=c);a=(c=g.get(a.msgId))==null?void 0:c.reportingMeta;a!=null&&(h.reportingMeta=a);b===d("MAWAckLevel").ACK.sent&&delete h.resendCount;f.push(h)});c==null?void 0:c.addPoint("bulk_updating_messages",{"int":{debugUpdsLength:f.length}});return a.messages.bulkPut(f).then(function(){return d("MAWDexieTable").dexieAll(f.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b)}))}).then(function(a){c==null?void 0:c.addPoint("bulk_update_call_bridge",{"int":{debugEntriesLength:f.length}});f.forEach(function(b,e){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,void 0,a[e],void 0,c==null?void 0:c.getFlowDetails().instanceKey)})});return[].concat(f,e)})})})}function aa(a,b,c,e){return d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success||e==null||b.value.oldestMsg!==c&&b.value.newestMsg!==c)return;var f=b.value;b=[a.messages.where(["threadJid","sortOrderMs"]).above([f.jid,e]).first(),a.messages.where(["threadJid","sortOrderMs"]).below([f.jid,e]).last()];return d("MAWDexieTable").dexieAll(b).then(function(b){var e=b[0];b=b[1];return d("MAWDbThreadTxns").updateThread(a,babelHelpers["extends"]({},f,{newestMsg:f.newestMsg===c?b==null?void 0:b.msgId:f.newestMsg,newestMsgTs:f.newestMsg===c?(b==null?void 0:b.ts)==null?null:d("WATimeUtils").castUnixTimeToMillisTime(b.ts):f.newestMsgTs,oldestMsg:f.oldestMsg===c?e==null?void 0:e.msgId:f.oldestMsg})).then(function(){})})})}function ba(a,b,e,f,g){if(b===(e==null?void 0:e.msgId)&&f===(g==null?void 0:g.msgId))return d("MAWDexieTable").dexieResolve();d("MAWIndexedDb").afterTransactionEffect(function(){c("promiseDone")(c("MAWUpdateThreadMsgMetadataApi")(a,b,e,f,g))})}function ca(a,b,e,f,g,h,i){g===void 0&&(g=!1);h===void 0&&(h=!1);i===void 0&&(i="before");return f===0?d("MAWDexieTable").dexieResolve({hasMoreAfter:!1,hasMoreBefore:!1,msgs:[]}):d("MAWDexieTable").dexieAll([a.threads.get({jid:b}),e==null?d("MAWDexieTable").dexieResolve(null):a.messages.get({msgId:e})]).then(function(b){var j=b[0],k=b[1],l=j==null?void 0:j.oldestMsg,p=j==null?void 0:j.newestMsg;if(j==null||e!=null&&k==null)return{hasMoreAfter:!1,hasMoreBefore:!1,msgs:[]};var q=h?function(a){return!0}:function(a){return a.messageExpirationTs==null||a.messageExpirationTs>d("WATimeUtils").unixTime()};b=d("MAWDexieTable").dexieResolve([]);f===1&&g&&k!=null&&(b=d("MAWDexieTable").dexieResolve([k].filter(q)));d("WALogger").LOG(o(),k==null?void 0:k.msgId,f,g,h,i);return b.then(function(b){b=b.length>0?d("MAWDexieTable").dexieResolve(b):na(a,j.jid,k,g,f,q,i);var h=c("gkx")("23927");return d("MAWDexieTable").dexieAll([b,G(a,j.jid),I(a,j.jid)]).then(function(a){var b=a[0],c=a[1];a=a[2];ba(j,l,a,p,c);d("WALogger").LOG(n(),b.length);if(b.length===0)return{hasMoreAfter:!1,hasMoreBefore:!1,msgs:[]};var g=b[b.length-1],i=b[0];g=h?g.msgId!==(a==null?void 0:a.msgId):g.msgId!==(a==null?void 0:a.msgId)&&b.length===f;a=h?i.msgId!==(c==null?void 0:c.msgId):!1;i.threadJid!==j.jid&&d("WALogger").ERROR(m(),i.threadJid,j.jid,j.chatId,e);return{hasMoreAfter:a,hasMoreBefore:g,msgs:b}})})})}function da(a){return a.messages.where("altIndex").equals(d("MAWDbMsg").FUTUREPROOF_ALT_INDEX).toArray().then(function(a){var b=[];a.forEach(function(a){if(a.type!==d("MAWMsgType").MSG_TYPE.FUTUREPROOF){d("WALogger").ERROR(l(),a.msgId,a.type);return}b.push(a)});return b})}function W(a){return a.toString()}function ea(a,b,c,e){var f=b.mediaId;if(f===c){d("WALogger").LOG(k(),b.msgId,c);return d("MAWDexieTable").dexieResolve()}f=f!=null?a.media.get(f):d("MAWDexieTable").dexieResolve();return f.then(function(f){f&&d("WALogger").ERROR(j(),b.type);f=(f=e)!=null?f:void 0;f=babelHelpers["extends"]({},b,{mediaId:c,plaintextHash:f});return a.messages.put(f).then(function(){})})}function fa(a,b){var e=Array.from(b.keys());return a.messages.where("msgId").anyOf(e).toArray().then(function(e){var f=[];e.map(function(a){var e=b.get(a.msgId),g=a.mediaId;if(g!=null&&g!==e){if(e!=null)throw c("err")("mediaId "+W(g)+" in message "+a.msgId+" is different with the "+W(e)+" in bulkUpdateMediaId");d("WALogger").LOG(i(),a.msgId,e);return}g=babelHelpers["extends"]({},a,{mediaId:e,plaintextHash:a.plaintextHash});f.push(g)});return a.messages.bulkPut(f).then(function(){})})}function ga(a,b){return X(a,[b]).then(function(){})}function X(a,b){return a.messages.where("msgId").anyOf(b).toArray().then(function(b){var c=b.map(function(a){return babelHelpers["extends"]({},a,{isExpiredXmaMsg:!0})});return a.messages.bulkPut(c).then(function(){return c})})}function Y(a,b,c,e){if(e!=null&&e<=0)return d("MAWDexieTable").dexieResolve([]);a=a.messages.where("altIndex").equals(d("MAWDbMsg").craftToBeReadAltIndex(b)).filter(c);e!=null&&(a=a.limit(e));return a.toArray()}function ha(a,b,c,d){return Y(a,b,function(a){return a.msgId<=c},d)}function Z(a,b,c,e){return Y(a,b,function(a){return d("MAWDbMsg").getSortOrderWithFallback(a)<=c},e)}function ia(a,b,c){return Z(a,b,c).then(function(b){var c=b.map(function(a){return babelHelpers["extends"]({altIndex:null},a)});return a.messages.bulkPut(c).then(function(){return c})})}function ja(a,b){return a.messages["delete"](b)}function ka(a,b,c){var e=b.map(function(a){return a.rowId});b=c!=null?b.map(function(a){a=d("MAWJidUtils").toProtocolMsgId(a);if(!a)return;return babelHelpers["extends"]({},a,{reason:c})}).filter(Boolean):[];return d("MAWDexieTable").dexieAll([a.deletedMessages.bulkAdd(b),a.messages.bulkDelete(e)]).then(function(a){a[0];a=a[1];d("WALogger").LOG(h(),a)})}function la(a,b){return a.messages.where("msgId").anyOf(b).toArray()}function ma(a){return a.messages.where("altIndex").anyOf([d("MAWDbMsg").SPAM_ALT_INDEX,d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX]).toArray()}function na(a,b,c,e,f,g,h){h===void 0&&(h="before");c=c==null?null:d("MAWDbMsg").getSortOrderWithFallback(c);if(h==="before"){return a.messages.where(["threadJid","sortOrderMs"]).between([b,Number.MIN_SAFE_INTEGER],[b,(h=c)!=null?h:Number.MAX_SAFE_INTEGER],!0,e).reverse().filter(g).limit(f).toArray()}else{return a.messages.where(["threadJid","sortOrderMs"]).between([b,(h=c)!=null?h:Number.MIN_SAFE_INTEGER],[b,Number.MAX_SAFE_INTEGER],e,!0).filter(g).limit(f).toArray().then(function(a){return a.sort(function(a,b){return b.ts-a.ts})})}}function oa(a,b,c,d){var e=c.msgId;if(a==null&&b==null)return{newestMsg:e,oldestMsg:e};if(d==null){var f;return{newestMsg:e,oldestMsg:(f=a==null?void 0:a.msgId)!=null?f:e}}f=[a,b,c].filter(Boolean);return{newestMsg:f.reduce(function(a,b){return $(b,e,d)>=$(a,e,d)?b:a}).msgId,oldestMsg:f.reduce(function(a,b){return $(a,e,d)<$(b,e,d)?a:b}).msgId}}function $(a,b,c){return a.msgId===b?c:d("MAWDbMsg").getSortOrderWithFallback(a)}function pa(a,b){return a.messages.where("msgId").between(d("MAWDbMsg").msgIdsInChatLowerBound(b.chatId),d("MAWDbMsg").msgIdsInChatUpperBound(b.chatId)).last().then(function(a){a=a==null?0:d("MAWDbMsg").getInChatMsgIdFromMsgId(a.msgId);return a+1})}g.maybeGetMsg=w;g.getIsThreadEmpty=a;g.getThreadMessagesBySortOrder=F;g.getThreadNewestMessageBySortOrder=G;g.getThreadNewestMessageBySortOrderOrCache=b;g.getThreadNewestMessageId=e;g.getThreadNewestMessageTs=f;g.getThreadNewestNumMessagesBySortOrder=H;g.getThreadOldestMessageBySortOrder=I;g.getThreadOldestMessageId=J;g.maybeGetMsgByProtocolMsgId=K;g.maybeGetMsgListByMsgId_I_KNOW_WHAT_I_AM_DOING=L;g.maybeGetMsgResultByProtocolMsgId=M;g.getMsgMapByProtocolMsgId=N;g.getSortOrderFromMsgId=O;g.maybeGetRevokedMsgByProtocolMsgId=Q;g.maybeGetMsgByExternalId=R;g.checkIfMsgIsDeletedForMeOrRevoked=S;g.getMsgsByProtocolMsgId=T;g.updateSystemAck=U;g.bulkUpdateSystemAck=V;g.maybeUpdateThreadMsgsForDeleteForMe=aa;g.getMsgsFromOffset=ca;g.getFutureProofMsgs=da;g.updateMediaId=ea;g.bulkUpdateMediaId=fa;g.updateDbMsgXMAExpiration=ga;g.bulkUpdateDbMsgXMAExpired=X;g.getMsgsNeedingRetroactiveReadReceiptsUpTo__DONOTUSE=ha;g.getMsgsNeedingRetroactiveReadReceiptsUpTo=Z;g.clearRetroactiveReadReceiptStatusFromMsgsUpTo=ia;g.deleteDbMsg=ja;g.deleteMessages=ka;g.getMsgsByMsgIds=la;g.getSpamMsgs=ma;g.calculateOldestAndNewestMsg=oa;g.getNextMsgIdNumberForThread=pa}),98);
__d("WAArrayZip",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c=Math.min(a.length,b.length);return a.slice(0,c).map(function(a,c){return[a,b[c]]})}f.zip=a}),66);
__d("MAWDbThreadTxns",["MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","WAArrayZip","WALogger","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["markCutoverThreadAsNotMigratedLocally failed because thread is already unmigrated"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["markThreadAsMigratedLocally failed because thread is already migrated"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["markThreadAsMigratedLocally failed to get the thread"]);j=function(){return a};return a}function a(a,b){return a.threads.get({deduplicationKey:b}).then(function(a){return a==null?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeResult(a)})}function k(a,b){return a.threads.get({jid:b}).then(function(a){return a==null?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeResult(a)})}function l(a,b){return a.threads.where("jid").anyOf(b).toArray()}function b(a,b){return a.threads.where("jid").startsWith(b+"@").first().then(function(a){return a==null?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeResult(a)})}function c(a,b){return a.threads.where("jid").equals(b)["delete"]().then(function(){})}function e(a,b){return a.participants.where("userJid").equals(b).toArray().then(function(b){b=b.map(function(a){return a.threadJid});return l(a,b)})}function f(a,b){return a.participants.where("userJid").anyOf(b).toArray().then(function(b){var c=new Map(),d=new Set();b.forEach(function(a){var b,e=a.userJid;b=(b=c.get(e))!=null?b:[];b.push(a.threadJid);c.set(e,b);d.add(a.threadJid)});return l(a,Array.from(d)).then(function(a){var b=a.reduce(function(a,b){a.set(b.jid,b);return a},new Map());return new Map(Array.from(c.entries()).map(function(a){var c=a[0];a=a[1];return[c,a.map(function(a){return b.get(a)}).filter(Boolean)]}))})})}function m(a,b,c){return(b==null?void 0:b.lastReadMsgReceiptSent)==null?d("MAWDexieTable").dexieResolve(!1):d("MAWDbMsgTxns").getSortOrderFromMsgId(a,b.lastReadMsgReceiptSent).then(function(a){return c.sortOrderMs==null||a==null?!1:c.sortOrderMs<=a})}function n(a,b){return a.threads.get({jid:b.threadJid}).then(function(c){return m(a,c,b)})}function o(a,b){return a.threads.where("jid").anyOf(b.map(function(a){return a.threadJid})).toArray().then(function(c){return d("MAWDexieTable").dexieAll(d("WAArrayZip").zip(b,c).map(function(b){var c=b[0];b=b[1];return m(a,b,c)}))})}function p(a,b,c){return a.threads.where("jid").anyOf(b).toArray().then(function(b){var e=b.filter(Boolean).map(function(a){return babelHelpers["extends"]({},a,{archived:!0,cannotReplyReason:c?"viewer_not_subscribed":a.cannotReplyReason,folder:d("MAWFolderTypes").FOLDER_ID.ARCHIVED})});return a.threads.bulkPut(e).then(function(){e.forEach(function(a){c&&d("WALogger").LOG(["[Occamadillo] Leaving a group thread\n          "+a.jid.toString()+", showing a VIEWER_NOT_SUBSCRIBED composer blocker"]),d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:a.cannotReplyReason,folder:d("MAWFolderTypes").FOLDER_ID.ARCHIVED,threadJid:a.jid})})})})})}function q(a,b){return a.threads.where("jid").anyOf(b).toArray().then(function(b){var c=b.filter(Boolean).map(function(a){return babelHelpers["extends"]({},a,{cannotReplyReason:null})});return a.threads.bulkPut(c).then(function(){c.forEach(function(a){a={cannotReplyReason:null,threadJid:a.jid};d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread(a)})})})})}function r(a,b){return a.threads.where("jid").anyOf(b).toArray().then(function(b){var c=b.filter(Boolean).map(function(a){return babelHelpers["extends"]({},a,{archived:!1,cannotReplyReason:a.cannotReplyReason==="viewer_not_subscribed"?a.cannotReplyReason:null,folder:d("MAWFolderTypes").FOLDER_ID.INBOX})});return a.threads.bulkPut(c).then(function(){c.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:a.cannotReplyReason,folder:d("MAWFolderTypes").FOLDER_ID.INBOX,threadJid:a.jid})})})})})}function s(a,b){return a.threads.where("jid").anyOf(b).toArray().then(function(b){var c=b.filter(Boolean).map(function(a){return babelHelpers["extends"]({},a,{cannotReplyReason:"viewer_not_subscribed"})});return a.threads.bulkPut(c).then(function(){c.forEach(function(a){var b={cannotReplyReason:"viewer_not_subscribed",threadJid:a.jid};d("WALogger").LOG(["[Occamadillo] User is unsubscribed from thread\n          "+a.jid.toString()+", showing a VIEWER_NOT_SUBSCRIBED composer blocker"]);d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread(b)})})})})}function t(a,b){return k(a,b).then(function(b){if(!b.success){d("WALogger").WARN(j());return}b=b.value;if(b.isMigratedLocally===!0){d("WALogger").WARN(i());return}b=babelHelpers["extends"]({},b,{isMigratedLocally:!0});return a.threads.put(b).then(function(){})})}function u(a,b){if(b.isMigratedLocally===!1){d("WALogger").WARN(h());return d("MAWDexieTable").dexieResolve(b)}var c=babelHelpers["extends"]({},b,{isMigratedLocally:!1});return a.threads.put(c).then(function(){return c})}function v(a,b){return a.threads.put(b).then(function(){})}function w(a,b,c,e,f,g){c=c===(e==null?void 0:e.msgId);f=f===(g==null?void 0:g.msgId);return c&&f?d("MAWDexieTable").dexieResolve():v(a,babelHelpers["extends"]({},b,{newestMsg:g==null?void 0:g.msgId,newestMsgTs:f?b.newestMsgTs:(g==null?void 0:g.ts)==null?null:d("WATimeUtils").castUnixTimeToMillisTime(g.ts),oldestMsg:e==null?void 0:e.msgId}))}g.getThreadByDeduplicationKey=a;g.getThread=k;g.getThreads=l;g.getThreadPrimaryId=b;g.deleteThreadRow=c;g.getAllThreadsForUser=e;g.getAllThreadsForUsers=f;g.needsRetroactiveReadReceiptInThread=n;g.bulkNeedsRetroactiveReadReceiptInThread=o;g.archiveThreads=p;g.subscribeToThreads=q;g.unarchiveThreads=r;g.unsubscribeFromThreads=s;g.markCutoverThreadAsMigratedLocally=t;g.markCutoverThreadAsNotMigratedLocally=u;g.updateThread=v;g.updateThreadMsgsForUndefinedOldestOrNewestMsgs=w}),98);
__d("MAWDbMediaTxns",["MAWDbMsg","MAWDexieTable","MAWMediaUtils","MAWMsgType","WALogger","WAResultOrError","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["mediaId is null for media msg with msgId: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["mediaId is null for media msg with msgId: ",""]);i=function(){return a};return a}function a(a,b){return b==null?d("MAWDexieTable").dexieResolve():a.media.get({mediaId:b})}function j(a,b){return a.media.where("hashedPlaintextHash").equals(b).first()}function b(a,b){b=d("MAWMediaUtils").genHMACPlaintextHash(b);return j(a,b)}function e(a,b){return a.media.where("hashedPlaintextHash").anyOf(b).toArray()}function f(a,b){return b==null?d("MAWDexieTable").dexieResolve():k(a,b).then(function(c){c=c==null?void 0:c.mediaId;return c!=null?a.media.get({mediaId:c}):a.media.get({objectId:b})})}function k(a,b){return b==null?d("MAWDexieTable").dexieResolve():a.mediaBackup.get({objectId:b})}function l(a,b){a=a.mediaBackup.where("objectId").anyOf(b).toArray();return a.then(function(a){return new Map(a.map(function(a){return[a.objectId,a]}))})}function m(a,b){return l(a,b).then(function(b){b=Array.from(b.values()).map(function(a){return a.mediaId});return a.media.bulkGet(b)})}function n(a,b){if(b==null)return d("MAWDexieTable").dexieResolve();a=a.mediaBackup.where("msgId").equals(b).toArray();return a}function o(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve([]);b=b.filter(d("MAWDbMsg").isMediaMsg);var e=b.reduce(function(a,b){if(b.mediaId==null){d("WALogger").ERROR(i(),b.msgId);return a}return a.set(b.mediaId,b)},new Map());b=Array.from(e.keys());return r(a,b).then(function(a){var b=[];a.forEach(function(a){if(a==null)throw c("err")("Error missing media");var d=e.get(a.mediaId);if(d==null)throw c("err")("Error missing media");b.push([d,a])});return b})}function p(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve([]);b=b.filter(d("MAWDbMsg").isMediaMsg).map(function(a){var b=a.mediaId;if(b==null){d("WALogger").ERROR(h(),a.msgId);throw c("err")("mediaId is missing")}else return b});return r(a,b).then(function(a){var b=[];a.forEach(function(a){a!=null&&b.push(a)});return b})}function q(a,b){if(b.type===d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME||d("MAWDbMsg").isMediaMsg(b)){var c=b.mediaId;return c==null?b.type===d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME?d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult()):d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("missing")):a.media.get(c).then(function(a){return a==null?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeResult(a)})}else return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult())}function r(a,b){return a.media.bulkGet(b)}function s(a,b){var c=b.previewMediaIds!=null?r(a,b.previewMediaIds):d("MAWDexieTable").dexieResolve(),e=b.headerMediaId!=null?a.media.get(b.headerMediaId):d("MAWDexieTable").dexieResolve();a=b.faviconMediaId!=null?a.media.get(b.faviconMediaId):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([c,e,a]).then(function(a){var c=a[0],e=a[1];a=a[2];if(b.headerMediaId!=null&&e==null)return d("WAResultOrError").makeError("missing");if(b.faviconMediaId!=null&&a==null)return d("WAResultOrError").makeError("missing");if(c==null)return d("WAResultOrError").makeError("missing");var f=[];for(var c=c,g=Array.isArray(c),h=0,c=g?c:c[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var i;if(g){if(h>=c.length)break;i=c[h++]}else{h=c.next();if(h.done)break;i=h.value}i=i;if(i==null)return d("WAResultOrError").makeError("missing");else f.push(i)}return d("WAResultOrError").makeResult({favicon:a,header:e,previews:f})})}function t(a,b,c){b=babelHelpers["extends"]({},b,c);return a.media.put(b)}g.maybeGetMediaFromMediaId=a;g.maybeGetMediaFromHashedPlaintextHash=j;g.maybeGetMediaFromPlaintextHash=b;g.maybeBulkGetMediaFromHashedPlaintextHash=e;g.maybeGetMediaFromObjectId=f;g.maybeGetMediaBackupRowFromObjectId=k;g.maybeGetMediaBackupRowsFromObjectIds=l;g.maybeGetBulkMediaFromObjectIds=m;g.maybeGetMediaBackupRowFromMsgId=n;g.getMsgMediaPairFromMsgs=o;g.getMediaFromMsgs=p;g.getAndCheckMediaFromMsg=q;g.bulkGetMedias=r;g.getMediaForXMA=s;g.updateMedia=t}),98);
__d("MAWDbXMATxns",["MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWJidUtils","MAWXMAUtils","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return a.xma.bulkGet(b)}function b(a,b){return b==null?d("MAWDexieTable").dexieResolve():a.xma.get({xmaId:b})}function h(a,b){return b==null?d("MAWDexieTable").dexieResolve():a.xma.where("associatedMessageId").equals(b).first()}function i(a,b){return b==null?d("MAWDexieTable").dexieResolve():a.xma.where("externalId").equals(b.externalId).filter(function(a){return a.author===b.author&&a.threadJid===b.chat}).first()}function c(a,b){return i(a,b).then(function(b){return b==null?d("WAResultOrError").makeError("missing"):d("MAWDexieTable").dexieAll([d("MAWDbMediaTxns").getMediaForXMA(a,b),d("MAWDbMsgTxns").maybeGetMsg(a,b.associatedMessageId)]).then(function(a){var c=a[0];a=a[1];if(!c.success)return d("WAResultOrError").makeError("missing");c=c.value;var e=c.favicon,f=c.header;c=c.previews;return d("WAResultOrError").makeResult({associatedMessage:a,favicon:e,header:f,previews:c,xma:b})})})}function e(a,b){return h(a,b).then(function(b){if(b==null)return;return d("MAWDbMsgTxns").maybeGetMsg(a,b.msgId)})}function f(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve([]);b=b.filter(d("MAWDbMsg").isXMAMsg).map(function(a){return d("MAWJidUtils").maybeToProtocolMsgId(a.author,a.threadJid,a.externalId)}).filter(Boolean);b=b.map(function(b){return i(a,b)});return d("MAWDexieTable").dexieAll(b).then(function(a){return a.filter(Boolean)})}function j(a,b){return a.xma.where("associatedMessageId").anyOf(b).toArray().then(function(a){a=a.filter(function(a){return a.msgId!=null&&d("MAWXMAUtils").isXMAShare(a.targetType)});return a.reduce(function(a,b){return b.associatedMessageId!=null&&b.msgId!=null?a.set(b.associatedMessageId,b.msgId):a},new Map())})}function k(a,b){return a.xma.where("associatedMessageId").equals(b).first()}function l(a,b){return a.xma.where("associatedMessageId").equals(b).first().then(function(b){if(b==null)return;b=d("MAWJidUtils").maybeToProtocolMsgId(b.author,b.threadJid,b.externalId);if(b==null)return;return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b)})}function m(a,b){return k(a,b).then(function(b){return b==null?d("WAResultOrError").makeResult():d("MAWDexieTable").dexieAll([d("MAWDbMediaTxns").getMediaForXMA(a,b),d("MAWDbMsgTxns").maybeGetMsg(a,b.associatedMessageId)]).then(function(a){var c=a[0];a=a[1];if(!c.success)return d("WAResultOrError").makeError("missing");c=c.value;var e=c.favicon,f=c.header;c=c.previews;return d("WAResultOrError").makeResult({associatedMessage:a,favicon:e,header:f,previews:c,xma:b})})})}function n(a,b,c){return d("MAWDbThreadTxns").getThread(a,c).then(function(c){if(!c.success)return;c=c.value;if(b==null)return d("MAWDexieTable").dexieResolve();c={author:b.author,chat:c.jid,externalId:b.externalId};return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,c)})}g.bulkGetXMAs=a;g.maybeGetXMAFromXMAId=b;g.maybeGetXMAFromAssociatedMsgId=h;g.maybeGetXMAFromProtocolMsgId=i;g.maybeGetXMAPayloadFromProtocolMsgId=c;g.getDbXMAMsgFromAssociatedMsgId=e;g.getXMAFromMsgs=f;g.getXMAMsgIdsFromAssociatedMsgIds=j;g.maybeGetDbXMAMsgByAssociatedMsgId=l;g.maybeGetXMAPayloadFromAssociatedMsgId=m;g.maybeGetAssociatedXMAMsg=n}),98);
__d("MAWUpdateThreadMsgMetadataApi",["MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWTransactionMode","WALogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["updated oldestMsg from id "," to id "," when oldestMsg is undefined"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["updated newestMsg from id "," to id ",", and newestMsgTs from "," to "," when newestMsg is undefined"]);i=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READWRITE},"updateThreadMsgMetadataApiTransactor",function(a){return function(b,c,e,f,g){var j=c===(e==null?void 0:e.msgId),k=f===(g==null?void 0:g.msgId);if(j&&k)return d("MAWDexieTable").dexieResolve();k||d("WALogger").ERROR(i(),f,g==null?void 0:g.msgId,b.newestMsgTs,(g==null?void 0:g.ts)==null?null:d("WATimeUtils").castUnixTimeToMillisTime(g.ts));j||d("WALogger").ERROR(h(),c,e==null?void 0:e.msgId);return d("MAWDbThreadTxns").updateThreadMsgsForUndefinedOldestOrNewestMsgs(a,b,c,e,f,g).then(function(){})}});b=a;g["default"]=b}),98);
__d("MAWDbPendingStanza",["WAAssertUnreachable"],(function(a,b,c,d,e,f,g){"use strict";var h="revoked",i="deleteForMe",j="deleteThread";b="Revoked";d="DeleteForMe";e="DeleteThread";f={DELETE_FOR_ME:d,DELETE_THREAD:e,REVOKED:b};function a(a){switch(a){case"Revoked":return h;case"DeleteForMe":return i;case"DeleteThread":return j;default:return c("WAAssertUnreachable")(a)}}g.PENDING_REVOKED=h;g.PENDING_DELETE_FOR_ME=i;g.REVOKED=b;g.DELETE_FOR_ME=d;g.PENDING_TYPE=f;g.getPendingSuffix=a}),98);
__d("MAWEBBackendQPLUtils",["MAWEBSwitch","MAWQplProxy","Random","WAHashStringToNumber","gkx","hashString","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){b=(b=b)!=null?b:c("Random").uint32();d("MAWQplProxy").startQplUserFlow(c("qpl")._(521479468,"1752"),{"int":{numMessagesRestored:0},string:{threadId:a}},b);return b}function b(a,b){d("MAWQplProxy").sendQPLSuccessThroughBridge(c("qpl")._(521479468,"1752"),{string:{threadId:b}},a)}function e(a){return a.dyiBatch.each(function(a){if(a.isThread===!1)return;d("MAWQplProxy").sendQPLFailThroughBridge(c("qpl")._(521479468,"1752"),"dyi_backup_restore_error",{string:{threadId:a.threadId}},a.qplInstanceKeyForThread)})}function f(a,b){if(b.qplInstanceKeyForThread==null)return;a=a===!1?"dyi_backup_restore_continuing":"dyi_backup_restore_finished";var e=b.qplInstanceKeyForThread;d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(521479468,"1752"),a,{annotations:{"int":{numMessages:b.numMessages,numMessagesRestored:b.numMessagesRestored},string:{threadId:b.threadId}},instanceKey:(a=e)!=null?a:void 0})}function h(a,b){if(a==null)return;d("MAWQplProxy").sendQPLErrorThroughBridge(c("qpl")._(521479468,"1752"),"dyi_backup_restore_thread_halted",{debugInfo:"DYI attempting to re-restore previous batch - halting DYI for thread "+b,instanceKey:a})}function i(a,b){if(a==null)return;d("MAWQplProxy").sendQPLErrorThroughBridge(c("qpl")._(521479468,"1752"),"dyi_backup_restore_batch_not_in_progress",{debugInfo:"DYI for thread with jid "+b+" is not currently in progress",instanceKey:a})}function j(a,b){if(a==null)return;d("MAWQplProxy").sendQPLErrorThroughBridge(c("qpl")._(521479468,"1752"),"dyi_backup_restore_stopping_dyi",{debugInfo:"Error occurred on restore - stopping DYI for thread with chat jid "+b,instanceKey:a})}function k(a,b){if(a==null)return;d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(521478596,"1329"),"dyi_get_thread_list",{annotations:{"int":{threadsToRestore:b}},instanceKey:a})}function l(a){return c("hashString")(a)}function m(a,b){if(c("gkx")("23946")!==!0)return;var e=l(b);d("MAWQplProxy").startQplUserFlow(c("qpl")._(521485625,"1876"),{bool:{eb_switch:c("MAWEBSwitch").isEnabled(),is_retroactive_backups_upload:a},string:{trace_id:b}},e)}function n(a,b,e){if(c("gkx")("23946")!==!0||a==null)return;a=l(a);d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(521485625,"1876"),b,{annotations:e,instanceKey:a})}function o(a,b,e){if(c("gkx")("23946")!==!0||a==null)return;a=l(a);d("MAWQplProxy").sendQPLFailThroughBridge(c("qpl")._(521485625,"1876"),b,e,a)}function p(a,b,e){if(a==null)return;a=d("WAHashStringToNumber").hashStringToNumber(a);d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(521485815,"2166"),b,{annotations:e,instanceKey:a})}function q(a,b,e){if(a==null)return;a=d("WAHashStringToNumber").hashStringToNumber(a);d("MAWQplProxy").sendQPLFailThroughBridge(c("qpl")._(521485815,"2166"),b,e,a)}g.startDYIBackupRestoreQplUserFlow=a;g.endSuccessDYIBackupRestoreQplUserFlow=b;g.cleanupDYIBackupRestoreQplUserFlow=e;g.addPointDYIBackupRestoreQplUserFlow=f;g.markErrorDyiBackupRestoreThreadHalt=h;g.markErrorDyiBackupRestoreBatchNotInProgress=i;g.markErrorDyiBackupRestoreStoppingDyi=j;g.logDyiE2EGetThreadList=k;g.getQplInstanceKey=l;g.startEBBackupUploadQplUserFlow=m;g.addPointEBBackupUpload=n;g.endFailEBBackupUpload=o;g.logMediaRestoreFromMIQPLPoint=p;g.logMediaRestoreFromMIQPLEndFailure=q}),98);
__d("MAWEBUploadMessageUtils",["I64","MAWDbMsg","MAWExtractMsFromExternalId","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] externalId is not a valid int64"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] Timestamp bits in externalId not valid"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] ExternalId is not present"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["echoOverrideMessageSortOrder called without ID"]);l=function(){return a};return a}function a(a){var b=a.revokedExternalId!=null?a.revokedExternalId:a.externalId;b==null&&d("WALogger").ERROR(l());b=(h||(h=d("I64"))).of_string_opt(b);if(a.serverTs==null){if(a.sortOrderMs!=null)return a.sortOrderMs;b==null&&d("WALogger").WARN(k());var c=b==null?null:d("MAWExtractMsFromExternalId").extractMsFromExternalId(b);return d("MAWDbMsg").getCanonicalTsFromMsg(a)*1e3+((c=c)!=null?c:0)}if(b!=null){c=d("MAWExtractMsFromExternalId").extractMsFromExternalId(b);if(c!=null){b=a.originalTs!=null?a.originalTs:a.serverTs;return Number(b)*1e3+c}else d("WALogger").WARN(j())}else d("WALogger").WARN(i());return d("MAWDbMsg").getSortOrderWithFallback(a)}g.echoOverrideMessageSortOrder=a}),98);
__d("MAWEncryptedBackupCacheManager",[],(function(a,b,c,d,e,f){"use strict";var g=new Map(),h=new Map(),i=new Map();function a(a,b){h.set(a,{cache:b,status:"restoring"})}function b(a){a.forEach(function(a){var b=h.get(a);b!=null&&h.set(a,{cache:b.cache,status:"done"})})}function c(a){a=h.get(a);if(a!=null)return a.status;else return"none"}function d(a){return(a=h.get(a))==null?void 0:a.cache}function e(a){return h["delete"](a)}function j(a,b){var c=g.get(a)||new Set();c.add(b);g.set(a,c)}function k(a,b){a=g.get(a);return a!=null?a==null?void 0:a.has(b):!1}function l(a,b){a=g.get(a);a!=null&&a["delete"](b)}function m(a){return h.has(a)}function n(a){return i.has(a)}function o(a){return i.get(a)}function p(a){n(a)&&i["delete"](a)}function q(a,b){i.set(a,b)}f.restoredCache=h;f.addMsgEntryToRestoredCache=a;f.setRestoredCacheStatusAsDone=b;f.getRestoredCacheStatus=c;f.getRestoredCache=d;f.removeFromRestoredCache=e;f.addMsgEntryToReuploadCache=j;f.checkForMsgEntryInReuploadCache=k;f.removeMsgEntryFromReuploadCache=l;f.peekRestoreCache=m;f.peekPendingStanzaCache=n;f.getPendingStanzaCacheValue=o;f.removePendingStanzaCacheValue=p;f.addPendingStanzaToPendingStanzaCache=q}),66);
__d("WAProtocolMsgId",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){return a.externalId===b.externalId&&a.author===b.author&&a.chat===b.chat}f.equals=a}),66);
__d("EBUploadMessages",["$InternalEnum","EchoBackupCompareUtils","EchoMessage","LSDataTraceCheckPoint","LSDataTraceType","LSEBPayloadSerializerError","LSIntEnum","LSMEBTaskCreationSource","MAWBridge","MAWBridgeEventTransmitter","MAWBridgeTrace","MAWBridgeUpload","MAWConstants","MAWDbMsg","MAWDbMsgTxns","MAWDbMsgUtil","MAWDbPendingStanza","MAWDbThreadTxns","MAWDbXMA","MAWDexieTable","MAWEBBackendQPLUtils","MAWEBSwitch","MAWEBUploadMessageUtils","MAWEBUploadTrackingUtils","MAWEncryptedBackupCacheManager","MAWHMACKey","MAWHandlePendingStanzasInRestoreV2","MAWIndexedDb","MAWMsgType","MAWQplProxy","MAWTraceUtils","MAWTransactionMode","Promise","WAGlobals","WAJids","WALogger","WAMediaUtils","WAProtocolMsgId","WAStanzaUtils","WATimeUtils","asyncToGeneratorRuntime","cr:5916","cr:8231","cr:8232","gkx","qpl","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot proceed with encodeAndSendEchoMessage: Encrypted Backups are not enabled"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot proceed with encodeAndSendEchoMessage: Encrypted Backups are not enabled"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Duplicated upload stopped by cache, extId: ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to get upload with EBLS: ",""]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] threadJid is null for pendingStanza"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] externalId is null for pendingStanza"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] pendingStanzaMessageType: "," not supported"]);u=function(){return a};return a}var v=c("requireDeferred")("EchoSerializationFailureFalcoEvent").__setRef("EBUploadMessages"),w=c("requireDeferred")("EchoSerializationSuccessFalcoEvent").__setRef("EBUploadMessages");function a(a,b){a=b.messageIds;var c=b.oldTraceIdMap,e=b.pendingStanzaIds,f=b.reactionIds,g=b.uploadTrackingInstanceMap;b=b.xmaIds;b=d("MAWDbXMA").convertNumbersToXMAIds(b);e=(e=e)!=null?e:[];return y(a,e,f,b,c,g)}function e(a){return a==null?[]:a.filter(Boolean).map(function(a){if(a!=null)return d("MAWDbMsg").toMsgId(a)}).filter(Boolean)}var x=b("$InternalEnum").Mirrored(["FATAL","WARN"]);function y(a,b,c,d,e,f){a=D(a,b,c,d).then(function(a){return P(a,void 0,!1,e,f)});return a.then(function(){})}function z(a,b){return a.messages.bulkGet(b).then(function(a){return a.filter(Boolean)})}function A(a,b){return a.pendingStanzas.bulkGet(b).then(function(a){return a.filter(Boolean).map(function(a){var b=a.pendingContent.type;if(b==null||b!==d("MAWDbPendingStanza").PENDING_TYPE.REVOKED&&b!==d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME){d("WALogger").WARN(u(),b);return}b=a.pendingContent.content.externalId;if(b==null){d("WALogger").WARN(t());return}b=a.pendingContent.content.threadJid;if(b==null){d("WALogger").WARN(s());return}d("MAWHandlePendingStanzasInRestoreV2").issuePointQueryForPendingStanza(a)})}).then(function(a){return[]})}function B(a,b){return a.reactions.bulkGet(b).then(function(b){b=b.filter(Boolean).map(function(b){return d("MAWDbThreadTxns").getThread(a,b.threadJid).then(function(e){var f=e.success?e.value:null;if(f!=null&&f.chatId!=null){e=b.reactToAuthor;e=e===d("WAGlobals").getMyUserJid()?d("WAJids").AUTHOR_ME:e;return d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,b.reactToExternalId,f.jid,e).then(function(a){if(a==null&&!d("MAWEncryptedBackupCacheManager").peekRestoreCache(b.reactToExternalId)){var e=d("WAJids").threadIdForChatJid(f.jid);d("MAWEncryptedBackupCacheManager").addMsgEntryToReuploadCache(f.jid,b.reactToExternalId);d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(b.reactToExternalId,e,void 0,c("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT,f.jid)}return a})}})});return d("MAWDexieTable").dexieAll(b).then(function(a){return a.filter(Boolean)})})}function C(a,b){b=b.filter(Boolean);return a.xma.bulkGet(b).then(function(b){b=b.map(function(a){return a==null?void 0:a.associatedMessageId}).filter(Boolean);return a.messages.where("msgId").anyOf(b).toArray()})}var D=d("MAWIndexedDb").makeMsgrTransactor({messages:(j=d("MAWTransactionMode")).READONLY,pendingStanzas:j.READONLY,reactions:j.READONLY,threads:j.READONLY,xma:j.READONLY},"uploadMsgBackupGetMsgs",function(a){return function(b,c,d,e){return R(a,b,c,d,e)}});function E(a,c,e){c.forEach(function(a){a.uploadTrackingInstanceKey!=null&&(b("cr:8231")!=null?d("MAWEBUploadTrackingUtils").addPointWorkerOnly(a.uploadTrackingInstanceKey,"fire_ebls_upload"):d("MAWEBUploadTrackingUtils").addPointWorkerOnly(a.uploadTrackingInstanceKey,"fire_ui_event"))}),b("cr:8231")!=null?b("cr:8231")==null?void 0:b("cr:8231").init().then(function(){return b("cr:8231")==null?void 0:b("cr:8231").getLSStorage().then(function(a){return a.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){for(var d of c)yield b("cr:8232")==null?void 0:b("cr:8232").call(a,d)});return function(b){return a.apply(this,arguments)}}(),"readwrite")})})["catch"](function(a){d("WALogger").ERROR(r(),a)}):F({tag:"UploadMessageByBatch",value:{checkPoint:a,messages:c,qpl:e}})}function F(a){a=[a];d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:a})}function G(a,b,e){var f=[],g=[];if(a!=null){var h=c("gkx")("23946"),j=c("qpl")._(521485625,"1876");b.forEach(function(b){var c=b.checkPoint;b=b.pointName;h&&b!=null&&f.push({action:{name:b,type:"point"},annotations:null,event:j,instanceKey:d("MAWEBBackendQPLUtils").getQplInstanceKey(a),timestamp:d("MAWQplProxy").performanceAbsoluteNow()});g.push(d("MAWBridgeTrace").createBridgeTraceRecordCheckpointData((i||(i=d("LSIntEnum"))).ofNumber(c),(b=e)!=null?b:a,void 0,!1,-1,void 0))})}return{checkPointArray:g,qplArray:f}}function H(a,b,c,e,f,g,h){var i=b.xOfflineThreadingId;if(i==null)return!1;var j=d("WAStanzaUtils").toStanzaId(i);if(d("MAWEncryptedBackupCacheManager").getRestoredCacheStatus(j)==="done"){var k=d("EchoBackupCompareUtils").buildEchoDocCacheValue(b);k=d("EchoBackupCompareUtils").echoEquals(k,d("MAWEncryptedBackupCacheManager").getRestoredCache(j));d("MAWEncryptedBackupCacheManager").removeFromRestoredCache(j);if(k){d("WALogger").LOG(q(),j);return!1}}if(c!=null&&e!=null){k=window.performance.now();var l=d("EchoMessage").encodeEchoMessage(b),m=window.performance.now();h=h==null?void 0:h.get(j);if(h==null&&b.mediaData!=null){j=b.mediaData.xAttachmentType;h={mediaObjectId:d("WAMediaUtils").stringToDeliveryObjectId(b.mediaData.attachmentObjectId),mediaType:j}}a.push(d("MAWBridgeUpload").createBridgeUploadMessage({actionType:1,attachmentContext:h,authTs:c.serverTs,echoDocument:l,echoEncodingLatencyNs:(m-k)*1e6,errorCode:null,errorMessage:null,messageId:i,messageType:c.type,productType:"msgr",protoMsg:f,sortOrderMs:d("MAWEBUploadMessageUtils").echoOverrideMessageSortOrder(c),threadId:b.threadId,traceId:e,uploadTrackingInstanceKey:M(g,c.externalId)}));N("point",g,c.externalId,"construct_echo_success");J(c.externalId,e);return!0}return!1}function I(a,b){a!=null&&void v.load().then(function(c){return c.log(function(){return{message_id:a,trace_id:b}})})}function J(a,b){a!=null&&void w.load().then(function(c){return c.log(function(){return{message_id:a,trace_id:b}})})}function K(a,b,c){if(a==null||b==null)return c;else{b=M(b,a.externalId);if(b!=null)return b.toString();else return c}}function L(a,b,e,f){var g=new Map();a.forEach(function(a){return g.set(a.dbMsg.externalId,a)});return Q(a).then(function(a){var h=[],j=[],k=[];a.forEach(function(a){var l,m=g.get(a.externalId)||{dbMsg:null,traceId:null},n=m.dbMsg;m=m.traceId;l=n!=null?(l=b==null?void 0:b.find(function(a){var b=d("MAWDbMsgUtil").getProtocolMsgIdFromDbMsg(n);return b==null?!1:d("WAProtocolMsgId").equals(a.msgId,b)}))!=null?l:void 0:void 0;var o=a.echoMessage,q=[],r=K(n,e,m);if(a.maybeErrorDetail!=null){a=a.maybeErrorDetail;if(n!=null&&m!=null)if(a.uploadErrorType===x.WARN||a.errorCode===c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID){var s;s=a.uploadErrorType===x.WARN?"possible error when constructing echo message: "+((s=a.errorMsg)!=null?s:""):"media info invalid thrown from constructEchoMessage, error msg: "+((s=a.errorMsg)!=null?s:"");d("WALogger").WARN(p(),s);N("success",e,n.externalId,"construct_echo_success_media/xma_warn/error",{string:{errorMsg:s}});I(n.externalId,m)}else{h.push(d("MAWBridgeUpload").createBridgeUploadMessage({actionType:1,authTs:n.serverTs,echoDocument:null,echoEncodingLatencyNs:null,errorCode:a.errorCode,errorMessage:a.errorMsg,messageId:(s=o==null?void 0:o.xOfflineThreadingId)!=null?s:"0",messageType:n.type,protoMsg:l,sortOrderMs:d("MAWEBUploadMessageUtils").echoOverrideMessageSortOrder(n),threadId:(s=o==null?void 0:o.threadId)!=null?s:"0",traceId:m,uploadTrackingInstanceKey:M(e,n.externalId)}));N("fail",e,n.externalId,"construct_echo_failed",{string:{errorMsg:(s=a.errorMsg)!=null?s:"null error msg, msg type: "+n.type}});J(n.externalId,m)}return}if((o==null?void 0:o.xOfflineThreadingId)==null){if(n!=null&&m!=null){h.push(d("MAWBridgeUpload").createBridgeUploadMessage({actionType:1,authTs:n.serverTs,echoDocument:null,echoEncodingLatencyNs:null,errorCode:c("LSEBPayloadSerializerError").OTID_NOT_FOUND_IN_ACT_MESSAGES,errorMessage:null,messageId:"0",messageType:n.type,protoMsg:l,sortOrderMs:d("MAWEBUploadMessageUtils").echoOverrideMessageSortOrder(n),threadId:(a=o==null?void 0:o.threadId)!=null?a:"0",traceId:m,uploadTrackingInstanceKey:M(e,n.externalId)}));N("fail",e,n.externalId,"construct_echo_failed",{string:{errorMsg:"oitd not found"}});J(n.externalId,m)}}else{s=H(h,o,n,m,l,e,f);if(!s){n!=null&&N("success",e,n.externalId,"construct_echo_success_duplicate_message",{string:{errorMsg:"not unique from cache"}});return}}q.push({checkPoint:c("LSDataTraceCheckPoint").LABYRINTH_WEB_UPLOAD_ISSUE_MESSAGE_UPLOAD_UI_EVENT,pointName:"issue_message_upload_ui_event"});a=G(m,q,r);o=a.checkPointArray;l=a.qplArray;j.push.apply(j,l);k.push.apply(k,o);d("MAWTraceUtils").startNewTrace((i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_UPLOAD),d("MAWTraceUtils").CONTEXT_BACKUP_UPLOAD,r);(h.length>=d("MAWConstants").BRIDGE_UPLOAD_BATCH_SIZE||k.length>=d("MAWConstants").BRIDGE_UPLOAD_BATCH_SIZE)&&(E(k.slice(),h.slice(),j.slice()),k.length=0,h.length=0,j.length=0)});(h.length>0||k.length>0)&&E(k,h,j);return a})}function M(a,b){return a.get(b)}function N(a,b,c,e,f){b=M(b,c);if(b!=null)switch(a){case"success":d("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(b,e,f);break;case"fail":d("MAWEBUploadTrackingUtils").endFailWorkerOnly(b,e,f);break;case"point":d("MAWEBUploadTrackingUtils").addPointWorkerOnly(b,e,f);break}}function O(a){var b=new Set(),c=[];a.forEach(function(a){var e=a.externalId+"|"+d("WAJids").threadIdForChatJid(a.threadJid)+"|"+a.author;d("MAWEncryptedBackupCacheManager").getRestoredCacheStatus(a.externalId)!=="restoring"&&!b.has(e)&&(b.add(e),c.push(a))});return c}function P(a,e,f,g,i,j){if(!c("MAWEBSwitch").isEnabled()){d("WALogger").LOG(o());i.forEach(function(a,b){d("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(a,"upload_tracking_cancelled_eb_turned_off_upload",{string:{externalId:b,from:"uploadUniqueMessage"}})});return(h||(h=b("Promise"))).resolve()}a=O(a).filter(function(a){return d("MAWEBUploadTrackingUtils").isUploadSupported(a)}).map(function(a){var b;b=(b=f)!=null?b:!1;b={bool:{isMedia:d("MAWMsgType").isMAWSupportedMediaType(a.type),isRetroactiveBackupsUpload:b},string:{msgType:a.type}};N("point",i,a.externalId,"construct_echo_start",b);b=((b=M(i,a.externalId))!=null?b:d("MAWTraceUtils").createTraceId()).toString();d("MAWEBBackendQPLUtils").startEBBackupUploadQplUserFlow(f,b);f!=null&&f&&d("MAWEBBackendQPLUtils").addPointEBBackupUpload(b,"retroactive_backup_upload_started");return{lastRetryTs:d("WATimeUtils").millisTime(),msg:a,retriedTimes:0,traceId:b}});return S(a.map(function(a){var b=a.msg.quoteExternalId;if(b!=null)return{dbMsg:a.msg,quotedMsg:e==null?void 0:e.get(b),traceId:a.traceId};else return{dbMsg:a.msg,traceId:a.traceId}}),g,j,i).then(function(){return(h||(h=b("Promise"))).resolve()})}function f(a,e,f,g){if(!c("MAWEBSwitch").isEnabled()){d("WALogger").LOG(n());e.forEach(function(a,b){d("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(a,"upload_tracking_cancelled_eb_turned_off_upload",{string:{externalId:b,from:"uploadMessageFromUploadQueue"}})});return(h||(h=b("Promise"))).resolve()}return S(a.filter(function(a){var b=d("MAWEBUploadTrackingUtils").isUploadSupported(a);b||N("success",e,a.externalId,"upload_not_supported",{string:{msgType:a.type}});return b}).map(function(a){var b;b=((b=M(e,a.externalId))!=null?b:d("MAWTraceUtils").createTraceId()).toString();N("point",e,a.externalId,"construct_echo_start");return{dbMsg:a,traceId:b}}),void 0,f,e,g).then(function(){return(h||(h=b("Promise"))).resolve()})}var Q=d("MAWIndexedDb").makeMsgrTransactor({editMsgHistory:j.READONLY,media:j.READONLY,mediaBackup:j.READONLY,messages:j.READONLY,reactions:j.READONLY,threads:j.READONLY,xma:j.READONLY},"constructEchoMessage",function(a){return function(){for(var c=arguments.length,d=new Array(c),e=0;e<c;e++)d[e]=arguments[e];return b("cr:5916").constructEchoMessage.apply(b("cr:5916"),[a].concat(d))}});function R(a,b,e,f,g){b=z(a,b);c("gkx")("2251")?A(a,e):d("MAWDexieTable").dexieResolve();e=B(a,f);f=C(a,g);return d("MAWDexieTable").dexieAll([b,e,f]).then(function(a){return a.flat()})}function S(a,e,f,g,j){var n=new Map();a.forEach(function(a){var b=a.dbMsg;a=a.traceId;d("MAWEBBackendQPLUtils").addPointEBBackupUpload(a,"echo_message_upload_begin",{string:{message_type:b.type}});var f=d("MAWQplProxy").startQplUserFlow(c("qpl")._(521475102,"868"),{bool:{eb_switch:c("MAWEBSwitch").isEnabled()},"int":{sort_order:b.sortOrderMs,timestamp:Date.now()},string:{hashed_msgid:T(b.externalId),message_id:b.externalId,message_type:b.type.toString(),org_trace_id:e==null?void 0:e.get(b.externalId),trace_id:a}});n.set(b.externalId,{constructEchoFlow:f,traceId:a})});a=L(a,f,g,j)["catch"](function(a){a="[labyrinth_web] Error while encode and upload message to backup: "+String(a);d("WALogger").ERROR(m(),a);for(var e of n.values())d("MAWEBBackendQPLUtils").endFailEBBackupUpload(e.traceId,"echo_message_upload_failure",{string:{error_message:a}}),d("MAWTraceUtils").recordFailureAndFlushForTraceId(e.traceId,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_ECHO_MESSAGE_UPLOAD_FAILURE),[],a),e.constructEchoFlow.endFail("serialisation_failure");return(h||(h=b("Promise"))).resolve()});return a.then(function(a){a==null?void 0:a.forEach(function(a){var b;b=(b=a.echoMessage)==null?void 0:b.messageId;if(b!=null&&n.has(d("WAStanzaUtils").toStanzaId(b))){var e;b=n.get(d("WAStanzaUtils").toStanzaId(b))||{constructEchoFlow:null,traceId:null};var f=b.constructEchoFlow;b=b.traceId;e=a==null?void 0:(e=a.maybeErrorDetail)==null?void 0:e.uploadErrorType;a=a==null?void 0:(a=a.maybeErrorDetail)==null?void 0:a.errorMsg;if(e!=null)switch(e){case x.WARN:a!=null&&d("WALogger").WARN(l(),a);f==null?void 0:f.endSuccess({bool:{is_skipped:!0}});b!=null&&(d("MAWEBBackendQPLUtils").addPointEBBackupUpload(b,"echo_message_upload_invalid_request"),d("MAWTraceUtils").recordInvalidUploadRequestAndFlushTrace(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_ECHO_MESSAGE_UPLOAD_INVALID_REQUEST),[]));break;case x.FATAL:a=(e=a)!=null?e:"[labyrinth_web] unknown error in the upload message flow";d("WALogger").ERROR(k(),a);b!=null&&(d("MAWEBBackendQPLUtils").endFailEBBackupUpload(b,"echo_message_upload_failure",{string:{error_message:a}}),d("MAWTraceUtils").recordFailureAndFlushForTraceId(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_ECHO_MESSAGE_UPLOAD_FAILURE),[],a));f==null?void 0:f.endFail("serialisation_failure");break}else f==null?void 0:f.endSuccess()}});return(h||(h=b("Promise"))).resolve()})}function T(a){if(a==null)return"";var b=d("WAGlobals").getHMACKey();return d("MAWHMACKey").hmacTweetNaCl(a,b)}function U(a,b){var e=d("MAWTraceUtils").startNewTrace((i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_UPLOAD),d("MAWTraceUtils").CONTEXT_BACKUP_UPLOAD);d("MAWTraceUtils").recordCheckpointForTrace(e,i.ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_ECHO_MESSAGE_UPLOAD_BEGIN),[d("MAWTraceUtils").getTagForMsgType(a.type)],!1);d("MAWIndexedDb").afterTransaction({tag:"UploadMessage",value:d("MAWBridgeUpload").createBridgeUploadMessage({actionType:2,authTs:a.serverTs,echoDocument:null,echoEncodingLatencyNs:null,errorCode:null,errorMessage:null,messageId:a.externalId,messageType:a.type,sortOrderMs:d("MAWEBUploadMessageUtils").echoOverrideMessageSortOrder(a),threadId:d("WAJids").threadIdForChatJid(b),traceId:e,uploadTrackingInstanceKey:null})})}g.uploadMessages=a;g.convertStringMsgIdtoMsgId=e;g.UploadErrorType=x;g.uploadMessagesBackupWithSeparateTransactions=y;g.deduplicateMessageArray=O;g.uploadUniqueMessage=P;g.uploadMessageFromUploadQueue=f;g.getMessagesBackupForUpload=R;g.sendDeleteEchoMessage=U}),98);
__d("MAWBridgeThread",["MAWTimeUtils","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){var g=d("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(a){return!0},user:function(a){return!1}});return{authoritativeThreadKey:c,cannotReplyReason:a.cannotReplyReason,clientThreadKey:b,description:e,folder:a.folder,isGroup:g,jid:a.jid,lastActivityTs:d("MAWTimeUtils").ensureValidMillisTime(a.snippetMsgTs!=null&&d("WATimeUtils").fromMillisTime(a.snippetMsgTs)!==0?a.snippetMsgTs:f)||d("WATimeUtils").castToMillisTime(0),lastReadTs:d("MAWTimeUtils").ensureValidMillisTime(a.lastReadMsgTs)||d("WATimeUtils").castToMillisTime(0),muteExpireTimeMs:(c=a.muteExpireTimeMs)!=null?c:0}}function b(a,b,c,d){return{lastActivityTimestampMs:c,lastReadWatermarkTs:b,markUnread:d,threadJid:a}}g.createBridgeThread=a;g.createBridgeThreadTimestampsUpdated=b}),98);
__d("MAWGetOrCreateThreadTxns",["MAWAdminMsgTxns","MAWBridgeThread","MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDbThread","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","MAWWriteBulkWriteIncomingAdminMsgTxns","WATimeUtils","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){if(a!=null&&b!=null){var c=d("WATimeUtils").fromMillisTime(a),e=d("WATimeUtils").fromMillisTime(b);return d("WATimeUtils").castToMillisTime(Math.max(c,e))}return(c=a)!=null?c:b}function i(a,b){return a.threads.get({jid:b})}function j(a,b){return a.threads.where("jid").anyOf(b).toArray().then(function(a){var c=new Map();for(var a=a,d=Array.isArray(a),e=0,a=d?a:a[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var f;if(d){if(e>=a.length)break;f=a[e++]}else{e=a.next();if(e.done)break;f=e.value}f=f;c.set(f.jid,f)}return b.map(function(a){return c.get(a)})})}function a(a,b){var c=b.deduplicationKey,e=b.jid;c=b.deduplicationKey!=null?a.threads.get({deduplicationKey:c}):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([c,i(a,e)]).then(function(c){var d=c[0];c=c[1];if(d!=null)return{created:!1,thread:d};if(c==null)return l(a,b).then(function(a){return{created:!0,thread:a}});else return o(a,b,c).then(function(a){return{created:!1,thread:a}})})}function b(a,b){var c=b.map(function(a){a=a.deduplicationKey;return a}).filter(function(a){return a!=null});c=a.threads.where("deduplicationKey").anyOf(c).toArray();return d("MAWDexieTable").dexieAll([c,j(a,b.map(function(a){a=a.jid;return a}))]).then(function(c){var e=c[0];c=c[1];var f=new Map();for(var e=e,g=Array.isArray(e),h=0,e=g?e:e[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var i;if(g){if(h>=e.length)break;i=e[h++]}else{h=e.next();if(h.done)break;i=h.value}i=i;i.deduplicationKey!=null&&f.set(i.deduplicationKey,i)}var j={};i=[];h=[];for(g=c.entries(),e=Array.isArray(g),c=0,g=e?g:g[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var k,l;if(e){if(c>=g.length)break;l=g[c++]}else{c=g.next();if(c.done)break;l=c.value}l=l;var n=l[0];l=l[1];k=(k=b[n])==null?void 0:k.deduplicationKey;if(k!=null){var o=f.get(k);if(o!=null){j[k]={created:!1,thread:o};continue}}l==null?i.push(b[n]):h.push({params:b[n],thread:l})}return d("MAWDexieTable").dexieAll([i.length?m(a,i):d("MAWDexieTable").dexieResolve([]),h.length?p(a,h):d("MAWDexieTable").dexieResolve([])]).then(function(a){var c=a[0];a=a[1];for(var c=c,d=Array.isArray(c),e=0,c=d?c:c[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var f;if(d){if(e>=c.length)break;f=c[e++]}else{e=c.next();if(e.done)break;f=e.value}f=f;j[f.jid]={created:!0,thread:f}}for(f=a,e=Array.isArray(f),d=0,f=e?f:f[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){if(e){if(d>=f.length)break;c=f[d++]}else{d=f.next();if(d.done)break;c=d.value}a=c;j[a.jid]={created:!1,thread:a}}return b.map(function(a){var b=a.deduplicationKey;a=a.jid;if(b!=null){return(b=j[b])!=null?b:j[a]}return j[a]})})})}function k(a){var b=a.authoritativeThreadKey,c=a.clientThreadKey,e=a.createTs,f=a.deduplicationKey,g=a.folder,h=a.jid;a=a.lastActivityTimestamp;e=(a=(a=a)!=null?a:e)!=null?a:d("WATimeUtils").millisTime();b={authoritativeThreadKey:b!=null?b:void 0,deduplicationKey:f,folder:g!=null?g:d("MAWFolderTypes").FOLDER_ID.INBOX,jid:h,lastReadMsg:null,lastReadMsgReceiptSent:null,newestMsg:null,newestMsgTs:e,oldestMsg:null,optimisticThreadKey:(a=c)!=null?a:void 0,threadOrder:d("MAWDbThread").craftThreadOrder(e,h)};return b}function l(a,b){var e=b.authoritativeThreadKey,f=b.description,g=b.skipVerifyThread,h=k(b);return a.threads.add(h).then(function(b){b=babelHelpers["extends"]({},h,{chatId:b});g!==!0&&d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(b,b.optimisticThreadKey,e,f,h.newestMsgTs)});return d("MAWAdminMsgTxns").writeE2EEThreadDescriptionMsg(a,b)})["catch"](function(a){a=c("getErrorSafe")(a);a.message="Error creating thread: "+a.message;throw a})}function m(a,b){var e=b.map(k);return a.threads.bulkAdd(e,{allKeys:!0}).then(function(c){c=c.map(function(a,c){return{data:babelHelpers["extends"]({},e[c],{chatId:a}),params:b[c]}});for(var f=c,g=Array.isArray(f),h=0,f=g?f:f[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var i;if(g){if(h>=f.length)break;i=f[h++]}else{h=f.next();if(h.done)break;i=h.value}i=i;i.params.skipVerifyThread!==!0&&d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(i.data,i.data.optimisticThreadKey,i.params.authoritativeThreadKey,i.params.description)})}return d("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreads(a,c.map(function(a){return a.data}))})["catch"](function(a){a=c("getErrorSafe")(a);a.message="Error bulk creating threads: "+a.message;throw a})}function n(a,b,c){var d=b.authoritativeThreadKey,e=b.clientThreadKey,f=b.deduplicationKey,g=b.folder;b=b.lastActivityTimestamp;return babelHelpers["extends"]({},a,{authoritativeThreadKey:(d=d)!=null?d:a.authoritativeThreadKey,cannotReplyReason:g!=null||e!=null?null:a.cannotReplyReason,deduplicationKey:g!=null||e!=null?f:a.deduplicationKey,folder:(d=g)!=null?d:a.folder,newestMsgTs:h(c,b),optimisticThreadKey:(f=e)!=null?f:a.optimisticThreadKey})}function o(a,b,e){var f=b.authoritativeThreadKey,g=b.description,h=b.skipVerifyThread;return d("MAWDbMsgTxns").getThreadNewestMessageTs(a,e).then(function(i){var j=n(e,b,i);return a.threads.update(e.chatId,j).then(function(){var a;h!==!0&&d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(j,j.optimisticThreadKey,f,g,i)});d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({folder:(a=j==null?void 0:j.folder)!=null?a:d("MAWFolderTypes").FOLDER_ID.INBOX,threadJid:j.jid})});return j})["catch"](function(a){a=c("getErrorSafe")(a);a.message="Error updating thread: "+a.message;throw a})})}function p(a,b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.params,e=b.thread;return d("MAWDbMsgTxns").getThreadNewestMessageTs(a,e).then(function(a){a=n(e,c,a);return{params:c,thread:a}})})).then(function(b){return a.threads.bulkUpdate(b.map(function(a){a=a.thread;return{changes:a,key:a.chatId}})).then(function(){for(var a=b,c=Array.isArray(a),e=0,a=c?a:a[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var f;if(c){if(e>=a.length)break;f=a[e++]}else{e=a.next();if(e.done)break;f=e.value}f=f;var g=f.params,h=g.authoritativeThreadKey,i=g.description;g=g.skipVerifyThread;f=f.thread;g!==!0&&d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(f,f.optimisticThreadKey,h,i)});d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({folder:(g=f==null?void 0:f.folder)!=null?g:d("MAWFolderTypes").FOLDER_ID.INBOX,threadJid:f.jid})})}return b.map(function(a){a=a.thread;return a})})})["catch"](function(a){a=c("getErrorSafe")(a);a.message="Error bulk updating threads: "+a.message;throw a})}g.getExistingThread=i;g.bulkGetExistingThread=j;g.getOrCreateThread=a;g.bulkGetOrCreateThread=b;g.createThread=l;g.bulkCreateThread=m;g.updateThread=o;g.bulkUpdateThread=p}),98);
__d("MAWLocalizationUtils",["MAWAckLevel","MAWExternalId","MAWLocalizationType","MAWMsgType","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){return{ack:d("MAWAckLevel").ACK.sent,altIndex:(e=e)!=null?e:void 0,author:d("WAJids").AUTHOR_SYSTEM,externalId:d("MAWExternalId").generateExternalId(),msgContent:a,sortOrderMs:f,threadJid:b,ts:(e=c)!=null?e:d("WATimeUtils").unixTime(),type:d("MAWMsgType").MSG_TYPE.ADMIN}}function b(a){switch(a){case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_NAMED_GROUP:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_NAMED_GROUP:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_NAMED_GROUP:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_ONE_PARTICIPANT:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_TWO_PARTICIPANTS:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MORE_THAN_TWO_PARTICIPANTS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_MORE_THAN_ONE_USERS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MORE_THAN_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_ONE_PARTICIPANT:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_TWO_PARTICIPANTS:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MORE_THAN_TWO_PARTICIPANTS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_MORE_THAN_ONE_USERS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MORE_THAN_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_LEFT_GROUP:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SELF_DEMOTED:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_PROMOTED_PARTICIPANT:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_DEMOTED_PARTICIPANT:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_GOT_PROMOTED:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_GOT_DEMOTED:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_GOT_PROMOTED:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_GOT_DEMOTED:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_PROMOTED_YOU:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_DEMOTED_YOU:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_PROMOTED_PARTICIPANT:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SELF_DEMOTED:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_DEMOTED_PARTICIPANT:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UPDATED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UPDATED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_HOTLIKE:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_THEME:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_PHOTO:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_PINNED_MESSAGE:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UNPINNED_MESSAGE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_HOTLIKE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_THEME:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_PHOTO:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_PINNED_MESSAGE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UNPINNED_MESSAGE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_PARTICIPANT_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CLEAR_PARTICIPANT_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_CURRENT_USER_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SET_OWN_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CLEAR_OWN_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CLEAR_PARTICIPANT_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SET_OWN_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CLEAR_OWN_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CLEAR_CURRENT_USER_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_MINUTES:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_MINUTES:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_HOURS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_HOURS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_DAYS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_DAYS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_OFF:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_SECONDS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_SECONDS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_TAKE_SCREENSHOT:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_RECORD_SCREEN:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SET_ADD_MODE_ADMIN_ONLY:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SET_ADD_MODE_ALL_MEMBERS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SET_ADD_MODE_ADMIN_ONLY:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SET_ADD_MODE_ALL_MEMBERS:case d("MAWLocalizationType").LOCALIZATION_TYPE.SERVER_SET_ADD_MODE_ADMIN_ONLY:case d("MAWLocalizationType").LOCALIZATION_TYPE.SERVER_SET_ADD_MODE_ALL_MEMBERS:return!0}return!1}function c(a){switch(a){case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UPDATED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UPDATED_DEVICE:return!0}return!1}function e(a){switch(a){case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_ONE_PARTICIPANT:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_TWO_PARTICIPANTS:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MORE_THAN_TWO_PARTICIPANTS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_MORE_THAN_ONE_USERS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MORE_THAN_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU_AND_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU_AND_MORE_THAN_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_MORE_THAN_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_ONE_PARTICIPANT:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_TWO_PARTICIPANTS:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MORE_THAN_TWO_PARTICIPANTS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_MORE_THAN_ONE_USERS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MORE_THAN_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_YOU:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_YOU_AND_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_YOU_AND_MORE_THAN_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_MORE_THAN_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_LEFT_GROUP:return!0}return!1}g.buildUnstoredDbAdminMsg=a;g.isAdminMsgNormalized=b;g.isDeviceChangeAdminMsg=c;g.isParticipantChangeAdminMsg=e}),98);
__d("MAWAdminMsgTxns",["MAWDbMsg","MAWDbThread","MAWDbThreadTxns","MAWLocalizationType","MAWLocalizationUtils","MAWTimeUtils","MAWWriteBulkWriteIncomingAdminMsgTxns","MAWWriteMsgTxns","WALogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["writeReachabilityErrorAdminMsg failed to create or get 1:1 thread"]);h=function(){return a};return a}function a(a,b,c){var e=a.ts;e=d("WATimeUtils").castUnixTimeToMillisTime(e);c=d("MAWTimeUtils").ensureValidMillisTime(c)||d("WATimeUtils").castToMillisTime(0);e=e>c?e:c;return babelHelpers["extends"]({},b,{newestMsg:a.msgId,newestMsgTs:e,oldestMsg:a.msgId,snippetMsg:a.msgId,snippetMsgTs:d("WATimeUtils").castUnixTimeToMillisTime(d("MAWDbMsg").getCanonicalTsFromMsg(a)),threadOrder:d("MAWDbThread").craftThreadOrder(e,b.jid)})}function b(a,b){return d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success){d("WALogger").WARN(h());return}b=b.value;var c=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.REACHABILITY_ERROR,version:0},b.jid,d("WATimeUtils").castMillisTimeToUnixTime(d("WATimeUtils").millisTime()));return d("MAWWriteMsgTxns").writeMsg(a,c,b).then(function(){})})}function c(a,b){return d("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreads(a,[b]).then(function(a){a=a[0];return a})}function e(a){var b=d("MAWDbMsg").craftE2eeAdminMsgAltIndex(a.chatId);b=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION,version:0},a.jid,d("WATimeUtils").castToUnixTime(0),b);return babelHelpers["extends"]({},b,{msgId:d("MAWDbMsg").craftMsgIdV2(a.chatId,1,b),sortOrderMs:0})}g.getUpdatedThreadForAdminMsg=a;g.writeReachabilityErrorAdminMsg=b;g.writeE2EEThreadDescriptionMsg=c;g.buildE2EEThreadDescriptionMsg=e}),98);
__d("MAWAdminMsgTypesGrouped",["MAWLocalizationType"],(function(a,b,c,d,e,f,g){"use strict";b=[(a=d("MAWLocalizationType")).LOCALIZATION_TYPE.CUTOVER_IGD_THREAD_ADMIN_MESSAGE,a.LOCALIZATION_TYPE.CUTOVER_THREAD_ADMIN_MESSAGE,a.LOCALIZATION_TYPE.DUAL_THREAD_CUTOVER_ADMIN_MESSAGE];c=[a.LOCALIZATION_TYPE.CURRENT_USER_ADDED_DEVICE,a.LOCALIZATION_TYPE.CURRENT_USER_REMOVED_DEVICE,a.LOCALIZATION_TYPE.CURRENT_USER_UPDATED_DEVICE,a.LOCALIZATION_TYPE.PARTICIPANT_ADDED_DEVICE,a.LOCALIZATION_TYPE.PARTICIPANT_REMOVED_DEVICE,a.LOCALIZATION_TYPE.PARTICIPANT_UPDATED_DEVICE];e=[a.LOCALIZATION_TYPE.CURRENT_USER_ADDED_MORE_THAN_TWO_PARTICIPANTS,a.LOCALIZATION_TYPE.CURRENT_USER_ADDED_ONE_PARTICIPANT,a.LOCALIZATION_TYPE.CURRENT_USER_ADDED_TWO_PARTICIPANTS,a.LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MORE_THAN_TWO_PARTICIPANTS,a.LOCALIZATION_TYPE.CURRENT_USER_REMOVED_ONE_PARTICIPANT,a.LOCALIZATION_TYPE.CURRENT_USER_REMOVED_TWO_PARTICIPANTS,a.LOCALIZATION_TYPE.PARTICIPANT_ADDED_MORE_THAN_TWO_USER,a.LOCALIZATION_TYPE.PARTICIPANT_ADDED_ONE_USER,a.LOCALIZATION_TYPE.PARTICIPANT_ADDED_TWO_USER,a.LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU,a.LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_MORE_THAN_ONE_USERS,a.LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_ONE_USER,a.LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MORE_THAN_TWO_USER,a.LOCALIZATION_TYPE.PARTICIPANT_REMOVED_ONE_USER,a.LOCALIZATION_TYPE.PARTICIPANT_REMOVED_TWO_USER,a.LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU,a.LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_MORE_THAN_ONE_USERS,a.LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_ONE_USER,a.LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_MORE_THAN_TWO_USER,a.LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_ONE_USER,a.LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_TWO_USER,a.LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU,a.LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU_AND_MORE_THAN_ONE_USER,a.LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU_AND_ONE_USER,a.LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_MORE_THAN_TWO_USER,a.LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_ONE_USER,a.LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_TWO_USER,a.LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_YOU,a.LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_YOU_AND_MORE_THAN_ONE_USER,a.LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_YOU_AND_ONE_USER];f=[a.LOCALIZATION_TYPE.CURRENT_USER_DEMOTED_PARTICIPANT,a.LOCALIZATION_TYPE.CURRENT_USER_PROMOTED_PARTICIPANT,a.LOCALIZATION_TYPE.PARTICIPANT_DEMOTED_PARTICIPANT,a.LOCALIZATION_TYPE.PARTICIPANT_PROMOTED_PARTICIPANT,a.LOCALIZATION_TYPE.CURRENT_USER_GOT_DEMOTED,a.LOCALIZATION_TYPE.CURRENT_USER_GOT_PROMOTED,a.LOCALIZATION_TYPE.CURRENT_USER_SELF_DEMOTED,a.LOCALIZATION_TYPE.PARTICIPANT_GOT_DEMOTED,a.LOCALIZATION_TYPE.PARTICIPANT_GOT_PROMOTED,a.LOCALIZATION_TYPE.PARTICIPANT_PROMOTED_YOU,a.LOCALIZATION_TYPE.PARTICIPANT_DEMOTED_YOU,a.LOCALIZATION_TYPE.PARTICIPANT_SELF_DEMOTED,a.LOCALIZATION_TYPE.CURRENT_USER_SET_ADD_MODE_ADMIN_ONLY,a.LOCALIZATION_TYPE.CURRENT_USER_SET_ADD_MODE_ALL_MEMBERS,a.LOCALIZATION_TYPE.PARTICIPANT_SET_ADD_MODE_ADMIN_ONLY,a.LOCALIZATION_TYPE.PARTICIPANT_SET_ADD_MODE_ALL_MEMBERS,a.LOCALIZATION_TYPE.SERVER_SET_ADD_MODE_ADMIN_ONLY,a.LOCALIZATION_TYPE.SERVER_SET_ADD_MODE_ALL_MEMBERS];d=[a.LOCALIZATION_TYPE.CURRENT_USER_LEFT_GROUP,a.LOCALIZATION_TYPE.PARTICIPANT_LEFT_GROUP];var h=[a.LOCALIZATION_TYPE.CURRENT_USER_NAMED_GROUP,a.LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_HOTLIKE,a.LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_NICKNAME,a.LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_PHOTO,a.LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_THEME,a.LOCALIZATION_TYPE.CURRENT_USER_CLEAR_OWN_NICKNAME,a.LOCALIZATION_TYPE.CURRENT_USER_CLEAR_PARTICIPANT_NICKNAME,a.LOCALIZATION_TYPE.CURRENT_USER_SET_OWN_NICKNAME],i=[a.LOCALIZATION_TYPE.PARTICIPANT_NAMED_GROUP,a.LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_CURRENT_USER_NICKNAME,a.LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_HOTLIKE,a.LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_PARTICIPANT_NICKNAME,a.LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_PHOTO,a.LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_THEME,a.LOCALIZATION_TYPE.UNKNOWN_USER_NAMED_GROUP,a.LOCALIZATION_TYPE.PARTICIPANT_CLEAR_CURRENT_USER_NICKNAME,a.LOCALIZATION_TYPE.PARTICIPANT_CLEAR_OWN_NICKNAME,a.LOCALIZATION_TYPE.PARTICIPANT_CLEAR_PARTICIPANT_NICKNAME,a.LOCALIZATION_TYPE.PARTICIPANT_SET_OWN_NICKNAME],j=[a.LOCALIZATION_TYPE.CURRENT_USER_PINNED_MESSAGE,a.LOCALIZATION_TYPE.CURRENT_USER_UNPINNED_MESSAGE,a.LOCALIZATION_TYPE.PARTICIPANT_PINNED_MESSAGE,a.LOCALIZATION_TYPE.PARTICIPANT_UNPINNED_MESSAGE],k=[a.LOCALIZATION_TYPE.TWO_USERS_CONNECTED,a.LOCALIZATION_TYPE.TWO_USERS_CONNECTED_ONE_MSPLIT],l=[a.LOCALIZATION_TYPE.CURRENT_USER_SEND_UNRENDERABLE_MESSAGE,a.LOCALIZATION_TYPE.CURRENT_USER_SEND_LOCATION,a.LOCALIZATION_TYPE.CURRENT_USER_SEND_POLL_CREATION,a.LOCALIZATION_TYPE.CURRENT_USER_SEND_CONTACT_SHARE,a.LOCALIZATION_TYPE.CURRENT_USER_SEND_STORY_MENTION,a.LOCALIZATION_TYPE.CURRENT_USER_SEND_BUMP_MESSAGE,a.LOCALIZATION_TYPE.CURRENT_USER_SEND_STICKER_RECEIVER_FETCH_MESSAGE],m=[a.LOCALIZATION_TYPE.PARTICIPANT_SEND_UNRENDERABLE_MESSAGE,a.LOCALIZATION_TYPE.PARTICIPANT_SEND_LOCATION,a.LOCALIZATION_TYPE.PARTICIPANT_SEND_POLL_CREATION,a.LOCALIZATION_TYPE.PARTICIPANT_SEND_CONTACT_SHARE,a.LOCALIZATION_TYPE.PARTICIPANT_SEND_STORY_MENTION,a.LOCALIZATION_TYPE.PARTICIPANT_SEND_BUMP_MESSAGE,a.LOCALIZATION_TYPE.PARTICIPANT_SEND_STICKER_RECEIVER_FETCH_MESSAGE,a.LOCALIZATION_TYPE.META_AI_SEND_MESSAGE,a.LOCALIZATION_TYPE.USER_SEND_UNAVAILABLE_MESSAGE,a.LOCALIZATION_TYPE.USER_SEND_ENCRYPTED_MESSAGE,a.LOCALIZATION_TYPE.PARTICIPANT_SEND_BUMP_MESSAGE_ORIGINAL_UNAVAILABLE],n=[a.LOCALIZATION_TYPE.CURRENT_USER_BUMPED_MESSAGE,a.LOCALIZATION_TYPE.CURRENT_USER_BUMPED_OWN_MESSAGE],o=[a.LOCALIZATION_TYPE.PARTICIPANT_BUMPED_CURRENT_USER_MESSAGE,a.LOCALIZATION_TYPE.PARTICIPANT_BUMPED_OWN_MESSAGE,a.LOCALIZATION_TYPE.PARTICIPANT_BUMPED_PARTICIPANT_MESSAGE],p=[a.LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_DAYS,a.LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_HOURS,a.LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_MINUTES,a.LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_SECONDS,a.LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_OFF,a.LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_DAYS,a.LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_HOURS,a.LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_MINUTES,a.LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_SECONDS,a.LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_CHANGE_DAYS,a.LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_CHANGE_HOURS,a.LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_CHANGE_MINUTES,a.LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_CHANGE_SECONDS,a.LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_OFF,a.LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_ON_DAYS,a.LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_ON_HOURS,a.LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_ON_MINUTES,a.LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_ON_SECONDS,a.LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_DAYS,a.LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_HOURS,a.LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_MINUTES,a.LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_SECONDS,a.LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_OFF,a.LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_ON_DAYS,a.LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_ON_HOURS,a.LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_ON_MINUTES,a.LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_ON_SECONDS,a.LOCALIZATION_TYPE.EPHEMERAL_SETTINGS_AUTO_RESET],q=[a.LOCALIZATION_TYPE.YOUR_DEVICE_ICDC_ALERT_ADMIN_MESSAGE,a.LOCALIZATION_TYPE.ICDC_ALERT_ADMIN_MESSAGE],r=[a.LOCALIZATION_TYPE.CURRENT_USER_MISSED_AUDIO_CALL,a.LOCALIZATION_TYPE.CURRENT_USER_MISSED_VIDEO_CALL,a.LOCALIZATION_TYPE.PARTICIPANT_STARTED_GROUP_AUDIO_CALL,a.LOCALIZATION_TYPE.PARTICIPANT_STARTED_GROUP_VIDEO_CALL],s=[a.LOCALIZATION_TYPE.CURRENT_USER_AUDIO_CALLED,a.LOCALIZATION_TYPE.CURRENT_USER_STARTED_GROUP_AUDIO_CALL,a.LOCALIZATION_TYPE.CURRENT_USER_STARTED_GROUP_VIDEO_CALL,a.LOCALIZATION_TYPE.CURRENT_USER_VIDEO_CALLED,a.LOCALIZATION_TYPE.PARTICIPANT_MISSED_AUDIO_CALL,a.LOCALIZATION_TYPE.PARTICIPANT_MISSED_VIDEO_CALL,a.LOCALIZATION_TYPE.PARTICIPANT_AUDIO_CALLED,a.LOCALIZATION_TYPE.PARTICIPANT_VIDEO_CALLED],t=[a.LOCALIZATION_TYPE.CURRENT_USER_CREATED_GROUP,a.LOCALIZATION_TYPE.CURRENT_USER_MENTIONED_STORY_IG,a.LOCALIZATION_TYPE.CURRENT_USER_SENT_EVENT,a.LOCALIZATION_TYPE.CURRENT_USER_SENT_POST,a.LOCALIZATION_TYPE.CURRENT_USER_SENT_REEL,a.LOCALIZATION_TYPE.CURRENT_USER_SENT_STORY,a.LOCALIZATION_TYPE.CURRENT_USER_SENT_STORY_HIGHLIGHT,a.LOCALIZATION_TYPE.CURRENT_USER_RECEIVED_STORY_MENTION_IG,a.LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,a.LOCALIZATION_TYPE.YOU_EPHEMERAL_RECORD_SCREEN,a.LOCALIZATION_TYPE.YOU_EPHEMERAL_TAKE_SCREENSHOT,a.LOCALIZATION_TYPE.CURRENT_USER_UNSENT_MESSAGE],u=[a.LOCALIZATION_TYPE.PARTICIPANT_CREATED_GROUP,a.LOCALIZATION_TYPE.UNKNOWN_USER_CREATED_GROUP,a.LOCALIZATION_TYPE.PARTICIPANT_SEND_ATTACHMENT,a.LOCALIZATION_TYPE.PARTICIPANT_SEND_AUDIO,a.LOCALIZATION_TYPE.PARTICIPANT_SEND_GIF,a.LOCALIZATION_TYPE.PARTICIPANT_SEND_IMAGE,a.LOCALIZATION_TYPE.PARTICIPANT_SEND_STICKER,a.LOCALIZATION_TYPE.PARTICIPANT_SEND_TEXT,a.LOCALIZATION_TYPE.PARTICIPANT_SEND_TEXT_IN_GROUP,a.LOCALIZATION_TYPE.PARTICIPANT_SEND_VIDEO,a.LOCALIZATION_TYPE.PARTICIPANT_SENT_EVENT,a.LOCALIZATION_TYPE.PARTICIPANT_SENT_POST,a.LOCALIZATION_TYPE.PARTICIPANT_SENT_REEL,a.LOCALIZATION_TYPE.PARTICIPANT_SENT_STORY,a.LOCALIZATION_TYPE.PARTICIPANT_SENT_STORY_HIGHLIGHT,a.LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_RECORD_SCREEN,a.LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_TAKE_SCREENSHOT,a.LOCALIZATION_TYPE.PARTICIPANT_REACT_MESSAGE,a.LOCALIZATION_TYPE.PARTICIPANT_REACT_MESSAGE_IN_GROUP,a.LOCALIZATION_TYPE.PARTICIPANT_UNSENT_MESSAGE,a.LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_RECORD_SCREEN,a.LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_TAKE_SCREENSHOT];a=[a.LOCALIZATION_TYPE.EMPTY_SNIPPET];g.cutoverAdminMsgs=b;g.deviceChanges=c;g.participantsAddedRemoved=e;g.groupPermissionsChanged=f;g.participantLeftGroup=d;g.chatCustomizedByCurrentUser=h;g.chatCustomizedByOtherUser=i;g.pinnedMessageUpdate=j;g.twoUsersConnected=k;g.fallbackMsgFromCurrentUser=l;g.fallbackMsgFromOtherUser=m;g.currentUserBumpsMessage=n;g.otherUserBumpsMessage=o;g.ephemeralSettingChanges=p;g.icdcAlerts=q;g.callActionToNotifyAbout=r;g.callActionNotToNotifyAbout=s;g.otherNonAdminMsgToBeBumped=t;g.otherNonAdminMsgToBeMarkedAsUnread=u;g.otherNonAdminMsgToNotTriggerUpdate=a}),98);
__d("MAWThreadUpdateType",[],(function(a,b,c,d,e,f){"use strict";a=0;b=1;c=2;d=3;e=Object.freeze({BUMP_THREAD:c,MARK_THREAD_AS_UNREAD:d,NO_SNIPPET_UPDATE:a,SNIPPET_ONLY:b});f.THREAD_UPDATE_TYPE=e}),66);
__d("MAWGetThreadUpdateTypeForAdminMsg",["FBLogger","MAWAdminMsgTypesGrouped","MAWLocalizationType","MAWThreadUpdateType"],(function(a,b,c,d,e,f,g){"use strict";function a(a){a=(a=a.msgContent)==null?void 0:a.adminType;if(a==null){c("FBLogger")("messenger_e2ee_web").mustfix("nullAdminType");return d("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_UPDATE}if(h(a))return d("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD;if(i(a))return d("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD;if(j(a))return d("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY;if(k(a))return d("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_UPDATE;c("FBLogger")("messenger_e2ee_web").mustfix("unsupportedAdminMsgType");return d("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_UPDATE}function h(a){return d("MAWAdminMsgTypesGrouped").chatCustomizedByOtherUser.includes(a)||d("MAWAdminMsgTypesGrouped").callActionToNotifyAbout.includes(a)||d("MAWAdminMsgTypesGrouped").twoUsersConnected.includes(a)||d("MAWAdminMsgTypesGrouped").fallbackMsgFromOtherUser.includes(a)||d("MAWAdminMsgTypesGrouped").otherUserBumpsMessage.includes(a)||d("MAWAdminMsgTypesGrouped").otherNonAdminMsgToBeMarkedAsUnread.includes(a)||a===d("MAWLocalizationType").LOCALIZATION_TYPE.REACHABILITY_ERROR}function i(a){return d("MAWAdminMsgTypesGrouped").participantsAddedRemoved.includes(a)||d("MAWAdminMsgTypesGrouped").chatCustomizedByCurrentUser.includes(a)||d("MAWAdminMsgTypesGrouped").callActionNotToNotifyAbout.includes(a)||d("MAWAdminMsgTypesGrouped").fallbackMsgFromCurrentUser.includes(a)||d("MAWAdminMsgTypesGrouped").currentUserBumpsMessage.includes(a)||d("MAWAdminMsgTypesGrouped").otherNonAdminMsgToBeBumped.includes(a)}function j(a){return a===d("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_ROLLBACK_ADMIN_MESSAGE||d("MAWAdminMsgTypesGrouped").ephemeralSettingChanges.includes(a)||d("MAWAdminMsgTypesGrouped").groupPermissionsChanged.includes(a)||d("MAWAdminMsgTypesGrouped").participantLeftGroup.includes(a)||d("MAWAdminMsgTypesGrouped").pinnedMessageUpdate.includes(a)}function k(a){return d("MAWAdminMsgTypesGrouped").cutoverAdminMsgs.includes(a)||d("MAWAdminMsgTypesGrouped").deviceChanges.includes(a)||d("MAWAdminMsgTypesGrouped").icdcAlerts.includes(a)||d("MAWAdminMsgTypesGrouped").otherNonAdminMsgToNotTriggerUpdate.includes(a)||a===d("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION||a===d("MAWLocalizationType").LOCALIZATION_TYPE.EMPTY_SNIPPET||a===d("MAWLocalizationType").LOCALIZATION_TYPE.DEBUG_MSG}g.getThreadUpdateTypeForAdminMsg=a}),98);
__d("MAWGetThreadUpdateType",["MAWGetThreadUpdateTypeForAdminMsg","MAWMsgType","MAWThreadUpdateType","err","gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return c("gkx")("4847")?i[a.type](a):d("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_UPDATE}function h(){throw c("err")("Not implemented")}var i=(b={},b[(e=d("MAWMsgType")).MSG_TYPE.TEXT]=function(){return h()},b[e.MSG_TYPE.IMAGE]=function(){return h()},b[e.MSG_TYPE.VIDEO]=function(){return h()},b[e.MSG_TYPE.GIF]=function(){return h()},b[e.MSG_TYPE.STICKER]=function(){return h()},b[e.MSG_TYPE.DOCUMENT_FILE]=function(){return h()},b[e.MSG_TYPE.XMA]=function(){return h()},b[e.MSG_TYPE.BUMP_EXISTING_MESSAGE]=function(){return h()},b[e.MSG_TYPE.REACTION]=function(){return h()},b[e.MSG_TYPE.CIPHERTEXT]=function(){return h()},b[e.MSG_TYPE.DELETE_FOR_ME]=function(){return h()},b[e.MSG_TYPE.EDIT_ACTION]=function(){return h()},b[e.MSG_TYPE.RAVEN]=function(){return h()},b[e.MSG_TYPE.RAVEN_ACTION]=function(){return h()},b[e.MSG_TYPE.UNAVAILABLE]=function(){return h()},b[e.MSG_TYPE.REVOKED]=function(){return h()},b[e.MSG_TYPE.ADMIN]=function(a){return d("MAWGetThreadUpdateTypeForAdminMsg").getThreadUpdateTypeForAdminMsg(a)},b[e.MSG_TYPE.PTT]=function(){return h()},b[e.MSG_TYPE.SK_DISTRIBUTION]=function(){return h()},b[e.MSG_TYPE.FUTUREPROOF]=function(){return h()},b[e.MSG_TYPE.EXPIRED_EPHEMERAL]=function(){return h()},b[e.MSG_TYPE.EPHEMERAL_SETTING_ADMIN]=function(){return h()},b[e.MSG_TYPE.EPHEMERAL_SYNC_RESPONSE]=function(){return h()},b[e.MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE]=function(){return h()},b[e.MSG_TYPE.ICDC_ALERT]=function(){return h()},b[e.MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION]=function(){return h()},b[e.MSG_TYPE.GROUP_INVITE]=function(){return h()},b);g.getThreadUpdateTypeForMsg=a}),98);
__d("MAWUpdateThreadBumpTimestamp",["MAWBridgeTypesCreators","MAWCalculateBumpTimestampMs","MAWIndexedDb","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=d("MAWCalculateBumpTimestampMs").calculateBumpTimestampMs(d("WATimeUtils").castUnixTimeToMillisTime(a.ts));d("MAWIndexedDb").afterTransaction({tag:"ThreadBumpedV2",value:d("MAWBridgeTypesCreators").createBridgeBumpedThreadV2({bumpTimestampMs:c,description:"UpdateThreadBumpTimestamp-"+a.type,isMessageAuthorMe:a.author===d("WAJids").AUTHOR_ME,isUnbump:!1,shouldMarkThreadAsUnread:b,skipServerThreadBump:!1,threadJid:a.threadJid})})}g.bumpThread=a}),98);
__d("MAWDbReaction",["MAWAckLevel","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a){if(a.reactToAuthor!=="@me"||a.reaction==null)return null;var b=a.author==="@me"||a.author==="@system"?null:a.author;return b==null?null:babelHelpers["extends"]({},a,{author:b,reaction:a.reaction,reactToAuthor:a.reactToAuthor})}function b(a,b,c){var e=d("WAGlobals").getMyUserJid();return a.find(function(a){return a.threadJid===b&&d("WAJids").authorToUserId(a.author,e)===d("WAJids").authorToUserId(c,e)})}function c(a){return a}function e(a,b,c,e,f,g,h,i,j,k,l,m,n){m===void 0&&(m=d("MAWAckLevel").ACK.clock);m={ack:m,author:k,externalId:b,groupingKey:g,reaction:f,reactionId:c,reactToAuthor:h,reactToExternalId:e,reactToMsgId:i,senderTimestampMs:n,threadJid:a,ts:j};return l!=null?babelHelpers["extends"]({},m,{rowId:l}):m}g.castToIncomingDbReaction=a;g.findMatchingReaction=b;g.reactionIdToMsgId=c;g.formatReactionForDb=e}),98);
__d("MAWDbGroupInfoTxns",["MAWBridgeTypesCreators","MAWIndexedDb","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return h(a,b.jid).then(function(c){var d=b.participantVersion;c.success&&c.value.participantVersion!=null&&b.participantVersion==null&&(d=c.value.participantVersion);c=b.subject.content;c!=null&&c.length===0&&(c=void 0);var e={creationTs:b.creationTs,creator:b.creator,groupJid:b.jid,inviter:b.inviter,memberAddMode:b.memberAddMode,name:c,nameOwner:b.subject.user,nameTs:b.subject.ts,participantVersion:d};return i(a,e).then(function(){return e})})}function h(a,b){return a.groupInfo.get({groupJid:b}).then(function(a){return a==null?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeResult(a)})}function i(a,b){return a.groupInfo.put(b).then(function(){d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(b)})})}function b(a,b){return a.groupInfo.bulkPut(b).then(function(){b.forEach(function(a){return d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(a)})})})}function c(a,b){return a.groupInfo.bulkGet(b)}function e(a,b){return a.groupInfo["delete"](b)}g.putGroupInfo=a;g.getGroupInfo=h;g.updateGroupInfo=i;g.bulkUpdateGroupInfo=b;g.getGroupInfos=c;g.deleteGroupInfo=e}),98);
__d("MAWThreadSnippetForAdminOrEphemeralMsg",["MAWAdminMsgNormalized","MAWLocalizationUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=a.msgContent.adminType;a=d("MAWLocalizationUtils").isAdminMsgNormalized(c)?d("MAWAdminMsgNormalized").deconstructContactIdsFromAdminContent(c,a.msgContent.adminMsgContent):{contactIds:[],contents:a.msgContent.adminMsgContent};var e=a.contactIds;a=a.contents;return{snippetParams:{contactIDs:[].concat(e.map(function(a){return a==="Facebook User"?"0":a})),strings:[].concat(a)},snippetSenderContactId:b,snippetType:c}}g["default"]=a}),98);
__d("MAWThreadSnippetForBumpExistingMessageMsg",["MAWLocalizationType","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Bump message sender is null"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Bump message has no quoted author"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Bumped message can not have AUTHOR_SYSTEM"]);j=function(){return a};return a}function k(a,b,c){return{snippetParams:{contactIDs:(c=c)!=null?c:[],strings:[]},snippetSenderContactId:a,snippetType:b}}var l=function(a){return k(a,d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET)};function a(a,b,c){var e;if(d("WAJids").isAuthorSystem(a.author)){d("WALogger").ERROR(j());return l(b)}e=(e=(e=a.quote)==null?void 0:e.content.author)!=null?e:c;if(e==null){d("WALogger").ERROR(i());return l(b)}if(d("WAJids").isAuthorMe(a.author))return d("WAJids").isAuthorMe(e)?k(b,d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_BUMPED_OWN_MESSAGE):k(b,d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_BUMPED_MESSAGE,[d("WAJids").userIdFromJid(e)]);if(b==null){d("WALogger").ERROR(h());return l(b)}if(d("WAJids").isAuthorMe(e))return k(b,d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_CURRENT_USER_MESSAGE,[b]);return e===a.author?k(b,d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_OWN_MESSAGE,[b]):k(b,d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_PARTICIPANT_MESSAGE,[b,d("WAJids").userIdFromJid(e)])}g["default"]=a}),98);
__d("MAWThreadSnippetForCiphertextMsg",["MAWLocalizationType","gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return{snippetParams:{contactIDs:[],strings:[]},snippetSenderContactId:a,snippetType:c("gkx")("1564")?d("MAWLocalizationType").LOCALIZATION_TYPE.USER_SEND_ENCRYPTED_MESSAGE:d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET}}g["default"]=a}),98);
__d("MAWThreadSnippetForDocumentFileMsg",["MAWLocalizationType","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Document file message can not have AUTHOR_SYSTEM"]);h=function(){return a};return a}function a(a,b){var c,e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET;c={contactIDs:[],mentionJIDs:(c=a.msgContent)==null?void 0:c.mentionedJids,strings:[]};d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(h()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_ATTACHMENT,c.contactIDs.push(b));return{snippetParams:c,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippetForFallbackMessageMsg",["MAWLocalizationType","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,c){return{snippetParams:{contactIDs:(c=c)!=null?c:[],strings:[]},snippetSenderContactId:a,snippetType:b}}function a(a,b){var c=a.author;a=a.msgContent.subtype;if(d("WAJids").isAuthorMe(c))switch(a){case"liveLocationMessage":case"locationMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_LOCATION);case"contactShareMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_CONTACT_SHARE);case"storyMentionMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_STORY_MENTION);case"pollCreationMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_POLL_CREATION);case"bumpMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_BUMPED_MESSAGE);default:return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET)}else switch(a){case"liveLocationMessage":case"locationMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_LOCATION);case"contactShareMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_CONTACT_SHARE);case"storyMentionMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_STORY_MENTION);case"pollCreationMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_POLL_CREATION);case"bumpMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_PARTICIPANT_MESSAGE);case"metaAiMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.META_AI_SEND_MESSAGE);default:return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET)}}g["default"]=a}),98);
__d("MAWThreadSnippetForGifMsg",["MAWLocalizationType","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Animated message can not have AUTHOR_SYSTEM"]);h=function(){return a};return a}function a(a,b){var c,e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET;c={contactIDs:[],mentionJIDs:(c=a.msgContent)==null?void 0:c.mentionedJids,strings:[]};d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_GIF:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(h()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_GIF,c.contactIDs.push(b));return{snippetParams:c,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippetForImageMsg",["MAWLocalizationType","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Image message can not have AUTHOR_SYSTEM"]);h=function(){return a};return a}function a(a,b){var c,e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET;c={contactIDs:[],mentionJIDs:(c=a.msgContent)==null?void 0:c.mentionedJids,strings:[]};d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_IMAGE:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(h()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_IMAGE,c.contactIDs.push(b));return{snippetParams:c,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippetForPttMsg",["MAWLocalizationType","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Ptt message can not have AUTHOR_SYSTEM"]);h=function(){return a};return a}function a(a,b){var c,e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET;c={contactIDs:[],mentionJIDs:(c=a.msgContent)==null?void 0:c.mentionedJids,strings:[]};d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_AUDIO:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(h()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_AUDIO,c.contactIDs.push(b));return{snippetParams:c,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippetForRevokedMsg",["MAWLocalizationType","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Revoked message can not have AUTHOR_SYSTEM"]);h=function(){return a};return a}function a(a,b){var c,e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET;c={contactIDs:[],mentionJIDs:(c=a.msgContent)==null?void 0:c.mentionedJids,strings:[]};d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UNSENT_MESSAGE:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(h()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UNSENT_MESSAGE,c.contactIDs.push(b));return{snippetParams:c,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippetForStickerMsg",["MAWLocalizationType","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Sticker message can not have AUTHOR_SYSTEM"]);h=function(){return a};return a}function a(a,b){var c,e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET;c={contactIDs:[],mentionJIDs:(c=a.msgContent)==null?void 0:c.mentionedJids,strings:[]};d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_STICKER:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(h()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_STICKER,c.contactIDs.push(b));return{snippetParams:c,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippetForTextMsg",["MAWLocalizationType","MAWVault","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Text message can not have AUTHOR_SYSTEM"]);h=function(){return a};return a}function a(a,b,c){var e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,f={contactIDs:[],mentionJIDs:a.msgContent.mentionedJids,strings:[]};d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_TEXT:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(h()):(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_TEXT_IN_GROUP:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_TEXT,f.contactIDs.push(b));if(a.specialTextSize===1||a.specialTextSize===2||a.specialTextSize===3){c=d("MAWVault").unvault(a.msgContent.content);f.strings.push(c==="\ud83d\udc4d"?"(Y)":a.msgContent.content)}else f.strings.push(a.msgContent.content);return{snippetParams:f,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippetForVideoMsg",["MAWLocalizationType","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Video message can not have AUTHOR_SYSTEM"]);h=function(){return a};return a}function a(a,b){var c,e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET;c={contactIDs:[],mentionJIDs:(c=a.msgContent)==null?void 0:c.mentionedJids,strings:[]};d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_VIDEO:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(h()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_VIDEO,c.contactIDs.push(b));return{snippetParams:c,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippetForXMAMsg",["MAWLocalizationType","WAArmadilloXMA.pb","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Encountered unexpected XMAMessageType when building a thread snippet"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA story mentions must have a target Jid"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message does not have xmaMessageType"]);y=function(){return a};return a}function a(a,b){var c,e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET;c={contactIDs:[],mentionJIDs:(c=a.msgContent)==null?void 0:c.mentionedJids,strings:[]};a.xmaMessageType==null&&d("WALogger").ERROR(y());switch(a.xmaMessageType){case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH:d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(x()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_ATTACHMENT,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE:if(d("WAJids").isAuthorMe(a.author)){var f;if(a.msgContent!=null&&((f=a.msgContent)==null?void 0:f.content)!=null){e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_TEXT;c.strings.push((f=a.msgContent)==null?void 0:f.content)}else e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT}else if(d("WAJids").isAuthorSystem(a.author)||b==null)d("WALogger").ERROR(w());else{e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_TEXT;c.contactIDs.push(b);if(a.msgContent!=null&&((f=a.msgContent)==null?void 0:f.content)!=null){c.strings.push((f=a.msgContent)==null?void 0:f.content)}}break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE:d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_STORY:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(v()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_STORY,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT:d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_REEL:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(u()):e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_REEL;break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_PRIVATE_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE:d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_POST:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(t()):e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_POST;break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION:d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_STORY:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(s()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_STORY,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE:d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_STORY_HIGHLIGHT:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(r()):e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_STORY_HIGHLIGHT;break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_MENTION:if(d("WAJids").isAuthorMe(a.author)){e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MENTIONED_STORY_IG;f=a.threadJid;var g;f!=null&&(g=d("WAJids").interpretAsUserJid(f));if(g!=null){f=d("WAJids").userIdFromJid(g);c.contactIDs.push(f)}else d("WALogger").ERROR(q())}else d("WAJids").isAuthorSystem(a.author)?d("WALogger").ERROR(p()):e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_RECEIVED_STORY_MENTION_IG;break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL:d("WAJids").isAuthorMe(a.author)&&b!=null?(e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_AUDIO_CALLED,c.contactIDs.push(b)):d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(o()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_AUDIO_CALLED,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL:d("WAJids").isAuthorMe(a.author)&&b!=null?(e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_VIDEO_CALLED,c.contactIDs.push(b)):d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(n()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_VIDEO_CALLED,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL:d("WAJids").isAuthorMe(a.author)&&b!=null?(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_MISSED_AUDIO_CALL,c.contactIDs.push(b)):d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(m()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MISSED_AUDIO_CALL,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL:d("WAJids").isAuthorMe(a.author)&&b!=null?(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_MISSED_VIDEO_CALL,c.contactIDs.push(b)):d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(l()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MISSED_VIDEO_CALL,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL:d("WAJids").isAuthorMe(a.author)&&b!=null?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_STARTED_GROUP_AUDIO_CALL:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(k()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_STARTED_GROUP_AUDIO_CALL,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL:d("WAJids").isAuthorMe(a.author)&&b!=null?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_STARTED_GROUP_VIDEO_CALL:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(j()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_STARTED_GROUP_VIDEO_CALL,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT:d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_EVENT:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(i()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_EVENT,c.contactIDs.push(b));break;default:d("WALogger").ERROR(h())}return{snippetParams:c,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippet",["FBLogger","MAWLocalizationType","MAWMsgType","MAWThreadSnippetForAdminOrEphemeralMsg","MAWThreadSnippetForBumpExistingMessageMsg","MAWThreadSnippetForCiphertextMsg","MAWThreadSnippetForDocumentFileMsg","MAWThreadSnippetForFallbackMessageMsg","MAWThreadSnippetForGifMsg","MAWThreadSnippetForImageMsg","MAWThreadSnippetForPttMsg","MAWThreadSnippetForRevokedMsg","MAWThreadSnippetForStickerMsg","MAWThreadSnippetForTextMsg","MAWThreadSnippetForVideoMsg","MAWThreadSnippetForXMAMsg","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return/^\d+$/.test(a)}function i(a){if(d("WAJids").isAuthorSystem(a))return;a=d("WAJids").isAuthorMe(a)?d("WAJids").userIdFromJid(d("WAGlobals").getMyUserJid()):d("WAJids").userIdFromJid(a);if(!h(a)){c("FBLogger")("maw_db").mustfix("[MAWThreadSnippetBuildTxns] Snippet sender contact id is invalid");return}return a}function a(a,b,e){var f=i(a.author);switch(a.type){case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:return c("MAWThreadSnippetForCiphertextMsg")(f);case d("MAWMsgType").MSG_TYPE.TEXT:return c("MAWThreadSnippetForTextMsg")(a,f,b);case d("MAWMsgType").MSG_TYPE.IMAGE:return c("MAWThreadSnippetForImageMsg")(a,f);case d("MAWMsgType").MSG_TYPE.VIDEO:return c("MAWThreadSnippetForVideoMsg")(a,f);case d("MAWMsgType").MSG_TYPE.PTT:return c("MAWThreadSnippetForPttMsg")(a,f);case d("MAWMsgType").MSG_TYPE.ADMIN:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return c("MAWThreadSnippetForAdminOrEphemeralMsg")(a,f);case d("MAWMsgType").MSG_TYPE.GIF:return c("MAWThreadSnippetForGifMsg")(a,f);case d("MAWMsgType").MSG_TYPE.STICKER:return c("MAWThreadSnippetForStickerMsg")(a,f);case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return c("MAWThreadSnippetForDocumentFileMsg")(a,f);case d("MAWMsgType").MSG_TYPE.REVOKED:return c("MAWThreadSnippetForRevokedMsg")(a,f);case d("MAWMsgType").MSG_TYPE.XMA:return c("MAWThreadSnippetForXMAMsg")(a,f);case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return c("MAWThreadSnippetForBumpExistingMessageMsg")(a,f,e);case d("MAWMsgType").MSG_TYPE.FUTUREPROOF:return c("MAWThreadSnippetForFallbackMessageMsg")(a,f);default:return{snippetParams:{contactIDs:[],strings:[]},snippetSenderContactId:f,snippetType:d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET}}}g.getSnippetContactId=i;g.buildThreadSnippet=a}),98);
__d("MAWEphemeralMsgUtils",[],(function(a,b,c,d,e,f){"use strict";function a(a){return function(b){return!a.has(b.msgId)&&b.ephemeralMsgDisappeared!==!0}}f.filterNonExpiredMsg=a}),66);
__d("MAWThreadSnippetUtils",["MAWEphemeralMsgUtils","MAWLocalizationType","MAWLocalizationUtils","MAWMsgType","MAWXMAUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(a){var b;if(a.type===d("MAWMsgType").MSG_TYPE.REVOKED)return!0;if(d("MAWXMAUtils").isXMAStoryReply(a.xmaMessageType))return!0;b=((b=a.msgContent)==null?void 0:b.adminType)!=null?d("MAWLocalizationUtils").isDeviceChangeAdminMsg(a.msgContent.adminType):!1;if(a.type!==d("MAWMsgType").MSG_TYPE.ADMIN)return!1;a=a.msgContent.adminType;return a===d("MAWLocalizationType").LOCALIZATION_TYPE.DEBUG_MSG?!0:b}function a(a,b,c){return a.messages.where("[threadJid+sortOrderMs]").between([b.jid,Number.MIN_SAFE_INTEGER],[b.jid,Number.MAX_SAFE_INTEGER],!1,!1).filter(function(a){return(c==null||d("MAWEphemeralMsgUtils").filterNonExpiredMsg(c)(a))&&!h(a)}).reverse().first()}g.isDbMsgDisabledForThreadSnippet=h;g.findMostRecentSnippetMsgFromThread=a}),98);
__d("MAWThreadSnippetBuildTxns",["$InternalEnum","FBLogger","I64","MAWBridgeTypesCreators","MAWCalculateBumpTimestampMs","MAWDbGroupInfoTxns","MAWDbMsg","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLocalizationType","MAWThreadSnippet","MAWThreadSnippetUtils","WAGlobals","WAJids","WALongInt","WAProtocolMsgId","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i=b("$InternalEnum").Mirrored(["DO_NOT_BUMP_THREAD","MATCH_BUMP_TIMESTAMP_MS_TO_SNIPPET"]);function j(a,b,c){return d("MAWDexieTable").dexieAll([d("MAWDbGroupInfoTxns").getGroupInfo(a,d("WAJids").toGroupJid(b.threadJid))]).then(function(a){a=a[0];a=a.success;return d("MAWThreadSnippet").buildThreadSnippet(b,a,c)})}function a(a,b,c,e){return d("MAWDexieTable").dexieAll([d("MAWDbGroupInfoTxns").getGroupInfo(a,d("WAJids").toGroupJid(e))]).then(function(a){a=a[0];a=a.success;return k(b,c,a)})}function k(a,b,e){var f;d("WAJids").isAuthorMe(a)?(c("FBLogger")("maw_db").warn("[MAWThreadSnippetBuildTxns] Reaction snippet author should not be @me"),f=d("WAJids").userIdFromJid(d("WAGlobals").getMyUserJid())):f=d("WAJids").userIdFromJid(a);a={contactIDs:[],strings:[]};e=e?d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REACT_MESSAGE_IN_GROUP:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REACT_MESSAGE;a.contactIDs.push(f);a.strings.push(b);return{snippetParams:a,snippetSenderContactId:f,snippetType:e}}function e(a,b,c,e){var f=c.newestReaction,g=c.reactionsToClear;if(f!=null&&d("WATimeUtils").castUnixTimeToMillisTime(f.ts)>((c=b.snippetMsgTs)!=null?c:0))return d("MAWDexieTable").dexieResolve({newestReaction:f,reactionsToClear:[],thread:l(b,f,e)});return g!=null&&b.snippetMsg!=null?a.reactions.get({reactionId:b.snippetMsg}).then(function(c){var e=!1;if(c==null)e=!0;else{var f=d("MAWJidUtils").maybeToProtocolMsgId(c.author,c.threadJid,c.reactToExternalId);f!=null&&(e=g.some(function(a){a=d("MAWJidUtils").maybeToProtocolMsgId(a.author,a.threadJid,a.reactToExternalId);return a!=null&&d("WAProtocolMsgId").equals(a,f)}))}return e?m(a,{bumpThreadOption:i.MATCH_BUMP_TIMESTAMP_MS_TO_SNIPPET,isUnbump:!0,thread:b}).then(function(a){return{newestReaction:null,reactionsToClear:g,thread:a}}):d("MAWDexieTable").dexieResolve({newestReaction:null,reactionsToClear:[],thread:b})}):d("MAWDexieTable").dexieResolve({newestReaction:null,reactionsToClear:[],thread:b})}function l(a,b,c){var e=d("WATimeUtils").castUnixTimeToMillisTime(b.ts);c=k(b.author,b.reaction,c);var f=c.snippetParams,g=c.snippetSenderContactId;c=c.snippetType;var i=b.externalId!==void 0?(h||(h=d("I64"))).of_string_opt(b.externalId):void 0;e=b.senderTimestampMs!=null?(h||(h=d("I64"))).of_string(d("WALongInt").longIntToDecimalString(b.senderTimestampMs)):d("MAWCalculateBumpTimestampMs").calculateBumpTimestampMs(e,i);d("MAWIndexedDb").afterTransaction({tag:"ThreadBumpedV2",value:d("MAWBridgeTypesCreators").createBridgeBumpedThreadV2({bumpTimestampMs:e,description:"newReaction",isMessageAuthorMe:!1,snippetParams:f,snippetSenderContactId:g,snippetType:c,threadJid:a.jid})});return babelHelpers["extends"]({},a,{snippetMsg:b.reactionId,snippetMsgTs:d("WATimeUtils").castUnixTimeToMillisTime(b.ts)})}function m(a,b){var c=b.bumpMessageAuthorMap,e=b.bumpThreadOption,f=b.isUnbump,g=f===void 0?!1:f,k=b.thread;return d("MAWThreadSnippetUtils").findMostRecentSnippetMsgFromThread(a,k).then(function(b){if(b==null){d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:{contactIDs:[],strings:[]},snippetSenderContactId:"0",snippetType:d("MAWLocalizationType").LOCALIZATION_TYPE.EMPTY_SNIPPET,threadJid:k.jid})});return babelHelpers["extends"]({},k,{snippetMsg:void 0,snippetMsgTs:void 0})}var f=c==null?void 0:c.get(b.externalId);return j(a,b,f).then(function(a){var c=a.snippetParams,f=a.snippetSenderContactId;a=a.snippetType;var j=d("WATimeUtils").castUnixTimeToMillisTime(d("MAWDbMsg").getCanonicalTsFromMsg(b));switch(e){case i.DO_NOT_BUMP_THREAD:d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:c,snippetSenderContactId:f,snippetType:a,threadJid:k.jid})});break;case i.MATCH_BUMP_TIMESTAMP_MS_TO_SNIPPET:var l=d("MAWCalculateBumpTimestampMs").calculateBumpTimestampMs(j,(h||(h=d("I64"))).of_string_opt(b==null?void 0:b.externalId));d("MAWIndexedDb").afterTransaction({tag:"ThreadBumpedV2",value:d("MAWBridgeTypesCreators").createBridgeBumpedThreadV2({bumpTimestampMs:l,description:"getRefreshThreadSnippetChangeset",isMessageAuthorMe:b.author==="@me",isUnbump:g,skipBumpTimestampValidation:!0,skipServerThreadBump:!1,snippetParams:c,snippetSenderContactId:f,snippetType:a,threadJid:k.jid})})}return babelHelpers["extends"]({},k,{snippetMsg:b.msgId,snippetMsgTs:j})})})}function f(a,b,c){return m(a,{bumpMessageAuthorMap:c,bumpThreadOption:i.DO_NOT_BUMP_THREAD,thread:b}).then(function(b){return a.threads.put(b).then(function(){})})}g.buildThreadSnippet=j;g.buildReactionThreadSnippet=a;g.getReactionSnippetParams=k;g.getThreadChangesetForReactionChanges=e;g.getThreadChangesetForNewReaction=l;g.refreshThreadSnippet=f}),98);
__d("MAWUpdateThreadSnippet",["FBLogger","MAWBridgeTypesCreators","MAWDbMsg","MAWDbReaction","MAWDexieTable","MAWIndexedDb","MAWThreadSnippetBuildTxns"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var e=b.newestMsg,f=b.snippetMsg;f=(f=f)!=null?f:e;return f==null?d("MAWDexieTable").dexieResolve():d("MAWDexieTable").dexieAll([a.messages.get({msgId:f}),a.reactions.get({reactionId:f})]).then(function(e){var f=e[0];e=e[1];f!=null&&e!=null&&c("FBLogger")("maw_db").warn("[MAWUpdateThreadSnippet] msgId collision detected between Reaction and Message");return h(a,f,b,e).then(function(a){if(a!=null){var c=a.snippetParams,e=a.snippetSenderContactId;a=a.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:c,snippetSenderContactId:e,snippetType:a,threadJid:b.jid})})}})})}function h(a,b,c,e){e=e!=null?d("MAWDbReaction").castToIncomingDbReaction(e):e;return e!=null&&e.ts>(b!=null?d("MAWDbMsg").getCanonicalTsFromMsg(b):0)?d("MAWThreadSnippetBuildTxns").buildReactionThreadSnippet(a,e.author,e.reaction,c.jid):b==null?d("MAWDexieTable").dexieResolve():d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,b)}g.loadSnippetMsg=a}),98);
__d("MAWDbMessageHandler",["MAWDbThreadTxns","MAWDexieTable","MAWGetThreadUpdateType","MAWThreadUpdateType","MAWTransactionMode","MAWTransactor","MAWUpdateThreadBumpTimestamp","MAWUpdateThreadSnippet","err","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h=["Admin"];b=d("MAWTransactor").makeMsgrTransactor({groupInfo:(a=d("MAWTransactionMode")).READONLY,messages:a.READONLY,reactions:a.READONLY,threads:a.READONLY},"bumpThreadForMessages",function(a){return function(b,c){if(!i(b.type))return d("MAWDexieTable").dexieResolve();switch(c){case"add":j(a,b);break;case"update":break;case"put":break;case"delete":break}return d("MAWDexieTable").dexieResolve()}});function i(a){return!h.includes(a)?!1:c("gkx")("4847")}function j(a,b){var e=d("MAWGetThreadUpdateType").getThreadUpdateTypeForMsg(b);return d("MAWDbThreadTxns").getThread(a,b.threadJid).then(function(f){if(!f.success)throw c("err")("[MAWDbMessageHandler] thread not found"+b.threadJid);if(e===d("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_UPDATE)return;f=f.value;d("MAWUpdateThreadSnippet").loadSnippetMsg(a,f);if(e===d("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD||e===d("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD){f=e===d("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD;d("MAWUpdateThreadBumpTimestamp").bumpThread(b,f)}})}g.bumpThreadForMessages=b;g.isThreadUpdateEnabledViaMiddleware=i}),98);
__d("MAWAfterWriteMsgUtil",["$InternalEnum","ArmadilloDataTraceType","I64","MAWBridgeMsg","MAWBridgeTrace","MAWBridgeTypesCreators","MAWCalculateBumpTimestampMs","MAWDbMessageHandler","MAWDbMsg","MAWIndexedDb","MAWLocalizationType","MAWMsgType","MAWXMAUtils","WAJids","WALogger","WATimeUtils","justknobx","qex"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Skipping thread bump for thread: ",", msgType: ",", snippetType: ",", newestMsgTs: ",", bumpThreadOption: ","."]);i=function(){return a};return a}var j=b("$InternalEnum").Mirrored(["DO_NOT_BUMP_THREAD","BUMP_LOCAL_ONLY","BUMP_LOCAL_AND_SERVER"]);function a(a){var b=a.bumpThreadOption,e=a.dbMsg,f=a.hasMoreAfter,g=a.hasMoreBefore,h=a.isFirstMsg,i=a.isOldestMsgUpdated,j=a.openMessageOtid,l=a.openMessageParticipantCount,m=a.optimisticMsg,n=a.participantCount,o=a.prevOldestMsg,p=a.quotedReplyAttachmentMeta,q=a.snippet;a=a.updatedThread;var r=a.authoritativeThreadKey,s=a.jid,t=a.newestMsgTs;a=a.oldestMsg;if(e.altIndex===d("MAWDbMsg").SPAM_ALT_INDEX||e.altIndex===d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX)return;d("MAWIndexedDb").afterTransaction({tag:"StartTrace",value:d("MAWBridgeTrace").createBridgeStartTraceData(e,s,d("ArmadilloDataTraceType").armadilloMessageSend,j,h,l,n,r)});d("MAWXMAUtils").isXMAStoryReply(e.xmaMessageType)||d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(e,m,p)});k(b,e,s,t,q);if(o==null&&c("qex")._("1210")!==!0){d("MAWIndexedDb").afterTransaction({tag:"MsgsLoaded",value:d("MAWBridgeTypesCreators").createBridgeMsgsLoadedInfo(s,[e],!0,(j=g)!=null?j:!1,(h=f)!=null?h:!1)})}i&&a!=null&&d("MAWIndexedDb").afterTransaction({tag:"UpdateMinMessage",value:{minMessageId:a,minTimestampMs:d("MAWDbMsg").getCanonicalTsFromMsg(e)*1e3,threadJid:s}})}function k(a,b,c,e,f){switch(a){case j.DO_NOT_BUMP_THREAD:l(a,b,c,e,f);return;case j.BUMP_LOCAL_ONLY:case j.BUMP_LOCAL_AND_SERVER:if(m(b)||f==null||e==null){l(a,b,c,e,f);return}var g=f.snippetParams,i=f.snippetSenderContactId;f=f.snippetType;e=d("MAWCalculateBumpTimestampMs").calculateBumpTimestampMs(b.serverTs!=null?d("WATimeUtils").castUnixTimeToMillisTime(b.serverTs):e,(h||(h=d("I64"))).of_string_opt(b.externalId));d("MAWIndexedDb").afterTransaction({tag:"ThreadBumpedV2",value:d("MAWBridgeTypesCreators").createBridgeBumpedThreadV2({bumpTimestampMs:e,description:"writeMsgAfterTransaction-"+b.type,isMessageAuthorMe:b.author===d("WAJids").AUTHOR_ME,skipServerThreadBump:a===j.BUMP_LOCAL_ONLY,snippetParams:g,snippetSenderContactId:i,snippetType:f,threadJid:c})})}}function l(a,b,c,e,f){if(d("MAWDbMessageHandler").isThreadUpdateEnabledViaMiddleware(b.type))return;d("WALogger").LOG(i(),c,b.type,f==null?void 0:f.snippetType,e,a)}function m(a){if(d("MAWXMAUtils").isXMAStoryReply(a.xmaMessageType))return!0;return c("justknobx")._("2017")&&a.type===d("MAWMsgType").MSG_TYPE.ADMIN&&(d("MAWDbMessageHandler").isThreadUpdateEnabledViaMiddleware(a.type)||a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION||a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.DUAL_THREAD_CUTOVER_ADMIN_MESSAGE)?!0:!1}g.WriteMsgAfterTxnBumpThreadOption=j;g.writeMsgAfterTransaction=a}),98);
__d("MAWWriteBulkWriteIncomingAdminMsgTxns",["MAWAdminMsgTxns","MAWAfterWriteMsgUtil","MAWDbMessageHandler","MAWDbMsgTxns","MAWDexieTable","MAWMessageHasUniqueExternalIdValidator","MAWThreadSnippet","MAWThreadSnippetForAdminOrEphemeralMsg","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["OfflineBulkWriteAdminmsg - Missing thread when write e2ee thread description"]);h=function(){return a};return a}function i(a,b){var e=[],f=[],g=[],i=new Map(),j=new Map(),k=b.map(function(b){return d("MAWDbMsgTxns").getThreadOldestMessageId(a,b.jid).then(function(a){return i.set(b.jid,a)})}),l=b.map(function(b){return d("MAWDbMsgTxns").getThreadNewestMessageTs(a,b).then(function(a){return j.set(b.jid,a)})});return d("MAWDexieTable").dexieAll([k,l]).then(function(){b.forEach(function(a){a==null&&d("WALogger").ERROR(h());var b=d("MAWAdminMsgTxns").buildE2EEThreadDescriptionMsg(a),k=d("MAWAdminMsgTxns").getUpdatedThreadForAdminMsg(b,a,j.get(a.jid)),l=d("MAWDbMessageHandler").isThreadUpdateEnabledViaMiddleware(b.type)?null:c("MAWThreadSnippetForAdminOrEphemeralMsg")(b,d("MAWThreadSnippet").getSnippetContactId(b.author));a=i.get(a.jid);e.push(b);g.push(k);f.push({bumpThreadOption:d("MAWAfterWriteMsgUtil").WriteMsgAfterTxnBumpThreadOption.BUMP_LOCAL_ONLY,dbMsg:b,isFirstMsg:!1,isOldestMsgUpdated:a!=null&&b.msgId!==a,prevOldestMsg:a==null?void 0:a,snippet:l,updatedThread:k})});return{afterTransactionSyncMsgsData:f,e2eeThreadAdminMsgs:e,threadsToUpdate:g}})}function a(a,b){return i(a,b).then(function(b){var c=b.afterTransactionSyncMsgsData,e=b.e2eeThreadAdminMsgs,f=b.threadsToUpdate;d("MAWMessageHasUniqueExternalIdValidator").logMessageAddSource(e.map(function(a){return a.externalId}),"MAWWriteBulkWriteIncomingAdminMsgTxns.js::writeE2EEAdminMsgsForIncomingCreatedThreads");return d("MAWDexieTable").dexieAll([a.messages.bulkAdd(e),a.threads.bulkPut(f)]).then(function(){c.forEach(function(a){return d("MAWAfterWriteMsgUtil").writeMsgAfterTransaction(a)});return f})})}g.writeE2EEAdminMsgsForIncomingCreatedThreads=a}),98);
__d("MAWAuthor",["WAGlobals","WAJids","isStringNullOrEmpty"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){if(a==null||a===d("WAJids").AUTHOR_SYSTEM)return null;if(d("WAJids").isAuthorMe(a))return d("WAGlobals").getMyUserJid();var b=d("WAJids").authorAsUserJid(a);if(b==null||c("isStringNullOrEmpty")(d("WAJids").userIdFromJid(b)))return null;else return d("WAJids").authorAsUserJid(a)};g.getAuthorUserJid=a}),98);
__d("MAWDbReactionsTxns",["FBLogger","MAWAuthor","MAWBridgeTypesCreators","MAWDbMsg","MAWDbMsgUtil","MAWDexieTable","MAWIndexedDb","WALogger","WAMsgMap"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Deleted "," reactions"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted: "," reactions rows."]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted reaction with id : ","."]);j=function(){return a};return a}var k=function(a){return a};function a(a,b){return a.reactions.put(k(b))}function b(a,b){return a.reactions["delete"](b.rowId).then(function(){var a=b.author,c=b.reactionId,e=b.reactToMsgId,f=b.threadJid;if(e==null)return;d("MAWIndexedDb").afterTransaction({tag:"DeleteReaction",value:d("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:a,chatJid:f,reactToMsgId:e})});d("WALogger").LOG(j(),c)})}function e(a,b){return a.reactions.where("externalId").equals(b.externalId).filter(function(a){return a.author===b.author&&a.threadJid===b.chat}).first()}function f(a,b){var c=d("MAWAuthor").getAuthorUserJid(b.author);return a.reactions.where("reactToExternalId").equals(b.externalId).filter(function(a){return(a.reactToAuthor===c||a.reactToAuthor===b.author)&&a.threadJid===b.chat}).toArray()}function l(a,b){var d=b.reduce(function(a,b){a.set(b.msgId,b);return a},new Map());return a.reactions.where("reactToMsgId").anyOf(b.map(function(a){return a.msgId})).toArray().then(function(a){var b=a.filter(function(a){var b=a.reactToExternalId;a=a.reactToMsgId;return a!=null&&b===((b=d.get(a))==null?void 0:b.externalId)});b.length<a.length&&c("FBLogger")("messenger_e2ee_web").mustfix("Reactions query by reactToMsgId returns reactions with mismatching externalId");return b})}function m(a,b){return l(a,[b])}function n(a,b){var c=b.author,d=b.chat;b=b.externalId;return a.reactions.where("externalId").equals(b).filter(function(a){return a.author===c&&a.threadJid===d}).first()}function o(a,b){var c=b.map(function(a){a=a.externalId;return a});return a.reactions.where("externalId").anyOf(c).toArray().then(function(a){var c=d("MAWDbMsgUtil").convertMsgArrayToMap(a),e=new(d("WAMsgMap").MsgMap)();b.forEach(function(a){var b=c.get(a);b!=null&&e.set(a,b)});return e})}function p(a,b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.author;b=b.externalId;var e=d("MAWAuthor").getAuthorUserJid(c);return a.reactions.where("reactToExternalId").equals(b).filter(function(a){return d("MAWAuthor").getAuthorUserJid(a.reactToAuthor)===e}).toArray()})).then(function(b){b=b.reduce(function(a,b){return a.concat(b)},[]);b.forEach(function(a){var b=a.author,c=a.reactToMsgId;a=a.threadJid;if(c==null)return;d("MAWIndexedDb").afterTransaction({tag:"DeleteReaction",value:d("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:b,chatJid:a,reactToMsgId:c})})});d("WALogger").LOG(i(),b.length);return a.reactions.bulkDelete(b.map(function(a){return a.rowId}))})}function q(a,b){return a.reactions.where("reactToMsgId").anyOf(b.map(function(a){return a.msgId}))["delete"]().then(function(a){d("WALogger").LOG(h(),a)})}function r(a,b){return a.reactions.where("reactionId").between(d("MAWDbMsg").msgIdsInChatLowerBound(b.chatId),d("MAWDbMsg").msgIdsInChatUpperBound(b.chatId)).last().then(function(a){a=a==null?0:d("MAWDbMsg").getInChatMsgIdFromMsgId(a.reactionId);return a+1})}g.coerceToReaction=k;g.putReaction=a;g.deleteReaction=b;g.getReaction=e;g.getReactionForEcho=f;g.getReactionsFromMessages=l;g.getReactionsFromMessage=m;g.maybeGetReactionByProtocolMsgId=n;g.getReactionMapByProtocolMsgId=o;g.deleteReactionsByUniqueMsgIdentifiers=p;g.deleteAllReactionsForMessages=q;g.getNextReactionIdNumberForThread=r}),98);
__d("MAWSharedCOPLogger",["WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";a=d("WATagsLogger").TAGS(["COP"]);g["default"]=a}),98);
__d("WAPersistedQueueCache",["WAResolvable","WAShiftTimer","WATagsLogger","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error during flush: ",""]);h=function(){return a};return a}function a(a,c,e){var f=d("WATagsLogger").TAGS(["PersistedQueue",a,"cache"]),g=[],i=new(d("WAResolvable").Resolvable)(),j=(a=e)!=null?a:{},k=new(d("WAShiftTimer").ShiftTimer)(function(){void n()});return{commit:function(){return n()},add:function(a){g.push(a);a=i;l();m();return a.promise},config:function(a){j=a}};function l(){j.cacheSize!=null&&g.length>=j.cacheSize&&void n()}function m(){if(j.maxDelay!=null){var a=j.maxDelay;k.cancel();k.onOrAfter(a)}}function n(){var a,e;return b("regeneratorRuntime").async(function(j){while(1)switch(j.prev=j.next){case 0:if(!(g.length===0)){j.next=2;break}return j.abrupt("return");case 2:k.cancel();a=g;g=[];e=i;i=new(d("WAResolvable").Resolvable)();j.prev=7;j.next=10;return b("regeneratorRuntime").awrap(c(a));case 10:e.resolve();j.next=18;break;case 13:j.prev=13;j.t0=j["catch"](7);f.ERROR(h(),j.t0);e.reject(j.t0);throw j.t0;case 18:case"end":return j.stop()}},null,this,[[7,13]])}}g.makePersistedQueueCache=a}),98);
__d("WAPubSub",[],(function(a,b,c,d,e,f){"use strict";var g=function(){function a(){this.$1=new Set()}var b=a.prototype;b.publish=function(a){this.$1.forEach(function(b){return b(a)})};b.subscribe=function(a){var b=this;this.$1.add(a);return function(){b.$1["delete"](a)}};return a}();function a(){return new g()}f.WAPubSub=g;f.simplePubSub=a}),66);
__d("WAPersistedQueue",["WALogger","WAPersistedQueueCache","WAPubSub"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueue] new entry & commit"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueue] new entry"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueue] flush: ","}"]);j=function(){return a};return a}var k=function(){function a(a,b,c){var e=this;this.$1=d("WAPubSub").simplePubSub();this.keys=function(){return e.$4.keys(e.$3)};this.read=function(a){return e.$4.read(e.$3,a)};this.$3=a;this.$4=b;this.$2=d("WAPersistedQueueCache").makePersistedQueueCache(a,function(c){return b.write(a,c).then(function(){d("WALogger").DEV(j(),c.length),e.$1.publish({type:"flush"})})},c)}var b=a.prototype;b.subscribe=function(a){return this.$1.subscribe(a)};b.index=function(a){function b(b){return a.apply(this,arguments)}b.toString=function(){return a.toString()};return b}(function(a){return this.$4.index(this.$3,a)});b.addPending=function(a,b,c){d("WALogger").DEV(i()),this.$1.publish({type:"new_entity"}),void this.$2.add(a).then(function(){return b==null?void 0:b()},function(a){return c==null?void 0:c(a)})};b.addAndCommit=function(a){var b=this;d("WALogger").DEV(h());this.$1.publish({type:"new_entity"});a.forEach(function(a){return void b.$2.add(a)});return this.$2.commit()};b.commit=function(){return this.$2.commit()};b.ack=function(a){return this.$4.ack(this.$3,a)};b["delete"]=function(a){return this.$4["delete"](this.$3,a)};b.clear=function(){return this.$4.clear(this.$3)};return a}();function a(a,b,c){return new k(a,b,c)}g.PersistedQueue=k;g.initPersistedQueue=a}),98);
__d("WADbTransactor",["MAWIndexedDb","MAWTransactionMode","WAErr","WAExceededStorageQuota","asyncToGeneratorRuntime","dexie_maw"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e){var f=Object.keys(a),g=f.some(function(b){return a[b]===d("MAWTransactionMode").READWRITE})?d("MAWTransactionMode").READWRITE:d("MAWTransactionMode").READONLY;return function(){for(var a=arguments.length,j=new Array(a),k=0;k<a;k++)j[k]=arguments[k];return d("MAWIndexedDb").getSignalDB(b).then(function(a){return h(g,f,function(){return e(a.stores).apply(void 0,j)})})["catch"](function(a){d("WAExceededStorageQuota").checkQuotaExceededError(a);a=i(a);throw c("WAErr")("["+((a=a==null?void 0:a.toString())!=null?a:"unknown error")+"] Error performing %s transaction "+b)})}}function h(a,b,e){if(c("dexie_maw").currentTransaction!=null)throw c("WAErr")("protocolDB transactor %s cannot be called within another transaction");return d("MAWIndexedDb").getSignalDB().then(function(c){return c.transact(a,b,e)})}function i(a){if(a instanceof Error)return a;else if(typeof a==="string")return c("WAErr")(a);else return null}function e(a,b,c,d){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e){var f=a+"_"+e,g=(yield d("MAWIndexedDb").getDB(f));return g.transact(b,[a],function(){return c(g.stores[a])})["catch"](function(a){d("WAExceededStorageQuota").checkQuotaExceededError(a);var b=i(a);throw a("["+((a=b==null?void 0:b.toString())!=null?a:"unknown error")+"] Error performing %s transaction "+f)})});return j.apply(this,arguments)}g.makeSignalTransactor=a;g.persistedQueueTransactor=e}),98);
__d("WAPersistedQueueApi",["MAWTransactionMode","WADbTransactor"],(function(a,b,c,d,e,f,g){"use strict";function a(){return{ack:k,clear:m,"delete":l,index:i,keys:n,read:h,write:j}}function h(a,b){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READONLY,function(a){a=a.toCollection();(b==null?void 0:b.order)==="desc"&&(a=a.reverse());(b==null?void 0:b.filter)!=null&&(a=a.filter(b.filter));(b==null?void 0:b.limit)!=null&&(a=a.limit(b.limit));return a.toArray()},"read")}function i(a,b){return{equals:function(c){return{read:function(e){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READONLY,function(a){a=a.where(b).equals(c.length===1?c[0]:c);(e==null?void 0:e.order)==="desc"&&(a=a.reverse());(e==null?void 0:e.filter)!=null&&(a=a.filter(e.filter));(e==null?void 0:e.limit)!=null&&(a=a.limit(e.limit));return a.toArray()},"index-equal")}}},keys:function(){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READONLY,function(a){a=a.orderBy(b);return a.uniqueKeys()},"index-keys")},read:function(c){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READONLY,function(a){a=a.orderBy(b);(c==null?void 0:c.order)==="desc"&&(a=a.reverse());(c==null?void 0:c.filter)!=null&&(a=a.filter(c.filter));(c==null?void 0:c.limit)!=null&&(a=a.limit(c.limit));return a.toArray()},"index-read")}}}function j(a,b){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READWRITE,function(a){return a.bulkAdd(b).then(function(){})},"write")}function k(a,b){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READWRITE,function(a){return a.bulkDelete(b)},"ack")}function l(a,b){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READWRITE,function(a){return a.bulkDelete(b)},"delete")}function m(a){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READWRITE,function(a){return a.clear().then(function(){})},"clear")}function n(a){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READONLY,function(a){a=a.toCollection();return a.primaryKeys()},"keys")}g.dexieApiForPersistedQueue=a;g.persistedQueueRead=h;g.persistedQueueIndex=i;g.persistedQueueWrite=j;g.persistedQueueAck=k;g.persistedQueueDelete=l;g.persistedQueueClear=m;g.persistedQueueKeys=n}),98);
__d("MAWDbStaleQueue",["MAWCurrentUser","MAWDbVersion","MAWIndexedDbMetadata","MAWODSProxy","MAWSharedCOPLogger","WAGetPlatformFromStanzaId","WAOdsEnums","WAPersistedQueue","WAPersistedQueueApi","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Dropping: ",", error: ",". Source: ",""]);h=function(){return a};return a}var i=null;function j(){if(i)return i;var a=d("WAPersistedQueue").initPersistedQueue("staleQueue",d("WAPersistedQueueApi").dexieApiForPersistedQueue());i=a;return a}function a(a,b){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var e=a.type==="message"?a.subtype!=null?d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(a.stanzaId):d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(a.message.details.externalId):null;c("MAWSharedCOPLogger").EXPECTED_ERROR(h(),a.type,b,e);d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.POISON_QUEUE_ENTTITY,key:""+a.type});e=j();var f=d("MAWCurrentUser").getID();f=(f=(yield d("MAWDbVersion").getDexieDbVersion(d("MAWIndexedDbMetadata").dbName(f))))!=null?f:0;if(a.type!=="message")return;return e.addAndCommit([{dbVersion:f,exception:b,stanza:a}])});return k.apply(this,arguments)}e=function(){return j().read({limit:1}).then(function(a){return a.length===0})};f=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a===void 0&&(a=500);a=j().read({limit:a});a=(yield a.then(function(a){return a.flatMap(function(a){return a})}));return a});return function(b){return a.apply(this,arguments)}}();g.mawAddStaleStanza=a;g.isEmpty=e;g.read=f}),98);
__d("MAWIsQuotaExceededError",[],(function(a,b,c,d,e,f){"use strict";a=function(a){return a.name==="QuotaExceededError"||a.inner&&a.inner.name==="QuotaExceededError"};f.isQuotaExceededError=a}),66);
__d("MAWSharedRestoreUnavailableMessages",["LSMEBTaskCreationSource","MAWBridgeEventTransmitter","WAGlobals","WAJids","setTimeout"],(function(a,b,c,d,e,f,g){"use strict";var h=1e4,i=new Map();function j(a){if(i.has(a.externalId))return;i.set(a.externalId,!0);c("setTimeout")(function(){var b=a.chat;d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(a.externalId,d("WAJids").threadIdForChatJid(b),void 0,c("LSMEBTaskCreationSource").EB_POINT_QUERY_RETRY_DECRYPTION_FAILURES,b)},h)}function a(a){a.forEach(function(a){if(a.type!=="message")return;if(a.subtype!=null){if(a.subtype==="unavailable"||a.subtype==="ciphertext"){var b=d("WAJids").extractUserJid(a.from);j({author:d("WAGlobals").getMyUserJid()===b?"@me":b,chat:a.jid,externalId:a.stanzaId})}}else(a.message.decrypted.type==="IncomingCiphertextMsg"||a.message.decrypted.type==="UnavailableMsg")&&j(a.message.decrypted.id)})}g.restoreUnavailableMessages=a}),98);
__d("WAPREList",["$InternalEnum"],(function(a,b,c,d,e,f){"use strict";a=b("$InternalEnum")({DECRYPT_MESSAGE_FINAL:"decrypt_message_final",FRANKING_VALIDATION:"franking_validation",GET_DEVICES:"get_devices",MEDIA_DOWNLOAD:"media_download",MEDIA_UPLOAD:"media_upload",MEDIA_VALIDATE:"media_validate",DELETE_THREAD:"delete_thread",DOWNLOAD_AND_DECRYPT:"download_and_decrypt",MESSAGE_DECRYPTION:"message_decryption",MESSAGE_ENCRYPTION:"message_encryption",OFFLINE_QUEUE:"offline_queue",OFFLINE_RETRY:"offline_retry",ICDC_ERROR:"icdc_error",QUERY_GROUP:"query_group",QUERY_GROUPS:"query_groups",RETRY_RECEIPTS_SENT:"retry_receipts_sent",SYNCD_FATAL_ERROR:"syncd_fatal_error",SYNCD_CRITICAL_EVENT:"syncd_critical_event",SYNCD_CRITICAL_BOOTSTRAP_STAGE:"syncd_critical_bootstrap_stage",SYNCD_BOOTSTRAP_APP_STATE_DOWNLOAD:"syncd_bootstrap_app_state_download",SYNCD_DECRYPT_MUTATIONS:"syncd_decrypt_mutations",SYNCD_BOOTSTRAP_DATA_APPLIED:"syncd_bootstrap_data_applied",APP_STATE_SYNC_DAILY:"app_state_sync_daily",SYNCD:"syncd",SEND_MESSAGE:"send_message",RECEIVE_MESSAGE:"receive_message",SYNCD_KEY_ROTATION:"syncd_key_rotation",REMOVE_PARTICIPANTS:"remove_participants",CREATE_GROUP:"create_group",WA_JOBS_ORCHESTRATOR:"wa_jobs_orchestrator",WA_DISCONNECT:"wa_disconnect",WA_JOB_MANAGER:"wa_job_manager",STANZA_QUEUE_MESSAGE_CONSUMER:"stanza_queue_message_consumer",WA_FAIL_STANZA_QUEUE_ITEM:"stanza_queue_item_failure",ONE_QUEUE:"one_queue",PROTOCOL_QUEUE_CONSUMER:"protocol_queue_consumer",WA_NO_SIGNED_PRE_KEY:"wa_no_signed_pre_key",EB_RESTORE_WITH_HIM:"eb_restore_with_him",WORM:"worm"});f.PRE_METRIC=a}),66);
__d("WAMapContentTypeToFbType",[],(function(a,b,c,d,e,f){"use strict";function a(a){switch(a){case"text":return"text";case"media":return"media";case"reaction":return"reaction";case"live_location":case"pay":case"product_list":case"poll_creation":case"poll_vote":case"scheduled_call":return"text";default:return"text"}}f.mapContentTypeToFbType=a}),66);
__d("WAProtocolQueue",["WAErr","WAGlobals","WAJids","WALogger","WAMapContentTypeToFbType","WAPersistedQueue"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Protocol Queue is already initialized"]);h=function(){return a};return a}var i=5e3,j=null;function a(a){if(j!=null){d("WALogger").WARN(h());return j}a=d("WAPersistedQueue").initPersistedQueue("stanzaQueue",a,{cacheSize:null,maxDelay:i});j=a;return j}function b(){if(!j)throw c("WAErr")("Protocol queue not initialized");return j}function e(a){return{flush:function(){return a.commit()}}}function f(a){return a.map(function(a){return a.type==="message"?k(a):babelHelpers["extends"]({},a)})}function k(a){switch(a.subtype){case"unavailable":var b=a,c=d("WAJids").extractUserJid(b.from);c={id:{author:d("WAGlobals").getMyUserJid()===c?"@me":c,chat:b.jid,externalId:b.stanzaId},ts:b.serverTs,type:"UnavailableMsg"};return{incomingType:"wa",jid:b.jid,message:{decrypted:c,details:{count:null,externalId:b.stanzaId,folder:b.fbFolderId,from:d("WAJids").switchOnMsgrChatJidType(b.jid,{group:function(a){return{author:b.from,chat:a,groupJid:a,type:"group"}},user:function(a){return{author:b.from,chat:a,deviceJid:b.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:b.offline,recipient:b.recipient,reportingMeta:b.reportingMeta,retryCount:b.retryCount,ts:b.serverTs,type:d("WAMapContentTypeToFbType").mapContentTypeToFbType(b.contentType)}},priority:b.priority,stanzaId:b.stanzaId,stanzaQueueId:a.stanzaQueueId,type:b.type};case"armadillo":var e=a;c=d("WAJids").extractUserJid(e.from);c={device:{id:d("WAJids").extractDeviceId(e.from),identity:e.remoteIdentity},folder:e.fbFolderId,id:{author:d("WAGlobals").getMyUserJid()===c?"@me":c,chat:e.jid,externalId:e.stanzaId},msg:e.message,recipientsCount:null,reportingMeta:e.reportingMeta,ts:e.serverTs,type:"IncomingMsg"};return{incomingType:a.incomingType,jid:e.jid,message:{decrypted:c,details:{count:null,externalId:e.stanzaId,folder:e.fbFolderId,from:d("WAJids").switchOnMsgrChatJidType(e.jid,{group:function(a){return{author:e.from,chat:a,groupJid:a,type:"group"}},user:function(a){return{author:e.from,chat:a,deviceJid:e.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:e.offline,recipient:e.recipient,reportingMeta:e.reportingMeta,retryCount:e.retryCount,ts:e.serverTs,type:d("WAMapContentTypeToFbType").mapContentTypeToFbType(e.contentType)}},priority:e.priority,stanzaId:e.stanzaId,stanzaQueueId:a.stanzaQueueId,type:e.type,ebTimestampMs:e.ebTimestampMs};case"instamadillo":var f=a;c=d("WAJids").extractUserJid(f.from);c={device:{id:d("WAJids").extractDeviceId(f.from),identity:f.remoteIdentity},folder:f.fbFolderId,id:{author:d("WAGlobals").getMyUserJid()===c?"@me":c,chat:f.jid,externalId:f.stanzaId},msg:f.message,recipientsCount:null,reportingMeta:f.reportingMeta,ts:f.serverTs,type:"InstamadilloMsg"};return{incomingType:"wa",jid:f.jid,message:{decrypted:c,details:{count:null,externalId:f.stanzaId,folder:f.fbFolderId,from:d("WAJids").switchOnMsgrChatJidType(f.jid,{group:function(a){return{author:f.from,chat:a,groupJid:a,type:"group"}},user:function(a){return{author:f.from,chat:a,deviceJid:f.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!0,offline:f.offline,recipient:f.recipient,reportingMeta:f.reportingMeta,retryCount:f.retryCount,ts:f.serverTs,type:d("WAMapContentTypeToFbType").mapContentTypeToFbType(f.contentType)}},priority:f.priority,stanzaId:f.stanzaId,stanzaQueueId:a.stanzaQueueId,type:f.type};case"ciphertext":var g=a;c=d("WAJids").extractUserJid(g.from);c={createPlaceholder:g.contentType!=="reaction",id:{author:d("WAGlobals").getMyUserJid()===c?"@me":c,chat:g.jid,externalId:g.stanzaId},ts:g.serverTs,type:"IncomingCiphertextMsg"};return{incomingType:"wa",jid:g.jid,message:{decrypted:c,details:{count:null,type:d("WAMapContentTypeToFbType").mapContentTypeToFbType(g.contentType),externalId:g.stanzaId,folder:g.fbFolderId,from:d("WAJids").switchOnMsgrChatJidType(g.jid,{group:function(a){return{author:g.from,chat:a,groupJid:a,type:"group"}},user:function(a){return{author:g.from,chat:a,deviceJid:g.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:g.offline,recipient:g.recipient,reportingMeta:g.reportingMeta,retryCount:g.retryCount,ts:g.serverTs}},priority:g.priority,stanzaId:g.stanzaId,stanzaQueueId:a.stanzaQueueId,type:g.type};default:a;return babelHelpers["extends"]({},a)}}var l=9,m=5,n=2;function o(a){return a}function p(a){return a}function q(a){return a}g.initProtocolQueue=a;g.protocolQueue=b;g.protocolQueueFlushable=e;g.mapProtocolEntriesV2toV1=f;g.mapProcolQueueMessageV2toV1=k;g.WAProtocolQueuePriorityHigh=l;g.WAProtocolQueuePriorityLow=m;g.WAProtocolQueuePriorityBackground=n;g.appdataApplicationProtocol=o;g.extractSubProtocolFromAppdataProtocol=p;g.numberToStanzaQueueId=q}),98);
__d("WAPREMetrics",["WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[PRE] There are no subscribers to PRE events"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Removing all listeners from PRE_METRICS"]);i=function(){return a};return a}c=6e4;e=18e4;f=10*60*1e3;var j=0;function a(){var c=[];function e(a){c.push(a)}function b(){d("WALogger").WARN(i()),c.length=0}function a(a){c.length===0&&d("WALogger").WARN(h()),c.forEach(function(b){b(a)})}return{subscribe:e,notify:a,clear:b}}a=a();var k=a.notify,l=a.clear;a=a.subscribe;function b(a,b,c,d){var e;c==null&&j++;var f=(e=c)!=null?e:j,g="open";c==null?k({name:a,stage:"START",instanceKey:f,annotations:b,timeoutInMs:d}):k({name:a,stage:"RESUME",instanceKey:f,annotations:b});return{addPoint:function(c,b){k({name:a,stage:"POINT",reason:c,instanceKey:f,annotations:b})},addAnnotations:function(b){k({name:a,stage:"ANNOTATE",instanceKey:f,annotations:b})},endSuccess:function(b){k({name:a,stage:"SUCCESS",instanceKey:f,annotations:b}),g="closed"},endFail:function(c,b){k({name:a,stage:"FAIL",reason:c,instanceKey:f,annotations:b}),g="closed"},getFlowDetails:function(){return{name:a,instanceKey:f}},isActive:function(){return g==="open"}}}g.QPL_DEFAULT_TIMEOUT_IN_MS=c;g.QPL_RECEIVE_MESSAGE_TIMEOUT_IN_MS=e;g.QPL_MEDIA_DOWNLOAD_TIMEOUT_IN_MS=f;g.clear=l;g.subscribe=a;g.startMetric=b}),98);
__d("WAWaterFlow",["$InternalEnum","WAErr","WAMapWithDefault","WAPREMetrics","WATagsLogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose([" -> Done. Success: false\nTime taken: "," sec;","","\n"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose([" -> Done. Success: true\nTime taken: "," sec;","","\n"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose([" -> in progress.\nTime passed: "," sec;","","\n"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Step should be a enum type"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose([""," -> Done.;\nTime taken: ",";\nTime from start: ",";","","\n"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Step should be a enum type"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["No start point was found for step: ","."]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose([""," -> Start.","",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Step should be a enum type"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose([" -> Start.",""]);q=function(){return a};return a}var r=d("WATagsLogger").TAGS(["WAWaterflow"]),s=b("$InternalEnum").Mirrored(["INIT","ON_GOING","COMPLETED"]),t=function(){function a(a,b,c){this.$1=s.INIT,this.$7=[],this.$9=new(d("WAMapWithDefault").MapWithDefault)(function(){return[]}),this.$5=r.TAGS([a]),this.$8=b,this.$3={},this.$4=new Set(),this.$10=!c,this.$6=d("WATimeUtils").performanceAbsoluteNow()}var b=a.prototype;b.$11=function(){var a=this,b={"int":{},bool:{},string:{},string_array:{}};this.$4.forEach(function(c){var d=a.$3[c];Array.isArray(d)&&(b.string_array[c]=d);typeof d==="boolean"&&(b.bool[c]=d);typeof d==="number"&&(b["int"][c]=d);typeof d==="string"&&(b.string[c]=d)});return b};b.$12=function(a){if(a==null)return;for(var b in a){var c=a[b];c!==this.$3[b]&&(this.$4.add(b),this.$3[b]=c)}};b.$13=function(a,b){this.$6=d("WATimeUtils").performanceAbsoluteNow();this.$12(a);a=this.$11();this.$4.clear();this.$10&&this.$5.LOG(q(),u(this.$3));this.$1=s.ON_GOING;if(this.$8==null)return this;this.$2=d("WAPREMetrics").startMetric(this.$8,a,b);return this};b.startMetric=function(a){return this.$13(a)};b.reStartMetric=function(a,b){return this.$13(b,a)};b.startPoint=function(a,b){var e;if(typeof a!=="string"){this.$5.ERROR(p());throw c("WAErr")("Step should be a enum type")}this.$12(b);b=this.$11();(e=this.$2)==null?void 0:e.addPoint(a+"_start",b);this.$4.clear();e={step:a,from:d("WATimeUtils").performanceAbsoluteNow()};this.$7.push(e);this.$9.get(a).push(e);this.$10&&this.$5.LOG(o(),a,v(this.$7,this.$6),u(this.$3))};b.endPoint=function(a,b){var e,f=d("WATimeUtils").performanceAbsoluteNow(),g=this.$9.get(a).pop();g==null?this.$5.WARN(n(),a):g.to=f;if(typeof a!=="string"){this.$5.ERROR(m());throw c("WAErr")("Step should be a enum type")}this.$12(b);b=this.$11();(e=this.$2)==null?void 0:e.addPoint(a+"_end",b);this.$4.clear();this.$10&&this.$5.LOG(l(),a,w(g!=null?f-g.from:0),w(f-this.$6),v(this.$7,this.$6),u(this.$3))};b.isOnGoing=function(){return this.$1===s.ON_GOING};b.isCompleted=function(){return this.$1===s.COMPLETED};b.annotate=function(a){this.$12(a)};b.reAnnotate=function(a){this.$12(a(this.$3))};b.getAnnotations=function(){return this.$3};b.annotateImmediately=function(a){var b;this.$12(a);a=this.$11();(b=this.$2)==null?void 0:b.addAnnotations(a);this.$4.clear()};b.addPoint=function(a,b){var d;if(typeof a!=="string"){this.$5.ERROR(k());throw c("WAErr")("Step should be a enum type")}this.$12(b);b=this.$11();(d=this.$2)==null?void 0:d.addPoint(a,b);this.$4.clear()};b.getStartTime=function(){return this.$6};b.log=function(){this.$10&&this.$5.LOG(j(),(d("WATimeUtils").performanceAbsoluteNow()-this.$6)/1e3,v(this.$7,this.$6),u(this.$3))};b.endSuccess=function(a){var b;this.$12(a);a=this.$11();(b=this.$2)==null?void 0:b.endSuccess(a);this.$4.clear();this.$10&&this.$5.LOG(i(),(d("WATimeUtils").performanceAbsoluteNow()-this.$6)/1e3,v(this.$7,this.$6),u(this.$3));this.$1=s.COMPLETED};b.endFail=function(a,b){var c;this.$12(b);b=this.$11();(c=this.$2)==null?void 0:c.endFail(a,b);this.$4.clear();this.$10&&this.$5.LOG(h(),(d("WATimeUtils").performanceAbsoluteNow()-this.$6)/1e3,v(this.$7,this.$6),u(this.$3));this.$1=s.COMPLETED};return a}();function a(a){if(a==null)return{};var b={bool:{},"int":{},string:{},string_array:{}};for(var c in a)Array.isArray(a[c])&&(b.string_array[c]=a[c]),typeof a[c]==="number"&&(b["int"][c]=a[c]),typeof a[c]==="boolean"&&(b.bool[c]=a[c]),typeof a[c]==="string"&&(b.string[c]=a[c]);return b}function u(a){a=Object.entries(a).map(function(a){var b=a[0];a=a[1];return b+": "+String(a)});return a.length>0?"\n"+a.join("\n"):""}function v(a,b){a=a.map(function(a){var c=a.step,e=a.from;a=a.to;return typeof c==="string"?c+" => Started after: "+w(e-b)+"; "+(a!=null?"Completed after: "+w(a-e):"In progress: "+w(d("WATimeUtils").performanceAbsoluteNow()-e)):""}).filter(Boolean);return a.length>0?"\n"+a.join("\n"):""}function w(a){return a/1e3+"s"}function e(a,b,c){return new t(a,b,(a=c)!=null?a:!1)}g.WAWaterflow=t;g.convertToPREAnnotation=a;g.makeWaterflow=e}),98);
__d("MAWSharedCOPHandleBatch",["MAWDbStaleQueue","MAWIsQuotaExceededError","MAWSharedCOPLogger","MAWSharedRestoreUnavailableMessages","WAPREList","WAProtocolQueue","WAWaterFlow","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received more than 1 entry, despite having limit === 1"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed processing "," items"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[ackProtocols] Cannot ack from MAWConsumer: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Runtime error while processing stanzas batch. ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Quota exceeded while processing stanzas batch. ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose([""," stanzas. Config:",""]);m=function(){return a};return a}function n(a,b,c,d){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){var g=(yield a(b));b.order==="desc"&&(g=g.toReversed());if(g.length===0)return{exhausted:!0,handled:0};f==null?void 0:f.publish({type:"maw-infra-batch"});c("MAWSharedCOPLogger").LOG(m(),g.length,b);var o=d("WAWaterFlow").makeWaterflow("consumer",d("WAPREList").PRE_METRIC.PROTOCOL_QUEUE_CONSUMER,!0).startMetric();d("MAWSharedRestoreUnavailableMessages").restoreUnavailableMessages(g);var p=(yield e(g,o).then(function(a){return[a,null,!1]})["catch"](function(a){if(d("MAWIsQuotaExceededError").isQuotaExceededError(a)){c("MAWSharedCOPLogger").ERROR(l(),a);o.endFail("quota_exceeded");return[[],null,!0]}c("MAWSharedCOPLogger").ERROR(k(),a);return[[],a instanceof Error?a:c("err")(""+a),!1]})),q=p[0],r=p[1];p=p[2];if(p)return{exhausted:!0,handled:0};r==null?o.endSuccess():o.endFail("fail_process_entity");yield d("WAProtocolQueue").protocolQueue().ack(q)["catch"](function(a){return c("MAWSharedCOPLogger").ERROR(j(),a)});if(q.length>=g.length)return{exhausted:!1,handled:q.length};c("MAWSharedCOPLogger").WARN(i(),g.length-q.length);if(b.limit===1){g.length>1&&c("MAWSharedCOPLogger").ERROR(h());if(g.length===0)return{exhausted:!1,handled:0};p=g[0];r=(g=r==null?void 0:r.toString())!=null?g:"not-processed";yield d("WAProtocolQueue").protocolQueue()["delete"]([p.stanzaQueueId]);yield d("MAWDbStaleQueue").mawAddStaleStanza(p,r);return{exhausted:!1,handled:1}}p=(yield n(a,{limit:Math.ceil(((g=b.limit)!=null?g:1)/2),order:b.order},e,f));return{exhausted:!1,handled:q.length+p.handled}});return o.apply(this,arguments)}g.copHandleBatch=n}),98);
__d("WAPromiseEach",["regeneratorRuntime"],(function(a,b,c,d,e,f){"use strict";a=function(a,c){var d,e;return b("regeneratorRuntime").async(function(f){while(1)switch(f.prev=f.next){case 0:d=[],e=0;case 2:if(!(e<a.length)){f.next=11;break}f.t0=d;f.next=6;return b("regeneratorRuntime").awrap(c(a[e]));case 6:f.t1=f.sent,f.t0.push.call(f.t0,f.t1);case 8:e++;f.next=2;break;case 11:return f.abrupt("return",d);case 12:case"end":return f.stop()}},null,this)};f.promiseEach=a}),66);
__d("MAWSharedCOPHandler",["$InternalEnum","MAWSharedCOPHandleBatch","MAWSharedCOPLogger","WAPromiseEach","WAProtocolQueue","asyncToGeneratorRuntime","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processed "," stanzas. Exhausted: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[SafeGuard] Processing get downgraded to in order processing. Verify if it's intentional"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[UserBlocking] Processed "," stanzas from "," chats"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[LoadMoreMsgs] "," requested: ",", processed: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[OnDemand] Fatal: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[UserFacing] Processed "," stanzas. Exhausted: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Background] Processed "," stanzas. Exhausted: ",""]);n=function(){return a};return a}var o=b("$InternalEnum").Mirrored(["PERSIST","PERSIST_FAIL","FOLLOW_UP","PROCESS_RETRIES"]),p=c("justknobx")._("2541"),q=c("justknobx")._("2542"),r=c("justknobx")._("2653");function a(a){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=a.processEntries;var b=r?"desc":"asc",e=c("justknobx")._("2539");e=(yield d("MAWSharedCOPHandleBatch").copHandleBatch(d("WAProtocolQueue").protocolQueue().index("priority").read,{limit:e,order:b},a,null));b=e.exhausted;a=e.handled;c("MAWSharedCOPLogger").LOG(n(),a,b);return{exhausted:b,handled:a}});return s.apply(this,arguments)}function e(a){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.activeJid;a=a.processEntries;if(!r)return x({processEntries:a}).then(function(){return{exhausted:!0}});var e={exhausted:!0,handled:0};b!=null&&(e=(yield d("MAWSharedCOPHandleBatch").copHandleBatch(d("WAProtocolQueue").protocolQueue().index("[jid+priority]").equals([b,d("WAProtocolQueue").WAProtocolQueuePriorityHigh]).read,{limit:q,order:"desc"},a,null)));b=e.handled;e.exhausted&&(e=(yield d("MAWSharedCOPHandleBatch").copHandleBatch(d("WAProtocolQueue").protocolQueue().index("priority").equals([d("WAProtocolQueue").WAProtocolQueuePriorityHigh]).read,{limit:q,order:"desc"},a,null)),b+=e.handled);b>0&&c("MAWSharedCOPLogger").LOG(m(),b,e.exhausted);return{exhausted:e.exhausted}});return t.apply(this,arguments)}function f(a){return u.apply(this,arguments)}function u(){u=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.activeJid,e=a.count;a=a.processEntries;if(!r)return;a=(yield d("MAWSharedCOPHandleBatch").copHandleBatch(d("WAProtocolQueue").protocolQueue().index("[jid+priority]").equals([b,d("WAProtocolQueue").WAProtocolQueuePriorityHigh]).read,{limit:e,order:"desc"},a,null)["catch"](function(a){c("MAWSharedCOPLogger").ERROR(l(),a)}));c("MAWSharedCOPLogger").LOG(k(),b,e,a==null?void 0:a.handled)});return u.apply(this,arguments)}function v(a){return w.apply(this,arguments)}function w(){w=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.activeChat,f=a.processEntries,g=a.pubSub;a=a.recentChats;if(!r)return x({processEntries:f,pubSub:g});var h=0;yield d("WAPromiseEach").promiseEach(a,function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=c("gkx")("4258")&&a!==e?1:p;a=(yield d("MAWSharedCOPHandleBatch").copHandleBatch(d("WAProtocolQueue").protocolQueue().index("[jid+priority]").equals([a,d("WAProtocolQueue").WAProtocolQueuePriorityHigh]).read,{limit:b,order:"desc"},f,g));h+=a.handled});return function(b){return a.apply(this,arguments)}}());c("MAWSharedCOPLogger").LOG(j(),h,a.length)});return w.apply(this,arguments)}function x(a){return y.apply(this,arguments)}function y(){y=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.processEntries;a=a.pubSub;c("MAWSharedCOPLogger").ERROR(i());a==null?void 0:a.publish({type:"idle-oq-safe-guard"});var e=d("WAProtocolQueue").protocolQueue().index("priority").equals([d("WAProtocolQueue").WAProtocolQueuePriorityHigh]).read;while((f=(yield d("MAWSharedCOPHandleBatch").copHandleBatch(e,{limit:c("justknobx")._("2540"),order:"asc"},b,(f=a)!=null?f:null))).exhausted===!1){var f;c("MAWSharedCOPLogger").LOG(h(),f.handled,f.exhausted)}});return y.apply(this,arguments)}g.ConsumerProcessingStages=o;g.copHandleBackgroundBatch=a;g.copHandleUserFacingBatch=e;g.copHandleMessagesOnDemand=f;g.copHandleRecentMessages=v}),98);
__d("MAWSharedCOPLoop",["$InternalEnum","MAWSharedCOPLogger","Promise","WAResolvable","WAShiftTimer","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Completed: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Started: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Stuck: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Possibly stuck: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["COPLoop fatal: ",""]);m=function(){return a};return a}var n=b("$InternalEnum")({BLOCKING:-1,NON_BLOCKING:0,BASE_TIMEOUT:2}),o=0,p=1,q=2,r=function(){function a(){var a=this;this.$2=0;this.$3=60;this.$4=30;this.$5=c("justknobx")._("2543");this.$6=new(d("WAResolvable").Resolvable)();this.$7=new(d("WAResolvable").Resolvable)();this.$8=new(d("WAResolvable").Resolvable)();this.$9=new(d("WAShiftTimer").ShiftTimer)(function(){try{a.$10()}catch(b){c("MAWSharedCOPLogger").ERROR(m(),b),a.$9.onOrBefore(a.$5)}});this.$11=c("MAWSharedCOPLogger").TAGS(["loop"]);this.$12=[new Map(),new Map(),new Map()]}var e=a.prototype;e.$13=function(){if(!this.$1)return;this.$2++;switch(this.$1.behaviour){case n.BLOCKING:break;case n.NON_BLOCKING:this.$1=null;return;case n.BASE_TIMEOUT:if(this.$2>Number(n.BASE_TIMEOUT)){this.$1=null;return}break}if(!this.$1)return;var a=this.$1;this.$2>this.$4&&a.stuck===!1&&(a.stuck=!0,this.$11.WARN(l(),a.id));this.$2>this.$3&&(this.$11.ERROR(k(),a.id),this.$1=null)};e.$14=function(){var a=this;if(this.$1!=null)return{endReached:!1};for(var b=o;b<=q;b++){var c=this.$12[b].entries().next().value;if(c!=null){var d=function(){var d=c[0],e=c[1];a.$12[b]["delete"](d);a.$1=e;a.$2=0;a.$11.LOG(j(),e.id);e.fn()["finally"](function(){a.$2=0,a.$11.LOG(i(),e.id),a.$1=null,(a.$12[o].size>0||a.$5===0)&&a.$9.forceRunNow()});return{v:{endReached:!1}}}();if(typeof d==="object")return d.v}b===o&&this.$6.resolve();b===p&&this.$7.resolve();b===q&&this.$8.resolve()}return{endReached:!0}};e.$10=function(){this.$13();var a=this.$14();a=a.endReached;a||this.$9.onOrBefore(this.$5)};e.$15=function(a,c,e,f){var g;for(var i=q;i>a;i--){var j=this.$12[i].get(c);j!=null&&(g=j.resolvable,this.$12[i]["delete"](c))}for(j=o;j<a;j++){i=this.$12[j].get(c);if(i!=null)return i.resolvable.promise}g==null&&(g=new(d("WAResolvable").Resolvable)());i={behaviour:f,fn:function(b){function a(){return b.apply(this,arguments)}a.toString=function(){return b.toString()};return a}(function(){g.resolve((h||(h=b("Promise"))).resolve().then(e));return g.promise}),id:c,resolvable:g,stuck:!1};this.$12[a].set(c,i);a===o&&this.$1==null?this.$9.forceRunNow():this.$9.onOrBefore(this.$5);return g.promise};e.awaitUserBlocking=function(a,b,c){this.$6.resolveWasCalled()&&(this.$6=new(d("WAResolvable").Resolvable)());this.$7.resolveWasCalled()&&(this.$7=new(d("WAResolvable").Resolvable)());this.$8.resolveWasCalled()&&(this.$8=new(d("WAResolvable").Resolvable)());return this.$15(o,a,b,c)};e.awaitUserFacing=function(a,b,c){this.$7.resolveWasCalled()&&(this.$7=new(d("WAResolvable").Resolvable)());this.$8.resolveWasCalled()&&(this.$8=new(d("WAResolvable").Resolvable)());return this.$15(p,a,b,c)};e.awaitBackground=function(a,b,c){this.$8.resolveWasCalled()&&(this.$8=new(d("WAResolvable").Resolvable)());return this.$15(q,a,b,c)};e.waitForBackgroundQueueEmpty=function(){return this.$8.promise};e.waitForUserFacingQueueEmpty=function(){return this.$7.promise};e.waitForUserUnblocked=function(){return this.$6.promise};return a}();function a(a){return"p0-"+a}var s=0;function e(a){s++;return a+"-"+s}function f(a){return a}var t="cop-rest",u="cop-user-facing",v="cop-user-blocking";g.COPBehaviour=n;g.COPLoop=r;g.makeChatCopId=a;g.makeCopGUID=e;g.makeCopNonUniqueId=f;g.copBackground=t;g.copUserFacing=u;g.copUserBlocking=v}),98);
__d("MAWSharedStaleQueueReporter",["MAWDbStaleQueue","MAWQplProxy","asyncToGeneratorRuntime","justknobx","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("MAWDbStaleQueue").isEmpty());if(a)return;a=c("justknobx")._("1498");a=(yield d("MAWDbStaleQueue").read(a));var b=a.map(function(a){return[a.dbVersion,a.exception]});d("MAWQplProxy").startQplUserFlow(c("qpl")._(1056849770,"993"),{"int":{count:a.length},string_array:{dbErrors:Array.from(new Set(b.map(function(a){return a[1]}))),dbVersions:Array.from(new Set(b.map(function(a){return""+a[0]})))}}).endSuccess()});return h.apply(this,arguments)}g["default"]=a}),98);
__d("WAWaitForUser",["WAResolvable"],(function(a,b,c,d,e,f,g){"use strict";var h=new(d("WAResolvable").Resolvable)();function a(){h.resolveWasCalled()&&(h=new(d("WAResolvable").Resolvable)())}function b(){return h.promise}function c(){h.resolve()}function e(){return!h.resolveWasCalled()}g.maybeResetWaitForUserUnblocked=a;g.waitForUserUnblocked=b;g.unblockUser=c;g.isStillWaitingForUserUnblocked=e}),98);
__d("MAWSharedCOP",["FBLogger","MAWSharedCOPHandler","MAWSharedCOPLogger","MAWSharedCOPLoop","MAWSharedStaleQueueReporter","Promise","WAPubSub","WAWaitForUser","asyncToGeneratorRuntime","err","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["StaleQueue: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["IdleOQ: Offline"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Background FATAL: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["HighPri FATAL: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["HighPri FATAL: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["IdleOQ M2: Online"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["UserFacing FATAL: ",""]);o=function(){return a};return a}var p=function(){function a(a){var e=this;this.$1="offline";this.$2=d("WAPubSub").simplePubSub();this.$4=null;this.$5=new Set();this.$6=function(){e.queue.awaitUserFacing(d("MAWSharedCOPLoop").copUserFacing,b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("MAWSharedCOPHandler").copHandleUserFacingBatch({activeJid:e.$4,processEntries:e.$3}));a=a.exhausted;a||e.$6()}),d("MAWSharedCOPLoop").COPBehaviour.BLOCKING)["catch"](function(a){c("MAWSharedCOPLogger").ERROR(o(),a),e.$6()})};this.queue=new(d("MAWSharedCOPLoop").COPLoop)();this.$3=a}var e=a.prototype;e.handleThreadMetadata=function(a){var b=this;a.forEach(function(a){b.$5.add(a)})};e.onlineProcessing=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this;c("MAWSharedCOPLogger").LOG(n());try{yield this.queue.awaitUserBlocking(d("MAWSharedCOPLoop").makeCopNonUniqueId("online"),b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield d("MAWSharedCOPHandler").copHandleUserFacingBatch({activeJid:void 0,processEntries:a.$3})}),d("MAWSharedCOPLoop").COPBehaviour.BLOCKING)}catch(a){c("MAWSharedCOPLogger").ERROR(m(),a)}finally{this.$6(),this.$7()}});function e(){return a.apply(this,arguments)}return e}();e.$8=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this;this.$2.publish({type:"maw-infra-start"});this.$4!=null&&this.$5.add(this.$4);try{yield this.queue.awaitUserBlocking(d("MAWSharedCOPLoop").copUserBlocking,b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield d("MAWSharedCOPHandler").copHandleRecentMessages({activeChat:a.$4,processEntries:a.$3,pubSub:a.$2,recentChats:Array.from(a.$5)}),a.$2.publish({success:!0,type:"maw-infra-end"})}),d("MAWSharedCOPLoop").COPBehaviour.BLOCKING)}catch(a){c("MAWSharedCOPLogger").ERROR(l(),a),this.$2.publish({success:!1,type:"maw-infra-end"})}finally{this.$6()}});function e(){return a.apply(this,arguments)}return e}();e.$7=function(){var a=this;this.queue.awaitBackground(d("MAWSharedCOPLoop").copBackground,b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var b=(yield d("MAWSharedCOPHandler").copHandleBackgroundBatch({processEntries:a.$3}));b=b.exhausted;b||a.$7()}),d("MAWSharedCOPLoop").COPBehaviour.BLOCKING)["catch"](function(b){c("MAWSharedCOPLogger").ERROR(k(),b),a.$7()})};e.$9=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){c("MAWSharedCOPLogger").LOG(j());yield this.$8();this.$5.clear();this.$6();this.$7();this.queue.awaitBackground(d("MAWSharedCOPLoop").makeCopNonUniqueId("stale-queue-report"),function(){return c("MAWSharedStaleQueueReporter")()},d("MAWSharedCOPLoop").COPBehaviour.NON_BLOCKING)["catch"](function(a){c("MAWSharedCOPLogger").ERROR(i(),a)});return});function e(){return a.apply(this,arguments)}return e}();e.loadMoreMsgs=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c){var e=this;this.$4=a;return!d("WAWaitForUser").isStillWaitingForUserUnblocked()?(h||(h=b("Promise"))).resolve():this.queue.awaitUserBlocking(d("MAWSharedCOPLoop").makeCopNonUniqueId("load-more-msgs-"+a),function(){return d("MAWSharedCOPHandler").copHandleMessagesOnDemand({activeJid:a,count:c,processEntries:e.$3})},d("MAWSharedCOPLoop").COPBehaviour.BLOCKING)});function c(b,c){return a.apply(this,arguments)}return c}();e.subscribeToOfflineQueue=function(a,b){var e=this;a.subscribe(function(a){switch(a.type){case"offline-start":e.$1="offline";d("WAWaitForUser").maybeResetWaitForUserUnblocked();break;case"offline-end":e.$1="online";e.$9()["finally"](function(){d("WAWaitForUser").unblockUser()});break;default:a.type;break}});b.subscribe(function(a){switch(a.type){case"flush":if(e.$1!=="online")return;c("promiseDone")(e.onlineProcessing());return}})};e.awaitBackground=function(a,b){var c=this;return d("WAWaitForUser").waitForUserUnblocked().then(function(){return c.queue.awaitBackground(a,b,d("MAWSharedCOPLoop").COPBehaviour.NON_BLOCKING)})};e.subscribe=function(a){return this.$2.subscribe(a)};e.TEST_ONLY_setMode=function(a){this.$1=a};e.TEST_ONLY_getMode=function(){return this.$1};return a}(),q=null;function a(a){q!==null&&c("FBLogger")("messenger_e2ee_web").mustfix("COP init is called twice");q=new p(a);return q}function e(){if(q===null){c("FBLogger")("messenger_e2ee_web").mustfix("COP is called before init");throw c("err")("COP is called before init")}return q}g.COP=p;g.makeCOP=a;g.getCOP=e}),98);
__d("MAWMsgCleaner",["MAWLoggerUtils","MAWSharedCOP","MAWSharedCOPLoop","Promise","WAAssertUnreachable","WAShiftTimer","WATagsLogger","WATimeUtils","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow "," msgs' content cleaned"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["","::update ",""]);k=function(){return a};return a}a="Unsend";e="Ephemeral";f="DeleteForMe";var l="PendingStanza",m="Xma",n="IGDDM";f={DELETE_FOR_ME:f,EPHEMERAL:e,IGDDM:n,PENDING_STANZA:l,UNSEND:a,XMA:m};e=function(){function a(a,e){var f=this;this.$1=new(d("WAShiftTimer").ShiftTimer)(function(){c("gkx")("3547")?c("promiseDone")(d("MAWSharedCOP").getCOP().awaitBackground(d("MAWSharedCOPLoop").makeCopGUID(f.cleanerType),function(){return f.$2()})):c("promiseDone")(f.$2())});this.getNextTs=a.getNextTs;this.removeExpired=a.removeExpired;this.cleanerType=e;this.purgeEnabled=a.purgeEnabled;c("gkx")("3547")?c("promiseDone")(d("MAWSharedCOP").getCOP().awaitBackground(d("MAWSharedCOPLoop").makeCopGUID(e),function(){f.$1.forceRunNow();return(h||(h=b("Promise"))).resolve()})):this.$1.forceRunNow()}var e=a.prototype;e.update=function(a){var b=o(this.cleanerType);d("WATagsLogger").TAGS([b,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerUpdate]).LOG(k(),b,a);this.$1.onOrBefore(d("WATimeUtils").cappedMillisecondsUntil(a))};e.$2=function(){var a=this;if(!this.purgeEnabled())return(h||(h=b("Promise"))).resolve();var c=o(this.cleanerType);d("WATagsLogger").TAGS([c,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerPurge]).LOG(j(),c);return this.removeExpired().then(function(b){b>0&&d("WATagsLogger").TAGS([c,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerPurge]).LOG(i(),c,b);return a.getNextTs()}).then(function(b){b!=null&&a.update(b)})};return a}();function o(a){switch(a){case"Unsend":return"UnsendMsgCleaner";case"Ephemeral":return"EphemeralCleaner";case"DeleteForMe":return"DeleteForMeCleaner";case"PendingStanza":return"PendingStanzaCleaner";case"Xma":return"XmaCleaner";case"IGDDM":return"IGDDisappearingMsgCleaner";default:return c("WAAssertUnreachable")(a)}}n=e;g.CLEANER_TYPE=f;g.MsgCleaner=e;g.MSG_CLEANER_FOR_TESTING_ONLY=n}),98);
__d("MAWDeleteForMeMsgContentCleaner",["MAWMsgCleaner","WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["DeleteForMeMsgContentCleaner: Adding timestamps (",")"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["startDeleteForMeMsgContentCleaner invoked"]);j=function(){return a};return a}var k=null;function a(a){d("WALogger").LOG(j()),k==null&&(k=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.DELETE_FOR_ME))}function b(a){if(k==null){var b="Trying to add new DeleteForMeContentCleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(i(),b);throw c("err")(b)}else d("WALogger").DEV(h(),a),k.update(a)}function e(){return k}function f(){k=null}g.startDeleteForMeMsgContentCleaner=a;g.addNewDeleteForMeMsgContentCleanerTimestamp=b;g.getDeleteForMeMsgContentCleaner_FOR_TESTING_ONLY=e;g.resetDeleteForMeMsgContentCleaner_FOR_TESTING_ONLY=f}),98);
__d("isWAFTSContentSearchEnabled",["isE2EEConversationSearchEnabled","isE2EEUniversalSearchEnabled"],(function(a,b,c,d,e,f,g){"use strict";function a(){return c("isE2EEConversationSearchEnabled")()||c("isE2EEUniversalSearchEnabled")()}g["default"]=a}),98);
__d("MAWFTSTxns",["MAWDexieTable","isWAFTSContentSearchEnabled","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h=c("justknobx")._("1146"),i=c("justknobx")._("2154");function a(a,b){return!c("isWAFTSContentSearchEnabled")()?d("MAWDexieTable").dexieResolve(null):a.ftsPurgeBacklog.put({externalId:b})}function b(a,b){return!c("isWAFTSContentSearchEnabled")()||!h?d("MAWDexieTable").dexieResolve(null):a.ftsBackloggedMessages.put({rowId:b})}function e(a,b){return!c("isWAFTSContentSearchEnabled")()||!h||!i?d("MAWDexieTable").dexieResolve(null):a.ftsBackloggedMessages.bulkPut(b.map(function(a){return{rowId:a}}))}function f(a,b){return!c("isWAFTSContentSearchEnabled")()?d("MAWDexieTable").dexieResolve(null):a.ftsPurgeThreadBacklog.put({chatJid:b})}g.maybePutMessageToPurgeBacklog=a;g.maybePutMessageToBacklog=b;g.maybePutMessagesToBacklog=e;g.maybePutThreadToPurgeBacklog=f}),98);
__d("MAWPendingStanzaCleaner",["MAWMsgCleaner","WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["PendingStanzaCleaner: Adding timestamps (",")"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);i=function(){return a};return a}var j=null;function a(a){j==null&&(j=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.PENDING_STANZA))}function b(a){if(j==null){var b="Trying to add new PendingStanzaCleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(i(),b);throw c("err")(b)}else d("WALogger").DEV(h(),a),j.update(a)}function e(){return j}function f(){j=null}g.startPendingStanzaCleaner=a;g.addNewPendingStanzaCleanerTimestamp=b;g.getPendingStanzaCleaner_FOR_TESTING_ONLY=e;g.resetPendingStanzaCleaner_FOR_TESTING_ONLY=f}),98);
__d("MAWUpdateQuotedMsgTxns",["MAWAuthor","MAWBridgeMsg","MAWDexieTable","MAWIndexedDb","MAWMsgType"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a,b,c,e,f,g,h){var i=d("MAWAuthor").getAuthorUserJid(e);return a.messages.where("quoteExternalId").equals(c).toArray().then(function(c){if(c.length===0)return;var e=c;(h==null||!h)&&(e=c.filter(function(a){var c=a.quote;a=a.threadJid;return d("MAWAuthor").getAuthorUserJid(c==null?void 0:c.content.author)===i&&a===b}));var j=e.map(function(a){var b;b=Object.assign({},(b=a.quote)==null?void 0:b.content,f.content);b=babelHelpers["extends"]({},a.quote,f,{content:b});b.content.msgId==null&&g!=null&&(b.content.msgId=g);return babelHelpers["extends"]({},a,{quote:b})});return a.messages.bulkPut(j).then(function(){return j})})},i=function(a,b,c,e,f){f===void 0&&(f=d("MAWMsgType").MSG_TYPE.UNAVAILABLE);f={content:{mediaId:void 0,msgContent:void 0,type:f}};return h(a,b,c,e,f).then(function(a){if(a==null)return;a.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a)})})})};a=function(a,b,c){c===void 0&&(c=d("MAWMsgType").MSG_TYPE.UNAVAILABLE);var e=b.author,f=b.chat,g=b.externalId;return a.threads.get({jid:f}).then(function(b){if(b==null)return;return i(a,b.jid,g,e,c)})};b=function(a,b,c,e){var f=c.author,g=c.externalId,i=c.mediaId,j=c.msgContent,k=c.msgId,l=c.plaintextHash,m=c.ts;c=c.type;if(!d("MAWMsgType").isQuotedMsgType(c))return d("MAWDexieTable").dexieResolve();i={author:f,externalId:g,mediaId:i,msgContent:j,plaintextHash:l,ts:m,type:c};return h(a,b,g,f,{content:i},k,e)};g.disassociateQuotedMsg=i;g.disassociateQuotedMessageByProtocolMsgId=a;g.associateQuotedMessage=b}),98);
__d("MAWWriteDeleteMessageTxns",["EBUploadMessages","MAWAckLevel","MAWBridgeTypesCreators","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanza","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDbXMATxns","MAWDeleteForMeMsgContentCleaner","MAWDexieTable","MAWFTSTxns","MAWIndexedDb","MAWMsgType","MAWPendingStanzaCleaner","MAWThreadSnippetBuildTxns","MAWUpdateQuotedMsgTxns","MAWXMAUtils","WAResultOrError","WATimeUtils","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h=6*d("WATimeUtils").HOUR_SECONDS,i=30*d("WATimeUtils").DAY_SECONDS;function a(a,b){var c=b.protocolMsgId,e=c.author;b=c.chat;var f=c.externalId;return d("MAWDexieTable").dexieAll([d("MAWDbThreadTxns").getThread(a,b),a.unrenderedMessages.get({externalId:f}),d("MAWFTSTxns").maybePutMessageToPurgeBacklog(a,f)]).then(function(b){var g=b[0];b=b[1];if(!g.success)return d("WAResultOrError").makeError("missing_thread");return b!=null&&b.threadJid===g.value.jid&&b.author===e?d("WAResultOrError").makeError("duplicate_delete_for_me"):d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,c).then(function(b){if(b==null){var h={ack:d("MAWAckLevel").ACK.received,author:e,externalId:f,threadJid:g.value.jid,type:d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME},k=d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+i);h={deleteTs:k,externalIdWithType:f+"_"+d("MAWDbPendingStanza").PENDING_DELETE_FOR_ME,pendingContent:{content:h,type:d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME}};return a.pendingStanzas.add(h).then(function(){d("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(k);return d("WAResultOrError").makeResult()})}return d("MAWDexieTable").dexieResolve(j(a,b,e,c.chat,g.value)).then(function(){return d("WAResultOrError").makeResult()})})})}function j(a,b,e,f,g){var i,j=d("MAWDexieTable").dexieResolve();d("MAWXMAUtils").isXMAStoryReply((i=b.quote)==null?void 0:i.content.xmaMessageType)&&(j=k(a,b));var l={ack:b.ack,author:e,externalId:b.externalId,mediaId:b.mediaId,messageDeleteForMeTs:d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+h),msgContent:(i=d("MAWDbMsg").getMsgContent(b))==null?void 0:i.content,msgId:b.msgId,quote:b.quote,reportingMeta:b.reportingMeta,serverTs:c("justknobx")._("1753")?void 0:b.serverTs,threadJid:f,ts:b.ts,type:d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME,xmaMessageType:b.xmaMessageType};i=d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").deleteDbMsg(a,b.rowId),j]).then(function(){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.threadJid,[b])});c("gkx")("23914")&&c("justknobx")._("1071")&&d("EBUploadMessages").sendDeleteEchoMessage(b,g.jid);if(d("MAWDbMsg").isMediaMsg(b)){var e=b.mediaId,f=b.plaintextHash;e!=null&&(c("gkx")("2419")&&f!=null?d("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:e,msgId:b.msgId,plaintextHash:f,threadJid:b.threadJid}}):d("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:e,msgId:b.msgId,threadJid:b.threadJid}}))}return d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,g)});return d("MAWDexieTable").dexieAll([i,a.unrenderedMessages.add(l),d("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(a,[{author:e,chatJid:b.threadJid,externalId:b.externalId}]),d("MAWUpdateQuotedMsgTxns").disassociateQuotedMsg(a,b.threadJid,b.externalId,b.author,d("MAWMsgType").MSG_TYPE.REVOKED)]).then(function(){return d("MAWDbMsgTxns").maybeUpdateThreadMsgsForDeleteForMe(a,g.jid,b.msgId,b.sortOrderMs).then(function(){d("MAWDeleteForMeMsgContentCleaner").addNewDeleteForMeMsgContentCleanerTimestamp(l.messageDeleteForMeTs);return d("WAResultOrError").makeResult()})})}function k(a,b){return d("MAWDbXMATxns").maybeGetXMAFromAssociatedMsgId(a,b.msgId).then(function(b){return d("MAWDbMsgTxns").maybeGetMsg(a,b==null?void 0:b.msgId).then(function(b){if(b!=null)return d("MAWDbMsgTxns").deleteDbMsg(a,b.rowId)})})}g.REVOKE_CONTENT_EXPIRATION_IN_SEC=h;g.handleDeleteForMe=a;g.deleteXMAStoryReplyMsg=k}),98);
__d("MAWBuildIncomingMsgs",["MAWAckLevel","MAWDbMsg","MAWMsgType","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=6*d("WATimeUtils").HOUR_SECONDS;function a(a,b){var c=a.author;a=a.externalId;return{ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:c,externalId:a,serverTs:b,ts:b,type:d("MAWMsgType").MSG_TYPE.CIPHERTEXT}}function b(a,b){var c=a.author;a=a.externalId;return{ack:d("MAWAckLevel").ACK.failed,altIndex:void 0,author:c,externalId:a,serverTs:b,ts:b,type:d("MAWMsgType").MSG_TYPE.UNAVAILABLE}}function c(a,b){var c;return{ack:a.ack,author:a.author,externalId:a.externalId,messageDeleteForMeTs:d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+h),msgContent:(c=d("MAWDbMsg").getMsgContent(a))==null?void 0:c.content,threadJid:b.jid,ts:a.ts,type:d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME}}function e(a,b,c){return{ack:a.ack,altIndex:void 0,author:a.author,externalId:c.externalId,msgContent:d("MAWDbMsg").getMsgContent(a),originalTs:a.ts,revokedExternalId:c.revokedExternalId,threadJid:b.jid,ts:c.ts,type:d("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+h)}}g.REVOKE_CONTENT_EXPIRATION_IN_SEC=h;g.buildUnstoredCiphertextMsg=a;g.buildUnstoredUnavailableMsg=b;g.buildUnstoredDeleteForMeMsg=c;g.buildUnstoredRevokedMsg=e}),98);
__d("MAWDbEditMsgHistory",["I64"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return a}function b(a){return(h||(h=d("I64"))).of_float(a)}function c(a){return(h||(h=d("I64"))).to_float(a)}g.unsafeCoerceToEditMsgHistoryId=a;g.convertToEditMsgHistoryId64=b;g.convertToEditMsgHistoryId=c}),98);
__d("MAWDbEditMsgHistoryTxns",["MAWAckLevel","MAWDbEditMsgHistory","MAWDexieTable","MAWIndexedDb","MAWVault","WALogger","WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[getEditHistoryMsgByEditedProtocolMsgId] Suspected multiple instances of same message!"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[getEditHistoryMsgByEditedProtocolMsgId] Can't have "," messages with the same editExternalId!"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["No msgId found mapped with externalId: Edit messages with the externalId do not have associated Msg in the IDB."]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n          'No edit history found for the messages despite there being an editCount greater than 0"]);k=function(){return a};return a}function a(a,b){var c=[];if(b.length===0)return d("MAWDexieTable").dexieResolve(c);b=b.filter(function(a){return a.editCount!=null&&a.editCount>0});var e=b.map(function(a){return[a.externalId,a.threadJid]});if(e.length===0)return d("MAWDexieTable").dexieResolve([]);var f=b.reduce(function(a,b){b.msgId!=null&&a.set(b.externalId,b.msgId);return a},new Map());return l(a,e).then(function(a){if(a.length===0){d("WATagsLogger").TAGS(["MAWLoadMsgsTxns"]).ERROR(k());return[]}for(var b=0;b<a.length;b++){var e=a[b],g=f.get(e.originalMsgExternalId);g!=null?c.push(babelHelpers["extends"]({},e,{editMsgHistoryId:d("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(e.editMsgHistoryId),originalMsgId:g})):d("WATagsLogger").TAGS(["MAWLoadMsgsTxns"]).ERROR(j())}d("MAWIndexedDb").afterTransaction({tag:"EditMsgHistoryAdded",value:c});return c})}function l(a,b){return a.editMsgHistory.where(["originalMsgExternalId","threadJid"]).anyOf(b).toArray()}function b(a,b){return b==null?d("MAWDexieTable").dexieResolve():a.editMsgHistory.get({editMsgHistoryId:b})}function c(a,b,c){return a.editMsgHistory.where("originalMsgExternalId").equals(c).filter(function(a){return a.editExternalId===b.externalId&&a.author===b.author&&a.threadJid===b.chat}).toArray().then(function(a){if(a.length>1){var b=a.map(function(a){return""+a.editTs.toString()});b=new Set(b).size===1;!b?d("WALogger").ERROR(i(),a.length):d("WALogger").ERROR(h())}return a[0]})}function e(a,b){return b==null?d("MAWDexieTable").dexieResolve([]):a.editMsgHistory.where("originalMsgExternalId").equals(b.externalId).filter(function(a){return a.author===b.author&&a.threadJid===b.chat}).toArray().then(function(a){var b=[];a.forEach(function(a){if(a==null)return;b.push(a)});return b})}function f(a,b){return a.editMsgHistory.bulkGet(b)}function m(a,b,c){var e=b.map(function(a,b){return babelHelpers["extends"]({},a,{editMsgHistoryId:d("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(c[b])})});return a.messages.where("externalId").anyOf(e.map(function(a){return a.originalMsgExternalId})).toArray().then(function(a){var b=new Map();a.forEach(function(a){a!=null&&b.set(a.externalId,a)});return e.map(function(a){var c=b.get(a.originalMsgExternalId);return c==null?null:babelHelpers["extends"]({},a,{originalMsgId:c.msgId})}).filter(Boolean)}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"EditMsgHistoryAdded",value:a});return c})}function n(a,b,c){c===void 0&&(c=!0);return a.editMsgHistory.bulkAdd(b,{allKeys:!0}).then(function(e){return c?m(a,b,e):d("MAWDexieTable").dexieResolve(e)})}function o(a,b,c,d){return d.then(function(d){return p(a,b,c,d)})}function p(a,b,c,e){var f=[];return a.editMsgHistory.where("originalMsgExternalId").equals(b).filter(function(a){return a.threadJid===e&&a.author===c&&(a.sendStatus==null||a.sendStatus>=d("MAWAckLevel").ACK.sent)}).toArray().then(function(a){a.forEach(function(a){f.push({messageId:a.editExternalId,originalMessageId:a.originalMsgExternalId,text:d("MAWVault").unvault(a.msgContent.content),timestamp:a.editTs})});return f})}function q(a,b,c,d){return a.editMsgHistory.where("originalMsgExternalId").equals(b).filter(function(a){return a.threadJid===d&&a.author===c})["delete"]().then(function(){})}var r=function(a,b){return a.editMsgHistory.where(["originalMsgExternalId","threadJid"]).anyOf(b)["delete"]().then(function(){return d("MAWDexieTable").dexieResolve(b.length)})};function s(a,b,c){return a.editMsgHistory.put(babelHelpers["extends"]({},b,{msgContent:c.msgContent})).then(function(b){return a.editMsgHistory.get({editMsgHistoryId:b})})}g.loadEditMsgHistory=a;g.getEditHistoryByOriginalMsgExternalIdAndThreadJid=l;g.maybeGetEditMsgHistoryFromEditMsgHistoryId=b;g.getEditHistoryMsgByEditedProtocolMsgId=c;g.maybeGetEditMsgHistoryFromProtocolMsgId=e;g.bulkGetEditMsgHistorys=f;g.bulkAddEditMsgHistory=n;g.getEditHistoryAsEchoWithJidPromise=o;g.getEditHistoryAsEcho=p;g.bulkRemoveEditHistory=q;g.deleteExpiredEditMsgHistory=r;g.updateEditMsgHistoryWithNewIncomingMsg=s}),98);
__d("MAWDeleteThreadUtil",[],(function(a,b,c,d,e,f){"use strict";function a(a){var b=[];a.forEach(function(a){if(a.pendingContent.type==="DeleteThread"){a=a.pendingContent.content.metaSyncMessageRange.lastMessageTimestamp;a!=null&&b.push(a)}});if(b.length===0)return null;b.sort(function(a,b){return b-a});a=b[0];return{lastMessageTimestamp:a}}function b(a,b){return b!=null&&b.lastMessageTimestamp>=a}f.getLatestDeleteThreadInfo=a;f.isMsgDeletedViaDeleteThread=b}),66);
__d("MAWDbPendingStanzaTxns",["MAWDbPendingStanza","MAWDeleteThreadUtil","MAWPendingStanzaCleaner","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,c,e,f){var g=d("MAWDbPendingStanza").getPendingSuffix(f);return a.pendingStanzas.where("externalIdWithType").equals(b+"_"+g).filter(function(a){a=a.pendingContent;return a.type===f&&a.content.author===c&&a.content.threadJid===e}).first()}function a(a,b,c,e){return h(a,b,c,e,d("MAWDbPendingStanza").PENDING_TYPE.REVOKED)}function b(a,b,c,e){return h(a,b,c,e,d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME)}function c(a,b){var c=b.map(function(a){a=a.expirationInSeconds;return d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+a)});b=b.map(function(a,b){var e=a.content,f=a.externalId;a=a.pendingStanzaType;return{deleteTs:c[b],externalIdWithType:f+"_"+d("MAWDbPendingStanza").getPendingSuffix(a),pendingContent:e}});return a.pendingStanzas.bulkAdd(b).then(function(){return c.forEach(d("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp)}).then(function(){})}function e(a,b,c,e,f){f=d("MAWDbPendingStanza").getPendingSuffix(f);var g=d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+c);c={deleteTs:g,externalIdWithType:e+"_"+f,pendingContent:b};return a.pendingStanzas.add(c).then(function(){d("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(g)})}function f(a,b){var c=d("MAWDbPendingStanza").getPendingSuffix(d("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD);return a.pendingStanzas.where("externalIdWithType").equals(b+"_"+c).toArray().then(function(a){return d("MAWDeleteThreadUtil").getLatestDeleteThreadInfo(a)})}function i(a){return a.pendingStanzas.toArray()}function j(a,b){b=b.map(function(a){return a.rowId});return a.pendingStanzas.bulkDelete(b)}function k(a){var b;return(a==null?void 0:(b=a.pendingContent)==null?void 0:b.type)===d("MAWDbPendingStanza").PENDING_TYPE.REVOKED?a==null?void 0:(b=a.pendingContent)==null?void 0:b.content:null}function l(a,b){var c=d("MAWDbPendingStanza").getPendingSuffix(d("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD);b=b.map(function(a){return a+"_"+c});return a.pendingStanzas.where("externalIdWithType").anyOf(b).toArray().then(function(a){a=a.reduce(function(a,b){var c=a.get(b.externalIdWithType);c==null?a.set(b.externalIdWithType,[b]):c.push(b);return a},new Map());var b=new Map();a.forEach(function(a,c){c=d("WAJids").unsafeCoerceToChatJid(c.split("_")[0]);a=d("MAWDeleteThreadUtil").getLatestDeleteThreadInfo(a);a!=null&&b.set(c,a)});return b})}g.maybeGetPendingStanzaByExternalId=h;g.maybeGetPendingRevokedStanza=a;g.maybeGetPendingDeletedStanza=b;g.bulkPutPendingStanzas=c;g.putPendingStanza=e;g.maybeGetDeleteThreadFromPendingStanza=f;g.getAllPendingStanzas=i;g.deletePendingStanzas=j;g.getRevokedContent=k;g.bulkGetDeleteThreadPendingStanzas=l}),98);
__d("MAWBridgeMsgCountdown",["MAWDbMsg","MAWLoggerUtils","WATagsLogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["createBridgeMsgsStartCountdown: msg ",", expiration ",", ms until countdown ",", duration ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Calling the messages starting countdown bridge event with remaning time less or equal to 0 (expired message)"]);i=function(){return a};return a}var j=d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.Countdown]);function a(a){return{msgs:a.map(function(a){var b,c=a.messageExpirationTs;b=(b=a.ephemeralSetting)==null?void 0:b.ephemeralExpirationInSec;if(c==null||b==null)return;var e=d("WATimeUtils").cappedMillisecondsUntil(c);if(e<=0){j.LOG(i());return}var f=b*1e3;e>f&&(e=f);j.LOG(h(),a.msgId,c,e,b);return{countdownTs:c,millisecondsUntilCountdownTs:e,msgId:a.msgId,threadJid:a.threadJid,ts:d("MAWDbMsg").getCanonicalTsFromMsg(a)}}).filter(Boolean)}}function b(a,b){return{countdownTs:b,msgId:a}}g.createBridgeMsgsStartCountdown=a;g.createBridgeMsgClearCountdown=b}),98);
__d("MAWEphemeralCleaner",["MAWLoggerUtils","MAWMsgCleaner","WATagsLogger","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCleaner: Adding timestamps for UI(",") and backend(",")"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["startEphemeralCleaner invoked"]);j=function(){return a};return a}var k=null;function a(a){var b=a.backendFns;a=a.uiFns;d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerStart]).LOG(j());if(k==null){var c;k={backend:new((c=d("MAWMsgCleaner")).MsgCleaner)(b,c.CLEANER_TYPE.EPHEMERAL),ui:new c.MsgCleaner(a,c.CLEANER_TYPE.EPHEMERAL)}}}function b(a,b){if(k==null){var e="Trying to add new ephemeral timestamp before the cleaner is initialized!";d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerTimestamp]).ERROR(i(),e);throw c("err")(e)}else{e=k;var f=e.backend;e=e.ui;d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerTimestamp]).DEV(h(),a,b);e.update(a);f.update(b)}}function e(){return k}function f(){k=null}g.startEphemeralCleaner=a;g.addNewEphemeralTimestamp=b;g.getEphemeralCleaner_FOR_TESTING_ONLY=e;g.resetEphemeralCleaner_FOR_TESTING_ONLY=f}),98);
__d("MAWEphemeralSettingsCache",["MAWBridge","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h=new Map();function i(a,b){h.set(a,b)}function a(a){var b={ephemeralExpirationInSec:0,ephemeralLastUpdatedOrSetTimestamp:d("WATimeUtils").castToUnixTime(0)};return(a=h.get(a))!=null?a:b}function c(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b={ephemeralExpirationInSec:0,ephemeralLastUpdatedOrSetTimestamp:d("WATimeUtils").castToUnixTime(0)};if(!h.has(a)){var c=(yield d("MAWBridge").getBridge().sendAndReceive("event","getLSDBEphemeralSetting",{chatJid:a}));i(a,(a=c)!=null?a:b)}});return j.apply(this,arguments)}g.setEphemeralSettingCache=i;g.getEphemeralSettingCache=a;g.requestLSDBCacheForJid=c}),98);
__d("WAArmadilloApplication.pb",["WAArmadilloXMA.pb","WACommon.pb","WAProtoConst"],(function(a,b,c,d,e,f,g){var h,i;a={ES_OPEN:1,ES_CLOSE:2};b={PAYMENT_UNKNOWN:-1,REQUEST_INITED:4,REQUEST_DECLINED:5,REQUEST_TRANSFER_INITED:6,REQUEST_TRANSFER_COMPLETED:7,REQUEST_TRANSFER_FAILED:8,REQUEST_CANCELED:9,REQUEST_EXPIRED:10,TRANSFER_INITED:11,TRANSFER_PENDING:12,TRANSFER_PENDING_RECIPIENT_VERIFICATION:13,TRANSFER_CANCELED:14,TRANSFER_COMPLETED:15,TRANSFER_NO_RECEIVER_CREDENTIAL_NO_RTS_PENDING_CANCELED:16,TRANSFER_NO_RECEIVER_CREDENTIAL_NO_RTS_PENDING_OTHER:17,TRANSFER_REFUNDED:18,TRANSFER_PARTIAL_REFUND:19,TRANSFER_CHARGED_BACK:20,TRANSFER_EXPIRED:21,TRANSFER_DECLINED:22,TRANSFER_UNAVAILABLE:23};c={SCREENSHOT_IMAGE:1,SCREEN_RECORDING:2};e={PLAYED:0,SCREENSHOT:1,FORCE_DISABLE:2};f={VIEW_ONCE:0,ALLOW_REPLAY:1,KEEP_IN_CHAT:2};var j={SMALL_LIKE:1,MEDIUM_LIKE:2,LARGE_LIKE:3},k={},l={},m={},n={},o={},p={},q={},r={},s={},t={},u={},v={},w={},x={},y={},z={},A={},B={},C={},D={},E={},F={},G={},H={},I={},J={},K={},L={},M={};k.internalSpec={payload:[1,(h=d("WAProtoConst")).TYPES.MESSAGE,m],metadata:[2,h.TYPES.MESSAGE,l]};l.internalSpec={};m.internalSpec={content:[1,h.TYPES.MESSAGE,D],applicationData:[2,h.TYPES.MESSAGE,r],signal:[3,h.TYPES.MESSAGE,o],subProtocol:[4,h.TYPES.MESSAGE,n],__oneofs__:{payload:["content","applicationData","signal","subProtocol"]}};n.internalSpec={futureProof:[1,h.TYPES.ENUM,(i=d("WACommon.pb")).FUTURE_PROOF_BEHAVIOR]};o.internalSpec={encryptedBackupsSecrets:[1,h.TYPES.MESSAGE,p],__oneofs__:{signal:["encryptedBackupsSecrets"]}};p.internalSpec={backupId:[1,h.TYPES.UINT64],serverDataId:[2,h.TYPES.UINT64],epoch:[3,h.FLAGS.REPEATED|h.TYPES.MESSAGE,q],tempOcmfClientState:[4,h.TYPES.BYTES],mailboxRootKey:[5,h.TYPES.BYTES],obliviousValidationToken:[6,h.TYPES.BYTES]};q.internalSpec={id:[1,h.TYPES.UINT64],anonId:[2,h.TYPES.BYTES],rootKey:[3,h.TYPES.BYTES],status:[4,h.TYPES.ENUM,a]};r.internalSpec={metadataSync:[1,h.TYPES.MESSAGE,C],aiBotResponse:[2,h.TYPES.MESSAGE,s],__oneofs__:{applicationData:["metadataSync","aiBotResponse"]}};s.internalSpec={summonToken:[1,h.TYPES.STRING],messageText:[2,h.TYPES.STRING],serializedExtras:[3,h.TYPES.STRING]};t.internalSpec={actionTimestamp:[1,h.TYPES.INT64],chatAction:[101,h.TYPES.MESSAGE,w],messageAction:[102,h.TYPES.MESSAGE,u],__oneofs__:{actionType:["chatAction","messageAction"]}};u.internalSpec={key:[1,h.TYPES.MESSAGE,i.MessageKeySpec],messageDelete:[101,h.TYPES.MESSAGE,v],__oneofs__:{action:["messageDelete"]}};v.internalSpec={};w.internalSpec={chatId:[1,h.TYPES.STRING],chatArchive:[101,h.TYPES.MESSAGE,z],chatDelete:[102,h.TYPES.MESSAGE,y],chatRead:[103,h.TYPES.MESSAGE,x],__oneofs__:{action:["chatArchive","chatDelete","chatRead"]}};x.internalSpec={messageRange:[1,h.TYPES.MESSAGE,B],read:[2,h.TYPES.BOOL]};y.internalSpec={messageRange:[1,h.TYPES.MESSAGE,B]};z.internalSpec={messageRange:[1,h.TYPES.MESSAGE,B],archived:[2,h.TYPES.BOOL]};A.internalSpec={key:[1,h.TYPES.MESSAGE,i.MessageKeySpec],timestamp:[2,h.TYPES.INT64]};B.internalSpec={lastMessageTimestamp:[1,h.TYPES.INT64],lastSystemMessageTimestamp:[2,h.TYPES.INT64],messages:[3,h.FLAGS.REPEATED|h.TYPES.MESSAGE,A]};C.internalSpec={actions:[2,h.FLAGS.REPEATED|h.TYPES.MESSAGE,t]};D.internalSpec={commonSticker:[1,h.TYPES.MESSAGE,M],screenshotAction:[3,h.TYPES.MESSAGE,I],extendedContentMessage:[4,h.TYPES.MESSAGE,d("WAArmadilloXMA.pb").ExtendedContentMessageSpec],ravenMessage:[5,h.TYPES.MESSAGE,L],ravenActionNotifMessage:[6,h.TYPES.MESSAGE,K],extendedMessageContentWithSear:[7,h.TYPES.MESSAGE,J],imageGalleryMessage:[8,h.TYPES.MESSAGE,H],paymentsTransactionMessage:[10,h.TYPES.MESSAGE,E],bumpExistingMessage:[11,h.TYPES.MESSAGE,G],noteReplyMessage:[13,h.TYPES.MESSAGE,F],ravenMessageMsgr:[14,h.TYPES.MESSAGE,L],__oneofs__:{content:["commonSticker","screenshotAction","extendedContentMessage","ravenMessage","ravenActionNotifMessage","extendedMessageContentWithSear","imageGalleryMessage","paymentsTransactionMessage","bumpExistingMessage","noteReplyMessage","ravenMessageMsgr"]}};E.internalSpec={transactionId:[1,h.TYPES.UINT64],amount:[2,h.TYPES.STRING],currency:[3,h.TYPES.STRING],paymentStatus:[4,h.TYPES.ENUM,b],extendedContentMessage:[5,h.TYPES.MESSAGE,d("WAArmadilloXMA.pb").ExtendedContentMessageSpec]};F.internalSpec={noteId:[1,h.TYPES.STRING],noteText:[2,h.TYPES.MESSAGE,i.MessageTextSpec],noteTimestampMs:[3,h.TYPES.INT64],textContent:[4,h.TYPES.MESSAGE,i.MessageTextSpec],stickerContent:[5,h.TYPES.MESSAGE,i.SubProtocolSpec],videoContent:[6,h.TYPES.MESSAGE,i.SubProtocolSpec],__oneofs__:{noteReplyContent:["textContent","stickerContent","videoContent"]}};G.internalSpec={key:[1,h.TYPES.MESSAGE,i.MessageKeySpec]};H.internalSpec={images:[1,h.FLAGS.REPEATED|h.TYPES.MESSAGE,i.SubProtocolSpec]};I.internalSpec={screenshotType:[1,h.TYPES.ENUM,c]};J.internalSpec={searId:[1,h.TYPES.STRING],payload:[2,h.TYPES.BYTES],nativeUrl:[3,h.TYPES.STRING],searAssociatedMessage:[4,h.TYPES.MESSAGE,i.SubProtocolSpec],searSentWithMessageId:[5,h.TYPES.STRING]};K.internalSpec={key:[1,h.TYPES.MESSAGE,i.MessageKeySpec],actionTimestamp:[2,h.TYPES.INT64],actionType:[3,h.TYPES.ENUM,e]};L.internalSpec={ephemeralType:[1,h.TYPES.ENUM,f],imageMessage:[2,h.TYPES.MESSAGE,i.SubProtocolSpec],videoMessage:[3,h.TYPES.MESSAGE,i.SubProtocolSpec],__oneofs__:{mediaContent:["imageMessage","videoMessage"]}};M.internalSpec={stickerType:[1,h.TYPES.ENUM,j]};g.ARMADILLO_SIGNAL_ENCRYPTED_BACKUPS_SECRETS_EPOCH_EPOCH_STATUS=a;g.ARMADILLO_CONTENT_PAYMENTS_TRANSACTION_MESSAGE_PAYMENT_STATUS=b;g.ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE=c;g.ARMADILLO_CONTENT_RAVEN_ACTION_NOTIF_MESSAGE_ACTION_TYPE=e;g.ARMADILLO_CONTENT_RAVEN_MESSAGE_EPHEMERAL_TYPE=f;g.ARMADILLO_CONTENT_COMMON_STICKER_STICKER_TYPE=j;g.ArmadilloSpec=k;g.Armadillo$MetadataSpec=l;g.Armadillo$PayloadSpec=m;g.Armadillo$SubProtocolPayloadSpec=n;g.Armadillo$SignalSpec=o;g.Armadillo$Signal$EncryptedBackupsSecretsSpec=p;g.Armadillo$Signal$EncryptedBackupsSecrets$EpochSpec=q;g.Armadillo$ApplicationDataSpec=r;g.Armadillo$ApplicationData$AIBotResponseMessageSpec=s;g.Armadillo$ApplicationData$MetadataSyncActionSpec=t;g.Armadillo$ApplicationData$MetadataSyncAction$SyncMessageActionSpec=u;g.Armadillo$ApplicationData$MetadataSyncAction$SyncMessageAction$ActionMessageDeleteSpec=v;g.Armadillo$ApplicationData$MetadataSyncAction$SyncChatActionSpec=w;g.Armadillo$ApplicationData$MetadataSyncAction$SyncChatAction$ActionChatReadSpec=x;g.Armadillo$ApplicationData$MetadataSyncAction$SyncChatAction$ActionChatDeleteSpec=y;g.Armadillo$ApplicationData$MetadataSyncAction$SyncChatAction$ActionChatArchiveSpec=z;g.Armadillo$ApplicationData$MetadataSyncAction$SyncActionMessageSpec=A;g.Armadillo$ApplicationData$MetadataSyncAction$SyncActionMessageRangeSpec=B;g.Armadillo$ApplicationData$MetadataSyncNotificationSpec=C;g.Armadillo$ContentSpec=D;g.Armadillo$Content$PaymentsTransactionMessageSpec=E;g.Armadillo$Content$NoteReplyMessageSpec=F;g.Armadillo$Content$BumpExistingMessageSpec=G;g.Armadillo$Content$ImageGalleryMessageSpec=H;g.Armadillo$Content$ScreenshotActionSpec=I;g.Armadillo$Content$ExtendedContentMessageWithSearSpec=J;g.Armadillo$Content$RavenActionNotifMessageSpec=K;g.Armadillo$Content$RavenMessageSpec=L;g.Armadillo$Content$CommonStickerSpec=M}),98);
__d("MAWEphemeralUtil",["MAWAckLevel","MAWBridgeMsgCountdown","MAWExternalId","MAWIndexedDb","MAWLocalizationType","MAWMsgType","WAArmadilloApplication.pb","WAGlobals","WAJids","WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["The new ephemeral setting timestamp should be greater than the existing timestamp"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["New ephemeral duration should be different from the existing duration"]);i=function(){return a};return a}function a(a,b,c){var e=d("WAGlobals").getMyDeviceJid();e=b.ephemeralExpirationInSec!==a.ephemeralExpirationInSec&&b.ephemeralLastUpdatedOrSetTimestamp===a.ephemeralLastUpdatedOrSetTimestamp&&e<=c;return e||a.ephemeralLastUpdatedOrSetTimestamp>b.ephemeralLastUpdatedOrSetTimestamp}function b(a,b,c){if(a==null)return!0;a=a.ephemeralSetting;if(a!=null&&a.ephemeralExpirationInSec===b){d("WALogger").DEV(i());return!1}if(a!=null&&a.ephemeralLastUpdatedOrSetTimestamp>c){d("WALogger").DEV(h());return!1}return!0}function e(a){a={ack:d("MAWAckLevel").ACK.sent,altIndex:void 0,author:d("WAJids").AUTHOR_SYSTEM,externalId:d("MAWExternalId").generateExternalId(),msgContent:{adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_MINUTES},ts:a,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN};return{unstoredDbMedia:null,unstoredDbMsg:a,unstoredDbReaction:null}}function f(a,b){var e;switch(b){case d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE:e=d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE;break;case d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING:e=d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING;break;default:throw c("err")("Received unexpected screenshot action type")}b={ack:d("MAWAckLevel").ACK.sent,altIndex:void 0,author:d("WAJids").AUTHOR_SYSTEM,externalId:d("MAWExternalId").generateExternalId(),msgContent:{adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_TAKE_SCREENSHOT,screenshotActionType:e},ts:a,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION};return{unstoredDbMedia:null,unstoredDbMsg:b,unstoredDbReaction:void 0}}function j(a){return d("WAJids").switchOnMsgrChatJidType(a,{group:function(a){throw c("err")("Received invalid chatJid. We only support ephemeral messaging in 1:1 threads.")},user:function(a){return a}})}function k(a){a!=null&&a.messageExpirationTs!=null&&a.ephemeralCounterStarted===!0&&d("MAWIndexedDb").afterTransaction({tag:"MsgClearCountdown",value:d("MAWBridgeMsgCountdown").createBridgeMsgClearCountdown(a.msgId,a.messageExpirationTs)})}g.isLocalSettingOutdated=a;g.shouldUpdateForOutgoingUserEphemeralSettingChange=b;g.buildUnstoredDbEphemeralSettingMsgWithoutContentPlaceholder=e;g.buildUnstoredDbEphemeralScreenshotActionMsgWithoutContentPlaceholder=f;g.getUserJidForEphemeralSetting=j;g.maybeClearEphemeralMsgCountdown=k}),98);
__d("MAWEphemeralSettingsTxns",["DateConsts","MAWDbThreadTxns","MAWDexieTable","MAWEphemeralSettingsCache","MAWEphemeralUtil","MAWIndexedDb","MAWLoggerUtils","WAGlobals","WAJids","WALogger","WAResultOrError","WATagsLogger","WATimeUtils","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["maybeResetEphemeralSyncResponseBackoffInfo reset for ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["maybeResetEphemeralSyncResponseBackoffInfo no op for ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Contact "," "," and ephemeral setting "," should not be null when receiving the server ack for outgoing ephemeral setting change"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleAndWriteIncomingEphemeralSetting - ephemeral setting in sync"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleAndWriteIncomingEphemeralSetting - Sending Sync Response with duration ",", timestamp ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received invalid chat jid for incoming ephemeral settings"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleAndWriteIncomingEphemeralSetting - Handle Incoming Ephemeral Setting duration: ",", lastUpdated: ",""]);o=function(){return a};return a}var p=d("WATagsLogger").TAGS([(h=d("MAWLoggerUtils")).Tag.Ephemeral,h.Tag.SettingChange,h.Tag.Incoming]),q=d("WATagsLogger").TAGS([h.Tag.Ephemeral,h.Tag.SettingChange,h.Tag.Outgoing]),r=null,s=90*d("DateConsts").SEC_PER_DAY;function a(a,b,e,f,g,h,i,j,k,q){if(f<0||f>s){j=d("WAJids").interpretAndValidateJid(i.jid).toString();throw c("err")("EphemeralSetting duration is invalid "+f+", jidType: "+j)}k={ephemeralExpirationInSec:f,ephemeralLastUpdatedOrSetTimestamp:g};d("WALogger").LOG(o(),f,g);j=d("WAJids").interpretAsUserJid(i.jid);if(j==null){p.ERROR(n());return d("MAWDexieTable").dexieResolve(r)}f=d("WAJids").isAuthorMe(b)?d("WAGlobals").getMyUserJid():b;b=e!=null?d("WAJids").toDeviceJid(f,e.id):null;e=d("MAWEphemeralSettingsCache").getEphemeralSettingCache(i.jid);var t=e==null?void 0:e.ephemeralExpirationInSec,u=e==null?void 0:e.ephemeralLastUpdatedOrSetTimestamp;if(q){if(e!=null&&b!=null&&!d("MAWEphemeralUtil").isLocalSettingOutdated(k,e,b))if(g!==u){d("WALogger").LOG(m(),t,u);return d("MAWDexieTable").dexieResolve({dbMsg:null,outOfSyncEphemeralSetting:{chatJid:i.jid,correctEphemeralExpirationInSec:e.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:e.ephemeralLastUpdatedOrSetTimestamp}})}else{d("WALogger").WARN(l());return d("MAWDexieTable").dexieResolve(r)}d("MAWIndexedDb").afterTransaction({tag:"EphemeralSettingsUpdatedForUI",value:{author:d("WAJids").userIdFromJid(f),chatJid:i.jid,ephemeralSettingArgs:k,isEphemeralSettingReset:h}});return d("MAWDexieTable").dexieResolve(r)}q={ephemeralSetting:k,ephemeralSyncResponseBackoffInfo:void 0,userJid:j};return a.ephemeralSettings.put(q).then(function(){return r})}function b(a,b,e,f,g){var h=e;if(h<0)throw c("err")("Ephemeral duration should be 0 or more");var i=d("MAWEphemeralUtil").getUserJidForEphemeralSetting(b);return d("MAWDbThreadTxns").getThread(a,b).then(function(b){return!b.success?{success:!1}:a.ephemeralSettings.get({userJid:i}).then(function(b){if(!d("MAWEphemeralUtil").shouldUpdateForOutgoingUserEphemeralSettingChange(b,h,f))return{success:!1};b=b==null?{ephemeralSetting:{ephemeralExpirationInSec:h,ephemeralLastUpdatedOrSetTimestamp:f},userJid:i}:babelHelpers["extends"]({},b,{ephemeralSetting:{ephemeralExpirationInSec:h,ephemeralLastUpdatedOrSetTimestamp:f}});return a.ephemeralSettings.put(b).then(function(){return{success:!0}})})})}function e(a,b,e){var f=d("MAWEphemeralUtil").getUserJidForEphemeralSetting(b);return a.ephemeralSettings.get({userJid:f}).then(function(b){if(b==null||b.ephemeralSetting==null){q.ERROR(k(),f,b,b==null?void 0:b.ephemeralSetting);throw c("err")("Contact and ephemeral setting should not be null when receiving the server ack for outgoing ephemeral setting change")}b=babelHelpers["extends"]({},b,{ephemeralSetting:{ephemeralExpirationInSec:b.ephemeralSetting.ephemeralExpirationInSec,ephemeralLastUpdatedOrSetTimestamp:e}});return a.ephemeralSettings.put(b).then(function(){})})}function f(a,b){a=d("WAJids").interpretAsUserJid(b);if(a==null)throw c("err")("Unexpected chatJid input to isEphemeralMessagesEnabledForContact");a=d("MAWEphemeralSettingsCache").getEphemeralSettingCache(b);if(a.ephemeralLastUpdatedOrSetTimestamp===d("WATimeUtils").castToUnixTime(0))return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("no_ephemeral_setting"));return a!=null&&a.ephemeralExpirationInSec>0?d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult({outOfSyncEphemeralSetting:{chatJid:b,correctEphemeralExpirationInSec:a.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:a.ephemeralLastUpdatedOrSetTimestamp}})):d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("no_ephemeral_setting"))}function t(a,b){return a.ephemeralSettings.get({userJid:b}).then(function(c){if((c==null?void 0:c.ephemeralSyncResponseBackoffInfo)==null){p.LOG(j(),b);return d("WAResultOrError").makeResult()}c.ephemeralSyncResponseBackoffInfo=void 0;p.LOG(i(),b);return a.ephemeralSettings.put(c).then(function(){return d("WAResultOrError").makeResult()})})}g.handleAndWriteIncomingEphemeralSetting=a;g.handleAndWriteOutgoingUserEphemeralSettingChange=b;g.updateContactWhenEphemeralSettingChangeMarkedSent=e;g.getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg=f;g.maybeResetEphemeralSyncResponseBackoffInfo=t}),98);
__d("MAWEphemeralMsgTxns",["MAWBridgeMsgCountdown","MAWBridgeTypesCreators","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDbXMATxns","MAWDexieTable","MAWEphemeralCleaner","MAWEphemeralConsts","MAWEphemeralMsgUtils","MAWEphemeralSettingsTxns","MAWIndexedDb","MAWLocalizationType","MAWLoggerUtils","MAWThreadSnippetBuildTxns","MAWThreadSnippetUtils","WAJids","WATagsLogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is not out of sync"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is out of sync: correct duration ",", correct timestamp ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is ephemeral: duration ",", timestamp ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is non-ephemeral"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["maybeUpdateEphemeralSettingOrCheckOutOfSyncAfterWritingIncomingMsg: Message from ",", chat ",", type ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["updating ephemeral timestamp msg ",", existing expiration ",", existing deletion ",", updated expiration ",", updated deletion ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["markEphemeralMessageAsSent EphemeralCounter: Showing UI counter for ",""]);n=function(){return a};return a}var o=d("WATagsLogger").TAGS([(e=d("MAWLoggerUtils")).Tag.Ephemeral,e.Tag.SettingSync,e.Tag.Incoming]),p=d("WATagsLogger").TAGS([e.Tag.Ephemeral,e.Tag.OnRead,e.Tag.Countdown]);function q(a,b,c){c===void 0&&(c=function(){return!0});return d("MAWDbMsgTxns").getThreadMessagesBySortOrder(a,b,!1,!0).filter(c).limit(1).toArray().then(function(a){return{needsUpdate:!0,value:(a=a[0])!=null?a:null}})}function r(a,b,c){return c.size===0?d("MAWDexieTable").dexieResolve():d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success)return;var e=b.value;return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").getThreadOldestMessageId(a,e.jid),d("MAWDbMsgTxns").getThreadNewestMessageId(a,e)]).then(function(b){var f=b[0],g=b[1];if(f==null||g==null)return;b=d("MAWEphemeralMsgUtils").filterNonExpiredMsg(c);var h=c.has(f)?q(a,e.jid,b):d("MAWDexieTable").dexieResolve({needsUpdate:!1});b=c.has(g)?d("MAWDbMsgTxns").getThreadMessagesBySortOrder(a,e.jid,!0,!1).filter(b).reverse().limit(1).toArray().then(function(b){b=b[0];return b!=null&&d("MAWThreadSnippetUtils").isDbMsgDisabledForThreadSnippet(b)?d("MAWThreadSnippetUtils").findMostRecentSnippetMsgFromThread(a,e,c).then(function(a){return{needsUpdate:!0,value:(a=a)!=null?a:null}}):{needsUpdate:!0,value:(b=b)!=null?b:null}}):d("MAWDexieTable").dexieResolve({needsUpdate:!1});return d("MAWDexieTable").dexieAll([h,b]).then(function(b){var c=b[0],h=b[1];if(!c.needsUpdate&&!h.needsUpdate)return;b=h.needsUpdate?(b=(b=h.value)==null?void 0:b.msgId)!=null?b:void 0:g;var i=h.needsUpdate?h.value!=null?d("WATimeUtils").castUnixTimeToMillisTime(d("MAWDbMsg").getCanonicalTsFromMsg(h.value)):void 0:e.snippetMsgTs,j=babelHelpers["extends"]({},e,{newestMsg:b,oldestMsg:c.needsUpdate?(c=(c=c.value)==null?void 0:c.msgId)!=null?c:null:f,snippetMsg:b,snippetMsgTs:i});return a.threads.put(j).then(function(){if(h.needsUpdate){var b=h.value;if(b==null)d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:{contactIDs:[],strings:[]},snippetSenderContactId:"0",snippetType:d("MAWLocalizationType").LOCALIZATION_TYPE.EMPTY_SNIPPET,threadJid:j.jid})});else return d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,b).then(function(a){var b=a.snippetParams,c=a.snippetSenderContactId;a=a.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:b,snippetSenderContactId:c,snippetType:a,threadJid:j.jid})})})}})})})})}function a(a,b){if(b==null||b.ephemeralSetting==null||b.ephemeralSetting.ephemeralExpirationInSec===0)return d("MAWDexieTable").dexieResolve(b);var c=d("WATimeUtils").castToUnixTime(b.ts+b.ephemeralSetting.ephemeralExpirationInSec),e=d("WATimeUtils").castToUnixTime(c+d("MAWEphemeralConsts").ephemeralReportingWindowInSeconds);return s(a,[{messageDeleteTs:e,messageExpirationTs:c,msgId:b.msgId,readTsForLogging:b.ts}]).then(function(a){var b=a[0],c=a[1];a=a[2];a.length>0&&(p.LOG(n(),a.map(function(a){return a.msgId})),d("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:d("MAWBridgeMsgCountdown").createBridgeMsgsStartCountdown(a)}));b!=null&&c!=null&&d("MAWEphemeralCleaner").addNewEphemeralTimestamp(b,c);return a[0]})}function s(a,b){var c=b.map(function(a){return a.msgId});return d("MAWDbXMATxns").getXMAMsgIdsFromAssociatedMsgIds(a,c).then(function(d){var e=new Map();b.forEach(function(a){e.set(a.msgId,{messageDeleteTs:a.messageDeleteTs,messageExpirationTs:a.messageExpirationTs,readTsForLogging:a.readTsForLogging});var b=d.get(a.msgId);b!=null&&e.set(b,{messageDeleteTs:a.messageDeleteTs,messageExpirationTs:a.messageExpirationTs,readTsForLogging:a.readTsForLogging})});var f=null,g=null,h=[],i=Array.from(new Set(c.concat(Array.from(d.values()))));return a.messages.where("msgId").anyOf(i).toArray().then(function(b){if(b.length===0)return;b.forEach(function(a){var b=a.messageExpirationTs,c=a.messageDeleteTs,d=e.get(a.msgId),i=d==null?void 0:d.messageExpirationTs;d=d==null?void 0:d.messageDeleteTs;p.LOG(m(),a.msgId,b,c,i,d);if(i==null||d==null)return;if(a.ephemeralCounterStarted===!0)return;f==null?f=i:i<f&&(f=i);g==null?g=d:d<g&&(g=d);b=babelHelpers["extends"]({},a,{ephemeralCounterStarted:!0,messageDeleteTs:d,messageExpirationTs:i});h.push(b)});return a.messages.bulkPut(h)}).then(function(){return[f,g,h]})})}function b(a,b){if(b.size===0)return d("MAWDexieTable").dexieResolve();var c=[];b.forEach(function(b,d){c.push(r(a,d,b))});return d("MAWDexieTable").dexieAll(c).then(function(){})}function c(a,b,c,e,f,g){if(b==null||f==null)return d("MAWDexieTable").dexieResolve();o.LOG(l(),c,e.jid,b.type);var m=d("MAWDexieTable").dexieResolve();if(b.ephemeralSetting==null)d("WAJids").switchOnMsgrChatJidType(e.jid,{group:function(){return d("MAWEphemeralSettingsTxns").maybeResetEphemeralSyncResponseBackoffInfo(a,c).then(function(){})},user:function(){d("MAWDbMsg").isMsgEligibleForTriggeringEphemeralSyncResponse(b)&&(o.LOG(k()),m=d("MAWEphemeralSettingsTxns").getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg(a,e.jid).then(function(a){return a==null?void 0:(a=a.value)==null?void 0:a.outOfSyncEphemeralSetting}))}});else if(b.messageExpirationTs!=null&&b.messageDeleteTs!=null){var n=b.ephemeralSetting,p=b.messageDeleteTs,q=b.messageExpirationTs;o.LOG(j(),n.ephemeralExpirationInSec,n.ephemeralLastUpdatedOrSetTimestamp);d("MAWEphemeralCleaner").addNewEphemeralTimestamp(q,p);m=d("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(a,c,f,n.ephemeralExpirationInSec,n.ephemeralLastUpdatedOrSetTimestamp,!1,e,g,null,!0).then(function(a){return a==null?void 0:a.outOfSyncEphemeralSetting})}return m.then(function(b){if(b!=null){o.LOG(i(),b.correctEphemeralExpirationInSec,b.correctEphemeralLastUpdatedOrSetTimestamp);return b}else{o.LOG(h());return d("MAWEphemeralSettingsTxns").maybeResetEphemeralSyncResponseBackoffInfo(a,c).then(function(){})}})}g.markEphemeralMessageAsSent=a;g.bulkUpdateEphemeralMessageTimestamps=s;g.updateThreadsOnMessagesExpiredFromUi=b;g.syncEphemeralSettingOnIncomingMsg=c}),98);
__d("MAWGetMsgQuoteTxn",["MAWDbMsgTxns","MAWDexieTable","MAWMsgType","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a){return a==null||a===d("WAJids").AUTHOR_SYSTEM?null:d("WAJids").authorAsUserJid(a)};function i(a,b,c){var e=b.quote;b=(e==null?void 0:e.content)||{};var f=b.author;b=b.externalId;if(f==null)return d("MAWDexieTable").dexieResolve(null);f=d("WAJids").isAuthorMe(f)?d("WAJids").AUTHOR_ME:h(f);if(e==null||f==null||b==null)return d("MAWDexieTable").dexieResolve(null);f={author:f,chat:c,externalId:b};return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,f).then(function(b){if(b==null||!d("MAWMsgType").isQuotedMsgType(b.type))return{quote:e,quoteExternalId:e.content.externalId};var a=b.author,c=b.externalId,f=b.mediaId,g=b.msgContent,h=b.msgId,i=b.plaintextHash,j=b.specialTextSize,k=b.ts,l=b.type,m=b.xmaMessageType;a={author:a,externalId:c,mediaId:f,msgContent:g,msgId:h,plaintextHash:i,specialTextSize:j,ts:k,type:l,xmaMessageType:m};b.messageExpirationTs!=null&&b.messageExpirationTs<d("WATimeUtils").unixTime()&&(a=babelHelpers["extends"]({},a,{mediaId:void 0,msgContent:void 0,type:d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL}));return{quote:babelHelpers["extends"]({},e,{content:a}),quoteExternalId:b.externalId}})}function a(a,b,c){return i(a,b,c).then(function(a){return babelHelpers["extends"]({},b,{quote:a==null?void 0:a.quote,quoteExternalId:a==null?void 0:a.quoteExternalId})})}g.getMsgQuoteInfo=i;g.enhanceMsgWithQuoteInfo=a}),98);
__d("MAWBridgeParticipants",["WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(a){var b=a.deliveredWatermarkTs,c=a.lastReadActionTs,e=a.lastReadWatermarkTs,f=a.threadJid,g=a.type;a=a.userJid;return{deliveredWatermarkTs:b||d("WATimeUtils").castToUnixTime(0),fbid:d("WAJids").extractUserId(a),isAdmin:g==="superadmin"||g==="admin",isInvited:g==="invitedParticipant",isSuperAdmin:g==="superadmin",lastReadActionTs:(b=c)!=null?b:d("WATimeUtils").castToUnixTime(0),readWatermarkTs:e||d("WATimeUtils").castToUnixTime(0),threadJid:f}}function a(a){return{participants:a.map(function(a){return h(a)})}}g.createBridgeParticipant=h;g.createBridgeParticipants=a}),98);
__d("MAWDbParticipantTxns",["FBLogger","MAWBridgeParticipants","MAWBridgeTypesCreators","MAWCurrentUser","MAWDbParticipant","MAWDexieTable","MAWIndexedDb","MAWODSProxy","WAGlobals","WAJids","WAOdsEnums","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,d,e){d===void 0&&(d="participant");return h(a,b,[{addressable:e,type:d,userJid:c}]).then(function(a){return a[0]})}function h(a,b,c){return j(a,c.map(function(a){return babelHelpers["extends"]({},a,{threadJid:b})}))}function i(a,b){d("WAJids").switchOnMsgrChatJidType(a.threadJid,{group:function(){},user:function(e){a.userJid!==e&&a.userJid!==d("WAGlobals").getMyUserJid()&&c("FBLogger")("messenger_e2ee_web").mustfix("Attempting to insert participant to a mismatched one-on-one thread at %s",b)}})}function j(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve([]);var c=[];b.forEach(function(a){var b=a.addressable,e=a.threadJid,f=a.type;a=a.userJid;c.push({addressable:b,deliveredWatermarkTs:d("WATimeUtils").castToUnixTime(0),id:d("MAWDbParticipant").craftParticipantId(e,a),lastReadWatermarkTs:d("WATimeUtils").castToUnixTime(0),threadJid:e,type:f,userJid:a})});c.forEach(function(a){return i(a,"bulkAddParticipantsInThreads")});return a.participants.bulkPut(c).then(function(){d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(c)});return c})}function b(a,b,c){return p(a,b).then(function(e){var f=[],g=new Set(c.map(function(a){return a.userJid}));for(var i=e,j=Array.isArray(i),k=0,i=j?i:i[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var m;if(j){if(k>=i.length)break;m=i[k++]}else{k=i.next();if(k.done)break;m=k.value}m=m;var n=g.has(m.userJid);n||f.push([m.threadJid,m.userJid])}n=[];m=new Set(e.map(function(a){return a.userJid}));for(k=0;k<c.length;k++){j=c[k];i=m.has(j.userJid);i||n.push(j)}f.length>0&&d("MAWODSProxy").odsBumpEntityKey({amount:1,entity:d("WAOdsEnums").Entity.MAW_ONE_TO_ONE_THREAD_PARTICIPANT_CLEANUP,key:d("MAWCurrentUser").isEmployee()?"employee":"public"});return d("MAWDexieTable").dexieAll([h(a,b,n),l(a,f)]).then(function(a){var b=a[0];a[1];a=c.reduce(function(a,c){var d=b.find(function(a){return a.userJid===c.userJid}),f=e.find(function(a){return a.userJid===c.userJid});d!=null&&f==null?a.push(d):f!=null&&a.push(f);return a},[]);return a})})}function e(a,b){b.forEach(function(a){return i(a,"bulkUpdateParticipants")});return a.participants.bulkPut(b).then(function(){b.length>0&&d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(b)});return b})}function f(a,b,c){if(c.length===0)return d("MAWDexieTable").dexieResolve();c=c.map(function(a){return[b,a]});return l(a,c)}function k(a,b,c){if(b.length===0)return d("MAWDexieTable").dexieResolve();b=b.map(function(a){return[a,c]});return l(a,b)}function l(a,b){return a.participants.where(["threadJid","userJid"]).anyOf(b).toArray().then(function(b){return a.participants.bulkDelete(b.map(function(a){return a.id})).then(function(){return a.threads.where("jid").anyOf(Array.from(new Set(b.map(function(a){return a.threadJid})))).toArray()}).then(function(a){var c=new Map(a.map(function(a){return[a.jid,a.chatId]}));b.forEach(function(a){var b=c.get(a.threadJid);b!=null&&d("MAWIndexedDb").afterTransaction({tag:"ParticipantRemoved",value:{threadJid:a.threadJid,userId:d("WAJids").extractUserId(a.userJid)}})})})})}function m(a,b){return a.participants.where("threadJid").equals(b)["delete"]()}function n(a,b,c,d,e){return o(a,[{deliveredWatermarkTs:c,lastReadActionTs:e,lastReadWatermarkTs:d,participantKey:b}]).then(function(a){return a[0]})}function o(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve([]);var c=new Map(),e=[];b.forEach(function(a){e.push(a.participantKey),c.set(JSON.stringify(a.participantKey),a)});return a.participants.where(["threadJid","userJid"]).anyOf(e).toArray().then(function(b){var e=[],f=[];b.forEach(function(a){var b=c.get(JSON.stringify([a.threadJid,a.userJid]));if(b==null)return;var d=b.deliveredWatermarkTs,g=b.lastReadActionTs;b=b.lastReadWatermarkTs;var h=a.deliveredWatermarkTs,i=a.lastReadWatermarkTs,j=a.lastReadActionTs,k=d>h,l=b>i,m=j==null||g>j;if(!k&&!l&&!m){f.push(a);return}e.push(babelHelpers["extends"]({},a,{deliveredWatermarkTs:k?d:h,lastReadActionTs:m?g:j,lastReadWatermarkTs:l?b:i}))});e.forEach(function(a){return i(a,"bulkUpdateParticipantTimestamps")});return a.participants.bulkPut(e).then(function(){e.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"ReceivedReceipt",value:d("MAWBridgeTypesCreators").createBridgeReceivedReceipt(a.threadJid,d("WAJids").extractUserId(a.userJid),a.deliveredWatermarkTs,a.lastReadWatermarkTs,a.lastReadActionTs)})});return[].concat(e,f)})})}function p(a,b){return a.participants.where("threadJid").equals(b).toArray()}function q(a,b){return a.participants.where("threadJid").anyOf(b).toArray()}function r(a,b){return p(a,b).then(function(a){return a.filter(function(a){return a.type==="invitedParticipant"})})}function s(a,b,c){return a.participants.where(["threadJid","userJid"]).equals([b,c]).first().then(function(a){return a==null?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeResult(a)})}function t(a,b){return a.participants.where(["threadJid","userJid"]).anyOf(b).toArray().then(function(a){var c=new Map(a.map(function(a){return[JSON.stringify([a.threadJid,a.userJid]),a]}));return b.map(function(a){return c.get(JSON.stringify(a))})})}g.addParticipant=a;g.bulkAddParticipants=h;g.logIfIllegalParticipant=i;g.bulkAddParticipantsInThreads=j;g.bulkUpsertParticiantsInThread=b;g.bulkUpdateParticipants=e;g.bulkDeleteParticipantsInThread=f;g.bulkDeleteParticipantAcrossThreads=k;g.bulkDeleteParticipants=l;g.deleteAllParticipantsForThread=m;g.updateParticipantTimestamps=n;g.bulkUpdateParticipantTimestamps=o;g.getParticipantsInThread=p;g.getParticipantsInThreads=q;g.getInvitedParticipantsInThread=r;g.getParticipant=s;g.bulkGetParticipants=t}),98);
__d("MAWWriteMsgSideEffectTxns",["MAWDbMsg","MAWDbParticipantTxns","MAWDexieTable"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=d("MAWDbMsg").getCanonicalTsFromMsg(b),e=b.author;return e!=="@me"&&e!=="@system"?d("MAWDbParticipantTxns").updateParticipantTimestamps(a,[b.threadJid,e],c,c,c):d("MAWDexieTable").dexieResolve()}g.updateParticipantTimestampsForMsg=a}),98);
__d("MAWWriteMsgTxns",["MAWAfterWriteMsgUtil","MAWBridgeMsg","MAWBridgeTypesCreators","MAWBuildIncomingMsgs","MAWDbEditMsgHistory","MAWDbEditMsgHistoryTxns","MAWDbMessageHandler","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanzaTxns","MAWDbReactionsTxns","MAWDbThread","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDeleteForMeMsgContentCleaner","MAWDeleteThreadUtil","MAWDexieTable","MAWEBUploadMessageUtils","MAWEphemeralMsgTxns","MAWFTSTxns","MAWFolderTypes","MAWGetMsgQuoteTxn","MAWGetOrCreateThreadTxns","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWLocalizationUtils","MAWMessageHasUniqueExternalIdValidator","MAWMsgType","MAWThreadEvent","MAWThreadSnippetBuildTxns","MAWThreadSnippetUtils","MAWTimeUtils","MAWUpdateQuotedMsgTxns","MAWWriteMsgSideEffectTxns","MAWWriteRevokeMessageTxns","WAJids","WALogger","WATimeUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["handle"," Msg: Message from ",", chat ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["writeMsgAfterTransaction - sortOrderMs: ",""]);i=function(){return a};return a}function j(a,b,e,f){var g=e.ts;g=[d("WATimeUtils").castUnixTimeToMillisTime(g),e.type===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN];var h=g[0],i=g[1];return d("MAWGetOrCreateThreadTxns").getExistingThread(a,b.jid).then(function(b){if(b==null)throw c("err")("at this point there's always a thread - checking for updates");var g=d("MAWDbMsgTxns").getThreadOldestMessageBySortOrder(a,b.jid),j=d("MAWDbMsgTxns").getThreadNewestMessageBySortOrderOrCache(a,b,"defer_to_qe");return d("MAWDexieTable").dexieAll([g,j]).then(function(c){var g,j,k=c[0];c=c[1];var l=c==null?1:d("MAWDbMsg").getInChatMsgIdFromMsgId(c.msgId)+1;g=d("WATimeUtils").castToMillisTime((g=c==null?void 0:c.sortOrderMs)!=null?g:0);var m=h>g&&!i?h:g;g=(g=d("MAWTimeUtils").ensureValidMillisTime(b.lastReadMsgTs))!=null?g:0;j=d("WATimeUtils").castToMillisTime((j=c==null?void 0:c.sortOrderMs)!=null?j:0);g=g<j;var n=e.author===d("WAJids").AUTHOR_ME||e.type===d("MAWMsgType").MSG_TYPE.ADMIN&&d("MAWLocalizationUtils").isParticipantChangeAdminMsg(e.msgContent.adminType)&&!g,o=babelHelpers["extends"]({},e,{msgId:d("MAWDbMsg").craftMsgIdV2(b.chatId,l,e)}),p=d("MAWEBUploadMessageUtils").echoOverrideMessageSortOrder(e);g=p>((j=b.snippetMsgTs)!=null?j:0);var q=!d("MAWThreadSnippetUtils").isDbMsgDisabledForThreadSnippet(o)&&g;l=d("MAWDbMsgTxns").calculateOldestAndNewestMsg(k,c,o,f);var r=l.newestMsg,s=l.oldestMsg;j=q?d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,o):d("MAWDexieTable").dexieResolve(null);return j.then(function(a){return{isOldestMsgUpdated:k!=null&&s!==k.msgId,msgId:o.msgId,prevOldestMsg:k,updatedSnippet:a,updatedThread:babelHelpers["extends"]({},b,{lastReadMsg:n?o.msgId:b.lastReadMsg,lastReadMsgTs:n?m:b.lastReadMsgTs,newestMsg:r,newestMsgTs:m,oldestMsg:s,snippetMsg:q?o.msgId:b.snippetMsg,snippetMsgTs:q?d("WATimeUtils").castToMillisTime(p):b.snippetMsgTs,threadOrder:d("MAWDbThread").craftThreadOrder(m,b.jid)})}})})})}function a(a,b,c,e){return a.messages.where(["threadJid","sortOrderMs"]).equals([c.jid,e]).filter(function(a){return a.type!==d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN&&a.type!==d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION?!1:a.type===b.type&&a.msgContent.adminType===b.msgContent.adminType}).first().then(function(d){return d!=null?d:k(a,b,c)})}function b(a,b,c,e){return a.messages.where(["threadJid","sortOrderMs"]).equals([c.jid,e]).filter(function(a){return a.type===d("MAWMsgType").MSG_TYPE.ADMIN&&a.msgContent.adminType===b.msgContent.adminType}).first().then(function(d){return d!=null?d:k(a,b,c)})}function k(a,b,c,e,f,g,h,k){e===void 0&&(e={});e=e;var l=e.isFirstMsg,m=l===void 0?!1:l;l=e.isIncoming;var n=l===void 0?!1:l;l=e.isOutgoing;var o=l===void 0?!1:l,p=e.openMessageOtid,q=e.openMessageParticipantCount,r=e.optimisticMsg,s=e.participantCount,t=e.quotedReplyAttachmentMeta;l=e.sortOrderMs;return j(a,c,b,l).then(function(c){var e=c.isOldestMsgUpdated,j=c.msgId,l=c.prevOldestMsg,u=c.updatedSnippet,v=c.updatedThread,w=babelHelpers["extends"]({},b,{msgId:j,sortOrderMs:d("MAWEBUploadMessageUtils").echoOverrideMessageSortOrder(b)});if(h!=null&&h){d("MAWMessageHasUniqueExternalIdValidator").logMessageAddSource([w.externalId],"MAWWriteMsgTxns::writeMsg isPointRestoreForEB");return a.messages.add(w).then(function(a){return babelHelpers["extends"]({},w,{rowId:a})})}d("MAWMessageHasUniqueExternalIdValidator").logMessageAddSource([w.externalId],"MAWWriteMsgTxns::writeMsg");return d("MAWDexieTable").dexieAll([a.messages.add(w).then(function(a){return babelHelpers["extends"]({},w,{rowId:a})}),a.threads.put(v),d("MAWFTSTxns").maybePutMessageToBacklog(a,w.externalId)]).then(function(a){var b=a[0];a[1];o&&d("WALogger").LOG(i(),b.sortOrderMs);a=d("MAWAfterWriteMsgUtil").WriteMsgAfterTxnBumpThreadOption.BUMP_LOCAL_ONLY;n&&b.altIndex!==d("MAWDbMsg").SPAM_ALT_INDEX&&b.altIndex!==d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX&&b.author!==d("WAJids").AUTHOR_ME?a=d("MAWAfterWriteMsgUtil").WriteMsgAfterTxnBumpThreadOption.BUMP_LOCAL_AND_SERVER:o&&(a=d("MAWAfterWriteMsgUtil").WriteMsgAfterTxnBumpThreadOption.DO_NOT_BUMP_THREAD);d("MAWAfterWriteMsgUtil").writeMsgAfterTransaction({bumpThreadOption:a,dbMsg:b,hasMoreAfter:g,hasMoreBefore:f,isFirstMsg:m,isOldestMsgUpdated:e,msgsLeftToRestoreForEB:k,openMessageOtid:p,openMessageParticipantCount:q,optimisticMsg:r,participantCount:s,prevOldestMsg:(l==null?void 0:l.msgId)==null?void 0:l.msgId,quotedReplyAttachmentMeta:t,snippet:u,updatedThread:v});return b})})}function l(a,b,e){return d("MAWGetOrCreateThreadTxns").getExistingThread(a,e.jid).then(function(e){if(e==null)throw c("err")("at this point there's always a thread - checking for updates");return d("MAWDbUnrenderedMsgTxns").getNextUnrenderedMsgIdNumberForThread(a,e).then(function(c){var f=babelHelpers["extends"]({},b,{msgId:d("MAWDbMsg").craftUnrenderedMsgId(e.chatId,c)});return d("MAWDexieTable").dexieAll([a.unrenderedMessages.add(f),a.threads.put(e)]).then(function(a){var b=a[0];a[1];return babelHelpers["extends"]({},f,{rowId:b})})})})}function e(a,b,c){return d("MAWDexieTable").dexieAll([m(a,b,c),d("MAWDbEditMsgHistoryTxns").getEditHistoryByOriginalMsgExternalIdAndThreadJid(a,[[b.externalId,c.jid]]).then(function(a){return{editMsgHistories:a,originalEditMsgHistory:a.find(function(a){return a.editExternalId===b.externalId})}})]).then(function(a){var b=a[0];a=a[1];var c=a.editMsgHistories;a=a.originalEditMsgHistory;return babelHelpers["extends"]({},b,{editMsgHistories:c,existingEditMsgHistory:(b=a)!=null?b:null})})}function m(a,b,c){c=[b.externalId,c.jid,b.author];var e=c[0],f=c[1];c=c[2];return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,e,f,c),d("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(a,e,c,f),d("MAWDbPendingStanzaTxns").maybeGetPendingDeletedStanza(a,e,c,f),d("MAWDbMsgTxns").checkIfMsgIsDeletedForMeOrRevoked(a,e,f,c),d("MAWDbPendingStanzaTxns").maybeGetDeleteThreadFromPendingStanza(a,f).then(function(a){return d("MAWDeleteThreadUtil").isMsgDeletedViaDeleteThread(b.ts,a)})]).then(function(a){var b=a[0],c=a[1],d=a[2],e=a[3];a=a[4];return{existingMsg:(b=b)!=null?b:null,isDeletedWithThread:a,isDeleteForMeOrRevoked:e,pendingDeleteForMeStanza:(b=d)!=null?b:null,pendingRevokedStanza:(a=c)!=null?a:null}})}function f(a,b,c){return d("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(a,b.externalId,b.author,c.jid).then(function(e){if(e!=null)return p(a,b,c,e);e=b.author;d("WALogger").DEV(h(),b.type,e,c.jid);var f=babelHelpers["extends"]({},babelHelpers["extends"]({},b,{threadJid:c.jid}));c.folder===d("MAWFolderTypes").FOLDER_ID.OTHER&&(f.altIndex=f.altIndex===d("MAWDbMsg").FUTUREPROOF_ALT_INDEX?d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX:d("MAWDbMsg").SPAM_ALT_INDEX);return d("MAWGetMsgQuoteTxn").getMsgQuoteInfo(a,f,c.jid).then(function(b){b!=null&&(f=babelHelpers["extends"]({},f,{quote:b==null?void 0:b.quote,quoteExternalId:b==null?void 0:b.quoteExternalId}));return d("MAWDexieTable").dexieAll([d("MAWUpdateQuotedMsgTxns").associateQuotedMessage(a,c.jid,f),d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,f),d("MAWLoadReplyMediaTxns").getReplyMediaForMsg(a,f)]).then(function(b){var e=b[0],g=b[1],h=b[2];return k(a,f,c,{isIncoming:!0,quotedReplyAttachmentMeta:g}).then(function(b){return d("MAWDexieTable").dexieAll([d("MAWWriteMsgSideEffectTxns").updateParticipantTimestampsForMsg(a,f),d("MAWEphemeralMsgTxns").markEphemeralMessageAsSent(a,b)]).then(function(a){a=a[1];e!=null&&e.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a,void 0,h)})});return a||b})})})})})}function n(a,b,c,e,f){var g=babelHelpers["extends"]({},babelHelpers["extends"]({},b,{msgId:c.msgId,rowId:c.rowId,serverTs:c.serverTs,sortOrderMs:c.sortOrderMs,threadJid:e.jid,ts:c.ts}));return d("MAWDexieTable").dexieAll([d("MAWUpdateQuotedMsgTxns").associateQuotedMessage(a,e.jid,g),d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,g),d("MAWLoadReplyMediaTxns").getReplyMediaForMsg(a,g),d("MAWGetMsgQuoteTxn").getMsgQuoteInfo(a,g,e.jid),d("MAWDbMsgTxns").getThreadNewestMessageId(a,e)]).then(function(h){var i=h[0],j=h[1],k=h[2],l=h[3],m=h[4];g=babelHelpers["extends"]({},g,{quote:l==null?void 0:l.quote,quoteExternalId:l==null?void 0:l.quoteExternalId});return((h=c.editCount)!=null?h:0)>0&&f!=null&&b.type===d("MAWMsgType").MSG_TYPE.TEXT?d("MAWDbEditMsgHistoryTxns").updateEditMsgHistoryWithNewIncomingMsg(a,f,b).then(function(a){a!=null&&d("MAWIndexedDb").afterTransaction({tag:"EditMsgHistoryAdded",value:[babelHelpers["extends"]({},a,{editMsgHistoryId:d("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(a.editMsgHistoryId),originalMsgId:c.msgId})]});return c}):a.messages.put(g).then(function(){return d("MAWDbThreadTxns").needsRetroactiveReadReceiptInThread(a,g)}).then(function(b){if(b){g.altIndex=d("MAWDbMsg").craftToBeReadAltIndex(e.chatId);return a.messages.put(g)}}).then(function(){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(g,void 0,k)});d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(g,void 0,j)});d("MAWIndexedDb").afterTransactionThreadEvent({chatJid:e.jid,msgId:g.msgId},d("MAWThreadEvent").PLACEHOLDER_CONVERT_SUBSCRIPTION);i!=null&&i.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a,void 0,k)})});if(g.msgId===m&&!d("MAWDbMessageHandler").isThreadUpdateEnabledViaMiddleware(g.type)){var b=g;b.rowId;b=babelHelpers.objectWithoutPropertiesLoose(b,["rowId"]);return d("MAWDexieTable").dexieAll([d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,g),d("MAWWriteMsgSideEffectTxns").updateParticipantTimestampsForMsg(a,b)]).then(function(a){a=a[0];var b=a.snippetParams,c=a.snippetSenderContactId;a=a.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:b,snippetSenderContactId:c,snippetType:a,threadJid:e.jid})});return g})}return g})})}function o(a,b,c,e){var f=d("MAWBuildIncomingMsgs").buildUnstoredDeleteForMeMsg(b,c);return d("MAWDexieTable").dexieAll([d("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(a,[{author:f.author,chatJid:f.threadJid,externalId:f.externalId}]),l(a,f,c),a.pendingStanzas["delete"](e.rowId),d("MAWFTSTxns").maybePutMessageToPurgeBacklog(a,b.externalId)]).then(function(a){a[0];a=a[1];d("MAWDeleteForMeMsgContentCleaner").addNewDeleteForMeMsgContentCleanerTimestamp(f.messageDeleteForMeTs);return babelHelpers["extends"]({},f,{msgId:a.msgId,rowId:a.rowId})})}function p(a,b,e,f){var g=d("MAWDbPendingStanzaTxns").getRevokedContent(f);if(g==null)throw c("err")("missing revoked content");b=d("MAWBuildIncomingMsgs").buildUnstoredRevokedMsg(b,e,g);return d("MAWDexieTable").dexieAll([k(a,b,e),a.pendingStanzas["delete"](f.rowId)]).then(function(b){var c=b[0];return d("MAWWriteRevokeMessageTxns").markIncomingMessageRevoked(a,c,e).then(function(){return c})})}g.writeDedupedEphemeralSettingAdminMessage=a;g.writeDedupedAdminMessage=b;g.writeMsg=k;g.writeUnrenderedMsg=l;g.prepareTextMsgWriteData=e;g.prepareMsgWriteData=m;g.writeNewIncomingMsg=f;g.writeCiphertextUpdate=n;g.handleDeleteForMeMessage=o;g.handleOutOfOrderRevokedMessage=p}),98);
__d("MAWDbDeletedMessages",["$InternalEnum"],(function(a,b,c,d,e,f){"use strict";a=b("$InternalEnum")({ChatDelete:"chat_delete",Revoke:"revoke"});f.DbDeletedMsgReasonEnum=a}),66);
__d("MAWUnsendMsgContentCleaner",["MAWMsgCleaner","WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["UnsendMsgContentCleaner: Adding timestamps (",")"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["startUnsendMsgContentCleaner invoked"]);j=function(){return a};return a}var k=null;function a(a){d("WALogger").LOG(j()),k==null&&(k=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.UNSEND))}function b(a){if(k==null){var b="Trying to add new UnsendMsgContentCleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(i(),b);throw c("err")(b)}else d("WALogger").DEV(h(),a),k.update(a)}function e(){return k}function f(){k=null}g.startUnsendMsgContentCleaner=a;g.addNewUnsendMsgContentCleanerTimestamp=b;g.getUnsendMsgContentCleaner_FOR_TESTING_ONLY=e;g.resetUnsendMsgContentCleaner_FOR_TESTING_ONLY=f}),98);
__d("MAWWriteRevokeMessageTxns",["EBUploadMessages","FBLogger","MAWAckLevel","MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbDeletedMessages","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanza","MAWDbReactionsTxns","MAWDexieTable","MAWEphemeralUtil","MAWFTSTxns","MAWIndexedDb","MAWJidUtils","MAWMsgType","MAWPendingStanzaCleaner","MAWThreadSnippetBuildTxns","MAWUnsendMsgContentCleaner","MAWUpdateQuotedMsgTxns","MAWWriteDeleteMessageTxns","MAWWriteMsgTxns","MAWXMAUtils","WATimeUtils","err","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h=6*d("WATimeUtils").HOUR_SECONDS,i=30*d("WATimeUtils").DAY_SECONDS;function a(a,b,e,f,g,h){if(h!=null&&f==null){h=babelHelpers["extends"]({},b,{originalTs:d("WATimeUtils").castMilliSecondsToUnixTime(h),threadJid:e.jid,unsendMsgContentDeleteTs:(h=b.serverTs)!=null?h:b.ts});return d("MAWWriteMsgTxns").writeMsg(a,h,e).then(function(a){return a.type==="Revoked"?a:null})}var k=d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+i),m=b.author,n=b.externalId,o=b.revokedExternalId,p=g!=null?l(a,g):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([f==null?d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,b.revokedExternalId,e.jid,b.author):d("MAWDexieTable").dexieResolve(f),d("MAWFTSTxns").maybePutMessageToPurgeBacklog(a,n)]).then(function(g){var h=g[0];(f==null||h!=null)&&c("FBLogger")("messenger_e2ee_web").warn("Revoked message missing originalMsg incorrectly");if(h==null){g={deleteTs:k,externalIdWithType:o+"_"+d("MAWDbPendingStanza").PENDING_REVOKED,pendingContent:{content:{ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:m,externalId:n,revokedExternalId:o,threadJid:e.jid,ts:b.ts,type:"Revoked"},type:d("MAWDbPendingStanza").PENDING_TYPE.REVOKED}};return d("MAWDexieTable").dexieAll([a.pendingStanzas.add(g),p]).then(function(b){b[0];b=b[1];d("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(k);b===!0&&d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,e)})}return p.then(function(){return j(a,h,e,b.externalId,b.revokedExternalId,b.serverTs,b.ts,!1)})})}function j(a,b,c,e,f,g,i,j){var l=babelHelpers["extends"]({},b,{altIndex:void 0,externalId:e,msgContent:d("MAWDbMsg").getMsgContent(b),originalTs:(e=b.serverTs)!=null?e:b.ts,revokedExternalId:f,serverTs:g,threadJid:c.jid,ts:i,type:"Revoked",unsendMsgContentDeleteTs:d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+h)});if(j){d("EBUploadMessages").sendDeleteEchoMessage(b,c.jid);return d("MAWDexieTable").dexieResolve(l)}return k(a,b,l,c).then(function(){return l})}function k(a,b,e,f,g){var h;g===void 0&&(g=!1);h=d("MAWXMAUtils").isXMAStoryReply((h=b.quote)==null?void 0:h.content.xmaMessageType)?d("MAWWriteDeleteMessageTxns").deleteXMAStoryReplyMsg(a,b):d("MAWDexieTable").dexieResolve();var i=d("MAWJidUtils").toProtocolMsgId(b);i=i!=null?a.deletedMessages.add(babelHelpers["extends"]({},i,{reason:d("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke})):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([a.messages.put(e),d("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(a,[{author:e.author,chatJid:e.threadJid,externalId:e.revokedExternalId}]),d("MAWUpdateQuotedMsgTxns").disassociateQuotedMsg(a,e.threadJid,e.revokedExternalId,e.author,d("MAWMsgType").MSG_TYPE.REVOKED),h,i,d("MAWFTSTxns").maybePutMessageToPurgeBacklog(a,b.externalId)]).then(function(){g||d("MAWUnsendMsgContentCleaner").addNewUnsendMsgContentCleanerTimestamp(e.unsendMsgContentDeleteTs);return d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,f)}).then(function(){b!=null&&d("EBUploadMessages").sendDeleteEchoMessage(b,b.threadJid);d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(e)});if(b!=null&&d("MAWDbMsg").isMediaMsg(b)){var a=b.mediaId,f=b.plaintextHash;a!=null&&(c("gkx")("2419")&&f!=null?d("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:a,msgId:b.msgId,plaintextHash:f,threadJid:b.threadJid}}):d("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:a,msgId:b.msgId,threadJid:b.threadJid}}))}d("MAWEphemeralUtil").maybeClearEphemeralMsgCountdown(b)})}function b(a,b,e){if(b.type!==d("MAWMsgType").MSG_TYPE.REVOKED)throw c("err")("Cant mark unrevoked message revoked");var f=d("MAWJidUtils").toProtocolMsgId(b);f=f!=null?a.deletedMessages.add(babelHelpers["extends"]({},f,{reason:d("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke})):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([d("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(a,[{author:b.author,chatJid:b.threadJid,externalId:b.revokedExternalId}]),d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,e),f]).then(function(){d("MAWUnsendMsgContentCleaner").addNewUnsendMsgContentCleanerTimestamp(b.unsendMsgContentDeleteTs),d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(b)})})}function l(a,b){return b.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?a.messages["delete"](b.rowId).then(function(){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.threadJid,[b])});return!0}):d("MAWDexieTable").dexieResolve(!1)}g.REVOKE_CONTENT_EXPIRATION_IN_SEC=h;g.writeIncomingRevokeMsg=a;g.revokeUnstoredMsg=j;g.markExistingMsgRevoked=k;g.markIncomingMessageRevoked=b}),98);
__d("MAWReStoreDb",["MAWIndexedDb","MAWReStoreDbSetup","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){if(c("gkx")("3577"))return d("MAWReStoreDbSetup").getDB();h==null&&(d("MAWIndexedDb").willSetupDB()?h=d("MAWIndexedDb").getDB().then(function(){return d("MAWReStoreDbSetup").getDB()}):h=d("MAWReStoreDbSetup").getDB());return h}g.getDB=a}),98);
__d("MAWReStoreTiming",["FBLogger","MAWErrorObject","MAWIndexedDb","MAWLLAMigrationUtils","MAWQplProxy","MAWReStoreDb","MAWRestoreDbState","asyncToGeneratorRuntime","qex"],(function(a,b,c,d,e,f,g){"use strict";var h=["MWPTransactor"];function i(a){a=d("MAWLLAMigrationUtils").getTransactorQPLParam(a);a=a.length===2?a:[null,void 0];var b=a[0];a=a[1];return b!=null?d("MAWQplProxy").startQplUserFlow(b,a,void 0,d("MAWLLAMigrationUtils").QPL_TRANSACTION_TIMEOUT_MS):null}var j=c("FBLogger")("messenger_e2ee_web");function k(a){if(a)return j.catching(a);else return j}function l(a,c){return b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var b=(yield d("MAWReStoreDb").getDB()),e=i(a),f;try{e==null?void 0:e.addPoint("transactor_execution_start");for(var g=arguments.length,j=new Array(g),l=0;l<g;l++)j[l]=arguments[l];f=(yield c.apply(void 0,[b].concat(j)));e==null?void 0:e.addPoint("transactor_execution_end");e==null?void 0:e.endSuccess()}catch(b){var m;e==null?void 0:e.endFail("transaction_fail");var n=d("MAWErrorObject").getErrorObject(b);throw k(n).mustfixThrow("[%s] Error performing %s transaction",h.join("|"),(m=a)!=null?m:"")}return f})}function a(a,b,e,f){return function(){for(var g=arguments.length,h=new Array(g),i=0;i<g;i++)h[i]=arguments[i];return!c("qex")._("1016")?d("MAWIndexedDb").makeMsgrTransactor(e,a,f).apply(void 0,h):d("MAWRestoreDbState").isUsingShim().then(function(c){return c?l(a,b).apply(void 0,h):d("MAWIndexedDb").makeMsgrTransactor(e,a,f).apply(void 0,h)})}}g.makeShimTransactor=a}),98);
__d("MAWHandlePendingStanzasInRestoreV2",["EBUploadMessages","I64","LSMEBTaskCreationSource","MAWBridgeEventTransmitter","MAWDbPendingStanza","MAWDbPendingStanzaTxns","MAWDexieTable","MAWEBUploadTrackingUtils","MAWEncryptedBackupCacheManager","MAWIndexedDb","MAWReStoreTiming","MAWTransactionMode","MAWWriteRevokeMessageTxns","Promise","ReQL","WAJids","WALogger","cr:553","cr:7702","cr:8066","nullthrows","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] pendingStanza type "," is not supported"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] revokedExternalId is null for pendingStanza"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] revokedExternalId is null for pendingStanza"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] threadJid is null for pendingStanza"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] pendingStanzaTs is null for pendingStanza"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] revokedExternalId is null for pendingStanza"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] externalId is null for pendingStanza"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Could not find thread for chatId "," for pendingStanza"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Delete For Me pending stanza does not need to be applied."]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] thread is null"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] pendingStanza type "," is not supported"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Pending Stanza not found in the cache. This shouldn't happen."]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] externalId is null for pendingStanza"]);v=function(){return a};return a}var w=(a=(e=(a=b("cr:553"))==null?void 0:a.structuredClone)!=null?e:(f=b("cr:7702"))==null?void 0:f.structuredClone)!=null?a:(e=b("cr:8066"))==null?void 0:e.structuredClone;f=function(a,c,d){a=a.restoredMsgsData;if(a){var e=a.newlyAddedMsgs;e=e.concat(a.existingMsgs);return x(e,c,d)}return(i||(i=b("Promise"))).resolve()};var x=function(a,e,f){f==null?void 0:f.addPoint("apply_pending_stanza_start");var g=0,h=0,j=0,k=0,l=new Map();return F().then(function(a){a==null?void 0:a.map(function(a){var b=a.pendingContent.content.externalId;if(b==null){d("WALogger").WARN(v());return}l.set(a.externalIdWithType,a)}),k=l.size}).then(function(){var b=new Set();return B(a).then(function(f){return d("MAWDexieTable").dexieAll(a.map(function(a){var c=a.externalId;if(e)if(d("MAWEncryptedBackupCacheManager").peekPendingStanzaCache(c)){var i=d("MAWEncryptedBackupCacheManager").getPendingStanzaCacheValue(c);if(i==null){d("WALogger").ERROR(u());return}return A(i,a,f,e).then(function(a){a!=null&&b.add(i);d("MAWEncryptedBackupCacheManager").removePendingStanzaCacheValue(c);l["delete"](i.externalIdWithType);a=i.pendingContent.type;a===d("MAWDbPendingStanza").PENDING_TYPE.REVOKED&&g++;h++})}else l.clear();else{var k=c+"_"+d("MAWDbPendingStanza").PENDING_REVOKED,m=l.get(k);if(m!=null)return A(m,a,f,e).then(function(a){a!=null&&(b.add(m),g++,j++),l["delete"](m.externalIdWithType)})}})).then(function(){if(!e){var a=y(l);g+=a[1];h+=a[0]+a[1];c("promiseDone")(z(Array.from(b)))}})})}).then(function(a){f==null?void 0:f.addPoint("apply_pending_stanza_end",{"int":{initialRestorePendingStanzaCount:j,pendingStanzasToBeUploadedCount:k,pointRestorePendingStanzaCount:h,revokedCount:g}});return(i||(i=b("Promise"))).resolve()})},y=function(a){var b=0,c=0;a.forEach(function(a){var e=a.pendingContent.type;e===d("MAWDbPendingStanza").PENDING_TYPE.REVOKED?c++:e===d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME&&b++;E(a)});a.clear();return[b,c]},z=d("MAWIndexedDb").makeMsgrTransactor({pendingStanzas:d("MAWTransactionMode").READWRITE},"deletePendingStanzasFromIndexedDB",function(a){return function(b){return d("MAWDbPendingStanzaTxns").deletePendingStanzas(a,b)}}),A=function(a,e,f,g){var h=a.pendingContent.type;if(h===d("MAWDbPendingStanza").PENDING_TYPE.REVOKED)return D(a,e,f,g).then(function(a){if(a!=null){var b=d("MAWEBUploadTrackingUtils").genInstanceKeyOnly();d("MAWEBUploadTrackingUtils").startUploadTracking(a.externalId,a.type,"pendingstanza",b);c("promiseDone")(d("EBUploadMessages").uploadUniqueMessage([a],void 0,!1,void 0,new Map([[a.externalId,b]])))}});else if(h===d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME)return C(a);else{d("WALogger").WARN(t(),h);return(i||(i=b("Promise"))).resolve()}},B=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READONLY},"getThreadsForMessages",function(a){return function(b){var c=[];b.forEach(function(a){c.push(a.threadJid)});return a.threads.where("jid").anyOf(c).toArray().then(function(a){var b=new Map();a.forEach(function(a){if(a==null){d("WALogger").WARN(s());return d("MAWDexieTable").dexieResolve()}b.set(a.jid,a)});return b})}}),C=d("MAWIndexedDb").makeMsgrTransactor({pendingStanzas:d("MAWTransactionMode").READWRITE},"deleteForMeMsg",function(a){return function(b){d("WALogger").LOG(r());return d("MAWDexieTable").dexieAll([a.pendingStanzas["delete"](b.rowId)]).then(function(){return d("MAWDexieTable").dexieResolve(b)})}}),D=d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY,deletedMessages:d("MAWTransactionMode").READWRITE,ftsPurgeBacklog:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READWRITE,media:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READWRITE,pendingStanzas:d("MAWTransactionMode").READWRITE,reactions:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,xma:d("MAWTransactionMode").READONLY},"revokeMessage",function(a){return function(b,c,e,f){e=e.get(c.threadJid);if(e==null){d("WALogger").ERROR(q(),c.threadJid);return d("MAWDexieTable").dexieResolve()}var g=b.pendingContent.content.externalId;if(g==null){d("WALogger").ERROR(p());return d("MAWDexieTable").dexieResolve()}var h=b.pendingContent.content.revokedExternalId;if(h==null){d("WALogger").ERROR(o());return d("MAWDexieTable").dexieResolve()}var i=b.pendingContent.content.ts;if(i==null){d("WALogger").ERROR(n());return d("MAWDexieTable").dexieResolve()}return d("MAWWriteRevokeMessageTxns").revokeUnstoredMsg(a,c,e,g,h,c.serverTs,c.ts,f).then(function(c){a.pendingStanzas["delete"](b.rowId);return d("MAWDexieTable").dexieResolve(c)})}});function E(a){var b=a.pendingContent.content.threadJid;if(b==null){d("WALogger").WARN(m());return}var e=d("WAJids").threadIdForChatJid(b),f=a.pendingContent.type;if(f===d("MAWDbPendingStanza").PENDING_TYPE.REVOKED){var g=a.pendingContent.content.revokedExternalId;if(g==null){d("WALogger").WARN(l());return}g=g}else if(f===d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME){var h=a.pendingContent.content.externalId;if(h==null){d("WALogger").WARN(k());return}g=h}else{d("WALogger").WARN(j(),f);return}d("MAWEncryptedBackupCacheManager").addPendingStanzaToPendingStanzaCache(g,a);d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(g,e,void 0,c("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT,b)}var F=d("MAWReStoreTiming").makeShimTransactor("getAllPendingStanzas",function(a){return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.e2ee_pendingStanzas).map(function(a){a=c("nullthrows")(w)(a);return babelHelpers["extends"]({},a,{rowId:(h||(h=d("I64"))).to_float(a.rowId)})}))},{pendingStanzas:d("MAWTransactionMode").READONLY},function(a){return function(){return d("MAWDbPendingStanzaTxns").getAllPendingStanzas(a)}});g.applyPendingStanzas=f;g.issuePointQueryForPendingStanza=E}),98);
__d("MAWBridgeXMA",["MAWBridgeUIEventDataValidation","MAWDbMedia","WALogger","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWBridge - createBridgeXMA received unexpected media type - ",""]);h=function(){return a};return a}function i(a){if(a==null)return void 0;switch(a){case"Image":case"Sticker":return"image/png";case"Gif":return"image/gif";case"Video":return"video/mp4";case"Ptt":return"audio/wav"}}function a(a,b,e){var f=b.contentRef,g=b.ctas,j=b.defaultCTA,k=b.defaultPreviewMediaId,l=b.faviconMediaId,m=b.headerMediaId,n=b.headerTitle,o=b.maxSubtitleNumOfLines,p=b.maxTitleNumOfLines,q=b.msgId,r=b.offlineAttachmentId,s=b.overlayIconGlyph,t=b.overlayTitle,u=b.subtitleText,v=b.targetId,w=b.targetType,x=b.targetUsername,y=b.threadJid,z=b.titleText,A=b.xmaId;b=b.xmaLayoutType;a!=null&&a.mediaType!==d("MAWDbMedia").IMAGE&&d("WALogger").WARN(h(),a.mediaType);v!=null&&d("MAWBridgeUIEventDataValidation").stringToI64Opt(v);return{contentRef:f,ctas:g,defaultCTA:j,defaultPreviewMediaId:k,duration:null,faviconMediaId:l,filesize:a==null?void 0:a.size,hasMedia:c("gkx")("821")?e:void 0,headerMediaId:m,headerTitle:n,maxSubtitleNumOfLines:o,maxTitleNumOfLines:p,mediaType:a==null?void 0:a.mediaType,msgId:q,offlineAttachmentId:r,overlayIconGlyph:s,overlayTitle:t,playableUrlMimeType:i(a==null?void 0:a.mediaType),previewHeight:a==null?void 0:(f=a.validatedImageInfo)==null?void 0:f.jpegThumbnailHeight,previewHeightLarge:a==null?void 0:(g=a.validatedImageInfo)==null?void 0:g.height,previewUrlMimeType:i(a==null?void 0:a.mediaType),previewWidth:a==null?void 0:(j=a.validatedImageInfo)==null?void 0:j.jpegThumbnailWidth,previewWidthLarge:a==null?void 0:(k=a.validatedImageInfo)==null?void 0:k.width,subtitleText:u,targetId:v,targetType:w,targetUsername:x,threadJid:y,titleText:z,ts:a==null?void 0:a.ts,xmaId:A,xmaLayoutType:b}}function b(a,b){var c=a.msgId;a=a.threadJid;return{msgId:c,threadJid:a,xmaId:b}}function e(a,b){var c=a.msgId;a=a.threadJid;return{msgId:c,threadJid:a,xmaId:b}}g.createBridgeXMA=a;g.createBridgeXMAShareExpired=b;g.createBridgeXMAShareTombstoned=e}),98);
__d("MAWDbReactionUtils",["MAWBridgeTypesCreators","MAWIndexedDb"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.author,c=a.reaction,e=a.reactToMsgId,f=a.threadJid;a=a.ts;if(e==null)return;d("MAWIndexedDb").afterTransaction(c==null?{tag:"DeleteReaction",value:d("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:b,chatJid:f,reactToMsgId:e})}:{tag:"UpsertReaction",value:d("MAWBridgeTypesCreators").createBridgeUpsertReaction({author:b,chatJid:f,reaction:c||"",reactToMsgId:e,ts:a})})}g.dispatchReaction=a}),98);
__d("WAArrayGroupBy",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c=new Map();for(var d=0;d<a.length;d++){var e=b(a[d]),f=c.get(e);f==null?c.set(e,[a[d]]):f.push(a[d])}return Array.from(c.entries())}f.groupBy=a}),66);
__d("MAWBulkPutReactionsWithThreadUpdateTxn",["MAWBridgeBuildThreadSnippet","MAWBridgeTypesCreators","MAWBridgeUIEventDataValidation","MAWDbReaction","MAWDbReactionUtils","MAWDbReactionsTxns","MAWDexieTable","MAWJidUtils","MAWThreadSnippetBuildTxns","MAWTransactor","Promise","WAArrayGroupBy","WAJids","WAMsgMap","asyncToGeneratorRuntime","cr:3061","err","qex"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){return a.reduce(function(a,b){var c=d("MAWJidUtils").maybeToProtocolMsgId(b.author,b.threadJid,b.reactToExternalId);if(c==null)return a;a.set(c,d("MAWDbReactionsTxns").coerceToReaction(b));return a},new(d("WAMsgMap").MsgMap)()).values()}function a(a,e,f){if(e.length===0)return d("MAWDexieTable").dexieResolve();e=i(e);var g=e.map(function(a){var b=f.get(a.threadJid);if(b==null)throw c("err")("Should not have got here - expect thread to exist for flow");c("qex")._("1215")!==!0&&d("MAWDbReactionUtils").dispatchReaction(a);return a});e=d("WAArrayGroupBy").groupBy(g,function(a){a=a.threadJid;return a});e=e.map(function(b){var c=b[0];b=b[1];c=f.get(c);if(c==null||b.length===0)return null;var e=null;for(var g=b.length-1;g>=0;g--){e=d("MAWDbReaction").castToIncomingDbReaction(b[g]);if(e!=null)break}g=b.filter(function(a){return a.reaction==null});b=d("WAJids").interpretAsGroupJid(c.jid)!=null;return d("MAWThreadSnippetBuildTxns").getThreadChangesetForReactionChanges(a,c,{newestReaction:e,reactionsToClear:g},b)}).filter(Boolean);return d("MAWDexieTable").dexieAll(e).then(function(e){return d("MAWDexieTable").dexieAll([a.threads.bulkPut(e.map(function(a){a=a.thread;return a})),a.reactions.bulkPut(g)]).then(function(){if(c("qex")._("1215")===!0&&b("cr:3061")!=null)return d("MAWTransactor").runInLSDB(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield (h||(h=b("Promise"))).all(e.map(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(c){var e=c.newestReaction;c=c.thread;var f=(yield b("cr:3061").getOrCreateOptimisticThreadKey(a,c.jid));f=(yield a.threads.get(f));if(f!=null&&e!=null&&c.snippetMsg!=null&&e.author!=null){var g=d("WAJids").interpretAsGroupJid(c.jid)!=null;e=d("MAWThreadSnippetBuildTxns").getReactionSnippetParams(e.author,e.reaction,g);g=e.snippetParams;var h=e.snippetSenderContactId;e=e.snippetType;g=d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:g,snippetSenderContactId:h,snippetType:e,threadJid:c.jid});h=(yield d("MAWBridgeBuildThreadSnippet").buildBridgeThreadSnippet(g,f.snippet));yield a.threads.put(babelHelpers["extends"]({},f,{snippet:h,snippetSenderContactId:g.snippetSenderContactId!=null?d("MAWBridgeUIEventDataValidation").stringToI64Opt(g.snippetSenderContactId):void 0}))}});return function(a){return c.apply(this,arguments)}}()))});return function(b){return a.apply(this,arguments)}}())}).then(function(){})})}g.bulkPutReactionsWithThreadUpdates=a}),98);
__d("MAWBulkWriteReactionsTxns",["LSMEBTaskCreationSource","MAWAuthor","MAWBulkPutReactionsWithThreadUpdateTxn","MAWDbMsg","MAWDbReaction","MAWDbReactionsTxns","MAWDexieTable","MAWEncryptedBackupCacheManager","MAWIndexedDb","WAArrayGroupBy","WAJids","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var e=[],f=[];b.forEach(function(a){var b=a.chatJid;a=a.unstoredReaction;a=a.reactToExternalId;e.push(b);f.push(a)});return d("MAWDexieTable").dexieAll([a.threads.where("jid").anyOf(e).toArray(),a.messages.where("externalId").anyOf(f).toArray(),a.reactions.where("reactToExternalId").anyOf(f).toArray()]).then(function(e){var f=e[0],g=e[1];e=e[2];var h=new Map(f.map(function(a){return[a.jid,a]})),i=new Map(d("WAArrayGroupBy").groupBy(g,function(a){return a.externalId})),j=new Map(d("WAArrayGroupBy").groupBy(e,function(a){return a.reactToExternalId})),k=[];g=f.map(function(b){return d("MAWDbReactionsTxns").getNextReactionIdNumberForThread(a,b).then(function(a){return[b.jid,a]})});return d("MAWDexieTable").dexieAll(g).then(function(a){var e=new Map(a);b.forEach(function(a){var b=a.chatJid;a=a.unstoredReaction;var f=a.author,g=a.externalId,l=a.groupingKey,m=a.reaction,n=a.reactToAuthor,o=a.reactToExternalId,p=a.senderTimestampMs,q=a.ts,r=h.get(b);if(r==null)return"missing_thread";b=e.get(r.jid);if(b==null)throw c("err")("nextInChatReactionId should not be null");e.set(r.jid,b+1);var s=j.get(a.reactToExternalId)||[];s=d("MAWDbReaction").findMatchingReaction(s,r.jid,f);var t=d("MAWAuthor").getAuthorUserJid(n),u=i.get(a.reactToExternalId);if(u==null&&!d("MAWEncryptedBackupCacheManager").peekRestoreCache(a.reactToExternalId)){var v=d("WAJids").threadIdForChatJid(r.jid);d("MAWEncryptedBackupCacheManager").addMsgEntryToReuploadCache(r.jid,a.reactToExternalId);d("MAWIndexedDb").afterTransaction({tag:"IssuePointQuery",value:{jid:r.jid,messageId:a.reactToExternalId,startSortKey:void 0,taskSource:c("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT,threadId:v}})}a=u==null?void 0:u.find(function(a){return a.threadJid===r.jid&&t===d("MAWAuthor").getAuthorUserJid(a.author)});u=d("MAWDbReaction").formatReactionForDb(r.jid,g,d("MAWDbMsg").craftReactionId(r.chatId,b),o,m,l,n,a==null?void 0:a.msgId,q,(v=f)!=null?v:d("WAJids").AUTHOR_ME,s==null?void 0:s.rowId,void 0,p);k.push(u)});return{chatJidToDbThread:h,unstoredDbReactionsForInsertion:k}})})}function b(a,b){var c=b.chatJidToDbThread;b=b.unstoredDbReactionsForInsertion;return d("MAWBulkPutReactionsWithThreadUpdateTxn").bulkPutReactionsWithThreadUpdates(a,b,c)}g.prepareReactionsData=a;g.bulkWriteReactions=b}),98);
__d("MAWCastToMsgrServerMediaType",["MAWDbMedia","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["invalid client mediaType: "," for castClientMediaTypeToServerMediaType method"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["invalid mediaType: "," for castToMsgrServerMediaType method"]);i=function(){return a};return a}function a(a,b){b===void 0&&(b=!1);if(b&&a==="image")return"xma";switch(a){case"image":case"video":case"gif":case"sticker":case"document":return a;case"ptt":return"audio";case"xma-image":return"xma";default:d("WALogger").ERROR(i(),a);return null}}function b(a,b){b===void 0&&(b=!1);if(b&&a===d("MAWDbMedia").MEDIA_TYPE.IMAGE)return"xma";switch(a){case"Image":return"image";case"Video":return"video";case"Gif":return"gif";case"Sticker":return"sticker";case"DocumentFile":return"document";case"Ptt":return"audio";default:d("WALogger").ERROR(h(),a);return null}}g.castToMsgrServerMediaType=a;g.castClientMediaTypeToServerMediaType=b}),98);
__d("WADbDeviceRegistration",[],(function(a,b,c,d,e,f){"use strict";a=25;b=6;c=100;d="https://reg-e2ee.facebook.com";e=d;var g="https://v.whatsapp.net",h="https://reg-e2ee.instagram.com",i="/v2/fb_icdc_fetch",j="/v2/fb_register_v2",k="Device has already been registered to WA servers",l="Device registration finished successfully",m="Device registration retries failed "+b+" times. No longer attempting registration.",n="Device registration response was null",o="Current user id is zero",p="CryptoAuthToken is empty",q="CryptoAuthToken is expired",r={failed:"failed",finished:"finished"};f.MAX_USERS_FOR_NOTIFY_DEVICE_CHANGE=a;f.MAX_DEVICE_REGISTRATION_RETRIES=b;f.MAX_ROTATE_CRYPTO_AUTH_TOKEN_RETRIES=c;f.REG_FB_DOMAIN=d;f.REG_MSGR_DOMAIN=e;f.REG_WA_DOMAIN=g;f.REG_IGD_DOMAIN=h;f.ICDC_ENDPOINT=i;f.REGISTRATION_ENDPOINT=j;f.DEVICE_ALREADY_REGISTERED=k;f.DEVICE_SUCCESSFULLY_REGISTERED=l;f.FAILED_REGISTRATION_RETRIES=m;f.NULL_RESPONSE_FROM_SERVER=n;f.DEVICE_REGISTER_ERROR_ZERO_AS_USER_ID=o;f.DEVICE_REGISTER_ERROR_EMPTY_CAT_TOKEN=p;f.DEVICE_REGISTER_ERROR_EXPIRED_CAT_TOKEN=q;f.RegistrationStatesEnum=r}),66);
__d("WorkerUtils",[],(function(a,b,c,d,e,f){"use strict";function b(){try{return"WorkerGlobalScope"in a&&a instanceof a.WorkerGlobalScope}catch(a){return!1}}function c(){try{return"SharedWorkerGlobalScope"in a&&a instanceof a.SharedWorkerGlobalScope}catch(a){return!1}}f.isWorkerContext=b;f.isSharedWorkerContext=c}),66);
__d("getOrchestratorVersion",["qex"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a;return(a=c("qex")._("263"))!=null?a:"default"}g["default"]=a}),98);
__d("MAWMainWebWorkerConfig",["MAWGK","MAWParseXMAFBConfig","WADbDeviceRegistration","WorkerUtils","getOrchestratorVersion","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i=1;a={armadilloWebProcessFutureproof:function(){return c("MAWGK").armadillo_web_process_futureproof},batchSize:function(){return c("justknobx")._("1866")},getDevicesV2:function(){return c("gkx")("4551")},getSignalFutureMessagesMax:function(){return c("gkx")("4280")?c("justknobx")._("847"):2e3},icdcAlertTriggerFailureCounter:function(){return c("justknobx")._("1970")},icdcCooldownIntervalInMinutes:function(){return c("justknobx")._("1971")},icdcIntervalInMinutes:function(){return c("justknobx")._("1972")},ignoreReadReceipts:function(){return c("gkx")("2855")},isDocumentReceiveEnabled:function(){return!c("gkx")("23924")},isEphemeralMessagesEnabled:function(){return!0},isFrankingDropOnInvalid:function(){return c("gkx")("23973")},isFrankingDropOnMissing:function(){return c("gkx")("23974")},isFrankingEnabled:function(){return c("justknobx")._("1347")},isGifEnabled:function(){return c("justknobx")._("1147")},isICDCErrorEnabled:function(){return c("gkx")("23975")},isMediaFallbackToAlternativeHmacSaltsEnabled:function(){return c("gkx")("23976")},isMediaStreamingForProgressiveJpegEnabled:function(){return c("gkx")("2325")},isMediaWaitForConnectionOnRetryEnabled:function(){return c("gkx")("23977")},isOctetStreamAttachmentMimeTypeEnabled:function(){return c("gkx")("4644")},isPollsFallbackExperienceEnabled:function(){return c("gkx")("23978")},isPreEstablishSessionEnabled:function(){return c("gkx")("23979")},isProgressiveJpegEnabledForDownload:function(){return c("justknobx")._("2411")},isProgressiveJpegSendEnabled:function(){return c("justknobx")._("2412")},isSenderKeyPredistributionEnabled:function(){return c("gkx")("23981")},isSharedWorkerContext:function(){return(h||(h=d("WorkerUtils"))).isSharedWorkerContext()},isStickerEnabled:function(){return c("justknobx")._("2618")},isUnsupportedMessagesRedesignEnabled:function(){return c("gkx")("1564")},jpegThumbnailTargetByteSizeKB:function(){return c("justknobx")._("2338")},maxPrekeysToUpload:function(){return 200},maxUsersForNotifyDeviceChange:function(){return d("WADbDeviceRegistration").MAX_USERS_FOR_NOTIFY_DEVICE_CHANGE},mediaDownloadDeduplication:function(){return c("gkx")("33150")},mediaTtlOnWhatsAppInfraInDays:function(){return c("justknobx")._("2715")},oneQueueTimeoutMs:function(){return c("justknobx")._("2583")},orchestratorVersion:function(){return c("getOrchestratorVersion")()},pjpegPreviewAvoidLastScan:function(){return c("justknobx")._("67")},sessionDropIfTooOld:function(){return c("justknobx")._("2240")},shouldDeviceStateTimesout:function(){return c("justknobx")._("2592")},skipDownloadablePreviewForProgressiveJpeg:function(){return c("justknobx")._("2371")},uiLayoutTriggeredMediaDownload:function(){return c("gkx")("4137")},useLongSessionDrop:function(){return c("gkx")("1244")},useProtocolMediaKey:function(){return c("gkx")("3718")},useUpdatedSenderKeySession:function(){return c("gkx")("23937")},waDanglingQueue:function(){return c("justknobx")._("1921")}};b={enableDocumentBackupAndRestore:function(){return c("gkx")("4805")},encryptForwardedMedia:function(){return c("gkx")("2983")},isEditMessageSendEnabled:function(){return!0},isMediaAssociatedXMAsEnabled:function(){return c("gkx")("4379")},isRavenMessagesEnabled:function(){return!0},isSaveThumbnailAsChunkEnabled:function(){return c("gkx")("9641")},productTypeForEBAttachments:"msgr",restoreExpiredMediaForNonMsgRestoreFlow:function(){return c("gkx")("4254")},skipExpiredDownload:function(){return c("gkx")("3981")},skipPreviewUploadForImages:function(){return c("gkx")("4951")},supportedTypesVersion:function(){return c("MAWGK").armadillo_web_process_futureproof?i+1:i},supportedXMATargetTypes:function(){return d("MAWParseXMAFBConfig").FB_SUPPORTED_TARGET_TYPES}};g.waConfig=a;g.mawConfig=b}),98);
__d("MAWConfig",["MAWMainWebWorkerConfig"],(function(a,b,c,d,e,f,g){"use strict";var h=d("MAWMainWebWorkerConfig").mawConfig;function a(){return h}function b(a){h=a}g.getConfig=a;g.setConfig=b}),98);
__d("MAWDexieCastToPromise",["Promise"],(function(a,b,c,d,e,f){"use strict";var g;function a(a){return(g||(g=b("Promise"))).resolve(a)}function c(a){return a}f.dexieCastToPromise=a;f.promiseCastToDexiePromise_I_KNOW_WHAT_I_AM_DOING=c}),66);
__d("MAWMediaAfterTxns",["MAWBridgeTypesCreators","MAWDbMedia","MAWDexieCastToPromise","MAWIndexedDb","MAWMediaUtils","MAWRavenUtils","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a,b){return{ephemeralMediaState:b,ephemeralMediaViewMode:d("MAWRavenUtils").getEphemeralMediaViewMode(a)}};function a(a,b,e,f){c("promiseDone")(d("MAWDexieCastToPromise").dexieCastToPromise(f.messages.where("msgId").anyOf(b.msgIds).toArray().then(function(g){var j=a.threadJid;g=d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(g,j);j=a.ravenEphemeralType!=null&&a.ravenEphemeralMediaState!=null?d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:j,filteredMsgIds:g,hasMediaForUI:e,media:b,ravenSettings:h(a.ravenEphemeralType,a.ravenEphemeralMediaState),sortOrderMs:a.sortOrderMs}):d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:j,filteredMsgIds:g,hasMediaForUI:e,media:b,sortOrderMs:a.sortOrderMs});c("gkx")("2616")===!0?i(f,j):d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:j})})))}function i(a,b,e){if(!j(b))return d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:b});c("promiseDone")(d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWMediaUtils").getBridgeMediaAnnotatedForDisplay(a,b,e).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:a})})))}function j(a){switch(a.mediaType){case d("MAWDbMedia").MEDIA_TYPE.IMAGE:case d("MAWDbMedia").MEDIA_TYPE.VIDEO:case d("MAWDbMedia").MEDIA_TYPE.GIF:case d("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE:return!0;default:return!1}}g.handleNewMediaAfterTxn=a;g.handleNewMediaAfterTxnWithBridgeMedia=i}),98);
__d("MAWMediaBackupTxns",["MAWDbMediaTxns","MAWDexieTable","Promise","WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fbid already exists for objectId"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mediaId or msgId cannot differ for an objectId in mediaBackup"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] ObjectId already shared by different msgId"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fbid already exists for objectId"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mediaId or msgId cannot differ for an objectId in mediaBackup"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry. Will attempt a retry. Error: ",""]);o=function(){return a};return a}var p=1;function q(a,b,e,f,g,h){h===void 0&&(h=0);return f==null?d("MAWDexieTable").dexieResolve():d("MAWDbMediaTxns").maybeGetMediaBackupRowFromObjectId(a,f).then(function(i){if(i==null){var j={mediaId:b,msgId:e,objectId:f};g!=null&&(j=babelHelpers["extends"]({},j,{fbid:g}));return a.mediaBackup.add(j).then(function(a){return babelHelpers["extends"]({},j,{mediaBackupId:a})})["catch"](function(i){if(i.name==="ConstraintError"){if(h<p){d("WALogger").WARN(o(),i);return q(a,b,e,f,g,h+1)}throw c("err")("Failed to add mediaBackup entry. Original error: %s, %s",i.name,i.message)}d("WALogger").ERROR(n(),i);throw i})}else if(i.mediaId!==b||i.msgId!==e){d("WALogger").ERROR(m());return i}else{if(i.fbid==null&&g!=null){var k=babelHelpers["extends"]({},i,{fbid:g});return a.mediaBackup.put(k).then(function(a){return k})}else d("WALogger").WARN(l());return i}})}function a(a,c){if(c==null)return d("MAWDexieTable").dexieResolve();var e=[];c.forEach(function(a){a=a.objectId;a!=null&&e.push(a)});return d("MAWDbMediaTxns").maybeGetMediaBackupRowsFromObjectIds(a,e).then(function(e){var f=new Map(),g=[];c.forEach(function(a){var b=a.objectId;if(b!=null){var c=e.get(b);if(c==null){var h={mediaId:a.mediaId,msgId:a.msgId,objectId:b},l=a.fbid;h=babelHelpers["extends"]({},h,{fbid:l});f.get(b)!=null&&((l=f.get(b))==null?void 0:l.msgId)!==a.msgId&&d("WALogger").ERROR(k());f.set(b,h)}else{c.mediaId!==a.mediaId&&d("WALogger").ERROR(j());l=a.fbid;if(c.fbid==null&&l!=null){b=babelHelpers["extends"]({},c,{fbid:l});g.push(b)}else d("WALogger").WARN(i())}}});return(h||(h=b("Promise"))).all([a.mediaBackup.bulkAdd([].concat(Array.from(f.values()))),a.mediaBackup.bulkPut(g)]).then(function(){})}).then(function(){})}g.linkMediaBackup=q;g.bulkLinkMediaBackup=a}),98);
__d("WASortedLists",[],(function(a,b,c,d,e,f){"use strict";function a(){return[]}function b(){return[]}function c(a,b){return a.filter(b)}function d(a,b){return l(a.map(b))}function e(a,b){var c=a.length===b.length;for(var d=0;c&&d<a.length;d++)a[d]!==b[d]&&(c=!1);return c}function g(a,b){for(var c=0;c<a.length;c++)if(a[c]===b)return a;return a.concat([b]).sort()}function h(a,b){if(a.length<b.length)return!1;var c=!0;for(var d=0,e=0;c&&e<b.length;e++)do c=a[d]===b[e];while(!c&&++d<a.length);return c}function i(a,b){var c=[];for(var d=0,e=0;d<a.length;d++){var f=a[d];while(e<b.length&&f>b[e])e++;(e===b.length||f<b[e])&&c.push(f)}return c}function j(a,b){var c=[],d=0,e=0;while(d<a.length&&e<b.length){var f=a[d],g=b[e];f<g?d++:f===g?(c.push(f),d++,e++):e++}return c}function k(a,b){var c=[],d=0,e=0;while(d<a.length&&e<b.length)a[d]<b[e]?c.push(a[d++]):a[d]===b[e]?(c.push(a[d++]),e++):c.push(b[e++]);while(d<a.length)c.push(a[d++]);while(e<b.length)c.push(b[e++]);return c}function l(a){return m(a.slice().sort())}function m(a){var b=!1;for(var c=0;c<a.length-1;c++)a[c]===a[c+1]&&(b=!0);if(!b)return a;c=[];for(b=0;b<a.length-1;b++)a[b]!==a[b+1]&&c.push(a[b]);c.push(a[a.length-1]);return c}function n(a){return Array.from(a).sort()}function o(a){return a.slice().sort()}function p(a,b,c){var d=null;for(var e=0;!d&&e<a.length;e++)a[e]===b&&(d=a.slice(),d[e]=c,d=m(d.sort()));return d||a}function q(a){return[a]}function r(a){return a.length<1}function s(a,b,c){return a.slice(b,c)}f.emptySet=a;f.emptyList=b;f.filter=c;f.map=d;f.areEqual=e;f.addToSet=g;f.contains=h;f.subtract=i;f.intersect=j;f.joinUniq=k;f.sortAndDedupe=l;f.asSortedSet=n;f.sort=o;f.swapIn=p;f.singleElement=q;f.isEmpty=r;f.slice=s}),66);
__d("MAWMediaManagementTxns",["FBLogger","MAWBridgeTypesCreators","MAWBridgeUpload","MAWCastToMsgrServerMediaType","MAWConfig","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieCastToPromise","MAWDexieTable","MAWIndexedDb","MAWMediaAfterTxns","MAWMediaBackupTxns","MAWMediaUtils","MAWMsgType","MAWSupportedDocumentTypes","MAWWriteMsgTxns","WAErrorMessage","WAJids","WALogger","WAMediaUtils","WASortedLists","WATagsLogger","WATimeUtils","err","gkx","isInstamadilloEB","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mediaBackup entry already exists for objectId ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same FBId assigned for different mediaIds. fbId: "," - shared by hashedPlaintextHashes: "," ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same objectId assigned for different mediaIds. objectId: "," shared by  hashedPlaintextHashes: "," ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][updateMediaWithEncodedMediaEntryData] media entry is missing, can't upate media with encoded data"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media entry is missing, can't update media info"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link. Possible duplicate? Will attempt a retry. Error: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link. Possible duplicate? Will attempt a retry. For plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry. Error: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry. For plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media found after retry for plaintextHash: ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missing mandatory args for incoming media msg"]);r=function(){return a};return a}var s=d("WATagsLogger").TAGS(["MAWMediaManagementTxns"]),t=c("gkx")("23924");function a(a,b,c,e){var f=c==null||b.type===d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE&&(t||!d("MAWSupportedDocumentTypes").isAllowedType((c=c.validatedDocumentFileInfo)==null?void 0:c.filename));return d("MAWWriteMsgTxns").prepareMsgWriteData(a,b,e).then(function(a){return babelHelpers["extends"]({},a,{shouldDropDocument:f})})}function b(a,b,e,f){f===void 0&&(f=!1);var g={validatedAudioInfo:b.validatedAudioInfo,validatedDocumentFileInfo:b.validatedDocumentFileInfo,validatedImageInfo:b.validatedImageInfo,validatedVideoInfo:b.validatedVideoInfo},h=d("MAWMediaUtils").genHMACPlaintextHash(b.plaintextHash),i=d("WAMediaUtils").decodeMediaEntryData(b.mediaEntry),j=i.objectId!=null?d("WAMediaUtils").stringToDeliveryObjectId(i.objectId):null;return d("MAWDexieTable").dexieAll([u(a,e,b.plaintextHash,b.mediaType,b.size,b.mediaEntry,g,j,void 0,f),d("MAWDbChunkTxns").hasMediaChunk(a,h)]).then(function(b){var c=b[0];b=b[1];e.type!==d("MAWMsgType").MSG_TYPE.REVOKED&&!f&&d("MAWMediaAfterTxns").handleNewMediaAfterTxn(e,c,b,a);return c}).then(function(a){var b=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(i.serverMediaType,f),g=i.mediaKeyTimestamp;if(d("MAWMsgType").isMAWSupportedMediaType(e.type)&&!c("isInstamadilloEB")()){var h=e.threadJid;j!=null&&b!=null&&h!=null&&g!=null&&(b!=="document"||d("MAWConfig").getConfig().enableDocumentBackupAndRestore())?d("MAWIndexedDb").afterTransaction({tag:"UploadAttachment",value:d("MAWBridgeUpload").createBridgeUploadAttachment(j,b,e.externalId,d("MAWConfig").getConfig().productTypeForEBAttachments,d("WAJids").threadIdForChatJid(h),h,g)}):d("WALogger").WARN(r())}return a})}function u(a,b,c,e,f,g,h,i,j,k){k===void 0&&(k=!1);return v(a,b,c,e,f,g,h,i,j,k).then(function(c){var e=k?d("MAWDexieTable").dexieResolve():d("MAWDbMsgTxns").updateMediaId(a,b,c.mediaId,c.plaintextHash);return e.then(function(){return d("MAWMediaBackupTxns").linkMediaBackup(a,c.mediaId,b.msgId,i,j).then(function(){return c})})})}function v(a,b,e,f,g,h,i,j,k,l,r){l===void 0&&(l=!1);r===void 0&&(r=0);return d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,e).then(function(t){var u=new Map(t==null?void 0:t.mediaEntries),w=z(h,j,k);w!=null&&u.set(b.msgId,w);if(t){r>0&&s.LOG(q(),e);t.msgIds||c("FBLogger")("messenger_e2ee_web").mustfix("Media missing msgIds: media type=%s",t.mediaType);t.mediaType||c("FBLogger")("messenger_e2ee_web").mustfix("Media missing mediaType: type=%s ; msg type=%s",f,b.type);var x=babelHelpers["extends"]({},t,i,{mediaEntries:u,mediaType:(w=t.mediaType)!=null?w:f,msgIds:d("WASortedLists").addToSet(t.msgIds||d("WASortedLists").emptySet(),b.msgId)});return a.media.put(x).then(function(){return x})}else{var y=d("MAWMediaUtils").genHMACPlaintextHash(e),A=babelHelpers["extends"]({fbid:(w=k)!=null?w:void 0,hashedPlaintextHash:y,mediaEntries:u,mediaType:f,msgIds:d("WASortedLists").singleElement(b.msgId),objectId:(t=j)!=null?t:void 0,plaintextHash:e,size:g,ts:d("WATimeUtils").unixTime()},i);return a.media.add(A).then(function(a){return babelHelpers["extends"]({},A,{mediaId:a})})["catch"](function(c){var q=d("WAErrorMessage").maybeGetMessageFromError(c);if(r>0){s.WARN(p(),e,y,q);s.ERROR(o(),q);throw c}else{s.WARN(n(),e,y,q);s.ERROR(m(),q);return v(a,b,e,f,g,h,i,j,k,l,r+1)}})}})}var w=function(a,b,e,f,g,h,i,j,k){k===void 0&&(k=!1);return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(b){if(b==null)throw c("err")("Do not have the media message in db when attachHashToMediaMsg");else return u(a,b,e,h,i,void 0,j,f,g,k)})},x=function(a,b,c){return d("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(a,b).then(function(b){if(b!=null){var d=babelHelpers["extends"]({},b);c.validatedAudioInfo!=null&&(d.validatedAudioInfo=babelHelpers["extends"]({},b.validatedAudioInfo,c.validatedAudioInfo));c.validatedVideoInfo!=null&&(d.validatedVideoInfo=babelHelpers["extends"]({},b.validatedVideoInfo,c.validatedVideoInfo));c.validatedImageInfo!=null&&(d.validatedImageInfo=babelHelpers["extends"]({},b.validatedImageInfo,c.validatedImageInfo));c.validatedDocumentFileInfo!=null&&(d.validatedDocumentFileInfo=babelHelpers["extends"]({},b.validatedDocumentFileInfo,c.validatedDocumentFileInfo));return a.media.update(d.mediaId,d).then(function(){})}else s.WARN(l())})},y=function(a,b,c,e){return d("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(a,b).then(function(b){if(b!=null){var f=e?b.mediaEntries.set(c,e):b.mediaEntries;b=babelHelpers["extends"]({},b,{mediaEntries:f});return a.media.update(b.mediaId,b)}else{s.ERROR(k());return d("MAWDexieTable").dexieResolve()}})};function e(a,b,c,e,f,g,h,i,j,k){k===void 0&&(k=!1);return d("MAWDexieTable").dexieAll([w(a,b,e,f,g,h,j.size,i,k),d("MAWDbChunkTxns").getOrCreateMediaChunk(a,e,c,j.type)]).then(function(a){a=a[0];return a})}function z(a,b,c){var e;a=a;a!=null&&b!=null&&(e=d("WAMediaUtils").decodeMediaEntryData(a),a=d("WAMediaUtils").encodeMediaEntryWithUpdatedObjectId(e,b));a!=null&&c!=null&&(e=d("WAMediaUtils").decodeMediaEntryData(a),a=d("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(e,c));return a}function f(a,b,c){var e=new Map();a.mediaEntries.forEach(function(a,f){var g=d("WAMediaUtils").decodeMediaEntryData(a);g=g.objectId===b?d("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(g,c):a;e.set(f,g)});return e}function A(a,b,c){var e=new Map();b.forEach(function(a){var b;b=(b=e.get(a.hashedPlaintextHash))!=null?b:[];b.push(a);e.set(a.hashedPlaintextHash,b)});return d("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(a,[].concat(Array.from(e.keys()))).then(function(f){var g=new Map(f.map(function(a){return[a.hashedPlaintextHash,a]})),h=new Map();b.forEach(function(a){var b=g.get(a.hashedPlaintextHash);if(a==null)return;var c=z(a==null?void 0:a.entry,a==null?void 0:a.objectId,a==null?void 0:a.fbId);if(b){var e=c?b.mediaEntries.set(a.msgId,c):b.mediaEntries;e=babelHelpers["extends"]({},b,{mediaEntries:e,msgIds:d("WASortedLists").addToSet(b.msgIds,a.msgId)});g.set(a.hashedPlaintextHash,e)}else I(h,a,c)});var i=new Map(),j=new Map();f=Array.from(h.values()).filter(function(a){return B(a,i,j)});return d("MAWDexieTable").dexieAll([a.media.bulkAdd(f),a.media.bulkPut(Array.from(g.values()))]).then(function(){return C(a,[].concat(Array.from(e.keys())),e,c)})})}function B(a,b,c){if(a.objectId!=null){var d=b.get(a.objectId);if(d!=null&&d!==a.hashedPlaintextHash){s.ERROR(j(),a.objectId,d,a.hashedPlaintextHash);return!1}}if(a.fbid!=null){d=c.get(a.fbid);if(d!=null&&d!==a.hashedPlaintextHash){s.ERROR(i(),a.fbid,d,a.hashedPlaintextHash);return!1}}a.objectId!=null&&b.set(a.objectId,a.hashedPlaintextHash);a.fbid!=null&&c.set(a.fbid,a.hashedPlaintextHash);return!0}function C(a,b,c,e){return d("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(a,b).then(function(b){return d("MAWDexieTable").dexieAll([F(a,b,c),d("MAWMediaBackupTxns").bulkLinkMediaBackup(a,G(b,c))]).then(function(){D(b,c,e,a);return b})})}function D(a,b,e,f){a.forEach(function(a){var g=b.get(a.hashedPlaintextHash);g!=null&&!E(g)&&c("promiseDone")(d("MAWDexieCastToPromise").dexieCastToPromise(f.messages.where("msgId").anyOf(a.msgIds).toArray().then(function(b){b=d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:e,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(b,e),hasMediaForUI:!1,media:a});c("gkx")("2616")===!0?d("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(f,b):d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:b})})))})}function E(a){return a.reduce(function(a,b){return a||b.isXMAShare},!1)}function F(a,b,c){b=b.reduce(function(a,b){var d;(d=c.get(b.hashedPlaintextHash))==null?void 0:d.filter(function(a){return a!=null&&!a.isXMAShare}).forEach(function(c){return a.set(c.msgId,b.mediaId)});return a},new Map());return d("MAWDbMsgTxns").bulkUpdateMediaId(a,b)}function G(a,b){var c=new Map();a.forEach(function(a){var d;d=(d=b.get(a.hashedPlaintextHash))!=null?d:[];d.forEach(function(b){c.has(b.objectId)?s.WARN(h(),b.objectId):b.objectId!=null&&c.set(b.objectId,{fbid:b.fbId,mediaId:a.mediaId,msgId:b.msgId,objectId:b.objectId})})});return Array.from(c.values())}function H(a,b){var c;a=a?new Map([[b.msgId,a]]):new Map();return babelHelpers["extends"]({fbid:(c=b.fbId)!=null?c:void 0,hashedPlaintextHash:b.hashedPlaintextHash,mediaEntries:a,mediaType:b.mediaType,msgIds:d("WASortedLists").singleElement(b.msgId),objectId:(c=b.objectId)!=null?c:void 0,plaintextHash:b.plaintextHash,size:b.size,ts:d("WATimeUtils").unixTime()},b.mediaInfo)}function I(a,b,c){var d=a.get(b.hashedPlaintextHash);d==null?a.set(b.hashedPlaintextHash,H(c,b)):(c!=null&&d.mediaEntries.set(b.msgId,c),d.msgIds.push(b.msgId))}g.prepareMediaWriteData=a;g.handleUnstoredDbMedia=b;g.linkMedia=u;g.createOrUpdateMediaRow=v;g.attachHashToMediaMsg=w;g.updateMediaEntryWithValidatedMediaInfo=x;g.updateMediaWithEncodedMediaEntryData=y;g.attachHashAndSaveMedia=e;g.updateBackupFbidInMediaEntries=f;g.bulkLinkMedia=A;g.linkMessageAndMediaBackupForMediaList=C}),98);
__d("WAGroupInviteUtils",[],(function(a,b,c,d,e,f){"use strict";function a(a){return a}f.toInviteCode=a}),66);
__d("WAPromiseBackoffs",["Promise","WAErr"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){if(a===0)return 0;var c=o(b.algo);for(var d=1;d<a;d++)c();return j(b,c())}function i(a){var b=a.relativeDelay,c=b===void 0?!1:b,d=null,e=o(a.algo);return function(){var b=d;if(b==null){d=c?Date.now():0;return 0}var f=j(a,e());if(c){var g=Date.now();b=g-b;b>0&&(f=Math.max(0,f-b));d=g}return f}}function d(a){var c=i(a);return function(a){return new(h||(h=b("Promise")))(function(b){var d=c();d>0?setTimeout(b,d,a):b(a)})}}function j(a,b){var c=a.max,d=a.min;a=a.jitter;a=a===void 0?.1:a;b=b;c!=null&&b>c&&(b=c);d!=null&&b<d&&(b=d);a!==0&&(b=Math.ceil(b*(1+a*Math.random())));return b}function k(a){var b=a.second-a.first,c=a.first-b;return function(){var a=b+c;c=b;b=a;return a}}function l(a){var b=a.base,c=b===void 0?2:b,d=a.first;return function(){var a=d;d*=c;return a}}function m(a){var b=a.delay;return function(){return b}}function n(a){var b=a.toMs;a=a.backoff;var c=o(a);return function(){return b(c())}}function o(a){switch(a.type){case"fibonacci":return k(a);case"exponential":return l(a);case"constant":return m(a);case"adjust":return n(a);default:a;throw c("WAErr")("makeTimeFunc unrecognized backoff "+a.type)}}g.getDelay=a;g.createTimer=i;g.createPromiseTimer=d}),98);
__d("WorkerRelayEnvironment",["ActorURIConfig","MAWCurrentUser","RelayAPIConfig","createRelayFBNetwork","createRelayFBNetworkFetch","err","relay-runtime"],(function(a,b,c,d,e,f,g){"use strict";var h=null;function a(){var a=i(d("MAWCurrentUser").getID());h={execute:a.execute};return h}function b(){if(h==null)throw c("err")("Relay worker environment not initialized");return h}function i(a,b){b={actorID:a,batchResponseChunks:!0,getAdditionalData:function(){var b={};a!=null&&(b[c("ActorURIConfig").PARAMETER_ACTOR]=a);c("RelayAPIConfig").useXController===!1&&c("RelayAPIConfig").accessToken!==""&&(b.access_token=c("RelayAPIConfig").accessToken);return b},graphURI:b};b=c("createRelayFBNetworkFetch")(b);var e=function(a,b,c){return d("relay-runtime").Observable.create(function(a){return a.complete()})};return c("createRelayFBNetwork")(b,e,null,null)}g.createWorkerRelayEnvironment=a;g.getWorkerRelayEnvironment=b}),98);/*FB_PKG_DELIM*/
__d("WAMediaTransport.pb",["WACommon.pb","WAProtoConst"],(function(a,b,c,d,e,f,g){var h;a={NONE:0,LQ_4K:1,HQ_4K:2};b={NONE:0,GIPHY:1,TENOR:2};c={TALKING_A:0,IDLE_A:1,TALKING_B:2,IDLE_B:3,BACKGROUND:4};e={UNKNOWN:0,OPUS:1};f={};var i={},j={},k={},l={},m={},n={},o={},p={},q={},r={},s={},t={},u={},v={},w={},x={},y={},z={},A={},B={},C={},D={},E={},F={};f.internalSpec={integral:[1,(h=d("WAProtoConst")).TYPES.MESSAGE,l],ancillary:[2,h.TYPES.MESSAGE,i]};i.internalSpec={fileLength:[1,h.TYPES.UINT64],mimetype:[2,h.TYPES.STRING],thumbnail:[3,h.TYPES.MESSAGE,j],objectId:[4,h.TYPES.STRING]};j.internalSpec={jpegThumbnail:[1,h.TYPES.BYTES],downloadableThumbnail:[2,h.TYPES.MESSAGE,k],thumbnailWidth:[3,h.TYPES.UINT32],thumbnailHeight:[4,h.TYPES.UINT32]};k.internalSpec={fileSha256:[1,h.TYPES.BYTES],fileEncSha256:[2,h.TYPES.BYTES],directPath:[3,h.TYPES.STRING],mediaKey:[4,h.TYPES.BYTES],mediaKeyTimestamp:[5,h.TYPES.INT64],objectId:[6,h.TYPES.STRING],thumbnailScansSidecar:[7,h.TYPES.BYTES],thumbnailScanLengths:[8,h.FLAGS.REPEATED|h.TYPES.UINT32]};l.internalSpec={fileSha256:[1,h.TYPES.BYTES],mediaKey:[2,h.TYPES.BYTES],fileEncSha256:[3,h.TYPES.BYTES],directPath:[4,h.TYPES.STRING],mediaKeyTimestamp:[5,h.TYPES.INT64]};m.internalSpec={integral:[1,h.TYPES.MESSAGE,o],ancillary:[2,h.TYPES.MESSAGE,n]};n.internalSpec={height:[1,h.TYPES.UINT32],width:[2,h.TYPES.UINT32],scansSidecar:[3,h.TYPES.BYTES],scanLengths:[4,h.FLAGS.REPEATED|h.TYPES.UINT32],midQualityFileSha256:[5,h.TYPES.BYTES],hdType:[6,h.TYPES.ENUM,a]};o.internalSpec={transport:[1,h.TYPES.MESSAGE,f]};p.internalSpec={integral:[1,h.TYPES.MESSAGE,r],ancillary:[2,h.TYPES.MESSAGE,q]};q.internalSpec={seconds:[1,h.TYPES.UINT32],caption:[2,h.TYPES.MESSAGE,d("WACommon.pb").MessageTextSpec],gifPlayback:[3,h.TYPES.BOOL],height:[4,h.TYPES.UINT32],width:[5,h.TYPES.UINT32],sidecar:[6,h.TYPES.BYTES],gifAttribution:[7,h.TYPES.ENUM,b]};r.internalSpec={transport:[1,h.TYPES.MESSAGE,f]};s.internalSpec={integral:[1,h.TYPES.MESSAGE,w],ancillary:[2,h.TYPES.MESSAGE,t]};t.internalSpec={seconds:[1,h.TYPES.UINT32],avatarAudio:[2,h.TYPES.MESSAGE,u]};u.internalSpec={poseId:[1,h.TYPES.UINT32],avatarAnimations:[2,h.FLAGS.REPEATED|h.TYPES.MESSAGE,v]};v.internalSpec={fileSha256:[1,h.TYPES.BYTES],fileEncSha256:[2,h.TYPES.BYTES],directPath:[3,h.TYPES.STRING],mediaKey:[4,h.TYPES.BYTES],mediaKeyTimestamp:[5,h.TYPES.INT64],objectId:[6,h.TYPES.STRING],animationsType:[7,h.TYPES.ENUM,c]};w.internalSpec={transport:[1,h.TYPES.MESSAGE,f],audioFormat:[2,h.TYPES.ENUM,e]};x.internalSpec={integral:[1,h.TYPES.MESSAGE,z],ancillary:[2,h.TYPES.MESSAGE,y]};y.internalSpec={pageCount:[1,h.TYPES.UINT32]};z.internalSpec={transport:[1,h.TYPES.MESSAGE,f]};A.internalSpec={integral:[1,h.TYPES.MESSAGE,C],ancillary:[2,h.TYPES.MESSAGE,B]};B.internalSpec={pageCount:[1,h.TYPES.UINT32],height:[2,h.TYPES.UINT32],width:[3,h.TYPES.UINT32],firstFrameLength:[4,h.TYPES.UINT32],firstFrameSidecar:[5,h.TYPES.BYTES],mustacheText:[6,h.TYPES.STRING],isThirdParty:[7,h.TYPES.BOOL],receiverFetchId:[8,h.TYPES.STRING]};C.internalSpec={transport:[1,h.TYPES.MESSAGE,f],isAnimated:[2,h.TYPES.BOOL],receiverFetchId:[3,h.TYPES.STRING]};D.internalSpec={integral:[1,h.TYPES.MESSAGE,F],ancillary:[2,h.TYPES.MESSAGE,E]};E.internalSpec={displayName:[1,h.TYPES.STRING]};F.internalSpec={vcard:[1,h.TYPES.STRING],downloadableVcard:[2,h.TYPES.MESSAGE,f],__oneofs__:{contact:["vcard","downloadableVcard"]}};g.IMAGE_TRANSPORT_ANCILLARY_HD_TYPE=a;g.VIDEO_TRANSPORT_ANCILLARY_ATTRIBUTION=b;g.AUDIO_TRANSPORT_ANCILLARY_AVATAR_AUDIO_ANIMATIONS_TYPE=c;g.AUDIO_TRANSPORT_INTEGRAL_AUDIO_FORMAT=e;g.WAMediaTransportSpec=f;g.WAMediaTransport$AncillarySpec=i;g.WAMediaTransport$Ancillary$ThumbnailSpec=j;g.WAMediaTransport$Ancillary$Thumbnail$DownloadableThumbnailSpec=k;g.WAMediaTransport$IntegralSpec=l;g.ImageTransportSpec=m;g.ImageTransport$AncillarySpec=n;g.ImageTransport$IntegralSpec=o;g.VideoTransportSpec=p;g.VideoTransport$AncillarySpec=q;g.VideoTransport$IntegralSpec=r;g.AudioTransportSpec=s;g.AudioTransport$AncillarySpec=t;g.AudioTransport$Ancillary$AvatarAudioSpec=u;g.AudioTransport$Ancillary$AvatarAudio$DownloadableAvatarAnimationsSpec=v;g.AudioTransport$IntegralSpec=w;g.DocumentTransportSpec=x;g.DocumentTransport$AncillarySpec=y;g.DocumentTransport$IntegralSpec=z;g.StickerTransportSpec=A;g.StickerTransport$AncillarySpec=B;g.StickerTransport$IntegralSpec=C;g.ContactTransportSpec=D;g.ContactTransport$AncillarySpec=E;g.ContactTransport$IntegralSpec=F}),98);
__d("validateMAWMediaAndComposeEntryForProtoMsg",["WAMediaUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){if(b==null)throw c("err")("DbMedia is null in validateMediaAndComposeEntryForProtoMsg");if(!b.msgIds.includes(a))throw c("err")("the media ("+b.mediaId+") is not linked to the msg ("+a+")");a=b.mediaEntries.get(a);if(a==null)throw c("err")("media entry not found in validateMediaAndComposeEntryForProtoMsg");var e=b.plaintextHash,f=d("WAMediaUtils").mediaEntryDataToRawData(e,a);e=["fileSha256","mediaKey","fileEncSha256","directPath","mediaKeyTimestamp"];a=e.filter(function(a){return f[a]==null});if(a.length>0)throw c("err")("missing fields in mediaEntryData: "+a.toString());return[b,f]}g["default"]=a}),98);
__d("MAWAsConsumerApplication",["I64","LSIntEnum","MAWDbMedia","MAWJids","MAWMsgType","MAWVault","WAAssertUnreachable","WAConsumerApplication.pb","WAGlobals","WAJids","WAMediaTransport.pb","encodeMAWDocumentFileMessage","encodeProtobuf","err","gkx","validateMAWMediaAndComposeEntryForProtoMsg"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j="image/jpeg",k="video/mp4",l="audio/wav",m="image/gif",n="image/webp",o=c("gkx")("4644")?"application/octet-stream":"application/pdf",p=new ArrayBuffer(0);function a(a,b,e){switch(a.type){case d("MAWMsgType").MSG_TYPE.TEXT:return r(a);case d("MAWMsgType").MSG_TYPE.IMAGE:return s(a,b);case d("MAWMsgType").MSG_TYPE.VIDEO:return z(a,b);case d("MAWMsgType").MSG_TYPE.PTT:return C(a,b);case d("MAWMsgType").MSG_TYPE.REVOKED:return F(a);case d("MAWMsgType").MSG_TYPE.GIF:return z(a,b);case d("MAWMsgType").MSG_TYPE.STICKER:return w(a,b);case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return c("encodeMAWDocumentFileMessage")(a,b);case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE:case d("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION:return null;case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:throw c("err")("Implemented ephemeral setting message in MAWAsConsumerApplication");case d("MAWMsgType").MSG_TYPE.XMA:throw c("err")("XMA content message is not consumer application. It should be addressed as ArmadilloApplication");case d("MAWMsgType").MSG_TYPE.FUTUREPROOF:case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:case d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case d("MAWMsgType").MSG_TYPE.ADMIN:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:case d("MAWMsgType").MSG_TYPE.ICDC_ALERT:case d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:throw c("err")("We do not support converting to protoMsg with "+a.type+" type","maw_db");case d("MAWMsgType").MSG_TYPE.RAVEN:case d("MAWMsgType").MSG_TYPE.RAVEN_ACTION:throw c("err")("Raven content message is not consumer application. It should be addressed as ArmadilloApplication");case d("MAWMsgType").MSG_TYPE.EDIT_ACTION:throw c("err")("We do not support editing messages right now since the sending flow is not implemented yet. ");case d("MAWMsgType").MSG_TYPE.GROUP_INVITE:return G(a,e);case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:throw c("err")("Sending bump messages is not supported yet.");default:return c("WAAssertUnreachable")(a.type)}}function b(a,b){if(b==null)return q(a);else switch(b.mediaType){case d("MAWDbMedia").MEDIA_TYPE.IMAGE:return t(a.msgId,b);case d("MAWDbMedia").MEDIA_TYPE.VIDEO:return A(a.msgId,b);case d("MAWDbMedia").MEDIA_TYPE.PTT:return D(a.msgId,b);case d("MAWDbMedia").MEDIA_TYPE.GIF:return A(a.msgId,b);case d("MAWDbMedia").MEDIA_TYPE.STICKER:return x(a.msgId,b);default:return null}}function q(a){var b=null;if(a.type===d("MAWMsgType").MSG_TYPE.REVOKED&&a.msgContent!=null&&a.msgContent.content!=null)b=a.msgContent.content;else if(a.type===d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME&&a.msgContent!=null)b=a.msgContent;else return null;return{payload:{content:{messageText:{mentionedJid:[],text:d("MAWVault").unvault(b)}}}}}function r(a){var b={payload:{content:{messageText:{mentionedJid:a.msgContent.mentionedJids,text:d("MAWVault").unvault(a.msgContent.content)}}}};if(a.specialTextSize!=null){a=a.specialTextSize===1?d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.SMALL:a.specialTextSize===2?d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.MEDIUM:d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.LARGE;b.metadata={specialTextSize:a}}return b}function s(a,b){return t(a.msgId,b)}function t(a,b){a=c("validateMAWMediaAndComposeEntryForProtoMsg")(a,b);b=a[0];a=a[1];return v(b,a)}function u(a,b){var c;a={ancillary:{height:(c=a.validatedImageInfo)==null?void 0:c.height,scanLengths:((c=b.progressiveJpegDetails)==null?void 0:c.scanLengths)||[],scansSidecar:(c=b.progressiveJpegDetails)==null?void 0:c.sidecar,width:(c=a.validatedImageInfo)==null?void 0:c.width},integral:{transport:{ancillary:{fileLength:a.size,mimetype:j,objectId:b.objectId,thumbnail:{downloadableThumbnail:b.downloadableThumbnail,jpegThumbnail:void 0,thumbnailHeight:(c=a.validatedImageInfo)==null?void 0:c.jpegThumbnailHeight,thumbnailWidth:(c=a.validatedImageInfo)==null?void 0:c.jpegThumbnailWidth}},integral:{directPath:b.directPath,fileEncSha256:b.fileEncSha256,fileSha256:b.fileSha256,mediaKey:b.mediaKey,mediaKeyTimestamp:b.mediaKeyTimestamp}}}};return d("encodeProtobuf").encodeProtobuf(d("WAMediaTransport.pb").ImageTransportSpec,a).readBuffer()}function v(a,b){a=u(a,b);return{payload:{content:{imageMessage:{caption:{mentionedJid:[]},image:{payload:a,version:1}}}}}}function e(a){return{payload:{content:{editMessage:{key:{fromMe:!0,id:a.originalMsgExternalId,remoteJid:a.threadJid},message:{mentionedJid:a.msgContent.mentionedJids,text:d("MAWVault").unvault(a.msgContent.content)},timestampMs:a.editTs*1e3}}}}}function w(a,b){return x(a.msgId,b)}function x(a,b){a=c("validateMAWMediaAndComposeEntryForProtoMsg")(a,b);b=a[0];a=a[1];return y(b,a)}function y(a,b){var c;a={ancillary:{height:(c=a.validatedImageInfo)==null?void 0:c.height,width:(c=a.validatedImageInfo)==null?void 0:c.width},integral:{transport:{ancillary:{fileLength:a.size,mimetype:n,objectId:b.objectId,thumbnail:{thumbnailHeight:(c=a.validatedImageInfo)==null?void 0:c.jpegThumbnailHeight,thumbnailWidth:(c=a.validatedImageInfo)==null?void 0:c.jpegThumbnailWidth}},integral:{directPath:b.directPath,fileEncSha256:b.fileEncSha256,fileSha256:b.fileSha256,mediaKey:b.mediaKey,mediaKeyTimestamp:b.mediaKeyTimestamp}}}};c=d("encodeProtobuf").encodeProtobuf(d("WAMediaTransport.pb").StickerTransportSpec,a);return{payload:{content:{stickerMessage:{sticker:{payload:c.readBuffer(),version:1}}}}}}function z(a,b){return A(a.msgId,b)}function A(a,b){a=c("validateMAWMediaAndComposeEntryForProtoMsg")(a,b);b=a[0];a=a[1];return B(b,a)}function B(a,b){var c,e=a.mediaType===d("MAWDbMedia").MEDIA_TYPE.GIF,f=e?a.validatedImageInfo:a.validatedVideoInfo;c={ancillary:{gifPlayback:e,height:f==null?void 0:f.height,seconds:e?void 0:(c=a.validatedVideoInfo)==null?void 0:c.duration,sidecar:b.sidecar,width:f==null?void 0:f.width},integral:{transport:{ancillary:{fileLength:a.size,mimetype:e?m:k,objectId:b.objectId,thumbnail:e?{thumbnailHeight:f==null?void 0:f.jpegThumbnailHeight,thumbnailWidth:f==null?void 0:f.jpegThumbnailWidth}:{downloadableThumbnail:b.downloadableThumbnail,jpegThumbnail:void 0,thumbnailHeight:f==null?void 0:f.jpegThumbnailHeight,thumbnailWidth:f==null?void 0:f.jpegThumbnailWidth}},integral:{directPath:b.directPath,fileEncSha256:b.fileEncSha256,fileSha256:b.fileSha256,mediaKey:b.mediaKey,mediaKeyTimestamp:b.mediaKeyTimestamp}}}};a=d("encodeProtobuf").encodeProtobuf(d("WAMediaTransport.pb").VideoTransportSpec,c);return{payload:{content:{videoMessage:{caption:{mentionedJid:[]},video:{payload:a.readBuffer(),version:1}}}}}}function C(a,b){return D(a.msgId,b)}function D(a,b){a=c("validateMAWMediaAndComposeEntryForProtoMsg")(a,b);b=a[0];a=a[1];return E(b,a)}function E(a,b){var e;e={ancillary:{seconds:(e=a.validatedAudioInfo)==null?void 0:e.duration},integral:{audioFormat:c("gkx")("3532")?d("WAMediaTransport.pb").AUDIO_TRANSPORT_INTEGRAL_AUDIO_FORMAT.OPUS:void 0,transport:{ancillary:{fileLength:a.size,mimetype:l,objectId:b.objectId,thumbnail:{jpegThumbnail:p}},integral:{directPath:b.directPath,fileEncSha256:b.fileEncSha256,fileSha256:b.fileSha256,mediaKey:b.mediaKey,mediaKeyTimestamp:b.mediaKeyTimestamp}}}};a=d("encodeProtobuf").encodeProtobuf(d("WAMediaTransport.pb").AudioTransportSpec,e);return{payload:{content:{audioMessage:{audio:{payload:a.readBuffer(),version:1},ptt:!0}}}}}function F(a){return{payload:{applicationData:{revoke:{key:{fromMe:!0,id:a.revokedExternalId}}}}}}function f(a){var b=d("WAJids").isAuthorMe(a.reactToAuthor)||d("WAGlobals").getMyUserJid()===a.reactToAuthor,c=d("WAJids").interpretAsGroupJid(a.threadJid)!=null;c={groupingKey:a.groupingKey==null?void 0:a.groupingKey,key:{fromMe:b,id:a.reactToExternalId,participant:c&&!b?a.reactToAuthor:void 0,remoteJid:a.threadJid},senderTimestampMs:a.ts*1e3,text:a.reaction==null?void 0:a.reaction};return{payload:{content:{reactionMessage:c}}}}function G(a,b){if(a.threadJid==null)throw c("err")("msg threadJid is null in encodeGroupInviteMessage");if(b==null)throw c("err")("DbGroupInvite is null in encodeGroupInviteMessage");var e=d("WAJids").interpretAsGroupJid(a.threadJid);if(e==null)throw c("err")("groupJid is null in encodeGroupInviteMessage");return{payload:{content:{groupInviteMessage:{groupJid:e,groupName:a.groupName,inviteCode:b.inviteCode,inviteExpiration:b.inviteExpirationTs}}}}}function H(a){return(h||(h=d("I64"))).equal(a.displayedContentTypes,(i||(i=d("LSIntEnum"))).ofNumber(1))||(h||(h=d("I64"))).equal(a.displayedContentTypes,(i||(i=d("LSIntEnum"))).ofNumber(256))||a.textHasLinks||a.isUnsent?I(a):null}function I(a){var b;b=(b=a.mentionIds)==null?void 0:(b=b.split(","))==null?void 0:b.map(d("MAWJids").toUserJid);return{payload:{content:{messageText:{mentionedJid:(b=b)!=null?b:[],text:a.text}}}}}g.IMAGE_MIME_TYPE=j;g.VIDEO_MIME_TYPE=k;g.AUDIO_MIME_TYPE=l;g.GIF_MIME_TYPE=m;g.STICKER_MIME_TYPE=n;g.FILE_MIME_TYPE=o;g.emptyAudioFileArrayBuffer=p;g.asConsumerApplication=a;g.deletedMsgAsConsumerApplicationForSpamReporting=b;g.encodeValidatedMediaToImageTransport=u;g.encodeEditMessage=e;g.encodeReactionMessage=f;g.asConsumerApplicationLSDb=H}),98);
__d("encodeMAWDocumentFileMessage",["MAWAsConsumerApplication","WAMediaTransport.pb","encodeProtobuf","validateMAWMediaAndComposeEntryForProtoMsg"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return h(a.msgId,b)}function h(a,b){a=c("validateMAWMediaAndComposeEntryForProtoMsg")(a,b);b=a[0];a=a[1];return i(b,a)}function i(a,b){b={ancillary:{},integral:{transport:{ancillary:{fileLength:a.size,mimetype:d("MAWAsConsumerApplication").FILE_MIME_TYPE,objectId:b.objectId,thumbnail:{jpegThumbnail:new ArrayBuffer(1),thumbnailHeight:1,thumbnailWidth:1}},integral:{directPath:b.directPath,fileEncSha256:b.fileEncSha256,fileSha256:b.fileSha256,mediaKey:b.mediaKey,mediaKeyTimestamp:b.mediaKeyTimestamp}}}};b=d("encodeProtobuf").encodeProtobuf(d("WAMediaTransport.pb").DocumentTransportSpec,b);return{payload:{content:{documentMessage:{document:{payload:b.readBuffer(),version:1},fileName:(b=a.validatedDocumentFileInfo)==null?void 0:b.filename}}}}}g["default"]=a}),98);
__d("MAWCastToServerMediaType",[],(function(a,b,c,d,e,f){"use strict";function a(a){switch(a){case"document":case"image":case"xma-image":case"video":case"ptt":case"gif":case"sticker":return a;default:return null}}f.castToServerMediaType=a}),66);
__d("MAWConvertExtendedContentOverlayIconGlyphToXMAGatingType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid ExtendedContentOverlayIconGlyph: ",""]);h=function(){return a};return a}function a(a){switch(a){case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.INFO:return d("EchoMessageXMAFieldUtils").XMAGatingType.INFO;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.EYE_OFF:return d("EchoMessageXMAFieldUtils").XMAGatingType.EYE_OFF;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NEWS_OFF:return d("EchoMessageXMAFieldUtils").XMAGatingType.NEWS_OFF;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.WARNING:return d("EchoMessageXMAFieldUtils").XMAGatingType.WARNING;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.PRIVATE:return d("EchoMessageXMAFieldUtils").XMAGatingType.PRIVATE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE:return d("EchoMessageXMAFieldUtils").XMAGatingType.NONE;default:d("WALogger").ERROR(h(),a);return d("EchoMessageXMAFieldUtils").XMAGatingType.NONE}}g.convertExtendedContentOverlayIconGlyphToXMAGatingType=a}),98);
__d("MAWConvertExtendedContentTargetTypeToXMATargetType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid ExtendedContentTargetType: ",""]);h=function(){return a};return a}function a(a){switch(a){case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION:return d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_MENTION;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE:return d("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_IMAGE_POST_SHARE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE:return d("EchoMessageXMAFieldUtils").XMAContentType.IG_MULTIPOST_SHARE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE:return d("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_VIDEO_POST_SHARE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE:return d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_SHARE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE:return d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_SHARE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE:return d("EchoMessageXMAFieldUtils").XMAContentType.IG_CLIPS_SHARE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE:return d("EchoMessageXMAFieldUtils").XMAContentType.IG_IGTV_SHARE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE:return d("EchoMessageXMAFieldUtils").XMAContentType.IG_SHOP_SHARE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE:return d("EchoMessageXMAFieldUtils").XMAContentType.IG_PROFILE_SHARE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE:return d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_HIGHLIGHT_SHARE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE:return d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_HIGHLIGHT_SHARE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY:return d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REPLY;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION:return d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REACTION;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE:return d("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_SHARE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY:return d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_REPLY;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE:return d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_SHARE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION:return d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_MENTION;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE:return d("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_VIDEO_SHARE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE:return d("EchoMessageXMAFieldUtils").XMAContentType.FB_GAMING_CUSTOM_UPDATE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY:return d("EchoMessageXMAFieldUtils").XMAContentType.FB_PRODUCER_STORY_REPLY;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE:return d("EchoMessageXMAFieldUtils").XMAContentType.MSG_EXTERNAL_LINK_SHARE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL:return d("EchoMessageXMAFieldUtils").XMAContentType.RTC_AUDIO_CALL;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL:return d("EchoMessageXMAFieldUtils").XMAContentType.RTC_VIDEO_CALL;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL:return d("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_AUDIO_CALL;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL:return d("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_VIDEO_CALL;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL:return d("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_AUDIO_CALL;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL:return d("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_VIDEO_CALL;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT:return d("EchoMessageXMAFieldUtils").XMAContentType.FB_EVENT;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH:return d("EchoMessageXMAFieldUtils").XMAContentType.MSG_RECEIVER_FETCH;default:d("WALogger").ERROR(h(),a);return d("EchoMessageXMAFieldUtils").XMAContentType.NONE}}g.convertExtendedContentTargetTypeToXMATargetType=a}),98);
__d("MAWConvertExtendedContentXMLLayoutTypeToXMALayoutType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid ExtendedContentXMLLayoutType: ",""]);h=function(){return a};return a}function a(a){switch(a){case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE:return d("EchoMessageXMAFieldUtils").XMALayoutType.SINGLE;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.PORTRAIT:return d("EchoMessageXMAFieldUtils").XMALayoutType.PORTRAIT;default:d("WALogger").ERROR(h(),a);return d("EchoMessageXMAFieldUtils").XMALayoutType.SINGLE}}g.convertExtendedContentXMLLayoutTypeToXMALayoutType=a}),98);
__d("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaGatingType: ",""]);h=function(){return a};return a}function a(a){switch(a){case d("EchoMessageXMAFieldUtils").XMAGatingType.INFO:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.INFO;case d("EchoMessageXMAFieldUtils").XMAGatingType.EYE_OFF:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.EYE_OFF;case d("EchoMessageXMAFieldUtils").XMAGatingType.NEWS_OFF:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NEWS_OFF;case d("EchoMessageXMAFieldUtils").XMAGatingType.WARNING:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.WARNING;case d("EchoMessageXMAFieldUtils").XMAGatingType.PRIVATE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.PRIVATE;case d("EchoMessageXMAFieldUtils").XMAGatingType.NONE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE;default:d("WALogger").ERROR(h(),a);return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE}}g.convertXMAGatingTypeToExtendedContentOverlayIconGlyph=a}),98);
__d("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaLayoutType: ",""]);h=function(){return a};return a}function a(a){switch(a){case d("EchoMessageXMAFieldUtils").XMALayoutType.SINGLE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE;case d("EchoMessageXMAFieldUtils").XMALayoutType.PORTRAIT:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.PORTRAIT;default:d("WALogger").ERROR(h(),a);return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE}}g.convertXMALayoutTypeToExtendedContentXMLLayoutType=a}),98);
__d("MAWDownloadManager",[],(function(a,b,c,d,e,f){"use strict";var g=1e4;a=function(){function a(){this.$1=[],this.$2=new Map()}var b=a.prototype;b.setToDownloadManager=function(a,b){this.$3(),this.$2.set(a,b),this.$1.push(a)};b.getFromDownloadManager=function(a){return this.$2.get(a)};b.removeFromMediaDownloadManager=function(a){this.$2["delete"](a);var b=this.$1.filter(function(b){return b!==a});this.setDownloadManagerQueue(b)};b.setDownloadManagerQueue=function(a){this.$1=a};b.$3=function(){if(this.$1.length>=g){var a=this.$1.shift();this.$2["delete"](a)}};return a}();f.DownloadManager=a}),66);
__d("MAWGetAttachmentTypeForServerMediaType",["EchoMessageMediaFieldUtils","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid AttachmentType: ",""]);h=function(){return a};return a}function a(a){switch(a){case"image":return d("EchoMessageMediaFieldUtils").AttachmentType.IMAGE;case"video":return d("EchoMessageMediaFieldUtils").AttachmentType.VIDEO;case"ptt":return d("EchoMessageMediaFieldUtils").AttachmentType.PTT;case"gif":return d("EchoMessageMediaFieldUtils").AttachmentType.GIF;case"sticker":return d("EchoMessageMediaFieldUtils").AttachmentType.STICKER;case"xma-image":return d("EchoMessageMediaFieldUtils").AttachmentType.XMA;case"document":return d("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT;default:d("WALogger").WARN(h(),a);return null}}g.getAttachmentTypeForServerMediaType=a}),98);
__d("MAWGetMediaAttachmentTypeForServerMediaType",["EchoMessageMediaFieldUtils","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid EchoMessageActMediaAttachmentType: ",""]);h=function(){return a};return a}function a(a){switch(a){case"image":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE;case"video":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO;case"ptt":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.PTT;case"gif":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF;case"sticker":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER;case"audio":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.AUDIO;case"document":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.DOCUMENT;case"ppic":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.PROFILE_PICTURE;case"md-app-state":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.APP_STATE;case"md-msg-hist":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.HISTORY_SYNC;case"thumbnail-image":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.THUMBNAIL_IMAGE;case"thumbnail-video":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.THUMBNAIL_VIDEO;case"thumbnail-gif":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.THUMBNAIL_GIF;case"thumbnail-document":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.THUMBNAIL_DOCUMENT;case"thumbnail-link":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.THUMBNAIL_LINK;case"novi-video":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.NOVI_VIDEO;case"novi-image":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.NOVI_IMAGE;case"xma-image":return d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.XMA_IMAGE;default:d("WALogger").ERROR(h(),a);return null}}g.getMediaAttachmentTypeForServerMediaType=a}),98);
__d("MAWOptimisticUploadManager",[],(function(a,b,c,d,e,f){"use strict";var g=new Map();function a(){return g}function b(){g.clear()}f.getOptimisticUploadManager=a;f.clearOptimisticUploadManager=b}),66);
__d("MAWGetMediaPlaintextApi",["MAWIndexedDb","MAWMediaUtils","MAWOptimisticUploadManager","MAWTransactionMode","Promise","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media blob does not exist for the given hashedPlaintextHash"]);i=function(){return a};return a}a=function(a){var c=d("MAWOptimisticUploadManager").getOptimisticUploadManager();c=c.get(a);if(c==null)return j(a);else return(h||(h=b("Promise"))).resolve(c.file)};function j(a){return d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY},"getMediaPlaintextFromDb",function(a){return function(b){b=d("MAWMediaUtils").genHMACPlaintextHash(b);return a.chunk.where("hashedPlaintextHash").equals(b).first().then(function(a){if(!a){d("WALogger").WARN(i());return null}return new Blob([a.blobData],{type:a.mimetype})})}})(a)}g.getMediaPlaintext=a}),98);
__d("MAWGetPreviewContentTypeForMediaType",["EchoMessageMediaFieldUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){switch(a){case"image":return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG;case"gif":return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.GIF;case"sticker":return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.STICKER;case"video":return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_MP4;case"ptt":return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_WAV;case"xma-image":return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG;default:return null}}g.getPreviewContentTypeForMediaType=a}),98);
__d("MAWMediaDownloadManager",["MAWDownloadManager"],(function(a,b,c,d,e,f,g){"use strict";var h=new(d("MAWDownloadManager").DownloadManager)(),i=new(d("MAWDownloadManager").DownloadManager)();function a(a,b){h.setToDownloadManager(a,b)}function b(a){return h.getFromDownloadManager(a)}function c(a){h.removeFromMediaDownloadManager(a)}function e(a,b){i.setToDownloadManager(a,b)}function f(a){return i.getFromDownloadManager(a)}function j(a){i.removeFromMediaDownloadManager(a)}g.setToMediaDownloadManager=a;g.getFromMediaDownloadManager=b;g.removeFromMediaDownloadManager=c;g.setToMediaPlaintextDownloadManager=e;g.getFromMediaPlaintextDownloadManager=f;g.removeFromMediaPlaintextDownloadManager=j}),98);
__d("MAWHandleMediaDownloadApi",["MAWBridgeTypesCreators","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWLoggerUtils","MAWMediaAfterTxns","MAWMediaDownloadManager","MAWMediaUtils","MAWMsgType","MAWTransactionMode","MAWXMAUtils","Promise","WAArmadilloXMA.pb","WAResultOrError","WATagsLogger","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media is null when storing downloaded blob"]);i=function(){return a};return a}var j=d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.MediaDownload,d("MAWLoggerUtils").Tag.MessageReceive]);e=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READWRITE,media:a.READWRITE,messages:a.READONLY,threads:a.READONLY,xma:a.READONLY},"handleMediaDownload",function(a){return function(e,f,g,l){var m=d("MAWMediaUtils").genHMACPlaintextHash(e);return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,l),a.media.where("hashedPlaintextHash").equals(m).first(),d("MAWDbChunkTxns").getOrCreateMediaChunk(a,e,g,f)]).then(function(l){var m=l[0],n=l[1];l[2];if(n==null){j.ERROR(i());return d("WAResultOrError").makeError("missing-media-on-save")}c("gkx")("2419")?l=d("MAWMediaDownloadManager").getFromMediaPlaintextDownloadManager(e):l=d("MAWMediaDownloadManager").getFromMediaDownloadManager(n.mediaId);l!=null&&(l((h||(h=b("Promise"))).resolve(new Blob([g],{type:f}))),c("gkx")("2419")?d("MAWMediaDownloadManager").removeFromMediaPlaintextDownloadManager(e):d("MAWMediaDownloadManager").removeFromMediaDownloadManager(n.mediaId));return k(a,m).then(function(b){if(!b)return a.messages.where("msgId").anyOf(n.msgIds).toArray().then(function(b){return a.threads.where("jid").anyOf(b.map(function(a){return a.threadJid})).toArray().then(function(e){e.forEach(function(e){if(e!=null){e=d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:e.jid,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(b,e.jid),hasMediaForUI:!0,media:n,sortOrderMs:m==null?void 0:m.sortOrderMs});c("gkx")("2616")===!0?d("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(a,e,b):d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:e})}})})});else if(c("gkx")("821"))return a.messages.where("msgId").anyOf(n.msgIds).toArray().then(function(b){return a.threads.where("jid").anyOf(b.map(function(a){return a.threadJid})).toArray().then(function(e){e.forEach(function(e){if(e!=null)return d("MAWDbXMATxns").getXMAFromMsgs(a,b).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){if(d("MAWXMAUtils").isXMAStoryReply(b.targetType))return;if(b.defaultPreviewMediaId!==n.mediaId)return;c("promiseDone")(d("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(n,b,a))}))})})})})}).then(function(){return d("MAWDbMediaTxns").updateMedia(a,n,{size:g.byteLength})}).then(function(){return d("WAResultOrError").makeResult()})})}});function k(a,b){var c;if(b==null)return d("MAWDexieTable").dexieResolve(!1);if(b.type===d("MAWMsgType").MSG_TYPE.XMA)return d("MAWDexieTable").dexieResolve(!0);return((c=b.quote)==null?void 0:c.content.xmaMessageType)===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY?d("MAWDexieTable").dexieResolve(b.type===d("MAWMsgType").MSG_TYPE.TEXT):d("MAWDbXMATxns").maybeGetXMAFromAssociatedMsgId(a,b.msgId).then(function(a){return a!=null})}g.handleMediaDownload=e}),98);
__d("MAWMediaPreviewDownloadManager",["WAResolvable"],(function(a,b,c,d,e,f,g){"use strict";var h=1e4,i=[],j=new Map();function a(a){if(j.has(a))return;k();var b=new(d("WAResolvable").Resolvable)();j.set(a,b);i.push(a)}function b(a){return j.get(a)}function c(a){j["delete"](a)}function k(){if(i.length>=h){var a=i.shift();j["delete"](a)}}function e(){i=[],j.clear()}g.markMediaPreviewAsDownloading=a;g.getMediaPreviewDownloadingResolvable=b;g.removeMediaPreviewDownloadingResolvable=c;g.clear=e}),98);
__d("MAWHandleMediaPreviewBeforeDownloadApi",["MAWMediaPreviewDownloadManager","Promise"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(a){d("MAWMediaPreviewDownloadManager").markMediaPreviewAsDownloading(a);return(h||(h=b("Promise"))).resolve()};g.handleMediaPreviewBeforeDownload=a}),98);
__d("MAWHandleMediaPreviewDownloadApi",["MAWBridgeTypesCreators","MAWConfig","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLoggerUtils","MAWMediaAfterTxns","MAWMediaPreviewDownloadManager","MAWTransactionMode","WACryptoSha256","WAHashUtils","WALoggerTag","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Main media for preview is null. Type: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handling preview for main hash ","... preview hash ","..."]);i=function(){return a};return a}var j=d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.MediaDownload,d("MAWLoggerUtils").Tag.MessageReceive,c("WALoggerTag").MediaPreview]);a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e){var f=d("WAHashUtils").toPlaintextHash(yield d("WACryptoSha256").sha256(b)),g=d("MAWMediaPreviewDownloadManager").getMediaPreviewDownloadingResolvable(a);g!=null&&(g.resolve(new Blob([b],{type:"image/jpeg"})),d("MAWMediaPreviewDownloadManager").removeMediaPreviewDownloadingResolvable(a));return k(a,f,b,c,e)});return function(b,c,d,e){return a.apply(this,arguments)}}();var k=d("MAWIndexedDb").makeMsgrTransactor({chunk:(e=d("MAWTransactionMode")).READWRITE,media:e.READWRITE,messages:e.READONLY,threads:e.READONLY},"handleMediaPreviewDownload",function(a){return function(b,e,f,g,k){return d("MAWDexieTable").dexieAll([d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,b),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,k),l(a,e,f)]).then(function(k){var l=k[0],m=k[1];k[2];j.LOG(i(),d("WAHashUtils").sanitisePlaintextHash(b),d("WAHashUtils").sanitisePlaintextHash(e));if(l==null){j.WARN(h(),g);return d("WAResultOrError").makeError("missing-media-on-save")}switch(g){case"image":a.media.update(l.mediaId,babelHelpers["extends"]({},l,{validatedImageInfo:babelHelpers["extends"]({},l.validatedImageInfo,{jpegThumbnail:f,thumbnailPlaintextHash:d("MAWConfig").getConfig().isSaveThumbnailAsChunkEnabled()?e:void 0})}));break;case"video":a.media.update(l.mediaId,babelHelpers["extends"]({},l,{validatedVideoInfo:babelHelpers["extends"]({},l.validatedVideoInfo,{jpegThumbnail:f,thumbnailPlaintextHash:d("MAWConfig").getConfig().isSaveThumbnailAsChunkEnabled()?e:void 0})}));break;default:g;break}return a.messages.where("msgId").anyOf(l.msgIds).toArray().then(function(b){return a.threads.where("jid").anyOf(b.map(function(a){return a.threadJid})).toArray().then(function(e){e.forEach(function(e){if(e!=null){e=d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:e.jid,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(b,e.jid),hasMediaForUI:!0,media:l,sortOrderMs:m==null?void 0:m.sortOrderMs});c("gkx")("2616")===!0?d("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(a,e,b):d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:e})}});return d("WAResultOrError").makeResult()})})})}});function l(a,b,c){return!d("MAWConfig").getConfig().isSaveThumbnailAsChunkEnabled()?d("MAWDexieTable").dexieResolve():d("MAWDbChunkTxns").getOrCreateMediaChunk(a,b,c,"image/jpeg").then(function(){return d("MAWDexieTable").dexieResolve()})}g.handleMediaPreviewDownload=a}),98);
__d("MAWMediaRetryInfo",[],(function(a,b,c,d,e,f){"use strict";var g=new Map();function a(a,b){g.set(a,b)}function b(a){return g.get(a)}function c(a){g.has(a)&&g["delete"](a)}f.setRetriedMediaInfo=a;f.getRetriedMediaInfo=b;f.clearRetriedMediaInfo=c}),66);
__d("MAWUpdateMediaEntryForMsgApi",["FBLogger","MAWBridgeUpload","MAWCastToMsgrServerMediaType","MAWCastToServerMediaType","MAWConfig","MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWMediaBackupTxns","MAWOptimisticUploadManager","MAWTransactionMode","WAJids","WALogger","WAMediaUtils","err","isInstamadilloEB"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missing required arguments for media backup"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Nothing to update if updatedMediaEntry is null"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose([""," msgId does not exist within media entries"]);j=function(){return a};return a}var k=d("MAWIndexedDb").makeMsgrTransactor({media:(a=d("MAWTransactionMode")).READWRITE,mediaBackup:a.READWRITE,messages:a.READONLY,threads:a.READONLY},"updateMediaEntryForMsg",function(a){return function(b,e,f,g,k){var l=d("MAWCastToServerMediaType").castToServerMediaType(k);if(!l){c("FBLogger")("labyrinth_web","unsupported_media").mustfix("unsupported media type");throw c("err")("Media type unsupported: "+((l=k)!=null?l:""))}return d("MAWDexieTable").dexieAll([d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,b),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,e)]).then(function(b){var l=b[0],m=b[1];if(!m)throw c("err")("Message does not exist for the given protocolMsgId");if(!l)throw c("err")("Media does not exist for the given hashedPlaintextHash");if(!l.msgIds.includes(m.msgId)){d("WALogger").LOG(j(),m.msgId);return}b=l.mediaEntries;var n=b.get(m.msgId);n=f(n);if(n==null){d("WALogger").LOG(i());return}b=babelHelpers["extends"]({},l,{mediaEntries:b.set(m.msgId,n)});g!=null&&(b=babelHelpers["extends"]({},b,{objectId:d("WAMediaUtils").stringToDeliveryObjectId(g)}));var o=d("WAMediaUtils").decodeMediaEntryData(n);return a.media.put(b).then(function(b){return g!=null?d("MAWMediaBackupTxns").linkMediaBackup(a,l.mediaId,m.msgId,d("WAMediaUtils").stringToDeliveryObjectId(g)):d("MAWDexieTable").dexieResolve()}).then(function(){var a=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(k),b=o.mediaKeyTimestamp;g!=null&&a!=null&&b!=null&&(a!=="document"||d("MAWConfig").getConfig().enableDocumentBackupAndRestore())&&!c("isInstamadilloEB")()?d("MAWIndexedDb").afterTransaction({tag:"UploadAttachment",value:d("MAWBridgeUpload").createBridgeUploadAttachment(g,a,e.externalId,d("MAWConfig").getConfig().productTypeForEBAttachments,d("WAJids").threadIdForChatJid(e.chat),m.threadJid,b)}):d("WALogger").WARN(h())})})}});b=function(a,b,c,d,e){l(a,c);return k(a,b,c,d,e)};function l(a,b){var c=d("MAWOptimisticUploadManager").getOptimisticUploadManager(),e=c.get(a);if(e==null)return;b=b();if(b==null)return;c.set(a,babelHelpers["extends"]({},e,{mediaEntry:b}))}g.updateMediaEntryForMsg=b}),98);
__d("WAAPI",["cr:9751"],(function(a,b,c,d,e,f,g){"use strict";g["default"]=b("cr:9751")}),98);
__d("WAIsMediaExpiredError",[],(function(a,b,c,d,e,f){"use strict";a=function(a){switch(a){case"media-key-expired":case"signature-expired":case"signature-expired-and-resign-failed-no-ids":case"signature-expired-and-resign-failed-cdn-url":return!0;case"missing-media-key-timestamp":case"hash-mismatch":case"ciphertext-hash-mismatch":case"enc-hash-mismatch":case"decryption-error":case"max-attempts-exceeded":case"request-error":case"download-throttled":case"media-not-found":case"media-entry-invalid":case"no-host":case"backoff":case"disconnected":case"runtime-error":return!1;default:a;return!0}};f.isMediaExpiredError=a}),66);
__d("MAWHandleEchoMediaMsgsRestoreV2",["EchoMessage","EchoMessageMediaFieldUtils","LSDataTraceCheckPoint","LSDataTraceType","LSIntEnum","MAWAsConsumerApplication","MAWBridge","MAWBridgeTypesCreators","MAWCastToMsgrServerMediaType","MAWConfig","MAWDbChunkTxns","MAWDbMediaTxns","MAWEBBackendQPLUtils","MAWFrontendMediaUtils","MAWGetMediaPlaintextApi","MAWHandleMediaDownloadApi","MAWHandleMediaPreviewBeforeDownloadApi","MAWHandleMediaPreviewDownloadApi","MAWIndexedDb","MAWJids","MAWMediaManagementTxns","MAWMediaRetryInfo","MAWMediaUtils","MAWQplProxy","MAWSupportedDocumentTypes","MAWTraceUtils","MAWTransactionMode","MAWUpdateMediaEntryForMsgApi","Promise","WAAPI","WABase64","WAGetStorageQplAnnotations","WAHashStringToNumber","WAHashUtils","WAIsMediaExpiredError","WAJids","WALogger","WAMediaUtils","WAStartMediaDownloadQplFlow","WATagsLogger","WATimeUtils","asyncToGeneratorRuntime","gkx","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot find the media entry for message with mediaKey ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot find the media entry for message with mediaKey ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media for message: "," is already downloaded on the device"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to construct downloadableThumbnail from previewMediaData: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Encrypted hash cannot be null for non-XMA attachments"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot download media - document extension is disallowed"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot download media - media content type null"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media entry is missing from index db. It is required to retry download by resigning cdn url"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["isPointRestore: ",""]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media download failed with error: "," "," when downloading. Message timestamp: ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Retry download media as signature has expired and should be renewed"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media download complete"]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] downloading media from MI directly"]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] start media download from whatsapp infra"]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash is null - unable to download thumbnail"]);x=function(){return a};return a}var y="media_restore";function z(a){var c=D(a);return c.then(function(c){var d=new Map();a.forEach(function(a){var b=c.get(a);b=b==null?void 0:b.blobData;d.set(a,b)});return(i||(i=b("Promise"))).resolve(d)})}function A(a){switch(a){case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG:return"image/jpeg";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_PNG:return"image/png";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.STICKER:return"image/webp";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.GIF:return"image/gif";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_MP4:return"audio/mp4";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_WAV:return"audio/wav";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.XMA:return"xma"}}function a(a,b,c){return B.apply(this,arguments)}function B(){B=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f){if(a.length===0)return(i||(i=b("Promise"))).resolve();var g=[],q=[],r=new Map(),s=new Map();a.map(function(a){var c=a.mediaData,e=a.messageTimestamp,f=F(c.plaintextHash),h=c.attachmentObjectId,j=c.attachmentType,k=c.backupEntFbid,l=c.directPath,t=c.filename,u=c.height,v=c.mediaContentType,w=c.mediaKeyTimestamp,x=c.mediaPlayableDuration,y=c.previewContentHeight,z=c.previewContentType,B=c.previewContentWidth,C=c.size;c=c.width;var D=d("WAHashUtils").stringToPlaintextHash(f),E=d("MAWMediaUtils").genHMACPlaintextHash(D);q.push(E);v=v!=null?d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(v,a.isXMA):z!=null?d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(A(z)):null;if(v==null){d("WALogger").ERROR(p());return(i||(i=b("Promise"))).resolve()}if(j===d("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT&&!d("MAWSupportedDocumentTypes").isAllowedType(t)){d("WALogger").LOG(o());return(i||(i=b("Promise"))).resolve()}z=a.mediaData.encryptedHash;if(z==null&&!a.isXMA){d("WALogger").ERROR(n());return(i||(i=b("Promise"))).resolve()}j=v.mediaType;v=v.serverMediaType;h=d("WAMediaUtils").stringToDeliveryObjectId(h);k=k!=null?d("WAMediaUtils").stringToBackupEntFbid(k):void 0;var J=a.threadJId,K=G({filename:t,height:u,mediaPlayableDuration:x,mediaType:j,previewContentHeight:y,previewContentWidth:B,width:c});s.set(h,{filename:t,height:u,mediaPlayableDuration:x,mediaType:j,messageTimestamp:e,plaintextHash:D,previewContentHeight:y,previewContentWidth:B,serverMediaType:v,threadJId:J,width:c});u=null;if(a.previewMediaData!=null)try{u=I(a.previewMediaData)}catch(a){d("WALogger").ERROR(m(),a)}if(z!=null){x=H(f,z,a.mediaData.mediaKey,l,w,v,t,k,h,u,C);g.push({entry:x,fbId:k,hashedPlaintextHash:E,isXMAShare:a.isXMA,mediaInfo:K,mediaType:j,msgId:a.msgId,objectId:h,plaintextHash:D,size:(e=C)!=null?e:0})}B=(y=r.get(E))!=null?y:[];B.push(a);r.set(E,B)});var t=(yield C(g,e));a=(yield z(q));var u=[];a.forEach(function(a,b){var i=r.get(b);i==null?void 0:i.forEach(function(i){if(i==null)return;if(a!=null){d("WALogger").LOG(l(),i.externalId);var m=t.find(function(a){return a.plaintextHash===i.mediaData.plaintextHash});if(m==null){d("WALogger").LOG(k(),i.mediaData.mediaKey);return}return E(m.msgIds).then(function(a){return d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewMedia",value:d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:i.threadJId,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(a,e),hasMediaForUI:!0,media:m})}]})})}var n=d("MAWTraceUtils").startNewTrace((h||(h=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_MEDIA_RESTORE),y);d("MAWTraceUtils").recordCheckpointForTrace(n,h.ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_MEDIA_RESTORE_START),[],!1);var o=s.get(d("WAMediaUtils").stringToDeliveryObjectId(i.mediaData.attachmentObjectId));if(i==null||o==null)return;var p=o.filename,q=o.height,r=o.mediaPlayableDuration,v=o.mediaType,w=o.messageTimestamp,x=o.plaintextHash,z=o.previewContentHeight,A=o.previewContentWidth,B=o.serverMediaType,C=o.threadJId;o=o.width;var D=d("WAJids").extractUserId(d("MAWJids").toUserJid(i.threadJId));B=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(B,i.isXMA);if(B!=null){B={attachmentFbId:i.mediaData.backupEntFbid,attachmentObjectId:d("WAMediaUtils").stringToDeliveryObjectId(i.mediaData.attachmentObjectId),mediaType:B,messageId:i.externalId,messageTimeStamp:i.messageTimestamp,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,threadId:D,threadJid:C};D=g.find(function(a){return a.hashedPlaintextHash===b});D=D==null?void 0:D.entry;if(D==null){d("WALogger").ERROR(j(),i.mediaData.mediaKey);return}u.push(J({author:i.author,directPath:i.mediaData.directPath,echoMsg:i.echoMsg,externalId:i.externalId,filename:p,hashedPlaintextHash:b,height:q,isXMA:i.isXMA,mediaPlayableDuration:r,mediaType:v,messageTimestamp:w,plaintextHash:x,previewContentHeight:z,previewContentWidth:A,threadJId:C,width:o},n,B,void 0,d("WAMediaUtils").decodeMediaEntryData(D),f))}})});yield (i||(i=b("Promise"))).all(u)});return B.apply(this,arguments)}var C=(e=d("MAWIndexedDb")).makeMsgrTransactor({media:(f=d("MAWTransactionMode")).READWRITE,mediaBackup:f.READWRITE,messages:f.READWRITE},"restoreLinkMedias",function(a){return function(b,c){return d("MAWMediaManagementTxns").bulkLinkMedia(a,b,c)}}),D=e.makeMsgrTransactor({chunk:f.READONLY},"getChunksByHash",function(a){return function(b){return d("MAWDbChunkTxns").maybeBulkGetChunksFromHash(a,b)}}),E=e.makeMsgrTransactor({messages:f.READONLY},"getMessagesForMsgIds",function(a){return function(b){return a.messages.where("msgId").anyOf(b).toArray()}});function F(a){if(a.endsWith("=")){var b="";for(var c=0;c<a.length;c++){var d=a.charAt(c);if(d==="=")return b;b+=d}}return a}function G(a){var b=a.height,c=a.mediaType,e=a.width,f=a.previewContentHeight,g=a.previewContentWidth,h=a.mediaPlayableDuration;a=a.filename;return{validatedAudioInfo:c==="Ptt"&&h!=null?{duration:M(h),mimetype:d("MAWAsConsumerApplication").AUDIO_MIME_TYPE,played:!1}:null,validatedDocumentFileInfo:c==="DocumentFile"?{filename:a,mimetype:d("MAWAsConsumerApplication").FILE_MIME_TYPE}:null,validatedImageInfo:c==="Image"?{height:b,jpegThumbnailHeight:f,jpegThumbnailWidth:g,width:e}:c==="Gif"||c==="Sticker"?{height:b,jpegThumbnailHeight:b,jpegThumbnailWidth:e,width:e}:null,validatedVideoInfo:c==="Video"?{height:b,jpegThumbnailHeight:f,jpegThumbnailWidth:g,mimetype:d("MAWAsConsumerApplication").VIDEO_MIME_TYPE,width:e}:null}}function H(a,b,c,e,f,g,h,i,j,k,l){a=d("WABase64").decodeB64UrlSafe(a,!0);b=d("WABase64").decodeB64UrlSafe(b,!0);c=c!=null?d("WABase64").decodeB64UrlSafe(c,!0):void 0;return d("WAMediaUtils").rawDataToMediaEntry({directPath:e,downloadableThumbnail:k!=null?k:void 0,fbid:i!=null?i:void 0,fileEncSha256:b,filename:h,fileSha256:a,mediaKey:c,mediaKeyTimestamp:f!=null?d("WATimeUtils").castToUnixTime(f):void 0,objectId:j!=null?j:void 0,serverMediaType:g,size:l!=null?l:void 0})}function I(a){var b=a.attachmentObjectId,c=a.directPath,e=a.encryptedHash,f=a.mediaKey,g=a.mediaKeyTimestamp;a=a.plaintextHash;if(e==null){d("WALogger").ERROR(x());return}else{g=g!=null?d("WATimeUtils").castToUnixTime(g):void 0;f=f!=null?d("WAMediaUtils").castToMediaKey(d("WABase64").decodeB64UrlSafe(f,!0)):void 0;a=d("WABase64").decodeB64UrlSafe(a,!0);e=d("WABase64").decodeB64UrlSafe(e,!0);return{directPath:c,fileEncSha256:e,fileSha256:a,mediaKey:f,mediaKeyTimestamp:g,objectId:b}}}var J=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,i){var j,k;d("WALogger").LOG(w());var l=a.author,m=a.externalId,n=a.filename,o=a.hashedPlaintextHash,p=a.height,q=a.mediaPlayableDuration,r=a.mediaType,x=a.messageTimestamp,y=a.plaintextHash,z=a.previewContentHeight,A=a.previewContentWidth,B=a.threadJId,C=a.width;j=((j=(j=d("MAWMediaRetryInfo").getRetriedMediaInfo(m))==null?void 0:j.isXMA)!=null?j:!1)||((j=a==null?void 0:a.isXMA)!=null?j:!1);k=((k=d("MAWMediaRetryInfo").getRetriedMediaInfo(m))==null?void 0:(k=k.echoMsg)==null?void 0:k.serializationOrigin)||(a==null?void 0:(k=a.echoMsg)==null?void 0:k.serializationOrigin)||d("EchoMessage").EchoSerializationOriginType.UNKNOWN;l={author:l,chat:B,externalId:m};var D=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:l});D.addAnnotations({bool:{isRetryFromMI:e==null,isXMA:j,pathMismatch:f!==g.directPath},"int":{mediaEntrySize:g.size},string:{oldDirectPath:(B=a==null?void 0:a.oldDirectPath)!=null?B:"",origin:k,restorationCdnUrl:(j=f)!=null?j:""}});void d("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(a){D.addAnnotations(a)});if(e!=null&&c("gkx")("23960")){d("WALogger").LOG(v());d("MAWMediaRetryInfo").setRetriedMediaInfo(m,a);return K(m,e,b)}B=f==null?d("MAWConfig").getConfig().skipExpiredDownload():!1;k=d("MAWConfig").getConfig().restoreExpiredMediaForNonMsgRestoreFlow()?yield c("WAAPI").cachedDownloadFullMediaOnly({downloadMediaMetric:D,getMediaPlaintext:d("MAWGetMediaPlaintextApi").getMediaPlaintext,hash:y,mediaEntry:g,onlyIfMediaTTLIsValid:B,protocolMsgId:l,updateMediaEntryForMsg:d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg}):yield c("WAAPI").downloadMedia({downloadMediaMetric:D,getMediaPlaintext:d("MAWGetMediaPlaintextApi").getMediaPlaintext,handleMediaPreviewBeforeDownload:d("MAWHandleMediaPreviewBeforeDownloadApi").handleMediaPreviewBeforeDownload,handleMediaPreviewDownload:d("MAWHandleMediaPreviewDownloadApi").handleMediaPreviewDownload,hash:y,mediaEntry:g,onlyIfMediaTTLIsValid:B,protocolMsgId:l,updateMediaEntryForMsg:d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg});if(k.success){j=k.value;f=j.mimeType;g=j.plaintext;yield d("MAWHandleMediaDownloadApi").handleMediaDownload(y,f,g,l);D.endSuccess();d("MAWMediaRetryInfo").clearRetriedMediaInfo(m);B=G({filename:n,height:p,mediaPlayableDuration:q,mediaType:r,previewContentHeight:z,previewContentWidth:A,width:C});yield L(o,B);d("WALogger").LOG(u());d("MAWTraceUtils").recordSuccessAndFlushForTraceId(b,(h||(h=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_MEDIA_RESTORE_SUCCESS),[]);e==null&&b!=null&&d("MAWQplProxy").sendQPLSuccessThroughBridge(c("qpl")._(521485815,"2166"),void 0,d("WAHashStringToNumber").hashStringToNumber(b))}else{j=k.error;d("WAIsMediaExpiredError").isMediaExpiredError(j)&&e?(D.addPoint("eb_resign_requested"),D.endSuccess(),d("WALogger").WARN(t()),d("MAWMediaRetryInfo").setRetriedMediaInfo(m,a),yield K(m,e,b,i)):(D.endFail(j),d("WALogger").ERROR(s(),m,j,x),d("MAWMediaRetryInfo").clearRetriedMediaInfo(m),d("MAWTraceUtils").recordFailureAndFlushForTraceId(b,(h||(h=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_MEDIA_RESTORE_FAILURE),[],"media download failed with error: "+j),d("MAWEBBackendQPLUtils").logMediaRestoreFromMIQPLEndFailure(b,"media_download_failure"))}});return function(b,c,d,e,f,g){return a.apply(this,arguments)}}(),K=e.makeMsgrTransactor({media:f.READONLY,mediaBackup:f.READONLY},"invokeRestoreAccessCheckSprocToDownloadAttachment",function(a){return function(b,e,f,g){var i=d("WAMediaUtils").stringToDeliveryObjectId(e.attachmentObjectId);return d("MAWDbMediaTxns").maybeGetMediaFromObjectId(a,i).then(function(a){if(a){var i;if(f!=null&&e!=null){var j;a=d("WAHashStringToNumber").hashStringToNumber(f);j={bool:{isPointRestore:(j=g)!=null?j:!1},string:{mediaType:e.mediaType}};i=d("MAWQplProxy").startQplUserFlow(c("qpl")._(521485815,"2166"),j,a)}d("WATagsLogger").TAGS(["labyrinth_web","media_restore",(j=f)!=null?j:""]).LOG(r(),g);g===!0?i!=null&&i.endSuccess():d("MAWIndexedDb").afterTransaction({tag:"ResignAttachmentCDNUrl",value:{backupEntFbid:e.attachmentFbId,chatId:e.chatId==null?void 0:e.chatId.toString(),deliveryObjectId:e.attachmentObjectId,mediaType:e.mediaType,messageId:b,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,sortOrder:e.messageTimeStamp,threadId:e.threadId,threadJid:e.threadJid,traceId:f}})}else d("WALogger").ERROR(q()),d("MAWTraceUtils").recordFailureAndFlushForTraceId(f,(h||(h=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_MEDIA_RESTORE_FAILURE),[],"media entry is missing from index db. It is required to retry download by resigning cdn url")})}}),L=e.makeMsgrTransactor({media:f.READWRITE,messages:f.READWRITE},"updateMediaWithDownloadedChunkBlob",function(a){return function(b,c){return d("MAWMediaManagementTxns").updateMediaEntryWithValidatedMediaInfo(a,b,c)}});function M(a){var b=Math.floor(a/1e3);if(b>0)return b;else return a}g.downloadMediaAndWriteToMediaStore=a;g.getBase64WithoutPadding=F;g.constructMediaEntry=H;g.handleDownloadMedia=J;g.invokeRestoreAccessCheckSprocToDownloadAttachment=K}),98);
__d("WAMessageKey",["WAErr","WAGlobals","WAJids","WAStanzaUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a===d("WAJids").AUTHOR_ME||a==d("WAGlobals").getMyUserJid()}function a(a,b,e){if(e==null)throw c("WAErr")("messageKey is null");var f=e.id,g=e.remoteJid;if(f==null)throw c("WAErr")("messageKey.id is null");else if(g==null)throw c("WAErr")("messageKey.remoteJid is null");g=d("WAJids").interpretAndValidateJid(g);if(g.jidType==="unknown")throw c("WAErr")("messageKey.remoteJid is invalid");var i,j=d("WAJids").AUTHOR_ME;if(g.jidType==="group"){i=g.groupJid;if(h(b)&&e.fromMe===!0)j=d("WAJids").AUTHOR_ME;else if(e.fromMe==!0)j=b;else{var k=e.participant;if(k==null)throw c("WAErr")("key.participant is null");k=d("WAJids").interpretAndValidateJid(k);if(k.jidType==="msgrUser")j=k.userJid;else throw c("WAErr")("key.participant is invalid")}}else if(g.jidType==="msgrUser"||g.jidType==="msgrDevice"){k=d("WAJids").interpretAndValidateJid(a);if(k.jidType!=="msgrUser")throw c("WAErr")("expected user type jid.");i=k.userJid;h(b)?e.fromMe===!0?j=d("WAJids").AUTHOR_ME:j=k.userJid:e.fromMe===!0&&(j=k.userJid)}else throw c("WAErr")("Unsupported jidtype type");return{chat:i,author:h(j)?d("WAJids").AUTHOR_ME:j,externalId:d("WAStanzaUtils").toStanzaId(f)}}g.extractProtocolMessageId=a}),98);
__d("WAParseConsumerMessagePollCreation",["WAGlobals","WAHex","WAMsgType"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e){a={unstoredMsg:{type:d("WAMsgType").MSG_TYPE.FUTUREPROOF,msgContent:{protobuf:d("WAHex").bytesToBuffer(a),subtype:d("WAGlobals").getConfig().isUnsupportedMessagesRedesignEnabled()?"pollCreationMessage":null},id:b.id,ts:b.ts,sentTs:b.sentTs,serverTs:b.serverTs,ack:b.ack,reportingMeta:c},unstoredMedia:null,unstoredQuotedMedia:null};return!e||!d("WAGlobals").getConfig().isPollsFallbackExperienceEnabled()?a:a}g["default"]=a}),98);
__d("WAParseProtocolUtils",["WAGlobals","WALogger","WALongInt","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unsupported franking version ",""]);h=function(){return a};return a}function a(a,b){b=i(b,a.serverTs);a=b==null?void 0:b.expirationTs;var c=b==null?void 0:b.deleteTs;b=b==null?void 0:b.ephemeralSetting;return{expirationTs:a,deleteTs:c,ephemeralSetting:b}}function b(a,b){b=j(b);b!=null&&(a.reportingMeta=b);return b}function i(a,b){var c;c=a==null?void 0:(c=a.chatEphemeralSetting)==null?void 0:c.ephemeralExpiration;a=a==null?void 0:(a=a.chatEphemeralSetting)==null?void 0:a.ephemeralSettingTimestamp;if(c==null||a==null||c===0||!d("WAGlobals").getConfig().isEphemeralMessagesEnabled())return null;b=d("WATimeUtils").castToUnixTime(b+d("WAGlobals").getDependencies().ephemeralMaxDeletionWindowForUnseenMessage());var e=b,f=null;try{a=d("WALongInt").numberOrThrowIfTooLarge(a)/1e3;f=d("WATimeUtils").castToUnixTime(a)}catch(a){return null}return{expirationTs:b,deleteTs:e,ephemeralSetting:{expirationTs:c,updatedTs:f}}}function j(a){a=a==null?void 0:a.frankingVersion;a!=null&&a!==0&&d("WALogger").ERROR(h(),a);return{frankingKey:void 0,frankingTag:void 0,frankingVersion:a,reportingContent:void 0,reportingTag:void 0}}g.parseEphemerality=a;g.enhanceReportingMeta=b}),98);
__d("WAParseConsumerMessageProtocol",["WACommon.pb","WAConsumerApplication.pb","WAErr","WAGlobals","WAHex","WAJids","WALogger","WAMediaTransport.pb","WAMessageKey","WAMsgType","WAParseConsumerMessagePollCreation","WAParseMediaTransportProtocol","WAParseProtocolUtils","WAResultOrError","WAStanzaUtils","WATimeUtils","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["parseConsumerMessageProtocol error :",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["WAParseConsumerMessageProtocol - ephemeralSetting duration is invalid ",", jidType: ",""]);i=function(){return a};return a}var j=90*d("WATimeUtils").DAY_SECONDS;b=1;e=0;f=1;f=d("WAGlobals").getConfig().armadilloWebProcessFutureproof()?f+1:f;function a(a,b,e,f,g,k){var l;b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAConsumerApplication.pb").ConsumerApplicationSpec,b);l=(l=b.payload)==null?void 0:(l=l.applicationData)==null?void 0:(l=l.revoke)==null?void 0:(l=l.key)==null?void 0:l.id;if(l!=null)return{unstoredMsg:{type:d("WAMsgType").MSG_TYPE.REVOKED,id:e.id,ts:e.ts,sentTs:e.sentTs,serverTs:e.serverTs,ack:e.ack,reportingMeta:e.reportingMeta,revokedExternalId:d("WAStanzaUtils").toStanzaId(l),unsendMsgContentDeleteTs:null,msgContent:null,ebTimestampMs:k},unstoredMedia:null,unstoredQuotedMedia:null};var m=(g==null?void 0:g.isForwarded)||!1;l=d("WAParseProtocolUtils").parseEphemerality(e,g);var w=l.expirationTs,x=l.deleteTs,y=l.ephemeralSetting;if(y!=null&&(y.expirationTs<0||y.expirationTs>j)){k=d("WAJids").interpretAndValidateJid(a);l=k.jidType;k=y.expirationTs;d("WALogger").ERROR(i(),k,l)}var z=d("WAParseProtocolUtils").enhanceReportingMeta(e,g),A=(k=o(g))!=null?k:void 0,B=(l=b.payload)==null?void 0:l.content;if(!B)return{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null};var C=(k=b.metadata)==null?void 0:k.specialTextSize,D=t(B),E={contentTypeForLogging:D,unstoredMsg:{type:d("WAMsgType").MSG_TYPE.FUTUREPROOF,msgContent:{protobuf:d("WAHex").bytesToBuffer(f),subtype:null},id:e.id,ts:e.ts,sentTs:e.sentTs,serverTs:e.serverTs,ack:e.ack,reportingMeta:z},unstoredMedia:null,unstoredQuotedMedia:null};l=function(){try{switch(D){case"messageText":var b,i=B[D];if(i==null)throw c("WAErr")("consumerMessage has no messageText");b=((b=i.commands)==null?void 0:b.some(function(a){return a.commandType===d("WACommon.pb").COMMAND_COMMAND_TYPE.AI}))===!0;if(b)return babelHelpers["extends"]({},E,{unstoredMsg:babelHelpers["extends"]({},E.unstoredMsg,{msgContent:babelHelpers["extends"]({},E.unstoredMsg.msgContent,{subtype:d("WAGlobals").getConfig().isUnsupportedMessagesRedesignEnabled()?"metaAiMessage":null})})});if(i.text==null)throw c("WAErr")("consumerMessage has no messageText");return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.TEXT,msgContent:{content:i.text,mentionedJids:i.mentionedJid.map(d("WAJids").validateUserJid).filter(Boolean)},quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m},e,{specialTextSize:C}),unstoredMedia:null,unstoredQuotedMedia:null};case"reactionMessage":return{unstoredMsg:n(a,e,B[D]),unstoredMedia:null,unstoredQuotedMedia:null};case"imageMessage":b=p(B,e.ts);return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.IMAGE,quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m,mediaId:b.plaintextHash},e),unstoredMedia:b,unstoredQuotedMedia:null};case"videoMessage":var j,k;i=B[D];if(i==null)throw c("WAErr")("consumerMessage has no videoMessage");b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").VideoTransportSpec,i==null?void 0:(b=i.video)==null?void 0:b.payload);j=b==null?void 0:(j=b.integral)==null?void 0:(j=j.transport)==null?void 0:(j=j.ancillary)==null?void 0:j.mimetype;k=(b==null?void 0:(k=b.ancillary)==null?void 0:k.gifPlayback)===!0&&j==="image/gif";if(k&&!d("WAGlobals").getConfig().isGifEnabled())return E;j=d("WAParseMediaTransportProtocol").parseVideoMsg(b,e.ts,k);if(j==null)throw c("WAErr")("consumerMessage has no video media info");if(v(g)&&((b=i.caption)==null?void 0:b.text)!=null){return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.TEXT,msgContent:{content:(b=i.caption)==null?void 0:b.text,mentionedJids:i.caption.mentionedJid.map(d("WAJids").validateUserJid).filter(Boolean)},quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m},e,{specialTextSize:C}),unstoredMedia:null,unstoredQuotedMedia:null}}return{unstoredMsg:k?babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.GIF},e,{quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m,reportingMeta:z,mediaId:j.plaintextHash}):babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.VIDEO},e,{quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m,mediaId:j.plaintextHash}),unstoredMedia:j,unstoredQuotedMedia:null};case"audioMessage":b=q(B,e.ts);return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.PTT,quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m,mediaId:b.plaintextHash},e),unstoredMedia:b,unstoredQuotedMedia:null};case"stickerMessage":if(d("WAGlobals").getConfig().isStickerEnabled()){i=r(B);k=d("WAParseMediaTransportProtocol").parseStickerMsg(i,e.ts);if(k==null){if(((j=i.integral)==null?void 0:j.receiverFetchId)!=null)return babelHelpers["extends"]({},E,{unstoredMsg:babelHelpers["extends"]({},E.unstoredMsg,{msgContent:babelHelpers["extends"]({},E.unstoredMsg.msgContent,{subtype:"stickerReceiverFetchMessage"})})});throw c("WAErr")("consumerMessage has no sticker media info")}return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.STICKER,quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m,reportingMeta:z,mediaId:k.plaintextHash},e),unstoredMedia:k,unstoredQuotedMedia:null}}return E;case"documentMessage":if(d("WAGlobals").getConfig().isDocumentReceiveEnabled()){b=s(B,e.ts);return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.DOCUMENT_FILE,quote:A,expirationTs:w,deleteTs:x,ephemeralSetting:y,isForwarded:m,reportingMeta:z,mediaId:b.plaintextHash},e),unstoredMedia:b,unstoredQuotedMedia:null}}return E;case"groupInviteMessage":return{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null,unstoredIncomingGroupInvite:u(e,B)};case"editMessage":i=B[D];j=i==null?void 0:i.message;k=j==null?void 0:j.text;b=i==null?void 0:(b=i.key)==null?void 0:b.id;if(i==null||j==null||k==null)throw c("WAErr")("consumerMessage with editMessage type has no editMessage");if(b==null)throw c("WAErr")("consumerMessage with editMessage type has no original Msg External Id.");i=d("WAStanzaUtils").toStanzaId(b);return{unstoredEditMsg:{type:d("WAMsgType").MSG_TYPE.EDIT_ACTION,editMsgContent:{content:k,mentionedJids:j.mentionedJid.map(d("WAJids").validateUserJid).filter(Boolean)},originalMsgExternalId:i,id:e.id,ts:e.ts,sentTs:e.sentTs,serverTs:e.serverTs,ack:e.ack,reportingMeta:z,specialTextSize:C},unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null};case"pollCreationMessage":return c("WAParseConsumerMessagePollCreation")(f,e,z,B[D]);case"pollUpdateMessage":return d("WAGlobals").getConfig().isUnsupportedMessagesRedesignEnabled()?{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null}:E;case"contactMessage":case"locationMessage":case"extendedTextMessage":case"statusTextMessage":case"contactsArrayMessage":case"liveLocationMessage":case"viewOnceMessage":default:return E}}catch(a){d("WALogger").ERROR(h(),a);return{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null}}}();return babelHelpers["extends"]({},l,{contentTypeForLogging:D})}function k(a){if(d("WAJids").isAuthorSystem(a))throw c("WAErr")("Got system author");return a}var l=30;function m(a){if(a==null)return d("WAResultOrError").makeResult(null);return a.length>l?d("WAResultOrError").makeError("invalid-reaction-text-length"):d("WAResultOrError").makeResult(a)}function n(a,b,e){if(e==null)throw c("WAErr")("consumerMessage has no reactionMessage");var f=k(b.id.author);a=d("WAMessageKey").extractProtocolMessageId(a,f,e.key);f=e.text;var g=e.groupingKey;e=e.senderTimestampMs;var h=m(f);if(!h.success){throw c("WAErr")('"'+((f=f)!=null?f:"")+'" is not a valid reaction ['+h.error+"]")}return{type:d("WAMsgType").MSG_TYPE.REACTION,ack:b.ack,id:b.id,reactToExternalId:a.externalId,reactToAuthor:a.author,reaction:h.value,groupingKey:g,ts:b.ts,senderTimestampMs:e}}function o(a){var b,e;b=a==null?void 0:(b=a.quotedMessage)==null?void 0:b.stanzaId;e=a==null?void 0:(e=a.quotedMessage)==null?void 0:e.participant;a=a==null?void 0:(a=a.quotedMessage)==null?void 0:a.remoteJid;e=e!=null?d("WAJids").interpretAndValidateJid(e):null;var f;(e==null?void 0:e.jidType)==="msgrUser"&&e.userJid===d("WAGlobals").getMyUserJid()?f=d("WAJids").AUTHOR_ME:(e==null?void 0:e.jidType)==="msgrUser"?f=e.userJid:f=d("WAJids").AUTHOR_ME;if(b==null)return null;e={type:d("WAMsgType").MSG_TYPE.UNAVAILABLE,author:f,externalId:d("WAStanzaUtils").toStanzaId(b),ts:null};if(a!=null){f=d("WAJids").interpretAndValidateJid(a);if(f.jidType==="group")return{remoteJid:f.groupJid,content:e};else throw c("WAErr")("not supported")}else return{remoteJid:null,content:e}}function p(a,b){a=a.imageMessage;if(a==null)throw c("WAErr")("consumerMessage has no imageMessage");return d("WAParseMediaTransportProtocol").decodeImageTransport(a==null?void 0:(a=a.image)==null?void 0:a.payload,b)}function q(a,b){var e;a=a.audioMessage;if(a==null)throw c("WAErr")("consumerMessage has no audioMessage");e=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").AudioTransportSpec,a==null?void 0:(e=a.audio)==null?void 0:e.payload);e=d("WAParseMediaTransportProtocol").parseAudioMsg(e,(a==null?void 0:a.ptt)||!1,b);if(e==null)throw c("WAErr")("consumerMessage has no audio media info");return e}function r(a){a=a.stickerMessage;if(a==null)throw c("WAErr")("consumerMessage has no stickerMessage");return d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").StickerTransportSpec,a==null?void 0:(a=a.sticker)==null?void 0:a.payload)}function s(a,b){var e;a=a.documentMessage;if(a==null)throw c("WAErr")("consumerMessage has no documentMessage");e=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").DocumentTransportSpec,a==null?void 0:(e=a.document)==null?void 0:e.payload);a=a==null?void 0:a.fileName;e=d("WAParseMediaTransportProtocol").parseDocumentMsg(e,a,b);if(e==null)throw c("WAErr")("consumerMessage has no document media info");return e}function t(a){var b=Object.keys(a).filter(function(a){return a!=="$$unknownFieldCount"});if(b.length!==1)throw c("WAErr")(JSON.stringify(a)+" consumerMessage payload content should have exactly one field, instead found "+JSON.stringify(b));return b[0]}function u(a,b){b=b.groupInviteMessage;if(b==null)throw c("WAErr")("consumerMessage has no GroupInvite Data");return babelHelpers["extends"]({ack:a.ack,author:a.id.author,externalId:a.id.externalId,ts:a.ts},b)}function v(a){if((a==null?void 0:a.readonlyMetadataDataclass)!=null)try{a=JSON.parse(a==null?void 0:a.readonlyMetadataDataclass);return(a==null?void 0:(a=a.power_up)==null?void 0:a.power_up_style)!=null}catch(a){throw c("WAErr")("Failed to parse readonly metadata dataclass JSON")}return!1}g.MINIMAL_MEDIA_DURATION=b;g.DEFAULT_FILE_SIZE=e;g.SUPPORTED_TYPES_VERSION=f;g.parseConsumerMessageProtocol=a;g.interpretAsNonSystemAuthor=k;g.validReactionMessageText=m;g.parseReactionMessage=n;g.parsedQuotedConsumerMessage=o;g.parseOneOfContentType=t}),98);
__d("WAMedia",[],(function(a,b,c,d,e,f){"use strict";a="Image";b="Video";c="Ptt";d="Gif";e="Sticker";var g="DocumentFile",h={IMAGE:a,VIDEO:b,PTT:c,GIF:d,STICKER:e,DOCUMENT_FILE:g};f.IMAGE=a;f.VIDEO=b;f.PTT=c;f.GIF=d;f.STICKER=e;f.DOCUMENT_FILE=g;f.MEDIA_TYPE=h}),66);
__d("WAParseMediaTransportProtocol",["WAConsumerApplication.pb","WAErr","WAHashUtils","WALogger","WALongInt","WAMedia","WAMediaTransport.pb","WAMediaUtils","WAMsgMap","WAParseConsumerMessageProtocol","WAProgressiveJpegGetScanLengths","WATimeUtils","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["downloadableThumbnail is missing some required fields"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["cannot compose mediaEntry with the media message"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["parseMediaKey error :",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["cannot compose mediaEntry with the media message"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["protobuf msg with no plaintext hash"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["There is unknown fileds in integral of VideoTransport"]);m=function(){return a};return a}function n(a,b,c){var e,f,g;if(!((e=a.integral)==null?void 0:e.transport))return null;e=(e=a.integral)==null?void 0:e.transport;if(d("decodeProtobuf").getUnknownFields(e.integral)!=null){d("WALogger").ERROR(m());return null}f=(f=e.integral)==null?void 0:f.fileSha256;if(!f){d("WALogger").ERROR(l());return null}var h=null;if(((g=a.ancillary)==null?void 0:g.scansSidecar)!=null&&((g=a.ancillary)==null?void 0:g.scanLengths)!=null){h={sidecar:(g=a.ancillary)==null?void 0:g.scansSidecar,scanLengths:(g=a.ancillary)==null?void 0:(a=g.scanLengths)==null?void 0:a.map(d("WAProgressiveJpegGetScanLengths").asProgressiveJpegScanLength)}}if(((g=e.integral)==null?void 0:g.fileSha256)==null||((a=e.integral)==null?void 0:a.fileEncSha256)==null||((g=e.integral)==null?void 0:g.mediaKey)==null||((a=e.integral)==null?void 0:a.directPath)==null||((g=e.integral)==null?void 0:g.mediaKeyTimestamp)==null||((a=e.ancillary)==null?void 0:a.objectId)==null){d("WALogger").ERROR(k());return null}a=(g=e.ancillary)==null?void 0:g.fileLength;g=(g=e.ancillary.thumbnail)==null?void 0:g.downloadableThumbnail;e=d("WAMediaUtils").rawDataToMediaEntry({fileSha256:e.integral.fileSha256,fileEncSha256:e.integral.fileEncSha256,mediaKey:e.integral.mediaKey,directPath:e.integral.directPath,mediaKeyTimestamp:d("WATimeUtils").castLongIntToUnixTime(e.integral.mediaKeyTimestamp),serverMediaType:b,objectId:(b=e.ancillary)==null?void 0:b.objectId,fbid:void 0,downloadableThumbnail:{directPath:g==null?void 0:g.directPath,fileEncSha256:g==null?void 0:g.fileEncSha256,fileSha256:g==null?void 0:g.fileSha256,mediaKey:g==null?void 0:g.mediaKey,mediaKeyTimestamp:(g==null?void 0:g.mediaKeyTimestamp)==null?null:d("WATimeUtils").castLongIntToUnixTime(g==null?void 0:g.mediaKeyTimestamp),objectId:g==null?void 0:g.objectId},filename:c,progressiveJpegDetails:h,size:a==null?a:d("WALongInt").numberOrThrowIfTooLarge(a)});return{size:a==null?d("WAParseConsumerMessageProtocol").DEFAULT_FILE_SIZE:d("WALongInt").numberOrThrowIfTooLarge(a),plaintextHash:d("WAHashUtils").toPlaintextHash(new Uint8Array(f)),mediaEntry:e}}function o(a,b){var c,e=n(a,"image");if(!e)return null;e=q(e,b);b=(b=a.ancillary)==null?void 0:b.width;c=(c=a.ancillary)==null?void 0:c.height;a.ancillary!=null&&(a.ancillary.width!=null&&a.ancillary.width===4294967295&&(b=void 0),a.ancillary.height!=null&&a.ancillary.height===4294967295&&(c=void 0));c=babelHelpers["extends"]({},e,{mediaType:d("WAMedia").MEDIA_TYPE.IMAGE,validatedVideoInfo:null,validatedImageInfo:{width:b,height:c,jpegThumbnail:(e=a.integral)==null?void 0:(b=e.transport)==null?void 0:(c=b.ancillary)==null?void 0:(e=c.thumbnail)==null?void 0:e.jpegThumbnail,jpegThumbnailHeight:(b=a.integral)==null?void 0:(c=b.transport)==null?void 0:(e=c.ancillary)==null?void 0:(b=e.thumbnail)==null?void 0:b.thumbnailHeight,jpegThumbnailWidth:(c=a.integral)==null?void 0:(e=c.transport)==null?void 0:(b=e.ancillary)==null?void 0:(a=b.thumbnail)==null?void 0:a.thumbnailWidth},validatedAudioInfo:null,validatedDocumentFileInfo:null});return c}function a(a,b){a=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").ImageTransportSpec,a);a=o(a,b);if(a==null)throw c("WAErr")("consumerMessage has no image media info");return a}function b(a,b,c){var e;if(!((e=a.integral)==null?void 0:e.transport))return null;e=n(a,c?"gif":"video");if(!e)return null;e=q(e,b);e=babelHelpers["extends"]({},e,{mediaType:c?d("WAMedia").MEDIA_TYPE.GIF:d("WAMedia").MEDIA_TYPE.VIDEO,validatedVideoInfo:c?null:{duration:(a==null?void 0:(b=a.ancillary)==null?void 0:b.seconds)!=null&&(a==null?void 0:(e=a.ancillary)==null?void 0:e.seconds)>d("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION?a==null?void 0:(b=a.ancillary)==null?void 0:b.seconds:d("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION,width:a==null?void 0:(e=a.ancillary)==null?void 0:e.width,height:a==null?void 0:(b=a.ancillary)==null?void 0:b.height,mimetype:a==null?void 0:(e=a.integral)==null?void 0:(b=e.transport)==null?void 0:(e=b.ancillary)==null?void 0:e.mimetype,jpegThumbnail:(b=a.integral)==null?void 0:(e=b.transport)==null?void 0:(b=e.ancillary)==null?void 0:(e=b.thumbnail)==null?void 0:e.jpegThumbnail,jpegThumbnailHeight:(b=a.integral)==null?void 0:(e=b.transport)==null?void 0:(b=e.ancillary)==null?void 0:(e=b.thumbnail)==null?void 0:e.thumbnailHeight,jpegThumbnailWidth:(b=a.integral)==null?void 0:(e=b.transport)==null?void 0:(b=e.ancillary)==null?void 0:(e=b.thumbnail)==null?void 0:e.thumbnailWidth},validatedImageInfo:c?{width:(b=a.ancillary)==null?void 0:b.width,height:(e=a.ancillary)==null?void 0:e.height,jpegThumbnail:(c=a.integral)==null?void 0:(b=c.transport)==null?void 0:(e=b.ancillary)==null?void 0:(c=e.thumbnail)==null?void 0:c.jpegThumbnail,jpegThumbnailHeight:(b=a.integral)==null?void 0:(e=b.transport)==null?void 0:(c=e.ancillary)==null?void 0:(b=c.thumbnail)==null?void 0:b.thumbnailHeight,jpegThumbnailWidth:(e=a.integral)==null?void 0:(c=e.transport)==null?void 0:(b=c.ancillary)==null?void 0:(a=b.thumbnail)==null?void 0:a.thumbnailWidth}:null,validatedAudioInfo:null,validatedDocumentFileInfo:null});return e}function e(a,b,c){if(!((b=a.integral)==null?void 0:b.transport))return null;b=n(a,"ptt");if(!b)return null;b=q(b,c);b=babelHelpers["extends"]({},b,{mediaType:d("WAMedia").MEDIA_TYPE.PTT,validatedVideoInfo:null,validatedImageInfo:null,validatedDocumentFileInfo:null,validatedAudioInfo:{duration:(a==null?void 0:(c=a.ancillary)==null?void 0:c.seconds)!=null&&(a==null?void 0:(b=a.ancillary)==null?void 0:b.seconds)>d("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION?a==null?void 0:(c=a.ancillary)==null?void 0:c.seconds:d("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION,mimetype:a==null?void 0:(b=a.integral)==null?void 0:(c=b.transport)==null?void 0:(a=c.ancillary)==null?void 0:a.mimetype,played:!1}});return b}function f(a,b){var c;if(!((c=a.integral)==null?void 0:c.transport))return null;c=n(a,"sticker");if(!c)return null;c=q(c,b);c=babelHelpers["extends"]({},c,{mediaType:d("WAMedia").MEDIA_TYPE.STICKER,validatedVideoInfo:null,validatedImageInfo:{width:(b=a.ancillary)==null?void 0:b.width,height:(c=a.ancillary)==null?void 0:c.height,jpegThumbnail:(b=a.integral)==null?void 0:(c=b.transport)==null?void 0:(b=c.ancillary)==null?void 0:(c=b.thumbnail)==null?void 0:c.jpegThumbnail,jpegThumbnailHeight:(b=a.integral)==null?void 0:(c=b.transport)==null?void 0:(b=c.ancillary)==null?void 0:(c=b.thumbnail)==null?void 0:c.thumbnailHeight,jpegThumbnailWidth:(b=a.integral)==null?void 0:(c=b.transport)==null?void 0:(a=c.ancillary)==null?void 0:(b=a.thumbnail)==null?void 0:b.thumbnailWidth},validatedAudioInfo:null,validatedDocumentFileInfo:null});return c}function p(a,b,c){var e;if(!((e=a.integral)==null?void 0:e.transport))return null;e=n(a,"document",b);if(!e)return null;e=q(e,c);return babelHelpers["extends"]({},e,{mediaType:d("WAMedia").MEDIA_TYPE.DOCUMENT_FILE,validatedVideoInfo:null,validatedImageInfo:null,validatedAudioInfo:null,validatedDocumentFileInfo:{mimetype:a==null?void 0:(c=a.integral)==null?void 0:(e=c.transport)==null?void 0:(a=e.ancillary)==null?void 0:a.mimetype,filename:(c=b)!=null?c:void 0}})}function q(a,b){return{mediaEntry:a.mediaEntry,plaintextHash:a.plaintextHash,size:a.size,msgIds:[],mediaEntries:new(d("WAMsgMap").MsgMap)(),ts:b}}function r(a){a=a.msg;if(a.subprotocolType!=="consumerMessage")return[];a=d("decodeProtobuf").decodeProtobuf(d("WAConsumerApplication.pb").ConsumerApplicationSpec,a.subprotocol);if(a.payload==null||a.payload.content==null)return[];var b=a.payload.content;a=d("WAParseConsumerMessageProtocol").parseOneOfContentType(a.payload.content);try{switch(a){case"imageMessage":a=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").ImageTransportSpec,(a=b.imageMessage)==null?void 0:(a=a.image)==null?void 0:a.payload);return s(a,"image");case"videoMessage":a=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").VideoTransportSpec,(a=b.videoMessage)==null?void 0:(a=a.video)==null?void 0:a.payload);return s(a,"video");case"audioMessage":a=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").AudioTransportSpec,(a=b.audioMessage)==null?void 0:(a=a.audio)==null?void 0:a.payload);return s(a,"ptt");case"stickerMessage":a=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").StickerTransportSpec,(a=b.stickerMessage)==null?void 0:(a=a.sticker)==null?void 0:a.payload);return s(a,"sticker");case"documentMessage":a=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").DocumentTransportSpec,(a=b.documentMessage)==null?void 0:(b=a.document)==null?void 0:b.payload);return s(a,"document");case"groupInviteMessage":case"editMessage":case"pollCreationMessage":case"pollUpdateMessage":case"messageText":case"reactionMessage":case"contactMessage":case"locationMessage":case"extendedTextMessage":case"statusTextMessage":case"contactsArrayMessage":case"liveLocationMessage":case"viewOnceMessage":default:return[]}}catch(a){d("WALogger").ERROR(j(),a);return[]}}function s(a,b){var c,e;if(!((c=a.integral)==null?void 0:c.transport))return[];c=(c=a.integral)==null?void 0:c.transport;if(c.integral==null||((e=c.integral)==null?void 0:e.fileSha256)==null||((e=c.integral)==null?void 0:e.fileEncSha256)==null||((e=c.integral)==null?void 0:e.mediaKey)==null||((e=c.integral)==null?void 0:e.directPath)==null||((e=c.integral)==null?void 0:e.mediaKeyTimestamp)==null||((e=c.ancillary)==null?void 0:e.objectId)==null){d("WALogger").ERROR(i());return[]}e=c.integral;var f=e.fileSha256,g=e.fileEncSha256,j=e.mediaKey,k=e.directPath;e=e.mediaKeyTimestamp;b={directPath:k,plaintextHash:d("WAHashUtils").toPlaintextHash(f),ciphertextHash:d("WAHashUtils").toCiphertextHash(g),fbid:void 0,fileEncSha256:g,fileSha256:f,mediaKey:j,mediaKeyTimestamp:d("WATimeUtils").castLongIntToUnixTime(e),objectId:(k=c.ancillary)==null?void 0:k.objectId,serverMediaType:b,sidecar:((g=a.ancillary)==null?void 0:g.scansSidecar)||((f=a.ancillary)==null?void 0:f.sidecar),size:d("WALongInt").maybeNumberOrThrowIfTooLarge((j=c.ancillary)==null?void 0:j.fileLength),scanLengths:(e=a.ancillary)==null?void 0:(k=e.scanLengths)==null?void 0:k.map(d("WAProgressiveJpegGetScanLengths").asProgressiveJpegScanLength),uploadToken:void 0};j=(g=c.ancillary)==null?void 0:(f=g.thumbnail)==null?void 0:f.downloadableThumbnail;a=null;if(j!=null&&(j==null?void 0:j.fileSha256)!=null&&(j==null?void 0:j.fileEncSha256)!=null&&(j==null?void 0:j.mediaKey)!=null&&(j==null?void 0:j.directPath)!=null&&(j==null?void 0:j.mediaKeyTimestamp)!=null&&(j==null?void 0:j.objectId)!=null){e=j.fileSha256;k=j.fileEncSha256;c=j.mediaKey;g=j.directPath;f=j.mediaKeyTimestamp;var l=j.objectId;a={ciphertextHash:d("WAHashUtils").toCiphertextHash(k),directPath:g,fileEncSha256:k,fileSha256:e,mediaKey:c,mediaKeyTimestamp:d("WATimeUtils").castLongIntToUnixTime(f),objectId:l,plaintextHash:d("WAHashUtils").toPlaintextHash(e),scanLengths:void 0,serverMediaType:"preview",sidecar:void 0,uploadToken:void 0,size:void 0}}else j!=null&&d("WALogger").ERROR(h());return[b,a].filter(Boolean)}g.getMediaMeta=n;g.parseImageMsg=o;g.decodeImageTransport=a;g.parseVideoMsg=b;g.parseAudioMsg=e;g.parseStickerMsg=f;g.parseDocumentMsg=p;g.parseMediaKey=r}),98);
__d("MAWParseBumpExistingMessageMsg",["WAMessageKey","WAParseConsumerMessageProtocol","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.chat,e=a.content;a=a.meta;e=e.bumpExistingMessage;if(e==null)throw c("err")("bumpExistingMessage has no content");e=e.key;if(e==null)throw c("err")("bumpExistingMessage has no message key");var f=d("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(a.id.author);f=d("WAMessageKey").extractProtocolMessageId(b,f,e);e=f.author;f=f.externalId;e={ack:a.ack,id:{author:a.id.author,chat:a.id.chat,externalId:a.id.externalId},quote:{content:{author:e,externalId:f,ts:null,type:"Unavailable"},remoteJid:b},reportingMeta:a.reportingMeta,sentTs:a.sentTs,serverTs:a.serverTs,ts:a.serverTs,type:"BumpExistingMessage"};return{contentTypeForLogging:"bumpExistingMessage",unstoredMedia:null,unstoredMsg:e,unstoredQuotedMedia:null,unstoredXMA:null}}g["default"]=a}),98);
__d("MAWParseNoteReplyMsg",["MAWMsgType","WAMsgType","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b,e=a.content;a=a.meta;e=e.noteReplyMessage;if(e==null)throw c("err")("noteReplyMessage has no content");b=(b=e.textContent)==null?void 0:b.text;if(b==null)throw c("err")("noteReplyMessage has no text content");e=(e=e.noteText)==null?void 0:e.text;if(e==null)throw c("err")("noteReplyMessage has no note text");b={ack:a.ack,forwardingScore:a.forwardingScore,id:{author:a.id.author,chat:a.id.chat,externalId:a.id.externalId},msgContent:{content:b},quote:{content:{author:a.id.author,externalId:a.id.externalId,msgContent:{content:e},ts:a.serverTs,type:d("WAMsgType").NOTE_REPLY},remoteJid:a.id.chat},ts:a.serverTs,type:d("MAWMsgType").MSG_TYPE.TEXT};return{contentTypeForLogging:"noteReplyMessage",unstoredMedia:null,unstoredMsg:b,unstoredQuotedMedia:null,unstoredXMA:null}}g["default"]=a}),98);
__d("MAWParseRavenActionNotificationMsg",["MAWConfig","MAWMsg","WAStanzaUtils","WATimeUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b,e,f=a.content;a=a.meta;if(!d("MAWConfig").getConfig().isRavenMessagesEnabled())return{unstoredMedia:null,unstoredMsg:null,unstoredQuotedMedia:null,unstoredXMA:null};b=(b=f.ravenActionNotifMessage)==null?void 0:b.actionType;b=d("MAWMsg").MAWRavenActionNotifType.cast(b);e=(e=f.ravenActionNotifMessage)==null?void 0:e.actionTimestamp;var g;if(e!=null){e=Number(e);e>d("WATimeUtils").MAX_INT?g=d("WATimeUtils").castMilliSecondsToUnixTime(e):g=d("WATimeUtils").castToUnixTime(e)}e=((e=f.ravenActionNotifMessage)==null?void 0:(e=e.key)==null?void 0:e.id)!=null?d("WAStanzaUtils").toStanzaId((e=f.ravenActionNotifMessage)==null?void 0:(f=e.key)==null?void 0:f.id):null;if(b==null)throw c("err")("Error when getting actionType for RavenNotificationMessage "+a.id.externalId);if(g==null)throw c("err")("Error when getting actionTimestamp for RavenNotificationMessage "+a.id.externalId);if(e==null)throw c("err")("Error when getting ravenActionToMsgExternalId for RavenNotificationMessage "+a.id.externalId);f={ack:a.ack,actionTimestamp:g,actionType:b,id:a.id,ravenActionToMsgExternalId:e,sentTs:a.sentTs,serverTs:a.serverTs,ts:a.serverTs,type:"RavenAction"};return{unstoredMedia:null,unstoredMsg:f,unstoredQuotedMedia:null,unstoredXMA:null}}g.parseRavenActionNotificationMessage=a}),98);
__d("MAWParseSubprotocolVersionConsts",[],(function(a,b,c,d,e,f){"use strict";a=2;b=2;c=1;d=2;e=1;var g=1;f.ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION=a;f.XMA_PREVIEW_SUBPROTOCOL_VERSION=b;f.XMA_FAVICON_SUBPROTOCOL_VERSION=c;f.XMA_HEADER_SUBPROTOCOL_VERSION=d;f.RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION=e;f.RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION=g}),66);
__d("MAWParseRavenMsg",["MAWConfig","MAWMsg","MAWMsgType","MAWParseSubprotocolVersionConsts","WALogger","WAMediaTransport.pb","WAParseMediaTransportProtocol","decodeProtobuf","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n        received video messsage version is older than expected ",". "]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n        received image messsage version is older than expected ",". "]);i=function(){return a};return a}function a(a){var b=a.content;a=a.meta;if(!d("MAWConfig").getConfig().isRavenMessagesEnabled())return{unstoredMedia:null,unstoredMsg:null,unstoredQuotedMedia:null,unstoredXMA:null};b=b.ravenMessage;if(b==null)throw c("err")("Raven message payload has no content");var e=d("MAWMsg").MAWRavenMsgEphemeralType.cast(b.ephemeralType);if(e==null)throw c("err")("Error when casting ephemeralType for Raven message");var f=void 0;if(b.imageMessage)(b.imageMessage.version==null||b.imageMessage.version<d("MAWParseSubprotocolVersionConsts").RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(i(),d("MAWParseSubprotocolVersionConsts").RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION),f=d("WAParseMediaTransportProtocol").decodeImageTransport(b.imageMessage.payload,a.ts);else if(b.videoMessage){(b.videoMessage.version==null||b.videoMessage.version<d("MAWParseSubprotocolVersionConsts").RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(h(),d("MAWParseSubprotocolVersionConsts").RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION);b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").VideoTransportSpec,b.videoMessage.payload);f=d("WAParseMediaTransportProtocol").parseVideoMsg(b,a.ts,!1)}else throw c("err")("Error unsupported Raven message type");if(f==null)throw c("err")("Error Raven message has no associated image or video");b={ack:a.ack,id:a.id,mediaId:f.plaintextHash,ravenEphemeralMediaState:e===d("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT?d("MAWMsg").MAWRavenMsgEphemeralMediaState.PERMANENT:d("MAWMsg").MAWRavenMsgEphemeralMediaState.UNSEEN,ravenEphemeralType:e,reportingMeta:a.reportingMeta,sentTs:a.sentTs,serverTs:a.serverTs,ts:a.ts,type:d("MAWMsgType").MSG_TYPE.RAVEN};return{unstoredMedia:f,unstoredMsg:b,unstoredQuotedMedia:null,unstoredXMA:null}}g.parseRavenMessage=a}),98);
__d("WAAckLevel",[],(function(a,b,c,d,e,f){"use strict";a={SENDER_BACKFILL_SENT:-7,INACTIVE_RECEIVED:-6,CONTENT_UNUPLOADABLE:-5,CONTENT_TOO_BIG:-4,CONTENT_GONE:-3,EXPIRED:-2,FAILED:-1,CLOCK:0,SENT:1,RECEIVED:2,READ:3,PLAYED:4};f.ACK=a}),66);
__d("MAWParseScreenshotActionMsg",["MAWExternalId","MAWMsgType","WAAckLevel","WAArmadilloApplication.pb","WAJids","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.content;a=a.meta;b=b.screenshotAction;if(b==null)throw c("err")("screenshotAction has no content");b=b.screenshotType;if(b==null)throw c("err")("Missing screenshot type in payload");if(![d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE,d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING].includes(b))throw c("err")("Received unexpected screenshot action type");b={ack:d("WAAckLevel").ACK.SENT,id:{author:d("WAJids").AUTHOR_SYSTEM,chat:a.id.chat,externalId:d("MAWExternalId").generateExternalId()},msgContent:{adminMsgContent:[],adminType:"youEphemeralTakeScreenshot",screenshotActionType:b},ts:a.serverTs,type:d("MAWMsgType").EPHEMERAL_SCREENSHOT_ACTION};return{contentTypeForLogging:"screenshotAction",unstoredMedia:null,unstoredMsg:b,unstoredQuotedMedia:null,unstoredXMA:null}}g.parseEphemeralScreenshotActionProtocol=a}),98);
__d("MAWParseArmadilloProtocol",["MAWMsgType","MAWParseBumpExistingMessageMsg","MAWParseNoteReplyMsg","MAWParseRavenActionNotificationMsg","MAWParseRavenMsg","MAWParseScreenshotActionMsg","MAWParseXMAProtocol","WAArmadilloApplication.pb","WAGlobals","WAHex","WALogger","decodeProtobuf","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWParseArmadilloProtocol - Dropping message. contentType: ",", reason: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWParseArmadilloProtocol - handling futureproof message for contentType: ",""]);i=function(){return a};return a}var j={unstoredMedia:null,unstoredMsg:null,unstoredQuotedMedia:null,unstoredXMA:null},k=new Map([["screenshotAction",d("MAWParseScreenshotActionMsg").parseEphemeralScreenshotActionProtocol],["extendedContentMessage",d("MAWParseXMAProtocol").parseXMAProtocol],["ravenActionNotifMessage",d("MAWParseRavenActionNotificationMsg").parseRavenActionNotificationMessage],["ravenMessage",d("MAWParseRavenMsg").parseRavenMessage],["noteReplyMessage",c("MAWParseNoteReplyMsg")],["bumpExistingMessage",c("MAWParseBumpExistingMessageMsg")]]);function a(a,b,c,e,f,g){b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAArmadilloApplication.pb").ArmadilloSpec,b);b=(b=b.payload)==null?void 0:b.content;if(!b)return j;var n=m(b);try{var o=k.get(n);if(o!=null)return o({chat:a,content:b,meta:c,metadata:g,protobuf:e},f);d("WALogger").LOG(i(),n);return{contentTypeForLogging:n,unstoredMedia:null,unstoredMsg:{ack:c.ack,id:c.id,msgContent:{protobuf:d("WAHex").bytesToBuffer(e),subtype:l(n)},reportingMeta:c.reportingMeta,sentTs:c.sentTs,serverTs:c.serverTs,ts:c.ts,type:d("MAWMsgType").MSG_TYPE.FUTUREPROOF},unstoredQuotedMedia:null,unstoredXMA:null}}catch(a){d("WALogger").ERROR(h(),n,a);return j}}function l(a){if(!d("WAGlobals").getConfig().isUnsupportedMessagesRedesignEnabled())return null;switch(a){case"bumpExistingMessage":return"bumpMessage";default:return null}}function m(a){var b=Object.keys(a).filter(function(a){return a!=="$$unknownFieldCount"});if(b.length!==1)throw c("err")(JSON.stringify(a)+" armadillo payload content should only have one field");a=b[0];return a}g.EMPTY_CONTENT=j;g.parseArmadilloProtocol=a}),98);
__d("WAParseMessageApplication",["decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b,c,e=a.payload;if(e==null)return{version:"v3",type:"error",error:"The messageApplication has no payload"};if(d("decodeProtobuf").getUnknownFields(a.payload)!=null)return{version:"v3",type:"error",error:"There are unknown fields in the message application payload"};e=e.subProtocol;if(e==null)return{version:"v3",type:"error",error:"The messageApplication payload has no subProtocol"};if(d("decodeProtobuf").getUnknownFields(e)!=null)return{version:"v3",type:"error",error:"messageApplication subProtocol has unknown fields",futureProof:e.futureProof};e=[];b=(b=a.payload)==null?void 0:(b=b.subProtocol)==null?void 0:b.consumerMessage;c=(c=a.payload)==null?void 0:(c=c.subProtocol)==null?void 0:c.armadillo;a=(a=a.payload)==null?void 0:(a=a.subProtocol)==null?void 0:a.multiDevice;if(b!=null){if(b.payload==null)return{version:"v3",type:"error",error:"subprotocol of type consumerMessage has no payload"};e.push({payload:new Uint8Array(b.payload),type:"success",subprotocolType:"consumerMessage"})}if(c!=null){if(c.payload==null)return{version:"v3",type:"error",error:"subprotocol of type armadillo has no payload"};e.push({payload:new Uint8Array(c.payload),type:"success",subprotocolType:"armadillo"})}if(a!=null){if(a.payload==null)return{version:"v3",type:"error",error:"subprotocol of type multiDevice has no payload"};e.push({payload:new Uint8Array(a.payload),type:"success",subprotocolType:"multiDevice"})}return e.length!==1?{version:"v3",type:"error",error:"Wrong number of subprotocols: "+e.length}:e[0]}g.parseMessageApplication=a}),98);
__d("MAWParseXMAProtocol",["ACTSanitizerApiTypes","MAWConfig","MAWMsgType","MAWODSProxy","MAWParseArmadilloProtocol","MAWParseSubprotocolVersionConsts","MAWXMALoggingUtils","WAArmadilloXMA.pb","WAHex","WALogger","WAMedia","WAMsgApplication.pb","WAOdsEnums","WAParseConsumerMessageProtocol","WAParseMediaTransportProtocol","WAParseMessageApplication","WAParseProtocolUtils","WAStanzaUtils","WATimeUtils","decodeProtobuf","err","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["S410301 The url contains RTL characters"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(['S410301 The url is invalid. It contains a colon separator, but not "://"']);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid message text during XMA restore"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid url prefix during XMA restore"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid native URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid action URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid action and native URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["ExternalId: "," textId: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n      received previews version is older than expected ",". "]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n    received favicon version is older than expected ",". "]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n    received headerImage version is older than expected ",". "]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n      received associatedMessage version is older than expected "," as expected. "]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["extendedContentMessage does not have valid XMA content, dropping message"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[XMA] received associated message with incorrect version ",""]);u=function(){return a};return a}var aa=new Set([d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY]);function v(a,b){return a==null||a.payload==null?void 0:d("WAParseMediaTransportProtocol").decodeImageTransport(a.payload,b)}function ba(a,b,e,f,g){if(b==null||b.payload==null)return null;b.version!==d("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION&&d("WALogger").ERROR(u(),b.version);b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMsgApplication.pb").MessageApplicationSpec,b.payload);b=d("WAParseMessageApplication").parseMessageApplication(b);if(b.type==="error")throw c("err")("XMA contains unparseable message application.");b=b;if(b.subprotocolType!=="consumerMessage")throw c("err")("XMA contains incorrect message application type: "+b.subprotocolType);return d("WAParseConsumerMessageProtocol").parseConsumerMessageProtocol(a,b.payload,e,f,g)}var w="https://www.instagram.com/stories/",x="https://www.instagram.com/reel/",y="https://www.instagram.com/tv/",z="https://www.instagram.com/_n/profile_shop?",A="https://www.instagram.com/",B="https://www.alpha.facebook.com/share/",C="https://m.facebook.com/share/",D="https://www.facebook.com/share/",E="https://m.alpha.facebook.com/share/",F="https://facebook.com/share/",G="https://www.alpha.facebook.com/stories/",H="https://www.facebook.com/stories/",I="https://fb.gg/",J="https://www.facebook.com/",K="https://m.facebook.com/",L="https://www.alpha.facebook.com/",M="https://m.alpha.facebook.com/",N="https://facebook.com/",O="https://fb.watch/",P="https://www.facebook.com/l.php",Q="https://m.facebook.com/l.php",R="https://www.alpha.facebook.com/l.php",S="https://m.alpha.facebook.com/l.php",ca="https://facebook.com/l.php",da="https://l.facebook.com/l.php",T="https://facebook.com/events/",ea="https://www.facebook.com/events/",fa="https://www.alpha.facebook.com/events/",ga="https://m.facebook.com/events/",ha="https://m.alpha.facebook.com/events/",U="fb-messenger://payments/receipt?product_id=",V="messenger://location_share",ia="http://m.me/",ja=":",W="http://",ka="https://";function a(a,b){var e=a.chat,f=a.content,g=a.meta,h=a.metadata;a=a.protobuf;f=f.extendedContentMessage;if(f==null)throw c("err")("extendedContentMessage has no content");var i=f.targetType;try{b=b(f);if(b===d("ACTSanitizerApiTypes").ACTSanitizerValidationResult.Valid)d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"xma_validation.valid"});else{d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"xma_validation.invalid"});d("WALogger").WARN(t());return d("MAWParseArmadilloProtocol").EMPTY_CONTENT}}catch(a){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"xma_validation.error"});throw c("err")("Unexpected error trying to validate XMA content: "+a.message)}if(i==null||!d("MAWConfig").getConfig().supportedXMATargetTypes().has(i))return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:{ack:g.ack,id:g.id,msgContent:{protobuf:d("WAHex").bytesToBuffer(a),subtype:ma(i)},reportingMeta:g.reportingMeta,sentTs:g.sentTs,serverTs:g.serverTs,ts:g.ts,type:d("MAWMsgType").MSG_TYPE.FUTUREPROOF},unstoredQuotedMedia:null,unstoredXMA:null,xmaTargetTypeForLogging:i};b=d("WAParseProtocolUtils").parseEphemerality(g,h);var j=b.deleteTs,k=b.ephemeralSetting;b=b.expirationTs;var l=d("WAParseProtocolUtils").enhanceReportingMeta(g,h),m=f.associatedMessage,n=f.contentRef,u=f.ctas,w=f.favicon,x=f.headerImage,y=f.headerTitle,z=f.maxSubtitleNumOfLines,A=f.maxTitleNumOfLines,B=f.messageText,C=f.overlayDescription,D=f.overlayIconGlyph,E=f.overlayTitle,F=f.previews,G=f.sentWithMessageId,H=f.subtitleText,I=f.targetId,J=f.targetUsername,K=f.titleText,L=f.xmaLayoutType;m!=null&&(m.version==null||m.version<d("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(s(),d("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION);x!=null&&(x.version==null||x.version<d("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(r(),d("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION);w!=null&&(w.version==null||w.version<d("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(q(),d("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION);F.every(function(a){(a.version==null||a.version<d("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(p(),d("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION)});f=f.targetExpiringAtSec!=null?d("WATimeUtils").castLongIntToUnixTime(f.targetExpiringAtSec):void 0;var M=m!=null&&G!=null?[d("WAStanzaUtils").toStanzaId(G),g.id.externalId]:[g.id.externalId,void 0],N=M[0];M=M[1];var O=[];if(F!=null)for(var P=0;P<F.length;P++){var Q,R=v(F[P],g.ts);R!=null&&!((i===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE||i===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE)&&R.mediaType===d("WAMedia").MEDIA_TYPE.IMAGE&&((Q=R.validatedImageInfo)==null?void 0:Q.height)===1&&((Q=R.validatedImageInfo)==null?void 0:Q.width)===1)&&O.push(R)}Q=v(x,g.ts);R=v(w,g.ts);F=(P=d("WAParseConsumerMessageProtocol").parsedQuotedConsumerMessage(h))!=null?P:void 0;x=babelHelpers["extends"]({deleteTs:j,ephemeralSetting:k,expirationTs:b,id:babelHelpers["extends"]({},g.id,{externalId:N}),quote:F,reportingMeta:l,type:d("MAWMsgType").MSG_TYPE.XMA},g);w=u.map(function(a){a.actionContentBlob;a=babelHelpers.objectWithoutPropertiesLoose(a,["actionContentBlob"]);return a});P=w.slice(1);i===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE&&u.length===1&&(P=w);b={author:g.id.author,contentRef:n,ctas:P,defaultCTA:w[0],externalId:N,faviconMediaId:(j=R==null?void 0:R.plaintextHash)!=null?j:void 0,headerMediaId:(k=Q==null?void 0:Q.plaintextHash)!=null?k:void 0,headerTitle:y,isTombstoned:f!=null?d("WATimeUtils").unixTime()>f:!1,maxSubtitleNumOfLines:z,maxTitleNumOfLines:A,overlayDescription:C,overlayIconGlyph:D,overlayTitle:E,previewMediaIds:O.length>0?O.map(function(a){return a.plaintextHash}):void 0,sentWithMessage:B,subtitleText:H,targetExpiringAtSec:f,targetId:I,targetType:i,targetUsername:J,threadJid:e,titleText:K,xmaLayoutType:L};var S;if(m!=null&&G==null)throw c("err")("XMA associatedMessage cannot be received without sentWithMessageId field");m!=null&&M!=null&&(S=ba(e,m,g,a,h));u=(l=(F=S)==null?void 0:F.unstoredMedia)!=null?l:null;n=d("MAWConfig").getConfig().isMediaAssociatedXMAsEnabled()===!0&&aa.has(i);if(u!=null&&!n){P=d("MAWXMALoggingUtils").getXmaTargetTypeStringFromEnum(i);d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"assoc_msg_media_"+((w=P)!=null?w:"unknown")});throw c("err")("XMA associated msg cannot have additioinal dbMedia")}y=(k=(j=S)==null?void 0:j.unstoredMsg)!=null?k:null;M!=null&&y!=null&&(d("WALogger").DEV(o(),N,M),y.id=babelHelpers["extends"]({},y.id,{externalId:M}),x.id=babelHelpers["extends"]({},y.id,{externalId:N}),b.externalId=N);if(n&&u!=null&&((y==null?void 0:y.type)==="Gif"||(y==null?void 0:y.type)==="Sticker"))return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:x,unstoredQuotedMedia:null,unstoredXMA:{unstoredAssociatedMedia:u!=null?u:void 0,unstoredAssociatedMsg:y!=null?y:void 0,unstoredFavicon:R,unstoredHeaderMedia:Q,unstoredPreviews:O.length>0?O:void 0,xma:b},xmaTargetTypeForLogging:i};if(y!=null&&y.type!=="Text")throw c("err")('XMA associated msg cannot have type different from "Text". Received type: '+y.type);return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:x,unstoredQuotedMedia:null,unstoredXMA:{unstoredAssociatedMedia:void 0,unstoredAssociatedMsg:y!=null?y:void 0,unstoredFavicon:R,unstoredHeaderMedia:Q,unstoredPreviews:O.length>0?O:void 0,xma:b},xmaTargetTypeForLogging:i}}function b(a){var b=a.ctas,d=a.targetType;if(d==null)throw c("err")("extendedContentMessage does not have a targetType");var e=!0;b.forEach(function(a){a.actionContentBlob;a=babelHelpers.objectWithoutPropertiesLoose(a,["actionContentBlob"]);e=e&&X(a,d)});return e}function la(a){var b=a.ebRestore,c=a.hasActionUrl,e=a.hasNativeUrl,f=a.isActionUrlValid,g=a.isNativeUrlValid;a=a.targetType;!g&&!f?d("WALogger").ERROR(n(),b!=null&&b?"[labyrinth_web]":"[S410301][transport]",a,e,c):g&&!f?d("WALogger").ERROR(m(),b!=null&&b?"[labyrinth_web]":"[S410301][transport]",a,e,c):f&&!g&&d("WALogger").ERROR(l(),b!=null&&b?"[labyrinth_web]":"[S410301][transport]",a,e,c)}function X(a,b,c){var d=a.nativeUrl;a=a.actionUrl;var e=Y(d,b,c),f=Y(a,b,c);la({ebRestore:c,hasActionUrl:a!=null,hasNativeUrl:d!=null,isActionUrlValid:f,isNativeUrlValid:e,targetType:b});return e&&f}function ma(a){if(!c("gkx")("1564"))return null;switch(a){case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2:return"locationMessage";case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_CONTACT:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_AI_CONTACT:return"contactShareMessage";case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION:return"storyMentionMessage";default:return null}}function Y(a,b,c){if(a==null)return!0;if(pa(a,b)===!1){c!=null&&c&&d("WALogger").ERROR(k());return!1}if(!qa(a)){c!=null&&c&&d("WALogger").ERROR(j());return!1}return!0}function Z(a){return a.startsWith(B)||a.startsWith(C)||a.startsWith(D)||a.startsWith(E)||a.startsWith(F)}function na(a){return a.startsWith(P)||a.startsWith(Q)||a.startsWith(R)||a.startsWith(S)||a.startsWith(ca)||a.startsWith(da)}function $(a){return a.startsWith(J)||a.startsWith(K)||a.startsWith(L)||a.startsWith(M)||a.startsWith(N)}function oa(a){return a.startsWith(T)||a.startsWith(ea)||a.startsWith(fa)||a.startsWith(ga)||a.startsWith(ha)}function pa(a,b){if(a==null)return!0;switch(b){case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_HIGHLIGHT_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_HIGHLIGHT_REACTION:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_MENTION:return a.startsWith(w);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE:return a.startsWith(x);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE:return a.startsWith(y);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE:return a.startsWith(z);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_IG_MEDIA_SHARE:return a.startsWith(A);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION:return a.startsWith(H)||a.startsWith(G)||Z(a);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE:return a.startsWith(I);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_PRIVATE_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE:return($(a)||a.startsWith(O))&&!na(a);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2:return a.startsWith(V);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_HIGHLIGHTS_TAB_LOCAL_EVENT_REPLY:return oa(a);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT:return oa(a)||Z(a);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_CONTACT:return $(a)||a.startsWith(ia);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_EXTERNAL_LINK:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_AUDIO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_VIDEO_CALL:if(a.includes(ja)&&(!a.startsWith(W)&&!a.startsWith(ka))){b=a.indexOf("://");b===-1&&d("WALogger").ERROR(i());return!1}break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_RECEIVER_FETCH:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.DATACLASS_SENDER_COPY:return!0;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_P2P_PAYMENT:return a.startsWith(U)}return!0}function qa(a){for(var b=0;b<a.length;b++){var c=a.charAt(b);switch(c){case"\u202c":case"\u202d":case"\u202e":d("WALogger").ERROR(h());return!1;default:break}}return!0}g.kIGStoryCtaPrefix=w;g.kIGClipsCtaPrefix=x;g.kIGTVCtaPrefix=y;g.kIGShopCtaPrefix=z;g.kIGDefaultCtaPrefix=A;g.kFBStoryCtaPrefix=H;g.kFBGamingCustomUpdateCtaPrefix=I;g.kFBDefaultWWWCtaPrefix=J;g.kFBEventCtaPrefix=T;g.kMSGP2PPaymentUrlPrefix=U;g.kMessengerLocationSharePrefix=V;g.kHttpPrefix=W;g.parseXMAProtocol=a;g.isXMAContentValid=b;g.isValidCTA=X}),98);
__d("MAWHandleEchoXMARestoreV2",["EchoMessage","LSDataTraceCheckPoint","LSIntEnum","MAWBridge","MAWBridgeXMA","MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph","MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWDbMediaTxns","MAWDbMsg","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWODSProxy","MAWParseXMAProtocol","MAWTraceUtils","MAWTransactionMode","Promise","WAArmadilloXMA.pb","WALogger","WAMediaUtils","WAOdsEnums","WATimeUtils","asyncToGeneratorRuntime","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid CTA observed while restoring XMA. Echo message origin ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] threadJid field is not present in the restoredMsg. Echo message origin ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaLayoutType field is not present in the echo doc. Echo message origin ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaGatingType field is not present in the echo doc. Echo message origin ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaTargetType field is not present in the echo doc. Echo message origin ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaDefaultCTA field is not present in the echo doc. Echo message origin ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaData is missing in the echo doc. Echo message origin ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] msgContent is null for external link share XMA on Restore. Echo message origin ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] dbXMA is null. EchoMessage origin ",""]);r=function(){return a};return a}a=function(a,e,f,g){f==null?void 0:f.addPoint("xma_restore_start");d("MAWTraceUtils").recordCheckpointForTrace(g,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_XMA_RESTORE_STARTED),[],!1);var j=a.restoredMsgsData;if(j){var k=j.newlyAddedMsgs;k=k.concat(j.existingMsgs);var l=[];k.map(function(b){var c=b.externalId;c=a.echoMsgMap.get(c);c!=null&&(c.contentType===d("EchoMessage").EchoMessageContentType.XMA&&l.push(b))});return l.length===0?(h||(h=b("Promise"))).resolve():s(l,a.echoMsgMap,e,g).then(function(a){f==null?void 0:f.addPoint("xma_restore_end",{"int":{xma:a.length}});d("MAWTraceUtils").recordCheckpointForTrace(g,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_XMA_RESTORE_ENDED),[],!1);return(h||(h=b("Promise"))).resolve()})}f==null?void 0:f.addPoint("xma_restore_end",{"int":{xma:0}});return(h||(h=b("Promise"))).resolve()};function s(a,e,f,g){var h=new Map(a.map(function(a){var b=e.get(a.externalId);b=b==null?void 0:(b=b.mediaData)==null?void 0:b.attachmentObjectId;if(b!=null)return[d("WAMediaUtils").stringToDeliveryObjectId(b),a]}).filter(Boolean)),j=Array.from(h.keys()),k=new Map();return t(j).then(function(l){var m=[];j.forEach(function(a){var b;b=(b=h.get(a))==null?void 0:b.externalId;b!=null&&k.set(b,a)});a.filter(function(a){return d("MAWDbMsg").isXMAMsg(a)}).forEach(function(a){var b=e.get(a.externalId);if(b){var f=k.get(a.externalId),h;if(f!=null){f=l.get(f);f!=null&&(h=f.mediaId)}f=b.serializationOrigin;f==null&&(f=d("EchoMessage").EchoSerializationOriginType.UNKNOWN);b=v(a,b,h,f);b==null?(d("WALogger").ERROR(r(),f),d("MAWTraceUtils").recordCheckpointForTrace(g,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_XMA_RESTORE_DBXMA_NULL),[],!1)):(b.targetType===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE&&a.msgContent==null&&(d("WALogger").WARN(q(),f),d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.EB_RESTORE,key:"missing_msg_content_external_link_xma"})),m.push(b))}});return u(m).then(function(a){if(a.length>0){a.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=k.get(a.externalId);if(f!=null){var e;b!=null&&(e=l.get(b));c("gkx")("821")?b=(yield d("MAWHandleXmaTransactionUtil").checkMediaChunkTransactionAndCreatedBridgeXma(e,a)):b=d("MAWBridgeXMA").createBridgeXMA(e,a,!1);d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewXMA",value:b}]})}});return function(b){return a.apply(this,arguments)}}());return a}return a})})}var t=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY,mediaBackup:d("MAWTransactionMode").READONLY},"restoreGetMediaForXMAByObjectIds",function(a){return function(b){return d("MAWDbMediaTxns").maybeGetMediaBackupRowsFromObjectIds(a,b).then(function(b){var c=Array.from(b.values()).map(function(a){return a.mediaId});return a.media.bulkGet(c).then(function(a){var c=new Map();a!=null&&a.forEach(function(a){a!=null&&c.set(a.mediaId,a)});var d=new Map();b.forEach(function(a,b){a=c.get(a.mediaId);a!=null&&d.set(b,a)});return d})})}}),u=d("MAWIndexedDb").makeMsgrTransactor({xma:d("MAWTransactionMode").READWRITE},"restoreWriteXMAsToDb",function(a){return function(b){return a.xma.bulkAdd(b,{allKeys:!0}).then(function(a){return a.map(function(a,c){return babelHelpers["extends"]({},b[c],{xmaId:a})})})}});function v(a,b,c,e){var f;if(b.xmaData==null){d("WALogger").ERROR(p(),e);return null}var g;if(b.xmaData.xmaDefaultCTA!=null){var h;g=w((h=b.xmaData)==null?void 0:h.xmaDefaultCTA)}else d("WALogger").WARN(o(),e);if(((h=b.xmaData)==null?void 0:h.xmaTargetType)!=null)h=d("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(b.xmaData.xmaTargetType);else{d("WALogger").ERROR(n(),e);return null}var i;((f=b.xmaData)==null?void 0:f.xmaGatingType)!=null?i=d("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph").convertXMAGatingTypeToExtendedContentOverlayIconGlyph(b.xmaData.xmaGatingType):d("WALogger").WARN(m(),e);var q;((f=b.xmaData)==null?void 0:f.xmaLayoutType)!=null?q=d("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType").convertXMALayoutTypeToExtendedContentXMLLayoutType(b.xmaData.xmaLayoutType):d("WALogger").WARN(l(),e);if(a.threadJid!=null)f=a.threadJid;else{d("WALogger").ERROR(k(),e);return null}if(g!=null&&!d("MAWParseXMAProtocol").isValidCTA(g,h,!0)){d("WALogger").ERROR(j(),e);return null}var r;((e=b.xmaData)==null?void 0:e.xmaContentRef)!=null&&(r=b.xmaData.xmaContentRef);return{author:a.author,contentRef:r,ctas:[],defaultCTA:g,defaultPreviewMediaId:(e=c)!=null?e:void 0,externalId:a.externalId,headerTitle:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaHeaderTitle,isTombstoned:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaIsTombstoned,maxSubtitleNumOfLines:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaMaxSubtitleNumLines,maxTitleNumOfLines:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaMaxTitleNumLines,msgId:a.msgId,overlayIconGlyph:i,overlayTitle:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaHeaderSubtitle,previewMediaIds:c!=null?[c]:[],subtitleText:b==null?void 0:(a=b.xmaData)==null?void 0:a.xmaSubtitleText,targetExpiringAtSec:((e=b.xmaData)==null?void 0:e.xmaTargetExpiry)!=null?d("WATimeUtils").castToUnixTime(Number((c=b.xmaData)==null?void 0:c.xmaTargetExpiry)):void 0,targetId:b==null?void 0:(a=b.xmaData)==null?void 0:a.xmaTargetId,targetType:h,targetUsername:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaTargetUsername,threadJid:f,titleText:(c=b.xmaData)==null?void 0:c.xmaTitleText,xmaLayoutType:q}}function w(a){return{actionUrl:a,buttonType:d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_CTA_BUTTON_TYPE.OPEN_NATIVE,nativeUrl:a}}g.writeXMAToXMAStore=a;g.getMediaForXMAByObjectIds=t;g.writeXMAsToDb=u}),98);
__d("MAWHandlePointRestoredMsgV2",["EBUploadMessages","MAWEBUploadTrackingUtils","MAWEncryptedBackupCacheManager","MAWIndexedDb","MAWTransactionMode","Promise","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Completed handling of point restored message"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Completed handling of point restored message"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Started handling of point restored message"]);k=function(){return a};return a}function a(a){d("WALogger").LOG(k());a=a.restoredMsgsData;if(a){var c=a.existingMsgs;a=a.newlyAddedMsgs;a=a.concat(c);var e=[],f=new Map(),g=[],l=new Map();a.filter(function(a){return d("MAWEncryptedBackupCacheManager").checkForMsgEntryInReuploadCache(a.threadJid,a.externalId)}).forEach(function(a){e.push(a);g.push(a.externalId);var b=d("MAWEBUploadTrackingUtils").genInstanceKeyOnly();l.set(a.externalId,b);d("MAWEBUploadTrackingUtils").startUploadTracking(a.externalId,a.type,"pointrestore",b)});c=m(g);return c.then(function(a){a.forEach(function(a){var b=a.quoteExternalId;b!=null&&f.set(b,a)});return e.length>0?d("EBUploadMessages").uploadUniqueMessage(e,f,void 0,void 0,l).then(function(a){e.forEach(function(a){d("MAWEncryptedBackupCacheManager").removeMsgEntryFromReuploadCache(a.threadJid,a.externalId)})}):(h||(h=b("Promise"))).resolve()}).then(function(a){d("WALogger").LOG(j())})}d("WALogger").LOG(i());return(h||(h=b("Promise"))).resolve()}function l(a,b){return a.messages.where("quoteExternalId").anyOf(b).toArray()}var m=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY},"maybeBatchGetMsgsByQuoteExternalId",function(a){return function(){for(var b=arguments.length,c=new Array(b),d=0;d<b;d++)c[d]=arguments[d];return l.apply(void 0,[a].concat(c))}});g.uploadPointRestoredMessageIfRequired=a}),98);
__d("MAWRestoreMsgsUiUpdator",["MAWBridgeEventTransmitter","MAWDbMsg","MAWDbThread","MAWDexieTable","MAWFolderTypes","MAWThreadSnippetBuildTxns","gkx","qex"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f,g,j,l,m,n,o,p,q,r){g=h(a,g,c,e,f,l,m);return g.then(function(c){if(m==null||j){var e=k(c);e&&!q&&d("MAWBridgeEventTransmitter").updateThreadOutsideTxn(c.cannotReplyReason,d("MAWFolderTypes").FOLDER_ID.INBOX,c.chatId,c.jid);return i(a,b,c,n,o,p,m,q).then(function(){return c})}return c}).then(function(b){return d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,b,r)}).then(function(){})}function h(a,b,c,e,f,g,h){var i=babelHelpers["extends"]({},b,{lastReadMsg:g,lastReadMsgTs:f,newestMsg:c,newestMsgTs:e,oldestMsg:h,threadOrder:d("MAWDbThread").craftThreadOrder(e,b.jid)});return a.threads.put(i).then(function(){return i})}function i(a,b,e,f,g,h,i,k){var l=b.map(function(a){return a}).reverse(),m=e.chatId,n=e.jid;if(f!=null){f=d("MAWDbMsg").toMsgId(f);if(f!=null)return a.messages.get({msgId:f}).then(function(f){if(f!=null){f=f.sortOrderMs;var o;c("gkx")("23906")||c("qex")._("1016")?o=d("MAWDexieTable").dexieResolve(0):o=a.messages.where(["threadJid","sortOrderMs"]).between([n,l[0].sortOrderMs],[n,f],!1,!1).count();return o.then(function(a){a===0&&(j(l,g,e,k),k||d("MAWBridgeEventTransmitter").issueMsgLoadedEventAfterTxn(m,e.jid,l,i===null,h,!1));return{chatId:m,restoredMessages:b}})}return{chatId:m,restoredMessages:b}})}k||d("MAWBridgeEventTransmitter").issueMsgLoadedEventAfterTxn(m,e.jid,l,i===null,h,!1);return d("MAWDexieTable").dexieResolve({chatId:m,restoredMessages:b})}function j(a,b,c,e){var f=b==null?void 0:b.sortOrderMs,g=a[a.length-1],h=g.sortOrderMs;b!=null&&g!=null&&f!=null&&h!=null&&f<h&&(a.push(b),e||d("MAWBridgeEventTransmitter").deleteMessageRangesV2AfterTxn(b.msgId,d("MAWDbMsg").getSortOrderWithFallback(b),c.jid))}function k(a){return a.archived===!0&&a.cannotReplyReason!=="viewer_not_subscribed"}g.updateThreadAndMessages=a;g.shouldThreadBeUnarchived=k}),98);
__d("MAWRestoreMsgsTxns",["ArmadilloDataTraceType","FBLogger","LSMEBTaskCreationSource","MAWBridgeEventTransmitter","MAWBridgeTypesCreators","MAWDbMsg","MAWDbMsgTxns","MAWDexieTable","MAWEBBackendQPLUtils","MAWFTSTxns","MAWIndexedDb","MAWLocalizationType","MAWMessageHasUniqueExternalIdValidator","MAWMsgType","MAWQplProxy","MAWRestoreMsgsUiUpdator","MAWTimeUtils","MAWTransactionMode","WAHashStringToNumber","WAJids","WALogger","WATimeUtils","gkx","qpl"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to create restored messages and update thread metadata ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Thread with jid "," does not exist for restore"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["DYI attempting to re-restore previous batch - halting DYI for thread ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] DYI for thread with jid "," is not currently in progress"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["error occurred on restore - stopping DYI for thread with chat jid ",""]);l=function(){return a};return a}function m(a,b,c){return c!=null?a.messages.where(["threadJid","sortOrderMs"]).between([b.jid,c.ts],[b.jid,d("MAWDbMsg").MAX_MSG_SORT_ORDER],!1,!0).limit(1).first():d("MAWDexieTable").dexieResolve()}function a(a,b,c){return d("MAWDbMsgTxns").maybeGetMsg(a,c).then(function(c){if(c!=null)return a.messages.where(["threadJid","sortOrderMs"]).between([b.jid,c.sortOrderMs],[b.jid,d("MAWDbMsg").MAX_MSG_SORT_ORDER],!1,!0).limit(1).first();else return d("MAWDexieTable").dexieResolve()})}function n(a){return a!=null&&a.type===d("MAWMsgType").MSG_TYPE.ADMIN&&(a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION||a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_THREAD_ADMIN_MESSAGE||a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_IGD_THREAD_ADMIN_MESSAGE||a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.DUAL_THREAD_CUTOVER_ADMIN_MESSAGE)}var o=(e=d("MAWIndexedDb")).makeMsgrTransactor({messages:(f=d("MAWTransactionMode")).READONLY},"checkForDecryptionFailuresToPointRestore",function(a){return function(){return a.messages.filter(function(a){return a.type===d("MAWMsgType").MSG_TYPE.UNAVAILABLE||a.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT}).toArray().then(function(a){a.forEach(function(a){a.threadJid!=null&&d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(a.externalId,d("WAJids").threadIdForChatJid(a.threadJid),void 0,c("LSMEBTaskCreationSource").EB_POINT_QUERY_RETRY_DECRYPTION_FAILURES,a.threadJid)})})}});function p(a,b,c,e,f,g,h,i,j,k,l){var m=g.isOldestMsgUpdated,n=g.lastReadMsg,o=g.lastReadMsgTs,p=g.newestMsgId,q=g.newestMsgTs,s=g.oldestMsgId,t=!0;return d("MAWDbMsgTxns").getThreadNewestMessageId(a,c).then(function(g){b&&(g!=null&&(t=r(g,e)));g=d("MAWDexieTable").dexieResolve();t&&(f.length>0&&(g=d("MAWRestoreMsgsUiUpdator").updateThreadAndMessages(a,f,p,q,o,c,m,n,s,h,i,j,k,l)));return g.then(function(){if(k)return D(a,e,c,j);else return d("MAWDexieTable").dexieResolve()})})}function b(a){var b=a.bumpMessageAuthorMap,e=a.existingMsgs,f=a.hasMoreBefore,g=a.instanceKey,h=a.isDyiInProgress,i=a.isPointRestore,j=a.maybeNewestMsg,k=a.maybeOldestAdminMsg,l=a.maybeOldestMsg,m=a.minMsgId,n=a.newMsgs,o=a.optimisticMsgs,p=a.taskSource;a=a.thread;p=p===c("LSMEBTaskCreationSource").EB_POINT_QUERY_RETRY_DECRYPTION_FAILURES;var q=new Map(),r=[];e.map(function(a){a.type===d("MAWMsgType").MSG_TYPE.UNAVAILABLE||a.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?r.push(a):q.set(a.externalId,a)});var s=[];return G(n,e,a.jid,q,j,h,i,k,l,s,o,g,f,m,p,r,b).then(function(a){return a})}function q(a,b,c){a.altIndex!==d("MAWDbMsg").SPAM_ALT_INDEX&&a.altIndex!==d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX&&(d("MAWBridgeEventTransmitter").startTraceOutsideTxn(a,b,d("ArmadilloDataTraceType").armadilloMessageSend),d("MAWBridgeEventTransmitter").issueNewMsgUiEventOutsideTxn(a,c))}function r(a,b){var c=!1;for(var e=0;e<b.length;e++){var f=b[e];d("MAWDbMsg").getInChatMsgIdFromMsgId(a)<=d("MAWDbMsg").getInChatMsgIdFromMsgId(f.msgId)&&(c=!0)}return c}var s=e.makeMsgrTransactor({messages:f.READONLY},"getMsgsByProtocolMsgIds",function(a){return function(){for(var b=arguments.length,c=new Array(b),e=0;e<b;e++)c[e]=arguments[e];return d("MAWDbMsgTxns").getMsgsByProtocolMsgId.apply(void 0,[a].concat(c))}}),t=e.makeMsgrTransactor({messages:f.READONLY},"restoreGetMsg",function(a){return function(b){return d("MAWDbMsgTxns").maybeGetMsg(a,b)}}),u=e.makeMsgrTransactor({messages:f.READONLY},"restoreGetThreadNewestMessage",function(a){return function(b){return d("MAWDbMsgTxns").getThreadNewestMessageBySortOrderOrCache(a,b)}}),v=e.makeMsgrTransactor({messages:f.READONLY},"restoreMaybeGetOldestNonAdminMessage",function(a){return function(b){return d("MAWDbMsgTxns").getThreadOldestMessageBySortOrder(a,b.jid).then(function(c){if(c==null)return d("MAWDexieTable").dexieResolve({maybeOldestAdminMsg:null,maybeOldestMsg:null});else if(n(c))return m(a,b,c).then(function(a){return{maybeOldestAdminMsg:c,maybeOldestMsg:a}});return{maybeOldestAdminMsg:null,maybeOldestMsg:c}})}});function w(a,b,c,e,f,g,h,i,j){return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,b.externalId,c.jid,b.author).then(function(a){if(a!=null)return;a=e.get(b.externalId);if(a==null){a=d("WATimeUtils").castUnixTimeToMillisTime(b.ts);i.newestMsgTs=a>i.newestMsgTs?a:i.newestMsgTs;var k=d("MAWDbMsg").craftMsgIdV2(c.chatId,i.msgNextInChatMsgId,b);i.msgNextInChatMsgId+=1;(i.oldestMsgId==null||!g&&a<i.oldestMsgTs)&&(i.isOldestMsgUpdated=!0,i.oldestMsgId=h!=null&&d("WATimeUtils").castUnixTimeToMillisTime(h.ts)<a?h.msgId:k,i.oldestMsgTs=h!=null&&d("WATimeUtils").castUnixTimeToMillisTime(h.ts)<a?d("WATimeUtils").castUnixTimeToMillisTime(h.ts):a);(i.newestMsgTs===a||n(f))&&(i.newestMsgId=k);b.author===d("WAJids").AUTHOR_ME&&(i.lastReadMsgTs==null||a>i.lastReadMsgTs)&&(i.lastReadMsg=k,i.lastReadMsgTs=a);a=babelHelpers["extends"]({},b,{msgId:k,sortOrderMs:d("MAWDbMsg").getSortOrderWithFallback(b)});j.push(a)}})})).then(function(){})}function x(a,b){d("WALogger").ERROR(l(),b);return a.dyiBatch.filter(function(a){return a.threadId===b}).toArray().then(function(c){var e;e=(e=c.find(function(a){return a.qplInstanceKeyForThread!==null}))==null?void 0:e.qplInstanceKeyForThread;d("MAWEBBackendQPLUtils").markErrorDyiBackupRestoreStoppingDyi(e,b);return a.dyiBatch.bulkDelete(c.map(function(a){return a.batchId}))})}function y(a,b,c){return a.dyiBatch.filter(function(a){return a.isThread&&a.threadId===b}).toArray().then(function(b){b=b[0];if(b.numMessagesRestored!=null)return a.dyiBatch.update(b.batchId,{numMessagesRestored:b.numMessagesRestored+c}).then(function(){})})}function z(a,b,c,d){d={isThread:!1,numMessages:d?b:-1,oldestTs:0,threadId:a.jid};if(c.length>0){b=c.reduce(function(a,b){if(b.sortOrderMs!=null&&a.sortOrderMs!=null&&b.sortOrderMs<a.sortOrderMs)return b;else return a},c[0]);b.sortOrderMs!=null&&(d.oldestTs=b.sortOrderMs)}return d}function A(a,b,c,d,e){var f=z(b,c,d,e);if(e)return C(a,b,f.oldestTs).then(function(d){if(!d)return a.dyiBatch.add(f).then(function(){return y(a,b.jid,c)})});else return a.dyiBatch.add(f).then(function(){return y(a,b.jid,c)})}function B(a,b,c){return a.dyiBatch.filter(function(a){return a.threadId===b.jid}).toArray().then(function(a){var e=!1;for(var f=a,g=Array.isArray(f),h=0,f=g?f:f[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var i;if(g){if(h>=f.length)break;i=f[h++]}else{h=f.next();if(h.done)break;i=h.value}i=i;i.isThread&&(e=!0)}h=(i=a.find(function(a){return a.qplInstanceKeyForThread!==null}))==null?void 0:i.qplInstanceKeyForThread;e||(d("MAWEBBackendQPLUtils").markErrorDyiBackupRestoreBatchNotInProgress(h,b.jid),(c==null||!c)&&d("WALogger").ERROR(k(),b.jid));return e})}function C(a,b,c){return a.dyiBatch.filter(function(a){return!a.isThread&&a.threadId===b.jid}).toArray().then(function(e){if(e.length>0){var f=!1,g=[];for(var e=e,h=Array.isArray(e),i=0,e=h?e:e[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var k;if(h){if(i>=e.length)break;k=e[i++]}else{i=e.next();if(i.done)break;k=i.value}k=k;k.oldestTs<=c?(d("WALogger").ERROR(j(),b.chatId),d("MAWEBBackendQPLUtils").markErrorDyiBackupRestoreThreadHalt(k.qplInstanceKeyForThread,b.chatId),f=!0):g.push(k.batchId)}return f?x(a,b.jid).then(function(a){return!0}):a.dyiBatch.bulkDelete(g).then(function(a){return!1})}return d("MAWDexieTable").dexieResolve(!1)})}function D(a,b,e,f){if(!c("gkx")("23911"))return d("MAWDexieTable").dexieResolve();var g=b.length;return a.dyiBatch.count().then(function(c){return c===0?d("MAWDexieTable").dexieResolve():B(a,e).then(function(c){if(!c)return a.dyiBatch.filter(function(a){return a.threadId===e.jid}).toArray().then(function(b){a.dyiBatch.bulkDelete(b.map(function(a){return a.batchId}))});else return A(a,e,g,b,f)})})}function E(a,b){return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").getThreadNewestMessageId(a,b),d("MAWDbMsgTxns").getThreadNewestMessageTs(a,b),d("MAWDbMsgTxns").getNextMsgIdNumberForThread(a,b)]).then(function(a){var b=a[0],c=a[1];a=a[2];return{newestMsgId:b,newestMsgTs:c,nextInChatMsgId:a}})}function F(a,b,c,e,f,g,h,i,j,k){return w(a,b,c,e,f,g,h,i,j).then(function(b){if(k!=null)for(b=0;b<j.length;b++){var e=j[b],f=e.externalId;f=k.get(f);f!=null&&(e.ts=d("WATimeUtils").castMilliSecondsToUnixTime(f.ts))}d("MAWMessageHasUniqueExternalIdValidator").logMessageAddSource(j.map(function(a){return a.externalId}),"MAWRestoreMsgsTxns.js::createRestoredMessages isPointRestore: "+(g?1:0));return a.messages.bulkAdd(j,{allKeys:!0}).then(function(a){return a.map(function(a,b){return babelHelpers["extends"]({},j[b],{rowId:a})})}).then(function(b){return a.threads.put(c).then(function(){return b})})})}var G=e.makeMsgrTransactor({dyiBatch:f.READWRITE,ftsBackloggedMessages:f.READWRITE,groupInfo:f.READWRITE,messages:f.READWRITE,threads:f.READWRITE},"createRestoredMessagesAndUpdateThread",function(a){return function(b,c,e,f,g,j,k,l,m,n,o,r,s,t,u,v,w){return a.threads.get({jid:e}).then(function(r){if(r==null){d("WALogger").ERROR(i(),e);return d("MAWDexieTable").dexieResolve()}return E(a,r).then(function(e){var i=e.newestMsgId,u=e.newestMsgTs;e=e.nextInChatMsgId;var v={isOldestMsgUpdated:!1,lastReadMsg:r.lastReadMsg,lastReadMsgTs:d("MAWTimeUtils").ensureValidMillisTime(r.lastReadMsgTs),msgNextInChatMsgId:e,newestMsgId:i,newestMsgTs:d("MAWTimeUtils").ensureValidMillisTime(u)||d("WATimeUtils").castToMillisTime(0),oldestMsgId:m==null?void 0:m.msgId,oldestMsgTs:d("WATimeUtils").castUnixTimeToMillisTime((e=m==null?void 0:m.ts)!=null?e:d("WATimeUtils").castToUnixTime(0))};i=d("MAWDexieTable").dexieResolve();return i.then(function(){return d("MAWDexieTable").dexieAll([F(a,b,r,f,g,k,l,v,n,o),d("MAWFTSTxns").maybePutMessagesToBacklog(a,b.map(function(a){return a.externalId}))]).then(function(b){b=b[0];if(!j)for(var d=b,e=Array.isArray(d),f=0,d=e?d:d[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var g;if(e){if(f>=d.length)break;g=d[f++]}else{f=d.next();if(f.done)break;g=f.value}g=g;q(g,r.jid,o)}g=c.concat(b);var h={existingMsgs:c,newlyAddedMsgs:b,threadJid:r.jid};return p(a,k,r,g,b,v,t,l,s,j,w).then(function(){return h})})["catch"](function(a){d("WALogger").ERROR(h(),a)})})})})}});g.getNextMsgBasedOnSortOrderMs=a;g.isE2eeOrCutoverAdminMsg=n;g.checkForDecryptionFailuresToPointRestore=o;g.restoreMsgsForThread=b;g.getMsgsByProtocolMsgIds=s;g.getMsg=t;g.maybeGetThreadNewestMessage=u;g.maybeGetOldestNonAdminMessage=v;g.prepareUnstoredMsgArrayAndUpdateKeyVariables=w;g.stopDyiForThread=x;g.checkIfBatchInProgress=B}),98);
__d("MAWRestoreValidationUtils",[],(function(a,b,c,d,e,f){"use strict";function g(a){return a.reduce(function(a,b){if(b.externalId!=null){a[b.externalId]=((b=a[b.externalId])!=null?b:0)+1;return a}return a},{})}function a(a,b,c,d,e){var f=g(a),h=g(b);if(c==null&&d==null)return;a=c!=null?c.map(function(a){return{externalId:a.otid}}):d!=null?d:[];b=g(a);c=Object.keys(f).filter(function(a){return!h[a]});d=Object.keys(h).filter(function(a){return!f[a]});a=Object.keys(b).filter(function(a){return!f[a]});var i=Object.entries(f).filter(function(a){a[0];a=a[1];return a>1}),j=Object.entries(h).filter(function(a){a[0];a=a[1];return a>1});b=Object.entries(b).filter(function(a){a[0];a=a[1];return a>1});j={"int":{duplicates_in_deanon_reference:j.length,duplicates_in_restore_request:b.length,duplicates_in_restored_messages:i.length,missing_in_deanon_reference:c.length,missing_in_restore_request:a.length,missing_in_restored_messages:d.length}};e==null?void 0:e.addPoint("restore_validation",j);return j}f.compareRestoredMsgstoDeanonData=a}),66);
__d("MAWHandleEchoMsgsRestoreApiV2",["EchoBackupCompareUtils","EchoMessage","LSDataTraceCheckPoint","LSIntEnum","LSMEBTaskCreationSource","MAWAckLevel","MAWBridgeEventTransmitter","MAWDbEditMsgHistoryTxns","MAWDbMsg","MAWDbThreadTxns","MAWDexieTable","MAWEncryptedBackupCacheManager","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleEchoMsgsRestoreApiUtils","MAWHandleEchoReactionsRestore","MAWHandleEchoXMARestoreV2","MAWHandlePendingStanzasInRestoreV2","MAWHandlePointRestoredMsgV2","MAWIndexedDb","MAWJids","MAWQplProxy","MAWRepliesRestoreUtils","MAWRestoreMsgsTxns","MAWRestoreValidationUtils","MAWTraceUtils","MAWTransactionMode","Promise","WAGlobals","WAJids","WAResultOrError","WAStanzaUtils","WATagsLogger","WATimeUtils","asyncToGeneratorRuntime","gkx","promiseDone","qpl","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Oldest message timestamp: "," and newest message timestamp: "," of the batch for thread: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No more messages to restore for thread: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Ignore duplicate restore request of an existing message"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Message ID must not be null"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decode the message"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No messages to be restored for thread: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] timestamp field should not be null as it is required for attachment download retry"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] timestamp field should not be null as it is required for attachment download retry"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] from field is missing from media message"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] from field is missing from media message"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Media data is null for the message: ",""]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Media data is null for the message: ",""]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Echo message is missing from the map: ",""]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Echo message is missing from the map: ",""]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missed restoring optimistic messages for thread: "," count: "," }"]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] threadJidPrimaryId "," missing from index db"]);y=function(){return a};return a}function z(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing thread for thread jid: ",""]);z=function(){return a};return a}function A(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error while restoring media/reaction: ",""]);A=function(){return a};return a}function B(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] handleEchoMsgsRestore v2 completed. newlyAdded: "," existing: "," isPointRestore: ",""]);B=function(){return a};return a}function C(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error while deleting point restored messages: ",""]);C=function(){return a};return a}function D(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Message creation complete. MessagesCreated: "," isPointRestore: "," startSortKey: "," taskSource: ",""]);D=function(){return a};return a}function E(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Low level api handleEchoMsgsRestore v2 initiated restore of "," messages. isPointRestore: "," startSortKey: "," taskSource: ",""]);E=function(){return a};return a}var F=c("requireDeferred")("MAWHandleEBRestoreWithHIM").__setRef("MAWHandleEchoMsgsRestoreApiV2");a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,j,k,l,m,n,o,p,q,r,s){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(j=l)!=null?j:""]).LOG(E(),e.length,f,m,p);j=f?d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.POINT_RESTORE:m!=null?d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.PAGINATED_RESTORE:d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.INITIAL_RESTORE;j=j;var t=q!=null?q:d("MAWQplProxy").startQplUserFlow(c("qpl")._(521486220,"827"),{bool:{uploadedFromEBQueue:s},"int":{messages:e.length},string:{message_backup_type:"echo",restore_type:j,trace_id:(q=l)!=null?q:""}},void 0,3e5);d("MAWTraceUtils").recordCheckpointForTrace(l,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_ECHO_MESSAGE_RESTORE_BEGIN),[],!1);var u=(yield L(a,l,p!=null&&p===c("LSMEBTaskCreationSource").MSGR_DYI)),v={messageIds:[],pendingRestoreSortKeys:[]};if(u){s=G(u,e,f,g,t,k,n,o,l,p,r);var w=a;return s.then(function(g){var j,k=((j=g.restoredMsgsData)==null?void 0:j.newlyAddedMsgs)?(j=g.restoredMsgsData)==null?void 0:j.newlyAddedMsgs.length:0;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(j=l)!=null?j:""]).LOG(D(),k,f,m,p);O(a,g,n,o);return(h||(h=b("Promise"))).all([M(g,t),N(g,t,l,f),d("MAWHandleEchoReactionsRestore").writeEchoReactionsToReactionsStore(g,d("WAGlobals").getMyUserJid(),t),R(w,g,u==null?void 0:u.jid)]).then(function(j){d("MAWEncryptedBackupCacheManager").setRestoredCacheStatusAsDone(Array.from(g.echoMsgMap.keys()));return(h||(h=b("Promise"))).all([d("MAWRepliesRestoreUtils").updateQuoteDataForReplyMessages(g,t),d("MAWHandleEchoXMARestoreV2").writeXMAToXMAStore(g,u.chatId,t,l),c("gkx")("2251")?d("MAWHandlePendingStanzasInRestoreV2").applyPendingStanzas(g,f,t):d("MAWDexieTable").dexieResolve()]).then(function(){c("promiseDone")(d("MAWHandlePointRestoredMsgV2").uploadPointRestoredMessageIfRequired(g));var j=g.restoredMsgsData;if(f&&j!=null){var m=p===c("LSMEBTaskCreationSource").EB_POINT_QUERY_RETRY_DECRYPTION_FAILURES||c("gkx")("1560")||c("gkx")("33");m||I(j.newlyAddedMsgs)["catch"](function(a){var b;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(b=l)!=null?b:""]).ERROR(C(),a)})}m=g.restoredMsgsData;j=(m==null?void 0:m.existingMsgs)?m==null?void 0:m.existingMsgs.length:0;m=e.length;t.endSuccess({"int":{existingMsgs:j,messages_lost:e.length-j-k,newlyAddedMsgs:k,restoredMsgs:j+k,totalMsgsToRestore:m},string:{threadJidPrimaryId:a}});d("MAWTraceUtils").recordCheckpointForTrace(l,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_RESTORE_MESSAGES_SUCCESS),[],!1);d("MAWTraceUtils").recordCheckpointForTrace(l,i.ofNumber(c("LSDataTraceCheckPoint").FLOW_END_AND_FLUSH),[],!0);g.quotesToBeRestored.forEach(function(a){v.messageIds.push(a.messageId),v.pendingRestoreSortKeys.push(a.sortOrderMs)});d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(m=l)!=null?m:""]).LOG(B(),k,j,f);return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult(v))})})["catch"](function(a){var c;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(c=l)!=null?c:""]).ERROR(A(),a);t.endFail("error_in_handle_media_or_reaction");return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult(v))})})}else{t.endFail("missing_thread_for_thread_jid");d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(j=l)!=null?j:""]).ERROR(z(),a);O(a,null,n,o)}return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult(v))});return function(b,c,d,e,f,g,h,i,j,k,l,m,n,o){return a.apply(this,arguments)}}();function G(a,b,c,d,e,f,g,h,i,j,k){return H.apply(this,arguments)}function H(){H=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,i,j,k,l,m,n,o){i==null?void 0:i.addPoint("message_restore_start");var p=new Map(),q=n!=null&&n===c("LSMEBTaskCreationSource").MSGR_DYI,r=[];e=(yield J(e,f,a,p,g,i,m));var s=e.dbThread,t=e.hasMoreBefore,u=e.messagesToAdd;g=e.quotesToBeRestoredForThread;r.push.apply(r,g);e=u.map(function(b){return{author:b.author,chat:a.jid,externalId:d("WAStanzaUtils").toStanzaId(b.externalId)}});return(h||(h=b("Promise"))).all([d("MAWRestoreMsgsTxns").maybeGetThreadNewestMessage(a),d("MAWRestoreMsgsTxns").maybeGetOldestNonAdminMessage(a),d("MAWRestoreMsgsTxns").getMsgsByProtocolMsgIds(e)]).then(function(a){var b=a[0],c=a[1],e=c.maybeOldestAdminMsg;c=c.maybeOldestMsg;a=a[2];var g=new Set(a.map(function(a){return a.externalId})),h=u.filter(function(a){return!g.has(a.externalId)});b={existingMsgs:a,hasMoreBefore:t,instanceKey:k,isDyiInProgress:q,isPointRestore:f,maybeNewestMsg:b,maybeOldestAdminMsg:e,maybeOldestMsg:c,minMsgId:j,newMsgs:h,optimisticMsgs:l,taskSource:n,thread:s,traceId:m};var v=[];a.forEach(function(a){return v.push({externalId:a.externalId})});h.forEach(function(a){return v.push({externalId:a.externalId})});return d("MAWRestoreMsgsTxns").restoreMsgsForThread(b).then(function(a){var b=[];(a==null?void 0:a.existingMsgs)!=null&&(b=b.concat(a==null?void 0:a.existingMsgs));(a==null?void 0:a.newlyAddedMsgs)!=null&&(b=b.concat(a==null?void 0:a.newlyAddedMsgs));i==null?void 0:i.addPoint("message_restore_end");o!=null&&!f&&d("MAWRestoreValidationUtils").compareRestoredMsgstoDeanonData(b,o,void 0,v,i);return{echoMsgMap:p,quotesToBeRestored:r,restoredMsgsData:a,thread:s}})})});return H.apply(this,arguments)}var I=d("MAWIndexedDb").makeMsgrTransactor({messages:(e=d("MAWTransactionMode")).READWRITE},"restoreDeleteMessages",function(a){return function(b){var c=[];for(var d=0;d<b.length;d++)c.push(b[d].rowId);return a.messages.bulkDelete(c)}});function J(a,b,c,d,e,f,g){return K.apply(this,arguments)}function K(){K=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g,h){var i=new Set(),p=new Map(),q=[];if(a==null||a.length===0){var r;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(r=h)!=null?r:""]).WARN(o(),c.jid);return{dbThread:c,hasMoreBefore:!1,messagesToAdd:[],quotesToBeRestoredForThread:q}}var s=0,t=[];a.forEach(function(a){a=d("EchoMessage").decodeEchoMessage(a);if(a==null){var b;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(b=h)!=null?b:""]).ERROR(n());return}a.contentType===d("EchoMessage").EchoMessageContentType.DECRYPTION_FAILURE&&s++;b=a.xOfflineThreadingId;if(b==null){var c;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(c=h)!=null?c:""]).ERROR(m());return}if(i.has(b)){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(c=h)!=null?c:""]).WARN(l());return}i.add(b);t.push(a)});s===a.length&&(g==null?void 0:g.addPoint("decryption_failure_batch",{"int":{decryptionFailuresCount:s}}));r=(yield F.load());a=r.restoreWithHIM;g=(yield a(t,c.jid,d("WAGlobals").getMyUserJid()));g.forEach(function(a){if(a.xOfflineThreadingId==null)return;var b=d("WAStanzaUtils").toStanzaId(a.xOfflineThreadingId),f=d("MAWHandleEchoMsgsRestoreApiUtils").getUnstoredDbMessageFromEchoMessage(a,c.jid,d("WAGlobals").getMyUserJid(),b,h);if(f!=null){d("MAWEncryptedBackupCacheManager").addMsgEntryToRestoredCache(b,d("EchoBackupCompareUtils").buildEchoDocCacheValue(a));p.set(b,f);e.set(b,a);a=a==null?void 0:a.quoteData;if(a!=null){var g=d("WAStanzaUtils").toStanzaId(a.quoteMessageId);if(g!=null&&!p.has(g))q.push({messageId:a.quoteMessageId,sortOrderMs:a.quoteSortOrderInMs.toString()});else{a=d("MAWRepliesRestoreUtils").addQuoteDataToReplyMessage(f,p.get(g));p.set(b,a)}}}});r=Array.from(p.values());r.sort(function(a,b){return((a=a.sortOrderMs)!=null?a:0)-((a=b.sortOrderMs)!=null?a:0)});a=b||f!==!1;if(!a){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(g=h)!=null?g:""]).LOG(k(),c.jid)}if(r.length>0){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(b=h)!=null?b:""]).LOG(j(),r[0].sortOrderMs,r[r.length-1].sortOrderMs,c.jid)}return{dbThread:c,hasMoreBefore:a,messagesToAdd:r,quotesToBeRestoredForThread:q}});return K.apply(this,arguments)}var L=d("MAWIndexedDb").makeMsgrTransactor({dyiBatch:e.READWRITE,threads:e.READONLY},"restoreGetThread",function(a){return function(b,c,e){return d("MAWDbThreadTxns").getThreadPrimaryId(a,b).then(function(f){if(f.success)return f.value;else{d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(f=c)!=null?f:""]).ERROR(y(),b);f=d("WAJids").unsafeCoerceToChatJid(b+"@msgr");return e!=null&&e?d("MAWRestoreMsgsTxns").stopDyiForThread(a,f):d("MAWDexieTable").dexieResolve()}})}}),M=d("MAWIndexedDb").makeMsgrTransactor({editMsgHistory:e.READWRITE,messages:e.READWRITE},"restoreEditMsgHistory",function(a){return function(b,c){c==null?void 0:c.addPoint("msg_history_start");var e=b.restoredMsgsData;if(e!=null){var f=e.newlyAddedMsgs.map(function(c){var f=[],g=c.externalId,h=c.author,i=e.threadJid;c=b.echoMsgMap.get(g);if(c!=null){var j=c.editHistory;return d("MAWDbEditMsgHistoryTxns").getEditHistoryAsEcho(a,g,h,i).then(function(b){if(b.length>=j.length)return d("MAWDexieTable").dexieResolve([]);j.forEach(function(a){return f.push({author:h,editExternalId:a.messageId!=null?d("WAStanzaUtils").toStanzaId(a.messageId):null,editTs:d("WATimeUtils").castToUnixTime(a.timestamp),msgContent:{content:a.text},originalMsgExternalId:g,sendStatus:d("MAWAckLevel").ACK.sent,threadJid:i})});b.length>0&&d("MAWDbEditMsgHistoryTxns").bulkRemoveEditHistory(a,g,h,i);return d("MAWDexieTable").dexieResolve(f)})}else return d("MAWDexieTable").dexieResolve([])});return d("MAWDexieTable").dexieAll(f).then(function(b){return d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,b.flat(),!0).then(function(a){return c==null?void 0:c.addPoint("msg_history_end")})})}else{c==null?void 0:c.addPoint("msg_history_end");return d("MAWDexieTable").dexieResolve()}}}),N=function(a,c,d,e){c==null?void 0:c.addPoint("media_restore_start");return P(a,d,e).then(function(a){c==null?void 0:c.addPoint("media_restore_end",{"int":{media:a}});return(h||(h=b("Promise"))).resolve()})};function O(a,b,e,f,g){if(e!=null&&c("gkx")("23961")){var h,i;h=(h=b==null?void 0:(h=b.restoredMsgsData)==null?void 0:h.newlyAddedMsgs.length)!=null?h:0;i=(i=b==null?void 0:(i=b.restoredMsgsData)==null?void 0:i.existingMsgs.length)!=null?i:0;if(f!=null&&f.size>0){var j,k=new Set([].concat((b==null?void 0:(j=b.restoredMsgsData)==null?void 0:(j=j.newlyAddedMsgs)==null?void 0:j.map(function(a){return a.externalId}))||[],(b==null?void 0:(j=b.restoredMsgsData)==null?void 0:(b=j.existingMsgs)==null?void 0:b.map(function(a){return a.externalId}))||[]));j=Array.from(f.keys()).reduce(function(a,b){return a+(k.has(b)?0:1)},0);if(j>0){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(b=g)!=null?b:""]).WARN(x(),a,j);d("MAWQplProxy").sendQPLFailThroughBridge(c("qpl")._(521482576,"1069"),"optimistic_msgs_missed_restore",{"int":{messages_backend_existing:i,messages_backend_restored:h,missed_message_count:j,optimistic_msgs_count:f.size}},e)}else d("MAWQplProxy").sendQPLSuccessThroughBridge(c("qpl")._(521482576,"1069"),{"int":{messages_backend_existing:i,messages_backend_restored:h,optimistic_msgs_count:f.size}},e)}else d("MAWQplProxy").sendQPLSuccessThroughBridge(c("qpl")._(521482576,"1069"),{"int":{messages_backend_existing:i,messages_backend_restored:h,optimistic_msgs_count:0}},e)}}function P(a,c,e){var f=a.restoredMsgsData,g=0;if(f){var i=f.existingMsgs.filter(function(a){return d("MAWDbMsg").isMediaMsg(a)&&a.mediaId==null}),j=f.newlyAddedMsgs;i=[].concat(i,j);var k=f.threadJid,l=[];i.map(function(b){var e=b.externalId;e=a.echoMsgMap.get(e);if((e==null?void 0:e.contentType)===d("EchoMessage").EchoMessageContentType.MEDIA||(e==null?void 0:e.contentType)===d("EchoMessage").EchoMessageContentType.XMA){b=Q(k,b,a.echoMsgMap,(e==null?void 0:e.contentType)===d("EchoMessage").EchoMessageContentType.XMA,c);b!=null&&(g+=1,l.push(b))}});return d("MAWHandleEchoMediaMsgsRestoreV2").downloadMediaAndWriteToMediaStore(l,a.thread.jid,e).then(function(a){return g})}return(h||(h=b("Promise"))).resolve(g)}function Q(a,b,e,f,g){e=e.get(b.externalId);if(e==null){if(f){var h;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore","xma",(h=g)!=null?h:""]).WARN(w(),b.externalId)}else{d("WATagsLogger").TAGS(["labyrinth_web","eb_restore","xma",(h=g)!=null?h:""]).ERROR(v(),b.externalId)}return null}h=e.mediaData;if(h==null){if(f){var i;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore","media",(i=g)!=null?i:""]).WARN(u(),e.messageId)}else{d("WATagsLogger").TAGS(["labyrinth_web","eb_restore","media",(i=g)!=null?i:""]).ERROR(t(),e.messageId)}return null}i=e.from;if(i==null){if(f){var j;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore","media",(j=g)!=null?j:""]).WARN(s())}else{d("WATagsLogger").TAGS(["labyrinth_web","eb_restore","media",(j=g)!=null?j:""]).ERROR(r())}return null}j=e.sortOrderMs;if(j==null){if(f){var k;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore","media",(k=g)!=null?k:""]).WARN(q())}else{d("WATagsLogger").TAGS(["labyrinth_web","eb_restore","media",(k=g)!=null?k:""]).ERROR(p())}return null}g=d("MAWJids").toUserJid(i.localKey);k=g===d("WAGlobals").getMyUserJid()?d("WAJids").AUTHOR_ME:g;i=b.externalId;g=b.msgId;b={author:k,echoMsg:e,externalId:i,isXMA:f,messageTimestamp:j,msgId:g,threadJId:a};k=c("gkx")("23925");i=Date.now()-j<1e3*60*60*24*30;return babelHelpers["extends"]({},b,{mediaData:h,previewMediaData:k&&i?e.previewMediaData:null})}function R(a,b,e){a!=null&&e!=null&&b.quotesToBeRestored.map(function(b){d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(b.messageId,a,b.sortOrderMs,c("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT,e)})}g.handleEchoMsgsBulkRestore=a;g.deleteMessages=I;g.getThread=L;g.getMediaMetadataForDownload=Q}),98);
__d("MAWUnstoredQuotedMsgUtils",["MAWMsgType","WAErr","WAJids","WAMsgType"],(function(a,b,c,d,e,f,g){"use strict";function h(a){if(a==null)return;var b=a.content;a=a.remoteJid;var e;switch(b.type){case d("MAWMsgType").MSG_TYPE.TEXT:e=j(b);break;case d("MAWMsgType").MSG_TYPE.IMAGE:e=k(b);break;case d("MAWMsgType").MSG_TYPE.VIDEO:e=l(b);break;case d("MAWMsgType").MSG_TYPE.PTT:e=m(b);break;case d("MAWMsgType").MSG_TYPE.GIF:e=n(b);break;case d("MAWMsgType").MSG_TYPE.STICKER:e=o(b);break;case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:e=q(b);break;case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:e=r(b);break;case d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:e=s(b);break;case d("WAMsgType").NOTE_REPLY:e=p(b);break;default:b.type;throw c("WAErr")("For flow")}return{content:e,remoteJid:a}}function i(a){if(d("WAJids").isAuthorSystem(a.author))throw c("WAErr")("A system message cannot be quoted");return{author:a.author,externalId:a.externalId,ts:a.ts}}function j(a){return babelHelpers["extends"]({},i(a),{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.TEXT})}function k(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.IMAGE})}function l(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.VIDEO})}function m(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.PTT})}function n(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.GIF})}function o(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.STICKER})}function p(a){return babelHelpers["extends"]({},i(a),{msgContent:a.msgContent,type:d("WAMsgType").NOTE_REPLY})}function q(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE})}function r(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.UNAVAILABLE})}function s(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL})}function a(a){return{quote:h(a.quote)}}g.getWithQuoteMsg=a}),98);
__d("MAWUnstoredTypedMsgUtils",["MAWDbMsg","MAWMsgType","MAWRavenUtils","MAWUnstoredQuotedMsgUtils","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return{ack:a.ack,author:a.id.author,externalId:a.id.externalId,reportingMeta:a.reportingMeta,serverTs:a.serverTs,ts:a.ts}}function i(a){return{forwardingScore:a.forwardingScore,isForwarded:a.isForwarded}}function j(a){return{ephemeralSetting:k(a.ephemeralSetting),messageDeleteTs:a.deleteTs,messageExpirationTs:a.expirationTs}}function k(a){if(a==null)return;return{ephemeralExpirationInSec:a.expirationTs,ephemeralLastUpdatedOrSetTimestamp:a.updatedTs}}function a(a,b){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,msgContent:{content:(a=b.sentWithMessage)!=null?a:"",mentionedJids:void 0},type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:b.targetType})}function b(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,editCount:0,msgContent:a.msgContent,specialTextSize:a.specialTextSize,type:d("MAWMsgType").MSG_TYPE.TEXT})}function c(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,plaintextHash:(a=a.mediaId)!=null?a:void 0,type:d("MAWMsgType").MSG_TYPE.IMAGE})}function e(a){return babelHelpers["extends"]({},h(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,ravenEphemeralMediaState:d("MAWRavenUtils").getEphemeralMediaState(a.ravenEphemeralMediaState),ravenEphemeralType:a.ravenEphemeralType,type:d("MAWMsgType").MSG_TYPE.RAVEN})}function f(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,plaintextHash:(a=a.mediaId)!=null?a:void 0,type:d("MAWMsgType").MSG_TYPE.VIDEO})}function l(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,type:d("MAWMsgType").MSG_TYPE.PTT})}function m(a){return{adminMsgContent:a.adminMsgContent,adminType:a.adminType}}function n(a){return babelHelpers["extends"]({},h(a),{altIndex:void 0,author:d("WAJids").AUTHOR_SYSTEM,msgContent:m(a.msgContent),type:d("MAWMsgType").MSG_TYPE.ADMIN})}function o(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,plaintextHash:(a=a.mediaId)!=null?a:void 0,type:d("MAWMsgType").MSG_TYPE.GIF})}function p(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,plaintextHash:(a=a.mediaId)!=null?a:void 0,type:d("MAWMsgType").MSG_TYPE.STICKER})}function q(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE})}function r(a){return babelHelpers["extends"]({},h(a),{altIndex:d("MAWDbMsg").FUTUREPROOF_ALT_INDEX,msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.FUTUREPROOF})}function s(a){return babelHelpers["extends"]({},h(a),{altIndex:void 0,ebTimestampMs:a.ebTimestampMs,revokedExternalId:a.revokedExternalId,type:d("MAWMsgType").MSG_TYPE.REVOKED})}function t(a){return{adminMsgContent:a.adminMsgContent,adminType:a.adminType}}function u(a){return babelHelpers["extends"]({},h(a),{altIndex:void 0,msgContent:t(a.msgContent),type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN})}function v(a){return{adminMsgContent:a.adminMsgContent,adminType:a.adminType,screenshotActionType:a.screenshotActionType,version:a.version}}function w(a){return babelHelpers["extends"]({},h(a),{altIndex:void 0,msgContent:v(a.msgContent),type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION})}function x(a){return{adminType:a.adminType,authorName:a.authorName}}function y(a){return babelHelpers["extends"]({},h(a),{altIndex:void 0,msgContent:x(a.msgContent),type:d("MAWMsgType").MSG_TYPE.ICDC_ALERT})}function z(a){return babelHelpers["extends"]({},h(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),{altIndex:void 0,type:d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE})}g.getXMAMsg=a;g.getTextMsg=b;g.getImageMsg=c;g.getRavenMsg=e;g.getVideoMsg=f;g.getPttMsg=l;g.getAdminMsg=n;g.getGifMsg=o;g.getStickerMsg=p;g.getDocumentFileMsg=q;g.getFutureproofMsg=r;g.getRevokedMsg=s;g.getEphemeralSettingAdminMsg=u;g.getEphemeralScreenshotActionMsg=w;g.getICDCAlertMsg=y;g.getBumpExistingMessageMsg=z}),98);
__d("MAWUnstoredMsgUtils",["MAWMsgType","MAWUnstoredTypedMsgUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.unstoredMsg;a=a.unstoredXMA;if(b==null)return null;switch(b.type){case d("MAWMsgType").MSG_TYPE.TEXT:return d("MAWUnstoredTypedMsgUtils").getTextMsg(b);case d("MAWMsgType").MSG_TYPE.IMAGE:return d("MAWUnstoredTypedMsgUtils").getImageMsg(b);case d("MAWMsgType").MSG_TYPE.VIDEO:return d("MAWUnstoredTypedMsgUtils").getVideoMsg(b);case d("MAWMsgType").MSG_TYPE.PTT:return d("MAWUnstoredTypedMsgUtils").getPttMsg(b);case d("MAWMsgType").MSG_TYPE.ADMIN:return d("MAWUnstoredTypedMsgUtils").getAdminMsg(b);case d("MAWMsgType").MSG_TYPE.FUTUREPROOF:return d("MAWUnstoredTypedMsgUtils").getFutureproofMsg(b);case d("MAWMsgType").MSG_TYPE.REVOKED:return d("MAWUnstoredTypedMsgUtils").getRevokedMsg(b);case d("MAWMsgType").MSG_TYPE.GIF:return d("MAWUnstoredTypedMsgUtils").getGifMsg(b);case d("MAWMsgType").MSG_TYPE.STICKER:return d("MAWUnstoredTypedMsgUtils").getStickerMsg(b);case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return d("MAWUnstoredTypedMsgUtils").getDocumentFileMsg(b);case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return d("MAWUnstoredTypedMsgUtils").getEphemeralSettingAdminMsg(b);case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return d("MAWUnstoredTypedMsgUtils").getEphemeralScreenshotActionMsg(b);case d("MAWMsgType").MSG_TYPE.ICDC_ALERT:return d("MAWUnstoredTypedMsgUtils").getICDCAlertMsg(b);case d("MAWMsgType").MSG_TYPE.XMA:if((a==null?void 0:a.xma)==null)throw c("err")("XMA content cannot be parsed without XMA payload");return d("MAWUnstoredTypedMsgUtils").getXMAMsg(b,a==null?void 0:a.xma);case d("MAWMsgType").MSG_TYPE.RAVEN:return d("MAWUnstoredTypedMsgUtils").getRavenMsg(b);case d("MAWMsgType").MSG_TYPE.RAVEN_ACTION:case d("MAWMsgType").MSG_TYPE.REACTION:case d("MAWMsgType").MSG_TYPE.EDIT_ACTION:return null;case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return d("MAWUnstoredTypedMsgUtils").getBumpExistingMessageMsg(b);default:b.type;return null}}function b(a){if(a==null)return null;switch(a.type){case d("MAWMsgType").MSG_TYPE.TEXT:return d("MAWUnstoredTypedMsgUtils").getTextMsg(a);case d("MAWMsgType").MSG_TYPE.GIF:return d("MAWUnstoredTypedMsgUtils").getGifMsg(a);case d("MAWMsgType").MSG_TYPE.STICKER:return d("MAWUnstoredTypedMsgUtils").getStickerMsg(a);default:return null}}function e(a){a=a.unstoredMsg;if(!a||a.type!==d("MAWMsgType").MSG_TYPE.REACTION)return null;a=a;return{ack:a.ack,author:a.id.author,externalId:a.id.externalId,groupingKey:a.groupingKey,reaction:a.reaction,reactToAuthor:a.reactToAuthor,reactToExternalId:a.reactToExternalId,senderTimestampMs:a.senderTimestampMs,threadJid:a.id.chat,ts:a.ts}}function f(a){a=a.unstoredMsg;if(!a||a.type!==d("MAWMsgType").MSG_TYPE.RAVEN_ACTION)return null;a=a;return{ack:a.ack,actionTimestamp:a.actionTimestamp,actionType:a.actionType,author:a.id.author,externalId:a.id.externalId,ravenActionToMsgExternalId:a.ravenActionToMsgExternalId,ts:a.ts,type:a.type}}function h(a){a=a.unstoredIncomingGroupInvite;return!a?null:babelHelpers["extends"]({},a)}function i(a){return a==null?null:{ack:a.ack,author:a.id.author,editMsgContent:a.editMsgContent,externalId:a.id.externalId,originalMsgExternalId:a.originalMsgExternalId,reportingMeta:a.reportingMeta,serverTs:a.serverTs,specialTextSize:a.specialTextSize,ts:a.ts,type:a.type}}g.getUnstoredMsg=a;g.getUnstoredAssociatedMsg=b;g.getUnstoredReaction=e;g.getUnstoredRavenActionMsg=f;g.getGroupInvite=h;g.getUnstoredEditActionMsg=i}),98);
__d("MAWUnstoredMediaUtils",["MAWUnstoredMsgUtils","WASortedLists"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a==null?null:{mediaEntry:a.mediaEntry,mediaType:a.mediaType,msgIds:d("WASortedLists").emptySet(),plaintextHash:a.plaintextHash,size:a.size,ts:a.ts,validatedAudioInfo:a.validatedAudioInfo,validatedDocumentFileInfo:a.validatedDocumentFileInfo,validatedImageInfo:a.validatedImageInfo,validatedVideoInfo:a.validatedVideoInfo}}function a(a){a=a.unstoredXMA;if(a==null)return;var b=a.unstoredAssociatedMedia,c=a.unstoredAssociatedMsg,e=a.unstoredFavicon,f=a.unstoredHeaderMedia,g=a.unstoredPreviews;a=a.xma;return{unstoredAssociatedMedia:(b=h(b))!=null?b:void 0,unstoredAssociatedMsg:(b=d("MAWUnstoredMsgUtils").getUnstoredAssociatedMsg(c))!=null?b:void 0,unstoredDbXMA:{author:a.author,contentRef:a.contentRef,ctas:a.ctas,defaultCTA:a.defaultCTA,externalId:a.externalId,headerTitle:a.headerTitle,isTombstoned:a.isTombstoned,maxSubtitleNumOfLines:a.maxSubtitleNumOfLines,maxTitleNumOfLines:a.maxTitleNumOfLines,overlayDescription:a.overlayDescription,overlayIconGlyph:a.overlayIconGlyph,overlayTitle:a.overlayTitle,subtitleText:a.subtitleText,targetExpiringAtSec:a.targetExpiringAtSec,targetId:a.targetId,targetType:a.targetType,targetUsername:a.targetUsername,threadJid:a.threadJid,titleText:a.titleText,xmaLayoutType:a.xmaLayoutType},unstoredFavicon:(c=h(e))!=null?c:void 0,unstoredHeaderMedia:(b=h(f))!=null?b:void 0,unstoredPreviews:g?g.map(function(a){return h(a)}).filter(Boolean):void 0}}g.getUnstoredMedia=h;g.getUnstoredXMA=a}),98);
__d("MAWUnstoredContentToUnstoredDbContentUtils",["MAWUnstoredMediaUtils","MAWUnstoredMsgUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b,c=(b=d("MAWUnstoredMsgUtils")).getUnstoredMsg(a),e=d("MAWUnstoredMediaUtils").getUnstoredMedia(a.unstoredMedia),f=b.getUnstoredReaction(a),g=b.getUnstoredRavenActionMsg(a),h=d("MAWUnstoredMediaUtils").getUnstoredXMA(a),i=b.getGroupInvite(a);b=b.getUnstoredEditActionMsg(a.unstoredEditMsg);if(i==null)return{contentTypeForLogging:a.contentTypeForLogging,unstoredDbEditActionMsg:b,unstoredDbMedia:e,unstoredDbMsg:c,unstoredDbRavenActionMsg:g,unstoredDbReaction:f,unstoredXMA:h,xmaTargetTypeForLogging:a.xmaTargetTypeForLogging};else return{contentTypeForLogging:a.contentTypeForLogging,unstoredDbEditActionMsg:b,unstoredDbMedia:e,unstoredDbMsg:c,unstoredDbRavenActionMsg:g,unstoredDbReaction:f,unstoredIncomingDbGroupInvite:i,unstoredXMA:h,xmaTargetTypeForLogging:a.xmaTargetTypeForLogging}}g.unstoredContentToUnstoredDbContent=a}),98);
__d("MAWWriteReactionTxns",["MAWAuthor","MAWDbMsg","MAWDbReaction","MAWDbReactionUtils","MAWDbReactionsTxns","MAWDexieTable","qex"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e){var f=b.author,g=b.externalId,h=b.groupingKey,i=b.reaction,j=b.reactToAuthor,k=b.reactToExternalId,l=b.senderTimestampMs,m=b.ts;return d("MAWDexieTable").dexieAll([a.messages.where("externalId").equals(k).toArray(),a.reactions.where("reactToExternalId").equals(k).toArray(),d("MAWDbReactionsTxns").getNextReactionIdNumberForThread(a,e)]).then(function(b){var n=b[0],o=b[1];b=b[2];o=d("MAWDbReaction").findMatchingReaction(o,e.jid,f);var p=d("MAWAuthor").getAuthorUserJid(j);n=n.find(function(a){return a.threadJid===e.jid&&p===d("MAWAuthor").getAuthorUserJid(a.author)});var q=d("MAWDbReaction").formatReactionForDb(e.jid,g,d("MAWDbMsg").craftReactionId(e.chatId,b),k,i,h,j,n==null?void 0:n.msgId,m,f,o==null?void 0:o.rowId,void 0,l);return d("MAWDbReactionsTxns").putReaction(a,q).then(function(a){a=babelHelpers["extends"]({},q,{rowId:a});c("qex")._("1016")!==!0&&d("MAWDbReactionUtils").dispatchReaction(a);return a})})}g.writeReaction=a}),98);
__d("MAWWriteReactionMsgApi",["MAWDexieTable","MAWIndexedDb","MAWTransactionMode","MAWWriteReactionTxns","WAJids"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a,b,c,e,f,g){g===void 0&&(g=d("WAJids").AUTHOR_ME);var h=e.groupingKey,i=e.reaction,j=e.reactToAuthor,k=e.reactToExternalId;e=e.senderTimestampMs;var l={author:g,externalId:b,groupingKey:h,reaction:i,reactToAuthor:j,reactToExternalId:k,senderTimestampMs:e,ts:f};return a.threads.get({jid:c}).then(function(b){return b==null?"missing_thread":d("MAWWriteReactionTxns").writeReaction(a,l,b)}).then(function(a){return a==="missing_thread"?{type:"missing_thread"}:{msgId:a.reactionId,protocolMsgId:{author:g,chat:c,externalId:a.externalId},type:"not_sent"}})};b=d("MAWIndexedDb").makeMsgrTransactor({groupInfo:(a=d("MAWTransactionMode")).READONLY,media:a.READONLY,messages:a.READONLY,participants:a.READONLY,reactions:a.READWRITE,threads:a.READWRITE},"writeReactionMsg",function(a){return function(b,c,e,f,g){g===void 0&&(g=d("WAJids").AUTHOR_ME);return h(a,b,c,e,f,g)}});c=d("MAWIndexedDb").makeMsgrTransactor({groupInfo:a.READONLY,media:a.READONLY,messages:a.READONLY,participants:a.READONLY,reactions:a.READWRITE,threads:a.READWRITE},"bulkWriteReactionMsg",function(a){return function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){return h(a,b.externalId,b.chatJid,b.args,b.ts,b.author)}))}});g.writeReactionMsg=b;g.bulkWriteReactionMsg=c}),98);
__d("MessageBackupSupplementalKeyGenerator",["$InternalEnum"],(function(a,b,c,d,e,f){"use strict";b=b("$InternalEnum")({REACTION:"reaction",EDIT:"edit"});var g=":";function a(a,b){return""+a+g+b}function c(a){return a.split(g)[1]}function h(a,b){b=b.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");b=new RegExp("^"+b,"i");return b.test(a)}function d(a){return h(a,"reaction")}function e(a){return h(a,"edit")}f.SupplementalKeyPrefix=b;f.SUPPLEMENTAL_KEY_DELIMITER=g;f.createMessageSupplementalKey=a;f.getSupplementalSenderId=c;f.isSupplementalProtobufAReaction=d;f.isSupplementalProtobufAnEdit=e}),66);
__d("MAWHandleEchoProtobufsRestoreApi",["EchoMessageMediaFieldUtils","LSDataTraceCheckPoint","LSIntEnum","LSMEBTaskCreationSource","MAWBridge","MAWBridgeEventTransmitter","MAWBridgeMsg","MAWBridgeXMA","MAWDbEditMsgHistoryTxns","MAWDbMsg","MAWDexieTable","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleEchoMsgsRestoreApiUtils","MAWHandleEchoMsgsRestoreApiV2","MAWHandleEchoXMARestoreV2","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWJids","MAWLoadReplyMediaTxns","MAWMsgType","MAWQplProxy","MAWRestoreMsgsTxns","MAWRestoreValidationUtils","MAWTraceUtils","MAWTransactionMode","MAWUnstoredContentToUnstoredDbContentUtils","MAWUpdateQuotedMsgTxns","MAWWriteReactionMsgApi","MessageBackupSupplementalKeyGenerator","Promise","WAAckLevel","WAArmadilloApplication.pb","WAArmadilloBackupMessage.pb","WABase64","WAConsumerApplication.pb","WAGlobals","WAHashUtils","WAJids","WALogger","WAMediaTransport.pb","WAMediaUtils","WAMsgApplication.pb","WAMsgType","WAParseConsumerMessageProtocol","WAParseMessageApplication","WAStanzaUtils","WATimeUtils","asyncToGeneratorRuntime","decodeProtobuf","gkx","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Cannot download media - timestamp cannot be null"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] cannot support message type for protobuf restore - reverting to echo restore"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Protobuf restore initiated for "," messages. isPointRestore: "," referenceTimestamp: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] No text content found in edit msg"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Unable to parse edit msg, missing either timestamp or msg id"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Message contains unparseable message application - unable to restore message"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Unable to retrieve decoded protobuf from backup message - unsupported message type"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] No author found for original message that was bumped - unable to restore"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Unable to retrieve revoked message external id"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Invalid attachment type, cannot restore attachment"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Unsupported media type, cannot get mimetype for attachment"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Failed to create db msg from protobuf"]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] Missing required fields, unable to create db msg from protobuf for thread jid "," and otid ",""]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] No target type found for XMA - unable to extract XMA content for message"]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] XMA data is null - unable to extract XMA content for message"]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] No revoked msg external id found for revoked msg"]);y=function(){return a};return a}function z(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web] text content cannot be null for msg type text - unable to restore msg"]);z=function(){return a};return a}var A=new Set(),B=new Set(),C=new Map(),D=new Map(),E=new Map(),F=d("MAWIndexedDb").makeMsgrTransactor({chunk:(e=d("MAWTransactionMode")).READONLY,media:e.READONLY,messages:e.READWRITE,xma:e.READONLY},"associateQuotedMessagesForRestoredDbMsgs",function(a){return function(b,c,e){var f=0;return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWUpdateQuotedMsgTxns").associateQuotedMessage(a,c,b,!0).then(function(b){b!=null&&b.length>0&&(f+=b.length,b.forEach(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,void 0,a)})})}))})})).then(function(){e==null?void 0:e.addPoint("replies_restore_end",{"int":{replies:f}});return d("MAWDexieTable").dexieResolve()})}});function G(a,b,c){c={author:c,chat:b,externalId:a};return c}function H(a,b,c){var e=new Map(),f=a.metadata;a=a.reactionData;if(f!=null&&a!=null){var g=f.senderId,h=f.messageId;if(g!=null&&h!=null){a.forEach(function(a){var f=a.ts,i=a.senderId,j=a.reactionExternalId,k=d("WAStanzaUtils").toStanzaId(h);if(i==null||j==null)return;j=d("WAStanzaUtils").toStanzaId(j);i=d("MAWJids").toUserJid(i);var l=d("MAWJids").toUserJid(g);i=i===c?d("WAJids").AUTHOR_ME:i;l=l===c?d("WAJids").AUTHOR_ME:l;var m=i===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED;m={ack:m,chatJid:b,reaction:a.reaction,reactionAuthor:i,reactionExternalId:j,reactToExternalId:k,reactToMsgAuthor:l,ts:f};e.set(j,m)});return e}}}function I(a,b,c,e,f,g,h,i,j){if(a===d("MAWMsgType").MSG_TYPE.TEXT)if(h==null){d("WALogger").ERROR(z());return}else{h={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,msgContent:{content:h,mentionedJids:i!=null?i.map(d("WAJids").validateUserJid).filter(Boolean):void 0},ts:b,type:d("MAWMsgType").MSG_TYPE.TEXT};return h}else if(a===d("MAWMsgType").MSG_TYPE.VIDEO){i={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.VIDEO};return i}else if(a===d("MAWMsgType").MSG_TYPE.GIF){h={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.GIF};return h}else if(a===d("MAWMsgType").MSG_TYPE.IMAGE){i={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.IMAGE};return i}else if(a===d("MAWMsgType").MSG_TYPE.STICKER){h={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.STICKER};return h}else if(a===d("MAWMsgType").MSG_TYPE.PTT){i={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.PTT};return i}else if(a===d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE){h={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE};return h}else if(a===d("MAWMsgType").MSG_TYPE.XMA){i={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,ts:b,type:d("MAWMsgType").MSG_TYPE.XMA};return i}else if(a===d("MAWMsgType").MSG_TYPE.REVOKED){if(j==null){d("WALogger").ERROR(y());return}h={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,ebTimestampMs:null,id:e,msgContent:void 0,revokedExternalId:j,ts:b,type:d("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:b};return h}else if(a===d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE){g={ack:d("WAAckLevel").ACK.SENT,id:e,ts:b,type:d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE};return g}}function J(a,b,c,e,f){if(f==null){d("WALogger").ERROR(x());return}var g=f==null?void 0:f.ctas.map(function(a){return{actionUrl:a.actionUrl,buttonType:a.buttonType,ctaType:a.ctaType,nativeUrl:a.nativeUrl,title:a.title}}),h=f.targetType;if(h==null){d("WALogger").ERROR(w());return}var i;f.targetExpiringAtSec!=null&&typeof f.targetExpiringAtSec==="number"&&(i=d("WATimeUtils").castToUnixTime(f.targetExpiringAtSec));a={author:a,contentRef:f.contentRef,ctas:g,defaultCTA:g.length>0?g[0]:void 0,externalId:b,headerTitle:f.headerTitle,maxSubtitleNumOfLines:f.maxSubtitleNumOfLines,maxTitleNumOfLines:f.maxTitleNumOfLines,msgId:c,overlayDescription:f.overlayDescription,overlayIconGlyph:f.overlayIconGlyph,overlayTitle:f.overlayTitle,subtitleText:f.subtitleText,targetExpiringAtSec:i,targetId:f.targetId,targetType:h,targetUsername:f.targetUsername,threadJid:e,titleText:f.titleText,xmaLayoutType:f.xmaLayoutType};return a}function K(a,b,c){var e=a.metadata,f=a.msgType;if(e!=null&&f!=null){var g,h,i=e.messageId;e=e.senderId;g=(g=a.decodedPayload)==null?void 0:g.text;h=(h=a.decodedPayload)==null?void 0:h.mentionedJid;if(i!=null&&e!=null){var j=d("WATimeUtils").castMilliSecondsToUnixTime(a.sortOrderMs);e=d("MAWJids").toUserJid(e);var k=d("WAStanzaUtils").toStanzaId(i),l=e===c?d("WAJids").AUTHOR_ME:e,m=G(k,b,e);if(a.editMsgData.length>0){var n=j;a.editMsgData.forEach(function(a){var b;if(a.ts>n&&((b=a.editMsgContent.message)==null?void 0:b.text)!=null){n=a.ts;g=(b=a.editMsgContent.message)==null?void 0:b.text;h=(b=a.editMsgContent.message)==null?void 0:b.mentionedJid}})}j=I(f,j,l,m,a.isForwarded,a.forwardingScore,g,h,a.revokedMsgExternalId);if(j==null){d("WALogger").ERROR(v(),b,k);return}var o;if(a.xmaData!=null&&((l=a.xmaData)==null?void 0:l.targetType)!=null){l={author:e,externalId:k,targetType:(m=a.xmaData)==null?void 0:m.targetType,threadJid:b};o={unstoredAssociatedMedia:void 0,unstoredAssociatedMsg:void 0,unstoredFavicon:void 0,unstoredHeaderMedia:void 0,unstoredPreviews:void 0,xma:l}}e={unstoredMedia:void 0,unstoredMsg:j,unstoredQuotedMedia:void 0,unstoredXMA:o};m=d("MAWUnstoredContentToUnstoredDbContentUtils").unstoredContentToUnstoredDbContent(e);if(m.unstoredDbMsg!=null){b=m.unstoredDbMsg;b.sortOrderMs=a.sortOrderMs;a.noteReply!=null&&(b.quote={content:a.noteReply,remoteJid:void 0});l=C.get(i);b.author!=null&&c===b.author&&b.author!==d("WAJids").AUTHOR_SYSTEM&&(b.author=d("WAJids").AUTHOR_ME);l!=null&&(b.quoteExternalId=d("WAStanzaUtils").toStanzaId(l));f===d("MAWMsgType").MSG_TYPE.TEXT&&(b.editCount=a.editMsgData.length);j={author:b.author,stanzaId:k,unstoredDbContent:m};return j}}}d("WALogger").ERROR(u())}function L(a){switch(a){case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.GIF;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.STICKER;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_MP4;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.AUDIO:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_WAV;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.XMA_IMAGE:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG;default:return null}}function M(a){switch(a){case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE:return d("EchoMessageMediaFieldUtils").AttachmentType.IMAGE;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF:return d("EchoMessageMediaFieldUtils").AttachmentType.GIF;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER:return d("EchoMessageMediaFieldUtils").AttachmentType.STICKER;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO:return d("EchoMessageMediaFieldUtils").AttachmentType.VIDEO;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.AUDIO:return d("EchoMessageMediaFieldUtils").AttachmentType.PTT;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.XMA_IMAGE:return d("EchoMessageMediaFieldUtils").AttachmentType.XMA;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.DOCUMENT:return d("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT;default:return null}}function N(){try{return WorkerGlobalScope!==void 0&&self instanceof WorkerGlobalScope}catch(a){return!1}}function O(a){var b,e=N()?d("WAGlobals").getConfig().isOctetStreamAttachmentMimeTypeEnabled():c("gkx")("4644");switch(a){case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE:b="image/jpeg";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.AUDIO:b="audio/wav";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO:b="video/mp4";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF:b="image/gif";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER:b="image/webp";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.XMA_IMAGE:b="image/jpeg";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.DOCUMENT:b=e?"application/octet-stream":"application/pdf";break;default:d("WALogger").ERROR(t())}return b}function P(a,b,c){var e,f,g,h,i,j;b=b;var k=a.ancillary;a=a.integral;e=a==null?void 0:(e=a.transport)==null?void 0:(e=e.integral)==null?void 0:e.fileSha256;f=a==null?void 0:(f=a.transport)==null?void 0:(f=f.integral)==null?void 0:f.fileEncSha256;g=a==null?void 0:(g=a.transport)==null?void 0:(g=g.integral)==null?void 0:g.mediaKey;h=(a==null?void 0:(h=a.transport)==null?void 0:(h=h.integral)==null?void 0:h.mediaKeyTimestamp)!=null?typeof (a==null?void 0:(h=a.transport)==null?void 0:h.integral.mediaKeyTimestamp)==="number"?a==null?void 0:(h=a.transport)==null?void 0:h.integral.mediaKeyTimestamp:void 0:void 0;var l=k==null?void 0:k.gifPlayback;l!=null&&l&&(b=d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF);l=a==null?void 0:(l=a.transport)==null?void 0:(l=l.ancillary)==null?void 0:(l=l.thumbnail)==null?void 0:l.thumbnailHeight;i=a==null?void 0:(i=a.transport)==null?void 0:(i=i.ancillary)==null?void 0:(i=i.thumbnail)==null?void 0:i.thumbnailWidth;var m=L(b),n=M(b);if(n===null){d("WALogger").ERROR(s());return}a={attachmentObjectId:a==null?void 0:(j=a.transport)==null?void 0:(j=j.ancillary)==null?void 0:j.objectId,attachmentType:n,directPath:a==null?void 0:(j=a.transport)==null?void 0:(n=j.integral)==null?void 0:n.directPath,encryptedHash:f!=null?d("WAHashUtils").toPlaintextHash(f):void 0,filename:c,height:k==null?void 0:k.height,mediaKey:g!=null?d("WABase64").encodeB64UrlSafe(g):void 0,mediaKeyTimestamp:h,mediaPlayableDuration:k==null?void 0:k.seconds,plaintextHash:e!=null?d("WAHashUtils").toPlaintextHash(e):void 0,width:k==null?void 0:k.width,xAttachmentType:b,xContentType:"full"};j=O(b);j!=null&&(a.mediaContentType=j);m!=null&&(a.previewContentType=m,a.previewContentHeight=l,a.previewContentWidth=i);return d("EchoMessageMediaFieldUtils").convertMediaMetadataDetailsToMediaMetadata(a)}function Q(a,b,c,e){b!=null&&a!=null&&(c.push({mediaMetadata:b,mediaRestoreType:e}),D.set(d("WAStanzaUtils").toStanzaId(a),c))}function R(a,b,c,e,f){var g,h,i=T(a);g=i==null?void 0:(g=i.obj.payload)==null?void 0:g.content;var j={editMsgData:[],externalId:e,forwardingScore:(h=i==null?void 0:(h=i.metadata)==null?void 0:h.forwardingScore)!=null?h:0,isForwarded:(h=i==null?void 0:(h=i.metadata)==null?void 0:h.isForwarded)!=null?h:!1,metadata:a.metadata,reactionData:[],sortOrderMs:b,unknownFieldCount:a.$$unknownFieldCount},k=[];if(g!=null){if(g.messageText!=null){j.msgType=d("MAWMsgType").MSG_TYPE.TEXT;j.decodedPayload=g.messageText;return j}else if(g.extendedContentMessage!=null){j.msgType=d("MAWMsgType").MSG_TYPE.XMA;j.xmaData=g.extendedContentMessage;if(((h=g.extendedContentMessage)==null?void 0:h.headerImage)!=null){h=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").ImageTransportSpec,(b=g.extendedContentMessage)==null?void 0:b.headerImage.payload);b=P(h,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE);Q(e,b,k,"xma_header")}if(((h=g.extendedContentMessage)==null?void 0:h.favicon)!=null){h=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").ImageTransportSpec,(b=g.extendedContentMessage)==null?void 0:b.favicon.payload);b=P(h,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE);Q(e,b,k,"xma_favicon")}if(((h=g.extendedContentMessage)==null?void 0:h.previews)!=null){(b=g.extendedContentMessage)==null?void 0:b.previews.forEach(function(a){a=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").ImageTransportSpec,a.payload);a=P(a,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE);j.mediaMetadata=a;Q(e,a,k,"xma_preview")})}return j}else if(g.audioMessage!=null){h=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").AudioTransportSpec,(h=g.audioMessage)==null?void 0:(b=h.audio)==null?void 0:b.payload);b=P(h,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.AUDIO);j.msgType=d("MAWMsgType").MSG_TYPE.PTT;j.mediaMetadata=b;Q(e,b,k,"attachment");return j}else if(g.videoMessage!=null){h=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").VideoTransportSpec,(h=g.videoMessage)==null?void 0:(h=h.video)==null?void 0:h.payload);b=P(h,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO);b!=null&&b.xAttachmentType===d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF?j.msgType=d("MAWMsgType").MSG_TYPE.GIF:j.msgType=d("MAWMsgType").MSG_TYPE.VIDEO;j.mediaMetadata=b;Q(e,b,k,"attachment");return j}else if(g.imageMessage!=null){h=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").ImageTransportSpec,(h=g.imageMessage)==null?void 0:(h=h.image)==null?void 0:h.payload);b=P(h,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE);j.msgType=d("MAWMsgType").MSG_TYPE.IMAGE;j.mediaMetadata=b;Q(e,b,k,"attachment");return j}else if(g.stickerMessage!=null){h=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").StickerTransportSpec,(h=g.stickerMessage)==null?void 0:(h=h.sticker)==null?void 0:h.payload);b=P(h,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER);j.msgType=d("MAWMsgType").MSG_TYPE.STICKER;j.mediaMetadata=b;Q(e,b,k,"attachment");return j}else if(g.documentMessage!=null){h=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").DocumentTransportSpec,(h=g.documentMessage)==null?void 0:(h=h.document)==null?void 0:h.payload);b=P(h,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.DOCUMENT,(h=g.documentMessage)==null?void 0:h.fileName);j.msgType=d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE;j.mediaMetadata=b;Q(e,b,k,"attachment");return j}}else if((i==null?void 0:(g=i.obj.payload)==null?void 0:(h=g.applicationData)==null?void 0:h.revoke)!=null){g=i==null?void 0:(g=i.obj.payload)==null?void 0:(h=g.applicationData)==null?void 0:(g=h.revoke)==null?void 0:(h=g.key)==null?void 0:h.id;if(g==null)d("WALogger").ERROR(r());else{j.revokedMsgExternalId=d("WAStanzaUtils").toStanzaId(g);j.msgType=d("MAWMsgType").MSG_TYPE.REVOKED;return j}}if((i==null?void 0:(h=i.obj.payload)==null?void 0:(g=h.content)==null?void 0:g.bumpExistingMessage)!=null){h=i==null?void 0:(h=i.obj.payload)==null?void 0:(g=h.content)==null?void 0:g.bumpExistingMessage;g=(g=h.key)==null?void 0:g.id;g!=null&&(B.has(g)||A.add(g),C.set(e,g));g=(g=h.key)==null?void 0:g.participant;if(g==null){g=(h=h.key)==null?void 0:h.remoteJid}if(g==null)d("WALogger").ERROR(q());else{h=d("WAJids").unsafeCoerceToUserJid(g);g=h===c?d("WAJids").AUTHOR_ME:h;E.set(d("WAStanzaUtils").toStanzaId(e),g);j.msgType=d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE;return j}}if((i==null?void 0:(h=i.obj)==null?void 0:(g=h.payload)==null?void 0:(h=g.content)==null?void 0:h.noteReplyMessage)!=null){h=i==null?void 0:(g=i.obj)==null?void 0:(h=g.payload)==null?void 0:(g=h.content)==null?void 0:g.noteReplyMessage;g=h.noteTimestampMs;var l=h.noteText;a=(a=a.metadata)==null?void 0:a.senderId;if(g!=null&&typeof g==="number"&&a!=null&&f!=null){a=d("MAWJids").toUserJid(a);f=d("MAWJids").toUserJid(f);a=f===a?c:f;f={author:a===c?d("WAJids").AUTHOR_ME:a,externalId:d("WAStanzaUtils").toStanzaId(e),ts:d("WATimeUtils").castMilliSecondsToUnixTime(g),type:d("WAMsgType").NOTE_REPLY};if((l==null?void 0:l.text)!=null){c={content:l==null?void 0:l.text,mentionedJids:l==null?void 0:l.mentionedJid.map(function(a){return d("MAWJids").toUserJid(a)})};f.msgContent=c}j.noteReply=f}if(h.textContent!=null){j.msgType=d("MAWMsgType").MSG_TYPE.TEXT;j.decodedPayload=h.textContent;return j}else if(h.stickerContent!=null){a=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").StickerTransportSpec,h.stickerContent.payload);b=P(a,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER);j.msgType=d("MAWMsgType").MSG_TYPE.STICKER;j.mediaMetadata=b;Q(e,b,k,"attachment");return j}else if(h.videoContent!=null){g=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").VideoTransportSpec,h.videoContent.payload);b=P(g,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO);b!=null&&b.xAttachmentType===d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF?j.msgType=d("MAWMsgType").MSG_TYPE.GIF:j.msgType=d("MAWMsgType").MSG_TYPE.VIDEO;j.mediaMetadata=b;Q(e,b,k,"attachment");return j}}i!=null&&S(j,i.obj);d("WALogger").ERROR(p());return j}function S(a,b){var c;(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.locationMessage)!=null&&(a.futureProofMessageType="locationMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.liveLocationMessage)!=null&&(a.futureProofMessageType="liveLocationMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.pollCreationMessage)!=null&&(a.futureProofMessageType="pollCreationMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.pollUpdateMessage)!=null&&(a.futureProofMessageType="pollUpdateMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.viewOnceMessage)!=null&&(a.futureProofMessageType="viewOnceMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.contactMessage)!=null&&(a.futureProofMessageType="contactMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.extendedTextMessage)!=null&&(a.futureProofMessageType="extendedTextMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.groupInviteMessage)!=null&&(a.futureProofMessageType="groupInviteMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.commonSticker)!=null&&(a.futureProofMessageType="commonSticker");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.screenshotAction)!=null&&(a.futureProofMessageType="screenshotAction");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.ravenMessage)!=null&&(a.futureProofMessageType="ravenMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.ravenActionNotifMessage)!=null&&(a.futureProofMessageType="ravenActionNotifMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.extendedMessageContentWithSear)!=null&&(a.futureProofMessageType="extendedMessageContentWithSear");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.imageGalleryMessage)!=null&&(a.futureProofMessageType="imageGalleryMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.paymentsTransactionMessage)!=null&&(a.futureProofMessageType="paymentsTransactionMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.ravenMessageMsgr)!=null&&(a.futureProofMessageType="ravenMessageMsgr");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.applicationData)==null?void 0:c.metadataSync)!=null&&(a.futureProofMessageType="metadataSync");(b==null?void 0:(c=b.payload)==null?void 0:(b=c.applicationData)==null?void 0:b.aiBotResponse)!=null&&(a.futureProofMessageType="aiBotResponse")}function T(a){var b;b=(b=a.metadata)==null?void 0:b.messageId;a=d("decodeProtobuf").decodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,a.payload);var c=d("WAParseMessageApplication").parseMessageApplication(a);if(c.type==="error"){d("WALogger").ERROR(o());return}a=a.metadata;var e=a==null?void 0:a.quotedMessage;e=e==null?void 0:e.stanzaId;b!=null&&e!=null&&(B.has(e)||A.add(e),C.set(b,e));if(c.subprotocolType==="armadillo"){b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAArmadilloApplication.pb").ArmadilloSpec,c.payload);return{metadata:a,obj:b}}else if(c.subprotocolType==="consumerMessage")return{metadata:a,obj:d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAConsumerApplication.pb").ConsumerApplicationSpec,c.payload)}}function U(a,b,c){return a.map(function(a){return V(a,b,c)})}function V(a,b,c){var e=d("decodeProtobuf").decodeProtobuf(d("WAArmadilloBackupMessage.pb").BackupMessageSpec,a.toplevelProtobuf.decryptedProtobuf);e=R(e,a.toplevelProtobuf.protobufTimestampMS,b,a.otid,c);c=a.supplementalProtobufs;for(c of c){var f=c[0],g=c[1];if(!d("MessageBackupSupplementalKeyGenerator").isSupplementalProtobufAReaction(f)&&!d("MessageBackupSupplementalKeyGenerator").isSupplementalProtobufAnEdit(f))continue;var h=d("decodeProtobuf").decodeProtobuf(d("WAArmadilloBackupMessage.pb").BackupMessageSpec,g.decryptedProtobuf);if(d("MessageBackupSupplementalKeyGenerator").isSupplementalProtobufAReaction(f)&&h.payload!=null){var i,j;i=(i=h.metadata)==null?void 0:i.messageId;j=(j=T(h))==null?void 0:(j=j.obj.payload)==null?void 0:(j=j.content)==null?void 0:j.reactionMessage;var k=d("MessageBackupSupplementalKeyGenerator").getSupplementalSenderId(f);j!=null&&k!=null&&e.reactionData.push({reaction:j,reactionExternalId:i,senderId:k,ts:d("WATimeUtils").castMilliSecondsToUnixTime(g.protobufTimestampMS)})}else if(d("MessageBackupSupplementalKeyGenerator").isSupplementalProtobufAnEdit(f)&&h.payload!=null){j=f.split(":");j.length!==3&&d("WALogger").ERROR(n());i=d("WAStanzaUtils").toStanzaId(j[1]);j=(k=T(h))==null?void 0:(g=k.obj.payload)==null?void 0:(f=g.content)==null?void 0:f.editMessage;g=(k=h.metadata)==null?void 0:k.senderId;if(j!=null){h=(f=j.key)==null?void 0:f.id;k=j.timestampMs;if(h!=null&&k!=null&&g!=null&&typeof k==="number"){f=d("MAWJids").toUserJid(g);g=f===b?d("WAJids").AUTHOR_ME:f;e.editMsgData.push({author:g,editMsgContent:j,externalId:i,originalMsgExternalId:d("WAStanzaUtils").toStanzaId(h),ts:d("WATimeUtils").castMilliSecondsToUnixTime(k)})}}}}B.add(a.otid);return e}function W(a,b,e,f,g,h){h==null?void 0:h.addPoint("replies_restore_start");return F(a,g,h).then(function(){b!=null&&(A.forEach(function(a){d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(a,b,void 0,c("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT,g)}),A.clear(),C.clear(),B.clear(),D.clear())})}function aa(a,e,f){f==null?void 0:f.addPoint("xma_restore_start");var g=[],h=new Map();return(i||(i=b("Promise"))).all(a.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(d("MAWDbMsg").isXMAMsg(a)){var b=a.externalId,c=e.get(b);if(c!=null&&c.xmaData!=null){a=J(a.author,a.externalId,a.msgId,a.threadJid,c.xmaData);if(a!=null){var f,i,j=[],k=[],l=[];c=D.get(b);c!=null&&c.forEach(function(a){var b=d("WAMediaUtils").stringToDeliveryObjectId(a.mediaMetadata.attachmentObjectId);l.push(b);a.mediaRestoreType==="xma_header"&&(f=b);a.mediaRestoreType==="xma_favicon"&&(i=b);a.mediaRestoreType==="xma_preview"&&j.push(b)});var m=(yield d("MAWHandleEchoXMARestoreV2").getMediaForXMAByObjectIds(l));m.forEach(function(a,b){h.set(a.mediaId,a)});if(f!=null){a.headerMediaId=(b=m.get(f))==null?void 0:b.mediaId}if(i!=null){a.faviconMediaId=(c=m.get(i))==null?void 0:c.mediaId}j.forEach(function(a){a=(a=m.get(a))==null?void 0:a.mediaId;a!=null&&k.push(a)});a.previewMediaIds=k;k.length>0&&(a.defaultPreviewMediaId=k[0]);g.push(a)}}}});return function(b){return a.apply(this,arguments)}}())).then(function(){return d("MAWHandleEchoXMARestoreV2").writeXMAsToDb(g).then(function(a){a.forEach(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b;a.previewMediaIds!=null&&a.previewMediaIds.length>0&&(b=h.get(a.previewMediaIds[0]));var e;c("gkx")("821")?e=(yield d("MAWHandleXmaTransactionUtil").checkMediaChunkTransactionAndCreatedBridgeXma(b,a)):e=d("MAWBridgeXMA").createBridgeXMA(b,a,!1);d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewXMA",value:e}]})});return function(b){return a.apply(this,arguments)}}()),f==null?void 0:f.addPoint("xma_restore_end",{"int":{xma:a.length}})})})}function a(a){return X.apply(this,arguments)}function X(){X=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.currentUserJid,f=a.deanonApiPayload,g=a.decryptedMessagesProtobufs,m=a.echoMessages,n=a.hasMoreAfter,o=a.hasMoreBefore,p=a.instanceKey,q=a.isPointRestore,r=a.minMsgId,s=a.referenceTimestamp,t=a.requestId,u=a.taskSource,v=a.threadJidPrimaryId;a=a.uploadedFromEbQueue;if(g.length===0)return(i||(i=b("Promise"))).resolve();d("WALogger").LOG(l(),g.length,q,s);u=u!=null&&u===c("LSMEBTaskCreationSource").MSGR_DYI;var w=v,x=(yield d("MAWHandleEchoMsgsRestoreApiV2").getThread(v,t,u));s=q?d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.POINT_RESTORE:s!=null?d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.PAGINATED_RESTORE:d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.INITIAL_RESTORE;s=s;var y=d("MAWQplProxy").startQplUserFlow(c("qpl")._(521486220,"827"),{bool:{isPointRestore:q,uploadedFromEbQueue:a},"int":{messages:g.length},string:{message_backup_type:"protobuf",restore_type:s}},void 0,3e5);d("MAWTraceUtils").recordCheckpointForTrace(t,(h||(h=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_ECHO_MESSAGE_RESTORE_BEGIN),[],!1);if(x){s=U(g,e,v);var z=x.jid,A=new Set(),C=new Map(),F=s.map(function(a){C.set(d("WAStanzaUtils").toStanzaId(a.externalId),a);var b=K(a,z,e);b==null&&A.add(a.externalId);return b}).filter(Boolean),G=s.filter(function(a){return A.has(a==null?void 0:a.externalId)});m!=null&&m.length>0&&m.length!==g.length&&(y==null?void 0:y.addPoint("mismatch_between_echo_and_protobuf_payload_from_server",{"int":{echoMessagesLength:m.length,protobufMessagesLength:g.length}}));if(G.length>0){var H=new Map();G.forEach(function(a){var b="unknown";a.msgType!=null?b=a.msgType:a.futureProofMessageType!=null&&(b=a.futureProofMessageType);a=H.get(b);a!=null?H.set(b,a+1):H.set(b,1)});var I={};H.forEach(function(a,b){b="protobuf_restore_failure_"+b;I[b]=a});y==null?void 0:y.addPoint("protobuf_restore_failed_count_by_msg_type",{"int":I});if(m!=null&&m.length===g.length){d("WALogger").LOG(k());B.clear();y==null?void 0:y.addPoint("reverting_to_echo_restore");yield d("MAWHandleEchoMsgsRestoreApiV2").handleEchoMsgsBulkRestore(v,m,!1,o,n,r,void 0,void 0,p,void 0,void 0,y,void 0,a);return}}G=F.map(function(a){return{author:a.author,chat:x.jid,externalId:a.stanzaId}});var J=new Set();m=F.map(function(a){J.add(a.stanzaId);return babelHelpers["extends"]({},babelHelpers["extends"]({},a.unstoredDbContent.unstoredDbMsg,{threadJid:x.jid}))});var L=new Map();f!=null&&f.forEach(function(a){L.set(a.externalId,a.sortOrderMs)});s.forEach(function(a){var b=a.sortOrderMs;a=a.externalId;if(L.size>0&&b!=null){a=L.get(a);a!=null&&(a!==b&&(y==null?void 0:y.addPoint("protobuf_restore_toplevel_ts_mismatch")))}});m.sort(function(a,b){return((a=a.sortOrderMs)!=null?a:0)-((a=b.sortOrderMs)!=null?a:0)});n=(yield (i||(i=b("Promise"))).all([d("MAWRestoreMsgsTxns").maybeGetThreadNewestMessage(x),d("MAWRestoreMsgsTxns").maybeGetOldestNonAdminMessage(x),d("MAWRestoreMsgsTxns").getMsgsByProtocolMsgIds(G)]));a=n[0];F=n[1];s=F.maybeOldestAdminMsg;G=F.maybeOldestMsg;F=n[2];var M=new Set(F.map(function(a){return a.externalId}));n=m.filter(function(a){return!M.has(a.externalId)});m=q||o;F={bumpMessageAuthorMap:E,existingMsgs:F,hasMoreBefore:(o=m)!=null?o:!0,instanceKey:p,isDyiInProgress:u,isPointRestore:q,maybeNewestMsg:a,maybeOldestAdminMsg:s,maybeOldestMsg:G,minMsgId:r,newMsgs:n,thread:x};y==null?void 0:y.addPoint("message_restore_start");m=(yield d("MAWRestoreMsgsTxns").restoreMsgsForThread(F));o=0;p=0;y==null?void 0:y.addPoint("message_restore_end");u=[];(m==null?void 0:m.existingMsgs)!=null&&(u=u.concat(m==null?void 0:m.existingMsgs),o=m==null?void 0:m.existingMsgs.length);(m==null?void 0:m.newlyAddedMsgs)!=null&&(u=u.concat(m==null?void 0:m.newlyAddedMsgs),p=m==null?void 0:m.newlyAddedMsgs.length);f!=null&&!q&&d("MAWRestoreValidationUtils").compareRestoredMsgstoDeanonData(u,f,g,void 0,y);var N=[];u.map(function(a){if(a!=null&&D.has(a.externalId)){var b=a.sortOrderMs,c=d("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(a.author),e=D.get(a.externalId);b==null?d("WALogger").ERROR(j()):e!=null&&a.mediaId==null&&e.map(function(e){e={author:c,echoMsg:void 0,externalId:a.externalId,isXMA:d("MAWDbMsg").isXMAMsg(a),mediaData:e.mediaMetadata,messageTimestamp:b,msgId:a.msgId,previewMediaData:void 0,threadJId:a.threadJid};N.push(e)})}});a=d("MAWHandleEchoMediaMsgsRestoreV2").downloadMediaAndWriteToMediaStore(N,z,q);s=i.all(u.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=C.get(a.externalId);a!=null&&(yield ba(a,z,y,e),yield ca(a,z,e,y))});return function(b){return a.apply(this,arguments)}}()));y==null?void 0:y.addPoint("media_restore_start");yield i.all([a,s]);y==null?void 0:y.addPoint("media_restore_end",{"int":{media:N.length}});yield aa(u,C,y);yield W(u,w,x.chatId,q,z,y);y.endSuccess({"int":{existingMsgs:o,messages_lost:g.length-o-p,newlyAddedMsgs:p,restoredMsgs:o+p,totalMsgsToRestore:g.length},string:{threadJidPrimaryId:v}});d("MAWTraceUtils").recordCheckpointForTrace(t,(h||(h=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_RESTORE_MESSAGES_SUCCESS),[],!1);d("MAWTraceUtils").recordCheckpointForTrace(t,h.ofNumber(c("LSDataTraceCheckPoint").FLOW_END_AND_FLUSH),[],!0)}});return X.apply(this,arguments)}function ba(a,b,c,d){return Y.apply(this,arguments)}function Y(){Y=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e){c.addPoint("msg_history_start");if(a.editMsgData.length>0){var f,g,h,i=[],j=a.sortOrderMs;f=(f=a.metadata)==null?void 0:f.messageId;g=(g=a.metadata)==null?void 0:g.senderId;h=(h=a.decodedPayload)==null?void 0:h.text;if(f!=null&&g!=null){j=d("WATimeUtils").castMilliSecondsToUnixTime(j);g=d("MAWJids").toUserJid(g);f=d("WAStanzaUtils").toStanzaId(f);e=g===e?d("WAJids").AUTHOR_ME:g;g=Z(e,h,f,f,j,b);g!=null&&i.push(g);a.editMsgData.forEach(function(a){var c;c=Z(a.author,(c=a.editMsgContent.message)==null?void 0:c.text,a.externalId,a.originalMsgExternalId,a.ts,b);c!=null&&i.push(c)});yield da(i);c.addPoint("msg_history_end")}}});return Y.apply(this,arguments)}function Z(a,b,c,e,f,g){var h=a===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED;if(b!=null)return{author:a,editExternalId:c,editTs:f,msgContent:{content:b},originalMsgExternalId:e,sendStatus:h,threadJid:g};d("WALogger").ERROR(m());return void 0}function ca(a,b,c,d){return $.apply(this,arguments)}function $(){$=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g){f=H(a,e,f);a=a.metadata;if(f!=null&&a!=null){g.addPoint("reactions_restore_start");var h=a.messageId,j=[];f.forEach(function(a,b){return j.push({stanzaId:b,waReactionMsg:a})});if(c("gkx")("4219")){a=j.filter(function(a){a=a.waReactionMsg;return h!=null&&a.ts!=null}).map(function(a){var b=a.stanzaId;a=a.waReactionMsg;return{args:{groupingKey:a.reaction.groupingKey,reaction:a.reaction.text,reactToAuthor:d("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(a.reactToMsgAuthor),reactToExternalId:a.reactToExternalId,senderTimestampMs:a.reaction.senderTimestampMs},author:d("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(a.reactionAuthor),chatJid:e,externalId:b,ts:a.ts}});yield d("MAWWriteReactionMsgApi").bulkWriteReactionMsg(a)}else{f=(i||(i=b("Promise"))).all(j.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.waReactionMsg,c=b.ts;c!=null&&h!=null&&(yield d("MAWWriteReactionMsgApi").writeReactionMsg(a.stanzaId,e,{groupingKey:b.reaction.groupingKey,reaction:b.reaction.text,reactToAuthor:d("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(b.reactToMsgAuthor),reactToExternalId:b.reactToExternalId,senderTimestampMs:b.reaction.senderTimestampMs},c,d("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(b.reactionAuthor)))});return function(b){return a.apply(this,arguments)}}()));yield f}g.addPoint("reactions_restore_end")}});return $.apply(this,arguments)}var da=d("MAWIndexedDb").makeMsgrTransactor({editMsgHistory:e.READWRITE,messages:e.READWRITE},"bulkAddEditMsgHistory",function(a){return function(b){return d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,b).then(function(){})}});g.associateQuotedMessagesForRestoredDbMsgsTransactor=F;g.createUnstoredDbContentFromProtobufObject=K;g.decodeProtobufArray=U;g.decodeDecryptedMessageProtobuf=V;g.handleProtobufsRestore=a}),98);
__d("MAWUploadMessageTxns",["EBUploadMessages","EchoCommonUtils","EchoEncodingUtils","EchoMessage","EchoMessageQuoteFieldUtils","LSEBPayloadSerializerError","LSMEBTaskCreationSource","MAWBridgeEventTransmitter","MAWConvertExtendedContentOverlayIconGlyphToXMAGatingType","MAWConvertExtendedContentTargetTypeToXMATargetType","MAWConvertExtendedContentXMLLayoutTypeToXMALayoutType","MAWDbEditMsgHistoryTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbMsgUtil","MAWDbReactionsTxns","MAWDbXMATxns","MAWDexieTable","MAWEBUploadMessageUtils","MAWEncryptedBackupCacheManager","MAWGetAttachmentTypeForServerMediaType","MAWGetMediaAttachmentTypeForServerMediaType","MAWGetPreviewContentTypeForMediaType","MAWJidUtils","MAWJids","MAWMsgType","MAWVault","MAWXMAUtils","WAArmadilloXMA.pb","WABase64","WAGlobals","WAJids","WALogger","WAMediaUtils","WATimeUtils","err","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] edit history has length ",", but edit count on message is ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No XMA object found for msg with external id ",". Cannot upload XMA"]);k=function(){return a};return a}var l="You unsent a message";function m(a){switch(a.specialTextSize){case 1:return d("EchoMessage").MessageTextSize.SMALL;case 2:return d("EchoMessage").MessageTextSize.MEDIUM;case 3:return d("EchoMessage").MessageTextSize.LARGE;default:return d("EchoMessage").MessageTextSize.NONE}}function n(a,b){return d("MAWDbXMATxns").maybeGetXMAFromProtocolMsgId(a,d("MAWJidUtils").maybeToProtocolMsgId(b.author,b.threadJid,b.externalId)).then(function(e){if(e!=null)return e.previewMediaIds!=null?d("MAWDexieTable").dexieAll(e.previewMediaIds.map(function(b){return d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,b)})).then(function(a){for(var a=a,b=Array.isArray(a),f=0,a=b?a:a[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var g;if(b){if(f>=a.length)break;g=a[f++]}else{f=a.next();if(f.done)break;g=f.value}g=g;if(g==null)return d("MAWDexieTable").dexieResolve({maybeErrorDetail:{errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"constructEchoMessage: DbMedia is null for the XMA message",uploadErrorType:d("EBUploadMessages").UploadErrorType.WARN},xmaData:void 0})}return u(e)}):u(e);else{d("WALogger").ERROR(k(),b.externalId);return d("MAWDexieTable").dexieResolve({maybeErrorDetail:{errorCode:c("LSEBPayloadSerializerError").UNKNOWN_ERROR,errorMsg:"constructEchoMessage: no xma object found for msg with external id "+b.externalId,uploadErrorType:d("EBUploadMessages").UploadErrorType.WARN},xmaData:void 0})}})}function o(a,b){try{return d("MAWDbMsg").isMediaMsg(a)||a.type===d("MAWMsgType").MSG_TYPE.XMA}catch(e){a="[labyrinth_web] Invalid msg type for isMediaMsg check: "+e;d("WALogger").ERROR(j(),a);b.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:a,uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return!1}}function p(a,b){return{echoMessage:null,externalId:a,maybeErrorDetail:{errorCode:c("LSEBPayloadSerializerError").NOT_IMPLEMENTED,errorMsg:b,uploadErrorType:d("EBUploadMessages").UploadErrorType.WARN}}}function q(a,b,c){var e=d("MAWDexieTable").dexieResolve(c.threadJid),f={mediaMetadata:null},g=o(c,f);g=g?s(a,c):d("MAWDexieTable").dexieResolve(f);f=t(a,c);b=c.quote!=null?z(a,c.quote,e,b):d("MAWDexieTable").dexieResolve();var h=d("MAWDbMsg").isXMAMsg(c)?n(a,c):d("MAWDexieTable").dexieResolve(null);a=d("MAWDbEditMsgHistoryTxns").getEditHistoryAsEchoWithJidPromise(a,c.externalId,c.author,e);return{editHistoryPromise:a,mediaMetadataUploadPromise:g,quotedMsgPromise:b,reactionsPromise:f,threadJidPromise:e,xmaDataUploadRequestPromise:h}}function r(a,b,e,f,g,h,j,k){var n,o=d("WAJids").threadIdForChatJid(a),p=j.serverTs;n=(n=j.editCount)!=null?n:0;h.length>0&&h.length-1!==j.editCount&&(d("WALogger").WARN(i(),h.length,j.editCount),n=h.length-1);p={authoritativeTimestampMs:p!=null?p*1e3:void 0,contentSubtype:d("EchoMessage").EchoMessageContentSubtype.NONE,contentType:d("EchoMessage").EchoMessageContentType.TEXT,displayTimestampMs:j.ts*1e3,editCount:n,editHistory:h,from:d("EchoCommonUtils").craftEchoAddress(null,k,"AdvancedCrypto"),groupId:j.groupId,groupIndex:j.groupIndex,groupSize:j.groupSize,isForwarded:j.isForwarded,messageId:j.externalId,serializationOrigin:d("EchoMessage").EchoSerializationOriginType.WEB,sortOrderMs:d("MAWEBUploadMessageUtils").echoOverrideMessageSortOrder(j),textSize:m(j),threadId:o,version:d("EchoMessage").ECHO_MESSAGE_MIGRATION_DOCUMENT_VERSION,xContentType:d("EchoEncodingUtils").convertDbMsgTypeToXMessageContentType(j.type),xMessagePlaceholderType:d("EchoMessage").EchoMessagePlaceholderType.NO_PLACEHOLDER,xOfflineThreadingId:j.externalId,xThreadId:o};((n=j.msgContent)==null?void 0:n.content)!=null&&(p=babelHelpers["extends"]({},p,{text:d("MAWVault").unvault(j.msgContent.content)}));j.type===d("MAWMsgType").MSG_TYPE.REVOKED&&(p.contentType=d("EchoMessage").EchoMessageContentType.PLACEHOLDER,p.contentSubtype=d("EchoMessage").EchoMessageContentSubtype.UNSEND,p.revokeSentTimestampMs=j.originalTs,p.revokeUnsentTimestampMS=j.unsendMsgContentDeleteTs,p.text=l);if(f!=null){h=y(f);k=d("MAWXMAUtils").isXMAStoryReply(f.xmaMessageType)?A(h.senderId,a):h.senderId;o=d("EchoCommonUtils").craftEchoAddress(null,k,"AdvancedCrypto");f.sortOrderMs!=null&&(p.quoteData={quoteMessageId:f.externalId,quoteMessageSender:o,quoteSortOrderInMs:f.sortOrderMs,replyType:j.type===d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE?d("EchoMessageQuoteFieldUtils").EchoMessageQuoteReplyType.BUMP:void 0,status:d("EchoMessageQuoteFieldUtils").EchoMessageQuoteStatus.VALID},f.type===d("MAWMsgType").MSG_TYPE.XMA&&c("gkx")("458")&&(p.xContentType=d("EchoEncodingUtils").convertDbMsgTypeToXMessageContentType(f.type)))}if(d("MAWMsgType").isMAWSupportedMediaType(j.type)){n=b.mediaMetadata;if(n!=null)p=babelHelpers["extends"]({},p,{contentType:d("EchoMessage").EchoMessageContentType.MEDIA,mediaData:n});else if(j.type!==d("MAWMsgType").MSG_TYPE.XMA)return{echoMessage:p,externalId:j.externalId,maybeErrorDetail:b.maybeErrorDetail}}if(g!=null&&g.xmaData!=null&&j.type===d("MAWMsgType").MSG_TYPE.XMA){p.xmaData=g.xmaData;p.contentType=d("EchoMessage").EchoMessageContentType.XMA;if(p.mediaData==null&&((a=g.xmaData)==null?void 0:a.xmaDefaultCTA)!=null&&p.text==null){p.text=(h=g.xmaData)==null?void 0:h.xmaDefaultCTA}}else if(g!=null&&g.xmaData==null&&j.type===d("MAWMsgType").MSG_TYPE.XMA)return{echoMessage:p,externalId:j.externalId,maybeErrorDetail:g.maybeErrorDetail};return{echoMessage:babelHelpers["extends"]({},p,e),externalId:j.externalId}}function a(a,b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.dbMsg;b=b.quotedMsg;if(!d("MAWMsgType").isEBSupportedMsgType(c.type))return d("MAWDexieTable").dexieResolve(p(c.externalId,'constructEchoMessage: "'+String(c.type)+'" NYI'));if(c.serverTs==null)return d("MAWDexieTable").dexieResolve(p(c.externalId,'constructEchoMessage: "'+String(c.type)+'" Not authoritative msg. '));var e=d("WATimeUtils").castToUnixTime(0);if(c.serverTs===e||c.serverTs===null&&c.ts===e){e="constructEchoMessage: Invalid timestamp - timestamp for message corresponds to 1/1/1970";d("WALogger").ERROR(h(),e);return d("MAWDexieTable").dexieResolve(p(c.externalId,e))}e=y(c);var f=e.senderId;e=q(a,b,c);b=e.editHistoryPromise;var g=e.mediaMetadataUploadPromise,i=e.quotedMsgPromise,j=e.reactionsPromise,k=e.threadJidPromise;e=e.xmaDataUploadRequestPromise;return d("MAWDexieTable").dexieAll([k,g,j,i,e,b]).then(function(a){var b=a[0],d=a[1],e=a[2],g=a[3],h=a[4];a=a[5];return r(b,d,e,g,h,a,c,f)})}))}function s(a,b){var e={mediaMetadata:null};if(b.type===d("MAWMsgType").MSG_TYPE.XMA)return d("MAWDbXMATxns").maybeGetXMAFromProtocolMsgId(a,d("MAWJidUtils").maybeToProtocolMsgId(b.author,b.threadJid,b.externalId)).then(function(b){if(b!=null)return v(a,b);else{e.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] Media meta data couldn't be created for XMA because DbXMA is not in IndexedDB. This probably means the XMA message was not sent properly by ChatX.",uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return d("MAWDexieTable").dexieResolve(e)}});if(!d("MAWMsgType").isMAWSupportedMediaType(b.type)){e.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").NOT_SUPPORTED_ON_WEB,errorMsg:"[labyrinth_web] Media type is not supported for msg, type: "+b.type,uploadErrorType:d("EBUploadMessages").UploadErrorType.WARN};return d("MAWDexieTable").dexieResolve(e)}if(b.mediaId==null){e.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] No media id found in a media msg",uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return d("MAWDexieTable").dexieResolve(e)}var f=d("WATimeUtils").DAY_SECONDS*28,g=b.serverTs;if(g!=null&&d("WATimeUtils").unixTime()-g>f){e.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] Media is older than 28 days and is not being uploaded.",uploadErrorType:d("EBUploadMessages").UploadErrorType.WARN};return d("MAWDexieTable").dexieResolve(e)}return d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,b.mediaId).then(function(f){if(!f){e.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] No media db entry for media id",uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return d("MAWDexieTable").dexieResolve(e)}var g=d("MAWDbMediaTxns").maybeGetMediaBackupRowFromMsgId(a,b.msgId);return g.then(function(a){return d("MAWDexieTable").dexieResolve(w(b.msgId,f,!1,a))})})}function t(a,b){b=d("MAWDbMsgUtil").getProtocolMsgIdFromDbMsg(b);return b==null?d("MAWDexieTable").dexieResolve():d("MAWDbReactionsTxns").getReactionForEcho(a,b).then(function(a){if(a!=null&&a.length>0){var b=d("WAJids").extractUserId(d("WAGlobals").getMyUserJid()),c=a.map(function(a){var c=d("WAJids").authorToUserId(a.author,b);return d("EchoCommonUtils").craftEchoAddress(a.reaction,c,"AdvancedCrypto")}),e=a.map(function(a){var c=d("WAJids").authorToUserId(a.author,b);return d("EchoCommonUtils").craftEchoAddress((a.ts*1e3).toString(),c,"AdvancedCrypto")});a=a.map(function(a){var c=d("WAJids").authorToUserId(a.author,b);return d("EchoCommonUtils").craftEchoAddress(a.externalId.toString(),c,"AdvancedCrypto")});return{reactionAuthoritativeTimestampMs:e,reactions:c,reactionXOfflineThreadingIds:a}}})}function u(a){var b={xmaData:null};if(a.isTombstoned==null){b.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no isTombstoned to construct XMAData",uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return b}var e={xmaContentRef:a.contentRef,xmaHeaderSubtitle:a.overlayTitle,xmaHeaderTitle:a.headerTitle,xmaIsTombstoned:a.isTombstoned,xmaMaxSubtitleNumLines:a.maxSubtitleNumOfLines,xmaMaxTitleNumLines:a.maxTitleNumOfLines,xmaSubtitleText:a.subtitleText,xmaTargetExpiry:a.targetExpiringAtSec,xmaTargetId:a.targetId,xmaTargetUsername:a.targetUsername,xmaTitleText:a.titleText},f=a.xmaLayoutType||d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE;e=babelHelpers["extends"]({},e,{xmaLayoutType:d("MAWConvertExtendedContentXMLLayoutTypeToXMALayoutType").convertExtendedContentXMLLayoutTypeToXMALayoutType(f)});a.targetType!=null&&(e=babelHelpers["extends"]({},e,{xmaTargetType:d("MAWConvertExtendedContentTargetTypeToXMATargetType").convertExtendedContentTargetTypeToXMATargetType(a.targetType)}));a.overlayIconGlyph!=null&&(e=babelHelpers["extends"]({},e,{xmaGatingType:d("MAWConvertExtendedContentOverlayIconGlyphToXMAGatingType").convertExtendedContentOverlayIconGlyphToXMAGatingType(a.overlayIconGlyph)}));a.defaultCTA!=null&&a.defaultCTA.nativeUrl!=null&&(e=babelHelpers["extends"]({},e,{xmaDefaultCTA:a.defaultCTA.nativeUrl}));b.xmaData=e;return b}function v(a,b){var e={mediaMetadata:null};if(b.previewMediaIds!=null){var f=b.previewMediaIds[0];return d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,f).then(function(f){if(!f){e.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] No media db entry for media id to be used for xma",uploadErrorType:d("EBUploadMessages").UploadErrorType.WARN};return d("MAWDexieTable").dexieResolve(e)}var g=b.msgId;if(g==null){e.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] No message id found in a xma msg",uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return d("MAWDexieTable").dexieResolve(e)}var h=d("MAWDbMediaTxns").maybeGetMediaBackupRowFromMsgId(a,g);return h.then(function(a){return d("MAWDexieTable").dexieResolve(w(g,f,!0,a))})})}else return d("MAWDexieTable").dexieResolve(e)}function w(a,b,e,f){var g={mediaMetadata:null},h=null;f!=null&&f.length>0&&(h=f.find(function(a){return a.mediaId===b.mediaId}));f=h!=null?h.fbid:b.fbid;a=b.mediaEntries.get(a);if(a==null){g.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no media entry to construct mediaMetadata",uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return g}a=d("WAMediaUtils").decodeMediaEntryData(a);h=h!=null?h.objectId:b.objectId;if(h==null)return g;var i=d("MAWGetAttachmentTypeForServerMediaType").getAttachmentTypeForServerMediaType(a.serverMediaType);if(i==null){g.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no attachment type to construct mediaMetadata",uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return g}var j=a.mediaKey;if(j==null){g.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no mediaKey to construct mediaMetadata",uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return g}var k=a.mediaKeyTimestamp;if(k==null){g.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no mediaKeyTimestamp to construct mediaMetadata",uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return g}var l=a.directPath;if(l==null){g.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no directPath to construct mediaMetadata",uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return g}if(a.serverMediaType==null){g.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no mediaContentType to construct mediaMetadata",uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return g}e=e?"image/jpeg":d("WAMediaUtils").getMimeTypeFromServerMediaType(a.serverMediaType);var m=d("MAWGetMediaAttachmentTypeForServerMediaType").getMediaAttachmentTypeForServerMediaType(a.serverMediaType);if(m==null){g.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no xAttachmentType to construct mediaMetadata",uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return g}if(a.serverMediaType!=null&&a.serverMediaType in{gif:1,image:1,sticker:1}&&b.validatedImageInfo==null){g.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no imageinfo to construct mediaMetadata",uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return g}if(a.serverMediaType==="video"&&b.validatedVideoInfo==null){g.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no videoinfo to construct mediaMetadata",uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return g}if(a.serverMediaType==="ptt"&&b.validatedAudioInfo==null){g.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no audioinfo to construct mediaMetadata",uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return g}if(a.fileSha256==null){g.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no WA fileSha256 found",uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return g}var n=d("WABase64").encodeB64UrlSafe(a.fileSha256);if(a.fileEncSha256==null){g.maybeErrorDetail={errorCode:c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no WA fileEncSha256 found",uploadErrorType:d("EBUploadMessages").UploadErrorType.FATAL};return g}g=d("WABase64").encodeB64UrlSafe(a.fileEncSha256);var o=null,p=null,q=null,r=null,s=null,t=void 0;a=d("MAWGetPreviewContentTypeForMediaType").getPreviewContentTypeForMediaType(a.serverMediaType);if(b.validatedImageInfo!=null){var u;o=(u=b.validatedImageInfo.width)!=null?u:0;p=(u=b.validatedImageInfo.height)!=null?u:0;r=(u=b.validatedImageInfo.jpegThumbnailWidth)!=null?u:0;s=(u=b.validatedImageInfo.jpegThumbnailHeight)!=null?u:0}if(b.validatedVideoInfo!=null){o=(u=b.validatedVideoInfo.width)!=null?u:0;p=(u=b.validatedVideoInfo.height)!=null?u:0;r=(u=b.validatedVideoInfo.jpegThumbnailWidth)!=null?u:0;s=(u=b.validatedVideoInfo.jpegThumbnailHeight)!=null?u:0;q=(u=b.validatedVideoInfo.duration)!=null?u:0}if(b.validatedAudioInfo!=null){q=(u=b.validatedAudioInfo.duration)!=null?u:0}b.validatedDocumentFileInfo!=null&&(t=b.validatedDocumentFileInfo.filename);u={attachmentObjectId:h,attachmentType:i,directPath:l,encryptedHash:g,mediaBackupStatus:"success",mediaContentType:e,mediaKey:d("EchoEncodingUtils").convertMediaKeyToString(j),mediaKeyTimestamp:k,plaintextHash:n,size:b.size,xAttachmentType:m,xContentType:"full"};u=x(u,f,a,o,p,q,r,s,t);return{mediaMetadata:u}}function x(a,b,c,d,e,f,g,h,i){a=a;b!=null&&(a=babelHelpers["extends"]({},a,{backupEntFbid:b}));c!=null&&(a=babelHelpers["extends"]({},a,{previewContentType:c}));d!=null&&(a=babelHelpers["extends"]({},a,{width:d}));e!=null&&(a=babelHelpers["extends"]({},a,{height:e}));f!=null&&(a=babelHelpers["extends"]({},a,{mediaPlayableDuration:f*1e3}));g!=null&&(a=babelHelpers["extends"]({},a,{previewContentWidth:g}));h!=null&&(a=babelHelpers["extends"]({},a,{previewContentHeight:h}));i!=null&&(a=babelHelpers["extends"]({},a,{filename:i}));return a}function y(a){a=d("WAJids").authorToUserId(a.author,d("WAJids").userIdFromJid(d("WAGlobals").getMyUserJid()));var b=d("MAWJids").toUserJid(a);return{senderId:a,senderJid:b}}function z(a,b,e,f){var g=b.content.msgId,h=b.content.externalId;return f!=null?d("MAWDexieTable").dexieResolve(f):d("MAWDbMsgTxns").maybeGetMsg(a,g).then(function(a){if(a==null)return e.then(function(a){var b=d("WAJids").threadIdForChatJid(a);if(!d("MAWEncryptedBackupCacheManager").peekRestoreCache(h)){d("MAWEncryptedBackupCacheManager").addMsgEntryToReuploadCache(a,h);d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(h,b,void 0,c("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT,a);return null}else{a=(b=d("MAWEncryptedBackupCacheManager").getRestoredCache(h))==null?void 0:b.dbMsg;return d("MAWDexieTable").dexieResolve(a)}});else return d("MAWDexieTable").dexieResolve(a)})}function A(a,b){var e=d("WAJids").extractUserId(d("WAGlobals").getMyUserJid());b=d("WAJids").interpretAsUserJid(b);if(b==null)throw c("err")("this is a flow check, participant jid can not be null");return a===e?d("WAJids").extractUserId(b):e}g.constructEchoMessage=a;g.constructXMAData=u;g.constructMediaMetadata=w;g.setConditionalFields=x}),98);
__d("MAWWriteOutgoingMsgApi",["MAWAckLevel","MAWAuthor","MAWDbMsg","MAWDbMsgTxns","MAWDbRavenActionTxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","MAWQplProxy","MAWTransactionMode","MAWVault","MAWWriteMsgTxns","WAArmadilloXMA.pb","WAAssertUnreachable","WAJids","WALogger","WAStanzaUtils","WATimeUtils","err","qpl"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["msgToQuotedMsg: Unsupported message type ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["BumpExistingMessage does not have quote content when replying"]);i=function(){return a};return a}var j=function(a,b,e){b!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),a,{annotations:e,instanceKey:b})};b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ephemeralSettings:a.READWRITE,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,participants:a.READONLY,threads:a.READWRITE,unrenderedMessages:a.READWRITE,xma:a.READONLY},"writeOutgoingMsg",function(a){return function(b,c,e,f,g){f.content!=null&&(f.content=d("MAWVault").vault(f.content));j("write_outgoing_msg_start",f.s2sInstanceKey);return d("MAWDexieTable").dexieAll([a.threads.get({jid:c}),a.messages.where("externalId").equals(b).toArray(),k(a,f.quote,c),d("MAWDbRavenActionTxns").maybeGetRavenMsgQueryByProtocolMsgId(a,f.ravenProtocolMsgId,g)]).then(function(c){var h=c[0],i=c[1],k=c[2];c=c[3];j("write_outgoing_msg_data_fetched",f.s2sInstanceKey,{bool:{isUnrenderedMsgType:d("MAWDbMsg").isUnrenderedMsgType(g)}});if(h==null)return{type:"missing_thread"};i=i.find(function(a){return a.threadJid===h.jid&&a.author===d("WAJids").AUTHOR_ME});if(i!=null)return i.ack>=d("MAWAckLevel").ACK.sent?{msgId:i.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:h.jid,externalId:i.externalId},type:"already_sent"}:{msgId:i.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:h.jid,externalId:i.externalId},type:"not_sent"};else{if(!d("MAWDbMsg").isUnrenderedMsgType(g)){i={ack:d("MAWAckLevel").ACK.clock,altIndex:void 0,author:d("WAJids").AUTHOR_ME,ephemeralSetting:f.ephemeralSetting,externalId:b,isForwarded:f.isForwarded,specialTextSize:f.specialTextSize,threadJid:h.jid,ts:e};var n=l(g,i,f,k),p=f.isFirstMsg,q=f.openMessageOtid,r=f.openMessageParticipantCount,s=f.optimisticMsg,t=f.participantCount;i=d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,n).then(function(b){return d("MAWWriteMsgTxns").writeMsg(a,n,h,{isCurrentDeviceSendingMsg:!0,isFirstMsg:p,isOutgoing:!0,openMessageOtid:q,openMessageParticipantCount:r,optimisticMsg:s,participantCount:t,quotedReplyAttachmentMeta:b})})}else{k={ack:d("MAWAckLevel").ACK.clock,author:d("WAJids").AUTHOR_ME,externalId:b,threadJid:h.jid,ts:e};k=m(g,k,f,c==null?void 0:c.externalId);i=d("MAWWriteMsgTxns").writeUnrenderedMsg(a,k,h)}return i.then(function(c){j("write_outgoing_msg_promise_resolved",f.s2sInstanceKey);return o(a,g,h.jid,e).then(function(){return{msgId:c.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:h.jid,externalId:b},type:"not_sent"}})})}})}});function k(a,b,c){return b==null?d("MAWDexieTable").dexieResolve(null):d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(b){return b==null?null:a.threads.get({jid:b.threadJid}).then(function(a){var e=n(b);if(e==null)return null;b.messageExpirationTs!=null&&b.messageExpirationTs<d("WATimeUtils").unixTime()&&(e=babelHelpers["extends"]({},e,{mediaId:void 0,msgContent:void 0,type:d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL,xmaMessageType:void 0}));if(a==null||a.jid===c)return{content:e,remoteJid:null};a=d("WAJids").interpretAndValidateJid(a.jid);a=a.jidType==="group"?a.groupJid:null;return{content:e,remoteJid:a}})})}function l(a,b,e,f){if(d("MAWDbMsg").isUnrenderedMsgType(a))throw c("err")("getNewMsg called for wrong message type "+a);var g,h;if(e.quote!=null&&(f==null?void 0:f.content)!=null){var i;h=f==null?void 0:(i=f.content)==null?void 0:i.externalId;g={content:f==null?void 0:f.content,remoteJid:(i=f==null?void 0:f.remoteJid)!=null?i:void 0}}f=babelHelpers["extends"]({},b,{quote:g,quoteExternalId:h});i=e.mediaGroupMetadata;switch(a){case"Text":return babelHelpers["extends"]({},f,{msgContent:{content:e.content!=null?e.content:"",mentionedJids:e.mentionedJids},type:d("MAWMsgType").MSG_TYPE.TEXT});case"Image":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.IMAGE},i);case"Video":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.VIDEO});case"Ptt":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.PTT});case"Gif":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.GIF});case"Sticker":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.STICKER});case"DocumentFile":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE});case"XMA":if(e.xmaMessageType==null)throw c("err")("XMA Message Missing xmaMessageType");b=e.content!=null&&e.xmaMessageType===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE?e.content:"";return babelHelpers["extends"]({},f,{msgContent:{content:b},type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:e.xmaMessageType});case"EditAction":throw c("err")("EditAction is not supported yet");case"BumpExistingMessage":throw c("err")("BumpExistingMessage is not supported yet");case"Revoked":case"DeleteForMe":case"Ciphertext":case"Futureproof":case"Unavailable":case"Admin":case"ExpiredEphemeral":case"EphemeralSettingAdmin":case"EphemeralScreenshotAction":case"AlertICDC":case"GroupInvite":case"Reaction":case"Raven":case"RavenAction":throw c("err")("Should not be writing ciphertext, futureproof, unsent, admin,\n        ephemeral setting messages, ephemeral screenshot action, group invite messages");default:throw c("WAAssertUnreachable")(a)}}function m(a,b,e,f){if(!d("MAWDbMsg").isUnrenderedMsgType(a))throw c("err")("getNewUnrenderedMsg called for wrong message type "+a);switch(a){case"EphemeralSyncResponse":if(e.ephemeralSetting==null)throw c("err")("Ephemeral Sync Response without ephemeral settings");return babelHelpers["extends"]({},b,{ephemeralSetting:e.ephemeralSetting,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE});case"EphemeralSettingChangeFromCurrentDevice":var g;if(e.ephemeralSetting==null)throw c("err")("Ephemeral Setting Change without ephemeral settings");return babelHelpers["extends"]({},b,{ephemeralSetting:e.ephemeralSetting,isEphemeralSettingReset:(g=e.isEphemeralSettingReset)!=null?g:!1,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE});case"GroupInvite":g=d("WAJids").interpretAsGroupJid(b.threadJid);if(g==null)throw c("err")("Group Invite without valid group jid");if(e.invitedParticipantUserJid==null)throw c("err")("Group Invite without invited user jid");return babelHelpers["extends"]({},b,{groupName:e.groupName==null?void 0:e.groupName,invitedParticipantUserJid:e.invitedParticipantUserJid,type:d("MAWMsgType").MSG_TYPE.GROUP_INVITE});case"SenderKeyDistribution":return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION});case"RavenAction":if(f==null)throw c("err")("Raven Action without Raven Message External Id");if(e.actionType==null)throw c("err")("Raven Action without Action Type");return babelHelpers["extends"]({},b,{actionType:e.actionType,ravenActionToMsgExternalId:d("WAStanzaUtils").toStanzaId(f),type:d("MAWMsgType").MSG_TYPE.RAVEN_ACTION});case"EditAction":throw c("err")("Edit action not implemented yet");default:throw c("WAAssertUnreachable")(a)}}function n(a){var b={author:d("MAWAuthor").getAuthorUserJid(a.author)||d("WAJids").AUTHOR_ME,externalId:a.externalId,mediaId:a.mediaId,msgId:a.msgId,plaintextHash:a.plaintextHash,specialTextSize:a.specialTextSize,ts:a.ts,xmaMessageType:a.xmaMessageType};switch(a.type){case d("MAWMsgType").MSG_TYPE.IMAGE:return babelHelpers["extends"]({},b,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.IMAGE});case d("MAWMsgType").MSG_TYPE.VIDEO:return babelHelpers["extends"]({},b,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.VIDEO});case d("MAWMsgType").MSG_TYPE.PTT:return babelHelpers["extends"]({},b,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.PTT});case d("MAWMsgType").MSG_TYPE.TEXT:return babelHelpers["extends"]({},b,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.TEXT});case d("MAWMsgType").MSG_TYPE.STICKER:return babelHelpers["extends"]({},b,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.STICKER});case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return babelHelpers["extends"]({},b,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE});case d("MAWMsgType").MSG_TYPE.GIF:return babelHelpers["extends"]({},b,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.GIF});case d("MAWMsgType").MSG_TYPE.XMA:return babelHelpers["extends"]({},b,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:a.xmaMessageType});case d("MAWMsgType").MSG_TYPE.REVOKED:return babelHelpers["extends"]({},b,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.UNAVAILABLE});case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:if(((b=a.quote)==null?void 0:b.content)==null){d("WALogger").ERROR(i());return null}return babelHelpers["extends"]({},a.quote.content,{author:d("MAWAuthor").getAuthorUserJid(a.quote.content.author)||d("WAJids").AUTHOR_ME});default:d("WALogger").ERROR(h(),a.type);throw c("err")("Trying to reply to a message type that does not support replies")}}function o(a,b,c,e){if(b===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE)return d("WAJids").switchOnMsgrChatJidType(c,{group:function(){return d("MAWDexieTable").dexieResolve()},user:function(b){return a.ephemeralSettings.get({userJid:b}).then(function(b){var c;if(b==null)return d("MAWDexieTable").dexieResolve();b.ephemeralSyncResponseBackoffInfo={syncResponseRetries:((c=(c=b.ephemeralSyncResponseBackoffInfo)==null?void 0:c.syncResponseRetries)!=null?c:0)+1,syncResponseSentTs:e};return a.ephemeralSettings.put(b)}).then(function(){})}});return b===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE?d("WAJids").switchOnMsgrChatJidType(c,{group:function(){return d("MAWDexieTable").dexieResolve()},user:function(b){return a.ephemeralSettings.get({userJid:b}).then(function(b){if(b==null||b.ephemeralSyncResponseBackoffInfo==null)return d("MAWDexieTable").dexieResolve();b.ephemeralSyncResponseBackoffInfo=void 0;return a.ephemeralSettings.put(b).then(function(){})})}}):d("MAWDexieTable").dexieResolve()}g.writeOutgoingMsg=b}),98);
__d("MediaDownloadMediator",["WALogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][labyrinth_dyi] MI download failure: ",""]);h=function(){return a};return a}var i=new Map();function a(a,b){i.set(a,b)}function c(a,b){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c;yield (c=i.get(a))==null?void 0:c["continue"](b);i["delete"](a)});return j.apply(this,arguments)}function e(a,b){d("WALogger").ERROR(h(),b.message);void ((b=i.get(a))==null?void 0:b.handleError());i["delete"](a)}g.mapDeliveryObjectIdToMediaDownloader=a;g.handleNewCDNUrlFromMI=c;g.handleMIDownloadFailure=e}),98);
__d("WAAPIMetrics",["WAGlobals","WAJids","WAPREList","WAPREMetrics"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){c===void 0&&(c={});return function(){var d=h(b,c);for(var e=arguments.length,f=new Array(e),g=0;g<e;g++)f[g]=arguments[g];return a.apply(void 0,[d].concat(f)).then(function(a){d.endSuccess();return a})["catch"](function(a){d.endFail("error",{string:{error:""+a.toString()}});throw a})}}function h(a,b){b===void 0&&(b={});var c=null;try{c=d("WAGlobals").getDependencies().isEmployee()&&d("WAGlobals").getDependencies().isUseridAnnotationEnabled()?d("WAJids").extractUserId(d("WAGlobals").getMyUserJid()).slice(-5):null}catch(a){}return d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.WA_JOB_MANAGER,babelHelpers["extends"]({},b,{string:babelHelpers["extends"]({},(b=(b=b)==null?void 0:b.string)!=null?b:{},{name:a,userHash:c})}))}g.withMetrics=a}),98);
__d("WAParseMessageTransport",["decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return{version:"v3",type:"error",error:a}}function i(a,b){return a!=null&&(b.dsm==null||b.dsm.destinationJid==null||b.dsm.destinationJid!==a)}function a(a,b){var c=a.payload;a=a.protocol;if(c==null&&a==null)return h("There is no payload and protocol in the message transport");else if(a==null)return h("There is no protocol part in the message transport");var e=a.integral;if(e==null)return h("There is no integral part in the message transport");else if(e.padding==null)return h("There is no padding in the message transport");else if(i(b,e))return h("The recipient does not match the device sent message recipient");else if(d("decodeProtobuf").getUnknownFields(e)!=null)return babelHelpers["extends"]({},h("There are unknown fields in the integral"),{futureProof:c==null?void 0:c.futureProof});if(c!=null){b=c.applicationPayload;return b==null?h("There is no applicationPayload payload in the message transport"):{type:"applicationPayload",applicationPayload:b,skdm:j(a.ancillary),icdc:k(a.ancillary)}}e=j(a.ancillary);return e!=null?{type:"skdm",skdm:e,icdc:k(a.ancillary)}:{type:"unknown"}}function j(a){return a==null?null:a.skdm}function k(a){return a==null?null:a.icdc}g.parseMessageTransport=a}),98);
__d("WADecodeIncomingMsg",["WALogger","WALongInt","WAMsgApplication.pb","WAMsgTransport.pb","WAParseMessageApplication","WAParseMessageTransport","WATimeUtils","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["decodeIncomingMsg called with unexpected encoding version: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["instamadillo decodeIncomingMsg called with null applicationPayload"]);i=function(){return a};return a}function j(a,b){return a.futureProof?{version:"v3",type:"futureProof",futureProof:a.futureProof,protobuf:b,subtype:null}:{version:"v3",type:"error",error:a.error}}function a(a,b,c,e){if(b==="v2")return{version:"v2",encoded:a};else if(b==="v3"){var f=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMsgTransport.pb").MessageTransportSpec,a);f=d("WAParseMessageTransport").parseMessageTransport(f,c);if(f.type==="error")return j(f,a);if(f.type==="skdm")return k(f.skdm,f.icdc);else if(f.type==="applicationPayload"){if(e===!0){if(f.applicationPayload.payload==null){d("WALogger").DEV(i());return{version:"v3",type:"error",error:"instamadillo unhandled proto"}}return{version:"v3",type:"instamadillo",applicationPayload:new Uint8Array(f.applicationPayload.payload)}}c=l(f.applicationPayload,a,f.icdc);if(f.skdm!=null){e=k(f.skdm,f.icdc);return{version:"v3",type:"msgWithSKDM",msg:c,skdm:e}}return c}else{f.type;return{version:"v3",type:"error",error:"unhandled proto"}}}else{d("WALogger").DEV(h(),b);return{type:"error",version:"v3",error:"decodeIncomingMsg called with unexpected encoding version: "+b}}}function k(a,b){var c=a.axolotlSenderKeyDistributionMessage;a=a.groupId;if(c==null)return{type:"error",version:"v3",error:"parseSKDM called with null axolotlSenderKeyDistributionMessage"};else if(a==null)return{type:"error",version:"v3",error:"parseSKDM called with null groupId"};return{version:"v3",type:"skdm",msg:{senderKey:c,groupId:a},icdc:b}}function l(a,b,c){var e=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMsgApplication.pb").MessageApplicationSpec,a.payload);if(e.payload==null)return m(e.metadata);var f=d("WAParseMessageApplication").parseMessageApplication(e);return f.type==="error"?j(f,b):{version:"v3",type:"subprotocol",metadata:(e=e.metadata)!=null?e:null,subprotocolType:f.subprotocolType,subprotocol:f.payload,protobuf:b,frankingContent:a.payload,icdc:c}}function m(a){a=a==null?void 0:a.chatEphemeralSetting;if(a!=null){var b=a.ephemeralExpiration,c=a.ephemeralSettingTimestamp;if(b==null)return{version:"v3",type:"error",error:"Ephemeral setting without expiration"};try{c=c!=null?d("WATimeUtils").castToUnixTime(d("WALongInt").numberOrThrowIfTooLarge(c)/1e3):d("WATimeUtils").DEFAULT_UNIXTIME;return{version:"v3",type:"ephemeral",ephemeralExpirationInSec:b,ephemeralLastUpdatedOrSetTimestamp:c,isEphemeralSettingReset:(c=a.isEphemeralSettingReset)!=null?c:!1}}catch(e){return{version:"v3",type:"ephemeral",ephemeralExpirationInSec:b,ephemeralLastUpdatedOrSetTimestamp:d("WATimeUtils").DEFAULT_UNIXTIME,isEphemeralSettingReset:(c=a.isEphemeralSettingReset)!=null?c:!1}}}else return{version:"v3",type:"error",error:"MessageApplication has no payload and is not ephemeral"}}g.decodeIncomingMsg=a}),98);
__d("WAParseV3Protocol",["WAAckLevel","WAAssertUnreachable","WAErr","WAGlobals","WAHex","WAMsgType","WAParseConsumerMessageProtocol"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return function(b,e,f,g,h,i){h={id:{chat:e,author:g,externalId:f},ts:h,serverTs:h,ack:d("WAAckLevel").ACK.RECEIVED,forwardingScore:b.type!=="futureProof"?(f=b==null?void 0:(g=b.metadata)==null?void 0:g.forwardingScore)!=null?f:0:0};g=b.type!=="futureProof"&&((g=b.metadata)==null?void 0:(f=g.chatEphemeralSetting)==null?void 0:f.ephemeralExpiration)!=null&&((g=b.metadata)==null?void 0:(f=g.chatEphemeralSetting)==null?void 0:f.ephemeralExpiration)>0;if(b.type==="futureProof"||g&&!d("WAGlobals").getConfig().isEphemeralMessagesEnabled())return{unstoredMsg:{type:d("WAMsgType").FUTUREPROOF,msgContent:{subtype:null,protobuf:d("WAHex").bytesToBuffer(b.protobuf)},id:h.id,ts:h.ts,sentTs:h.sentTs,serverTs:h.serverTs,ack:h.ack,reportingMeta:h.reportingMeta},unstoredMedia:null,unstoredQuotedMedia:null};else if(b.type==="subprotocol"){f=a==null?void 0:a.get(b.subprotocolType);if(f!=null)return f(e,b.subprotocol,h,b.protobuf,b.metadata);switch(b.subprotocolType){case"consumerMessage":return d("WAParseConsumerMessageProtocol").parseConsumerMessageProtocol(e,b.subprotocol,h,b.protobuf,b.metadata,i);case"businessMessage":throw c("WAErr")("unsupported subprotocolType: "+b.subprotocolType);case"paymentMessage":throw c("WAErr")("unsupported subprotocolType: "+b.subprotocolType);case"multiDevice":throw c("WAErr")("unsupported subprotocolType: "+b.subprotocolType);case"voip":throw c("WAErr")("unsupported subprotocolType: "+b.subprotocolType);default:throw c("WAErr")("Subprotocol parser for: "+b.subprotocolType+" was not found")}}else return c("WAAssertUnreachable")(b.type)}}g.createV3ProtocolParser=a}),98);/*FB_PKG_DELIM*/
__d("LSQueryBulkUtils",["ReQL"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,b){b=await Promise.all(b.map(function(b){return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a).getKeyRange(b))}));return b.flat()}async function b(a,b){await Promise.all(b.map(function(b){return a.put(b)}));return b}g.bulkGetByIndex=a;g.bulkPut=b}),98);
__d("MAWUnsafeCoerce",[],(function(a,b,c,d,e,f){"use strict";function a(a){return a}f.unsafeCoerce=a}),66);
__d("MAWBulkEditMsgsTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbEditMsgHistory","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWThreadSnippetForTextMsg","MAWUnsafeCoerce","WAGlobals","WAJids","WAMsgMap","WAMsgType","err"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,e){var f=[];for(var g=0;g<a.length;g++){var h=a[g],i=d("MAWJidUtils").maybeToProtocolMsgId(h.author,h.threadJid,h.originalMsgExternalId);if(i!=null){i=(i=e.get(i))==null?void 0:i.msgId;i!=null?f.push(babelHelpers["extends"]({},h,{editMsgHistoryId:d("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(b[g]),originalMsgId:i})):c("FBLogger")("messenger_e2ee_web").warn("[edit messagehistory] Failed to get the original msgId for a msg that has been edited.")}}d("MAWIndexedDb").afterTransaction({tag:"EditMsgHistoryAdded",value:f})}function a(a,b){var c=new Set(),e=[];b.forEach(function(a){var b=a.chatJid;a=a.msg;c.add(b);e.push(a.originalMsgExternalId)});return d("MAWDexieTable").dexieAll([a.messages.where("externalId").anyOf(e).toArray(),a.messages.where("quoteExternalId").anyOf(e).toArray(),a.editMsgHistory.where("originalMsgExternalId").anyOf(e).toArray(),a.threads.where("jid").anyOf(Array.from(c)).toArray()]).then(function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return{editMsgHistory:d,originalMsgs:b,quoteMessages:c,threads:a}})}function i(a,b,e){var f=new Map();b.values().forEach(function(a){var b;b=(b=a.threadJid)!=null?b:d("WAJids").unsafeCoerceToChatJid("");if(f.has(b)){var c;(c=f.get(b))==null?void 0:c.push(a)}else f.set(b,[a])});b=e.map(function(b){return d("MAWDbMsgTxns").getThreadNewestMessageId(a,b,"defer_to_qe").then(function(a){return{editedMsgsInThread:f.get(b.jid),newestMsgId:a,thread:b}})});return d("MAWDexieTable").dexieAll(b).then(function(a){a.forEach(function(a){var b=a.editedMsgsInThread,e=a.newestMsgId;a=a.thread;if(a==null||b==null)return;b=b.filter(function(a){return a.msgId===e})[0];if(b!=null){var f=b.author;if(f==="@system")throw c("err")("[edit message] author should not be @system.");f=d("WAJids").userIdFromJid(f==="@me"?d("WAGlobals").getMyUserJid():f);b=c("MAWThreadSnippetForTextMsg")(b,f,d("WAJids").interpretAsGroupJid(a.jid)!=null);var g=b.snippetParams;b=b.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:g,snippetSenderContactId:f,snippetType:b,threadJid:a.jid})})}})})}function b(a,b,e){var f=e.editMsgHistory,g=e.originalMsgs,j=e.quoteMessages,l=e.threads,m=g.reduce(function(a,b){var c=d("MAWJidUtils").toProtocolMsgId(b);return c==null?a:a.set(c,b)},new(d("WAMsgMap").MsgMap)());e=f.reduce(function(a,b){var c=d("MAWJidUtils").toProtocolMsgId(b);return c==null?a:a.set(c,b)},new(d("WAMsgMap").MsgMap)());g=k(b,{messageHistoriesToEdit:e,messagesToEdit:m});var n=g[0],o=g[1],p=g[2];return d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,n,!1).then(function(b){h(n,b,m);var e=new(d("WAMsgMap").MsgMap)();o.entries().forEach(function(a){var b=a[0];a=a[1];var f=m.get(b);if(f==null){c("FBLogger")("messenger_e2ee_web").warn("Cannot find the original msg for the edit action.");return}if(f.type!==d("WAMsgType").MSG_TYPE.TEXT&&f.type!==d("WAMsgType").MSG_TYPE.CIPHERTEXT)throw c("err")("Only text or cipher text can be edited. Original msg type: %s",f.type);f=babelHelpers["extends"]({},f,{editCount:((f=f.editCount)!=null?f:0)+((f=p.get(b))!=null?f:0),msgContent:a.editMsgContent,type:d("WAMsgType").MSG_TYPE.TEXT});e.set(b,f)});return i(a,e,l).then(function(){var b=j.map(function(a){var b=a.quote,f=a.quoteExternalId,g=a.threadJid;if(b==null){c("FBLogger")("messenger_e2ee_web").warn("[edit message] Failed to get the quoted content for a msg that has been quoted.",a.externalId);return}g=d("MAWJidUtils").maybeToProtocolMsgId(b.content.author,g,f);if(g==null)return;f=e.get(g);if(f==null)return;return babelHelpers["extends"]({},a,{quote:babelHelpers["extends"]({},b,{content:babelHelpers["extends"]({},b.content,{msgContent:babelHelpers["extends"]({},f.msgContent)})})})}).filter(Boolean);return a.messages.bulkPut(e.values().concat(b)).then(function(){e.values().forEach(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,void 0,a)})})})}).then(function(){b.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a)})})})})})}function j(a,b){var e;switch(a.type){case d("WAMsgType").MSG_TYPE.TEXT:case d("WAMsgType").MSG_TYPE.EDIT_ACTION:return{author:a.author,editExternalId:a.externalId,editTs:(e=a.serverTs)!=null?e:a.ts,msgContent:(e=a.editMsgContent)!=null?e:d("MAWUnsafeCoerce").unsafeCoerce(a.msgContent),originalMsgExternalId:(e=a.originalMsgExternalId)!=null?e:a.externalId,sendStatus:d("MAWAckLevel").ACK.sent,specialTextSize:a.specialTextSize,threadJid:b};case d("WAMsgType").MSG_TYPE.CIPHERTEXT:return{author:a.author,editExternalId:a.externalId,editTs:(e=a.serverTs)!=null?e:a.ts,msgContent:{content:""},originalMsgExternalId:a.externalId,sendStatus:d("MAWAckLevel").ACK.sent,specialTextSize:a.specialTextSize,threadJid:b};default:a.type;throw c("err")("MAWBulkEditMsgsTxns::getMessageHistory: Unexpected msg type")}}function k(a,b){var e=b.messageHistoriesToEdit,f=b.messagesToEdit,g=[],h=new(d("WAMsgMap").MsgMap)(),i=new(d("WAMsgMap").MsgMap)();a.forEach(function(a){var b=a.chatJid;a=a.msg;var k=d("MAWJidUtils").maybeToProtocolMsgId(a.author,b,a.originalMsgExternalId);if(k==null)throw c("err")("[protocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",d("WAJids").isAuthorSystem(a.author),!!b,!!a.originalMsgExternalId);var l=d("MAWJidUtils").maybeToProtocolMsgId(a.author,b,a.externalId);if(l==null)throw c("err")("[editMsgProtocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",d("WAJids").isAuthorSystem(a.author),!!b,!!a.externalId);if(e.get(l)==null){g.push(j(a,b));l=(l=i.get(k))!=null?l:0;var m=f.get(k);i.set(k,l+1);if(e.get(k)==null&&l===0&&m!=null){if(m.type!==d("WAMsgType").MSG_TYPE.TEXT&&m.type!==d("WAMsgType").MSG_TYPE.CIPHERTEXT)throw c("err")("Only text or cipher text can be edited. Original msg type: %s",m.type);g.push(j(m,b))}}l=h.get(k);m=l==null?void 0:l.serverTs;b=a==null?void 0:a.serverTs;(m==null||b==null||m<b)&&h.set(k,a)});return[g,h,i]}g.prepareDataForMessageEdit=a;g.bulkEditMsgs=b;g.getMessageHistory=j}),98);
__d("MAWHIMLogger",["WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";a=d("WATagsLogger").TAGS(["HandleIncomingMessage"]);g["default"]=a}),98);
__d("MAWDbRavenActionTxns",["MAWBridgeTypesCreators","MAWDbMsg","MAWIndexedDb","MAWMsg","MAWRavenUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e){return a.messages.where("externalId").equals(b.ravenActionToMsgExternalId).filter(function(a){return a.threadJid===e.jid}).first().then(function(f){var g=f==null?void 0:f.msgId;if(g==null)throw c("err")("Cannot Write Raven Action without ID of Raven Message");return h(a,f).then(function(c){var d=babelHelpers["extends"]({msgId:g,threadJid:e.jid},b);return a.unrenderedMessages.add(d).then(function(a){return babelHelpers["extends"]({rowId:a},d)})}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"RavenActionUpdate",value:d("MAWBridgeTypesCreators").createBridgeRavenAction(a)});return})})}function h(a,b){if((b==null?void 0:b.type)!=="Raven")throw c("err")("Cannot Modify Message because Message is not Raven Message");var e=[d("MAWMsg").MAWRavenMsgEphemeralMediaState.cast(Number(b.ravenEphemeralMediaState)),d("MAWMsg").MAWRavenMsgEphemeralType.cast(Number(b.ravenEphemeralType))],f=e[0];e=e[1];if(f==null||e==null)throw c("err")("ravenEphemeralMediaStateEnum or ravenEphemeralTypeEnum is null");f=d("MAWRavenUtils").getNextRavenMessageEphemeralState(f,e);return a.messages.put(babelHelpers["extends"]({},b,{ravenEphemeralMediaState:f}))}function b(a,b,c){c=d("MAWDbMsg").isRavenActionMsgType(c)&&(b==null?void 0:b.externalId)!=null?[b.externalId]:[];return a.messages.where("externalId").anyOf(c).filter(function(a){return a.author===(b==null?void 0:b.author)&&a.threadJid===(b==null?void 0:b.chat)}).first()}g.writeRavenActionMsg=a;g.modifyRavenMsgWithActionMsg=h;g.maybeGetRavenMsgQueryByProtocolMsgId=b}),98);
__d("MAWEphemeralUtils",["MAWLocalizationType","WAArmadilloApplication.pb","WAGlobals","WAJids","err"],(function(a,b,c,d,e,f,g){"use strict";var h=60,i=60*h,j=24*i;function a(a,b,c,e){var f=[],g=b===j,k=a===d("WAGlobals").getMyUserJid();if(e)e=d("MAWLocalizationType").LOCALIZATION_TYPE.EPHEMERAL_SETTINGS_AUTO_RESET;else if(!k||a==null)b===0?e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_OFF:b<h?(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_ON_SECONDS:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_CHANGE_SECONDS,f.push(b.toString())):b<i?(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_ON_MINUTES:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_CHANGE_MINUTES,f.push((b/h).toString())):b<j||g?(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_ON_HOURS:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_CHANGE_HOURS,f.push((b/i).toString())):(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_ON_DAYS:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_CHANGE_DAYS,f.push((b/j).toString()));else{a=d("WAJids").extractUserId(a).toString();b===0?k?e=d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_OFF:(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_OFF,f.push(a)):b<h?(k?e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_ON_SECONDS:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_SECONDS:(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_SECONDS:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_SECONDS,f.push(a)),f.push(b.toString())):b<i?(k?e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_ON_MINUTES:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_MINUTES:(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_MINUTES:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_MINUTES,f.push(a)),f.push((b/h).toString())):b<j||g?(k?e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_ON_HOURS:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_HOURS:(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_HOURS:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_HOURS,f.push(a)),f.push((b/i).toString())):(k?e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_ON_DAYS:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_DAYS:(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_DAYS:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_DAYS,f.push(a)),f.push((b/j).toString()))}return{ephemeralSettingChangeContent:f,ephemeralSettingChangeType:e}}function b(a,b,e){var f,g=[];b=d("WAJids").extractUserId(b).toString();switch(a){case d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE:e?f=d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_TAKE_SCREENSHOT:(f=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_TAKE_SCREENSHOT,g.push(b));break;case d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING:e?f=d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_RECORD_SCREEN:(f=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_RECORD_SCREEN,g.push(b));break;default:throw c("err")("Received unexpected screenshot action type")}return{ephemeralScreenshotActionContent:g,ephemeralScreenshotActionType:f}}g.getEphemeralSettingChangeData=a;g.getEphemeralScreenshotActionData=b}),98);
__d("MAWEphemeralAdminMsgBuildTxns",["MAWAckLevel","MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDexieTable","MAWEphemeralUtils","MAWExternalId","MAWIndexedDb","MAWMsgType","MAWThreadSnippetBuildTxns","MAWWriteMsgTxns","WAGlobals","WAJids","WATimeUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g,h,i,j){if(e<0)throw c("err")("Received unexpected ephemeral time setting");e=d("MAWEphemeralUtils").getEphemeralSettingChangeData(b,e,h,i);h=e.ephemeralSettingChangeContent;i=e.ephemeralSettingChangeType;var k={ack:d("MAWAckLevel").ACK.sent,altIndex:void 0,author:(e=b)!=null?e:d("WAJids").AUTHOR_SYSTEM,msgContent:{adminMsgContent:h,adminType:i,version:1},type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN};e=j!=null&&b!=null?d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,j,g.jid,b):d("MAWDexieTable").dexieResolve();return e.then(function(b){if(b==null){var c,e=babelHelpers["extends"]({},k,{externalId:(c=j)!=null?c:d("MAWExternalId").generateExternalId(),sortOrderMs:d("WATimeUtils").castUnixTimeToMillisTime(f),threadJid:g.jid,ts:f});return d("MAWWriteMsgTxns").writeDedupedEphemeralSettingAdminMessage(a,e,g,d("WATimeUtils").castUnixTimeToMillisTime(f)).then(function(a){return babelHelpers["extends"]({},e,{msgId:a.msgId,rowId:a.rowId})})}else if(b.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT){var h=babelHelpers["extends"]({},b,k);return a.messages.put(h).then(function(){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.threadJid,[b])});d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(h)});return d("MAWDbMsgTxns").getThreadNewestMessageId(a,g).then(function(b){return h.msgId===b?d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,h).then(function(a){var b=a.snippetParams,c=a.snippetSenderContactId;a=a.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:b,snippetSenderContactId:c,snippetType:a,threadJid:g.jid})});return h}):h})})}else return null})}function b(a,b,c,e,f,g,h){var i=b===d("WAGlobals").getMyUserJid(),j=d("MAWEphemeralUtils").getEphemeralScreenshotActionData(f,b,i),k=j.ephemeralScreenshotActionContent;j=j.ephemeralScreenshotActionType;if(h==null){var l={ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:i?d("WAJids").AUTHOR_ME:b,externalId:g,msgContent:{adminMsgContent:k,adminType:j,screenshotActionType:f,version:1},sortOrderMs:d("WATimeUtils").castUnixTimeToMillisTime(e),threadJid:c.jid,ts:e,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION};return d("MAWWriteMsgTxns").writeDedupedEphemeralSettingAdminMessage(a,l,c,d("WATimeUtils").castUnixTimeToMillisTime(e)).then(function(a){return babelHelpers["extends"]({},l,{msgId:a.msgId,rowId:a.rowId})})}else if(h.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT){var m=babelHelpers["extends"]({},h,{ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:i?d("WAJids").AUTHOR_ME:b,msgContent:{adminMsgContent:k,adminType:j,screenshotActionType:f,version:1},type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION});return a.messages.put(m).then(function(){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(h.threadJid,[h])});d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(m)});return d("MAWDbMsgTxns").getThreadNewestMessageId(a,c).then(function(b){return m.msgId===b?d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,m).then(function(a){var b=a.snippetParams,e=a.snippetSenderContactId;a=a.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:b,snippetSenderContactId:e,snippetType:a,threadJid:c.jid})});return m}):m})})}else return d("MAWDexieTable").dexieResolve(null)}g.writeEphemeralSettingAdminMsg=a;g.writeEphemeralScreenshotActionMsg=b}),98);
__d("MAWMsgActionType",[],(function(a,b,c,d,e,f){"use strict";a={DELETE_FOR_ME:"DELETE_FOR_ME",NO_ACTION:"NO_ACTION",REVOKE:"REVOKE",UPDATE_CIPHERTEXT:"UPDATE_CIPHERTEXT",UPDATE_CIPHERTEXT_WITH_ASSOCIATED:"UPDATE_CIPHERTEXT_WITH_ASSOCIATED",WRITE:"WRITE",WRITE_WITH_ASSOCIATED:"WRITE_WITH_ASSOCIATED"};f.MSG_ACTION=a}),66);
__d("MAWDbReceiptTxns",["MAWDexieTable","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpectedly fetched null data from a msgIdToReceiptData map"]);h=function(){return a};return a}function a(a,b,c){return i([{deliveryReceipts:b==="delivered"?c:[],msgId:a,readReceipts:b==="read"?c:[],senderReceipts:b==="sender"?c:[]}]).then(function(a){return a[0]||{type:"missing"}})}function i(a){var b=a.map(function(a){return a.msgId}),c=new Map();a.forEach(function(a){c.set(a.msgId,a)});a=b.map(function(a){var b=c.get(a);if(b==null){d("WALogger").ERROR(h());return null}var e=new Set(),f=new Map(),g=b.deliveryReceipts,i=b.readReceipts;b=b.senderReceipts;[{receiptType:"delivered",receivers:g},{receiptType:"read",receivers:i},{receiptType:"sender",receivers:b}].forEach(function(a){var b=a.receiptType;a=a.receivers;a.forEach(function(a){var c=a.device;a=a.ts;c=d("WAJids").extractUserJid(c);var g=!1;if(b!=="sender"){var h=f.get(c);a=j(h,b,a);f.set(c,a);g=k(h,a)}g&&e.add(c)})});return{affectedUserJids:e,receipt:{msgId:a,statusTsPerUser:f}}}).filter(Boolean);return d("MAWDexieTable").dexieResolve(a.map(function(a){return{affectedUserJids:a.affectedUserJids,receipt:a.receipt}}))}function j(a,b,c){var d;d=(d=a==null?void 0:a.deliveredTs)!=null?d:c;a=a==null?void 0:a.readTs;b==="read"&&a==null&&(a=c);return{deliveredTs:d,readTs:a}}function k(a,b){return((b==null?void 0:b.deliveredTs)||0)>((a==null?void 0:a.deliveredTs)||0)||((b==null?void 0:b.readTs)||0)>((a==null?void 0:a.readTs)||0)}function b(a,b){return a.receipts.bulkDelete(b)}g.writeReceiptsForDevices=a;g.bulkWriteReceiptsForDevices=i;g.bulkDeleteAllReceiptsForMessages=b}),98);
__d("MAWMessageRequestUtils",["MAWFolderTypes","WADbContact"],(function(a,b,c,d,e,f,g){"use strict";function a(a){a=a===d("MAWFolderTypes").FOLDER_ID.PENDING||a===d("MAWFolderTypes").FOLDER_ID.OTHER;return a}function b(a,b){return(a===null||a===d("MAWFolderTypes").FOLDER_ID.INBOX)&&(b===d("WADbContact").REVERSED_ONE_WAY_CONTACT||b===d("WADbContact").NON_CONTACT)}g.isMessageRequestOrSpamThread=a;g.isInboxRequest=b}),98);
__d("MAWMarkThreadAsReadTxns",["FBLogger","MAWBridgeThread","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWMessageRequestUtils","MAWTimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,d,e,f){f===void 0&&(f=!1);var g=new Map();g.set(b,{msgId:d,sortOrderMs:e});return h(a,g,f).then(function(a){a=a.get(b);if(a==null)throw c("FBLogger")("messenger_web_devx","maw_mark_thread_as_read").warn("ThreadReadReceiptInfo unexpectedly unavailable for thread\n         in markThreadAsReadUpToMsgSortOrderMs()");return a})}function h(a,b,c){c===void 0&&(c=!1);return j(a,b).then(function(e){var f=e.threadJidToReadReceiptInfo,g=e.updatedThreads;return a.threads.bulkPut(g).then(function(){g.forEach(function(a){var e;e=(e=b.get(a.jid))==null?void 0:e.sortOrderMs;e!=null&&!c&&d("MAWIndexedDb").afterTransaction({tag:"ThreadTimestampsUpdated",value:d("MAWBridgeThread").createBridgeThreadTimestampsUpdated(a.jid,e,e,!1)});f.set(a.jid,{isReadReceiptExpectedToBeSent:(a=(e=f.get(a.jid))==null?void 0:e.isReadReceiptExpectedToBeSent)!=null?a:!1,type:"success"})});return f})})}function i(a,b,c){return d("MAWDbMsgTxns").getThreadOldestMessageId(a,b.jid).then(function(a){if(a==null)return null;a=d("MAWTimeUtils").ensureValidMillisTime(b.newestMsgTs);return babelHelpers["extends"]({},b,{lastReadMsg:c.msgId,newestMsgTs:a})})}function j(a,b){var e=new Map(),f=Array.from(b.keys()),g=[];return a.threads.where("jid").anyOf(f).toArray().then(function(h){var j=new Map();h.forEach(function(a){return j.set(a.jid,a)});f.forEach(function(a){j.has(a)||j.set(a,null)});h=Array.from(j).map(function(d){var f=d[0];d=d[1];if(d==null){e.set(f,{isReadReceiptExpectedToBeSent:!1,type:"missing"});return}f=k(d.folder);e.set(d.jid,{isReadReceiptExpectedToBeSent:f,type:"success"});f=b.get(d.jid);if(f==null)throw c("FBLogger")("maw_threads","maw_mark_thread_as_read").warn("ThreadReadReceiptInfo unexpectedly unavailable for thread\n            in getThreadJidToReadReceiptInfo()");return i(a,d,f).then(function(a){a!=null&&g.push(a)})});return d("MAWDexieTable").dexieAll(h).then(function(){return{threadJidToReadReceiptInfo:e,updatedThreads:g}})})}function k(a){return!d("MAWMessageRequestUtils").isMessageRequestOrSpamThread(a)}g.markThreadAsReadUpToMsgSortOrderMs=a;g.bulkMarkThreadAsReadUpToMsgSortOrderMs=h;g.isReadReceiptExpectedToBeSentFor=k}),98);
__d("MAWPendingReceiptProcessingTxns",["MAWDbMsg","MAWDbParticipantTxns","MAWDbReceiptTxns","MAWDexieTable","MAWMarkThreadAsReadTxns","WAJids","WALogger","WAMsg","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processing pending receipts for "," from ",""]);h=function(){return a};return a}function a(a,b,c){var e=d("WAMsg").craftWAMsgIdString({author:c.author,chat:b,externalId:c.externalId});return a.pendingReceipts.get(e).then(function(b){if(b==null)return;d("WALogger").LOG(h(),c.externalId,c.author);if(b.author===d("WAJids").AUTHOR_ME){var f=d("MAWDexieTable").dexieResolve();b.deliveryReceipts.length>0&&(f=f.then(function(){return d("MAWDbReceiptTxns").writeReceiptsForDevices(c.msgId,"delivered",b.deliveryReceipts)}));b.readReceipts.length>0&&(f=f.then(function(){return d("MAWDbReceiptTxns").writeReceiptsForDevices(c.msgId,"read",b.readReceipts)}));return f.then(function(b){var f=[];b!=null&&b.type!=="missing"&&b.receipt.statusTsPerUser.forEach(function(b,e){var g=b.deliveredTs!=null?c.ts:d("WATimeUtils").castToUnixTime(0),h=b.readTs!=null?c.ts:d("WATimeUtils").castToUnixTime(0);b=(b=b.readTs)!=null?b:d("WATimeUtils").castToUnixTime(0);f.push(d("MAWDbParticipantTxns").updateParticipantTimestamps(a,[c.threadJid,e],g,h,b))});return d("MAWDexieTable").dexieAll(f).then(function(){a.pendingReceipts["delete"](e)})})}else return d("MAWDexieTable").dexieAll([d("MAWMarkThreadAsReadTxns").markThreadAsReadUpToMsgSortOrderMs(a,c.threadJid,c.msgId,d("WATimeUtils").castToMillisTime(d("MAWDbMsg").getSortOrderWithFallback(c)))]).then(function(){return a.pendingReceipts["delete"](e)})})}g.processPendingReceipts=a}),98);
__d("MAWWriteEditTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWBridgeTypesCreators","MAWBulkEditMsgsTxns","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWThreadSnippetForTextMsg","MAWUnsafeCoerce","MAWWriteMsgTxns","WAGlobals","WAJids","WAMsgType","WAResultOrError","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var e=b.args,f=b.externalId,g=e.editMsgContent;e=e.originalProtocolMsgId;var i=e.chat,j=e.externalId;return d("MAWDexieTable").dexieAll([a.threads.get({jid:i}),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,e)]).then(function(e){var k=e[0],l=e[1];if(k==null)return d("WAResultOrError").makeError("missing_thread");if(l==null)return d("WAResultOrError").makeError("missing_msg");if(l.type!==d("WAMsgType").MSG_TYPE.TEXT)throw c("err")("Only text or cipher text can be edited. Original msg type: %s",l.type);return d("MAWDexieTable").dexieAll([a.messages.where("quoteExternalId").equals(j).filter(function(a){return((a=a.quote)==null?void 0:a.content.type)!==d("WAMsgType").NOTE_REPLY}).toArray(),a.editMsgHistory.where("originalMsgExternalId").equals(j).toArray(),d("MAWDbMsgTxns").getThreadNewestMessageId(a,k)]).then(function(e){var m=e[0],n=e[1],o=e[2];e=n.find(function(a){return a.author===d("WAJids").AUTHOR_ME&&a.threadJid===i&&a.editExternalId===f});if((e==null?void 0:e.sendStatus)!=null&&e.sendStatus>d("MAWAckLevel").ACK.clock)return d("WAResultOrError").makeError("already_sent");e=[];e.push(h(b,i,j));n=n.find(function(a){return a.author===d("WAJids").AUTHOR_ME&&a.threadJid===i&&a.editExternalId===j});n==null&&(l.editCount==null||l.editCount===0)&&e.push(h(l,i,j));return d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,e,!1).then(function(){var b,e=babelHelpers["extends"]({},l,{ack:d("MAWAckLevel").ACK.clock,editCount:((b=l.editCount)!=null?b:0)+1,msgContent:g});if(o!=null&&o===e.msgId){b=d("WAJids").userIdFromJid(d("WAGlobals").getMyUserJid());var h=c("MAWThreadSnippetForTextMsg")(e,b,d("WAJids").interpretAsGroupJid(k.jid)!=null),n=h.snippetParams;h=h.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:n,snippetSenderContactId:b,snippetType:h,threadJid:k.jid})})}var p=[],q=d("WAGlobals").getMyUserJid();n=m.find(function(a){var b;return(((b=a.quote)==null?void 0:b.content.author)===d("WAJids").AUTHOR_ME||((b=a.quote)==null?void 0:b.content.author)===q)&&a.threadJid===i});if(n!=null){b=n.quote;h=n.quoteExternalId;if(b==null)c("FBLogger")("messenger_e2ee_web").warn("[edit message] Failed to get the quoted content for a msg that has been quoted.",h);else{h=babelHelpers["extends"]({},n,{quote:babelHelpers["extends"]({},b,{content:babelHelpers["extends"]({},b.content,{msgContent:babelHelpers["extends"]({},e.msgContent)})})});p.push(h)}}return a.messages.bulkPut([e].concat(p)).then(function(){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,l)}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(e,void 0,a)})}).then(function(){p.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a)})});return d("WAResultOrError").makeResult({originalMsgExternalId:j,originalMsgId:l.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:i,externalId:f}})})})})})}function h(a,b,c){var e;return{author:d("WAJids").AUTHOR_ME,editExternalId:a.externalId,editTs:(e=a.serverTs)!=null?e:a.ts,msgContent:(e=(e=a.args)==null?void 0:e.editMsgContent)!=null?e:d("MAWUnsafeCoerce").unsafeCoerce(a.msgContent),originalMsgExternalId:c,sendStatus:d("MAWAckLevel").ACK.clock,specialTextSize:a.specialTextSize,threadJid:b}}function b(a,b,c,e){if(b.type!==d("WAMsgType").MSG_TYPE.TEXT||!e||e.length===0)return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b,c);var f=e.sort(function(a,b){return b.editTs-a.editTs})[0].msgContent;e=e.length;return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,babelHelpers["extends"]({},b,{editCount:e,msgContent:f}),c).then(function(c){return(c.type===d("WAMsgType").MSG_TYPE.TEXT?d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,[d("MAWBulkEditMsgsTxns").getMessageHistory(babelHelpers["extends"]({},c,{msgContent:b.msgContent}),c.threadJid)]):d("MAWDexieTable").dexieResolve()).then(function(){return c})})}g.writeEdit=a;g.writeNewIncomingMsgAndEditHistory=b}),98);
__d("MAWDbGroupInviteTxns",["MAWDexieTable","MAWMsgType"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return a.groupInvites.put(b).then(function(){return b})}function b(a,b,c){return a.groupInvites.where(["threadJid","inviteeJid"]).anyOf([[b,c]])["delete"]()}function h(a,b,c){return a.groupInvites.where(["threadJid","inviteeJid"]).equals([b,c]).first()}function c(a,b,c){return a.groupInvites.where(["threadJid","inviteeJid"]).anyOf([[b,c]]).toArray()}function e(a,b){return b.type===d("MAWMsgType").MSG_TYPE.GROUP_INVITE?b.invitedParticipantUserJid==null?d("MAWDexieTable").dexieResolve():h(a,b.threadJid,b.invitedParticipantUserJid):d("MAWDexieTable").dexieResolve()}g.putGroupInvite=a;g.deleteGroupInvitesByThreadAndInvitedParticipant=b;g.maybeGetGroupInvite=h;g.getGroupInvitesByThreadAndInvitedParticipant=c;g.getAndCheckGroupInviteFromMsg=e}),98);
__d("MAWGroupInviteManagementTxns",["MAWDbGroupInviteTxns","MAWDbParticipantTxns","MAWDexieTable","WAGlobals"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=!1;return d("MAWDbParticipantTxns").getInvitedParticipantsInThread(a,b).then(function(e){if(e.length===0){c=!0;var f=d("WAGlobals").getMyUserJid();return d("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(a,b,f).then(function(){return c})}else{var g=[];e.forEach(function(c){g.push(d("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(a,b,c.userJid))});return d("MAWDexieTable").dexieAll(g).then(function(){return c})}})}g.deleteGroupInvitesByThread=a}),98);
__d("MAWLoadMessageRequestCapabilitiesTxns",["MAWDexieTable","MAWIndexedDb","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a){for(var b=0;b<a.length;b++){var c=a[b],e=d("WAJids").interpretAsUserJid(c.jid);if(e==null)continue;d("MAWIndexedDb").afterTransaction({tag:"OneToOneMessageRequestLoaded",value:{fbid:d("WAJids").extractUserId(e),threadJid:c.jid}})}return d("MAWDexieTable").dexieResolve()}g.loadMessageRequestDataForThreads=a}),98);
__d("MAWThreadManagementTxns",["MAWBridgeEventTransmitter","MAWBridgeParticipants","MAWBridgeTypesCreators","MAWDbGroupInfoTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbParticipantTxns","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDexieTable","MAWGetOrCreateThreadTxns","MAWGroupInviteManagementTxns","MAWIndexedDb","MAWLoadMessageRequestCapabilitiesTxns","WAGlobals","WAJids","WALogger","WAMsgType","WASortedLists","WATimeUtils","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted "," media rows and "," chunk rows"]);h=function(){return a};return a}function a(a,b){var c=b.authoritativeThreadKey,e=b.createTs,f=b.folder,g=b.lastActivityTimestamp,h=b.lastReadWatermarkTimestamp,i=b.offlineThreadingId,j=b.userJid;return d("MAWGetOrCreateThreadTxns").getOrCreateThread(a,{authoritativeThreadKey:c,clientThreadKey:i,createTs:e,description:"getOrSetupOneToOneThread",folder:f,jid:j,lastActivityTimestamp:g,lastReadWatermarkTimestamp:h}).then(function(b){var c=b.created;b=b.thread;return m(a,j,c,b)})}function b(a,b){return d("MAWGetOrCreateThreadTxns").bulkGetOrCreateThread(a,b.map(function(a){var b=a.authoritativeThreadKey,c=a.createTs,d=a.folder,e=a.lastActivityTimestamp,f=a.lastReadWatermarkTimestamp,g=a.offlineThreadingId;a=a.userJid;return{authoritativeThreadKey:b,clientThreadKey:g,createTs:c,description:"getOrSetupOneToOneThread",folder:d,jid:a,lastActivityTimestamp:e,lastReadWatermarkTimestamp:f}})).then(function(c){return d("MAWDexieTable").dexieAll(c.map(function(c,d){var e=c.created;c=c.thread;return m(a,b[d].userJid,e,c)}))})}function e(a,b,c,e){return d("MAWDbGroupInfoTxns").getGroupInfo(a,b).then(function(b){if(!b.success)return null;var f=b.value;return d("MAWGetOrCreateThreadTxns").getOrCreateThread(a,{createTs:d("WATimeUtils").castUnixTimeToMillisTime(f.creationTs),description:"getOrRepairGroupThread",folder:c,jid:f.groupJid,skipVerifyThread:e}).then(function(a){var b=a.created;a=a.thread;return{created:b,groupInfo:f,thread:a}})})}function i(a,b){var c=[],e=[];b.forEach(function(a){d("MAWDbMsg").isMediaMsg(a)&&a.mediaId!=null&&(c.push(a.mediaId),e.push(a.msgId))});return a.media.bulkGet(c).then(function(b){var c=[],f=[];b.forEach(function(a,b){if(a!=null){var g=e[b];a.msgIds=d("WASortedLists").filter(a.msgIds,function(a){return a!==g});a.mediaEntries["delete"](g);a.msgIds.length===0&&a.mediaEntries.size===0&&(a.plaintextHash!=null&&c.push(a.hashedPlaintextHash),f.push(a.mediaId))}});b=a.media.bulkDelete(f);var g=a.chunk.where("hashedPlaintextHash").anyOf(c)["delete"]();return d("MAWDexieTable").dexieAll([b,g]).then(function(){d("WALogger").LOG(h(),f.length,c.length)})})}function j(a,b){return d("MAWDbMsgTxns").getThreadNewestMessageTs(a,b).then(function(c){return a.messages.where("threadJid").equals(b.jid).toArray().then(function(d){return k(a,b,c,d,!0)})})}function f(a,b,c,e){var f=c==null?void 0:c.lastMessageTimestamp;if(c==null)return j(a,b);var g=a.messages.where("threadJid").equals(b.jid).toArray(),h=d("MAWDbMsgTxns").getThreadNewestMessageTs(a,b);return d("MAWDexieTable").dexieAll([g,h]).then(function(g){var h=g[0];g=g[1];var i=[],j=new Set();f!=null&&h.forEach(function(a){a.ts<=f+1&&(j.add(a.msgId),i.push(a))});if((c==null?void 0:c.messages.length)!==0){var l=new Set();c.messages.forEach(function(a){l.add((a=a.key)==null?void 0:a.id)});h.forEach(function(a){l.has(a.externalId)&&!j.has(a.msgId)&&(j.add(a.msgId),i.push(a))})}if(i.length!==h.length)for(var m=h,n=Array.isArray(m),o=0,m=n?m:m[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var p;if(n){if(o>=m.length)break;p=m[o++]}else{o=m.next();if(o.done)break;p=o.value}p=p;if(!j.has(p.msgId)&&p.type!==d("WAMsgType").ADMIN)return k(a,b,g,i,!1,e)}return k(a,b,g,h,!0,e)})}function k(a,b,c,e,f,g){var h=d("WAJids").interpretAsGroupJid(b.jid),j=f?d("MAWDbThreadTxns").deleteThreadRow(a,b.jid):d("MAWDexieTable").dexieResolve(),k=f?d("MAWDbParticipantTxns").deleteAllParticipantsForThread(a,b.jid):d("MAWDexieTable").dexieResolve(),l=d("MAWDexieTable").dexieResolve(!1),m=d("MAWDexieTable").dexieResolve();h!=null&&f&&(l=d("MAWGroupInviteManagementTxns").deleteGroupInvitesByThread(a,h),m=d("MAWDbGroupInfoTxns").deleteGroupInfo(a,h));return d("MAWDexieTable").dexieAll([i(a,e),d("MAWDbReactionsTxns").deleteAllReactionsForMessages(a,e),d("MAWDbMsgTxns").deleteMessages(a,e,g),j,k,m,l]).then(function(a){a[0];a[1];a[2];a[3];a[4];a[5];a=a[6];f?(d("MAWBridgeEventTransmitter").deleteMessagesOfThreadAfterTxn(b,c),h!=null&&a&&d("MAWIndexedDb").afterTransaction({tag:"DeleteGroupInvite",value:d("MAWBridgeTypesCreators").createBridgeDeleteGroupInvite(b.jid)}),d("MAWIndexedDb").afterTransaction({tag:"ThreadHiddenV2",value:b.jid})):d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.jid,e)});return{deletedMessages:e.map(function(a){return d("MAWDbMsg").getWAMsgId(a)})}})}function l(a,b){var c=b.offlineThreadingId,e=b.userJid;return d("MAWGetOrCreateThreadTxns").createThread(a,{clientThreadKey:c,description:"setupOneToOneThread",jid:e}).then(function(b){return m(a,e,!0,b)})}function m(a,b,e,f){var g=[d("MAWLoadMessageRequestCapabilitiesTxns").loadMessageRequestDataForThreads([f])];b=[{type:"participant",userJid:b}];var h=d("WAGlobals").getMyUserJid();h!==f.jid&&b.push({type:"participant",userJid:h});if(c("gkx")("23923")){g.push(d("MAWDbParticipantTxns").bulkUpsertParticiantsInThread(a,f.jid,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(a)})}));return d("MAWDexieTable").dexieAll(g).then(function(){return{created:e,thread:f}})}e?g.push(d("MAWDbParticipantTxns").bulkAddParticipants(a,f.jid,b).then(function(){})):g.push(d("MAWDbParticipantTxns").getParticipantsInThread(a,f.jid).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(a)})}));return d("MAWDexieTable").dexieAll(g).then(function(){return{created:e,thread:f}})}g.getOrSetupOneToOneThread=a;g.bukGetOrSetupOneToOneThread=b;g.getGroupThread=e;g.deleteAllThreadData=j;g.metaSyncChatDeleteThread=f;g.setupOneToOneThread=l}),98);
__d("MAWWriteGroupInviteTxns",["MAWBridgeTypesCreators","MAWDbGroupInviteTxns","MAWDbParticipant","MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWLowLevelApiTypes","MAWThreadManagementTxns","WAGlobals","WAGroupInviteUtils","WAJids","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){return d("MAWDbThreadTxns").getThread(a,c).then(function(c){return!c.success?d("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.MISSING_GROUP:d("MAWDbGroupInviteTxns").maybeGetGroupInvite(a,b.threadJid,b.inviteeJid).then(function(c){return c&&!d("WATimeUtils").isInFuture(c.inviteExpirationTs)?d("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.EXISTING_GROUP_INVITE:d("MAWDbGroupInviteTxns").putGroupInvite(a,b)})})}function b(a,b,c,e){var f=b.caption,g=b.groupJid,h=b.inviteCode;b=b.inviteExpiration;var i=d("WAJids").interpretAsUserJid(c);if(g==null||b==null||h==null||i==null)return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError({type:"invalid_args"}));c=[d("WATimeUtils").castLongIntToUnixTime(b),d("WAJids").toGroupJid(g),d("WAGroupInviteUtils").toInviteCode(h)];var j=c[0];b=c[1];var k=c[2],l={folder:e,groupJid:b,inviteCode:k,inviteExpireTs:j,inviterJid:i,type:"group_invite"};return d("MAWThreadManagementTxns").getGroupThread(a,b,e,!0).then(function(b){return b==null?d("WAResultOrError").makeError(l):d("MAWDbParticipantTxns").getParticipant(a,b.thread.jid,i)}).then(function(b){if(!b.success)return d("WAResultOrError").makeError(l);var c=d("WAGlobals").getMyUserJid(),e=d("MAWDbParticipant").craftParticipantId(b.value.threadJid,c);return d("MAWDbGroupInviteTxns").putGroupInvite(a,{caption:f==null?void 0:f.text,inviteCode:k,invitedParticipantId:e,inviteeJid:c,inviteExpirationTs:j,inviterJid:i,threadJid:b.value.threadJid}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"GroupInviteUpdate",value:d("MAWBridgeTypesCreators").createBridgeGroupInvite(a)});return d("WAResultOrError").makeResult()})})}g.writeGroupInvite=a;g.writeIncomingGroupInviteMsg=b}),98);
__d("MAWExpiredXMACleaner",["MAWMsgCleaner","WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["ExpiredXMACleaner: Adding timestamps backend(",")"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["startExpiredXMACleaner invoked"]);j=function(){return a};return a}var k=null;function a(a){d("WALogger").LOG(j()),k==null&&(k=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.XMA))}function b(a){if(k==null){var b="Trying to add new addNewExpiredXMACleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(i(),b);throw c("err")(b)}else d("WALogger").DEV(h(),a),k.update(a)}function e(){return k}function f(){k=null}g.startExpiredXMACleaner=a;g.addNewExpiredXMACleanerTimestamp=b;g.getExpiredXMACleaner_FOR_TESTING_ONLY=e;g.resetExpiredXMACleaner_FOR_TESTING_ONLY=f}),98);
__d("MAWXMAManagementTxns",["MAWDexieTable","MAWMediaManagementTxns","MAWXMAUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){var g=b.unstoredDbXMA,i=b.unstoredFavicon,j=b.unstoredHeaderMedia,k=b.unstoredPreviews;f===void 0&&(f=!1);var l=new Map(),m=function(b){return b!=null?d("MAWMediaManagementTxns").handleUnstoredDbMedia(a,b,c,!0).then(function(a){return[b.plaintextHash,a]}):d("MAWDexieTable").dexieResolve([void 0,void 0])};f||(l.set(i==null?void 0:i.plaintextHash,m(i)).set(j==null?void 0:j.plaintextHash,m(j)),k==null?void 0:k.forEach(function(a){l.set(a==null?void 0:a.plaintextHash,m(a))}));b=Array.from(l.values());return d("MAWDexieTable").dexieAll(b).then(function(b){var l,m=new Map(b),n=((l=k)!=null?l:[]).map(function(a){return m.get(a.plaintextHash)}).filter(Boolean);return h(a,f?d("MAWXMAUtils").buildUnstoredTombstonedXMA(g):g,(l=m.get(i==null?void 0:i.plaintextHash))==null?void 0:l.mediaId,(l=m.get(j==null?void 0:j.plaintextHash))==null?void 0:l.mediaId,n.map(function(a){return a.mediaId}),c,e).then(function(a){return{dbMedias:b.map(function(a){a[0];a=a[1];return a}).filter(Boolean),dbXMA:a,firstPreview:n[0]}})})}function h(a,b,d,e,f,g,h){h=babelHelpers["extends"]({},b,{associatedMessageId:(b=h)!=null?b:void 0,defaultPreviewMediaId:f[0],faviconMediaId:d,headerMediaId:e,msgId:g.msgId,previewMediaIds:f});return a.xma.add(h).then(function(b){return a.xma.get(b)}).then(function(a){if(a==null)throw c("err")("Failed to write XMA to db");return a})}function b(a,b,c,e,f,g,h,i,j,k){var l=d("MAWXMAUtils").isXMAExpired(!1,j.targetExpiringAtSec);h=babelHelpers["extends"]({},j,{associatedMessageId:(j=h)!=null?j:void 0,author:i.author,externalId:i.externalId,isTombstoned:l,msgId:g,offlineAttachmentId:k,targetType:f,threadJid:i.chat});var m=l?h:babelHelpers["extends"]({},h,{defaultPreviewMediaId:(j=b)!=null?j:void 0,faviconMediaId:(g=e)!=null?g:void 0,headerMediaId:(k=c)!=null?k:void 0,previewMediaIds:b!=null?[b]:[]});return a.xma.add(m).then(function(a){return babelHelpers["extends"]({},m,{xmaId:a})})}g.handleUnstoredXMAContent=a;g.saveXMA=b}),98);
__d("MAWWriteXMAMessageTxns",["MAWBridgeMsg","MAWBridgeXMA","MAWDbXMATxns","MAWDexieTable","MAWExpiredXMACleaner","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWMsgType","MAWWriteMsgTxns","MAWXMAManagementTxns","MAWXMAUtils","WAJids","WATimeUtils","err","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";f=6*d("WATimeUtils").HOUR_SECONDS;var h=new Set([d("MAWMsgType").MSG_TYPE.TEXT,d("MAWMsgType").MSG_TYPE.GIF,d("MAWMsgType").MSG_TYPE.STICKER]);function a(a,b,c,e){var f=c.unstoredAssociatedMedia,g=c.unstoredAssociatedMsg,h=c.unstoredDbXMA;return d("MAWDbXMATxns").maybeGetAssociatedXMAMsg(a,g,e.jid).then(function(c){var i=b;if(c!=null&&c.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT){var j=c.serverTs,k=c.sortOrderMs;c=c.ts;i=babelHelpers["extends"]({},b,{serverTs:j,sortOrderMs:k!=null?k-1:k,ts:c})}j=[h.targetExpiringAtSec,h.targetType];k=j[0];c=j[1];d("MAWXMAUtils").isXMAStoryReaction(c)&&(g==null?void 0:g.msgContent)!=null&&(i=babelHelpers["extends"]({},b,{msgContent:g.msgContent}));j=d("MAWXMAUtils").isXMAExpired(h.isTombstoned,k);i.isExpiredXmaMsg=j;k=!d("MAWXMAUtils").isXMAStoryReaction(c)&&g!=null?d("MAWWriteMsgTxns").prepareMsgWriteData(a,g,e):d("MAWDexieTable").dexieResolve(null);return d("MAWDexieTable").dexieAll([d("MAWWriteMsgTxns").prepareMsgWriteData(a,i,e),k]).then(function(a){var b=a[0];a=a[1];return{associatedData:a,associatedMedia:f,associatedMsg:g,xmaData:b,xmaMsg:i}})})}function b(a,b,e,f){var g=e.unstoredDbXMA,h=[g.targetExpiringAtSec,g.targetType],i=h[0];h=h[1];if(b==null||b.type===d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME)return d("MAWDexieTable").dexieResolve({dbMedias:null,dbXMA:null});b.isExpiredXmaMsg!==!0&&i!=null&&d("MAWExpiredXMACleaner").addNewExpiredXMACleanerTimestamp(i);d("MAWXMAUtils").isXMAStoryReaction(h)&&d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b)});return d("MAWXMAManagementTxns").handleUnstoredXMAContent(a,babelHelpers["extends"]({},e,{unstoredDbXMA:g}),b,f,b.isExpiredXmaMsg===!0).then(function(e){var f=e.dbMedias,g=e.dbXMA;e=e.firstPreview;g!=null&&!d("MAWXMAUtils").isXMAStoryReply(g.targetType)&&(b.isExpiredXmaMsg!==!0&&(c("gkx")("821")?c("promiseDone")(d("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(e,g,a)):d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:d("MAWBridgeXMA").createBridgeXMA(e,g,!1)})));return{dbMedias:f,dbXMA:g}})}function e(a,b,e,f,g,i,j){if(!h.has(g.type))throw c("err")("flow check, this message type is not supported for XMA replies");var k=b.author;if(k==="@system")throw c("err")("wrong author of story reply");var l=d("WAJids").interpretAsUserJid(f);if(l==null)throw c("err")("this is a flow check, participant jid can not be null");k={author:k===d("WAJids").AUTHOR_ME?l:d("WAJids").AUTHOR_ME,externalId:e.externalId,mediaId:i?void 0:e==null?void 0:e.defaultPreviewMediaId,msgId:c("gkx")("458")?e.msgId:void 0,sourceId:(l=(k=e.defaultCTA)==null?void 0:k.nativeUrl)!=null?l:(i=e.defaultCTA)==null?void 0:i.actionUrl,ts:b.ts,type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:e.targetType};var m=babelHelpers["extends"]({},g,{mediaId:(l=j==null?void 0:j.mediaId)!=null?l:g.mediaId,quote:{content:k,remoteJid:f}});return a.messages.put(m).then(function(){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(m)})})}g.REVOKE_CONTENT_EXPIRATION_IN_SEC=f;g.XMA_REPLY_MSG_SUPPORTED_TYPES=h;g.prepareXMAWriteData=a;g.handleIncomingXMA=b;g.handleXMAReplyMsg=e}),98);
__d("MAWHandleIncomingMsgApi",["MAWDbRavenActionTxns","MAWDexieTable","MAWEBSwitch","MAWEphemeralAdminMsgBuildTxns","MAWEphemeralMsgTxns","MAWEphemeralSettingsTxns","MAWHIMLogger","MAWJidUtils","MAWMediaManagementTxns","MAWMsgActionType","MAWMsgType","MAWPendingReceiptProcessingTxns","MAWWriteEditTxns","MAWWriteGroupInviteTxns","MAWWriteMsgTxns","MAWWriteRevokeMessageTxns","MAWWriteXMAMessageTxns","MAWXMAUtils","WAJids","WAResultOrError","err","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Could not write dbAssociatedMsg but it exists: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleIncomingMsgInternal: Finished writing the incoming message"]);i=function(){return a};return a}var j=c("requireDeferred")("ArmadilloReceiveWriteDbSuccessFalcoEvent").__setRef("MAWHandleIncomingMsgApi"),k=c("requireDeferred")("EncryptedBackupTaskSkippedFalcoEvent").__setRef("MAWHandleIncomingMsgApi"),l=d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult(void 0));function a(a,b){b.receiveFlow.addPoint("him_write_message_start");return m(a,b).then(function(a){var c;b.receiveFlow.addPoint("him_write_message_end",{bool:{outOfSync:(a==null?void 0:(c=a.value)==null?void 0:c.outOfSyncEphemeralSetting)!=null},string:{msgWrittenResultType:(c=a==null?void 0:(c=a.value)==null?void 0:c.msgType)!=null?c:"unknown"}});return a})["catch"](function(a){var c;a.message="[handleIncomingMsg] ["+((c=b.type)!=null?c:"")+"/"+b.action+"] "+a.message;throw a})}function m(a,b){if(b.action===d("MAWMsgActionType").MSG_ACTION.NO_ACTION)return l;var e=function(c,e,f){return d("MAWEphemeralMsgTxns").syncEphemeralSettingOnIncomingMsg(a,c,e,b.thread,b.device,f)};switch(b.type){case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b.msg,b.thread).then(function(){return d("WAResultOrError").makeResult(null)});case d("MAWMsgType").MSG_TYPE.RAVEN_ACTION:return d("MAWDbRavenActionTxns").writeRavenActionMsg(a,b.msg,b.thread).then(function(){return d("WAResultOrError").makeResult(null)});case d("MAWMsgType").MSG_TYPE.REACTION:return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult({reactToExternalId:b.msg.reactToExternalId}));case d("MAWMsgType").MSG_TYPE.GROUP_INVITE:return d("WAJids").isAuthorMe(b.id.author)?l:d("MAWWriteGroupInviteTxns").writeIncomingGroupInviteMsg(a,b.msg,b.thread.jid,b.folder);case d("MAWMsgType").MSG_TYPE.TEXT:case d("MAWMsgType").MSG_TYPE.FUTUREPROOF:case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:case d("MAWMsgType").MSG_TYPE.RAVEN:case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:if(b.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME)return d("MAWWriteMsgTxns").handleDeleteForMeMessage(a,b.msg,b.thread,b.pendingDeleteForMeStanza).then(function(a){return o(a)});var f=b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT?d("MAWWriteMsgTxns").writeCiphertextUpdate(a,b.msg,b.existingMsg,b.thread,b.existingEditMsgHistory):b.action===d("MAWMsgActionType").MSG_ACTION.REVOKE?d("MAWWriteMsgTxns").handleOutOfOrderRevokedMessage(a,b.msg,b.thread,b.pendingRevokedStanza):d("MAWWriteEditTxns").writeNewIncomingMsgAndEditHistory(a,b.msg,b.thread,b.editMsgHistories);return f.then(function(c){var f=b.media!=null?d("MAWMediaManagementTxns").handleUnstoredDbMedia(a,b.media,c):d("MAWDexieTable").dexieResolve();return f.then(function(f){return d("MAWDexieTable").dexieAll([p(a,b.id,c,c.type!==d("MAWMsgType").MSG_TYPE.FUTUREPROOF),e(c,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(a){a[0];a=a[1];return o(c,a,f==null?null:[f])})})});case d("MAWMsgType").MSG_TYPE.REVOKED:return d("MAWWriteRevokeMessageTxns").writeIncomingRevokeMsg(a,b.msg,b.thread,b.originalMsg,b.previousRevokeMsg,b.ebTimestampMs).then(function(c){return d("MAWDexieTable").dexieAll([p(a,b.id,c),e(c,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(a){a[0];a=a[1];return o(c,a)})});case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return d("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(a,d("MAWJidUtils").getAuthorJid(b.id.author),b.device,b.msg.ephemeralExpirationInSec,b.msg.ephemeralLastUpdatedOrSetTimestamp,b.msg.isEphemeralSettingReset,b.thread,b.ts,b.id.externalId,!0).then(function(c){return p(a,b.id,c==null?void 0:c.dbMsg).then(function(){return o(c==null?void 0:c.dbMsg,c==null?void 0:c.outOfSyncEphemeralSetting)})});case d("MAWMsgType").MSG_TYPE.ICDC_ALERT:return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult({msgType:void 0,outOfSyncEphemeralSetting:void 0,plaintextHashs:void 0}));case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return d("MAWEphemeralAdminMsgBuildTxns").writeEphemeralScreenshotActionMsg(a,d("MAWJidUtils").getAuthorJid(b.id.author),b.thread,b.ts,b.screenshotActionType,b.id.externalId,b.existingMsg).then(function(c){return d("MAWDexieTable").dexieAll([p(a,b.id,c),e(c,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(a){a[0];a=a[1];return o(c,a)})});case d("MAWMsgType").MSG_TYPE.XMA:if(b.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME)return d("MAWWriteMsgTxns").handleDeleteForMeMessage(a,b.msg,b.thread,b.pendingDeleteForMeStanza).then(function(a){return o(a)});f=b.action===d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED||b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED?n(a,b).then(function(c){return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b.associatedMsg,b.thread).then(function(e){if(b.associatedMedia!=null)return d("MAWMediaManagementTxns").handleUnstoredDbMedia(a,b.associatedMedia,e).then(function(d){return q(a,c,e,b.xma,b.msg,b.associatedMsg,b.thread.jid,d)});else return q(a,c,e,b.xma,b.msg,b.associatedMsg,b.thread.jid)})}):b.action===d("MAWMsgActionType").MSG_ACTION.REVOKE?n(a,b):n(a,b).then(function(c){return d("MAWWriteXMAMessageTxns").handleIncomingXMA(a,c,b.xma,null).then(function(a){return babelHelpers["extends"]({},a,{dbMsg:c})})});return f.then(function(c){var f=c.dbAssociatedMsg,g=c.dbMedias,h=c.dbMsg;return d("MAWDexieTable").dexieAll([p(a,b.id,h,!0,f),e(h,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(a){a[0];a=a[1];return o(h,a,g)})});default:throw c("err")("We do not support handleIncomingMsgInternal with type: "+((f=b.type)!=null?f:""))}}function n(a,b){return b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT||b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED?d("MAWWriteMsgTxns").writeCiphertextUpdate(a,b.msg,b.existingMsg,b.thread,null):b.action===d("MAWMsgActionType").MSG_ACTION.REVOKE?d("MAWWriteMsgTxns").handleOutOfOrderRevokedMessage(a,b.msg,b.thread,b.pendingRevokedStanza):d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b.msg,b.thread)}function o(a,b,c){return d("WAResultOrError").makeResult({msgType:a==null?void 0:a.type,outOfSyncEphemeralSetting:(a=b)!=null?a:void 0,plaintextHashs:c==null?void 0:c.map(function(a){return a.plaintextHash})})}function p(a,b,e,f,g){var h=b.author,l=b.chat,m=b.externalId;f===void 0&&(f=!1);if(e==null)return d("MAWDexieTable").dexieResolve();void j.load().then(function(a){return a.log(function(){return{encrypted_backup_enable:c("MAWEBSwitch").isEnabled(),message_id:m}})});(!f||!c("MAWEBSwitch").isEnabled())&&void k.load().then(function(a){return a.log(function(){return{message_id:m,skipped_reason:"Msg type: "+e.type+", EB enabled: "+c("MAWEBSwitch").isEnabled().toString()}})});if(e==null)return d("MAWDexieTable").dexieResolve();b=d("MAWPendingReceiptProcessingTxns").processPendingReceipts(a,l,e);f=h===d("WAJids").AUTHOR_ME&&g!=null&&g.type!==d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME?d("MAWPendingReceiptProcessingTxns").processPendingReceipts(a,l,g):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([b,f]).then(function(){c("MAWHIMLogger").LOG(i())})}function q(a,b,e,f,g,i,j,k){return d("MAWWriteXMAMessageTxns").handleIncomingXMA(a,b,f,e.msgId).then(function(f){var l=f.dbMedias;f=f.dbXMA;e==null&&c("MAWHIMLogger").ERROR(h(),i.externalId);return(e!=null&&f!=null&&d("MAWXMAUtils").isXMAStoryReply(f.targetType)?d("MAWWriteXMAMessageTxns").handleXMAReplyMsg(a,g,f,j,e,g.isExpiredXmaMsg===!0,k):d("MAWDexieTable").dexieResolve()).then(function(){return k!=null?{dbAssociatedMsg:e,dbMedias:l!=null?[].concat(l,[k]):[k],dbMsg:b}:{dbAssociatedMsg:e,dbMedias:l,dbMsg:b}})})}g.handleIncomingMsg=a;g.processReceipts=p}),98);
__d("MAWLinkReactionsToMsgsTxns",["LSQueryBulkUtils","MAWDbMsgTxns","MAWDbReactionUtils","MAWDexieCastToPromise","MAWRestoreDbState","MAWTransactor","WAMsgMap","asyncToGeneratorRuntime","qex"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a.reduce(function(a,b){var c,d={author:b.reactToAuthor,chat:b.threadJid,externalId:b.reactToExternalId};c=(c=a.get(d))!=null?c:[];c.push(b);return a.set(d,c)},new(d("WAMsgMap").MsgMap)())}function i(a){a.forEach(function(a){d("MAWDbReactionUtils").dispatchReaction(a)})}function j(a,b){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){a=(yield d("MAWTransactor").runInLSDB(function(a){return d("LSQueryBulkUtils").bulkGetByIndex(a.e2ee_reactions.index("reactToExternalId"),b)}));return a});return k.apply(this,arguments)}function l(a,b){return a.reactions.where("reactToExternalId").anyOf(b).toArray()}function m(a,b){var e=d("MAWRestoreDbState").isUsingShim_UNSAFE()&&c("qex")._("1016")?function(){return d("MAWDexieCastToPromise").promiseCastToDexiePromise_I_KNOW_WHAT_I_AM_DOING(j(a,b))}:function(){return l(a,b)};return e().then(function(a){return h(a.filter(function(a){return a.reactToMsgId==null}))})}function a(a,b){return m(a,b).then(function(b){return d("MAWDbMsgTxns").getMsgsByProtocolMsgId(a,b.keys()).then(function(a){return a.flatMap(function(a){var c={author:a.author,chat:a.threadJid,externalId:a.externalId};c=(c=b.get(c))!=null?c:[];return c.map(function(b){b.reactToMsgId=a.msgId;return b})})})})}function n(a,b){return a.reactions.bulkPut(b).then(function(){i(b)})}function o(a,b){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c){yield d("MAWTransactor").runInLSDB(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=a.e2ee_reactions;yield d("LSQueryBulkUtils").bulkPut(a,c)});return function(b){return a.apply(this,arguments)}}())});return p.apply(this,arguments)}function e(a,b){return d("MAWRestoreDbState").isUsingShim_UNSAFE()&&c("qex")._("1016")?d("MAWDexieCastToPromise").promiseCastToDexiePromise_I_KNOW_WHAT_I_AM_DOING(o(a,b)):n(a,b)}g.getReactionLinkUpdatesForExternalIds=a;g.updateReactionLinks=e}),98);
__d("MAWLinkReactionsToMsgsApi",["MAWIndexedDb","MAWLinkReactionsToMsgsTxns","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";var h=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READONLY},"linkReactionsToMsgs",function(a){return function(b){return d("MAWLinkReactionsToMsgsTxns").getReactionLinkUpdatesForExternalIds(a,b).then(function(b){return d("MAWLinkReactionsToMsgsTxns").updateReactionLinks(a,b)})}});function a(a){return h(a)}g.linkReactionsToMsgs=a}),98);
__d("MAWOfflineThreadTxns",["MAWBridgeThread","MAWDbGroupInfoTxns","MAWDbParticipantTxns","MAWDbThread","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWLoadMessageRequestCapabilitiesTxns","MAWWriteBulkWriteIncomingAdminMsgTxns","WAArrayZip","WAGlobals","WAJids","WATagsLogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Duplicated thread creation for ",""]);h=function(){return a};return a}var i=new Set();function a(a,b,c){var e=new Set(b),f=new Map(),g=new Map();c.forEach(function(a){g.set(a.jid,"exists"),f.set(a.jid,a),e["delete"](a.jid)});if(e.size===0)return d("MAWDexieTable").dexieResolve({threadCreationResult:g,threads:f});e.forEach(function(a){i.has(a)&&d("WATagsLogger").TAGS(["occamadillo","incoming_processing"]).LOG(h(),a)});return n(a,e).then(function(b){b.oneToOneThreadsCreationData.forEach(function(a){i.add(a.thread.jid)});b.groupThreadsCreationData.forEach(function(a,b){i.add(b),a.groupInfo==null&&g.set(b,"missing")});return a.threads.bulkAdd(o(b),{allKeys:!0}).then(function(b){return d("MAWDbThreadTxns").getThreads(a,Array.from(e.values())).then(function(b){l(b);var c=p(b);return d("MAWDexieTable").dexieAll([j(a,c),d("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreads(a,b)]).then(function(){b.forEach(function(a){return f.set(a.jid,a)});return{threadCreationResult:g,threads:f}})})})})}function j(a,b){return d("MAWDexieTable").dexieAll([k(a,b),d("MAWLoadMessageRequestCapabilitiesTxns").loadMessageRequestDataForThreads(Array.from(b.values()))])}function k(a,b){var c=[],e=d("WAGlobals").getMyUserJid();b.forEach(function(a,b){c.push({threadJid:b,type:"participant",userJid:b}),e!==b&&c.push({threadJid:b,type:"participant",userJid:e})});return d("MAWDbParticipantTxns").bulkAddParticipantsInThreads(a,c).then(function(){})}function l(a){a.forEach(function(a){return d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(a,a.optimisticThreadKey,void 0,"createAllThreadsForOfflineMsgs")})})}function m(a,b){return{folder:null,jid:a,lastReadMsg:null,lastReadMsgReceiptSent:null,lastReadMsgTs:null,newestMsg:null,newestMsgTs:b!=null?d("WATimeUtils").castUnixTimeToMillisTime(b):null,oldestMsg:null,optimisticThreadKey:void 0,threadOrder:d("MAWDbThread").craftThreadOrder(d("WATimeUtils").millisTime(),a)}}function n(a,b){var c=[],e=[];b.forEach(function(a){d("WAJids").switchOnMsgrChatJidType(a,{group:function(a){return c.push(a)},user:function(a){return e.push(a)}})});return d("MAWDbGroupInfoTxns").getGroupInfos(a,c).then(function(a){var b=new Map(d("WAArrayZip").zip(c,a));a=new Map(c.map(function(a){var c=b.get(a);return[a,{groupInfo:c,thread:m(a,c==null?void 0:c.creationTs)}]}));var f=new Map(e.map(function(a){return[a,{thread:m(a,null)}]}));return{groupThreadsCreationData:a,oneToOneThreadsCreationData:f}})}function o(a){var b=a.groupThreadsCreationData;a=a.oneToOneThreadsCreationData;return Array.from(b.values()).map(function(a){a=a.thread;return a}).concat(Array.from(a.values()).map(function(a){a=a.thread;return a}))}function p(a){var b=new Map();a.forEach(function(a){d("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(a){},user:function(c){return b.set(c,a)}})});return b}g.createAllThreadsForOfflineMsgs=a}),98);
__d("MAWPreprocessMsgs",["MAWBuildIncomingMsgs","MAWDbMsgTxns","MAWDexieTable","MAWHIMLogger","MAWMediaManagementTxns","MAWMsgActionType","MAWMsgType","MAWWriteMsgTxns","MAWWriteXMAMessageTxns","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unsupported message type on preprocessing ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media is null for StanzaID ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Preparing media for msg with StanzaID ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpected msg type when writing ephemeral setting message. Should not happen"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["No unstored content for incoming message: SHOULD NEVER HAPPEN"]);l=function(){return a};return a}var m=c("MAWHIMLogger").TAGS(["MAWPreprocessMsgs"]);function a(a){var b=[],c=[];a.forEach(function(a){var d=a.msgData;a=a.unstoredContent;switch(d.type){case"IncomingMsg":if(a==null){m.ERROR(l());return}var e=a.unstoredDbEditActionMsg;a=a.unstoredDbReaction;if(a!=null){a={chatJid:d.id.chat,unstoredReaction:a};b.push(a)}e!=null&&c.push({chatJid:d.id.chat,msg:e});break;case"IncomingCiphertextMsg":default:break}});return{editActionMsgs:c,reactionMsgs:b}}function b(a,b,c){b.receiveFlow.addPoint("him_get_preprocessing_data_start");return n(a,b,c).then(function(a){var c;b.receiveFlow.addPoint("him_get_preprocessing_data_end",{string:{action:a.action,type:(c=a.type)!=null?c:""}});return a})}function n(a,b,c){var e=b.msgData,f=b.receiveFlow,g=b.unstoredContent;b=e.folder;var l=e.id,n=e.ts,p={id:l,receiveFlow:f,thread:c,ts:n},q=d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.NO_ACTION,msg:null,type:null}));switch(e.type){case"IncomingMsg":if(g==null)return q;var r=e.device,s=g.unstoredDbMsg;f=g.unstoredDbRavenActionMsg;var t=g.unstoredDbReaction,u=g.unstoredIncomingDbGroupInvite;if(f!=null)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:f,type:d("MAWMsgType").MSG_TYPE.RAVEN_ACTION}));else if(t!=null)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:t,type:d("MAWMsgType").MSG_TYPE.REACTION}));else if(u!=null)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,folder:b,msg:u,type:d("MAWMsgType").MSG_TYPE.GROUP_INVITE}));else if(s==null)return q;else if(s.type===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN){f=e.msg;if(f.version==="v3"&&f.type==="ephemeral")return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,msg:f,type:s.type}));else{m.ERROR(k());return q}}else if(s.type===d("MAWMsgType").MSG_TYPE.ICDC_ALERT)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,data:null,device:r,folder:b,type:s.type}));else if(s.type===d("MAWMsgType").MSG_TYPE.TEXT||s.type===d("MAWMsgType").MSG_TYPE.FUTUREPROOF)return d("MAWWriteMsgTxns").prepareTextMsgWriteData(a,s,c).then(function(a){var b=a.editMsgHistories,c=a.existingEditMsgHistory,e=a.existingMsg,f=a.isDeletedWithThread,g=a.isDeleteForMeOrRevoked,h=a.pendingDeleteForMeStanza;a=a.pendingRevokedStanza;var i=o(e,s,c);if(g||f||e!=null&&i!==!0)return q;if(i&&e!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,device:r,existingEditMsgHistory:c,existingMsg:e,msg:s,type:s.type});if(h!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:s,pendingDeleteForMeStanza:h,type:s.type});return a!=null?babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.REVOKE,device:r,msg:s,pendingRevokedStanza:a,type:s.type}):babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,editMsgHistories:b,msg:s,type:s.type})});else if(s.type===d("MAWMsgType").MSG_TYPE.IMAGE||s.type===d("MAWMsgType").MSG_TYPE.VIDEO||s.type===d("MAWMsgType").MSG_TYPE.PTT||s.type===d("MAWMsgType").MSG_TYPE.GIF||s.type===d("MAWMsgType").MSG_TYPE.STICKER||s.type===d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE||s.type===d("MAWMsgType").MSG_TYPE.RAVEN){s.type===d("MAWMsgType").MSG_TYPE.IMAGE&&((t=e.msg.metadata)==null?void 0:t.groupId)!=null&&(s.groupId=e.msg.metadata.groupId,s.groupIndex=e.msg.metadata.groupIndex,s.groupSize=e.msg.metadata.groupSize);m.LOG(j(),s.externalId);return d("MAWMediaManagementTxns").prepareMediaWriteData(a,s,g==null?void 0:g.unstoredDbMedia,c).then(function(a){var b=a.existingMsg,c=a.isDeletedWithThread,e=a.isDeleteForMeOrRevoked,f=a.pendingDeleteForMeStanza,h=a.pendingRevokedStanza;a=a.shouldDropDocument;var j=[g==null?void 0:g.unstoredDbMedia,o(b,s)],k=j[0];j=j[1];k==null&&m.LOG(i(),s.externalId);if(a===!0||e||c||k==null||b!=null&&!j)return q;if(j&&b!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,device:r,existingMsg:b,media:k,msg:s,type:s.type});if(f!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:s,pendingDeleteForMeStanza:f,type:s.type});return h!=null?babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.REVOKE,device:r,msg:s,pendingRevokedStanza:h,type:s.type}):babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,media:k,msg:s,type:s.type})})}else if(s.type===d("MAWMsgType").MSG_TYPE.XMA){var v=g==null?void 0:g.unstoredXMA;return v==null?q:d("MAWWriteXMAMessageTxns").prepareXMAWriteData(a,s,v,c).then(function(a){var b=a.xmaData.existingMsg,c=o(b,s);if(a.associatedMsg!=null&&a.associatedData!=null&&!a.associatedData.isDeletedWithThread&&!a.associatedData.isDeleteForMeOrRevoked)if(c&&b!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED,associatedMsg:a.associatedMsg,device:r,existingMsg:b,msg:a.xmaMsg,type:s.type,xma:v});else return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED,associatedMedia:a.associatedMedia,associatedMsg:a.associatedMsg,device:r,msg:a.xmaMsg,type:s.type,xma:v});if(c&&b!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,device:r,existingMsg:b,msg:a.xmaMsg,type:s.type,xma:v});c=a.xmaData;var e=c.isDeletedWithThread,f=c.isDeleteForMeOrRevoked,g=c.pendingDeleteForMeStanza;c=c.pendingRevokedStanza;if(e||f||b!=null)return q;if(g!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:a.xmaMsg,pendingDeleteForMeStanza:g,type:s.type});return c!=null?babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.REVOKE,device:r,msg:a.xmaMsg,pendingRevokedStanza:c,type:s.type}):babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,msg:a.xmaMsg,type:s.type,xma:v})})}else if(s.type===d("MAWMsgType").MSG_TYPE.REVOKED)return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,s.revokedExternalId,c.jid,l.author),d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,s.externalId,c.jid,l.author)]).then(function(a){var b=a[0];a=a[1];return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,ebTimestampMs:s.ebTimestampMs,msg:s,originalMsg:b,previousRevokeMsg:a,type:s.type})});else if(s.type===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION){u=d("WAJids").isAuthorMe(l.author)?d("WAGlobals").getMyUserJid():l.author;return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,l.externalId,c.jid,u)]).then(function(a){a=a[0];return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,existingMsg:a,screenshotActionType:s.msgContent.screenshotActionType,type:s.type})})}else if(s.type===d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,msg:s,type:s.type}));else{m.ERROR(h(),s.type);return q}case"IncomingCiphertextMsg":if(!((f=e==null?void 0:e.createPlaceholder)!=null?f:!1))return q;var w=d("MAWBuildIncomingMsgs").buildUnstoredCiphertextMsg(l,n);return d("MAWWriteMsgTxns").prepareMsgWriteData(a,w,c).then(function(a){var b=a.existingMsg,c=a.isDeletedWithThread;a=a.isDeleteForMeOrRevoked;return a||c||b!=null?q:babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:w,type:d("MAWMsgType").MSG_TYPE.CIPHERTEXT})});case"UnavailableMsg":case"FrankingInvalidMsg":var x=d("MAWBuildIncomingMsgs").buildUnstoredUnavailableMsg(l,n);return d("MAWWriteMsgTxns").prepareMsgWriteData(a,x,c).then(function(a){var b=a.existingMsg,c=a.isDeletedWithThread;a=a.isDeleteForMeOrRevoked;return a||c||b!=null?q:babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:x,type:d("MAWMsgType").MSG_TYPE.UNAVAILABLE})})}}function o(a,b,c){if(a==null&&c==null)return!1;return b.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?!1:(a==null?void 0:a.type)===d("MAWMsgType").MSG_TYPE.CIPHERTEXT||(c==null?void 0:c.msgContent.content)===""}g.classifyIncomingMsgs=a;g.getMessageDataByType=b;g.isCiphertextUpdate=o}),98);
__d("MAWSharedOfflineQueueMetric",["$InternalEnum","FBLogger","WAGlobals","WAPREList","WATagsLogger","WATimeUtils","WAWaterFlow"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["New mailbox age is ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["New mailbox age is ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Waterflow should start before the start of the processing"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Possible stuck reason: ",""]);k=function(){return a};return a}var l=d("WATagsLogger").TAGS(["offline-resume"]);f=b("$InternalEnum").Mirrored(["OFFLINE","ONLINE"]);var m=b("$InternalEnum").Mirrored(["WA_CLIENT_INFRA","WA_CLIENT_INFRA_DUPLICATED_START","WA_PASSIVE_MODE","WA_PASSIVE_MODE_FAIL","MAW_INFRA","MAW_NOT_IDLE_OQ"]),n=function(){function a(a,b,c,e){this.$1=0,this.$3=c,this.$2=d("WAWaterFlow").makeWaterflow("offline-resume",d("WAPREList").PRE_METRIC.OFFLINE_QUEUE),this.$6(a),this.$7(),this.$8(b),this.$9(e),this.$4=Math.round(d("WATimeUtils").performanceAbsoluteNow()/1e3)}var b=a.prototype;b.$8=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"passive-mode-start":b.$2.isOnGoing()||b.$2.startMetric();b.$2.startPoint(m.WA_PASSIVE_MODE,{passiveModeAcks:a.count});b.$10("passive");break;case"passive-mode-end":b.$2.endPoint(m.WA_PASSIVE_MODE);b.$10("passive-end");break;default:a.type,b.$2.addPoint(m.WA_PASSIVE_MODE_FAIL),b.$10("passive-end")}})};b.$9=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"new-message":if(a.commonMessageBase.offline==null)return;b.addWAMessage();b.$10("wa");break}})};b.$6=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"offline-start":b.$11(a.offlineStats);b.$10("wa-start");break;case"offline-end":b.$2.isOnGoing()&&(b.$2.endPoint(m.WA_CLIENT_INFRA),b.$10("maw"));break;case"offline-entity":b.$12(a.serverTs,a.offline);b.$10("wa");break;case"offline-processed":b.$13(a.count);b.$10("wa");break;case"connection-lost":b.$2.isOnGoing()&&b.$2.endFail("connection-lost");b.$14();break;default:a}})};b.$10=function(a,b){var c=this;b===void 0&&(b=15e3);clearTimeout(this.$5);this.$2.isOnGoing()&&(this.$5=setTimeout(function(){c.$2.isOnGoing()&&(c.$2.endFail(a+"-stuck"),l.WARN(k(),a))},b))};b.$14=function(){clearTimeout(this.$5)};b.$7=function(){var a=this;this.$3.subscribe(function(b){switch(b.type){case"idle-oq-safe-guard":if(!a.$2.isOnGoing())break;a.$2.addPoint(m.MAW_NOT_IDLE_OQ);break;case"maw-infra-start":if(!a.$2.isOnGoing())break;a.$10("maw");a.$2.startPoint(m.MAW_INFRA);break;case"maw-infra-batch":a.$2.isOnGoing()||(a.$2.startMetric(),a.$2.startPoint(m.MAW_INFRA));a.$10("maw");break;case"maw-infra-end":if(!a.$2.isOnGoing())break;a.$2.endPoint(m.MAW_INFRA);a.$14();b.success?a.$2.endSuccess():a.$2.endFail("fail");break;default:b}})};b.addWAMessage=function(){this.$2.isOnGoing()&&(this.$2.reAnnotate(function(a){a=a.waMessage;return{waMessage:((a=a)!=null?a:0)+1}}),this.$10("wa"))};b.addMAWEntity=function(a){this.$2.isOnGoing()&&(this.$2.reAnnotate(function(b){b=b.mawProcessedCount;return{mawProcessedCount:((b=b)!=null?b:0)+a}}),this.$10("maw"))};b.$11=function(a){this.$2.isOnGoing()?this.$2.addPoint(m.WA_CLIENT_INFRA_DUPLICATED_START):(this.$1++,this.$2.startMetric(),this.$4=Math.round(d("WATimeUtils").performanceAbsoluteNow()/1e3)),this.$2.startPoint(m.WA_CLIENT_INFRA,{batchSize:d("WAGlobals").getConfig().batchSize(),expectedAppdata:a.appdata,expectedCount:a.count,expectedMessage:a.message,expectedNotification:a.notification,expectedReceipt:a.receipt,offlineResumeCount:this.$1,useIncreasedSignalFutureMessagesMax:d("WAGlobals").getConfig().getSignalFutureMessagesMax()>2e3,waDanglingQueue:d("WAGlobals").getConfig().waDanglingQueue()})};b.getDetails=function(){var a;return((a=this.$2)==null?void 0:a.getAnnotations())||{}};b.$13=function(a){var b;(b=this.$2)==null?void 0:b.reAnnotate(function(b){return{waProcessed:((b=b.waProcessed)!=null?b:0)+a}})};b.addRuntimeErrorDuringOffflineQueue=function(){if(this.$2.isOnGoing()){var a;(a=this.$2)==null?void 0:a.reAnnotate(function(a){return{runtimeErrors:((a=a.runtimeErrors)!=null?a:0)+1}})}};b.addDecryptionError=function(){if(this.$2.isOnGoing()){var a;(a=this.$2)==null?void 0:a.reAnnotate(function(a){return{decryptErrors:((a=a.decryptErrors)!=null?a:0)+1}})}};b.addRetriesTrack=function(a){if(this.$2.isOnGoing()){var b;(b=this.$2)==null?void 0:b.reAnnotate(function(b){return{retries:((b=b.retries)!=null?b:0)+a}})}};b.$12=function(a,b){var c=this;if(!this.$2.isOnGoing()){l.WARN(j());return}this.$2.reAnnotate(function(d){var e=d.mailboxAgeSec,f=d.maxOffline;d=d.waDownloaded;e=e;e==null&&a!=null&&(e=c.$4-a,l.LOG(i(),e));e!=null&&a!=null&&(c.$4-a>e&&(e=c.$4-a,l.LOG(h(),e)));return{mailboxAgeSec:e,maxOffline:Math.max((e=f)!=null?e:0,b),waDownloaded:((f=d)!=null?f:0)+1}})};return a}(),o;function a(a,b,d,e){if(o!=null){var f=o;c("FBLogger")("messenger_e2ee_web").mustfix("Offline sync reported is inited twice");return f}o=new n(a,b,d,e);return o}function e(){if(o==null){c("FBLogger")("messenger_e2ee_web").mustfix("Offline sync reported is not inited");return null}return o}g.OfflineMode=f;g.OfflineStages=m;g.makeOfflineQueueMetric=a;g.getOfflineQueueMetric=e}),98);
__d("WAThrottle",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c=0,d=null,e;function f(){var f=Date.now(),g=f-c;for(var h=arguments.length,i=new Array(h),j=0;j<h;j++)i[j]=arguments[j];e=i;g>=b?(clearTimeout(d),d=null,a.apply(void 0,i),c=Date.now()):d==null&&(d=setTimeout(function(){return a.apply(void 0,e)},b-g))}return f}f.throttle=a}),66);
__d("MAWSharedOfflineResumeUINotifier",["MAWBridge","MAWQplProxy","MAWSharedProtocolQueueConst","WAOfflineUtils","WATagsLogger","WAThrottle","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose([' -> Unable to send "Offline Complete" event ',""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose([' -> "Offline Complete" bridge event sent']);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAW UI: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Set thread metadata: ",", ",""]);k=function(){return a};return a}var l=1e3/3,m=d("WATagsLogger").TAGS(["ProtocolQueue","MAWConsumer"]);a=function(){function a(){var a=this;this.$1={};this.$2={};this.$3=0;this.$4="wa";this.$5=!1;this.$6=0;this.$7=0;this.$8=0;this.$9=0;this.$10=null;this.$16=d("WAThrottle").throttle(function(){if(a.$5)return;a.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing)},l);this.$12=d("WAThrottle").throttle(function(){a.$4==="wa"&&a.$5===!1&&a.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Processing)},l)}var b=a.prototype;b.subscribeToWAEvents=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"offline-start":b.$10=d("MAWQplProxy").performanceAbsoluteNow();b.$6=a.offlineStats.count;b.$8=a.offlineStats.message;b.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Initializing,b.$10);b.$5=!1;b.$4="wa";break;case"offline-processed":break;case"offline-entity":b.$7++;b.$12();break;case"offline-end":b.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Complete);b.$4="maw";break;case"connection-lost":b.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Failed);break;default:a}})};b.subscribeToMawEvents=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"maw-infra-start":b.$10==null&&(b.$10=d("MAWQplProxy").performanceAbsoluteNow());b.$13();break;case"maw-infra-end":a.success?b.notifyUICurrentProcessingSucceeded():b.$14();b.$10=null;break}})};b.subscribeToMessageEvents=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"new-message":if(a.commonMessageBase.offline==null)return;b.addWAMessage();break}})};b.addWAMessage=function(){this.$9++,this.$12()};b.$13=function(){this.$3=0,this.$5=!1,this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Initializing)};b.setThreadMetadata=function(a){var b=a.reduce(function(a,b){a[b.from]=b.t;return a},{});a=a.reduce(function(a,b){b=b.from;a[b]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing};return a},{});m.DEV(k(),JSON.stringify(b),JSON.stringify(a));this.$1=b;this.$2=a};b.notifyUIChatReady=function(a){this.$2[a]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete},this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing)};b.updateChatState=function(a){var b=this;Object.entries(a).forEach(function(a){var c=a[0];a=a[1];if(b.$1[c]!=null){var e=b.$1[c];a>=e&&(b.$2[c]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete})}});this.$16()};b.addMAWEntity=function(a){this.$3+=a,this.$16()};b.notifyUICurrentProcessingSucceeded=function(){var a=this;Object.keys(this.$2).forEach(function(b){a.$2[b]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete}});this.$5=!0;this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete);this.$1={};this.$2={}};b.$14=function(){var a=this;Object.keys(this.$2).forEach(function(b){a.$2[b]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete}});this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Failed);this.$1={};this.$2={}};b.maybeNotifyUI=function(){this.$16()};b.$11=function(a,b){d("MAWBridge").getBridge().fireAndForget("event","offlineSnapshot",{downloaded:{count:this.$7,message:this.$9},expected:{count:this.$6,message:this.$8},status:a,timestamp:b!=null?b:d("MAWQplProxy").performanceAbsoluteNow()})};b.$15=function(a){var b=d("MAWQplProxy").performanceAbsoluteNow();b={chatJidStatus:this.$2,startTime:this.$10!=null?this.$10:null,status:a,timestamp:b,totalExpectedCount:this.$6,totalProcessedCount:this.$3};m.LOG(j(),JSON.stringify(b));a===d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete?c("promiseDone")(d("MAWBridge").getBridge().sendAndReceive("event","offlineConsumerProgress",b),function(){m.LOG(i())},function(a){m.ERROR(h(),a)}):d("MAWBridge").getBridge().fireAndForget("event","offlineConsumerProgress",b)};return a}();b=new a();g.ConsumerUINotifier=a;g.offlineResumeUINotifier=b}),98);
__d("MAWLoadGroupInvitesTxns",["MAWBridgeTypesCreators","MAWDbGroupInviteTxns","MAWDexieTable","MAWIndexedDb","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=[],e=d("WAGlobals").getMyUserJid();b.forEach(function(b){return d("WAJids").switchOnMsgrChatJidType(b.jid,{group:function(){c.push(d("MAWDbGroupInviteTxns").getGroupInvitesByThreadAndInvitedParticipant(a,b.jid,e))},user:function(){}})});return d("MAWDexieTable").dexieAll(c).then(function(a){a.forEach(function(a,b){a.forEach(function(b,a){d("MAWIndexedDb").afterTransaction({tag:"GroupInviteUpdate",value:d("MAWBridgeTypesCreators").createBridgeGroupInvite(b)})})})})}g.loadGroupInvites=a}),98);
__d("MAWLoadMsgsTxns",["MAWBridgeMsg","MAWBridgeMsgCountdown","MAWBridgeTypesCreators","MAWBridgeXMA","MAWDbChunkTxns","MAWDbEditMsgHistoryTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDbReactionUtils","MAWDbReactionsTxns","MAWDbXMATxns","MAWDexieTable","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWLoggerUtils","MAWMediaAfterTxns","MAWXMAUtils","WATagsLogger","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCounter: Showing UI counter for ",""]);h=function(){return a};return a}function i(a,b){return d("MAWDbMediaTxns").getMsgMediaPairFromMsgs(a,b).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b[0],e=b[1];return d("MAWDbChunkTxns").hasMediaChunk(a,e.hashedPlaintextHash).then(function(b){d("MAWMediaAfterTxns").handleNewMediaAfterTxn(c,e,b,a)})}))})}function j(a,b){return d("MAWDbXMATxns").getXMAFromMsgs(a,b).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){if(d("MAWXMAUtils").isXMAStoryReply(b.targetType))return;return d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,b.defaultPreviewMediaId).then(function(e){c("gkx")("821")?c("promiseDone")(d("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(e,b,a)):d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:d("MAWBridgeXMA").createBridgeXMA(e,b,!1)})})}))})}function k(a,b){return d("MAWDbReactionsTxns").getReactionsFromMessages(a,b).then(function(a){a.forEach(function(a){return d("MAWDbReactionUtils").dispatchReaction(a)});return a})}function a(a,b,c,e,f,g){f===void 0&&(f=!1);return d("MAWDbMsgTxns").getMsgsFromOffset(a,b,c,e,f,!1,g).then(function(b){var c=b.msgs,e=babelHelpers.objectWithoutPropertiesLoose(b,["msgs"]);return d("MAWDexieTable").dexieAll(c.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b)})).then(function(a){return babelHelpers["extends"]({msgs:c,replyMediaInfo:a},e)})}).then(function(e){var l=e.hasMoreAfter,m=e.hasMoreBefore,n=e.msgs,o=e.replyMediaInfo;e=n.map(function(a,b){if(d("MAWXMAUtils").isXMAStoryReply(a.xmaMessageType))return;return d("MAWBridgeMsg").createBridgeMsg(a,void 0,(o||[])[b])}).filter(Boolean);e.length>0&&d("MAWIndexedDb").afterTransaction({tag:"NewMsgs",value:{msgs:e}});e=n.filter(function(a){return a.ephemeralCounterStarted});e.length>0&&(d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.Countdown,d("MAWLoggerUtils").Tag.OnLoad]).LOG(h(),e.map(function(a){return a.msgId})),d("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:d("MAWBridgeMsgCountdown").createBridgeMsgsStartCountdown(e)}));(n.length>0||c==null)&&d("MAWIndexedDb").afterTransaction({tag:"MsgsLoaded",value:d("MAWBridgeTypesCreators").createBridgeMsgsLoadedInfo(b,n,f,m,l,g)});return d("MAWDexieTable").dexieAll([k(a,n),d("MAWDbEditMsgHistoryTxns").loadEditMsgHistory(a,n),i(a,n),j(a,n)]).then(function(a){a=a[0];return{hasMoreAfter:l,hasMoreBefore:m,msgs:n,reactions:a}})})}g.loadMsgsAndMediaFromOffset=a}),98);
__d("MAWLoadThreadsTxns",["FBLogger","MAWBridgeParticipants","MAWBridgeThread","MAWBridgeTypesCreators","MAWDbParticipantTxns","MAWDexieTable","MAWIndexedDb","MAWLoadGroupInvitesTxns","MAWLoadMessageRequestCapabilitiesTxns","MAWLoadMsgsTxns","MAWTransactionMode","MAWUpdateThreadSnippet","WAGlobals","WAJids","WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){f===void 0&&(f="loadContentsForThreads");b.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(a,e==null?void 0:e.get(a.jid),void 0,f)})});return d("MAWDexieTable").dexieAll([].concat(b.map(function(b){return i(a,b,c)}),[h(a,b),j(a,b),d("MAWLoadMessageRequestCapabilitiesTxns").loadMessageRequestDataForThreads(b),d("MAWLoadGroupInvitesTxns").loadGroupInvites(a,b)])).then(function(){return b})}function b(a,b,c,e){return d("MAWDexieTable").dexieAll([h(a,[c]),i(a,c,e),d("MAWUpdateThreadSnippet").loadSnippetMsg(a,c)]).then(function(e){e=e[0];b||l(a,c.jid,d("WAJids").interpretAsGroupJid(c.jid)!=null,!1,c.cannotReplyReason,c.archived);return e})}function h(a,b){return b.length===0?d("MAWDexieTable").dexieResolve([]):d("MAWDbParticipantTxns").getParticipantsInThreads(a,b.map(function(a){return a.jid})).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(a)});return a})}function i(a,b,c){return d("MAWLoadMsgsTxns").loadMsgsAndMediaFromOffset(a,b.jid,null,c,!0)}function j(a,b){var c=[];b.forEach(function(a){return d("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(a){return c.push(a)},user:function(){}})});return a.groupInfo.bulkGet(c).then(function(a){a.forEach(function(a){a!=null&&d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(a)})})})}e=function(a){a=a.threadJid;return k(a)};var k=d("MAWIndexedDb").makeMsgrTransactor({participants:d("MAWTransactionMode").READONLY},"checkIfGroupParticipant",function(a){return function(){for(var b=arguments.length,c=new Array(b),d=0;d<b;d++)c[d]=arguments[d];return l.apply(void 0,[a].concat(c))}});function l(a,b,e,f,g,h){e===void 0&&(e=!0);f===void 0&&(f=!0);var i=d("WAGlobals").getMyUserJid();return d("MAWDbParticipantTxns").getParticipant(a,b,i).then(function(a){if(!a.success){var j=e?"group":"one_to_one";d("WALogger").LOG(["[Occamadillo] User is not a participant of "+j+" thread\n        "+b.toString()+", showing a VIEWER_NOT_SUBSCRIBED composer blocker"]);if(g==null){var k;c("FBLogger")("maw_db","checkIfParticipant").catching((k=a.payload)!=null?k:c("err")(a.error)).warn("[Occamdillo] User %s is not a participant of %s thread %s, occam: %s, archived: %s, cannotReplyReason null.",i,j,b.toString(),f,h)}c("FBLogger")("labyrinth_web","checkIfParticipant").warn("[Occamdillo] User not a participant from checkIfParticipant");k={cannotReplyReason:"viewer_not_subscribed",threadJid:b};d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread(k)})}})}g.loadContentsForThreads=a;g.loadParticipantsAndMsgs=b;g.loadParticipants=h;g.loadGroups=j;g.checkIfGroupParticipant=e}),98);
__d("MAWThreadFetchAndEmitTxns",["MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLoadGroupInvitesTxns","MAWLoadMessageRequestCapabilitiesTxns","MAWLoadThreadsTxns","MAWThreadManagementTxns","WAJids","WATimeUtils","gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){f===void 0&&(f="fetchAndEmitThread");return d("WAJids").switchOnMsgrChatJidType(b,{group:function(b){return d("MAWThreadManagementTxns").getGroupThread(a,b,c).then(function(a){return a==null?null:{created:a.created,thread:a.thread}})},user:function(b){var f;return d("MAWThreadManagementTxns").getOrSetupOneToOneThread(a,{createTs:e==null?void 0:d("WATimeUtils").castUnixTimeToMillisTime(e),folder:(f=c)!=null?f:void 0,userJid:b})}}).then(function(b){return b==null||b.thread==null?null:d("MAWLoadThreadsTxns").loadContentsForThreads(a,[b.thread],1,null,f).then(function(){return b})})}function h(a,b){if(!c("gkx")("23922"))return d("MAWDexieTable").dexieResolve();b=b.map(function(b){return d("MAWDbMsgTxns").getThreadOldestMessageId(a,b.jid).then(function(a){return{oldestMsgId:a,thread:b}})});return d("MAWDexieTable").dexieAll(b).then(function(a){a.forEach(function(a){var b=a.oldestMsgId;a=a.thread;return d("MAWIndexedDb").afterTransaction({tag:"UpdateMessageRange",value:d("MAWBridgeTypesCreators").createBridgeUpdateMessageRange({newestMsgId:null,newestMsgTs:null,oldestMsgId:b,thread:a})})})})}function b(a,b){if(b.size===0)return d("MAWDexieTable").dexieResolve();b=Array.from(b);return a.threads.where("jid").anyOf(b).toArray().then(function(b){return h(a,b).then(function(){var c=b.filter(Boolean);return d("MAWDexieTable").dexieAll([d("MAWLoadThreadsTxns").loadParticipants(a,c),d("MAWLoadThreadsTxns").loadGroups(a,c),d("MAWLoadMessageRequestCapabilitiesTxns").loadMessageRequestDataForThreads(c),d("MAWLoadGroupInvitesTxns").loadGroupInvites(a,c)])})}).then(function(){})}g.fetchAndEmitThread=a;g.emitThreadContents=b}),98);
__d("MAWBulkHandleIncomingMsgApi",["MAWBulkEditMsgsTxns","MAWBulkWriteReactionsTxns","MAWDbThreadTxns","MAWDexieTable","MAWHIMLogger","MAWHandleIncomingMsgApi","MAWIndexedDb","MAWLinkReactionsToMsgsApi","MAWMsgActionType","MAWMsgType","MAWODSProxy","MAWOfflineThreadTxns","MAWPreprocessMsgs","MAWSharedOfflineQueueMetric","MAWSharedOfflineResumeUINotifier","MAWThreadFetchAndEmitTxns","MAWTransactionMode","WAMsgMap","WAOdsEnums","WAResultOrError","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Should never have 'write' and 'delete' in same OQ batch"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Should never have 'update ciphertext' and 'delete' in same OQ batch"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handling message with StanzaID ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handling "," messages"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot create thread for message. Reason: ",". StanzaID ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot create thread for message. Reason: ","."]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Previous message processing action failed so subsequent one can't succeed"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["ERROR!!! At this point we must have fields in the map, ",""]);o=function(){return a};return a}var p=c("gkx")("2014");function a(a){var b;return d("MAWIndexedDb").makeMsgrTransactor({chunk:(b=d("MAWTransactionMode")).READWRITE,deletedMessages:b.READWRITE,deviceChangeAlerts:b.READWRITE,editMsgHistory:b.READWRITE,ephemeralSettings:b.READWRITE,existingUsers:b.READWRITE,ftsBackloggedMessages:b.READWRITE,ftsPurgeBacklog:b.READWRITE,groupInfo:b.READWRITE,groupInvites:b.READWRITE,media:b.READWRITE,mediaBackup:b.READWRITE,messages:b.READWRITE,participants:b.READWRITE,pendingReceipts:b.READWRITE,pendingStanzas:b.READWRITE,reactions:b.READWRITE,threads:b.READWRITE,unrenderedMessages:b.READWRITE,xma:b.READWRITE},"bulkHandleIncomingMsgs",function(b){return function(){var e=d("MAWDexieTable").dexieResolve(),f=new(d("WAMsgMap").MsgMap)();d("MAWODSProxy").odsBumpEntityKey({amount:a.length,entity:d("WAOdsEnums").Entity.TOTAL_INCOMING_MESSAGE,key:"msgs"});d("MAWDexieTable").setDexiePSDItem("offlineQueueSize",a.length);var g=new Set(a.map(function(a){a=a.msgData;return a.id.chat})),h=d("MAWPreprocessMsgs").classifyIncomingMsgs(a),i=h.editActionMsgs,j=h.reactionMsgs,k=function(a,b){var e=f.get(a);if(!b.success)f.set(a,b);else if(e==null)c("MAWHIMLogger").ERROR(o(),b);else if(!e.success)c("MAWHIMLogger").WARN(n());else if(p)f.set(a,d("WAResultOrError").makeResult(babelHelpers["extends"]({},e.value,b.value)));else{e=e.value;b=b.value;(b==null?void 0:b.outOfSyncEphemeralSetting)!=null&&(e=babelHelpers["extends"]({},e,{outOfSyncEphemeralSetting:b.outOfSyncEphemeralSetting}));if((b==null?void 0:b.plaintextHashs)!=null){var g;e=babelHelpers["extends"]({},e,{plaintextHashs:(g=e.plaintextHashs)!=null?g:b.plaintextHashs})}(b==null?void 0:b.reactToExternalId)!=null&&(e=babelHelpers["extends"]({},e,{reactToExternalId:b.reactToExternalId}));e=babelHelpers["extends"]({},e,{msgType:(g=(g=e)==null?void 0:g.msgType)!=null?g:b==null?void 0:b.msgType});f.set(a,d("WAResultOrError").makeResult(e))}};return q(b,g).then(function(h){var n=h.threadCreationResult,o=h.threads,q=function(a,b){f.set(a,d("WAResultOrError").makeResult({protocolMsgId:a,unknownGroup:b==="missing"}))};h=d("MAWDexieTable").dexieAll(a.map(function(a){var e;e=[o.get(a.msgData.id.chat),(e=n.get(a.msgData.id.chat))!=null?e:"missing"];var f=e[0];e=e[1];if(f==null){c("MAWHIMLogger").ERROR(m(),e);c("MAWHIMLogger").WARN(l(),e,a.msgData.id.externalId);return}q(a.msgData.id,e);return d("MAWPreprocessMsgs").getMessageDataByType(b,a,f)}).filter(Boolean))["catch"](function(a){a.message="[getAllMessagesProcessingData] "+a.message;throw a});return d("MAWDexieTable").dexieAll([d("MAWBulkWriteReactionsTxns").prepareReactionsData(b,j),h]).then(function(a){var c=a[0],h=a[1];return d("MAWBulkWriteReactionsTxns").bulkWriteReactions(b,c).then(function(){var a=p?t(h):h;a.forEach(function(a){e=e.then(function(){return d("MAWHandleIncomingMsgApi").handleIncomingMsg(b,a)}).then(function(b){k(a.id,b),r(a.id,a.ts)})});e["catch"](function(a){a.message="[writeIncomingMsgs] "+a.message;throw a});return e}).then(function(){var a=i.length===0?d("MAWDexieTable").dexieResolve():d("MAWBulkEditMsgsTxns").prepareDataForMessageEdit(b,i).then(function(a){return d("MAWBulkEditMsgsTxns").bulkEditMsgs(b,i,a)});return a.then(function(){return d("MAWThreadFetchAndEmitTxns").emitThreadContents(b,g).then(function(){return{msgResults:f}})})})})})}})().then(function(a){var b=new Set();a.msgResults.values().forEach(function(a){if(a.success){a=a.value;(a==null?void 0:a.reactToExternalId)!=null?b.add(a.reactToExternalId):(a==null?void 0:a.protocolMsgId)!=null&&b.add(a.protocolMsgId.externalId)}});return d("MAWLinkReactionsToMsgsApi").linkReactionsToMsgs(Array.from(b)).then(function(){return a})})}function q(a,b){var c=Array.from(b);return d("MAWDbThreadTxns").getThreads(a,c).then(function(b){return d("MAWOfflineThreadTxns").createAllThreadsForOfflineMsgs(a,c,b)})}function r(a,b){var c;a=a.chat.toString();d("MAWSharedOfflineResumeUINotifier").offlineResumeUINotifier.updateChatState((c={},c[a]=b,c));d("MAWSharedOfflineResumeUINotifier").offlineResumeUINotifier.addMAWEntity(1);(a=d("MAWSharedOfflineQueueMetric").getOfflineQueueMetric())==null?void 0:a.addMAWEntity(1)}var s=c("MAWHIMLogger").TAGS(["MergeActions"]);function t(a){s.LOG(k(),a.length);var b=new(d("WAMsgMap").MsgMap)();for(var c=0;c<a.length;c++){var e=a[c];s.LOG(j(),e.id.externalId);e.receiveFlow.addPoint("him_merge_actions");var f=b.get(e.id);if(f==null){b.set(e.id,e);continue}if(f.action===e.action&&f.type===e.type){e.receiveFlow.addAnnotations({bool:{merge_actions_duplicate:!0}});continue}switch(e.action){case d("MAWMsgActionType").MSG_ACTION.NO_ACTION:continue;case d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT:case d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED:if(f.action===d("MAWMsgActionType").MSG_ACTION.REVOKE||f.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME){s.ERROR(i());continue}b.set(e.id,e);continue;case d("MAWMsgActionType").MSG_ACTION.WRITE:case d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED:if(f.action===d("MAWMsgActionType").MSG_ACTION.REVOKE||f.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME){s.ERROR(h());continue}switch(e.type){case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:break;case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:f.type===d("MAWMsgType").MSG_TYPE.UNAVAILABLE&&b.set(e.id,e);break;default:b.set(e.id,e)}break;case d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME:case d("MAWMsgActionType").MSG_ACTION.REVOKE:f.action!==d("MAWMsgActionType").MSG_ACTION.REVOKE&&b.set(e.id,e);break}}f=[];for(e=0;e<a.length;e++){var g;c=a[e];var l=b.get(c.id);c.receiveFlow.addAnnotations({string:{final_action:(g=l==null?void 0:l.action)!=null?g:"undefined",initial_action:c.action}});if(l==null||l.action===d("MAWMsgActionType").MSG_ACTION.NO_ACTION)continue;f.push(l);b["delete"](c.id)}return f}g.bulkHandleIncomingMsgs=a}),98);
__d("MAWConvertXMATargetTypeToExtendedContentTargetType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaTargetType: ",""]);h=function(){return a};return a}function a(a){switch(a){case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_MENTION:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_IMAGE_POST_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_MULTIPOST_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_VIDEO_POST_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_CLIPS_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_IGTV_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_SHOP_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_PROFILE_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_HIGHLIGHT_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_HIGHLIGHT_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REPLY:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REACTION:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_REPLY:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_MENTION:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_VIDEO_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_GAMING_CUSTOM_UPDATE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_PRODUCER_STORY_REPLY:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY;case d("EchoMessageXMAFieldUtils").XMAContentType.MSG_EXTERNAL_LINK_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_AUDIO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_VIDEO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_AUDIO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_VIDEO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_AUDIO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_VIDEO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_EVENT:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT;case d("EchoMessageXMAFieldUtils").XMAContentType.MSG_RECEIVER_FETCH:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH;default:d("WALogger").ERROR(h(),a);return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE}}g.convertXMATargetTypeToExtendedContentTargetType=a}),98);
__d("MAWHandleEchoMsgsRestoreApiUtils",["$InternalEnum","EchoMessage","EchoMessageMediaFieldUtils","MAWAckLevel","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWJids","MAWMsgType","MAWRepliesRestoreUtils","WAJids","WAStanzaUtils","WATagsLogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Message content is empty for the message: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Author info is missing from msg: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] thread has unsupported message type: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] thread has unsupported message content type: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] thread has unsupported message content type: ",", xContentType: ",",\n      subcontent type: "," ,\n      origin: ",""]);l=function(){return a};return a}c=b("$InternalEnum")({INITIAL_RESTORE:"initial_restore",POINT_RESTORE:"point_restore",PAGINATED_RESTORE:"paginated_restore"});function m(a,b){var c,e=a.contentType;switch(e){case d("EchoMessage").EchoMessageContentType.TEXT:return a.xContentType===d("EchoMessage").EchoXMessageContentType.BUMP?d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:d("MAWMsgType").MSG_TYPE.TEXT;case d("EchoMessage").EchoMessageContentType.MEDIA:return n(a);case d("EchoMessage").EchoMessageContentType.PLACEHOLDER:if(a.contentSubtype===d("EchoMessage").EchoMessageContentSubtype.UNSEND)return d("MAWMsgType").MSG_TYPE.REVOKED;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(c=b)!=null?c:""]).ERROR(l(),d("EchoMessage").EchoMessageContentType.getName(e),a.xContentType!=null?d("EchoMessage").EchoXMessageContentType.getName(a.xContentType):"unknown",d("EchoMessage").EchoMessageContentSubtype.getName(a.contentSubtype),a.serializationOrigin!=null?d("EchoMessage").EchoSerializationOriginType.getName(a.serializationOrigin):"unknown");break;case d("EchoMessage").EchoMessageContentType.XMA:return d("MAWMsgType").MSG_TYPE.XMA;case d("EchoMessage").EchoMessageContentType.DECRYPTION_FAILURE:return d("MAWMsgType").MSG_TYPE.CIPHERTEXT;default:d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(c=b)!=null?c:""]).ERROR(k(),d("EchoMessage").EchoMessageContentType.getName(e))}return null}function n(a,b){a=a.mediaData;if(a!=null){switch(a.attachmentType){case d("EchoMessageMediaFieldUtils").AttachmentType.IMAGE:return d("MAWMsgType").MSG_TYPE.IMAGE;case d("EchoMessageMediaFieldUtils").AttachmentType.STICKER:return d("MAWMsgType").MSG_TYPE.STICKER;case d("EchoMessageMediaFieldUtils").AttachmentType.VIDEO:return d("MAWMsgType").MSG_TYPE.VIDEO;case d("EchoMessageMediaFieldUtils").AttachmentType.GIF:return d("MAWMsgType").MSG_TYPE.GIF;case d("EchoMessageMediaFieldUtils").AttachmentType.PTT:return d("MAWMsgType").MSG_TYPE.PTT;case d("EchoMessageMediaFieldUtils").AttachmentType.XMA:return d("MAWMsgType").MSG_TYPE.XMA;case d("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT:return d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE}d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(b=b)!=null?b:""]).ERROR(j(),d("EchoMessageMediaFieldUtils").AttachmentType.getName(a.attachmentType))}return null}function a(a,b,c,e,f){var g=a.from;if(g==null){var h;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(h=f)!=null?h:""]).ERROR(i(),e);return null}h=m(a,f);if(h==null||a.isTombstoned!=null&&a.isTombstoned)return null;switch(h){case d("MAWMsgType").MSG_TYPE.TEXT:case d("MAWMsgType").MSG_TYPE.REVOKED:case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:return s(a,b,c,g,h,e,f);case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return o(a,b,c,g,h,e);case d("MAWMsgType").MSG_TYPE.XMA:return q(a,b,c,g,h,e);case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return v(a,b,c,g,h,e)}return null}function o(a,b,c,d,e,f){a=t(a,b,c,d,e,f);return p(e,a)}function p(a,b){switch(a){case d("MAWMsgType").MSG_TYPE.IMAGE:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.IMAGE});case d("MAWMsgType").MSG_TYPE.STICKER:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.STICKER});case d("MAWMsgType").MSG_TYPE.VIDEO:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.VIDEO});case d("MAWMsgType").MSG_TYPE.GIF:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.GIF});case d("MAWMsgType").MSG_TYPE.PTT:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.PTT});case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE})}}function q(a,b,c,e,f,g){b=t(a,b,c,e,f,g);c=a.text;if(a.xmaData!=null&&a.xmaData.xmaTargetType!=null){e=babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:d("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(a.xmaData.xmaTargetType)});c!=null&&(e.msgContent={content:c});return e}return null}function r(a){if(a==null)return void 0;else switch(a){case d("EchoMessage").MessageTextSize.SMALL:return 1;case d("EchoMessage").MessageTextSize.MEDIUM:return 2;case d("EchoMessage").MessageTextSize.LARGE:return 3;default:return void 0}}function s(a,b,c,e,f,g,i){var j=a.text;if(j==null){var k;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(k=i)!=null?k:""]).ERROR(h(),g);return null}k=t(a,b,c,e,f,g,i);if(f===d("MAWMsgType").MSG_TYPE.REVOKED){j!=null&&(k.msgContent={content:j});a.revokeSentTimestampMs!=null&&(k.originalTs=d("WATimeUtils").castToUnixTime(a.revokeSentTimestampMs));return babelHelpers["extends"]({},k,{revokedExternalId:d("WAStanzaUtils").toStanzaId("0"),type:d("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:a.revokeUnsentTimestampMS!=null?d("WATimeUtils").castToUnixTime(a.revokeUnsentTimestampMS):k.ts})}else if(f===d("MAWMsgType").MSG_TYPE.CIPHERTEXT)return babelHelpers["extends"]({},k,{msgContent:{content:j},specialTextSize:r(a.textSize),type:d("MAWMsgType").MSG_TYPE.CIPHERTEXT});else{b=babelHelpers["extends"]({},k,{msgContent:{content:j},specialTextSize:r(a.textSize),type:d("MAWMsgType").MSG_TYPE.TEXT});return babelHelpers["extends"]({},b,{editCount:Math.max(a.editHistory.length-1,0),groupId:a.groupId,groupIndex:a.groupIndex,groupSize:a.groupSize})}}function t(a,b,c,e,f,g,h){h=u(e,c);e={ack:h===d("WAJids").AUTHOR_ME?d("MAWAckLevel").ACK.sent:d("MAWAckLevel").ACK.received,altIndex:void 0,author:h,externalId:g,groupId:a.groupId,groupIndex:a.groupIndex,groupSize:a.groupSize,isForwarded:a.isForwarded,sortOrderMs:a.sortOrderMs,threadJid:b,ts:d("WATimeUtils").castToUnixTime(a.displayTimestampMs/1e3),type:f};a.authoritativeTimestampMs!=null?e.serverTs=d("WATimeUtils").castToUnixTime(a.authoritativeTimestampMs/1e3):e.serverTs=d("WATimeUtils").castToUnixTime(a.sortOrderMs/1e3);if(a.quoteData!=null){h=d("MAWRepliesRestoreUtils").getQuoteDataFromEchoMessage(a,c);h!=null&&(e.quote=h,e.quoteExternalId=h.content.externalId)}return e}function u(a,b){a=d("MAWJids").toUserJid(a.localKey);return a===b?d("WAJids").AUTHOR_ME:a}function v(a,b,c,e,f,g){a=t(a,b,c,e,f,g);return babelHelpers["extends"]({},a,{type:d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE})}g.MAWRestoreType=c;g.getDbMsgTypeFromEchoMessage=m;g.getUnstoredDbMessageFromEchoMessage=a;g.resolveAuthorFromEchoAddress=u}),98);
__d("MAWRepliesRestoreUtils",["EchoEncodingUtils","FBLogger","MAWBridgeMsg","MAWDexieTable","MAWGetMsgQuoteTxn","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","MAWTransactionMode","MAWUpdateQuotedMsgTxns","WALogger","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Quote data is missing for message: ",""]);h=function(){return a};return a}function a(a,b){if(b==null||!d("MAWMsgType").isQuotedMsgType(b.type))return a;else{b={author:b.author,externalId:b.externalId,ts:b.ts,type:b.type};b={content:b,remoteJid:null};return babelHelpers["extends"]({},a,{quote:b})}}function b(a,b){if(a.quoteData!=null&&a.quoteData.quoteMessageId!=null&&a.quoteData.quoteMessageSender!=null){b={author:d("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(a.quoteData.quoteMessageSender,b),externalId:(b=a.quoteData)==null?void 0:b.quoteMessageId,ts:a.displayTimestampMs,type:c("gkx")("458")?(b=d("EchoEncodingUtils").convertXMessageContentTypeToDbMsgType(a.xContentType))!=null?b:d("MAWMsgType").MSG_TYPE.TEXT:d("MAWMsgType").MSG_TYPE.TEXT};return{content:b,remoteJid:null}}else d("WALogger").ERROR(h(),a.messageId);return null}f=d("MAWIndexedDb").makeMsgrTransactor({chunk:(e=d("MAWTransactionMode")).READONLY,media:e.READONLY,messages:e.READWRITE,threads:e.READWRITE,xma:e.READONLY},"updateQuoteDataForReplyMessages",function(a){return function(b,c){c==null?void 0:c.addPoint("replies_restore_start");b=b.restoredMsgsData;if(b){var e=b.existingMsgs;b=b.newlyAddedMsgs;b=b.concat(e);return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWUpdateQuotedMsgTxns").associateQuotedMessage(a,b.threadJid,b).then(function(a){var c=[];b.quoteExternalId!=null&&c.push(b);a!=null&&c.push.apply(c,a);return c})})).then(function(b){b=b.reduce(function(a,b){return b.length>0?a.concat(b):a},[]);return i(a,b)}).then(function(a){c==null?void 0:c.addPoint("replies_restore_end",{"int":{replies:a}});return a})}return d("MAWDexieTable").dexieResolve(0)}});function i(a,b){return d("MAWDexieTable").dexieAll(b.map(function(b){var e=j(b);if(b.threadJid!=null)return d("MAWGetMsgQuoteTxn").enhanceMsgWithQuoteInfo(a,e,b.threadJid).then(function(a){return babelHelpers["extends"]({},a,{msgId:b.msgId,originalTs:b.originalTs,rowId:b.rowId,threadJid:b.threadJid,unsendMsgContentDeleteTs:b.unsendMsgContentDeleteTs})});else c("FBLogger")("labyrinth_web","thread_id_absent").mustfix("Reply restore: threadId cannot be null for a restored msg")})).then(function(a){return a.filter(Boolean).filter(function(a){return a.quote!=null})}).then(function(b){return a.messages.bulkPut(b).then(function(c){return b.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,void 0,a,"EncryptedBackups")})})})}).then(function(a){return(a=b==null?void 0:b.length)!=null?a:0})})}function j(a){a.msgId;a.originalTs;a.rowId;a.threadJid;a.unsendMsgContentDeleteTs;a=babelHelpers.objectWithoutPropertiesLoose(a,["msgId","originalTs","rowId","threadJid","unsendMsgContentDeleteTs"]);return a}g.addQuoteDataToReplyMessage=a;g.getQuoteDataFromEchoMessage=b;g.updateQuoteDataForReplyMessages=f;g.enhanceAndPersistReplyMessagesWithQuoteData=i}),98);
__d("MAWHandleEchoReactionsRestore",["MAWAckLevel","MAWAuthor","MAWBulkWriteReactionsTxns","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWTransactionMode","Promise","WAJids","WALogger","WAStanzaUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction fields in backup data uneven in length"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reactToAuthor field is null"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction external id missing"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction string is not a single character"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions empty author"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions for system author"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] echo document is absent for a restored msg"]);o=function(){return a};return a}function a(a,c,d){d==null?void 0:d.addPoint("reactions_restore_start");var e=a.echoMsgMap,f=a.restoredMsgsData,g=0;if(f){a=f.existingMsgs;var i=f.newlyAddedMsgs;i=i.concat(a);var j=f.threadJid;a=i.filter(function(a){var b=e.get(a.externalId);return q(e,a)&&b!=null&&r(b)});if(a.length===0)return(h||(h=b("Promise"))).resolve();var k=a.flatMap(function(a){var b=e.get(a.externalId);a=u(f.threadJid,c,a.externalId,a.msgId,a.author,b);return a.map(function(a){return{chatJid:j,unstoredReaction:a}})});return k.length===0?(h||(h=b("Promise"))).resolve():p(k).then(function(a){g+=k.length,d==null?void 0:d.addPoint("reactions_restore_end",{"int":{reactions:g}})})}return(h||(h=b("Promise"))).resolve()}var p=d("MAWIndexedDb").makeMsgrTransactor({groupInfo:(c=d("MAWTransactionMode")).READWRITE,messages:c.READWRITE,reactions:c.READWRITE,threads:c.READWRITE},"restoreWriteReactionsToDb",function(a){return function(b){return d("MAWBulkWriteReactionsTxns").prepareReactionsData(a,b).then(function(b){return d("MAWBulkWriteReactionsTxns").bulkWriteReactions(a,b)})}});function q(a,b){a=a.get(b.externalId);if(a==null){d("WALogger").ERROR(o());return!1}if(d("WAJids").isAuthorSystem(b.author)){d("WALogger").ERROR(n());return!1}if(d("MAWAuthor").getAuthorUserJid(b.author)==null){d("WALogger").ERROR(m());return!1}return!0}function r(a){return a.reactions!=null&&a.reactions.length!==0&&a.reactionXOfflineThreadingIds!=null&&a.reactionXOfflineThreadingIds.length!==0&&a.reactionAuthoritativeTimestampMs!=null&&a.reactionAuthoritativeTimestampMs.length!==0}function s(a,b,c){if((a==null?void 0:a.length)===0){d("WALogger").ERROR(l());return!1}if(b==null){d("WALogger").ERROR(k());return!1}if(c==null){d("WALogger").ERROR(j());return!1}return!0}function t(a,b,c){return(a||[]).map(function(a,e){if(c==null||b==null||(c==null?void 0:c.length)<=e||(b==null?void 0:b.length)<=e){d("WALogger").WARN(i());return[]}return[a,b[e],c[e]]})}function u(a,b,c,e,f,g){var h=d("MAWAuthor").getAuthorUserJid(f);if(g==null||h==null)return[];var i=g.reactionAuthoritativeTimestampMs;i=i===void 0?[]:i;var j=g.reactionXOfflineThreadingIds;j=j===void 0?[]:j;g=g.reactions;return t(g,j,i).filter(function(a){var b=a[0];a=a[1];return a!=null&&s(b.displayName,a.displayName,d("MAWAuthor").getAuthorUserJid(f))}).map(function(f){var g=f[0],i=f[1];f=f[2];var j=g.displayName;g=d("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(g,b);g={ack:g===d("WAJids").AUTHOR_ME?d("MAWAckLevel").ACK.sent:d("MAWAckLevel").ACK.received,author:g,externalId:d("WAStanzaUtils").toStanzaId(i.displayName||""),groupingKey:j,reaction:j,reactToAuthor:h,reactToExternalId:c,senderTimestampMs:null,threadJid:a,ts:d("WATimeUtils").castToUnixTime(Number(f.displayName)/1e3)};return e!=null?babelHelpers["extends"]({},g,{reactToMsgId:e}):g})}g.writeEchoReactionsToReactionsStore=a;g.getReactionsForReactionStore=u}),98);
__d("isUseridAnnotationEnabled",["gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(){return c("gkx")("24163")}g["default"]=a}),98);
__d("MAWUserHash",["MAWCurrentUser","WAGlobals","WAJids","isUseridAnnotationEnabled"],(function(a,b,c,d,e,f,g){"use strict";function a(){return d("MAWCurrentUser").isEmployee()&&c("isUseridAnnotationEnabled")()?d("WAJids").extractUserId(d("WAGlobals").getMyUserJid()).slice(-5):null}g.getUserHash=a}),98);
__d("WAServerRPCLogger",["WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";a=d("WATagsLogger").TAGS(["ServerRPC"]);g.logger=a}),98);
__d("MAWIncomingMsg",["MAWUserHash","WAGetPlatformFromStanzaId","WAHashStringToNumber","WAServerRPCLogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";a=d("WAServerRPCLogger").logger.TAGS(["HandleIncomingMsg"]);b=function(a){var b=a.encTypes,c=a.incomingType,e=a.msg,f=a.queueType;a=a.retryCount;return{"int":{messageAge:d("WATimeUtils").unixTime()-e.ts,msgId:d("WAHashStringToNumber").hashStringToNumber(e.externalId.toString()),offlineDelivery:e.offline,retryCount:a},string:{e2eePlatform:d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(e.externalId),incomingType:c,jid:e.from.chat,msgType:e.type,queueType:f,threadType:e.from.type,userHash:d("MAWUserHash").getUserHash()},string_array:{encTypes:b}}};g.logger=a;g.prepareAnnotationsForIncomingMessage=b}),98);
__d("MAWProtocolQueueMsg",["MAWBulkHandleIncomingMsgApi","MAWHIMLogger","MAWMsgType","MAWXMALoggingUtils","MAWXMAUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot have null result for non-invisible msgs"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handle: "," msgs: done"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handle: "," msgs"]);j=function(){return a};return a}function a(a){var b=new Set(),e=a.map(function(a){var c,e=a.decodedMsg,f=a.receiveFlow;a=a.stanza;var g=a.message.decrypted,h=d("MAWXMALoggingUtils").getXmaTargetTypeStringFromEnum(e==null?void 0:e.xmaTargetTypeForLogging);f.addAnnotations({bool:{furuteproof:(e==null?void 0:(c=e.unstoredDbMsg)==null?void 0:c.type)===d("MAWMsgType").MSG_TYPE.FUTUREPROOF},"int":{xmaTargetType:(c=e==null?void 0:e.xmaTargetTypeForLogging)!=null?c:-1},string:{contentType:(c=e==null?void 0:e.contentTypeForLogging)!=null?c:"",xmaTargetTypeString:h}});if(d("MAWXMAUtils").isRtcXMA(e==null?void 0:(c=e.unstoredXMA)==null?void 0:(h=c.unstoredDbXMA)==null?void 0:h.targetType)){f.endFail("rtc_xma_not_supported");b.add(a.stanzaQueueId);return null}if(g.type==="InstamadilloMsg"){f.endFail("instamadillo_not_supported");b.add(a.stanzaQueueId);return null}if(g.type==="InvisibleMsg"){b.add(a.stanzaQueueId);return null}return{msgData:g,receiveFlow:f,unstoredContent:e}}).filter(Boolean);c("MAWHIMLogger").LOG(j(),e.length);return d("MAWBulkHandleIncomingMsgApi").bulkHandleIncomingMsgs(e).then(function(d){var f=d.msgResults;c("MAWHIMLogger").LOG(i(),e.length);a.map(function(a){a=a.stanza;var d=f.get(a.message.decrypted.id);if(d==null){b.has(a.stanzaQueueId)||c("MAWHIMLogger").ERROR(h());return}d.success===!0&&b.add(a.stanzaQueueId)});return{followUpParams:{incomingMsgResults:f,incomingMsgs:a},toAck:Array.from(b)}})["catch"](function(b){var c="Not an Error instance",d="N/A";typeof b.message==="string"&&(c=b.message);typeof b.stack==="string"&&(d=b.stack);a.forEach(function(a){a.receiveFlow.endFail("consumer_handle_message_transaction_error",{string:{errorDescription:c,errorStack:d}})});throw b})}g.handleIncomingMessagesStanzas=a}),98);
__d("MAWProtocolQueueUtils",["MAWIncomingMsg","WAGetStorageQplAnnotations","WAHashStringToNumber","WAPREList","WAPREMetrics","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){b===void 0&&(b=d("WAPREList").PRE_METRIC.RECEIVE_MESSAGE);var e=a.stanza,f=d("WAPREMetrics").startMetric(b,d("MAWIncomingMsg").prepareAnnotationsForIncomingMessage({incomingType:e.incomingType,msg:e.message.details,queueType:e.message.details.offline!=null?"offline":"online",retryCount:e.message.details.retryCount}),d("WAHashStringToNumber").hashStringToNumber(e.stanzaId.toString()),d("WAPREMetrics").QPL_RECEIVE_MESSAGE_TIMEOUT_IN_MS);c("promiseDone")(d("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(a){f.addAnnotations(a)}));f.addPoint("consumer_handle_message_stanza_start");return babelHelpers["extends"]({},a,{receiveFlow:f})}function a(a){return h({decodedMsg:void 0,stanza:a})}g.addMetricToMessage=h;g.addMetricToProtocolMessage=a}),98);/*FB_PKG_DELIM*/
__d("MAWThreadKeyUtils",["I64"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return(h||(h=d("I64"))).to_string(a)}function b(a){return a}function c(a){return(h||(h=d("I64"))).of_string(a)}function e(a){return a}g.stringThreadKeyFromThreadKey=a;g.stringThreadKeyFromString=b;g.stringThreadKeyToI64=c;g.stringThreadKeyToString=e}),98);
__d("EncryptedBackupsDYIGenerateThreadMetadata",["CurrentUser","EncryptedBackupsDYISingleton","I64","IGDWebUtils","LSMessagingThreadTypeUtil","MAWThreadKeyUtils","Promise","ReQL","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot find thread id for thread key ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot find thread id for thread key ",""]);k=function(){return a};return a}function l(){return d("IGDWebUtils").isOnInstagramWeb()?(i||(i=d("I64"))).of_string(c("CurrentUser").getEIMU()):(i||(i=d("I64"))).of_string(c("CurrentUser").getAccountID())}function m(a,b){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.threads).getKeyRange(d("MAWThreadKeyUtils").stringThreadKeyToI64(b)))}function n(a,b){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.contacts).getKeyRange(b))}function a(a,b){return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.contacts).filter(function(a){return b.has((i||(i=d("I64"))).to_string(a.id))}))}function o(a,b){var c;return(c=d("ReQL")).toArrayAsync(c.leftJoin(c.fromTableAscending(a.tables.participants,["contactId"]).getKeyRange(b),c.fromTableAscending(a.tables.contacts,["name"])))}function p(a){return d("LSMessagingThreadTypeUtil").isOneToOne(a)||d("LSMessagingThreadTypeUtil").isOpenOneToOne(a)}function q(a,b,c){if(c!=null&&c.trim()!=="")return c+"_"+b;switch(a.length){case 0:return"Thread_"+b;case 1:return a[0]+"_"+b;case 2:return a[0]+"and"+a[1]+"_"+b;case 3:return""+a[0]+a[1]+"and"+a[2]+"_"+b;case 4:return""+a[0]+a[1]+a[2]+"and1other_"+b;default:return""+a[0]+a[1]+a[2]+"and"+(a.length-3)+"others_"+b}}function r(a,b,c,d,e,f){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g){var h=[],j=[f];f=(yield m(c,a));if(f!=null)if(p(f.threadType)){var l=b.getThreadIdForThreadKey(a);if(l==null){b.getLogger().WARN(k(),a);return}l=(yield n(c,(i||(i=d("I64"))).of_string(l)));(l==null?void 0:l.id)!=null&&(l==null?void 0:l.name)!=null&&b.setContactNameForContactId((i||(i=d("I64"))).to_string(l.id),l.name);l=(l==null?void 0:l.name)||"Unknown User";h.push(l);j.push(l);b.setThreadMetaDataByThreadKey(a,j,q(h,g,f.threadName))}else{l=(yield o(c,f.threadKey));l.forEach(function(a){var c=a[0];a=a[1];(c==null?void 0:c.contactId)!=null&&(a==null?void 0:a.name)!=null&&b.setContactNameForContactId((i||(i=d("I64"))).to_string(c.contactId),a.name);if(!(i||(i=d("I64"))).equal(c.contactId,e)){c=(a==null?void 0:a.name)||"Unknown User";h.push(c);j.push(c)}});b.setThreadMetaDataByThreadKey(a,j,q(h,g,f.threadName))}else b.setThreadMetaDataByThreadKey(a,j,q(h,g))});return s.apply(this,arguments)}function e(a){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c,e=d("EncryptedBackupsDYISingleton").getSingleton(),f=e.getLogger(),g=(yield e.getDB()),k=(yield n(g,l())),m=(c=k==null?void 0:k.id)!=null?c:(i||(i=d("I64"))).zero,o=(c=k==null?void 0:k.name)!=null?c:"Me";e.setContactNameForContactId((i||(i=d("I64"))).to_string(m),o);return a.reduce(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){yield a;a=e.getThreadIdForThreadKey(b);a==null&&void f.WARN(j(),b);return r(b,e,g,m,o,c)});return function(b,c,d){return a.apply(this,arguments)}}(),(h||(h=b("Promise"))).resolve())});return t.apply(this,arguments)}g.getAllUnmappedContacts=a;g.EncryptedBackupsDYIGenerateThreadMetadata=e}),98);
__d("EncryptedBackupsDYIZipUtils",["EncryptedBackupsDYIFileUtils","Promise","asyncToGeneratorRuntime","jszip"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){var f=new(c("jszip"))();for(a of a){var g=a.threadName+".json";f.file(g,JSON.stringify(a,null,2))}var i=(yield d("EncryptedBackupsDYIFileUtils").getMediaFolderHandle());yield (h||(h=b("Promise"))).all(e.map(function(a){return j(f,i,a)}));return f.generateAsync({compression:"DEFLATE",compressionOptions:{level:6},type:"blob"})});return i.apply(this,arguments)}function j(a,b,c){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){var e=c.split("/").pop();b=(yield d("EncryptedBackupsDYIFileUtils").readFile(b,e));a.file(c,b)});return k.apply(this,arguments)}g.generateZipFile=a}),98);
__d("EncryptedBackupsDYISingleton",["EncryptedBackupsDYIFileUtils","EncryptedBackupsDYIGenerateThreadMetadata","EncryptedBackupsDYISingletonFactory","EncryptedBackupsDYITypes","EncryptedBackupsDYIZipUtils","FBLogger","I64","LSIntEnum","MAWBridge","MAWQplProxy","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["DYI Exiting Early - Found "," instamadillo threads"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Updating DYI status with state BACKUP_RESTORE_SUCCESSFUL"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Writing file to user storage"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Generating zip file"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Generating output"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Fetched remaining contact names, total of "," contacts"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose([""," attachments left"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["DYI flow complete - generating output"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose([""," threads left"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["DYI flow complete - generating output"]);s=function(){return a};return a}var t=null;function u(){try{return WorkerGlobalScope!==void 0&&self instanceof WorkerGlobalScope}catch(a){return!1}}function a(a,b,e){if(t==null)switch(a){case d("EncryptedBackupsDYITypes").EncryptedBackupsDYIConfig.Armadillo:if(u())throw c("FBLogger")("labyrinth_web").mustfixThrow("EncryptedBackupsDYISingleton for Armadillo can only be initialised in the main thread");t=d("EncryptedBackupsDYISingletonFactory").getMAWEncryptedBackupsDYISingleton(b,e);break;case d("EncryptedBackupsDYITypes").EncryptedBackupsDYIConfig.Instamadillo:if(!u())throw c("FBLogger")("labyrinth_web").mustfixThrow("EncryptedBackupsDYISingleton for Instamadillo can only be initialised in the worker");t=d("EncryptedBackupsDYISingletonFactory").getIGDEncryptedBackupsDYISingleton(b,e);break}}function e(){if(t==null)throw c("FBLogger")("labyrinth_web").mustfixThrow("EncryptedBackupsDYISingleton is not initialised. Please call EncryptedBackupsDYISingleton.initSingleton() first.");return t}var v=function(){var c=a.prototype;c.getDB=function(){return this.$1()};c.getLogger=function(){return this.$4};function a(a,b,c,d){this.$5=new Map(),this.$6=new Set(),this.$7=new Set(),this.$8=new Map(),this.$9=new Map(),this.$10=new Map(),this.$11=new Map(),this.$12=new Map(),this.$1=a,this.$2=b,this.$3=c,this.$4=d}c.getAllMediaUrls=function(){return Array.from(this.$5.values())};c.$13=function(a){return this.$5.get(a)};c.setMediaUrlByPlainTextHash=function(a,b){if(this.$5.has(a))return;this.$5.set(a,b)};c.addThreadKeyToThreadsRestoreInProgress=function(a){this.$6.add(a)};c.isThreadRestoreInProgressForThreadKey=function(a){return this.$6.has(a)};c.deleteThreadKeyFromThreadsRestoreInProgress=function(a){this.$6["delete"](a),this.$14()&&(void this.$4.LOG(s()),void this.$15()),this.logDYIQPLPoint("message_restore_complete_"+this.$6.size.toString())};c.isThreadsRestoreComplete=function(){this.$4.LOG(r(),this.$6.size);return this.$6.size===0};c.addPlaintextHashToAttachmentDownloadsInProgress=function(a){this.$7.add(a)};c.deletePlaintextHashFromAttachmentDownloadsInProgress=function(a){this.$7["delete"](a),this.$14()&&(void this.$4.LOG(q()),void this.$15())};c.isAttachmentDownloadInProgressForPlaintextHash=function(a){return this.$7.has(a)};c.isAttachmentDownloadCompleteForPlaintextHash=function(a){return!!this.$5.get(a)};c.isAttachmentDownloadComplete=function(){this.$4.LOG(p(),this.$7.size);return this.$7.size===0};c.setMessagesByThreadKey=function(a,b,c){a=this.getMessagesByThreadKey(a);a.set(b,c)};c.getMessagesByThreadKey=function(a){this.$16(a)||this.$8.set(a,new Map());return this.$8.get(a)};c.$16=function(a){return this.$8.has(a)};c.getThreadIdForThreadKey=function(a){return this.$10.get(a)};c.getThreadKeyForThreadId=function(a){return this.$11.get(a)};c.setThreadMapping=function(a,b){this.$10.set(a,b),this.$11.set(b,a)};c.setThreadMetaDataByThreadKey=function(a,b,c){this.$9.set(a,{participants:b,threadName:c})};c.getThreadMetadataMap=function(){return this.$9};c.setContactNameForContactId=function(a,b){this.$12.set(a,b)};c.getContactNameForContactId=function(a){return this.$12.get(a)};c.getContactNameMap=function(){return this.$12};c.getOutput=function(){var a=this;return Array.from(this.getThreadMetadataMap(),function(b){var c=b[0];b=b[1];var d=a.$16(c);d=d?Array.from(a.getMessagesByThreadKey(c),function(b){b[0];b=b[1];return babelHelpers["extends"]({},b,{media:Array.from(b.media,function(b){b=a.$13(b);return{uri:b!=null?"./"+b:"Failed to download media"}})})}):[];d=d.map(function(b){var c=b.senderId,d=babelHelpers.objectWithoutPropertiesLoose(b,["senderId"]);if(c!=null&&d.senderName==="Unknown User"){c=a.getContactNameForContactId(c);if(c!=null)return babelHelpers["extends"]({},d,{senderName:c})}return b});c=d.sort(function(a,b){return typeof a.timestamp==="number"&&typeof b.timestamp==="number"?a.timestamp-b.timestamp:0});return babelHelpers["extends"]({},b,{messages:c})})};c.$14=function(){return this.isAttachmentDownloadComplete()&&this.isThreadsRestoreComplete()};c.$17=function(a){switch(a){case 0:return d("EncryptedBackupsDYITypes").EncryptedBackupsDYIState.InProgress;case 1:return d("EncryptedBackupsDYITypes").EncryptedBackupsDYIState.Completed;case 2:return d("EncryptedBackupsDYITypes").EncryptedBackupsDYIState.Failed;case-1:default:return d("EncryptedBackupsDYITypes").EncryptedBackupsDYIState.NotStarted}};c.updateDYIStatus=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=(yield this.getDB());yield c.runInTransaction(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){yield b.encrypted_backups_dyi_backup_restore_status.put({currentStatus:(h||(h=d("LSIntEnum"))).ofNumber(a),pk:(i||(i=d("I64"))).zero})});return function(a){return c.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":503");d("MAWBridge").getBridge().fireAndForget("event","updateDYIStatus",{status:this.$17(a)})});function c(b){return a.apply(this,arguments)}return c}();c.$18=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this,b=new Set();this.getContactNameMap().forEach(function(a,c){a==="Unknown User"&&b.add(c)});var c=(yield this.getDB());c=(yield d("EncryptedBackupsDYIGenerateThreadMetadata").getAllUnmappedContacts(c,b));c.forEach(function(b){var c=(i||(i=d("I64"))).to_string(b.id);a.setContactNameForContactId(c,b.name)});void this.$4.LOG(o(),this.getContactNameMap().size.toString())});function c(){return a.apply(this,arguments)}return c}();c.$15=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){this.logDYIQPLPoint("complete_dyi_flow_start");yield this.$18();void this.$4.LOG(n());var a=this.getOutput(),b=Array.from(this.$5.values());this.logDYIQPLPoint("write_file_start");void this.$4.LOG(m());a=(yield d("EncryptedBackupsDYIZipUtils").generateZipFile(a,b));b=(yield a.arrayBuffer());a=(yield d("EncryptedBackupsDYIFileUtils").getRootFolderHandle());void this.$4.LOG(l());var c="messages.zip";yield d("EncryptedBackupsDYIFileUtils").writeFile(a,c,b);this.logDYIQPLPoint("write_file_end");void this.$4.LOG(k());this.logDYIQPLPoint("complete_dyi_flow_end");yield this.updateDYIStatus(1);void this.clear()});function c(){return a.apply(this,arguments)}return c}();c.exitDYIEarly=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){b!=null&&this.$4.LOG(j(),b),this.logDYIQPLPoint("dyi_exit_early",{"int":{dyi_threads:b}}),yield this.updateDYIStatus(a?2:1),void this.clear()});function c(b,c){return a.apply(this,arguments)}return c}();c.clear=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){this.$5=new Map();this.$6=new Set();this.$7=new Set();this.$8=new Map();this.$9=new Map();var a=(yield d("EncryptedBackupsDYIFileUtils").getRootFolderHandle());yield a.removeEntry(d("EncryptedBackupsDYIFileUtils").DyiMediaFolder,{recursive:!0})});function c(){return a.apply(this,arguments)}return c}();c.logDYIQPLPoint=function(a,b){this.$3!=null&&d("MAWQplProxy").sendQplPointThroughBridge(this.$2,a,{annotations:b,instanceKey:this.$3})};return a}();g.initSingleton=a;g.getSingleton=e;g.EncryptedBackupsDYISingleton=v}),98);
__d("EncryptedBackupsDYISingletonFactory",["EncryptedBackupsDYISingleton","WATagsLogger","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return new(d("EncryptedBackupsDYISingleton").EncryptedBackupsDYISingleton)(a,c("qpl")._(521478596,"1329"),b,d("WATagsLogger").TAGS(["labyrinth_web","labyrinth_dyi",b==null?"":b.toString()]))}function b(a,b){return new(d("EncryptedBackupsDYISingleton").EncryptedBackupsDYISingleton)(a,c("qpl")._(521479842,"2163"),b,d("WATagsLogger").TAGS(["igd_labyrinth_web","igd_dyi",b==null?"":b.toString()]))}g.getMAWEncryptedBackupsDYISingleton=a;g.getIGDEncryptedBackupsDYISingleton=b}),98);
__d("EncryptedBackupsDYIHandleMessageRestore",["EncryptedBackupsDYISingleton","I64"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Message range query complete for thread with thread key ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Issuing next range query for thread with thread key ",", server generated next reference timestamp: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["nextTimestampMs was not supplied for thread with thread key ","."]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["handling message range query for thread with thread key ",", hasMoreBefore: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot find thread key for thread id: ",""]);m=function(){return a};return a}function a(a,b,c,e,f,g,i){var o=d("EncryptedBackupsDYISingleton").getSingleton(),p=o.getLogger();o=o.getThreadKeyForThreadId(b);if(o==null){p.WARN(m(),b);return}void p.LOG(l(),b,e);c.length>0&&g(o,b,c);if(!e||f==null){e&&f==null&&void p.ERROR(k(),b);n(o);return}g=(h||(h=d("I64"))).to_string(f);void p.LOG(j(),b,g);void i(a,g,b)}function n(a){var b=d("EncryptedBackupsDYISingleton").getSingleton(),c=b.getLogger();b.deleteThreadKeyFromThreadsRestoreInProgress(a);void c.LOG(i(),a)}g.handleMessageRangeQueryRestore=a}),98);
__d("EncryptedBackupsDYIMediaDownloadHandlers",["EncryptedBackupsDYIFileUtils","EncryptedBackupsDYISingleton","FBLogger","Promise","WAResultOrError","asyncToGeneratorRuntime","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["DYI Media download complete for attachment with hash ",""]);i=function(){return a};return a}a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){f=(yield d("EncryptedBackupsDYIFileUtils").getMediaFolderHandle());b=b.split("/")[1];b=c("uuidv4")()+"."+b;yield d("EncryptedBackupsDYIFileUtils").writeFile(f,b,e);f=d("EncryptedBackupsDYISingleton").getSingleton();e=f.getLogger();f.setMediaUrlByPlainTextHash(a,d("EncryptedBackupsDYIFileUtils").DyiMediaFolder+"/"+b);void e.LOG(i(),a);f.deletePlaintextHashFromAttachmentDownloadsInProgress(a);return d("WAResultOrError").makeResult()});return function(b,c,d,e){return a.apply(this,arguments)}}();e=function(){c("FBLogger")("labyrinth_web").debug("[DYIMediaPreviewHandler] Skipping previews for DYI");return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult())};g.DYIMediaDownloadHandler=a;g.DYIMediaPreviewHandler=e}),98);
__d("IGDBuildMediaResignCdnUrlTtlcPartialPayload",["I64","WABase64","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";var h,i="kPxziUnMc4MUpeaqUkHj8S1MKoxDyFEukbvxsEB/fwE=";function a(a){return!a?null:{backupId:d("WAJids").extractUserId(d("WAGlobals").getMyUserJid()),deviceId:(h||(h=d("I64"))).zero,isOpenEb:a,mailboxRootKey:new ArrayBuffer(0),ocmfClientState:d("WABase64").decodeB64(i)}}g["default"]=a}),98);
__d("LSCreateResignCDNUrlPayload",["LSArrayGetObjectAt","LSBase64Encode.nop","LSBinaryToHex.nop","LSCreateDerivedKeys.nop","LSFindBackup","LSGetBlobFromInt64BE.nop","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop","LSOcmfClientMap.nop","LSOpeEncrypt.nop","LSTruncateSortKey.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return a[10]?c.sequence([function(e){return c.blobs.neq(a[11],void 0)?c.sequence([function(e){return c.i64.neq(a[8],void 0)?c.sequence([function(e){return a[9]!==void 0?c.sequence([function(e){return c.blobs.neq(a[12],void 0)?c.sequence([function(e){return d[10]=c.createArray(),d[19]=(d[10].push(a[9]),d[10]),d[19]=(d[10].push(a[1]),d[10]),d[11]=c.toJSON(d[10]),d[12]=c.createArray(),d[19]=(d[12].push(c.i64.cast([0,32])),d[12]),c.nativeOperation(b("LSGetBlobFromString.nop"),["thread_ope_key","_",a[5]].join("")).then(function(a){return a=a,d[13]=a[0],a})},function(e){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),d[13],void 0,a[12],d[12]).then(function(a){return a=a,d[14]=a[0],a})},function(a){return d[14]?d[15]=!1:d[15]=!0,d[15]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] Got null keys while deriving message list OPE key. Returning null blobish"),d[19]=c.createArray(),void 0!==void 0?d[20]=(d[19].push(void 0),d[19]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","Got null keys while deriving message list OPE key. Returning null blobish",d[19],c.i64.cast([0,3]))},function(a){return d[16]=void 0}]):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[14],c.i64.cast([0,0])).then(function(a){return a=a,d[19]=a[0],d[20]=a[1],a})},function(a){return d[16]=d[19]}])},function(e){return c.blobs.neq(d[16],void 0)?c.sequence([function(e){return c.nativeOperation(b("LSGetBlobFromInt64BE.nop"),a[6]).then(function(a){return a=a,d[19]=a[0],a})},function(a){return c.nativeOperation(b("LSTruncateSortKey.nop"),d[19]).then(function(a){return a=a,d[20]=a[0],a})},function(a){return c.nativeOperation(b("LSOpeEncrypt.nop"),d[16],d[20],c.i64.cast([0,16])).then(function(a){return a=a,d[21]=a[0],a})},function(a){return c.nativeOperation(b("LSBinaryToHex.nop"),d[21]).then(function(a){return a=a,d[22]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),d[11]).then(function(a){return a=a,d[23]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2NvcGU="),d[23]).then(function(a){return a=a,d[24]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[24]).then(function(a){return a=a,d[25]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[25]).then(function(a){return a=a,d[26]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[9]).then(function(a){return a=a,d[27]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWFpbGJveF9pZF9zY29wZQ=="),d[27]).then(function(a){return a=a,d[28]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[28]).then(function(a){return a=a,d[29]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[29]).then(function(a){return a=a,d[30]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[4]).then(function(a){return a=a,d[31]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWVzc2FnZV9pZF9zY29wZQ=="),d[31]).then(function(a){return a=a,d[32]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[32]).then(function(a){return a=a,d[33]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[33]).then(function(a){return a=a,d[34]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[4]).then(function(a){return a=a,d[35]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[35]).then(function(a){return a=a,d[36]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[36]).then(function(a){return a=a,d[37]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[37]).then(function(a){return a=a,d[38]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[5]).then(function(a){return a=a,d[39]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("dGhyZWFkX2lkX3Njb3Bl"),d[39]).then(function(a){return a=a,d[40]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[40]).then(function(a){return a=a,d[41]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[41]).then(function(a){return a=a,d[42]=a[0],a})},function(e){return d[43]=new c.Map(),d[43].set("attachment_index_key",d[26]==null?"":d[26]),d[43].set("backup_ent_fbid",a[0]),d[43].set("delivery_object_id",a[1]),d[43].set("device_id",a[8]),d[43].set("mailbox_partial_id",d[30]==null?"":d[30]),d[43].set("media_type",a[3]),d[43].set("message_partial_id",d[34]==null?"":d[34]),d[43].set("product_type",a[2]),d[43].set("salt_partial_id",d[38]==null?"":d[38]),d[43].set("sort_key",d[22]==null?"":d[22]),d[43].set("thread_partial_id",d[42]==null?"":d[42]),d[43].set("isOpenEB",a[10]===!0),d[44]=new c.Map(),d[44].set("otid",a[4]),d[44].set("server_thread_key",a[7]),d[44].set("timestamp",c.i64.to_string(a[6])),c.nativeOperation(b("LSBase64Encode.nop"),a[11]).then(function(a){return a=a,d[45]=a[0],a})},function(e){return c.nativeOperation(b("LSBase64Encode.nop"),a[12]).then(function(a){return a=a,d[46]=a[0],a})},function(e){return d[47]=new c.Map(),d[47].set("ocmf_client_state_blob",d[45]==null?"":d[45]),d[47].set("mailbox_root_key",d[46]==null?"":d[46]),d[48]=c.createArray(),d[60]=(d[48].push(a[4]),d[48]),d[60]=(d[48].push(a[1]),d[48]),d[49]=c.toJSON(d[48]),d[43].set("raw_identifiers",d[44]),d[43].set("backup_id",a[9]),d[43].set("thread_id",a[5]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[49]).then(function(a){return a=a,d[50]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[50]).then(function(a){return a=a,d[51]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[51]).then(function(a){return a=a,d[52]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[52]).then(function(a){return a=a,d[53]=a[0],a})},function(a){return d[43].set("salt_partial_access_token",d[53]==null?"":d[53]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[11]).then(function(a){return a=a,d[54]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2FsdF9zY29wZQ=="),d[54]).then(function(a){return a=a,d[55]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[55]).then(function(a){return a=a,d[56]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[56]).then(function(a){return a=a,d[57]=a[0],a})},function(a){return d[43].set("salt_partial_attachment_index_key",d[57]==null?"":d[57]),d[43].set("raw_tokens",d[47]),d[58]=c.toJSON(d[43]),d[59]=new c.Map(),d[59].set("payload",d[58]),a=[d[59],void 0],d[17]=a[0],d[18]=a[1],a}]):c.resolve((d[19]=new c.Map(),d[19].set("error_code",c.i64.cast([0,25])),d[19].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[19].set("error_message","OPE key is null for IssueAttachmentRestoreTask"),e=[void 0,d[19]],d[17]=e[0],d[18]=e[1],e))},function(a){return a=[d[17],d[18]],d[8]=a[0],d[9]=a[1],a}]):c.resolve((d[10]=new c.Map(),d[10].set("error_code",c.i64.cast([0,20])),d[10].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[10].set("error_message","Missing mailbox_root_key for IssueAttachmentRestoreTask"),e=[void 0,d[10]],d[8]=e[0],d[9]=e[1],e))},function(a){return a=[d[8],d[9]],d[6]=a[0],d[7]=a[1],a}]):c.resolve((d[8]=new c.Map(),d[8].set("error_code",c.i64.cast([0,1])),d[8].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[8].set("error_message","Missing backup_id for IssueAttachmentRestoreTask"),e=[void 0,d[8]],d[6]=e[0],d[7]=e[1],e))},function(a){return a=[d[6],d[7]],d[4]=a[0],d[5]=a[1],a}]):c.resolve((d[6]=new c.Map(),d[6].set("error_code",c.i64.cast([0,24])),d[6].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[6].set("error_message","Missing device_id for IssueAttachmentRestoreTask"),e=[void 0,d[6]],d[4]=e[0],d[5]=e[1],e))},function(a){return a=[d[4],d[5]],d[2]=a[0],d[3]=a[1],a}]):c.resolve((d[4]=new c.Map(),d[4].set("error_code",c.i64.cast([0,22])),d[4].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[4].set("error_message","Missing ocmf_client_state_blob for IssueAttachmentRestoreTask"),e=[void 0,d[4]],d[2]=e[0],d[3]=e[1],e))},function(a){return a=[d[2],d[3]],d[0]=a[0],d[1]=a[1],a}]):c.sequence([function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,e){var f=a.done;a=a.value;return f?(f=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,20])],d[2]=f[0],d[3]=f[1],d[4]=f[2],d[5]=f[3],d[6]=f[4],d[7]=f[5],d[8]=f[6],d[9]=f[7],d[10]=f[8],d[11]=f[9],d[12]=f[10],d[13]=f[11],d[14]=f[12],d[15]=f[13],d[16]=f[14],d[17]=f[15],f):(e=a.item,c.sequence([function(a){return d[27]=e.backupTenancy,d[26]=e.encryptionVersion,d[22]=void 0,c.i64.neq(d[22],void 0)?c.resolve(d[23]=d[22]):c.sequence([function(a){return d[28]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[29]=a[0],a})},function(a){return d[29]?d[38]=(d[28].push(c.i64.cast([0,0])),d[28]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[30]=a[0],a})},function(a){return d[30]?d[38]=(d[28].push(c.i64.cast([0,2])),d[28]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[31]=a[0],a})},function(a){return d[31]?d[38]=(d[28].push(c.i64.cast([0,3])),d[28]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[32]=a[0],a})},function(a){return d[32]?d[38]=(d[28].push(c.i64.cast([0,4])),d[28]):0,d[33]=c.createArray(),d[34]=c.i64.of_int32(d[28].length),c.i64.gt(d[34],c.i64.cast([0,0]))?c.loopAsync(d[34],function(a){return d[38]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[28],d[38]).then(function(a){return a=a,d[39]=a[0],d[40]=a[1],a})},function(a){return d[41]=(d[33].push(d[39]),d[33])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[38]=c.createArray(),d[39]=c.i64.of_int32(d[33].length),c.i64.gt(d[39],c.i64.cast([0,0]))?c.loopAsync(d[39],function(a){return d[41]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[33],d[41]).then(function(a){return a=a,d[42]=a[0],d[43]=a[1],a})},function(a){return d[44]=(d[38].push(c.i64.to_string(d[42])),d[38])}])}):c.resolve()},function(a){return d[40]=d[38].join(","),d[35]=d[40]}])},function(a){return d[33].some(function(a){return c.i64.eq(d[26],a)})?d[36]=d[26]:d[36]=void 0,c.i64.neq(d[36],void 0)?d[37]=d[36]:d[37]=void 0,d[23]=d[37]}])},function(a){return c.i64.neq(d[23],void 0)?d[24]=d[23]:d[24]=c.i64.cast([0,0]),c.i64.neq(d[27],void 0)?d[25]=d[27]:d[25]=c.i64.cast([0,1]),a=[e.backupId,e.deviceId,e.mailboxRootKeyBlob,e.ocmfClientStateBlob,void 0,void 0,d[24],d[25],e.epochAuthPublicKeyBlob,e.epochAuthPrivateKeyBlob,e.devicePublicKeyBlob,e.devicePrivateKeyBlob,e.epochStoragePublicKeyBlob,e.epochStoragePrivateKeyBlob,e.obliviousValidationTokenBlob,e.authorityLevel],d[2]=a[0],d[3]=a[1],d[4]=a[2],d[5]=a[3],d[6]=a[4],d[7]=a[5],d[8]=a[6],d[9]=a[7],d[10]=a[8],d[11]=a[9],d[12]=a[10],d[13]=a[11],d[14]=a[12],d[15]=a[13],d[16]=a[14],d[17]=a[15],a}]))})},function(a){return c.storedProcedure(b("LSFindBackup")).then(function(a){return a=a,d[19]=a[0],a})},function(e){return c.blobs.neq(d[5],void 0)?c.sequence([function(e){return c.i64.neq(d[3],void 0)?c.sequence([function(e){return d[19]!==void 0?c.sequence([function(e){return c.blobs.neq(d[4],void 0)?c.sequence([function(e){return d[28]=c.createArray(),d[37]=(d[28].push(d[19]),d[28]),d[37]=(d[28].push(a[1]),d[28]),d[29]=c.toJSON(d[28]),d[30]=c.createArray(),d[37]=(d[30].push(c.i64.cast([0,32])),d[30]),c.nativeOperation(b("LSGetBlobFromString.nop"),["thread_ope_key","_",a[5]].join("")).then(function(a){return a=a,d[31]=a[0],a})},function(a){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),d[31],void 0,d[4],d[30]).then(function(a){return a=a,d[32]=a[0],a})},function(a){return d[32]?d[33]=!1:d[33]=!0,d[33]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] Got null keys while deriving message list OPE key. Returning null blobish"),d[37]=c.createArray(),void 0!==void 0?d[38]=(d[37].push(void 0),d[37]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","Got null keys while deriving message list OPE key. Returning null blobish",d[37],c.i64.cast([0,3]))},function(a){return d[34]=void 0}]):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[32],c.i64.cast([0,0])).then(function(a){return a=a,d[37]=a[0],d[38]=a[1],a})},function(a){return d[34]=d[37]}])},function(e){return c.blobs.neq(d[34],void 0)?c.sequence([function(e){return c.nativeOperation(b("LSGetBlobFromInt64BE.nop"),a[6]).then(function(a){return a=a,d[37]=a[0],a})},function(a){return c.nativeOperation(b("LSTruncateSortKey.nop"),d[37]).then(function(a){return a=a,d[38]=a[0],a})},function(a){return c.nativeOperation(b("LSOpeEncrypt.nop"),d[34],d[38],c.i64.cast([0,16])).then(function(a){return a=a,d[39]=a[0],a})},function(a){return c.nativeOperation(b("LSBinaryToHex.nop"),d[39]).then(function(a){return a=a,d[40]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),d[29]).then(function(a){return a=a,d[41]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2NvcGU="),d[41]).then(function(a){return a=a,d[42]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[42]).then(function(a){return a=a,d[43]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[43]).then(function(a){return a=a,d[44]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),d[19]).then(function(a){return a=a,d[45]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWFpbGJveF9pZF9zY29wZQ=="),d[45]).then(function(a){return a=a,d[46]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[46]).then(function(a){return a=a,d[47]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[47]).then(function(a){return a=a,d[48]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[4]).then(function(a){return a=a,d[49]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWVzc2FnZV9pZF9zY29wZQ=="),d[49]).then(function(a){return a=a,d[50]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[50]).then(function(a){return a=a,d[51]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[51]).then(function(a){return a=a,d[52]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[4]).then(function(a){return a=a,d[53]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[53]).then(function(a){return a=a,d[54]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[54]).then(function(a){return a=a,d[55]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[55]).then(function(a){return a=a,d[56]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[5]).then(function(a){return a=a,d[57]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("dGhyZWFkX2lkX3Njb3Bl"),d[57]).then(function(a){return a=a,d[58]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[58]).then(function(a){return a=a,d[59]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[59]).then(function(a){return a=a,d[60]=a[0],a})},function(e){return d[61]=new c.Map(),d[61].set("attachment_index_key",d[44]==null?"":d[44]),d[61].set("backup_ent_fbid",a[0]),d[61].set("delivery_object_id",a[1]),d[61].set("device_id",d[3]),d[61].set("mailbox_partial_id",d[48]==null?"":d[48]),d[61].set("media_type",a[3]),d[61].set("message_partial_id",d[52]==null?"":d[52]),d[61].set("product_type",a[2]),d[61].set("salt_partial_id",d[56]==null?"":d[56]),d[61].set("sort_key",d[40]==null?"":d[40]),d[61].set("thread_partial_id",d[60]==null?"":d[60]),d[61].set("isOpenEB",a[10]===!0),d[62]=new c.Map(),d[62].set("otid",a[4]),d[62].set("server_thread_key",a[7]),d[62].set("timestamp",c.i64.to_string(a[6])),c.nativeOperation(b("LSBase64Encode.nop"),d[5]).then(function(a){return a=a,d[63]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[4]).then(function(a){return a=a,d[64]=a[0],a})},function(e){return d[65]=new c.Map(),d[65].set("ocmf_client_state_blob",d[63]==null?"":d[63]),d[65].set("mailbox_root_key",d[64]==null?"":d[64]),d[66]=c.createArray(),d[78]=(d[66].push(a[4]),d[66]),d[78]=(d[66].push(a[1]),d[66]),d[67]=c.toJSON(d[66]),d[61].set("raw_identifiers",d[62]),d[61].set("backup_id",d[19]),d[61].set("thread_id",a[5]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[67]).then(function(a){return a=a,d[68]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[68]).then(function(a){return a=a,d[69]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[69]).then(function(a){return a=a,d[70]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[70]).then(function(a){return a=a,d[71]=a[0],a})},function(a){return d[61].set("salt_partial_access_token",d[71]==null?"":d[71]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[29]).then(function(a){return a=a,d[72]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2FsdF9zY29wZQ=="),d[72]).then(function(a){return a=a,d[73]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[73]).then(function(a){return a=a,d[74]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[74]).then(function(a){return a=a,d[75]=a[0],a})},function(a){return d[61].set("salt_partial_attachment_index_key",d[75]==null?"":d[75]),d[61].set("raw_tokens",d[65]),d[76]=c.toJSON(d[61]),d[77]=new c.Map(),d[77].set("payload",d[76]),a=[d[77],void 0],d[35]=a[0],d[36]=a[1],a}]):c.resolve((d[37]=new c.Map(),d[37].set("error_code",c.i64.cast([0,25])),d[37].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[37].set("error_message","OPE key is null for IssueAttachmentRestoreTask"),e=[void 0,d[37]],d[35]=e[0],d[36]=e[1],e))},function(a){return a=[d[35],d[36]],d[26]=a[0],d[27]=a[1],a}]):c.resolve((d[28]=new c.Map(),d[28].set("error_code",c.i64.cast([0,20])),d[28].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[28].set("error_message","Missing mailbox_root_key for IssueAttachmentRestoreTask"),e=[void 0,d[28]],d[26]=e[0],d[27]=e[1],e))},function(a){return a=[d[26],d[27]],d[24]=a[0],d[25]=a[1],a}]):c.resolve((d[26]=new c.Map(),d[26].set("error_code",c.i64.cast([0,1])),d[26].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[26].set("error_message","Missing backup_id for IssueAttachmentRestoreTask"),e=[void 0,d[26]],d[24]=e[0],d[25]=e[1],e))},function(a){return a=[d[24],d[25]],d[22]=a[0],d[23]=a[1],a}]):c.resolve((d[24]=new c.Map(),d[24].set("error_code",c.i64.cast([0,24])),d[24].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[24].set("error_message","Missing device_id for IssueAttachmentRestoreTask"),e=[void 0,d[24]],d[22]=e[0],d[23]=e[1],e))},function(a){return a=[d[22],d[23]],d[20]=a[0],d[21]=a[1],a}]):c.resolve((d[22]=new c.Map(),d[22].set("error_code",c.i64.cast([0,22])),d[22].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[22].set("error_message","Missing ocmf_client_state_blob for IssueAttachmentRestoreTask"),e=[void 0,d[22]],d[20]=e[0],d[21]=e[1],e))},function(a){return a=[d[20],d[21]],d[0]=a[0],d[1]=a[1],a}])},function(a){return a=[d[0],d[1]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure";e.exports=a}),null);
__d("LSCreateResignCDNUrlPayloadStoredProcedure",["LSCreateResignCDNUrlPayload","cr:8709"],(function(a,b,c,d,e,f,g){function a(a,b){var d=[];d[0]=b.backupEntFbid;d[1]=b.deliveryObjectId;d[2]=b.productType;d[3]=b.mediaType;d[4]=b.messageId;d[5]=b.threadId;d[6]=b.sortOrder;d[7]=b.serverThreadKey;d[8]=b.deviceId;d[9]=b.backupId;d[10]=b.isOpenEb;d[11]=b.ocmfClientState;d[12]=b.mailboxRootKey;return c("LSCreateResignCDNUrlPayload").apply(void 0,d.concat([a]))}g["default"]=a}),98);
__d("MebMIMediaDownloader",["FBLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(){function a(a,c){this.mediaDownloadMetadata=a;this.callbacks={onResignCdnUrlFailure:(a=c==null?void 0:c.onResignCdnUrlFailure)!=null?a:b("asyncToGeneratorRuntime").asyncToGenerator(function*(){}),onResignCdnUrlSuccess:(a=c==null?void 0:c.onResignCdnUrlSuccess)!=null?a:b("asyncToGeneratorRuntime").asyncToGenerator(function*(){})}}var d=a.prototype;d.getDownloadMetadata=function(){return this.mediaDownloadMetadata};d.handle=function(){throw c("FBLogger")("labyrinth_web").mustfixThrow("[MebMIMediaDownloader] Please don't use the base class. Instead use either MAWMIMediaDownloader or IGDMIMediaDownloader, depending on the platform.")};d["continue"]=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b;yield this.callbacks.onResignCdnUrlSuccess();b=(b=this.waMediaDownloader)==null?void 0:b.getDownloadMetadata();if(b!=null){var c=b.mediaEntry;c.directPath=a;b.isUrlRenewed=!0;yield (c=this.waMediaDownloader)==null?void 0:c.handle()}});function a(b){return a.apply(this,arguments)}return a}();d.handleError=function(){return this.callbacks.onResignCdnUrlFailure()};d.setNextHandler=function(a){this.waMediaDownloader=a};return a}();g["default"]=a}),98);
__d("IGDMIMediaDownloader",["I64","IGDBuildMediaResignCdnUrlTtlcPartialPayload","LSCreateResignCDNUrlPayloadStoredProcedure","LSFactory","LSShape","MAWBridge","MAWReStoreDb","MAWThreadKeyUtils","MebMIMediaDownloader","MediaDownloadMediator","WALogger","WAMediaUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][meb][media download] failed to fetch cdn url for attachment. The error is ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][meb][media download] failed to fetch cdn url for attachment. The error is ",""]);j=function(){return a};return a}a=function(a){babelHelpers.inheritsLoose(e,a);function e(){return a.apply(this,arguments)||this}var f=e.prototype;f.handle=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this,b=(yield d("MAWReStoreDb").getDB()),e=this.mediaDownloadMetadata.backupEntFbid;if(e!=null){var f=d("MAWThreadKeyUtils").stringThreadKeyToString(this.mediaDownloadMetadata.threadKey);b=(yield b.runInTransaction(function(b){return c("LSCreateResignCDNUrlPayloadStoredProcedure")(c("LSFactory")(b),babelHelpers["extends"]({backupEntFbid:(h||(h=d("I64"))).of_string(e),deliveryObjectId:a.mediaDownloadMetadata.deliveryObjectId,mediaType:a.mediaDownloadMetadata.mediaType,messageId:a.mediaDownloadMetadata.messageId,productType:a.mediaDownloadMetadata.productType,serverThreadKey:f,sortOrder:h.of_float(a.mediaDownloadMetadata.sortOrder),threadId:a.mediaDownloadMetadata.threadId},c("IGDBuildMediaResignCdnUrlTtlcPartialPayload")(Boolean(a.mediaDownloadMetadata.isOpenEb))))},"readwrite"));var g=b[0];if(g!=null){g=d("LSShape").toRecord(g);try{var k=d("WAMediaUtils").stringToDeliveryObjectId(this.mediaDownloadMetadata.deliveryObjectId);d("MediaDownloadMediator").mapDeliveryObjectIdToMediaDownloader(k,this);return d("MAWBridge").getBridge().fireAndForget("event","resignCdnUrl",{deliveryObjectId:k,payload:g.payload})}catch(a){d("WALogger").ERROR(j(),a)}}else if(b[1]){k=d("LSShape").toRecord(b[1]);d("WALogger").ERROR(i(),k.error_message)}}});function e(){return a.apply(this,arguments)}return e}();return e}(c("MebMIMediaDownloader"));g.IGDMIMediaDownloader=a}),98);
__d("MAWMIMediaDownloader",["FBLogger","I64","LSDatabaseSingleton","LSFactory","LSIntEnum","LSIssueAttachmentRestoreTaskStoredProcedure","LSMEBTaskCreationSource","MAWCastToMsgrServerMediaType","MAWThreadKeyUtils","MebMIMediaDownloader","MediaDownloadMediator","WAMediaUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;a=function(a){babelHelpers.inheritsLoose(e,a);function e(){return a.apply(this,arguments)||this}var g=e.prototype;g.handle=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this,b=(yield (h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton);d("MediaDownloadMediator").mapDeliveryObjectIdToMediaDownloader(d("WAMediaUtils").stringToDeliveryObjectId(this.mediaDownloadMetadata.deliveryObjectId),this);var e=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(this.mediaDownloadMetadata.mediaType);if(e==null)throw c("FBLogger")("labyrinth_web").mustfixThrow("Unsupported media type");var g=d("MAWThreadKeyUtils").stringThreadKeyToString(this.mediaDownloadMetadata.threadKey);yield b.runInTransaction(function(b){return c("LSIssueAttachmentRestoreTaskStoredProcedure")(c("LSFactory")(b),{backupEntFbid:(i||(i=d("I64"))).of_string(a.mediaDownloadMetadata.backupEntFbid),deliveryObjectId:a.mediaDownloadMetadata.deliveryObjectId,mediaType:e,messageId:a.mediaDownloadMetadata.messageId,productType:a.mediaDownloadMetadata.productType,serverThreadKey:g,sortOrder:i.of_float(a.mediaDownloadMetadata.sortOrder),source:(j||(j=d("LSIntEnum"))).ofNumber(c("LSMEBTaskCreationSource").MSGR_DYI),threadId:a.mediaDownloadMetadata.threadId})},"readwrite",void 0,void 0,f.id+":49")});function e(){return a.apply(this,arguments)}return e}();return e}(c("MebMIMediaDownloader"));g.MAWMIMediaDownloader=a}),98);
__d("MebWAMediaDownloader",["MAWBridge","MAWGetMediaPlaintextApi","MAWHandleMediaPreviewBeforeDownloadApi","MAWHandleMediaPreviewDownloadApi","MAWUpdateMediaEntryForMsgApi","WAAPI","WAIsMediaExpiredError","WALogger","WAStartMediaDownloadQplFlow","WATimeUtils","asyncToGeneratorRuntime","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] downloading media from MI directly"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][WAMediaDownloader] Cannot download media - missing mediaKeyTimestamp"]);i=function(){return a};return a}a=function(){function a(a,b,c){this.mediaDownloadMetadata=a,this.downloadCallbacks=b,this.waApiDownloadCall=c}var e=a.prototype;e.handle=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a,b=this.mediaDownloadMetadata.mediaEntry.mediaKeyTimestamp;if(b==null){d("WALogger").ERROR(i());return this.handleError()}b=!d("WATimeUtils").happenedWithin(b,29*d("WATimeUtils").DAY_SECONDS);a=(a=this.mediaDownloadMetadata.isUrlRenewed)!=null?a:!1;if(!a&&(b||c("gkx")("23960"))){d("WALogger").LOG(h());return this.handleUrlExpired()}a=this.mediaDownloadMetadata;b=a.hash;var e=a.mediaEntry;a=a.protocolMsgId;b=(yield this.waApiDownloadCall(b,e,a));if(b.success)return this.downloadCallbacks.onDownloadSuccess(b.value);if(d("WAIsMediaExpiredError").isMediaExpiredError(b.error))return this.handleUrlExpired();else return this.handleError()});function e(){return a.apply(this,arguments)}return e}();e.handleUrlExpired=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a;yield this.downloadCallbacks.onUrlExpired();return(a=this.mediaDownloadHandler)==null?void 0:a.handle()});function c(){return a.apply(this,arguments)}return c}();e.handleError=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a;yield this.downloadCallbacks.onDownloadError();return(a=this.mediaDownloadHandler)==null?void 0:a.handle()});function c(){return a.apply(this,arguments)}return c}();e.getDownloadMetadata=function(){return this.mediaDownloadMetadata};e.setNextHandler=function(a){this.mediaDownloadHandler=a};return a}();e=function(a,b,e){var f=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"MebWAMediaDownloader",msgType:null,protocolMsgId:e});return c("WAAPI").downloadMedia({downloadMediaMetric:f,getMediaPlaintext:d("MAWGetMediaPlaintextApi").getMediaPlaintext,handleMediaPreviewBeforeDownload:d("MAWHandleMediaPreviewBeforeDownloadApi").handleMediaPreviewBeforeDownload,handleMediaPreviewDownload:d("MAWHandleMediaPreviewDownloadApi").handleMediaPreviewDownload,hash:a,mediaEntry:b,onlyIfMediaTTLIsValid:!1,protocolMsgId:e,updateMediaEntryForMsg:d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg})};f=function(a,b,c){return d("MAWBridge").getBridge().sendAndReceive("backend","dyiDownloadMedia",{hash:a,mediaEntry:b,protocolMsgId:c})};g.MebWAMediaDownloader=a;g.MebWADownloadMediaFromWorker=e;g.MebWADownloadMediaThroughTheBridge=f}),98);
__d("EncryptedBackupsDYIMessageProcessingUtils",["EncryptedBackupsDYIMediaDownloadHandlers","EncryptedBackupsDYISingleton","IGDMIMediaDownloader","MAWMIMediaDownloader","MebWAMediaDownloader","Promise","WAJids","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["initiating media download for attachment with hash ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[MEB][DYI] Retry download media as signature has expired and should be renewed"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Successfully downloaded media"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media"]);l=function(){return a};return a}function a(a,b){return{isUnsent:!1,media:new Set(),reactions:[],senderName:m(a),text:"",timestamp:(a=b)!=null?a:0,type:""}}function m(a){var b=d("EncryptedBackupsDYISingleton").getSingleton(),c="Unknown User";if(a!=null){b=b.getContactNameForContactId(a);b!=null&&(c=b)}return c}function c(a,c,e,f,g,m,n,o,p,q){var r=d("EncryptedBackupsDYISingleton").getSingleton(),s=r.getLogger(),t={author:d("WAJids").unsafeCoerceToUserJid(n),chat:d("WAJids").unsafeCoerceToChatJid(g),externalId:o},u={hash:p,isUrlRenewed:!1,mediaEntry:f,protocolMsgId:t,sortOrderMs:q};n={onDownloadError:function(){void s.ERROR(l());r.deletePlaintextHashFromAttachmentDownloadsInProgress(u.hash);return(h||(h=b("Promise"))).resolve()},onDownloadSuccess:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){void s.LOG(k());var b=a.mimeType;a=a.plaintext;yield d("EncryptedBackupsDYIMediaDownloadHandlers").DYIMediaDownloadHandler(u.hash,b,a,t)});function c(b){return a.apply(this,arguments)}return c}(),onUrlExpired:function(){void s.LOG(j());return(h||(h=b("Promise"))).resolve()}};var v=new(d("MebWAMediaDownloader").MebWAMediaDownloader)(u,n,a);void s.LOG(i(),p);var w=f.serverMediaType;f=f.objectId;if(w!=null&&f!=null&&typeof q==="number"){c={backupEntFbid:c,deliveryObjectId:f,hash:p,mediaType:w,messageId:o,productType:e,sortOrder:q,threadId:g,threadKey:m};f={onResignCdnUrlFailure:function(){r.deletePlaintextHashFromAttachmentDownloadsInProgress(u.hash);return(h||(h=b("Promise"))).resolve()},onResignCdnUrlSuccess:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){});function c(){return a.apply(this,arguments)}return c}()};p=e==="msgr"?new(d("MAWMIMediaDownloader").MAWMIMediaDownloader)(c,f):new(d("IGDMIMediaDownloader").IGDMIMediaDownloader)(c,f);v.setNextHandler(p);p.setNextHandler(new(d("MebWAMediaDownloader").MebWAMediaDownloader)(u,n,a))}void v.handle()}g.buildBaseDyiMessage=a;g.getSenderName=m;g.startMediaDownloadChain=c}),98);
__d("LSDecryptMessageV2",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSCreateDerivedKeys.nop","LSGetBlobFromString.nop","LSIsMobileClient","LSLogMebClientEvent.nop","LSSymmetricEncryptionCreateDecryptedString.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][decryptMessageV2] Beginning execution."),d[1]=c.i64.of_float(Date.now()),d[8]=a[2]==null?c.i64.cast([0,0]):a[2],d[2]=c.i64.of_int32(a[3].length),c.i64.eq(d[2],c.i64.cast([0,1]))?c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[3],c.i64.cast([0,0])).then(function(a){return a=a,d[12]=a[0],d[13]=a[1],a})},function(e){return d[14]=d[12].get("epoch_anon_id"),d[12],d[15]=d[12].get("epoch_root_key"),d[12],d[16]=c.createArray(),d[26]=(d[16].push(c.i64.cast([0,32])),d[16]),c.i64.ge(d[8],c.i64.cast([0,3]))?c.resolve(d[17]=void 0):c.sequence([function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[1]).then(function(a){return a=a,d[26]=a[0],a})},function(a){return d[17]=d[26]}])},function(e){return c.i64.ge(d[8],c.i64.cast([0,4]))?(d[26]="_",d[18]=["message_key_in_epoch",d[26],c.blobs.to_string(d[14]),d[26],"cipher_version",d[26],c.i64.to_string(d[8]),d[26],"thread",d[26],a[1]==null?"":a[1]].join("")):(c.i64.ge(d[8],c.i64.cast([0,3]))?(d[27]="_",d[26]=["message_key_in_epoch",d[27],c.blobs.to_string(d[14]),d[27],"cipher_version",d[27],c.i64.to_string(d[8]),d[27],"thread",d[27],a[1]==null?"":a[1]].join("")):(c.i64.ge(d[8],c.i64.cast([0,2]))?(d[28]="_",d[27]=["message_key_in_epoch",d[28],c.blobs.to_string(d[14]),d[28],"cipher_version",d[28],c.i64.to_string(d[8])].join("")):d[27]=["message_key_in_epoch","_",c.blobs.to_string(d[14])].join(""),d[26]=d[27]),d[18]=d[26]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[18]).then(function(a){return a=a,d[19]=a[0],a})},function(a){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),d[19],d[17],d[15],d[16]).then(function(a){return a=a,d[20]=a[0],a})},function(a){return d[20]?d[21]=!1:d[21]=!0,d[21]?c.resolve(d[22]=void 0):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[20],c.i64.cast([0,0])).then(function(a){return a=a,d[26]=a[0],d[27]=a[1],a})},function(a){return d[22]=d[26]}])},function(e){return c.blobs.neq(d[22],void 0)?c.sequence([function(e){return c.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),d[22],c.blobs.of_string(["message_thread","_",a[1]].join("")),a[0]).then(function(a){return a=a,d[26]=a[0],a})},function(a){return d[26]!==void 0?c.resolve(d[27]=d[26]):c.sequence([function(a){return d[28]=["Failed to decrypt message. Epoch Anon ID: ",c.blobs.to_string(d[14]),", Encryption Version: ",c.i64.to_string(d[8])].join(""),function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsDecryptMessageV2StoredProcedure] ","",d[28]].join("")),d[29]=c.createArray(),void 0!==void 0?d[30]=(d[29].push(void 0),d[29]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessageV2StoredProcedure",[d[28]].join(""),d[29],c.i64.cast([0,3]))},function(a){return d[27]=void 0}])},function(a){return d[23]=d[27]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsDecryptMessageV2StoredProcedure] Decryption message key is null"),void 0!==void 0?c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,85]),c.i64.cast([0,2]),"[EncryptedBackups][LSEncryptedBackupsDecryptMessageV2StoredProcedure] Decryption message key is null",void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[27]=a[0],a})},function(a){return d[27]?d[28]=!0:d[28]=!1,d[28]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[29]=c.createArray(),void 0!==void 0?d[30]=(d[29].push(void 0),d[29]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[29],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[26]=c.createArray(),void 0!==void 0?d[27]=(d[26].push(void 0),d[26]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessageV2StoredProcedure","Decryption message key is null",d[26],c.i64.cast([0,3]))},function(a){return d[23]=void 0}])},function(a){return d[23]!==void 0?(a=[d[23],void 0],d[24]=a[0],d[25]=a[1],a):(d[26]=new c.Map(),d[26].set("error_code",c.i64.cast([0,101])),d[26].set("stored_procedure","LSEncryptedBackupsDecryptMessageV2StoredProcedure"),d[26].set("error_message",""),a=[void 0,d[26]],d[24]=a[0],d[25]=a[1],a),a=[d[24],d[25]],d[3]=a[0],d[4]=a[1],a}]):c.resolve((d[12]=c.i64.of_int32(a[3].length),c.i64.eq(d[12],c.i64.cast([0,0]))?(d[15]=new c.Map(),d[15].set("error_code",c.i64.cast([0,102])),d[15].set("stored_procedure","LSEncryptedBackupsDecryptMessageV2StoredProcedure"),d[15].set("error_message",""),e=[void 0,d[15]],d[13]=e[0],d[14]=e[1],e):(d[15]=new c.Map(),d[15].set("error_code",c.i64.cast([0,103])),d[15].set("stored_procedure","LSEncryptedBackupsDecryptMessageV2StoredProcedure"),d[15].set("error_message",""),e=[void 0,d[15]],d[13]=e[0],d[14]=e[1],e),e=[d[13],d[14]],d[3]=e[0],d[4]=e[1],e))},function(a){return d[5]=c.i64.of_float(Date.now()),d[6]=c.i64.random(),d[9]="Finishing execution. Execution time: ",d[10]=c.i64.to_string(c.i64.sub(d[5],d[0])),d[11]=" ms",d[7]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][decryptMessageV2] ",d[7],d[9],d[7],d[10],d[7],d[11]].join("")),c.i64.eq(c.i64.mod_(d[6],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[12]=",",d[13]=c.createArray(),void 0!==void 0?d[14]=(d[13].push(void 0),d[13]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"decryptMessageV2",[d[9],d[12],d[10],d[12],d[11]].join(""),d[13],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[3],d[4]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsDecryptMessageV2StoredProcedure";e.exports=a}),null);
__d("LSDecryptMessages",["LSArrayGetObjectAt","LSBase64Encode.nop","LSCreateDerivedKeys.nop","LSDecryptMessageV2","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][decryptMessages] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(e,f){var g=e.done;e=e.value;return g?(d[11]=new c.Map(),d[11].set("error_code",c.i64.cast([0,1])),d[11].set("stored_procedure","LSEncryptedBackupsDecryptMessagesStoredProcedure"),d[11].set("error_message",""),g=[void 0,d[11]],d[2]=g[0],d[3]=g[1],g):(f=e.item,c.sequence([function(a){return d[19]=f.backupId,d[20]=f.deviceId,d[18]=f.backupTenancy,d[17]=f.encryptionVersion,d[11]=void 0,c.i64.neq(d[11],void 0)?c.resolve(d[12]=d[11]):c.sequence([function(a){return d[21]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[22]=a[0],a})},function(a){return d[22]?d[31]=(d[21].push(c.i64.cast([0,0])),d[21]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[23]=a[0],a})},function(a){return d[23]?d[31]=(d[21].push(c.i64.cast([0,2])),d[21]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[24]=a[0],a})},function(a){return d[24]?d[31]=(d[21].push(c.i64.cast([0,3])),d[21]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[25]=a[0],a})},function(a){return d[25]?d[31]=(d[21].push(c.i64.cast([0,4])),d[21]):0,d[26]=c.createArray(),d[27]=c.i64.of_int32(d[21].length),c.i64.gt(d[27],c.i64.cast([0,0]))?c.loopAsync(d[27],function(a){return d[31]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[21],d[31]).then(function(a){return a=a,d[32]=a[0],d[33]=a[1],a})},function(a){return d[34]=(d[26].push(d[32]),d[26])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[31]=c.createArray(),d[32]=c.i64.of_int32(d[26].length),c.i64.gt(d[32],c.i64.cast([0,0]))?c.loopAsync(d[32],function(a){return d[34]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[26],d[34]).then(function(a){return a=a,d[35]=a[0],d[36]=a[1],a})},function(a){return d[37]=(d[31].push(c.i64.to_string(d[35])),d[31])}])}):c.resolve()},function(a){return d[33]=d[31].join(","),d[28]=d[33]}])},function(a){return d[26].some(function(a){return c.i64.eq(d[17],a)})?d[29]=d[17]:d[29]=void 0,c.i64.neq(d[29],void 0)?d[30]=d[29]:d[30]=void 0,d[12]=d[30]}])},function(e){return c.i64.neq(d[12],void 0)?d[13]=d[12]:d[13]=c.i64.cast([0,0]),c.i64.neq(d[18],void 0)?d[14]=d[18]:d[14]=c.i64.cast([0,1]),c.i64.neq(d[20],void 0)?c.sequence([function(e){return d[21]=c.createArray(),d[22]=c.createArray(),d[23]=new c.Map(),d[24]=c.i64.of_int32(a[0].length),c.i64.gt(d[24],c.i64.cast([0,0]))?c.loopAsync(d[24],function(e){return d[28]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[0],d[28]).then(function(a){return a=a,d[29]=a[0],d[30]=a[1],a})},function(a){return d[31]=d[29].get("epoch_anon_id"),d[29],d[32]=d[23].get(c.blobs.to_string(d[31])),d[23],d[32]!==void 0?c.resolve(d[33]=d[32]):c.sequence([function(a){return d[38]=d[29].get("epoch_anon_id"),d[29],d[39]=d[29].get("epoch_id"),d[29],c.i64.neq(d[39],void 0)?c.sequence([function(a){return d[42]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch([[[d[39]]]]),function(a){return c.i64.eq(a.backupId,d[19])&&c.i64.eq(a.epochId,d[39])&&c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[43]=new c.Map(),d[43].set("epoch_root_key",a.epochRootKeyBlob),d[43].set("epoch_anon_id",a.epochAnonIdBlob),d[44]=(d[42].push(d[43]),d[42])})},function(a){return d[40]=d[42]}]):c.sequence([function(a){return d[42]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch([[[d[19]]],"fk_secure_encrypted_backups_client_state"]),function(a){return c.i64.eq(a.backupId,d[19])&&c.blobs.eq(a.epochAnonIdBlob,d[38])&&c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[43]=new c.Map(),d[43].set("epoch_root_key",a.epochRootKeyBlob),d[43].set("epoch_anon_id",a.epochAnonIdBlob),d[44]=(d[42].push(d[43]),d[42])})},function(a){return d[40]=d[42]}])},function(a){return d[41]=c.i64.of_int32(d[40].length),c.i64.gt(d[41],c.i64.cast([0,0]))?(d[42]=d[29].get("epoch_anon_id"),d[29],d[23].set(c.blobs.to_string(d[42]),d[40])):0,d[33]=d[40]}])},function(e){return d[34]=d[29].get("value"),d[29],d[35]=d[29].get("encryption_version"),d[29],c.storedProcedure(b("LSDecryptMessageV2"),d[34],a[1],d[35],d[33]).then(function(a){return a=a,d[36]=a[0],d[37]=a[1],a})},function(a){return d[36]!==void 0?c.resolve((d[38]=d[29].get("otid"),d[29],d[39]=new c.Map(),d[39].set("value",d[36]),d[39].set("otid",d[38]),d[40]=(d[21].push(d[39]),d[21]))):c.sequence([function(a){return d[37]!==void 0?c.sequence([function(a){return d[38]=c.i64.of_int32(d[33].length),c.i64.gt(d[38],c.i64.cast([0,0]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[33],c.i64.cast([0,0])).then(function(a){return a=a,d[49]=a[0],d[50]=a[1],a})},function(a){return d[51]=d[49].get("epoch_root_key"),d[49],d[52]=c.createArray(),d[57]=(d[52].push(c.i64.cast([0,18])),d[52]),c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,d[51],d[52]).then(function(a){return a=a,d[53]=a[0],a})},function(a){return d[53]!==void 0?c.sequence([function(a){return d[57]=c.i64.of_int32(d[53].length),c.i64.ge(d[57],c.i64.cast([0,1]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[53],c.i64.cast([0,0])).then(function(a){return a=a,d[59]=a[0],d[60]=a[1],a})},function(a){return d[58]=d[59]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),d[59]=c.createArray(),void 0!==void 0?d[60]=(d[59].push(void 0),d[59]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint","CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",d[59],c.i64.cast([0,3]))},function(a){return d[58]=void 0}])},function(a){return d[54]=d[58]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),d[57]=c.createArray(),void 0!==void 0?d[58]=(d[57].push(void 0),d[57]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint","CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",d[57],c.i64.cast([0,3]))},function(a){return d[54]=void 0}])},function(a){return c.blobs.neq(d[54],void 0)?d[55]=!0:d[55]=!1,d[55]?0:(function(a){c.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),c["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),c.blobs.neq(d[54],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[54]).then(function(a){return a=a,d[57]=a[0],a})},function(a){return d[56]=d[57]==null?"[encodingFailed]":d[57]}]):c.resolve(d[56]="[null]")},function(a){return d[39]=d[56]}]):c.resolve(d[39]="[noEpochs]")},function(a){return d[40]=d[29].get("otid"),d[29],d[41]=d[29].get("epoch_anon_id"),d[29],d[42]=d[29].get("encryption_version"),d[29],c.i64.neq(d[42],void 0)?d[43]=c.i64.to_string(d[42]):d[43]="null",d[44]=c.i64.of_int32(d[33].length),d[45]=d[29].get("epoch_fingerprint"),d[29],c.blobs.neq(d[45],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[45]).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[46]=d[49]==null?"[encodingFailed]":d[49]}]):c.resolve(d[46]="[null]")},function(a){return d[47]=d[29].get("backup_id"),d[29],d[48]="",d[37].set("error_message",["Decryption failed for message with otid:",d[48],d[40],d[48]," epoch:",d[48],c.blobs.to_string(d[41]),d[48]," version:",d[48],d[43],d[48]," epoch_key_count:",d[48],c.i64.to_string(d[44]),d[48]," vsr_fingerprint:",d[48],d[46],d[48]," local_fingerprint:",d[48],d[39],d[48]," vsr_backup_id:",d[48],c.i64.to_string(d[47])==null?"[null]":c.i64.to_string(d[47]),d[48]," local_backup_id:",d[48],c.i64.to_string(d[19]),d[48]," local_device_id:",d[48],c.i64.to_string(d[20])].join(""))}]):c.resolve()},function(a){return d[38]=(d[22].push(d[37]),d[22])}])}])}):c.resolve()},function(a){return d[25]=c.i64.of_int32(d[22].length),c.i64.gt(d[25],c.i64.cast([0,0]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[22],c.i64.cast([0,0])).then(function(a){return a=a,d[28]=a[0],d[29]=a[1],a})},function(a){return a=[void 0,d[28]],d[26]=a[0],d[27]=a[1],a}]):c.resolve((a=[d[21],void 0],d[26]=a[0],d[27]=a[1],a))},function(a){return a=[d[26],d[27]],d[15]=a[0],d[16]=a[1],a}]):c.resolve((d[21]=new c.Map(),d[21].set("error_code",c.i64.cast([0,24])),d[21].set("stored_procedure","LSEncryptedBackupsDecryptMessagesStoredProcedure"),d[21].set("error_message",""),e=[void 0,d[21]],d[15]=e[0],d[16]=e[1],e))},function(a){return a=[d[15],d[16]],d[2]=a[0],d[3]=a[1],a}]))})},function(a){return d[5]=c.i64.of_float(Date.now()),d[6]=c.i64.random(),d[8]="Finishing execution. Execution time: ",d[9]=c.i64.to_string(c.i64.sub(d[5],d[0])),d[10]=" ms",d[7]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][decryptMessages] ",d[7],d[8],d[7],d[9],d[7],d[10]].join("")),c.i64.eq(c.i64.mod_(d[6],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[11]=",",d[12]=c.createArray(),void 0!==void 0?d[13]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"decryptMessages",[d[8],d[11],d[9],d[11],d[10]].join(""),d[12],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[2],d[3]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsDecryptMessagesStoredProcedure";e.exports=a}),null);
__d("MAWEncryptedBackupsDYIProcessEchoMessages",["EchoMessage","EncryptedBackupsDYIMessageProcessingUtils","EncryptedBackupsDYISingleton","MAWFrontendMediaUtils","MAWHandleEchoMediaMsgsRestoreV2","MebWAMediaDownloader","WAHashUtils","WAMediaUtils","WAStanzaUtils","qex"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media message is missing media data"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Explicitly dropping "," message type"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unsupported message content subtype for placeholder: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Bump message is not supported in DYI"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Encountered message edits: ","\n. Edit count: ","\n. Original message content: ",""],["Encountered message edits: ","\\n. Edit count: ","\\n. Original message content: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Dropping tombstoned message"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error processing Echo document. Dropping the message: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot convert Echo message to DYI format. Dropping the message"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processing "," echo messages for thread ",""]);p=function(){return a};return a}function a(a,b,c){var e=d("EncryptedBackupsDYISingleton").getSingleton(),f=e.getLogger();void f.LOG(p(),c.length,a);c.forEach(function(c){try{var g=q(a,b,c);if(g==null){void f.WARN(o());return}e.setMessagesByThreadKey(a,d("WAStanzaUtils").toStanzaId(c.messageId),g);return}catch(a){void f.ERROR(n(),a);return}})}function q(a,b,e){var f,g=d("EncryptedBackupsDYISingleton").getSingleton(),h=g.getLogger();if(e.isTombstoned!=null&&e.isTombstoned===!0){void h.LOG(m());return}f=d("EncryptedBackupsDYIMessageProcessingUtils").buildBaseDyiMessage((f=e.from)==null?void 0:f.localKey,e.sortOrderMs);(e.editCount>0||e.editHistory.length>0)&&void h.LOG(l(),JSON.stringify(e.editHistory,null,2),e.editCount,e.text);e.reactions!=null&&e.reactions.length>0&&(f.reactions=e.reactions.map(function(a){var b=a.displayName;a=a.localKey;return{actor:(a=g.getContactNameForContactId(a))!=null?a:"unknown",reaction:(a=b)!=null?a:"unknown"}}));var n=c("qex")._("172")||!1;switch(e.contentType){case d("EchoMessage").EchoMessageContentType.TEXT:if(n&&e.xContentType===d("EchoMessage").EchoXMessageContentType.BUMP){void h.WARN(k());return void 0}else f.type="text",f.text=e.text||"";break;case d("EchoMessage").EchoMessageContentType.MEDIA:f.type="media";f=r(a,b,e,f);break;case d("EchoMessage").EchoMessageContentType.PLACEHOLDER:e.contentSubtype===d("EchoMessage").EchoMessageContentSubtype.UNSEND&&(f.type="placeholder",f.isUnsent=!0,f.text="User unsent a message");void h.WARN(j(),d("EchoMessage").EchoMessageContentSubtype.getName(e.contentSubtype));return void 0;case d("EchoMessage").EchoMessageContentType.XMA:f.type="link";e.xmaData!=null&&e.xmaData.xmaDefaultCTA!=null?f.text=e.xmaData.xmaDefaultCTA:f.text=e.text||"";break;case d("EchoMessage").EchoMessageContentType.ADMIN_MESSAGE:case d("EchoMessage").EchoMessageContentType.DECRYPTION_FAILURE:case d("EchoMessage").EchoMessageContentType.NULL_STATE:case d("EchoMessage").EchoMessageContentType.UNSUPPORTED_NEEDS_UPDATE:void h.LOG(i(),e.contentType);return void 0}return f}function r(a,b,c,e){var f=d("EncryptedBackupsDYISingleton").getSingleton(),g=f.getLogger();if(c.mediaData==null){void g.WARN(h());return e}g=c.from;var i=c.xOfflineThreadingId,j=c.mediaData,k=j.attachmentObjectId,l=j.backupEntFbid,m=j.directPath,n=j.encryptedHash,o=j.filename,p=j.mediaContentType,q=j.mediaKey,r=j.mediaKeyTimestamp,s=j.plaintextHash;j=j.size;g=(g=g==null?void 0:g.localKey)!=null?g:"0";i=d("WAStanzaUtils").toStanzaId((i=i)!=null?i:"0");p=d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(p||"");p=p.serverMediaType;s=d("WAHashUtils").stringToPlaintextHash(d("MAWHandleEchoMediaMsgsRestoreV2").getBase64WithoutPadding(s));e.media.add(s);if(!f.isAttachmentDownloadInProgressForPlaintextHash(s)&&!f.isAttachmentDownloadCompleteForPlaintextHash(s)){f.addPlaintextHashToAttachmentDownloadsInProgress(s);n=d("MAWHandleEchoMediaMsgsRestoreV2").constructMediaEntry(s,(f=n)!=null?f:"",q,m,r,p,o,l,k,null,j);f=d("WAMediaUtils").decodeMediaEntryData(n);void d("EncryptedBackupsDYIMessageProcessingUtils").startMediaDownloadChain(d("MebWAMediaDownloader").MebWADownloadMediaThroughTheBridge,"-8","msgr",f,b,a,g,i,s,c.sortOrderMs)}return e}g.processEBEchoMessagesForDYI=a}),98);
__d("MAWEncryptedBackupsDYIProcessProtobufMessages",["CurrentUser","EncryptedBackupsDYIMessageProcessingUtils","EncryptedBackupsDYISingleton","MAWEBUploadMessageUtils","MAWFrontendMediaUtils","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleEchoProtobufsRestoreApi","MAWJids","MAWMsgType","MebWAMediaDownloader","WAHashUtils","WAJids","WAMediaUtils","WAStanzaUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] Starting DYI media download for attachemnt with hash ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] Media message is missing media data"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Explicitly dropping "," message type"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Bump message is not supported in DYI"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] XMA message doesn't have xmaData"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Documents are not supported in DYI"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to calculate sortOrder for protobuf message"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error processing protobuf: ts or messageId or senderId is null"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error processing protobuf: metadata or message type is null"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error processing protobuf. Dropping the message: ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error converting protobuf to DYI format. Dropping the message"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error converting protobuf to DYI format. Dropping the message"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["Decoded protobuf is empty"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processing "," protobuf messages for thread ",""]);u=function(){return a};return a}function a(a,b,e){var f=d("EncryptedBackupsDYISingleton").getSingleton(),g=f.getLogger();void g.LOG(u(),e.length,b);var h=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());e.forEach(function(c){try{c=d("MAWHandleEchoProtobufsRestoreApi").decodeDecryptedMessageProtobuf(c,h);if(c==null){void g.WARN(t());return}if(c!=null&&c.metadata!=null&&c.metadata.messageId!=null){var e=d("WAStanzaUtils").toStanzaId(c.metadata.messageId);c=v(a,b,c);if(c==null){void g.WARN(s());return}f.setMessagesByThreadKey(a,e,c)}else{void g.WARN(r());return}}catch(a){void g.ERROR(q(),a);return}})}function v(a,b,e){var f,g=d("EncryptedBackupsDYISingleton").getSingleton(),h=g.getLogger(),i=e.metadata,q=e.msgType;if(i==null||q==null){void h.WARN(p());return}q=i.messageId;var r=i.senderId;i=i.timestampMs;if(i==null||typeof i!=="number"||q==null||r==null){void h.WARN(o());return}q=d("WATimeUtils").castMilliSecondsToUnixTime(i);i=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());i=d("MAWHandleEchoProtobufsRestoreApi").createUnstoredDbContentFromProtobufObject(e,d("WAJids").unsafeCoerceToChatJid(b),i);if((i==null?void 0:i.unstoredDbContent.unstoredDbMsg)==null){void h.WARN(n());return}i=d("MAWEBUploadMessageUtils").echoOverrideMessageSortOrder(i.unstoredDbContent.unstoredDbMsg);r=d("EncryptedBackupsDYIMessageProcessingUtils").buildBaseDyiMessage(r,i);f=(f=e.decodedPayload)==null?void 0:f.text;if(e.editMsgData.length>0){var s=q;e.editMsgData.forEach(function(a){var b;if(a.ts>s&&((b=a.editMsgContent.message)==null?void 0:b.text)!=null){s=a.ts;f=(b=a.editMsgContent.message)==null?void 0:b.text}})}e.reactionData.length>0&&(r.reactions=e.reactionData.map(function(a){var b=a.reaction;a=a.senderId;return{actor:(a=g.getContactNameForContactId(a))!=null?a:"unknown",reaction:(a=b.text)!=null?a:"unknown"}}));switch(e.msgType){case d("MAWMsgType").MSG_TYPE.TEXT:r.type="text";r.text=f||"";break;case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.PTT:r.type="media";r.text=f||"";r=w(a,b,e,i,r);break;case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:void h.WARN(m());return;case d("MAWMsgType").MSG_TYPE.XMA:r.type="link";if(e.xmaData==null){void h.WARN(l());return}r.text=((q=e.xmaData)==null?void 0:q.ctas.map(function(a){return a.nativeUrl}).filter(Boolean).join("\n"))||"";break;case d("MAWMsgType").MSG_TYPE.REVOKED:r.type="placeholder";r.isUnsent=!0;r.text="User unsent a message";break;case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:void h.WARN(k());return;default:void h.LOG(j(),e.msgType);return}return r}function w(a,b,c,e,f){var g,j=d("EncryptedBackupsDYISingleton").getSingleton(),k=j.getLogger();if(c.mediaMetadata==null){void k.WARN(i());return f}var l=c.mediaMetadata,m=l.attachmentObjectId,n=l.backupEntFbid,o=l.directPath,p=l.encryptedHash,q=l.filename,r=l.mediaContentType,s=l.mediaKey,t=l.mediaKeyTimestamp,u=l.plaintextHash;l=l.size;g=(g=(g=c.metadata)==null?void 0:g.senderId)!=null?g:"0";c=d("WAStanzaUtils").toStanzaId(c.externalId);u=d("WAHashUtils").stringToPlaintextHash(u);r=d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(r||"");r=r.serverMediaType;f.media.add(u);if(!j.isAttachmentDownloadInProgressForPlaintextHash(u)&&!j.isAttachmentDownloadCompleteForPlaintextHash(u)){void k.LOG(h(),u);j.addPlaintextHashToAttachmentDownloadsInProgress(u);j=d("MAWHandleEchoMediaMsgsRestoreV2").constructMediaEntry(u,(k=p)!=null?k:"",s,o,t,r,q,n,m,null,l);p=d("WAMediaUtils").decodeMediaEntryData(j);void d("EncryptedBackupsDYIMessageProcessingUtils").startMediaDownloadChain(d("MebWAMediaDownloader").MebWADownloadMediaThroughTheBridge,"-8","msgr",p,b,a,g,c,u,e)}return f}g.processEBProtobufMessagesForDYI=a}),98);
__d("MAWEncryptedBackupsDYIHandleMessageRestore",["EncryptedBackupsDYIHandleMessageRestore","I64","LSDatabaseSingleton","LSFactory","LSIntEnum","LSIssueMessageRangeQueryTaskStoredProcedure","LSMEBTaskCreationSource","MAWEBRestoreTrackingUtils","MAWEncryptedBackupsDYIProcessEchoMessages","MAWEncryptedBackupsDYIProcessProtobufMessages","asyncToGeneratorRuntime","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=(h||d("LSIntEnum")).ofNumber(c("LSMEBTaskCreationSource").MSGR_DYI),l=c("justknobx")._("467"),m=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){d("MAWEBRestoreTrackingUtils").markEBRestoreDYI(c("LSMEBTaskCreationSource").MSGR_DYI),yield a.runInTransaction(function(a){return c("LSIssueMessageRangeQueryTaskStoredProcedure")(c("LSFactory")(a),{isPointQuery:!1,newerNumMessages:(i||(i=d("I64"))).zero,numMessages:i.of_int32(l),source:k,startSortKey:b,threadId:e})},"readwrite",void 0,void 0,f.id+":41")});return function(b,c,d){return a.apply(this,arguments)}}();function a(a,b,c,d){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e){var f=(yield (j||(j=d("LSDatabaseSingleton"))).LSDatabaseSingleton);void d("EncryptedBackupsDYIHandleMessageRestore").handleMessageRangeQueryRestore(f,a,b,c,e,d("MAWEncryptedBackupsDYIProcessEchoMessages").processEBEchoMessagesForDYI,m)});return n.apply(this,arguments)}function e(a,b,c,d){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e){var f=(yield (j||(j=d("LSDatabaseSingleton"))).LSDatabaseSingleton);void d("EncryptedBackupsDYIHandleMessageRestore").handleMessageRangeQueryRestore(f,a,b,c,e,d("MAWEncryptedBackupsDYIProcessProtobufMessages").processEBProtobufMessagesForDYI,m)});return o.apply(this,arguments)}g.taskCreationSource=k;g.MESSENGER_DYI_BATCH_SIZE=l;g.handleMAWEchoMessageRangeQueryRestore=a;g.handleMAWProtobufMessageRangeQueryRestore=e}),98);
__d("MAWRestoreMessagesFromEncryptedBackupsDeferred",["LSDatabaseSingleton","LSVec","MAWEncryptedBackupUtils","Promise","gkx","promiseDone","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=c("requireDeferred")("MAWRestoreMessagesFromEncryptedBackupsNOP").__setRef("MAWRestoreMessagesFromEncryptedBackupsDeferred");function a(a,e,f,g,k,l,m,n,o,p,q){return j.load().then(function(j){var r=p!=null?Number(p):void 0;r=c("gkx")("201")?d("MAWEncryptedBackupUtils").getMessageMetadataFromDeanonAPI(e,f.length,r):(i||(i=b("Promise"))).resolve();return r.then(function(b){c("promiseDone")((h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton.then(function(c){return c.runInTransaction(function(c){return j.call(c,a,e,f,g,k,l,m,n,o,p,q,b)},"readwrite")}));return[c("LSVec").ofArray([]),c("LSVec").ofArray([]),!1]})})}g.call=a}),98);
__d("LSRestoreEchoBlobs.nop",["CurrentUser","EchoMessage","I64","LSIntEnum","LSMEBTaskCreationSource","LSVec","MAWAsyncEBPendingQueryPromise","MAWEBRestoreTrackingUtils","MAWEncryptedBackupUtils","MAWEncryptedBackupsDYIHandleMessageRestore","MAWHandleEBRestoreWithHIM","MAWJids","MAWJobDefinitions","MAWRestoreMessagesFromEncryptedBackupsDeferred","Promise","WAJids","WALogger","WATagsLogger","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["LSRestoreEchoBlobs error: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["LSRestoreEchoBlobs error: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Restoring Messenger DYI batch"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["restoreEchoBlobs - no messages returned but hasMoreBefore is true"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["restoreEchoBlobs - Failed to decode echo message, with error: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["restoreEchoBlobs - "," "," ",""]);p=function(){return a};return a}a=function(a,e,f,g,q,r,s,t,u,v,w,x,y){try{if(w!=null){d("WATagsLogger").TAGS(["labyrinth_web","echo_restore",(a=w)!=null?a:"no_request_id"]).LOG(p(),w,v,(e=x)!=null?e:"");d("MAWEBRestoreTrackingUtils").markEBRestoreEcho(y);f=c("LSVec").toArray(g);d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"native_op_start",traceId:w,type:"echo"});d("MAWAsyncEBPendingQueryPromise").resolvePendingQueryIfPresent(w,{hasMoreAfter:s,hasMoreBefore:q,messages:f.map(function(a){try{a=d("EchoMessage").decodeEchoMessage(a);if(a==null)return null;var b=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());b=d("MAWHandleEBRestoreWithHIM").convertEchoMessage(a,d("WAJids").unsafeCoerceToChatJid("threadId"+d("WAJids").MSGR_USER_DOMAIN),b);if(b==null||b.length===0)return null;b=(b=b[0].decodedMsg)==null?void 0:b.unstoredDbMsg;if(b==null)return null;b.sortOrderMs=a.sortOrderMs;return b}catch(b){d("WATagsLogger").TAGS(["labyrinth_web","echo_restore",(a=w)!=null?a:"no_request_id"]).ERROR(o(),b.message);return null}}).filter(Boolean),nextMessageTimestampMsBefore:r,restoreType:"echo"})}a=c("LSVec").toArray(g);d("MAWEncryptedBackupUtils").logIfDuplicateMessagesFoundInRestore(a,"echo_restore");if(q===!0&&a.length===0){d("WATagsLogger").TAGS(["labyrinth_web","echo_restore",(e=w)!=null?e:"no_request_id"]).ERROR(n())}f=y!=null&&(j||(j=d("LSIntEnum"))).toNumber(y)===c("LSMEBTaskCreationSource").BULK_QUERY_FOR_SEARCH_RESULT;if(f)return(h||(h=b("Promise"))).resolve([!0,c("LSVec").ofArray([]),c("LSVec").ofArray([])]);g=y!=null&&(j||(j=d("LSIntEnum"))).toNumber(y)===c("LSMEBTaskCreationSource").FTS_INDEX_EB_MESSAGES_WEB;if(g)return(h||(h=b("Promise"))).resolve([!0,c("LSVec").ofArray([]),c("LSVec").ofArray([])]);e=y!=null&&(j||(j=d("LSIntEnum"))).toNumber(y)===c("LSMEBTaskCreationSource").MSGR_DYI;f=c("gkx")("3057");if(e&&f){d("WATagsLogger").TAGS(["labyrinth_web","echo_restore",(g=w)!=null?g:"no_request_id"]).LOG(m());e=a.map(d("EchoMessage").decodeEchoMessage).filter(Boolean);void d("MAWEncryptedBackupsDYIHandleMessageRestore").handleMAWEchoMessageRangeQueryRestore(v,e,q,r);return(h||(h=b("Promise"))).resolve([!0,c("LSVec").ofArray([]),c("LSVec").ofArray([])])}c("promiseDone")(d("MAWRestoreMessagesFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(v),a.map(d("MAWJobDefinitions").toEncodedEchoMessage),q,r==null?void 0:(i||(i=d("I64"))).to_int32(r),s,t==null?void 0:(i||(i=d("I64"))).to_int32(t),u,w,x,y!=null?(j||(j=d("LSIntEnum"))).unwrapIntEnum(y):-1)["catch"](function(a){d("WALogger").ERROR(l(),a)}));return(h||(h=b("Promise"))).resolve([!0,c("LSVec").ofArray([]),c("LSVec").ofArray([])])}catch(a){d("WALogger").ERROR(k(),a);w!=null&&d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(w,a);return(h||(h=b("Promise"))).resolve([!0,c("LSVec").ofArray([]),c("LSVec").ofArray([])])}};g["default"]=a}),98);
__d("LSHandleMessageRestoreResponse",["LSArrayGetObjectAt","LSDecryptMessages","LSDeleteBackupOnClient","LSIsEncryptionVersionSecure","LSIssueNewEbTaskAndGetTaskIDV2","LSIssuePointQueryRestoreTask","LSLoadThreadPkFromThreadId","LSLogMebClientEvent.nop","LSLogWebQpl.nop","LSRestoreEchoBlobs.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][handleMessageRestoreResponse] Beginning execution."),d[1]=c.i64.of_float(Date.now()),a[7]?(d[11]="handleMessageRestoreResponse was called with instructions to delete the user's EB client state",function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageRestoreResponse] ","",d[11]].join("")),d[12]=c.createArray(),void 0!==void 0?d[13]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleMessageRestoreResponse",[d[11]].join(""),d[12],c.i64.cast([0,4]))):c.resolve()},function(e){return d[2]=a[5].get("request_id"),a[5],d[3]=c.i64.of_int32(a[0].length),d[2]!==void 0?c.nativeOperation(b("LSLogWebQpl.nop"),d[2],c.i64.cast([0,521476165]),"call_from_client",d[3],void 0,void 0):c.resolve()},function(b){return c.i64.neq(a[6],void 0)?c.sequence([function(b){return c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}).next().then(function(b,e){var f=b.done;b=b.value;return f?d[11]=!1:(e=b.item,d[14]=e.deviceId,c.i64.neq(d[14],void 0)?d[13]=c.i64.neq(d[14],a[6]):d[13]=!1,d[11]=d[13])})},function(a){return d[4]=d[11]}]):c.resolve(d[4]=!1)},function(e){return d[4]?(d[11]="Exiting early due to EBDevice ID mismatch",function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageRestoreResponse] ","",d[11]].join("")),d[12]=c.createArray(),void 0!==void 0?d[13]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleMessageRestoreResponse",[d[11]].join(""),d[12],c.i64.cast([0,4]))):c.sequence([function(b){return d[11]=a[5].get("reference_timestamp"),a[5],d[12]=a[5].get("request_id"),a[5],d[13]=a[5].get("restore_task_source"),a[5],c.i64.neq(a[6],void 0)?c.sequence([function(b){return c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}).next().then(function(b,e){var f=b.done;b=b.value;return f?d[20]=!1:(e=b.item,d[23]=e.deviceId,c.i64.neq(d[23],void 0)?d[22]=c.i64.neq(d[23],a[6]):d[22]=!1,d[20]=d[22])})},function(a){return d[14]=d[20]}]):c.resolve(d[14]=!1)},function(e){return d[14]?c.resolve((d[20]=new c.Map(),d[20].set("error_code",c.i64.cast([0,110])),d[20].set("stored_procedure","LSEncryptedBackupsHandleMessageRestoreResponseStoredProcedure"),d[20].set("error_message",""),d[15]=d[20])):c.sequence([function(e){return d[20]=c.i64.of_int32(a[0].length),d[12]!==void 0?c.nativeOperation(b("LSLogWebQpl.nop"),d[12],c.i64.cast([0,521476165]),"decryption_start",d[20],d[13],void 0):c.resolve()},function(e){return c.storedProcedure(b("LSDecryptMessages"),a[0],a[2]).then(function(a){return a=a,d[21]=a[0],d[22]=a[1],a})},function(e){return d[21]!==void 0?c.sequence([function(e){return c.storedProcedure(b("LSLoadThreadPkFromThreadId"),a[2]).then(function(a){return a=a,d[24]=a[0],d[25]=a[1],a})},function(e){return c.i64.neq(d[24],void 0)?c.sequence([function(e){return d[27]=c.i64.of_int32(a[0].length),d[12]!==void 0?c.nativeOperation(b("LSLogWebQpl.nop"),d[12],c.i64.cast([0,521476165]),"decryption_success",d[27],d[13],void 0):c.resolve()},function(e){return void 0!==void 0?c.resolve(d[28]=void 0):c.sequence([function(a){return d[29]=c.createArray(),d[30]=c.i64.of_int32(d[21].length),c.i64.gt(d[30],c.i64.cast([0,0]))?c.loopAsync(d[30],function(a){return d[39]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[21],d[39]).then(function(a){return a=a,d[40]=a[0],d[41]=a[1],a})},function(a){return d[42]=d[40].get("value"),d[40],d[43]=(d[29].push(d[42]),d[29])}])}):c.resolve()},function(e){return d[31]=a[1].get("has_more_before"),a[1],d[32]=a[1].get("next_message_timestamp_ms_before"),a[1],d[33]=a[1].get("has_more_after"),a[1],d[34]=a[1].get("next_message_timestamp_ms_after"),a[1],c.nativeOperation(b("LSRestoreEchoBlobs.nop"),d[24],d[29],d[31],d[32],d[33],d[34],a[4],a[2],d[12],d[11],d[13]).then(function(a){return a=a,d[35]=a[0],d[36]=a[1],d[37]=a[2],a})},function(e){return a[7]?c.storedProcedure(b("LSDeleteBackupOnClient"),void 0,void 0,!0,d[12],void 0,!0):c.resolve()},function(e){return d[35]?c.sequence([function(e){return d[39]=c.i64.of_int32(d[37].length),d[40]=c.i64.of_int32(d[36].length),c.i64.eq(d[40],d[39])?c.sequence([function(e){return d[42]=c.i64.cast([0,0]),d[43]=c.i64.of_int32(d[37].length),c.i64.gt(d[43],c.i64.cast([0,0]))?c.loopAsync(d[43],function(e){return d[44]=e,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[37],d[44]).then(function(a){return a=a,d[45]=a[0],d[46]=a[1],a})},function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[36],d[42]).then(function(a){return a=a,d[47]=a[0],d[48]=a[1],a})},function(e){return c.storedProcedure(b("LSIssuePointQueryRestoreTask"),a[2],d[47],d[45],void 0,c.i64.cast([0,35])).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[42]=c.i64.add(d[42],c.i64.cast([0,1]))}])}):c.resolve()},function(a){return d[41]=void 0}]):c.resolve((d[42]=new c.Map(),d[42].set("error_code",c.i64.cast([0,106])),d[42].set("stored_procedure","LSEncryptedBackupsHandleMessageRestoreResponseStoredProcedure"),d[42].set("error_message",""),d[41]=d[42]))},function(a){return d[38]=void 0}]):c.resolve((d[39]=new c.Map(),d[39].set("error_code",c.i64.cast([0,105])),d[39].set("stored_procedure","LSEncryptedBackupsHandleMessageRestoreResponseStoredProcedure"),d[39].set("error_message",""),d[38]=d[39]))},function(a){return d[28]=d[38]}])},function(a){return d[26]=d[28]}]):c.resolve(d[26]=d[25])},function(a){return d[23]=d[26]}]):c.resolve((d[22]!==void 0?(d[24]=d[22].get("error_code"),d[22],c.i64.eq(d[24],c.i64.cast([0,1]))?0:0):0,d[23]=d[22]))},function(a){return d[15]=d[23]}])},function(e){return d[15]!==void 0?c.sequence([function(e){return d[20]=c.i64.of_int32(a[0].length),d[12]!==void 0?c.nativeOperation(b("LSLogWebQpl.nop"),d[12],c.i64.cast([0,521476165]),"decryption_fail",d[20],d[13],!1):c.resolve()},function(e){return a[7]?c.storedProcedure(b("LSDeleteBackupOnClient"),void 0,void 0,!0,d[12],void 0,!0):c.resolve()},function(e){return d[21]=d[15].get("error_code"),d[15],d[22]=d[15].get("stored_procedure"),d[15],d[23]=a[5].get("restore_operation_type"),a[5],d[24]=d[15].get("error_message"),d[15],c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,e){var f=a.done;a=a.value;return f?d[25]=void 0:(e=a.item,c.sequence([function(a){return d[45]=e.deviceId,d[44]=e.backupTenancy,d[43]=e.encryptionVersion,d[38]=void 0,c.i64.neq(d[38],void 0)?c.resolve(d[39]=d[38]):c.sequence([function(a){return d[46]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[47]=a[0],a})},function(a){return d[47]?d[56]=(d[46].push(c.i64.cast([0,0])),d[46]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[48]=a[0],a})},function(a){return d[48]?d[56]=(d[46].push(c.i64.cast([0,2])),d[46]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[49]?d[56]=(d[46].push(c.i64.cast([0,3])),d[46]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[50]=a[0],a})},function(a){return d[50]?d[56]=(d[46].push(c.i64.cast([0,4])),d[46]):0,d[51]=c.createArray(),d[52]=c.i64.of_int32(d[46].length),c.i64.gt(d[52],c.i64.cast([0,0]))?c.loopAsync(d[52],function(a){return d[56]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[46],d[56]).then(function(a){return a=a,d[57]=a[0],d[58]=a[1],a})},function(a){return d[59]=(d[51].push(d[57]),d[51])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[56]=c.createArray(),d[57]=c.i64.of_int32(d[51].length),c.i64.gt(d[57],c.i64.cast([0,0]))?c.loopAsync(d[57],function(a){return d[59]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[51],d[59]).then(function(a){return a=a,d[60]=a[0],d[61]=a[1],a})},function(a){return d[62]=(d[56].push(c.i64.to_string(d[60])),d[56])}])}):c.resolve()},function(a){return d[58]=d[56].join(","),d[53]=d[58]}])},function(a){return d[51].some(function(a){return c.i64.eq(d[43],a)})?d[54]=d[43]:d[54]=void 0,c.i64.neq(d[54],void 0)?d[55]=d[54]:d[55]=void 0,d[39]=d[55]}])},function(a){return c.i64.neq(d[39],void 0)?d[40]=d[39]:d[40]=c.i64.cast([0,0]),c.i64.neq(d[44],void 0)?d[41]=d[44]:d[41]=c.i64.cast([0,1]),c.i64.neq(d[45],void 0)?d[42]=d[45]:d[42]=void 0,d[25]=d[42]}]))})},function(e){return d[27]=new c.Map(),d[27].set("error_code",d[21]),d[27].set("error_message",d[24]==null?"":d[24]),d[27].set("stored_procedure",d[22]),d[28]=new c.Map(),d[28].set("act_thread_id",a[2]),d[28].set("source",d[13]),d[28].set("restore_operation_type",d[23]),d[28].set("request_id",d[12]),d[28].set("device_id",d[25]),d[29]=new c.Map(),d[29].set("restore_context",d[28]),d[29].set("failure",d[27]),d[30]=d[29].get("restore_context"),d[29],d[31]=d[30].get("act_thread_id"),d[30],d[32]=c.toJSON(d[29]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),["encrypted_backups_restore",":",d[31]].join(""),c.i64.cast([0,50030]),d[32],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[33]=a[0],a})},function(b){return d[34]=a[5].get("restore_operation_type"),a[5],d[35]=d[15].get("error_code"),d[15],d[36]=d[15].get("error_code"),d[15],d[37]=" ",d[16]=["Failed (",d[37],c.i64.to_string(d[36]),d[37],")"].join("")}]):c.resolve((d[20]=a[5].get("restore_operation_type"),a[5],d[16]="Succeeded"))},function(e){return d[17]="",d[18]=["Message Restore Status: ",d[17],d[16],d[17],". ACT Thread ID: ",d[17],a[2]].join(""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageRestoreResponse] ","",d[18]].join("")),d[19]=c.createArray(),void 0!==void 0?d[20]=(d[19].push(void 0),d[19]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleMessageRestoreResponse",[d[18]].join(""),d[19],c.i64.cast([0,4]))}])},function(a){return d[5]=c.i64.of_float(Date.now()),d[6]=c.i64.random(),d[8]="Finishing execution. Execution time: ",d[9]=c.i64.to_string(c.i64.sub(d[5],d[0])),d[10]=" ms",d[7]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageRestoreResponse] ",d[7],d[8],d[7],d[9],d[7],d[10]].join("")),c.i64.eq(c.i64.mod_(d[6],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[11]=",",d[12]=c.createArray(),void 0!==void 0?d[13]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleMessageRestoreResponse",[d[8],d[11],d[9],d[11],d[10]].join(""),d[12],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsHandleMessageRestoreResponseStoredProcedure";e.exports=a}),null);/*FB_PKG_DELIM*/
__d("WAParsableWapNode",["WABinary","WAErr","WAJids","WALogger","WALongInt","WAParsableXmlNode","WASignalKeys","WATimeUtils","WAWap","WAWapJid"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["ParsableWapNode: attrFromJid() is called with ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["ParsableWapNode: attrFromJid() is called with ",""]);i=function(){return a};return a}var j=function(b){babelHelpers.inheritsLoose(a,b);function a(a,c){var d;d=b.call(this,"XmppParsingFailure: "+a+": "+c)||this;d.name="XmppParsingFailure";d.parser=a;d.reason=c;return d}var c=a.prototype;c.toString=function(){return"XmppParsingFailure: "+this.parser+": "+this.reason};return a}(babelHelpers.wrapNativeSuper(Error));a=function(a){babelHelpers.inheritsLoose(b,a);function b(b,c){return a.call(this,b,c)||this}var e=b.prototype;e.assertFromServer=function(){var a=this.attrString("from");a!==d("WAJids").WA_SERVER_JID_SUFFIX&&this["throw"]('to have "from"="s.whatsapp.net", but instead has "'+a+'"')};e.attrUserJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);return c.userJid==null?this["throw"]('to have "'+a+'"={UserJid}, but instead has "'+b+'"'):c.userJid};e.attrPhoneUserJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);return c.jidType==="phoneUser"?c.userJid:this["throw"]('to have "'+a+'"={PhoneUserJid}, but instead has "'+b+'"')};e.attrLidUserJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);return c.jidType==="lidUser"?c.userJid:this["throw"]('to have "'+a+'"={LidUserJid}, but instead has "'+b+'"')};e.maybeAttrUserJid=function(a){return this.hasAttr(a)?this.attrUserJid(a):null};e.maybeAttrPhoneUserJid=function(a){return this.hasAttr(a)?this.attrPhoneUserJid(a):null};e.maybeAttrLidUserJid=function(a){return this.hasAttr(a)?this.attrLidUserJid(a):null};e.attrGroupJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);return c.groupJid==null?this["throw"]('to have "'+a+'"={GroupJid}, but instead has "'+b+'"'):c.groupJid};e.maybeAttrGroupJid=function(a){return this.hasAttr(a)?this.attrGroupJid(a):null};e.attrChatJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);if(c.userJid!=null)return c.userJid;return c.groupJid!=null?c.groupJid:this["throw"]('to have "'+a+'"={ChatJid}, but instead has "'+b+'"')};e.attrPhoneChatJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);if(c.jidType==="phoneUser")return c.userJid;else if(c.jidType==="group")return c.groupJid;else return this["throw"]('to have "'+a+'"={ChatJid}, but instead has "'+b+'"')};e.attrDeviceJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);if(c.deviceJid!=null)return c.deviceJid;if(c.userJid!=null)return d("WAJids").defaultDeviceJidForUser(c.userJid);if(c.hostedDeviceJid!=null)return c.hostedDeviceJid;return c.hostedLidDeviceJid!=null?c.hostedLidDeviceJid:this["throw"]('to have "'+a+'"={DeviceJid}, but instead has "'+b+'"')};e.attrPhoneDeviceJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);if(c.jidType==="phoneDevice")return c.deviceJid;return c.jidType==="phoneUser"?d("WAJids").defaultPhoneDeviceJidForUser(c.userJid):this["throw"]('to have "'+a+'"={PhoneDeviceJid}, but instead has "'+b+'"')};e.attrLidDeviceJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);if(c.jidType==="lidDevice")return c.deviceJid;return c.jidType==="lidUser"?d("WAJids").defaultLidDeviceJidForLidUserJid(c.userJid):this["throw"]('to have "'+a+'"={LidDeviceJid}, but instead has "'+b+'"')};e.attrDeviceId=function(a){a=this.attrInt(a);return d("WAJids").interpretAsDeviceId(a)};e.attrFromJidChat=function(){var a=this.attrJidWithType();switch(a.jidType){case"msgrUser":var b=a.userJid,e=d("WAJids").defaultDeviceJidForUser(b);return{type:"device",chat:b,deviceJid:e,author:e};case"interopUser":b=a.userJid;e=d("WAJids").defaultDeviceJidForUser(b);return{type:"device",chat:b,deviceJid:e,author:e};case"phoneUser":b=a.userJid;e=d("WAJids").defaultDeviceJidForUser(b);return{type:"device",chat:b,deviceJid:e,author:e};case"lidUser":b=a.userJid;e=d("WAJids").defaultLidDeviceJidForLidUserJid(b);return{type:"device",chat:b,deviceJid:e,author:e};case"phoneDevice":b=a.deviceJid;return{type:"device",chat:d("WAJids").extractUserJid(b),deviceJid:b,author:b};case"msgrDevice":e=a.deviceJid;return{type:"device",chat:d("WAJids").extractUserJid(e),deviceJid:e,author:e};case"interopDevice":b=a.deviceJid;return{type:"device",chat:d("WAJids").extractUserJid(b),deviceJid:b,author:b};case"lidDevice":e=a.deviceJid;return{type:"device",chat:d("WAJids").extractUserJid(e),deviceJid:e,author:e};case"group":b=this.hasAttr("participant")?this.attrDeviceJid("participant"):null;return b==null?this["throw"]("expected to have participant JID for group"):{type:"group",chat:a.groupJid,groupJid:a.groupJid,author:b};case"broadcast":e=this.hasAttr("participant")?this.attrDeviceJid("participant"):null;return e==null?this["throw"]("expected to have participant JID for group"):{type:"broadcast",broadcastJid:a.broadcastJid,chat:d("WAJids").extractUserJid(e),author:e};case"hosted":b=a.hostedDeviceJid;return{type:"device",chat:d("WAJids").extractUserJid(b),deviceJid:b,author:b};case"hostedLid":e=a.hostedLidDeviceJid;return{type:"device",chat:d("WAJids").extractUserJid(e),deviceJid:e,author:e};case"call":d("WALogger").ERROR(i(),a.callJid);throw c("WAErr")("ParsableWapNode: attrFromJid() does not support CallJid");default:a.jidType;return this["throw"]("attrFromJidChat should not be used with jid of type "+a.jidType)}};e.attrFromJidPhoneChat=function(){var a=this.attrJidWithType();switch(a.jidType){case"phoneUser":var b=a.userJid,e=d("WAJids").defaultPhoneDeviceJidForUser(b);return{type:"device",chat:b,deviceJid:e,author:e};case"phoneDevice":b=a.deviceJid;return{type:"device",chat:d("WAJids").extractPhoneUserJid(b),deviceJid:b,author:b};case"group":e=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return e==null?this["throw"]("expected to have participant JID for group"):{type:"group",chat:a.groupJid,groupJid:a.groupJid,author:e};case"broadcast":b=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return b==null?this["throw"]("expected to have participant JID for group"):{type:"broadcast",broadcastJid:a.broadcastJid,chat:d("WAJids").extractPhoneUserJid(b),author:b};case"call":d("WALogger").ERROR(h(),a.callJid);throw c("WAErr")("ParsableWapNode: attrFromJid() does not support CallJid");default:a.jidType;return this["throw"]("attrFromJidChat should not be used with jid of type "+a.jidType)}};e.attrFromPhoneJid=function(){var a=this.attrJidWithType();if(a.jidType==="status"){a=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return a==null?this["throw"]("to have participant for status msg"):{type:"status",author:a}}else return this.attrFromJidPhoneChat()};e.attrFromJid=function(){var a=this.attrJidWithType();if(a.jidType==="status"){var b=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return b==null?this["throw"]("to have participant for status msg"):{type:"status",author:b}}if(a.jidType==="newsletter")return{type:"newsletter",newsletterJid:a.newsletterJid};if(a.jidType==="hosted")return{type:"hosted",hostedDeviceJid:a.hostedDeviceJid};return a.jidType==="hostedLid"?{type:"hostedLid",hostedLidDeviceJid:a.hostedLidDeviceJid}:this.attrFromJidChat()};e.attrJidWithType=function(a){a===void 0&&(a="from");var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);return c.jidType==="unknown"?this["throw"]('to have "'+a+'"={Jid}, but instead has "'+b+'"'):c};e.attrWapJid=function(a){a===void 0&&(a="from");a=this.attrString(a);var b=d("WAJids").interpretAndValidateJid(a);return b.jidType==="unknown"?d("WAWapJid").WapJid.create(null,a):d("WAWap").JID(d("WAJids").extractFromJid(b))};e.attrLongInt=function(a){a=this.attrString(a);return d("WALongInt").decimalStringToLongInt(a)};e.attrTime=function(a){return d("WATimeUtils").castToUnixTime(this.attrInt(a))};e.attrFutureTime=function(a){a=this.attrInt(a);return d("WATimeUtils").futureUnixTime(a)};e.contentString=function(){if(this.hasChildren())return this["throw"]("to have string content, but has children instead");else if(this.hasContent()){var a=new(d("WABinary").Binary)(this.contentBytes());return a.readString(a.size())}else return this["throw"]("to have content")};e.decodeAsString=function(a){return d("WAWap").decodeAsString(a)};e.contentSerializedPubKey=function(){if(this.hasContent())return d("WASignalKeys").serializeIdentity(this.contentBytes());else return this["throw"]("to have content")};e.createParseError=function(a){return new j(this.name(),"expected <"+this.tag()+"> "+a)};e["throw"]=function(a){throw this.createParseError(a)};return b}(d("WAParsableXmlNode").ParsableXmlNode);g.XmppParsingFailure=j;g.ParsableWapNode=a}),98);
__d("WADeprecatedWapParser",["WAErr","WAParsableWapNode"],(function(a,b,c,d,e,f,g){"use strict";a=function(){function a(a,b){this.$1=a,this.$2=b}var b=a.prototype;b.parse=function(a){a=new(d("WAParsableWapNode").ParsableWapNode)(this.$1,a);try{return{success:this.$2(a)}}catch(a){if(a instanceof d("WAParsableWapNode").XmppParsingFailure)return{error:a};else throw a}};b.parseOrThrow=function(a){a=this.parse(a);if(a.error)throw c("WAErr")(String(a.error));return a.success};return a}();g["default"]=a}),98);
__d("WAAckParser",["WADeprecatedWapParser","WAJids"],(function(a,b,c,d,e,f,g){"use strict";b=new(c("WADeprecatedWapParser"))("ack",function(a){a.assertTag("ack");return{id:a.attrString("id"),ts:a.maybeAttrString("t"),"class":a.attrString("class"),type:a.maybeAttrString("type"),from:a.attrJidWithType(),participant:a.hasAttr("participant")?a.attrDeviceJid("participant"):null,recipient:a.hasAttr("recipient")?a.attrUserJid("recipient"):null}});function a(a,b){return a.id===b.id&&(b["class"]===void 0||a["class"]===b["class"])&&(b.type===void 0||a.type===b.type)&&(b.from===void 0||h(a.from,b.from))&&(b.participant===void 0||a.participant===b.participant)&&(b.recipient===void 0||a.recipient===b.recipient)&&(b.ts===void 0||a.ts===b.ts)}function h(a,b){if(d("WAJids").extractFromJid(a)===b)return!0;if(a.userJid!=null)return d("WAJids").defaultDeviceJidForUser(a.userJid)===b;if(a.deviceJid!=null){a=a.deviceJid;return d("WAJids").extractDeviceId(a)===0&&d("WAJids").extractUserJid(a)===b}return!1}g.AckParser=b;g.ackMatchesTemplate=a;g.fromJidsAreEqual=h}),98);
__d("WAConsumerApplication.pb",["WACommon.pb","WAProtoConst"],(function(a,b,c,d,e,f,g){var h;a={SMALL:1,MEDIUM:2,LARGE:3};b={SANS_SERIF:0,SERIF:1,NORICAN_REGULAR:2,BRYNDAN_WRITE:3,BEBASNEUE_REGULAR:4,OSWALD_HEAVY:5};c={NONE:0,VIDEO:1};e={};f={};var i={},j={},k={},l={},m={},n={},o={},p={},q={},r={},s={},t={},u={},v={},w={},x={},y={},z={},A={},B={},C={},D={},E={},F={},G={},H={},I={},J={},K={},L={},M={};e.internalSpec={payload:[1,(h=d("WAProtoConst")).TYPES.MESSAGE,f],metadata:[2,h.TYPES.MESSAGE,j]};f.internalSpec={content:[1,h.TYPES.MESSAGE,m],applicationData:[2,h.TYPES.MESSAGE,l],signal:[3,h.TYPES.MESSAGE,k],subProtocol:[4,h.TYPES.MESSAGE,i],__oneofs__:{payload:["content","applicationData","signal","subProtocol"]}};i.internalSpec={futureProof:[1,h.TYPES.ENUM,(d=d("WACommon.pb")).FUTURE_PROOF_BEHAVIOR]};j.internalSpec={specialTextSize:[1,h.TYPES.ENUM,a]};k.internalSpec={};l.internalSpec={revoke:[1,h.TYPES.MESSAGE,v],__oneofs__:{applicationContent:["revoke"]}};m.internalSpec={messageText:[1,h.TYPES.MESSAGE,d.MessageTextSpec],imageMessage:[2,h.TYPES.MESSAGE,I],contactMessage:[3,h.TYPES.MESSAGE,A],locationMessage:[4,h.TYPES.MESSAGE,D],extendedTextMessage:[5,h.TYPES.MESSAGE,C],statusTextMessage:[6,h.TYPES.MESSAGE,B],documentMessage:[7,h.TYPES.MESSAGE,F],audioMessage:[8,h.TYPES.MESSAGE,H],videoMessage:[9,h.TYPES.MESSAGE,G],contactsArrayMessage:[10,h.TYPES.MESSAGE,z],liveLocationMessage:[11,h.TYPES.MESSAGE,y],stickerMessage:[12,h.TYPES.MESSAGE,E],groupInviteMessage:[13,h.TYPES.MESSAGE,x],viewOnceMessage:[14,h.TYPES.MESSAGE,w],reactionMessage:[16,h.TYPES.MESSAGE,u],pollCreationMessage:[17,h.TYPES.MESSAGE,s],pollUpdateMessage:[18,h.TYPES.MESSAGE,r],editMessage:[19,h.TYPES.MESSAGE,n],__oneofs__:{content:["messageText","imageMessage","contactMessage","locationMessage","extendedTextMessage","statusTextMessage","documentMessage","audioMessage","videoMessage","contactsArrayMessage","liveLocationMessage","stickerMessage","groupInviteMessage","viewOnceMessage","reactionMessage","pollCreationMessage","pollUpdateMessage","editMessage"]}};n.internalSpec={key:[1,h.TYPES.MESSAGE,d.MessageKeySpec],message:[2,h.TYPES.MESSAGE,d.MessageTextSpec],timestampMs:[3,h.TYPES.INT64]};o.internalSpec={pollOption:[1,h.FLAGS.REPEATED|h.TYPES.MESSAGE,t]};p.internalSpec={selectedOptions:[1,h.FLAGS.REPEATED|h.TYPES.BYTES],senderTimestampMs:[2,h.TYPES.INT64]};q.internalSpec={encPayload:[1,h.TYPES.BYTES],encIv:[2,h.TYPES.BYTES]};r.internalSpec={pollCreationMessageKey:[1,h.TYPES.MESSAGE,d.MessageKeySpec],vote:[2,h.TYPES.MESSAGE,q],addOption:[3,h.TYPES.MESSAGE,q]};s.internalSpec={encKey:[1,h.TYPES.BYTES],name:[2,h.TYPES.STRING],options:[3,h.FLAGS.REPEATED|h.TYPES.MESSAGE,t],selectableOptionsCount:[4,h.TYPES.UINT32]};t.internalSpec={optionName:[1,h.TYPES.STRING]};u.internalSpec={key:[1,h.TYPES.MESSAGE,d.MessageKeySpec],text:[2,h.TYPES.STRING],groupingKey:[3,h.TYPES.STRING],senderTimestampMs:[4,h.TYPES.INT64],reactionMetadataDataclassData:[5,h.TYPES.STRING],style:[6,h.TYPES.INT32]};v.internalSpec={key:[1,h.TYPES.MESSAGE,d.MessageKeySpec]};w.internalSpec={imageMessage:[1,h.TYPES.MESSAGE,I],videoMessage:[2,h.TYPES.MESSAGE,G],__oneofs__:{viewOnceContent:["imageMessage","videoMessage"]}};x.internalSpec={groupJid:[1,h.TYPES.STRING],inviteCode:[2,h.TYPES.STRING],inviteExpiration:[3,h.TYPES.INT64],groupName:[4,h.TYPES.STRING],jpegThumbnail:[5,h.TYPES.BYTES],caption:[6,h.TYPES.MESSAGE,d.MessageTextSpec]};y.internalSpec={location:[1,h.TYPES.MESSAGE,L],accuracyInMeters:[2,h.TYPES.UINT32],speedInMps:[3,h.TYPES.FLOAT],degreesClockwiseFromMagneticNorth:[4,h.TYPES.UINT32],caption:[5,h.TYPES.MESSAGE,d.MessageTextSpec],sequenceNumber:[6,h.TYPES.INT64],timeOffset:[7,h.TYPES.UINT32]};z.internalSpec={displayName:[1,h.TYPES.STRING],contacts:[2,h.FLAGS.REPEATED|h.TYPES.MESSAGE,A]};A.internalSpec={contact:[1,h.TYPES.MESSAGE,d.SubProtocolSpec]};B.internalSpec={text:[1,h.TYPES.MESSAGE,C],textArgb:[6,h.TYPES.FIXED32],backgroundArgb:[7,h.TYPES.FIXED32],font:[8,h.TYPES.ENUM,b]};C.internalSpec={text:[1,h.TYPES.MESSAGE,d.MessageTextSpec],matchedText:[2,h.TYPES.STRING],canonicalUrl:[3,h.TYPES.STRING],description:[4,h.TYPES.STRING],title:[5,h.TYPES.STRING],thumbnail:[6,h.TYPES.MESSAGE,d.SubProtocolSpec],previewType:[7,h.TYPES.ENUM,c]};D.internalSpec={location:[1,h.TYPES.MESSAGE,L],address:[2,h.TYPES.STRING]};E.internalSpec={sticker:[1,h.TYPES.MESSAGE,d.SubProtocolSpec]};F.internalSpec={document:[1,h.TYPES.MESSAGE,d.SubProtocolSpec],fileName:[2,h.TYPES.STRING]};G.internalSpec={video:[1,h.TYPES.MESSAGE,d.SubProtocolSpec],caption:[2,h.TYPES.MESSAGE,d.MessageTextSpec]};H.internalSpec={audio:[1,h.TYPES.MESSAGE,d.SubProtocolSpec],ptt:[2,h.TYPES.BOOL]};I.internalSpec={image:[1,h.TYPES.MESSAGE,d.SubProtocolSpec],caption:[2,h.TYPES.MESSAGE,d.MessageTextSpec]};J.internalSpec={polygonVertices:[1,h.FLAGS.REPEATED|h.TYPES.MESSAGE,K],location:[2,h.TYPES.MESSAGE,L],__oneofs__:{action:["location"]}};K.internalSpec={x:[1,h.TYPES.DOUBLE],y:[2,h.TYPES.DOUBLE]};L.internalSpec={degreesLatitude:[1,h.TYPES.DOUBLE],degreesLongitude:[2,h.TYPES.DOUBLE],name:[3,h.TYPES.STRING]};M.internalSpec={protocol:[1,h.TYPES.MESSAGE,d.SubProtocolSpec]};g.CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE=a;g.CONSUMER_APPLICATION_STATUS_TEXT_MESAGE_FONT_TYPE=b;g.CONSUMER_APPLICATION_EXTENDED_TEXT_MESSAGE_PREVIEW_TYPE=c;g.ConsumerApplicationSpec=e;g.ConsumerApplication$PayloadSpec=f;g.ConsumerApplication$SubProtocolPayloadSpec=i;g.ConsumerApplication$MetadataSpec=j;g.ConsumerApplication$SignalSpec=k;g.ConsumerApplication$ApplicationDataSpec=l;g.ConsumerApplication$ContentSpec=m;g.ConsumerApplication$EditMessageSpec=n;g.ConsumerApplication$PollAddOptionMessageSpec=o;g.ConsumerApplication$PollVoteMessageSpec=p;g.ConsumerApplication$PollEncValueSpec=q;g.ConsumerApplication$PollUpdateMessageSpec=r;g.ConsumerApplication$PollCreationMessageSpec=s;g.ConsumerApplication$OptionSpec=t;g.ConsumerApplication$ReactionMessageSpec=u;g.ConsumerApplication$RevokeMessageSpec=v;g.ConsumerApplication$ViewOnceMessageSpec=w;g.ConsumerApplication$GroupInviteMessageSpec=x;g.ConsumerApplication$LiveLocationMessageSpec=y;g.ConsumerApplication$ContactsArrayMessageSpec=z;g.ConsumerApplication$ContactMessageSpec=A;g.ConsumerApplication$StatusTextMesageSpec=B;g.ConsumerApplication$ExtendedTextMessageSpec=C;g.ConsumerApplication$LocationMessageSpec=D;g.ConsumerApplication$StickerMessageSpec=E;g.ConsumerApplication$DocumentMessageSpec=F;g.ConsumerApplication$VideoMessageSpec=G;g.ConsumerApplication$AudioMessageSpec=H;g.ConsumerApplication$ImageMessageSpec=I;g.ConsumerApplication$InteractiveAnnotationSpec=J;g.ConsumerApplication$PointSpec=K;g.ConsumerApplication$LocationSpec=L;g.ConsumerApplication$MediaPayloadSpec=M}),98);
__d("WAMsgIdToMessageKey",["WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.author,c=a.externalId;a=a.chat;var e=d("WAJids").isAuthorMe(b),f=d("WAJids").interpretAsGroupJid(a);b=e?d("WAGlobals").getMyUserJid():b;a=a;f=f!=null?b:void 0;return{fromMe:e,id:c,remoteJid:a,participant:f}}g.msgIdToMessageKey=a}),98);
__d("WAAsConsumerApplication",["WAAssertUnreachable","WAConsumerApplication.pb","WAErr","WAMsgIdToMessageKey","WAMsgType"],(function(a,b,c,d,e,f,g){"use strict";b="image/jpeg";e="video/mp4";f="audio/wav";var h="image/gif",i="image/webp";function a(a){switch(a.type){case d("WAMsgType").MSG_TYPE.TEXT:return j(a);case d("WAMsgType").MSG_TYPE.REACTION:return k(a);case d("WAMsgType").MSG_TYPE.REVOKED:return l(a);default:return c("WAAssertUnreachable")(a.type)}}function j(a){var b={payload:{content:{messageText:{mentionedJid:[],text:a.msgContent.content}}}};if(a.specialTextSize!=null){a=a.specialTextSize===1?d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.SMALL:a.specialTextSize===2?d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.MEDIUM:d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.LARGE;b.metadata={specialTextSize:a}}return b}function k(a){if(a.reactToMsgId==null)throw c("WAErr")("cannot send reaction that reacts to no message");var b=d("WAMsgIdToMessageKey").msgIdToMessageKey(a.reactToMsgId);b={groupingKey:a.groupingKey==null?void 0:a.groupingKey,key:b,senderTimestampMs:a.ts,text:a.reaction==null?void 0:a.reaction};return{payload:{content:{reactionMessage:b}}}}function l(a){a={remoteJid:a.id.chat,fromMe:!0,id:a.revokedExternalId};return{payload:{applicationData:{revoke:{key:a}}}}}g.IMAGE_MIME_TYPE=b;g.VIDEO_MIME_TYPE=e;g.AUDIO_MIME_TYPE=f;g.GIF_MIME_TYPE=h;g.STICKER_MIME_TYPE=i;g.asConsumerApplication=a;g.encodeTextMessage=j;g.encodeReactionMessage=k}),98);
__d("WAFrankingTypes",[],(function(a,b,c,d,e,f){"use strict";function a(a){return a}function b(a){return a}f.castToFrankingTag=a;f.castToFrankingKey=b}),66);
__d("WAFranking",["$InternalEnum","WACryptoDependencies","WACryptoHmac","WACryptoUtils","WAFrankingTypes","WAGlobals","WAPREList","WAPREMetrics","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h=32,i=0,j=b("$InternalEnum").Mirrored(["KEEP","DROP"]);function a(){var a=new Uint8Array(h);d("WACryptoDependencies").getCrypto().getRandomValues(a);return d("WAFrankingTypes").castToFrankingKey(a)}function c(a){return(a=a)!=null?a:i}function e(a,b){return d("WACryptoHmac").hmacSha256(a,b).then(function(a){return d("WAFrankingTypes").castToFrankingTag(new Uint8Array(a))})}function k(a,c,e,f){var g;return b("regeneratorRuntime").async(function(h){while(1)switch(h.prev=h.next){case 0:h.t0=f;h.next=h.t0===void 0?3:h.t0===0?3:7;break;case 3:h.next=5;return b("regeneratorRuntime").awrap(d("WACryptoHmac").hmacSha256(c,a));case 5:g=h.sent;return h.abrupt("return",d("WACryptoUtils").uint8ArraysEqual(new Uint8Array(g),e));case 7:return h.abrupt("return",!0);case 8:case"end":return h.stop()}},null,this)}function f(a,c){var e,f,g,h,i,l,m,n;return b("regeneratorRuntime").async(function(o){while(1)switch(o.prev=o.next){case 0:if(!(!d("WAGlobals").getConfig().isFrankingEnabled()||a.version==="v3"&&a.type==="instamadillo")){o.next=2;break}return o.abrupt("return",{decision:j.KEEP,updatedReportingMeta:c});case 2:g=d("WAGlobals").getConfig().isFrankingDropOnInvalid();if(!((c==null?void 0:c.frankingTag)!=null&&((e=a.metadata)==null?void 0:e.frankingKey)==null)){o.next=7;break}c.frankingTag=null;c.reportingTag=null;return o.abrupt("return",{decision:j.KEEP,updatedReportingMeta:c});case 7:if(!((c==null?void 0:c.frankingTag)!=null&&a.version==="v3"&&a.type==="subprotocol"&&((f=a.metadata)==null?void 0:f.frankingKey)!=null&&a.frankingContent!=null)){o.next=24;break}h=c.frankingTag;i=a.frankingContent,l=a.metadata.frankingVersion;m=d("WAFrankingTypes").castToFrankingKey(new Uint8Array(a.metadata.frankingKey));n=d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.FRANKING_VALIDATION);if(!(m==null)){o.next=15;break}n.endFail("tagButNoKey");return o.abrupt("return",g?{decision:j.DROP,updatedReportingMeta:c}:{decision:j.KEEP,updatedReportingMeta:c});case 15:o.next=17;return b("regeneratorRuntime").awrap(k(new Uint8Array(i),m,h,l));case 17:if(o.sent){o.next=20;break}n.endFail("tagMismatch");return o.abrupt("return",g?{decision:j.DROP,updatedReportingMeta:c}:{decision:j.KEEP,updatedReportingMeta:c});case 20:c.frankingKey=m;c.reportingContent=i;n.endSuccess();return o.abrupt("return",{decision:j.KEEP,updatedReportingMeta:c});case 24:return o.abrupt("return",d("WAGlobals").getConfig().isFrankingDropOnMissing()?{decision:j.DROP,updatedReportingMeta:c}:{decision:j.KEEP,updatedReportingMeta:c});case 25:case"end":return o.stop()}},null,this)}g.FrankingDecision=j;g.createFrankingKey=a;g.getFrankingVersion=c;g.genFrankingTag=e;g.validateFrankingTag=k;g.handleAndValidateFrankingFromIncomingMsg=f}),98);
__d("WAMsgApplication.pb",["WACommon.pb","WAProtoConst"],(function(a,b,c,d,e,f,g){var h;a={DEFAULT:0,VANISH_MODE:1,DISAPPEARING_MESSAGES:2};b={};c={};e={};f={};var i={},j={},k={},l={},m={},n={};b.internalSpec={payload:[1,(h=d("WAProtoConst")).TYPES.MESSAGE,i],metadata:[2,h.TYPES.MESSAGE,c]};c.internalSpec={chatEphemeralSetting:[1,h.TYPES.MESSAGE,n],ephemeralSettingList:[2,h.TYPES.MESSAGE,f],ephemeralSharedSecret:[3,h.TYPES.BYTES],forwardingScore:[5,h.TYPES.UINT32],isForwarded:[6,h.TYPES.BOOL],businessMetadata:[7,h.TYPES.MESSAGE,(d=d("WACommon.pb")).SubProtocolSpec],frankingKey:[8,h.TYPES.BYTES],frankingVersion:[9,h.TYPES.INT32],quotedMessage:[10,h.TYPES.MESSAGE,e],threadType:[11,h.TYPES.ENUM,a],readonlyMetadataDataclass:[12,h.TYPES.STRING],groupId:[13,h.TYPES.STRING],groupSize:[14,h.TYPES.UINT32],groupIndex:[15,h.TYPES.UINT32],botResponseId:[16,h.TYPES.STRING],collapsibleId:[17,h.TYPES.STRING],__oneofs__:{ephemeral:["chatEphemeralSetting","ephemeralSettingList","ephemeralSharedSecret"]}};e.internalSpec={stanzaId:[1,h.TYPES.STRING],remoteJid:[2,h.TYPES.STRING],participant:[3,h.TYPES.STRING],payload:[4,h.TYPES.MESSAGE,i]};f.internalSpec={chatJid:[1,h.TYPES.STRING],ephemeralSetting:[2,h.TYPES.MESSAGE,n]};i.internalSpec={coreContent:[1,h.TYPES.MESSAGE,m],signal:[2,h.TYPES.MESSAGE,l],applicationData:[3,h.TYPES.MESSAGE,k],subProtocol:[4,h.TYPES.MESSAGE,j],__oneofs__:{content:["coreContent","signal","applicationData","subProtocol"]}};j.internalSpec={futureProof:[1,h.TYPES.ENUM,d.FUTURE_PROOF_BEHAVIOR],consumerMessage:[2,h.TYPES.MESSAGE,d.SubProtocolSpec],businessMessage:[3,h.TYPES.MESSAGE,d.SubProtocolSpec],paymentMessage:[4,h.TYPES.MESSAGE,d.SubProtocolSpec],multiDevice:[5,h.TYPES.MESSAGE,d.SubProtocolSpec],voip:[6,h.TYPES.MESSAGE,d.SubProtocolSpec],armadillo:[7,h.TYPES.MESSAGE,d.SubProtocolSpec],__oneofs__:{subProtocol:["consumerMessage","businessMessage","paymentMessage","multiDevice","voip","armadillo"]}};k.internalSpec={};l.internalSpec={};m.internalSpec={};n.internalSpec={ephemeralExpiration:[2,h.TYPES.UINT32],ephemeralSettingTimestamp:[3,h.TYPES.INT64],isEphemeralSettingReset:[4,h.TYPES.BOOL]};g.MESSAGE_APPLICATION_METADATA_THREAD_TYPE=a;g.MessageApplicationSpec=b;g.MessageApplication$MetadataSpec=c;g.MessageApplication$Metadata$QuotedMessageSpec=e;g.MessageApplication$Metadata$EphemeralSettingMapSpec=f;g.MessageApplication$PayloadSpec=i;g.MessageApplication$SubProtocolPayloadSpec=j;g.MessageApplication$ApplicationDataSpec=k;g.MessageApplication$SignalSpec=l;g.MessageApplication$ContentSpec=m;g.MessageApplication$EphemeralSettingSpec=n}),98);
__d("WAAsMessageApplication",["WAAsConsumerApplication","WAConsumerApplication.pb","WAFranking","WAMsgApplication.pb","encodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b;switch(a.type){default:b=d("WAAsConsumerApplication").asConsumerApplication(a)}var c=a.forwardingScore!=null?a.forwardingScore:0;a=a.isForwarded!=null?a.isForwarded:!1;c={metadata:{chatEphemeralSetting:null,forwardingScore:c,frankingKey:d("WAFranking").createFrankingKey(),frankingVersion:d("WAFranking").getFrankingVersion(),isForwarded:a,quotedMessage:null}};if(b!=null){a=d("encodeProtobuf").encodeProtobuf(d("WAConsumerApplication.pb").ConsumerApplicationSpec,b);c.payload={subProtocol:{consumerMessage:{payload:a.readBuffer(),version:1}}}}return d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,c).readByteArray()}function b(a){return a}g.asMessageApplication=a;g.castToMessageApplicationBytes=b}),98);
__d("WADbPersonalSenderKeyStatusTxns",["MAWDexieTable","MAWTransactionMode","WADbTransactor","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h={hasSenderKey:new Set(),rotateSenderKey:!0,senderKeyId:null,senderKeyTs:d("WATimeUtils").castToUnixTime(0)},i=d("WADbTransactor").makeSignalTransactor({personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE},"putNewPersonalSenderKeyStatus",function(a){return function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){return j(a,b)})).then(function(){})}});function j(a,b){var c=babelHelpers["extends"]({},h,{groupJid:b});return a.personalSenderKeyStatuses.put(c).then(function(){return c})}function a(a,b,c){return l(a,b).then(function(b){var d=[];b.forEach(function(a){if(a==null||a.rotateSenderKey)return;c.forEach(function(b){return a.hasSenderKey["delete"](b)});d.push(a)});return a.personalSenderKeyStatuses.bulkPut(d).then(function(){return b})})}function b(a,b){return a.personalSenderKeyStatuses.bulkDelete(b)}function c(a,b){return k(a,[b]).then(function(a){return a[0]})}function k(a,b){return l(a,b).then(function(b){var c=[];b.forEach(function(a){if(a==null)return;a.rotateSenderKey=!0;c.push(a)});return a.personalSenderKeyStatuses.bulkPut(c).then(function(){return b})})}function e(a,b){return a.personalSenderKeyStatuses.bulkPut(b).then(function(){})}function f(a,b,c,d){return a.personalSenderKeyStatuses.get(b).then(function(e){var f=babelHelpers["extends"]({},e||h,{groupJid:b,rotateSenderKey:!1,senderKeyId:c,senderKeyTs:d});return a.personalSenderKeyStatuses.put(f).then(function(){return f})})}function l(a,b){return a.personalSenderKeyStatuses.bulkGet(b)}g.bulkPutNewPersonalSenderKeyStatus=i;g.putNewPersonalSenderKeyStatus=j;g.removeDevicesToMultiplePersonalSenderKeyStatuses=a;g.bulkDeletePersonalSenderKeyStatus=b;g.setRotateSenderKeyToTrue=c;g.bulkSetRotateSenderKeyToTrueTxn=k;g.bulkUpdateSenderKeyStatus=e;g.updateSenderKeyStatusAsRotated=f;g.bulkGetPersonalSenderKeyStatuses=l}),98);
__d("WACreateGroup",["WADbPersonalSenderKeyStatusTxns","WAGlobals","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield d("WAGlobals").getDependencies().createGroups(a),yield d("WADbPersonalSenderKeyStatusTxns").bulkPutNewPersonalSenderKeyStatus(a.map(function(a){return a.groupToCreate.jid}))});return function(b){return a.apply(this,arguments)}}();g.createGroups=a}),98);
__d("WACryptoSha256",["Promise","WABase64","WACryptoDependencies"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){return(h||(h=b("Promise"))).resolve(d("WACryptoDependencies").getCrypto().subtle.digest({name:"SHA-256"},a))}function j(a){return(h||(h=b("Promise"))).resolve(i(a).then(d("WABase64").encodeB64))}function a(a){return j(k(a))}function k(a){var b=new ArrayBuffer(a.length),c=new Uint8Array(b);for(var d=0,e=a.length;d<e;d++)c[d]=a.charCodeAt(d);return b}g.sha256=i;g.sha256Base64=j;g.sha256Str=a}),98);
__d("WAParseIqResponse",["WAWap"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){var e=a.content;if(e&&Array.isArray(e)&&e[0]){e=e[0];if(e.tag==="error"){var f=e.attrs||{},g;c&&(typeof c==="function"?g=c(a):g=c.parseOrThrow(e));c=g;return{success:!1,errorCode:parseInt(f.code,10),errorText:d("WAWap").decodeAsString(f.text)||"",errorType:d("WAWap").decodeAsString(f.type)||"",errorBackoff:parseInt(f.backoff,10),toString:h,customError:c}}}if(typeof b==="function")return{success:!0,result:b(a)};else return{success:!0,result:b.parseOrThrow(a)}}function h(){return"IqError "+this.errorCode+": "+this.errorText}g.parseIqResponse=a}),98);
__d("WADeprecatedSendIq",["Promise","WAAckParser","WAArrayUtils","WAComms","WALogger","WAParseIqResponse"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Comms has no open socket, will send stanza when socket opens"]);i=function(){return a};return a}function a(a,b){return d("WAComms")._sendIq(a,!1).then(function(a){return d("WAParseIqResponse").parseIqResponse(a,b)})}function c(a,b,c){return d("WAComms")._sendIq(a,!1).then(function(a){return d("WAParseIqResponse").parseIqResponse(a,b,c)})}function e(a,b,c){return d("WAComms")._sendIq(a,!1,c).then(function(a){return d("WAParseIqResponse").parseIqResponse(a,b)})}function f(a,b){return d("WAComms")._sendIq(a,!0).then(function(a){return d("WAParseIqResponse").parseIqResponse(a,b)})}function j(a,b){return k(a,b).then(function(){})}function k(a,c){return new(h||(h=b("Promise")))(function(e){var f=d("WAComms").singletonOrThrowIfUninitialized("deprecatedSendStanzaAndReturnAck"),g=function(a){var b=d("WAAckParser").AckParser.parse(a);return!b.error&&d("WAAckParser").ackMatchesTemplate(b.success,c)?a:null},j={type:"ack",parseAndTest:g,resolve:e,stanza:a,attachedToSocketId:d("WAComms").DEFAULT_SOCKET_ID,orderedId:d("WAComms").getAndIncrementNextOrderedId()};f.ackHandlers.push(j);if(!f.socket){d("WALogger").LOG(i());return}f.callStanza(a)["catch"](function(a){var c=f.ackHandlers.indexOf(j);if(c===-1)return;d("WAArrayUtils").removeIndexWithoutPreservingOrder(f.ackHandlers,c);j.resolve((h||(h=b("Promise"))).reject(a))})})}function l(a,b){d("WAComms").castSmaxStanza(a,b)}g.deprecatedSendIq=a;g.deprecatedSendIqErrorParser=c;g.deprecatedSendIqIfConnectedWithin=e;g.deprecatedSendIqWithoutRetry=f;g.deprecatedSendStanzaAndWaitForAck=j;g.deprecatedSendStanzaAndReturnAck=k;g.deprecatedCastStanza=l}),98);
__d("WAFrankingNode",["Promise","WAFranking","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Can't handle franking version ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Franking key is missing"]);j=function(){return a};return a}function a(a,c,e){if(c==null){d("WALogger").ERROR(j());return(h||(h=b("Promise"))).resolve(null)}if(e!=null&&e!==0){d("WALogger").ERROR(i(),e);return(h||(h=b("Promise"))).resolve(null)}return d("WAFranking").genFrankingTag(c,a)}g.genFrankingTagFromMessageApplicationEncode=a}),98);
__d("WAGenReportingMeta",["WAByteArray","WAFranking","WAFrankingNode","WAGlobals","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){if(d("WAGlobals").getConfig().isFrankingEnabled()){var e=(yield d("WAFrankingNode").genFrankingTagFromMessageApplicationEncode(a,b,c));return{frankingKey:b,frankingTag:e,frankingVersion:d("WAFranking").getFrankingVersion(c),reportingContent:d("WAByteArray").uint8ArrayToBuffer(a),reportingTag:null}}else return{frankingKey:b,frankingTag:null,frankingVersion:d("WAFranking").getFrankingVersion(c),reportingContent:null,reportingTag:null}});return h.apply(this,arguments)}g.genReportingMeta=a}),98);
__d("WAGroupParserUtils",["WAErr","WAGroupInviteUtils","WAJids","WALogger","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["received unknown participant error code: ",""]);h=function(){return a};return a}var i={superadmin:"superadmin",admin:"admin",participant:"participant",nonparticipant:"nonparticipant"};function j(a){if(!a.hasAttr("error"))throw c("WAErr")("Expected participant node to have error attr");var b=a.attrInt("error"),e=a.attrUserJid("jid");switch(b){case 401:return{errorCode:b,text:"not-authorized",user:e};case 403:a=a.child("add_request");return{errorCode:b,text:"request-code",code:d("WAGroupInviteUtils").toInviteCode(a.attrString("code")),expiration:a.attrTime("expiration"),user:e};case 404:return{errorCode:b,text:"not-found",user:e};case 406:return{errorCode:b,text:"enterprise-not-allowed",user:e};case 408:return{errorCode:b,text:"temporarily-blocked",user:e};case 409:return{errorCode:b,text:"conflict",user:e};case 500:return{errorCode:b,text:"resource-constraint",user:e};default:d("WALogger").ERROR(h(),b);return{errorCode:-1,text:"unknown",user:e}}}function k(a,b){a.assertTag("participant");var c="participant";switch(b){case"add":case"demote":c="participant";break;case"promote":c="admin";break;case"remove":c="nonparticipant";break}b=a.attrUserJid("jid");if(a.hasAttr("error")){var e=j(a);return d("WAResultOrError").makeError(e)}else{e=a.attrEnumOrDefault("type",i,c);c=a.maybeAttrString("addressable")!=="false";return d("WAResultOrError").makeResult({user:b,type:e,addressable:c})}}function a(a){a.assertTag("group");var b,c=a.attrString("id");c.includes("@")?b=a.attrGroupJid("id"):b=d("WAJids").toGroupJid(c);return{jid:b,creator:a.maybeAttrUserJid("creator")||void 0,creationTs:a.attrTime("creation"),subject:{content:a.maybeAttrString("subject")||void 0,user:a.maybeAttrUserJid("s_o")||void 0,ts:a.hasAttr("s_t")?a.attrTime("s_t"):void 0},description:m(a)||void 0,participantVersion:a.maybeAttrString("p_v_id")||void 0,participants:a.mapChildrenWithTag("participant",function(a){return k(a)}),memberAddMode:l(a)||void 0}}function l(a){if(a.hasChild("member_add_mode")){a=a.child("member_add_mode");if(a.hasContent()){a=a.contentString();if(a==="admin_add"||a==="all_member_add")return a}}return null}function m(a){if(a.hasChild("description")){a=a.child("description");if(a.hasChild("body")){var b=a.child("body");if(b.hasContent())return{id:a.attrString("id"),ts:a.attrTime("t"),content:b.contentString(),user:b.maybeAttrUserJid("participant")||void 0}}}return null}g.PARTICIPANT_TYPES=i;g.parseProtocolGroupParticipantNode=k;g.parseGroupNode=a}),98);
__d("WAMsgTransport.pb",["WACommon.pb","WAProtoConst"],(function(a,b,c,d,e,f,g){var h;a={NOOP:0,UPSERT:1,DELETE:2,UPSERT_AND_DELETE:3};b={};c={};e={};f={};var i={},j={},k={},l={},m={},n={},o={};b.internalSpec={payload:[1,(h=d("WAProtoConst")).TYPES.MESSAGE,c],protocol:[2,h.TYPES.MESSAGE,e]};c.internalSpec={applicationPayload:[1,h.TYPES.MESSAGE,d("WACommon.pb").SubProtocolSpec],futureProof:[3,h.TYPES.ENUM,d("WACommon.pb").FUTURE_PROOF_BEHAVIOR]};e.internalSpec={integral:[1,h.TYPES.MESSAGE,m],ancillary:[2,h.TYPES.MESSAGE,f]};f.internalSpec={skdm:[2,h.TYPES.MESSAGE,l],deviceListMetadata:[3,h.TYPES.MESSAGE,o],icdc:[4,h.TYPES.MESSAGE,j],backupDirective:[5,h.TYPES.MESSAGE,i]};i.internalSpec={messageId:[1,h.TYPES.STRING],actionType:[2,h.TYPES.ENUM,a],supplementalKey:[3,h.TYPES.STRING]};j.internalSpec={senderIdentity:[1,h.TYPES.MESSAGE,k],recipientIdentities:[2,h.FLAGS.REPEATED|h.TYPES.MESSAGE,k],recipientUserJids:[3,h.FLAGS.REPEATED|h.TYPES.STRING]};k.internalSpec={seq:[1,h.TYPES.INT32],signingDevice:[2,h.TYPES.BYTES],unknownDevices:[3,h.FLAGS.REPEATED|h.TYPES.BYTES],unknownDeviceIds:[4,h.FLAGS.REPEATED|h.TYPES.INT32]};l.internalSpec={groupId:[1,h.TYPES.STRING],axolotlSenderKeyDistributionMessage:[2,h.TYPES.BYTES]};m.internalSpec={padding:[1,h.TYPES.BYTES],dsm:[2,h.TYPES.MESSAGE,n]};n.internalSpec={destinationJid:[1,h.TYPES.STRING],phash:[2,h.TYPES.STRING]};o.internalSpec={senderKeyHash:[1,h.TYPES.BYTES],senderTimestamp:[2,h.TYPES.UINT64],recipientKeyHash:[8,h.TYPES.BYTES],recipientTimestamp:[9,h.TYPES.UINT64]};g.MESSAGE_TRANSPORT_PROTOCOL_ANCILLARY_BACKUP_DIRECTIVE_ACTION_TYPE=a;g.MessageTransportSpec=b;g.MessageTransport$PayloadSpec=c;g.MessageTransport$ProtocolSpec=e;g.MessageTransport$Protocol$AncillarySpec=f;g.MessageTransport$Protocol$Ancillary$BackupDirectiveSpec=i;g.MessageTransport$Protocol$Ancillary$ICDCParticipantDevicesSpec=j;g.MessageTransport$Protocol$Ancillary$ICDCParticipantDevices$ICDCIdentityListDescriptionSpec=k;g.MessageTransport$Protocol$Ancillary$SenderKeyDistributionMessageSpec=l;g.MessageTransport$Protocol$IntegralSpec=m;g.MessageTransport$Protocol$Integral$DeviceSentMessageSpec=n;g.DeviceListMetadataSpec=o}),98);
__d("WASmaxAttrs",["WAWap"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){if(b==null)return d("WAWap").DROP_ATTR;else return a(b)}function b(a,b){if(b)return a;else return d("WAWap").DROP_ATTR}g.OPTIONAL=a;g.OPTIONAL_LITERAL=b}),98);
__d("WASmaxMixinGroupExhaustiveError",[],(function(a,b,c,d,e,f){"use strict";a=function(a){babelHelpers.inheritsLoose(b,a);function b(){var b,c;for(var d=arguments.length,e=new Array(d),f=0;f<d;f++)e[f]=arguments[f];return(b=c=a.call.apply(a,[this].concat(e))||this,c.name="SmaxMixinGroupExhaustiveError",b)||babelHelpers.assertThisInitialized(c)}return b}(babelHelpers.wrapNativeSuper(Error));f.SmaxMixinGroupExhaustiveError=a}),66);/*FB_PKG_DELIM*/
__d("MAWGetMsgByProtocolIdApi",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY},"getMsgsByProtocolMsgIdsTxn",function(a){return function(b){return d("MAWDbMsgTxns").getMsgsByProtocolMsgId(a,b)}});g.getMsgsByProtocolMsgIdsTxn=a}),98);
__d("MAWSharedEBUtils",["WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){return Date.now()-a>d("WATimeUtils").DAY_MILLISECONDS*30};g.entryOlderThan30Days=a}),98);
__d("MAWSharedEbUploadQueue",["MAWEBSwitch","MAWEBUploadTrackingUtils","MAWSharedEbUploadEntity","Promise","WAPersistedQueue","WAPersistedQueueApi","WATagsLogger","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to write to ebUploadQueue ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["EB Upload Queue is already initialized"]);j=function(){return a};return a}var k=d("WATagsLogger").TAGS(["EbUploadQueue"]),l=null;function m(){return l==null?n():l}function n(){l!=null&&k.ERROR(j());var a=d("WAPersistedQueue").initPersistedQueue("ebUploadQueue",d("WAPersistedQueueApi").dexieApiForPersistedQueue());l=a;return a}function a(a){if(a.length===0)return;a.forEach(function(a){a=a.msgId;d("MAWEBUploadTrackingUtils").checkUploadQueueStartedCache(a.externalId)&&d("MAWEBUploadTrackingUtils").addPointWorkerOnly(d("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(a),"build_queue_entity")});var e=a.map(function(a){var b=a.attachmentContext,c=a.backupDirective,e=a.isOpenEB,f=a.messageApplication,g=a.msgId,h=a.originalMsgProtocolId,i=a.reportingMeta,j=a.senderId,k=a.serverTs,l=a.sortOrderMs;a=a.tags;return d("MAWSharedEbUploadEntity").asEBUploadEntity({attachmentContext:b,backupDirective:c,isOpenEB:e,msgId:g,originalMsgProtocolId:h,protobuf:d("MAWSharedEbUploadEntity").encodeBackupMessage({messageApplication:f,msgId:g,reportingMeta:i,sortOrderMs:l}),senderId:j,serverTs:k,sortOrderMs:l,tags:a})});e.forEach(function(a){d("MAWEBUploadTrackingUtils").checkUploadQueueStartedCache(a.msgId.externalId)&&d("MAWEBUploadTrackingUtils").addPointWorkerOnly(d("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(a.msgId),"enqueue_start")});a=m();c("promiseDone")(a.addAndCommit(e)["catch"](function(a){e.forEach(function(b){d("MAWEBUploadTrackingUtils").checkUploadQueueStartedCache(b.msgId.externalId)&&d("MAWEBUploadTrackingUtils").endFailWorkerOnly(d("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(b.msgId),"enqueue_fail",{string:{reason:a.message}})});k.ERROR(i(),a);return(h||(h=b("Promise"))).reject(a)}).then(function(){e.forEach(function(a){d("MAWEBUploadTrackingUtils").checkUploadQueueStartedCache(a.msgId.externalId)&&d("MAWEBUploadTrackingUtils").addPointWorkerOnly(d("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(a.msgId),"enqueue_end",{bool:{enqueue_end_eb_switch:c("MAWEBSwitch").isEnabled()}})})},function(){}))}g.logger=k;g.ebUploadQueue=m;g.initEbUploadQueue=n;g.putMsgsToEbUpload=a}),98);
__d("MAWEbUploadQueue",["EBUploadMessages","MAWEBSwitch","MAWEBUploadTrackingUtils","MAWGetMsgByProtocolIdApi","MAWSharedEBUtils","MAWSharedEbUploadQueue","WAGlobals","WAJids","WAMsgMap","WAShiftTimer","WAWaitForUser","asyncToGeneratorRuntime","justknobx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot get message from db: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload queue uploading "," messages"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg found 2"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg not found 1"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg found"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose([""," cannot process EB upload"]);m=function(){return a};return a}var n=d("MAWSharedEbUploadQueue").logger.TAGS(["labyrinth-web"]),o=new Map(),p=new Map(),q=new(d("WAShiftTimer").ShiftTimer)(a);function a(){c("MAWEBSwitch").isEnabled()?void t()["catch"](function(a){n.ERROR(m(),a),o.forEach(function(b,c,e){d("MAWEBUploadTrackingUtils").endFailWorkerOnly(c,"upload_eb_msgs_error",{string:{reason:a}})}),o.clear(),q.onOrAfter(c("justknobx")._("2366"))}):(d("MAWEBUploadTrackingUtils").getUploadQueueStartedCache().forEach(function(a,b){d("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(a,"upload_queue_run_timer_eb_disabled"),d("MAWEBUploadTrackingUtils").removeExternalIdFromUploadQueueStartedCache(b)}),q.onOrAfter(c("justknobx")._("2366")))}function r(){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield d("WAWaitForUser").waitForUserUnblocked(),q.onOrBefore(c("justknobx")._("2367"))});return s.apply(this,arguments)}function e(){c("promiseDone")(r());var a=d("MAWSharedEbUploadQueue").ebUploadQueue();a.subscribe(function(a){a.type==="flush"&&c("promiseDone")(r())})}function t(){return u.apply(this,arguments)}function u(){u=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=d("MAWSharedEbUploadQueue").ebUploadQueue(),b=[],e=(yield a.read({filter:function(a){if(a.sortOrderMs==null||d("MAWSharedEBUtils").entryOlderThan30Days(a.sortOrderMs)){b.push(a.queueId);return!1}else return!o.has(d("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(a.msgId))},limit:c("justknobx")._("2368"),order:"desc"}));yield a["delete"](b);if(e.length===0)return;n.LOG(i(),e.length);a=new(d("WAMsgMap").MsgMap)(e.map(function(a){d("MAWEBUploadTrackingUtils").checkUploadQueueStartedCache(a.msgId.externalId)&&d("MAWEBUploadTrackingUtils").addPointWorkerOnly(d("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(a.msgId),"upload_queue_processing");return[a.msgId,a]}));e=e.map(function(a){var b;return{backupActionType:a.backupActionType,msgId:a.msgId,originalMsgProtocolId:(b=a.backupDirective)==null?void 0:b.originalMsgProtocolId,protobuf:a.protobuf,senderId:a.senderId,serverTs:a.serverTs,sortOrderMs:a.sortOrderMs,supplementalKey:a.supplementalKey}});var f=new Map(),g=a.values().map(function(a){d("MAWEBUploadTrackingUtils").checkUploadQueueStartedCache(a.msgId.externalId)&&d("MAWEBUploadTrackingUtils").addPointWorkerOnly(d("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(a.msgId),"queue_get_original_msg_id_start",{bool:{is_author_null:a.originalMsgProtocolId.author==null}});if(a.originalMsgProtocolId.author!=null){var b=a.originalMsgProtocolId.author,e=a.originalMsgProtocolId.chat;b={author:d("WAGlobals").getMyUserJid()===a.originalMsgProtocolId.author?d("WAJids").AUTHOR_ME:b,chat:e,externalId:a.originalMsgProtocolId.externalId};e=d("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(a.msgId);o.set(e,a.queueId);var g=f.get(b.externalId);if(g!=null){d("MAWEBUploadTrackingUtils").removeExternalIdFromUploadQueueStartedCache(a.msgId.externalId)&&d("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(e,"queue_original_id_duplicated");p.set(g,((g=p.get(g))!=null?g:new Set()).add(e));return null}else f.set(b.externalId,e);!d("MAWEBUploadTrackingUtils").removeExternalIdFromUploadQueueStartedCache(a.msgId.externalId)?d("MAWEBUploadTrackingUtils").startUploadTracking(b.externalId,null,"uploadqueue",e,!0):d("MAWEBUploadTrackingUtils").addPointWorkerOnly(e,"queue_non_retry_item");return b}else{d("MAWEBUploadTrackingUtils").endFailWorkerOnly(d("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(a.msgId),"queue_no_author_or_chat",{bool:{is_author_null:a.originalMsgProtocolId.author==null}});c("promiseDone")(d("MAWSharedEbUploadQueue").ebUploadQueue().ack([a.queueId]));return null}}).filter(Boolean);f.forEach(function(a,b){d("MAWEBUploadTrackingUtils").addPointWorkerOnly(a,"queue_get_original_msg_ids_done",{int_array:{supplemental_trace_ids:Array.from((b=p.get(a))!=null?b:[])}})});a=(yield d("MAWGetMsgByProtocolIdApi").getMsgsByProtocolMsgIdsTxn(g)["catch"](function(a){g.forEach(function(b){b=f.get(b.externalId);b!=null?d("MAWEBUploadTrackingUtils").endFailWorkerOnly(b,"get_db_msgs_error",{string:{reason:a}}):n.WARN(h(),a)});throw a}));f.forEach(function(a,b){d("MAWEBUploadTrackingUtils").addPointWorkerOnly(a,"queue_get_msgs_done")});w(f,g,a);yield d("EBUploadMessages").uploadMessageFromUploadQueue(a,f,e);q.onOrBefore(c("justknobx")._("2366"))});return u.apply(this,arguments)}function f(a,b){return v.apply(this,arguments)}function v(){v=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){b?d("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(a,"upload_queue_ack_worker_success"):d("MAWEBUploadTrackingUtils").endFailWorkerOnly(a,"upload_queue_ack_worker_fail");b=o.get(a);if(b==null)return;yield d("MAWSharedEbUploadQueue").ebUploadQueue().ack([b]);o["delete"](a);c("promiseDone")(r())});return v.apply(this,arguments)}function w(a,c,e){if(c.length>e.length){var f=new Set(c.map(function(a){return a.externalId}));e.forEach(function(b){if(f.has(b.externalId)){f["delete"](b.externalId);var c=a.get(b.externalId);c!=null?d("MAWEBUploadTrackingUtils").addPointWorkerOnly(c,"msg_found",{string:{msgType:b.type}}):n.WARN(l())}});f.forEach(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){b=a.get(b);if(b!=null){d("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(b,"upload_queue_msg_not_found");var c=o.get(b);o["delete"](b);if(c==null)return;yield d("MAWSharedEbUploadQueue").ebUploadQueue()["delete"]([c])}else n.WARN(k())});return function(a){return c.apply(this,arguments)}}())}else e.forEach(function(b){var c=a.get(b.externalId);c!=null?d("MAWEBUploadTrackingUtils").addPointWorkerOnly(c,"msg_found",{string:{msgType:b.type}}):n.WARN(j())})}g.scheduleNextRun=r;g.listenForEbUploadQueueFlush=e;g.uploadEBMsgs=t;g.ackWithInstanceKey=f}),98);
__d("WAJobRequirement",["Promise","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["JobRequirement[","] blocker errored ",""]);i=function(){return a};return a}c=function(){function a(a){var c=this;this.$1=(h||(h=b("Promise"))).resolve();this.$2=!0;this.$3=null;this.$4=function(){var a=c.$3;if(a!=null){c.$3=null;return(h||(h=b("Promise"))).all(a).then(c.$4)}c.$2=!0};this.name=a}var c=a.prototype;c.addBlocker=function(a){var c=this;a=a["catch"](function(a){d("WALogger").ERROR(i(),c.name,a).sendLogs("job-blocker-rejected")});if(this.$2)this.$2=!1,this.$1=(h||(h=b("Promise"))).all([this.$1,a]).then(this.$4);else{var e=this.$3;e!=null?e.push(a):this.$3=[a]}};c.waitUntilSatisfied=function(){return this.$1};c.isSatisfied=function(){return this.$2};c.isSatisfiable=function(){return!0};return a}();e=function(a){babelHelpers.inheritsLoose(c,a);function c(c){c=a.call(this,c)||this;a.prototype.addBlocker.call(babelHelpers.assertThisInitialized(c),new(h||(h=b("Promise")))(function(){}));return c}var d=c.prototype;d.addBlocker=function(){};d.isSatisfiable=function(){return!1};return c}(c);function a(a,c){var d=a.filter(function(a){return!a.isSatisfiable()});if(d.length>0){var e=d.map(function(a){return a.name});return function(a){c==null?void 0:c("unsatisfiable",e,a);return d[0].waitUntilSatisfied()}}var f=a.map(function(){return(h||(h=b("Promise"))).resolve()}),g=(h||(h=b("Promise"))).resolve(),i=null,j=function c(){if(f.every(function(b,c){return b===a[c].waitUntilSatisfied()})){i=null;return}var d=[],e=a.map(function(a){var b=a.waitUntilSatisfied();a.isSatisfied()||(d.push(a.name),b.then(function(){var b=d.indexOf(a.name);d.splice(b,1)}));return b});f=e;i=d;return(h||(h=b("Promise"))).all(e).then(c)};return function(a){if(i==null){var b=j();b!=null&&(g=g.then(function(){return b}))}c==null?void 0:c(i==null?"satisfied":"unsatisfied",i,a);return g}}g.JobRequirement=c;g.UnsatisfiableJobRequirement=e;g.joinRequirements=a}),98);
__d("WAPersistedJobManager",["Promise","WAJobRequirement","WALogger","WAPromiseBackoffs","WATimeUtils","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose([""," waiting on ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose([""," halting because of ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["waitUntilCompletedNonPersisted not implemented in PersistedJobManager"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["fireAndForgetNonPersisted not implemented in PersistedJobManager"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose([""," has been loaded and is marked as deprecated"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["addPersistedJobImplementation called twice for ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["onJobStarted for "," threw exception ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": "," step not found"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose([""," failed with error ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["onJobFinished for "," threw exception ",""]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": finished job"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception: ",""]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception. Tried "," times"]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": RetryOnBackoff"]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": requires page"]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": delaying until ",""]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": trim wait from "," to ",""]);y=function(){return a};return a}function z(){var a=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",".",""]);z=function(){return a};return a}function A(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": removing completed, expired job from db"]);A=function(){return a};return a}function B(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": skew detected, adjusting accordingly"]);B=function(){return a};return a}function C(){var a=babelHelpers.taggedTemplateLiteralLoose(["Running deprecated job ",""]);C=function(){return a};return a}function D(){var a=babelHelpers.taggedTemplateLiteralLoose(["No implementation for deprecated ",", job deleted"]);D=function(){return a};return a}function E(){var a=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",". Maybe it should have been put to the deprecated list?"]);E=function(){return a};return a}function F(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": InterruptJob"]);F=function(){return a};return a}function G(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": running step"]);G=function(){return a};return a}function H(){var a=babelHelpers.taggedTemplateLiteralLoose(["Persisted job missing for given ID"]);H=function(){return a};return a}function I(){var a=babelHelpers.taggedTemplateLiteralLoose(["No entry for job ",""]);I=function(){return a};return a}function J(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": restarting"]);J=function(){return a};return a}function K(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": stuck on the step ",", aborting the job"]);K=function(){return a};return a}var L=1,M=function(){function a(a){this.feature=a}var b=a.prototype;b.toString=function(){return"RequiresPage: "+this.feature};return a}(),N=function(){function a(a){this.backoffOptions=a}var b=a.prototype;b.toString=function(){return"RetryOnBackoff"};return a}();a=function(a){babelHelpers.inheritsLoose(b,a);function b(){return a.apply(this,arguments)||this}return b}(babelHelpers.wrapNativeSuper(Error));var O=function(a){this.result=a},P="$unstarted",Q="$finished";c=function(){function a(a){var c=this,e=a.isRestartAfterCrash,f=a.accessors,g=a.unfinishedJobEntries,i=new Map();g=g.then(function(a){var g=[],j=[];a.forEach(function(a){a.stepHardStartCountAfterTimeout>=5?g.push(a):j.push(a)});return(h||(h=b("Promise"))).all(g.map(function(a){d("WALogger").ERROR(K(),S(a),a.step).devConsole(R(a)).sendLogs("job-stuck-"+a.type);return f.deletePersistedJob(a.jobId)})).then(function(){j.forEach(function(a){if(i.has(a.jobId))return;d("WALogger").LOG(J(),R(a));i.set(a.jobId,c.$1(a,e))})})});this.implementationLoaders=new Map();this.implementations=new Map();this.stepBlockers=new WeakMap();this.accessors=f;this.activeJobs=i;this.initialJobsPromise=g;this.listeners=a.listeners;this.deprecatedJobs=a.deprecatedJobs}var c=a.prototype;c.loadAndRunJobFromId=function(a){var b=this.activeJobs.get(a);if(b!=null)return b;b=this.$2(a);this.activeJobs.set(a,b);return b};c.$2=function(a){var c,e,f;return b("regeneratorRuntime").async(function(g){while(1)switch(g.prev=g.next){case 0:c=this.initialJobsPromise,e=this.accessors;g.next=3;return b("regeneratorRuntime").awrap(c);case 3:g.next=5;return b("regeneratorRuntime").awrap(e.readPersistedJob(a));case 5:f=g.sent;if(f){g.next=10;break}d("WALogger").DEV(I(),a);d("WALogger").WARN(H());return g.abrupt("return",null);case 10:return g.abrupt("return",this.$1(f,!1));case 11:case"end":return g.stop()}},null,this)};c.$3=function(a){var b=this.implementations,c=this.implementationLoaders,d=b.get(a);if(d)return d;d=c.get(a);if(!d)return null;c=d();b.set(a,c);return c};c.$4=function(a,c){if(c==null||c.length===0)return(h||(h=b("Promise"))).resolve();var e=this.stepBlockers,f=e.get(c);f==null&&(f=d("WAJobRequirement").joinRequirements(c.map(function(a){return a()}),U),e.set(c,f));return f(a)};c.$5=function(a,b,c,e){var f=this;c===void 0&&(c=!1);var g=a.step,h=b.findIndex(function(a){return a.stepName===g}),i=b[h].info(a.current,a.original,V(a,c)),j=i.requirements,k=i.code;i=this.$4(a,j);e&&(i=i.then(e));return i.then(function(){d("WALogger").LOG(G(),T(a));return k(a.current,a.original,V(a,c))}).then(function(e){if(e instanceof O){d("WALogger").LOG(F(),T(a));return e.result}var g=h+1;if(g>=b.length)return e;g=b[g];a.step=g.stepName;a.current=e;a.stepHardStartCountAfterTimeout=0;a.stepFirstStartTime=d("WATimeUtils").unixTime();a.stepUnexpectedErrorCount=0;a.waitUntil=null;a.backedOffCount=0;return f.accessors.updatePersistedJob(a).then(function(){return f.$5(a,b,c)})})};c.$1=function(a,c){var e,f=this,g,i,j,k,l,m,n,F,G,H,I,J,K,O,S,U;return b("regeneratorRuntime").async(function(W){while(1)switch(W.prev=W.next){case 0:g=this.accessors,i=this.activeJobs,j=this.deprecatedJobs,k=this.listeners,l=k.onJobFinished,m=k.onJobStarted;W.next=3;return b("regeneratorRuntime").awrap(this.$3(a.type));case 3:n=W.sent;F=j[a.type];if(n){W.next=21;break}if(F){W.next=13;break}d("WALogger").ERROR(E(),a.type).sendLogs("missing-job-implementation");W.next=10;return b("regeneratorRuntime").awrap(g.deletePersistedJob(a.jobId));case 10:return W.abrupt("return",null);case 13:if(!(F==="NOOP")){W.next=18;break}d("WALogger").WARN(D(),a.type);W.next=17;return b("regeneratorRuntime").awrap(g.deletePersistedJob(a.jobId));case 17:return W.abrupt("return",null);case 18:W.next=20;return b("regeneratorRuntime").awrap(F());case 20:n=W.sent;case 21:G=n;F&&d("WALogger").LOG(C(),a.type);H=(e=a.stepFirstStartTime)!=null?e:d("WATimeUtils").unixTime();a.stepFirstStartTime=H;a.stepUnexpectedErrorCount=a.stepUnexpectedErrorCount||0;a.backedOffCount=a.backedOffCount||0;if(!(a.step===Q)){W.next=44;break}I=a.waitUntil;J=d("WATimeUtils").secondsUntil(H);if(!(I!=null&&d("WATimeUtils").isInFuture(I)&&J>0)){W.next=38;break}d("WALogger").LOG(B(),R(a));I=d("WATimeUtils").castToUnixTime(I-J);if(!d("WATimeUtils").isInFuture(I)){W.next=38;break}a.stepFirstStartTime=d("WATimeUtils").castToUnixTime(H-J);a.waitUntil=I;W.next=38;return b("regeneratorRuntime").awrap(this.accessors.updatePersistedJob(a));case 38:if(!(I==null||!d("WATimeUtils").isInFuture(I))){W.next=42;break}d("WALogger").LOG(A(),R(a));W.next=42;return b("regeneratorRuntime").awrap(g.deletePersistedJob(a.jobId));case 42:i["delete"](a.jobId);return W.abrupt("return",a.current);case 44:K=a.step!==P?n.find(function(b){return b.stepName===a.step}):n[0];if(K){W.next=50;break}d("WALogger").ERROR(z(),a.type,a.step).sendLogs("missing-job-step");W.next=49;return b("regeneratorRuntime").awrap(g.deletePersistedJob(a.jobId));case 49:return W.abrupt("return",null);case 50:a.step=K.stepName;O=function e(){var g=a.waitUntil,i=(h||(h=b("Promise"))).resolve();if(g!=null){var j=d("WATimeUtils").futureUnixTime(d("WATimeUtils").DAY_SECONDS);g>j?(d("WALogger").LOG(y(),T(a),g,j),a.waitUntil=j,i=f.accessors.updatePersistedJob(a).then(function(){return d("WATimeUtils").delayUntil(j)})):(d("WALogger").LOG(x(),T(a),g),i=d("WATimeUtils").delayUntil(g))}return i.then(function(){var g=function(){a.waitUntil=null;d("WATimeUtils").happenedWithin(H,d("WATimeUtils").DAY_SECONDS)||a.stepHardStartCountAfterTimeout++;return f.accessors.updatePersistedJob(a)};return f.$5(a,G,c,g)["catch"](function(c){if(c instanceof M){d("WALogger").LOG(w(),T(a));a.stepHardStartCountAfterTimeout>0&&(--a.stepHardStartCountAfterTimeout,f.accessors.updatePersistedJob(a));return new(h||(h=b("Promise")))(function(){})}else if(c instanceof N){d("WALogger").LOG(v(),T(a));var g=d("WAPromiseBackoffs").getDelay(++a.backedOffCount,c.backoffOptions);a.waitUntil=d("WATimeUtils").futureUnixTime(Math.ceil(g/1e3));a.stepHardStartCountAfterTimeout>0&&--a.stepHardStartCountAfterTimeout;return f.accessors.updatePersistedJob(a).then(e)}else if(a.stepUnexpectedErrorCount<L){d("WALogger").WARN(u(),T(a),a.stepUnexpectedErrorCount);d("WALogger").WARN(t(),T(a),c);a.stepUnexpectedErrorCount++;return f.accessors.updatePersistedJob(a).then(e)}throw c})})};S=O();U=S.then(function(c){var e;return b("regeneratorRuntime").async(function(h){while(1)switch(h.prev=h.next){case 0:d("WALogger").LOG(s(),T(a));e=null;try{e=l(a.jobId,a.type,a.original,c)}catch(b){d("WALogger").ERROR(r(),a.type,b).sendLogs("onJobFinished-threw")}if(!(e!=null&&e>0)){h.next=12;break}a.waitUntil=d("WATimeUtils").futureUnixTime(Math.ceil(e/1e3));a.step=Q;a.current=c;a.stepFirstStartTime=d("WATimeUtils").unixTime();h.next=10;return b("regeneratorRuntime").awrap(f.accessors.updatePersistedJob(a));case 10:h.next=15;break;case 12:h.next=14;return b("regeneratorRuntime").awrap(g.deletePersistedJob(a.jobId));case 14:i["delete"](a.jobId);case 15:case"end":return h.stop()}},null,this)},function(e){var f,h;return b("regeneratorRuntime").async(function(j){while(1)switch(j.prev=j.next){case 0:d("WALogger").ERROR(q(),a.type,e).sendLogs("job-threw-exception-"+a.type);f=G.find(function(b){return b.stepName===a.step});if(f){j.next=6;break}d("WALogger").ERROR(p(),a.type,a.step);j.next=10;break;case 6:h=f.info(a.current,a.original,V(a,c));if(!(h.stopRetryIf!=null)){j.next=10;break}j.next=10;return b("regeneratorRuntime").awrap(h.stopRetryIf.onStopRetry(a.current,a.original,V(a,c)));case 10:j.next=12;return b("regeneratorRuntime").awrap(g.deletePersistedJob(a.jobId));case 12:i["delete"](a.jobId);case 13:case"end":return j.stop()}},null,this)});try{m(a.jobId,a.type,a.original)}catch(b){d("WALogger").ERROR(o(),a.type,b).sendLogs("onJobStarted-threw")}return W.abrupt("return",U.then(function(){return S}));case 56:case"end":return W.stop()}},null,this)};c.addPersistedJobImplementation=function(a,b){var c=this.implementationLoaders,e=this.deprecatedJobs;if(c.has(a)){d("WALogger").ERROR(n(),a).sendLogs("repeat-job-loader");return}e&&e[a]&&d("WALogger").DEV(m(),a);c.set(a,b)};c.fireAndForget=function(a){var b=this;this.accessors.maybeCreateJob(a).then(function(a){a=a.id;return b.loadAndRunJobFromId(a)})};c.waitUntilPersisted=function(a){var b=this;return this.accessors.maybeCreateJob(a).then(function(a){a=a.id;b.loadAndRunJobFromId(a)})};c.waitUntilCompleted=function(a){var b=this;return this.accessors.maybeCreateJob(a).then(function(a){a=a.id;return b.loadAndRunJobFromId(a)})};c.fireAndForgetNonPersisted=function(a){d("WALogger").LOG(l())};c.waitUntilCompletedNonPersisted=function(a){return(h||(h=b("Promise"))).resolve(function(){return d("WALogger").LOG(k())})};return a}();function R(a){return"Job["+a.jobId+"] ("+a.type+")"}function S(a){return"[Job "+a.type+"] "}function T(a){return"Job["+a.jobId+"] ("+a.type+"."+a.step+")"}function U(a,b,c){a==="unsatisfiable"?d("WALogger").LOG(j(),T(c),b):a==="unsatisfied"?d("WALogger").LOG(i(),T(c),b):a}function V(a,b){b===void 0&&(b=!1);return{jobStartTime:a.startTime,afterCrash:b,interruptJob:W}}function W(a){return new O(a)}g.RequiresPage=M;g.RetryOnBackoff=N;g.NonRetryableError=a;g.InterruptJob=O;g.UNSTARTED_JOB=P;g.FINISHED_JOB=Q;g.PersistedJobManager=c}),98);
__d("WAStartMediaDownloadQplFlow",["WAGetPlatformFromStanzaId","WAGetStorageQplAnnotations","WAJids","WAMediaUtils","WAPREList","WAPREMetrics"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.downloadEntry,c=a.msgType;a=a.protocolMsgId;var e=d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.MEDIA_DOWNLOAD,{bool:{isTransformStreamSupported:d("WAMediaUtils").isTransformStreamSupported()},string:{chat_type:d("WAJids").switchOnMsgrChatJidType(a.chat,{group:function(){return"group"},user:function(){return"user"}}),downloadEntry:b,e2eePlatform:d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(a.externalId),msgType:c}},void 0,d("WAPREMetrics").QPL_MEDIA_DOWNLOAD_TIMEOUT_IN_MS);void d("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(a){e.addAnnotations(a)});return babelHelpers["extends"]({},e,{downloadEntry:b})}g.startMediaDownloadQplFlow=a}),98);
__d("WorkerBanzaiLazyQueueChannelWorker",["BanzaiLazyQueue","WorkerFuncChannel"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=d("WorkerFuncChannel").importChannel({queuePost:null},a,"banzai_lazyqueue_channel");c("BanzaiLazyQueue").onQueue.add(function(){h(b)});h(b)}function h(a){c("BanzaiLazyQueue").flushQueue().forEach(function(b){a.queuePost.apply(a,b)})}g.init=a}),98);
__d("WorkerSelf",["WorkerBanzaiLazyQueueChannelWorker","WorkerFuncChannel","WorkerQPLChannel"],(function(a,b,c,d,e,f,g){"use strict";function a(a){d("WorkerFuncChannel").activateChannels(a,"worker","client"),d("WorkerBanzaiLazyQueueChannelWorker").init(a),d("WorkerQPLChannel").setMessagePort(a)}g.init=a}),98);/*FB_PKG_DELIM*/
__d("LSDecryptProtobuf",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSBase64Decode.nop","LSCreateDerivedKeys.nop","LSGetBlobFromString.nop","LSIsMobileClient","LSLogMebClientEvent.nop","LSSymmetricEncryptionCreateDecryptedData.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][decryptProtobuf] Beginning execution."),d[1]=c.i64.of_float(Date.now()),d[8]=a[1]==null?c.i64.cast([0,0]):a[1],d[2]=c.i64.of_int32(a[3].length),c.i64.eq(d[2],c.i64.cast([0,1]))?c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[3],c.i64.cast([0,0])).then(function(a){return a=a,d[12]=a[0],d[13]=a[1],a})},function(e){return d[14]=d[12].get("epoch_anon_id"),d[12],d[15]=d[12].get("epoch_root_key"),d[12],d[16]=c.createArray(),d[26]=(d[16].push(c.i64.cast([0,32])),d[16]),c.i64.ge(d[8],c.i64.cast([0,3]))?c.resolve(d[17]=void 0):c.sequence([function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[2]).then(function(a){return a=a,d[26]=a[0],a})},function(a){return d[17]=d[26]}])},function(e){return c.i64.ge(d[8],c.i64.cast([0,4]))?(d[26]="_",d[18]=["message_key_in_epoch",d[26],c.blobs.to_string(d[14]),d[26],"cipher_version",d[26],c.i64.to_string(d[8]),d[26],"thread",d[26],a[2]==null?"":a[2]].join("")):(c.i64.ge(d[8],c.i64.cast([0,3]))?(d[27]="_",d[26]=["message_key_in_epoch",d[27],c.blobs.to_string(d[14]),d[27],"cipher_version",d[27],c.i64.to_string(d[8]),d[27],"thread",d[27],a[2]==null?"":a[2]].join("")):(c.i64.ge(d[8],c.i64.cast([0,2]))?(d[28]="_",d[27]=["message_key_in_epoch",d[28],c.blobs.to_string(d[14]),d[28],"cipher_version",d[28],c.i64.to_string(d[8])].join("")):d[27]=["message_key_in_epoch","_",c.blobs.to_string(d[14])].join(""),d[26]=d[27]),d[18]=d[26]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[18]).then(function(a){return a=a,d[19]=a[0],a})},function(a){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),d[19],d[17],d[15],d[16]).then(function(a){return a=a,d[20]=a[0],a})},function(a){return d[20]?d[21]=!1:d[21]=!0,d[21]?c.resolve(d[22]=void 0):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[20],c.i64.cast([0,0])).then(function(a){return a=a,d[26]=a[0],d[27]=a[1],a})},function(a){return d[22]=d[26]}])},function(e){return c.blobs.neq(d[22],void 0)?c.sequence([function(e){return c.nativeOperation(b("LSBase64Decode.nop"),a[0]).then(function(a){return a=a,d[26]=a[0],a})},function(e){return c.blobs.neq(d[26],void 0)?c.sequence([function(e){return c.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedData.nop"),d[22],c.blobs.of_string(["message_thread","_",a[2]].join("")),d[26]).then(function(a){return a=a,d[29]=a[0],a})},function(a){return d[27]=d[29]}]):c.resolve(d[27]=void 0)},function(a){return c.blobs.neq(d[27],void 0)?c.resolve(d[28]=d[27]):c.sequence([function(a){return d[29]=["Failed to decrypt message. Epoch Anon ID: ",c.blobs.to_string(d[14]),", Encryption Version: ",c.i64.to_string(d[8])].join(""),function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsDecryptProtobufStoredProcedure] ","",d[29]].join("")),d[30]=c.createArray(),void 0!==void 0?d[31]=(d[30].push(void 0),d[30]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptProtobufStoredProcedure",[d[29]].join(""),d[30],c.i64.cast([0,3]))},function(a){return d[28]=void 0}])},function(a){return d[23]=d[28]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsDecryptProtobufStoredProcedure] Decryption message key is null"),void 0!==void 0?c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,85]),c.i64.cast([0,2]),"[EncryptedBackups][LSEncryptedBackupsDecryptProtobufStoredProcedure] Decryption message key is null",void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[27]=a[0],a})},function(a){return d[27]?d[28]=!0:d[28]=!1,d[28]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[29]=c.createArray(),void 0!==void 0?d[30]=(d[29].push(void 0),d[29]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[29],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[26]=c.createArray(),void 0!==void 0?d[27]=(d[26].push(void 0),d[26]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptProtobufStoredProcedure","Decryption message key is null",d[26],c.i64.cast([0,3]))},function(a){return d[23]=void 0}])},function(a){return c.blobs.neq(d[23],void 0)?(a=[d[23],void 0],d[24]=a[0],d[25]=a[1],a):(d[26]=new c.Map(),d[26].set("error_code",c.i64.cast([0,101])),d[26].set("stored_procedure","LSEncryptedBackupsDecryptProtobufStoredProcedure"),d[26].set("error_message",""),a=[void 0,d[26]],d[24]=a[0],d[25]=a[1],a),a=[d[24],d[25]],d[3]=a[0],d[4]=a[1],a}]):c.resolve((d[12]=c.i64.of_int32(a[3].length),c.i64.eq(d[12],c.i64.cast([0,0]))?(d[15]=new c.Map(),d[15].set("error_code",c.i64.cast([0,102])),d[15].set("stored_procedure","LSEncryptedBackupsDecryptProtobufStoredProcedure"),d[15].set("error_message",""),e=[void 0,d[15]],d[13]=e[0],d[14]=e[1],e):(d[15]=new c.Map(),d[15].set("error_code",c.i64.cast([0,103])),d[15].set("stored_procedure","LSEncryptedBackupsDecryptProtobufStoredProcedure"),d[15].set("error_message",""),e=[void 0,d[15]],d[13]=e[0],d[14]=e[1],e),e=[d[13],d[14]],d[3]=e[0],d[4]=e[1],e))},function(a){return d[5]=c.i64.of_float(Date.now()),d[6]=c.i64.random(),d[9]="Finishing execution. Execution time: ",d[10]=c.i64.to_string(c.i64.sub(d[5],d[0])),d[11]=" ms",d[7]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][decryptProtobuf] ",d[7],d[9],d[7],d[10],d[7],d[11]].join("")),c.i64.eq(c.i64.mod_(d[6],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[12]=",",d[13]=c.createArray(),void 0!==void 0?d[14]=(d[13].push(void 0),d[13]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"decryptProtobuf",[d[9],d[12],d[10],d[12],d[11]].join(""),d[13],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[3],d[4]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsDecryptProtobufStoredProcedure";e.exports=a}),null);
__d("LSDecryptSupplementalKey",["LSArrayGetObjectAt","LSBase64Decode.nop","LSCreateDerivedKeys.nop","LSLogMebClientEvent.nop","LSSymmetricEncryptionCreateDecryptedData.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][decryptSupplementalKey] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.nativeOperation(b("LSBase64Decode.nop"),a[0]).then(function(a){return a=a,d[2]=a[0],a})},function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[1],c.i64.cast([0,0])).then(function(a){return a=a,d[3]=a[0],d[4]=a[1],a})},function(a){return c.blobs.neq(d[2],void 0)?c.sequence([function(a){return d[13]=d[3].get("epoch_root_key"),d[3],d[14]=c.createArray(),d[21]=(d[14].push(c.i64.cast([0,32])),d[14]),c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blob("a2RmX2luZm86bWFpbGJveF9yb290X2tleV92Mj5zdXBwbGVtZW50YWxfZW5jX2tleQ=="),void 0,d[13],d[14]).then(function(a){return a=a,d[15]=a[0],a})},function(a){return d[15]!==void 0?c.sequence([function(a){return d[21]=c.i64.of_int32(d[15].length),c.i64.ge(d[21],c.i64.cast([0,1]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[15],c.i64.cast([0,0])).then(function(a){return a=a,d[23]=a[0],d[24]=a[1],a})},function(a){return d[22]=d[23]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),d[23]=c.createArray(),void 0!==void 0?d[24]=(d[23].push(void 0),d[23]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",d[23],c.i64.cast([0,3]))},function(a){return d[22]=void 0}])},function(a){return d[16]=d[22]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),d[21]=c.createArray(),void 0!==void 0?d[22]=(d[21].push(void 0),d[21]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",d[21],c.i64.cast([0,3]))},function(a){return d[16]=void 0}])},function(a){return c.blobs.neq(d[16],void 0)?d[17]=!0:d[17]=!1,d[17]?0:(function(a){c.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),c["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),c.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedData.nop"),d[16],c.blob("c3VwcGxlbWVudGFsX2VuY19hYWQ="),d[2]).then(function(a){return a=a,d[18]=a[0],a})},function(a){return c.blobs.neq(d[18],void 0)?(a=[c.blobs.to_string(d[18]),void 0],d[19]=a[0],d[20]=a[1],a):(d[21]=new c.Map(),d[21].set("error_code",c.i64.cast([0,109])),d[21].set("stored_procedure","LSEncryptedBackupsDecryptSupplementalKeyStoredProcedure"),d[21].set("error_message",""),a=[void 0,d[21]],d[19]=a[0],d[20]=a[1],a),a=[d[19],d[20]],d[5]=a[0],d[6]=a[1],a}]):c.resolve((d[13]=new c.Map(),d[13].set("error_code",c.i64.cast([0,109])),d[13].set("stored_procedure","LSEncryptedBackupsDecryptSupplementalKeyStoredProcedure"),d[13].set("error_message",""),a=[void 0,d[13]],d[5]=a[0],d[6]=a[1],a))},function(a){return d[7]=c.i64.of_float(Date.now()),d[8]=c.i64.random(),d[10]="Finishing execution. Execution time: ",d[11]=c.i64.to_string(c.i64.sub(d[7],d[0])),d[12]=" ms",d[9]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][decryptSupplementalKey] ",d[9],d[10],d[9],d[11],d[9],d[12]].join("")),c.i64.eq(c.i64.mod_(d[8],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[13]=",",d[14]=c.createArray(),void 0!==void 0?d[15]=(d[14].push(void 0),d[14]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"decryptSupplementalKey",[d[10],d[13],d[11],d[13],d[12]].join(""),d[14],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[5],d[6]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsDecryptSupplementalKeyStoredProcedure";e.exports=a}),null);
__d("LSDecryptMessageProtobufs",["LSArrayGetObjectAt","LSDecryptProtobuf","LSDecryptSupplementalKey","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][decryptMessageProtobufs] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(e,f){var g=e.done;e=e.value;return g?(d[11]=new c.Map(),d[11].set("error_code",c.i64.cast([0,1])),d[11].set("stored_procedure","LSEncryptedBackupsDecryptMessageProtobufsStoredProcedure"),d[11].set("error_message",""),g=[void 0,d[11]],d[2]=g[0],d[3]=g[1],g):(f=e.item,c.sequence([function(a){return d[19]=f.backupId,d[18]=f.backupTenancy,d[17]=f.encryptionVersion,d[11]=void 0,c.i64.neq(d[11],void 0)?c.resolve(d[12]=d[11]):c.sequence([function(a){return d[20]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[21]=a[0],a})},function(a){return d[21]?d[30]=(d[20].push(c.i64.cast([0,0])),d[20]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[22]=a[0],a})},function(a){return d[22]?d[30]=(d[20].push(c.i64.cast([0,2])),d[20]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[23]=a[0],a})},function(a){return d[23]?d[30]=(d[20].push(c.i64.cast([0,3])),d[20]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[24]=a[0],a})},function(a){return d[24]?d[30]=(d[20].push(c.i64.cast([0,4])),d[20]):0,d[25]=c.createArray(),d[26]=c.i64.of_int32(d[20].length),c.i64.gt(d[26],c.i64.cast([0,0]))?c.loopAsync(d[26],function(a){return d[30]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[20],d[30]).then(function(a){return a=a,d[31]=a[0],d[32]=a[1],a})},function(a){return d[33]=(d[25].push(d[31]),d[25])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[30]=c.createArray(),d[31]=c.i64.of_int32(d[25].length),c.i64.gt(d[31],c.i64.cast([0,0]))?c.loopAsync(d[31],function(a){return d[33]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[25],d[33]).then(function(a){return a=a,d[34]=a[0],d[35]=a[1],a})},function(a){return d[36]=(d[30].push(c.i64.to_string(d[34])),d[30])}])}):c.resolve()},function(a){return d[32]=d[30].join(","),d[27]=d[32]}])},function(a){return d[25].some(function(a){return c.i64.eq(d[17],a)})?d[28]=d[17]:d[28]=void 0,c.i64.neq(d[28],void 0)?d[29]=d[28]:d[29]=void 0,d[12]=d[29]}])},function(e){return c.i64.neq(d[12],void 0)?d[13]=d[12]:d[13]=c.i64.cast([0,0]),c.i64.neq(d[18],void 0)?d[14]=d[18]:d[14]=c.i64.cast([0,1]),c.i64.neq(f.deviceId,void 0)?c.sequence([function(e){return d[20]=c.createArray(),d[21]=c.createArray(),d[22]=new c.Map(),d[23]=c.i64.of_int32(a[0].length),c.i64.gt(d[23],c.i64.cast([0,0]))?c.loopAsync(d[23],function(e){return d[27]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[0],d[27]).then(function(a){return a=a,d[28]=a[0],d[29]=a[1],a})},function(a){return d[30]=d[28].get("encrypted_protobufs"),d[28],d[31]=d[30].get("toplevel_protobuf"),d[30],d[32]=d[31].get("epoch_id"),d[31],d[33]=d[31].get("epoch_anon_id"),d[31],d[34]=d[22].get(c.blobs.to_string(d[33])),d[22],d[34]!==void 0?c.resolve(d[35]=d[34]):c.sequence([function(a){return c.i64.neq(d[32],void 0)?c.sequence([function(a){return d[42]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch([[[d[32]]]]),function(a){return c.i64.eq(a.backupId,d[19])&&c.i64.eq(a.epochId,d[32])&&c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[43]=new c.Map(),d[43].set("epoch_root_key",a.epochRootKeyBlob),d[43].set("epoch_anon_id",a.epochAnonIdBlob),d[44]=(d[42].push(d[43]),d[42])})},function(a){return d[41]=d[42]}]):c.sequence([function(a){return d[42]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch([[[d[19]]],"fk_secure_encrypted_backups_client_state"]),function(a){return c.i64.eq(a.backupId,d[19])&&c.blobs.eq(a.epochAnonIdBlob,d[33])&&c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[43]=new c.Map(),d[43].set("epoch_root_key",a.epochRootKeyBlob),d[43].set("epoch_anon_id",a.epochAnonIdBlob),d[44]=(d[42].push(d[43]),d[42])})},function(a){return d[41]=d[42]}])},function(a){return d[35]=d[41]}])},function(e){return d[36]=d[31].get("epoch_anon_id"),d[31],d[22].set(c.blobs.to_string(d[36]),d[35]),d[37]=d[31].get("encrypted_protobuf"),d[31],d[38]=d[31].get("encryption_version"),d[31],c.storedProcedure(b("LSDecryptProtobuf"),d[37],d[38],a[1],d[35]).then(function(a){return a=a,d[39]=a[0],d[40]=a[1],a})},function(e){return c.blobs.neq(d[39],void 0)?c.sequence([function(e){return d[41]=d[28].get("encrypted_protobufs"),d[28],d[42]=d[41].get("supplemental_protobufs"),d[41],d[43]=new c.Map(),d[44]=d[42].keys(),d[45]=c.i64.of_int32(d[44].length),c.i64.gt(d[45],c.i64.cast([0,0]))?c.loopAsync(d[45],function(e){return d[50]=e,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[44],d[50]).then(function(a){return a=a,d[51]=a[0],d[52]=a[1],a})},function(e){return d[53]=d[42].get(d[51]),d[42],d[53]!==void 0?c.sequence([function(a){return d[54]=d[53].get("epoch_id"),d[53],d[55]=d[53].get("epoch_anon_id"),d[53],d[56]=d[22].get(c.blobs.to_string(d[55])),d[22],d[56]!==void 0?c.resolve(d[57]=d[56]):c.sequence([function(a){return c.i64.neq(d[54],void 0)?c.sequence([function(a){return d[63]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch([[[d[54]]]]),function(a){return c.i64.eq(a.backupId,d[19])&&c.i64.eq(a.epochId,d[54])&&c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[64]=new c.Map(),d[64].set("epoch_root_key",a.epochRootKeyBlob),d[64].set("epoch_anon_id",a.epochAnonIdBlob),d[65]=(d[63].push(d[64]),d[63])})},function(a){return d[62]=d[63]}]):c.sequence([function(a){return d[63]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch([[[d[19]]],"fk_secure_encrypted_backups_client_state"]),function(a){return c.i64.eq(a.backupId,d[19])&&c.blobs.eq(a.epochAnonIdBlob,d[55])&&c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[64]=new c.Map(),d[64].set("epoch_root_key",a.epochRootKeyBlob),d[64].set("epoch_anon_id",a.epochAnonIdBlob),d[65]=(d[63].push(d[64]),d[63])})},function(a){return d[62]=d[63]}])},function(a){return d[57]=d[62]}])},function(a){return d[58]=d[53].get("epoch_anon_id"),d[53],d[22].set(c.blobs.to_string(d[58]),d[57]),d[59]=d[53].get("sk_ciphertext"),d[53],c.storedProcedure(b("LSDecryptSupplementalKey"),d[59]==null?"":d[59],d[57]).then(function(a){return a=a,d[60]=a[0],d[61]=a[1],a})},function(e){return d[60]!==void 0?c.sequence([function(e){return d[62]=d[53].get("encrypted_protobuf"),d[53],d[63]=d[53].get("encryption_version"),d[53],c.storedProcedure(b("LSDecryptProtobuf"),d[62],d[63],a[1],d[57]).then(function(a){return a=a,d[64]=a[0],d[65]=a[1],a})},function(a){return c.blobs.neq(d[64],void 0)?(d[66]=d[53].get("protobuf_timestamp_ms"),d[53],d[67]=new c.Map(),d[67].set("decrypted_protobuf",d[64]),d[67].set("protobuf_timestamp_ms",d[66]),d[43].set(d[60],d[67])):d[66]=(d[21].push(d[65]),d[21])}]):c.resolve((d[62]=new c.Map(),d[62].set("error_code",c.i64.cast([0,109])),d[62].set("stored_procedure","LSEncryptedBackupsDecryptMessageProtobufsStoredProcedure"),d[62].set("error_message",""),d[63]=(d[21].push(d[62]),d[21])))}]):c.resolve()}])}):c.resolve()},function(a){return d[46]=d[28].get("otid"),d[28],d[47]=d[31].get("protobuf_timestamp_ms"),d[31],d[48]=new c.Map(),d[48].set("decrypted_protobuf",d[39]),d[48].set("protobuf_timestamp_ms",d[47]),d[49]=new c.Map(),d[49].set("otid",d[46]),d[49].set("toplevel_protobuf",d[48]),d[49].set("supplemental_protobufs",d[43]),d[50]=(d[20].push(d[49]),d[20])}]):c.resolve(d[41]=(d[21].push(d[40]),d[21]))}])}):c.resolve()},function(a){return d[24]=c.i64.of_int32(d[21].length),c.i64.gt(d[24],c.i64.cast([0,0]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[21],c.i64.cast([0,0])).then(function(a){return a=a,d[27]=a[0],d[28]=a[1],a})},function(a){return a=[void 0,d[27]],d[25]=a[0],d[26]=a[1],a}]):c.resolve((a=[d[20],void 0],d[25]=a[0],d[26]=a[1],a))},function(a){return a=[d[25],d[26]],d[15]=a[0],d[16]=a[1],a}]):c.resolve((d[20]=new c.Map(),d[20].set("error_code",c.i64.cast([0,24])),d[20].set("stored_procedure","LSEncryptedBackupsDecryptMessageProtobufsStoredProcedure"),d[20].set("error_message",""),e=[void 0,d[20]],d[15]=e[0],d[16]=e[1],e))},function(a){return a=[d[15],d[16]],d[2]=a[0],d[3]=a[1],a}]))})},function(a){return d[5]=c.i64.of_float(Date.now()),d[6]=c.i64.random(),d[8]="Finishing execution. Execution time: ",d[9]=c.i64.to_string(c.i64.sub(d[5],d[0])),d[10]=" ms",d[7]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][decryptMessageProtobufs] ",d[7],d[8],d[7],d[9],d[7],d[10]].join("")),c.i64.eq(c.i64.mod_(d[6],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[11]=",",d[12]=c.createArray(),void 0!==void 0?d[13]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"decryptMessageProtobufs",[d[8],d[11],d[9],d[11],d[10]].join(""),d[12],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[2],d[3]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsDecryptMessageProtobufsStoredProcedure";e.exports=a}),null);
__d("MAWRestoreProtobufsFromEncryptedBackupsDeferred",["I64","LSDatabaseSingleton","promiseDone","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=c("requireDeferred")("MAWRestoreProtobufsFromEncryptedBackupsNOP").__setRef("MAWRestoreProtobufsFromEncryptedBackupsDeferred");function a(a,b,e,f,g,k,l,m,n,o,p,q,r){return j.load().then(function(j){c("promiseDone")((h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton.then(function(c){return c.runInTransaction(function(c){return j.call(c,a,b,e,f,g!=null?(i||(i=d("I64"))).to_float(g):0,k,l!=null?(i||(i=d("I64"))).to_float(l):(i||(i=d("I64"))).to_float((i||(i=d("I64"))).max_int),m,n,o,p,q,r)},"readwrite")}))})}g.call=a}),98);
__d("LSRestoreProtobufs.nop",["CurrentUser","I64","LSIntEnum","LSMEBTaskCreationSource","LSShape","LSVec","MAWAsyncEBPendingQueryPromise","MAWEBRestoreTrackingUtils","MAWEBUploadMessageUtils","MAWEncryptedBackupUtils","MAWEncryptedBackupsDYIHandleMessageRestore","MAWHandleEchoProtobufsRestoreApi","MAWJids","MAWJobDefinitions","MAWRestoreProtobufsFromEncryptedBackupsDeferred","Promise","WAJids","WATagsLogger","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Restoring Messenger DYI batch"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - Failed to decode protobufs, with error: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - ",""]);m=function(){return a};return a}a=function(a,e,f,g,i,p,q,r,s,t,u,v,w,x){a=null;w!=null&&(a=n(w));d("WATagsLogger").TAGS(["labyrinth_web","protobuf_restore",(e=t)!=null?e:"no_request_id"]).LOG(m(),(w=t)!=null?w:"no_request_id");d("MAWEBRestoreTrackingUtils").markEBRestoreProtobuf(x);e=o(g);d("MAWEncryptedBackupUtils").logIfDuplicateMessagesFoundInRestore(e,"protobuf_restore");if(t!=null)try{d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"native_op_start",traceId:t,type:"protobuf"});var y=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());w=d("MAWHandleEchoProtobufsRestoreApi").decodeProtobufArray(e,y).map(function(a){var b;if((a==null?void 0:(b=a.metadata)==null?void 0:b.messageId)!=null){b=d("MAWHandleEchoProtobufsRestoreApi").createUnstoredDbContentFromProtobufObject(a,d("WAJids").unsafeCoerceToChatJid(f),y);if(b!=null&&b.unstoredDbContent.unstoredDbMsg!=null){a=b.unstoredDbContent.unstoredDbMsg;b=d("MAWEBUploadMessageUtils").echoOverrideMessageSortOrder(a);a.sortOrderMs=b;return a}return null}return null}).filter(Boolean);d("MAWAsyncEBPendingQueryPromise").resolvePendingQueryIfPresent(t,{hasMoreAfter:q,hasMoreBefore:i,messages:w,nextMessageTimestampMsBefore:p,restoreType:"protobuf"})}catch(a){d("WATagsLogger").TAGS(["labyrinth_web","protobuf_restore",(g=t)!=null?g:"no_request_id"]).ERROR(l(),a.message)}w=x!=null&&(j||(j=d("LSIntEnum"))).unwrapIntEnum(x)===c("LSMEBTaskCreationSource").MSGR_DYI;g=c("gkx")("3057");if(w&&g){d("WATagsLogger").TAGS(["labyrinth_web","protobuf_restore",(w=t)!=null?w:"no_request_id"]).LOG(k());void d("MAWEncryptedBackupsDYIHandleMessageRestore").handleMAWProtobufMessageRangeQueryRestore(f,e,i,p);return(h||(h=b("Promise"))).resolve()}c("promiseDone")(d("MAWRestoreProtobufsFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(f),e,i,p,q,r,s,t,u,v,a,x));return(h||(h=b("Promise"))).resolve()};function n(a){return c("LSVec").toArray(a).map(function(a){return d("MAWJobDefinitions").toEncodedEchoMessage(a)})}function o(a){a=c("LSVec").toArray(a);a=a.map(function(a){return d("LSShape").toRecord(a)});return a.map(function(a){var b=d("LSShape").toRecord(a.toplevel_protobuf);b={decryptedProtobuf:b.decrypted_protobuf,protobufTimestampMS:(i||(i=d("I64"))).to_float(b.protobuf_timestamp_ms)};var c=new Map(),e=a.supplemental_protobufs;e.forEach(function(a,b){a=d("LSShape").toRecord(a);c.set(b,{decryptedProtobuf:a.decrypted_protobuf,protobufTimestampMS:(i||(i=d("I64"))).to_float(a.protobuf_timestamp_ms)})});return{otid:a.otid,supplementalProtobufs:c,toplevelProtobuf:b}})}g["default"]=a}),98);
__d("LSHandleMessageWithProtobufsRestore",["LSArrayGetObjectAt","LSDecryptMessageProtobufs","LSIsEncryptionVersionSecure","LSLoadThreadPkFromThreadId","LSLogMebClientEvent.nop","LSRestoreProtobufs.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][handleMessageWithProtobufsRestore] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.storedProcedure(b("LSDecryptMessageProtobufs"),a[0],a[2]).then(function(a){return a=a,d[2]=a[0],d[3]=a[1],a})},function(b){return d[4]=a[5].get("request_id"),a[5],d[5]=a[5].get("restore_task_source"),a[5],c.i64.neq(a[7],void 0)?c.sequence([function(b){return c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}).next().then(function(b,e){var f=b.done;b=b.value;return f?d[13]=!1:(e=b.item,d[16]=e.deviceId,c.i64.neq(d[16],void 0)?d[15]=c.i64.neq(d[16],a[7]):d[15]=!1,d[13]=d[15])})},function(a){return d[6]=d[13]}]):c.resolve(d[6]=!1)},function(e){return d[6]?c.resolve(0):c.sequence([function(e){return d[2]!==void 0?c.sequence([function(e){return c.storedProcedure(b("LSLoadThreadPkFromThreadId"),a[2]).then(function(a){return a=a,d[14]=a[0],d[15]=a[1],a})},function(e){return c.i64.neq(d[14],void 0)?c.sequence([function(e){return void 0!==void 0?c.resolve(d[17]=void 0):c.sequence([function(e){return d[18]=a[1].get("has_more_before"),a[1],d[19]=a[1].get("has_more_after"),a[1],d[18]?(d[27]=a[1].get("next_message_timestamp_ms_before"),a[1],d[20]=d[27]):d[20]=void 0,d[19]?(d[27]=a[1].get("next_message_timestamp_ms_after"),a[1],d[21]=d[27]):d[21]=void 0,d[22]=a[1].get("has_more_before"),a[1],d[23]=a[1].get("has_more_after"),a[1],d[24]=a[5].get("request_id"),a[5],d[25]=a[5].get("reference_timestamp"),a[5],d[26]=c.createArray(),c.nativeOperation(b("LSRestoreProtobufs.nop"),a[2],d[2],d[22],d[20],d[23],d[21],a[4],d[24],d[25],a[6],d[26],d[5])},function(a){return d[17]=void 0}])},function(a){return d[16]=d[17]}]):c.resolve(d[16]=d[15])},function(a){return d[13]=d[16]}]):c.resolve((d[3]!==void 0?(d[14]=d[3].get("error_code"),d[3],c.i64.eq(d[14],c.i64.cast([0,1]))?0:0):0,d[13]=d[3]))},function(e){return d[13]!==void 0?a[6]!==void 0?c.sequence([function(e){return d[14]=a[5].get("request_id"),a[5],c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,e){var f=a.done;a=a.value;return f?d[15]=void 0:(e=a.item,c.sequence([function(a){return d[25]=e.deviceId,d[24]=e.backupTenancy,d[23]=e.encryptionVersion,d[18]=void 0,c.i64.neq(d[18],void 0)?c.resolve(d[19]=d[18]):c.sequence([function(a){return d[26]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[27]=a[0],a})},function(a){return d[27]?d[36]=(d[26].push(c.i64.cast([0,0])),d[26]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[28]=a[0],a})},function(a){return d[28]?d[36]=(d[26].push(c.i64.cast([0,2])),d[26]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[29]=a[0],a})},function(a){return d[29]?d[36]=(d[26].push(c.i64.cast([0,3])),d[26]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[30]=a[0],a})},function(a){return d[30]?d[36]=(d[26].push(c.i64.cast([0,4])),d[26]):0,d[31]=c.createArray(),d[32]=c.i64.of_int32(d[26].length),c.i64.gt(d[32],c.i64.cast([0,0]))?c.loopAsync(d[32],function(a){return d[36]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[26],d[36]).then(function(a){return a=a,d[37]=a[0],d[38]=a[1],a})},function(a){return d[39]=(d[31].push(d[37]),d[31])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[36]=c.createArray(),d[37]=c.i64.of_int32(d[31].length),c.i64.gt(d[37],c.i64.cast([0,0]))?c.loopAsync(d[37],function(a){return d[39]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[31],d[39]).then(function(a){return a=a,d[40]=a[0],d[41]=a[1],a})},function(a){return d[42]=(d[36].push(c.i64.to_string(d[40])),d[36])}])}):c.resolve()},function(a){return d[38]=d[36].join(","),d[33]=d[38]}])},function(a){return d[31].some(function(a){return c.i64.eq(d[23],a)})?d[34]=d[23]:d[34]=void 0,c.i64.neq(d[34],void 0)?d[35]=d[34]:d[35]=void 0,d[19]=d[35]}])},function(a){return c.i64.neq(d[19],void 0)?d[20]=d[19]:d[20]=c.i64.cast([0,0]),c.i64.neq(d[24],void 0)?d[21]=d[24]:d[21]=c.i64.cast([0,1]),c.i64.neq(d[25],void 0)?d[22]=d[25]:d[22]=void 0,d[15]=d[22]}]))})},function(b){return d[17]=a[5].get("restore_task_source")},a[5]]):c.resolve():c.resolve(0)}])},function(a){return d[7]=c.i64.of_float(Date.now()),d[8]=c.i64.random(),d[10]="Finishing execution. Execution time: ",d[11]=c.i64.to_string(c.i64.sub(d[7],d[0])),d[12]=" ms",d[9]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageWithProtobufsRestore] ",d[9],d[10],d[9],d[11],d[9],d[12]].join("")),c.i64.eq(c.i64.mod_(d[8],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[13]=",",d[14]=c.createArray(),void 0!==void 0?d[15]=(d[14].push(void 0),d[14]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleMessageWithProtobufsRestore",[d[10],d[13],d[11],d[13],d[12]].join(""),d[14],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsHandleMessageWithProtobufsRestoreStoredProcedure";e.exports=a}),null);/*FB_PKG_DELIM*/
__d("LSCreateOpenToE2EEThreadLink",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.db.table(193).put({openThreadId:a[0],armadilloThreadId:a[1],showOpenMessageHistory:a[2],timestampMs:a[3]})},function(a){return b.resolve(c)}])}a.__sproc_name__="LSE2EEMessagingMetadataMailboxCreateOpenToE2EEThreadLinkStoredProcedure";e.exports=a}),null);
__d("LSShimHybridThreadDeleteUtil",["Promise","ReQL"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.mi_act_mapping_table).getKeyRange(b)).then(function(a){return a})}function c(a,c){if(c!=null)return(h||(h=b("Promise"))).all([a.threads["delete"](c.serverThreadKey),a.mi_act_mapping_table["delete"](c.serverThreadKey,c.clientThreadPk,c.jid)]).then(function(){});else return(h||(h=b("Promise"))).resolve()}g.getMiActMappingRow=a;g.deleteE2EEMetadataTable=c}),98);
__d("LSShimHybridThreadDeleteByThreadKey.nop",["LSShimHybridThreadDeleteUtil","asyncToGeneratorRuntime","gkx","qex"],(function(a,b,c,d,e,f,g){"use strict";a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){if(c("qex")._("1016")!==!0&&!c("gkx")("4991")){b=(yield d("LSShimHybridThreadDeleteUtil").getMiActMappingRow(a,e));return d("LSShimHybridThreadDeleteUtil").deleteE2EEMetadataTable(a,b)}});function e(b,c,d){return a.apply(this,arguments)}return e}();g["default"]=a}),98);
__d("LSHybridThreadDelete",["LSShimHybridThreadDeleteByThreadKey.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[];return c.sequence([function(d){return c.nativeOperation(b("LSShimHybridThreadDeleteByThreadKey.nop"),a[0])},function(a){return c.resolve(d)}])}a.__sproc_name__="LSE2EEMessagingMetadataMailboxHybridThreadDeleteStoredProcedure";e.exports=a}),null);
__d("LSMoveThreadToE2EECutoverFolder",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.db.table(9).fetch([[[a[0]]]]).next().then(function(c,d){d=c.done;c=c.value;return d?0:(c.item,b.forEach(b.db.table(9).fetch([[[a[0]]]]),function(a){var c=a.update;a.item;return c({folderName:"e2ee_cutover",parentThreadKey:b.i64.cast([-1,4294967279])})}))})},function(a){return b.resolve(c)}])}a.__sproc_name__="LSMailboxMoveThreadToE2EECutoverFolderStoredProcedure";e.exports=a}),null);
__d("LSReplaceOptimisticThread",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.db.table(9).fetch([[[a[1]]]]).next().then(function(c,d){d=c.done;c=c.value;return d?b.forEach(b.filter(b.db.table(9).fetch([[[a[0]]]]),function(c){return b.i64.eq(c.threadKey,a[0])&&b.i64.le(c.authorityLevel,b.i64.cast([0,20]))}),function(c){var d=c.update;c.item;return d({threadKey:a[1],authorityLevel:b.i64.cast([0,40])})}):(c.item,b.forEach(b.db.table(9).fetch([[[a[0]]]]),function(a){return a["delete"]()}))})},function(a){return b.resolve(c)}])}a.__sproc_name__="LSMailboxReplaceOptimisticThreadStoredProcedure";e.exports=a}),null);
__d("LSShimCopyAllParticipantNicknamesForThread",["gkx"],(function(a,b,c,d,e,f,g){function a(){var a=arguments,b=a[a.length-1],d=[];return c("gkx")("26379")===!1?0:0,b.resolve(d)}a.__sproc_name__="LSMailboxShimCopyAllParticipantNicknamesForThreadStoredProcedure";b=a;g["default"]=b}),98);
__d("LSShimGetServerThreadKeyFromJIDV2.nop",["ReQL","RetUtil","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){b=(yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.mi_act_mapping_table.index("jid")).getKeyRange(c)));return d("RetUtil").getNullableRetResult(b==null?void 0:b.serverThreadKey)});function c(b,c,d){return a.apply(this,arguments)}return c}();g["default"]=a}),98);
__d("MAWMiActBulkCreateThreadInActWithMiData",["I64","MAWBridgeFireAndForget","MAWBridgeSendAndReceive","MAWJids","MAWMIC","MAWTrackPendingOccamadilloThreads","MAWWaitForBackendSetup","MWCookieUtil","Promise","WABridgedAPI","WAJids","WALoggerDeferred","asyncToGeneratorRuntime","getErrorSafe","gkx","promiseDone","useMWInboxURIState"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Occamadillo] Querying WA server for group: ",""]);j=function(){return a};return a}var k=1,l=10,m=10,n=20;function a(a){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){try{var e=function(){return d("MAWBridgeSendAndReceive").sendAndReceive("backend","bulkCreateThread",{threads:f})},f=a.map(function(a){var b=a.fbid,e=a.isGroupThread,f=a.jid,g=a.lastActivityTimestampMs;a=a.lastReadWatermarkTimestampMs;f=(i||(i=d("I64"))).to_string(f);f=e?d("WAJids").toGroupJid(f):d("MAWJids").toUserJid(f);var h=d("MWCookieUtil").getAutoChatTabFromCookie();h=h?(i||(i=d("I64"))).equal(h.threadKey,b):!1;var j=h?l:k;j=c("gkx")("33030")&&!h&&!e?m:j;h=document.URL;e=d("useMWInboxURIState").getRouteTokens(h);c("gkx")("2316")&&e.indexOf((i||(i=d("I64"))).to_string(b))>-1&&(j=n);return{authoritativeThreadKey:i.to_string(b),chatJid:f,lastActivityTimestampMs:i.to_float(g),lastReadWatermarkTimestampMs:i.to_float(a),numOfMsgsToLoad:j}});e=(yield c("gkx")("4568")?d("MAWWaitForBackendSetup").waitForBackendSetup("bulk-occamadillo-mapping-await").then(e):e());d("MAWMIC").markEvent("occamadillo_mapping_bridge_event_received");yield (h||(h=b("Promise"))).all(e.map(function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b,e){if(b.status==="rejected")throw b.reason;e=a[e];var f=e.isGroupThread;e=e.jid;e=(i||(i=d("I64"))).to_string(e);if(f){f=d("WAJids").toGroupJid(e);if(b.value.isCreated||c("gkx")("23923")&&b.value.shouldQueryForGroup){c("promiseDone")(d("WALoggerDeferred").DEV(j(),e));try{yield c("WABridgedAPI").queryGroups({groups:[f],type:"array"})}catch(a){var g=a instanceof Error&&a.message.includes('"errorCode":403');if(!g)throw a}d("MAWBridgeFireAndForget").fireAndForget("backend","checkIfGroupParticipant",{threadJid:b.value.chatJid})}else c("gkx")("33036")&&d("MAWBridgeFireAndForget").fireAndForget("backend","updateLSThreadFromGroupInfo",{groupJid:f})}c("promiseDone")(d("MAWTrackPendingOccamadilloThreads").removePendingThread(e))});return function(a,b){return e.apply(this,arguments)}}()));return e}catch(a){d("MAWMIC").fail("thread_mapping_error",c("getErrorSafe")(a));throw a}});return o.apply(this,arguments)}g.miActBulkCreateThreadInActWithMiData=a}),98);
__d("WABatcher",["Promise","WAErr","WAResolvable"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,d){var e=a.delayMs,f=a.maxSize,g=null;function i(a){g&&g.args===a&&(g=null);return d(a)}var j=function(){if(g==null)return(h||(h=b("Promise"))).resolve();var a=g;g=null;clearTimeout(a.timer);a.run();return a.batchPromise};a=function(a){if(g)g.args.push(a);else{var d,k=[a];a=new(h||(h=b("Promise")))(function(a){d=function(){return void a(k)}}).then(i);var l=d;g={args:k,batchPromise:a,run:l,timer:setTimeout(l,e)}}if(g==null)throw c("WAErr")("activeBatch should not be null here");a=g;l=a.args;a=a.batchPromise;var m=l.length-1;f!=null&&l.length>=f&&void j();return a.then(function(a){return a[m]})};return{accept:a,runActiveBatch:j}}function a(a,b){var c=i(a,b);return function(a){return c.accept(a)}}function e(a){var e=[],f=new(d("WAResolvable").Resolvable)(),g=function(c){if(e.length===0)return(h||(h=b("Promise"))).resolve(new Map());var g=e,i=f;e=[];f=new(d("WAResolvable").Resolvable)();return(h||(h=b("Promise"))).resolve(a(g,c)).then(function(a){i.resolve(a);return a})},i=function(a){e.push(a);return f.promise.then(function(b){b=b.get(a);if(b==null)throw c("WAErr")("This should not happen because we just added it to the batch");return b})};return{accept:i,runActiveBatch:g}}g.createSimpleBatcher=i;g.batch=a;g.createBatcher=e}),98);
__d("LSShimVerifyThreadExists.nop",["I64","LSAuthorityLevel","LSContactGender","LSContactIdType","LSContactType","LSContactViewerRelationship","LSContactWorkForeignEntityType","LSFactory","LSGroupParticipantJoinState","LSIntEnum","LSPlatformArmadilloUtils","LSVec","LSVerifyContactRowExistsStoredProcedure","MAWMiActBulkCreateThreadInActWithMiData","MAWMiActCreateThreadInActWithMiData","MAWTrackPendingOccamadilloThreads","MWCookieUtil","Promise","ReQL","TemporaryLoggingUtilsForS406998Only","WABatcher","WALoggerDeferred","asyncToGeneratorRuntime","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Occamadillo] MI thread insertion for fbid: "," with last activity timestamp: "," and last read timestamp: ",", read = ",""]);k=function(){return a};return a}function l(a,b,c){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f){yield (j||(j=b("Promise"))).all(c("LSVec").toArray(f).map(function(b){return c("LSVerifyContactRowExistsStoredProcedure")(c("LSFactory")(a),{authorityLevel:(h||(h=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").OPTIMISTIC),blockedByViewerStatus:h.ofNumber(0),contactIdType:h.ofNumber(c("LSContactIdType").FBID),contactType:h.ofNumber(c("LSContactType").USER),contactViewerRelationship:h.ofNumber(c("LSContactViewerRelationship").UNKNOWN),gender:h.ofNumber(c("LSContactGender").UNKNOWN),id:b,isBlocked:!1,isMemorialized:!1,isSelf:!1,workForeignEntityType:h.ofNumber(c("LSContactWorkForeignEntityType").UNKNOWN)}).then(function(){return a.participants.put(d("TemporaryLoggingUtilsForS406998Only").logIfInvalidParticipantAndReturnForS406998Only({authorityLevel:(h||(h=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").OPTIMISTIC),contactId:b,deliveredWatermarkTimestampMs:(i||(i=d("I64"))).zero,groupParticipantJoinState:h.ofNumber(c("LSGroupParticipantJoinState").MEMBER),isModerator:!1,readActionTimestampMs:i.zero,readWatermarkTimestampMs:i.zero,threadKey:e},"LSShimVerifyThreadExists.nop"))})}))});return m.apply(this,arguments)}function n(a,b,c){return a.mi_act_mapping_table.put({clientThreadPk:(i||(i=d("I64"))).neg(b),jid:c,serverThreadKey:b})}a=200;e=15;var o=d("WABatcher").createSimpleBatcher({delayMs:a,maxSize:e},function(a){c("promiseDone")(d("MAWMiActBulkCreateThreadInActWithMiData").miActBulkCreateThreadInActWithMiData(a));return[]});d("LSPlatformArmadilloUtils").executeOnThreadMappingEnd(b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield o.runActiveBatch()}));f=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h,j,m,p){b=(yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.mi_act_mapping_table).getKeyRange(e)));b==null&&(yield n(a,e,f));c("promiseDone")(d("WALoggerDeferred").LOG(k(),(i||(i=d("I64"))).to_string(e),i.to_string(m),i.to_string(p),i.le(m,p)));c("gkx")("773")||(yield l(a,e,g));d("MAWTrackPendingOccamadilloThreads").addPendingThread(i.to_string(f));d("MWCookieUtil").isAutoChatTabFromCookie(e)?c("promiseDone")(d("MAWMiActCreateThreadInActWithMiData").miActCreateThreadInActWithMiData({fbid:e,isGroupThread:j,jid:f,lastActivityTimestampMs:m,lastReadWatermarkTimestampMs:p})):c("promiseDone")(o.accept({fbid:e,isGroupThread:j,jid:f,lastActivityTimestampMs:m,lastReadWatermarkTimestampMs:p}))});function e(b,c,d,e,f,g,h,i,j){return a.apply(this,arguments)}return e}();g["default"]=f}),98);
__d("LSTransportHybridParticipantUpdateReceipts",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.resolve(c)}a.__sproc_name__="LSE2EEMessagingMetadataMailboxTransportHybridParticipantUpdateReceiptsStoredProcedure";e.exports=a}),null);
__d("LSUpdateOccamadilloMostRecentMessagePerThread",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[],d=[];return b.sequence([function(d){return b.db.table(292).fetch([[[a[0]]]]).next().then(function(d,e){var f=d.done;d=d.value;return f?(c[1]=b.i64.of_float(Date.now()),b.db.table(292).add({threadKey:a[0],timestampMs:a[1],fetchTimestampMs:c[1]})):(e=d.item,c[2]=e.fetchTimestampMs,c[1]=b.i64.of_float(Date.now()),b.i64.neq(c[2],void 0)?b.i64.ge(c[1],b.i64.add(c[2],b.i64.cast([0,2592e6])))?b.db.table(292).put({threadKey:a[0],timestampMs:a[1],fetchTimestampMs:c[1]}):b.resolve():b.forEach(b.db.table(292).fetch([[[a[0]]]]),function(a){var b=a.update;a.item;return b({fetchTimestampMs:c[1]})}))})},function(a){return b.resolve(d)}])}a.__sproc_name__="LSE2EEMessagingMetadataMailboxUpdateOccamadilloMostRecentMessagePerThreadStoredProcedure";e.exports=a}),null);
__d("LSUpdateOptimisticContextThreadKeys",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.sequence([function(c){return b.forEach(b.filter(b.db.table(32).fetch(),function(c){return b.i64.eq(c.threadKey,a[0])}),function(b){var c=b.update;b.item;return c({threadKey:a[1]})})},function(c){return b.forEach(b.filter(b.db.table(31).fetch(),function(c){return b.i64.eq(c.threadKey,a[0])}),function(b){var c=b.update;b.item;return c({threadKey:a[1]})})}])},function(a){return b.resolve(c)}])}a.__sproc_name__="LSCoreUpdateOptimisticContextThreadKeysStoredProcedure";e.exports=a}),null);
__d("LSUpdateTaskQueueName",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.forEach(b.db.table(2).fetch([[[a[0]]],"queueNameTaskId"]),function(b){var c=b.update;b.item;return c({queueName:a[1]})})},function(a){return b.resolve(c)}])}a.__sproc_name__="LSCoreUpdateTaskQueueNameStoredProcedure";e.exports=a}),null);
__d("LSUpdateTaskValue",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.forEach(b.db.table(2).fetch([[[a[0]]],"queueNameTaskId"]),function(b){var c=b.update;b=b.item;return c({taskValue:b.taskValue.split(a[1]).join(a[2])})})},function(a){return b.resolve(c)}])}a.__sproc_name__="LSCoreUpdateTaskValueStoredProcedure";e.exports=a}),null);
__d("LSUpdateThreadAuthorityAndMapping",["LSDeleteThread","LSReplaceOptimisticThread","LSShimGetServerThreadKeyFromJIDV2.nop","LSUpdateOptimisticContextThreadKeys","LSUpdateTaskQueueName","LSUpdateTaskValue"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return c.nativeOperation(b("LSShimGetServerThreadKeyFromJIDV2.nop"),a[0]).then(function(a){return a=a,d[0]=a[0],a})},function(b){return c.db.table(9).fetch([[[a[1]]]]).next().then(function(a,b){b=a.done;a=a.value;return b?d[1]=!1:(a.item,d[1]=!0)})},function(b){return c.filter(c.db.table(9).fetch(),function(b){return c.i64.eq(b.threadKey,a[2])}).next().then(function(a,b){b=a.done;a=a.value;return b?d[3]=!1:(a.item,d[3]=!0)})},function(e){return d[5]=c.i64.neq(d[0],void 0),d[7]=c.i64.eq(d[0],a[2])&&d[5],!d[7]&&!(c.i64.eq(d[0],a[1])&&d[5])&&d[5]?function(a){c.logger(a).mustfix(a)}("The mi_act_mapping row did not correspond to either the authoritative or optimistic thread key."):0,c.i64.neq(a[2],void 0)?d[6]=a[2]:d[6]=c.i64.cast([0,0]),d[5]?d[7]?c.sequence([function(e){return d[1]?c.storedProcedure(b("LSDeleteThread"),a[1],!1):c.resolve()},function(a){return c.i64.neq(d[6],void 0)?c.forEach(c.db.table(9).fetch([[[d[6]]]]),function(a){var b=a.update;a.item;return b({clientThreadKey:d[6]})}):c.resolve()},function(e){return c.storedProcedure(b("LSReplaceOptimisticThread"),d[6],a[1])},function(e){return c.storedProcedure(b("LSUpdateOptimisticContextThreadKeys"),d[6],a[1])}]):d[3]?c.storedProcedure(b("LSDeleteThread"),d[6],!1):c.resolve():d[3]?d[1]?c.storedProcedure(b("LSDeleteThread"),d[6],!1):c.sequence([function(a){return c.i64.neq(d[6],void 0)?c.forEach(c.db.table(9).fetch([[[d[6]]]]),function(a){var b=a.update;a.item;return b({clientThreadKey:d[6]})}):c.resolve()},function(e){return c.storedProcedure(b("LSReplaceOptimisticThread"),d[6],a[1])},function(e){return c.storedProcedure(b("LSUpdateOptimisticContextThreadKeys"),d[6],a[1])}]):c.resolve()},function(e){return d[3]?c.sequence([function(e){return d[9]=c.i64.to_string(d[6]),d[8]=c.i64.to_string(a[1]),c.storedProcedure(b("LSUpdateTaskQueueName"),d[9],d[8])},function(a){return c.storedProcedure(b("LSUpdateTaskValue"),d[8],d[9],d[8])}]):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSE2EEMessagingMetadataMailboxUpdateThreadAuthorityAndMappingStoredProcedure";e.exports=a}),null);
__d("LSUpdateThreadAuthorityAndMappingWithOTIDFromJID",["LSShimGetServerThreadKeyFromJIDV2.nop","LSUpdateThreadAuthorityAndMapping"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return c.nativeOperation(b("LSShimGetServerThreadKeyFromJIDV2.nop"),a[0]).then(function(a){return a=a,d[0]=a[0],a})},function(e){return c.i64.neq(d[0],a[1])?d[1]=d[0]:d[1]=void 0,c.storedProcedure(b("LSUpdateThreadAuthorityAndMapping"),a[0],a[1],d[1])}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSE2EEMessagingMetadataMailboxUpdateThreadAuthorityAndMappingWithOTIDFromJIDStoredProcedure";e.exports=a}),null);
__d("LSVerifyHybridThreadExists",["LSShimVerifyThreadExists.nop","LSVerifyE2EEMetadataThreadExistsV2"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return c.storedProcedure(b("LSVerifyE2EEMetadataThreadExistsV2"),a[2],a[0],c.i64.cast([0,60])).then(function(a){return a=a,d[0]=a[0],a})},function(b){return d[1]=c.i64.of_float(Date.now()),c.i64.neq(a[11],void 0)?c.sequence([function(b){return c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}).next().then(function(b,e){var f=b.done;b=b.value;return f?d[4]=!1:(e=b.item,d[7]=e.deviceId,c.i64.neq(d[7],void 0)?d[6]=c.i64.neq(d[7],a[11]):d[6]=!1,d[4]=d[6])})},function(a){return d[2]=d[4]}]):c.resolve(d[2]=!1)},function(e){return d[2]?d[3]=!0:d[3]=a[8],c.nativeOperation(b("LSShimVerifyThreadExists.nop"),a[0],a[1],a[3],a[4],a[5],a[6],a[7])},function(a){return e[0]=c.i64.cast([0,0])}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSE2EEMessagingMetadataMailboxVerifyHybridThreadExistsStoredProcedure";e.exports=a}),null);/*FB_PKG_DELIM*/
__d("LSFindBackup",["LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(a){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsFindBackupStoredProcedure] Beginning execution."),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?d[1]=void 0:(b=a.item,d[1]=c.i64.to_string(b.backupId))})},function(a){return d[3]=c.i64.of_float(Date.now()),d[4]=c.i64.random(),d[6]="Finishing execution. Execution time: ",d[7]=c.i64.to_string(c.i64.sub(d[3],d[0])),d[8]=" ms",d[5]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsFindBackupStoredProcedure] ",d[5],d[6],d[5],d[7],d[5],d[8]].join("")),c.i64.eq(c.i64.mod_(d[4],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[9]=",",d[10]=c.createArray(),void 0!==void 0?d[11]=(d[10].push(void 0),d[10]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFindBackupStoredProcedure",[d[6],d[9],d[7],d[9],d[8]].join(""),d[10],c.i64.cast([0,4]))):c.resolve()},function(a){return e[0]=d[1]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsFindBackupStoredProcedure";e.exports=a}),null);
__d("LSIssueAttachmentRestoreTask",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSBase64Encode.nop","LSBinaryToHex.nop","LSCreateDataTrace","LSCreateDataTraceID.nop","LSCreateDerivedKeys.nop","LSFindBackup","LSFlushDataTrace.nop","LSGetBlobFromInt64BE.nop","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","LSOcmfClientMap.nop","LSOpeEncrypt.nop","LSTruncateSortKey.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] Beginning execution."),a[7]!==void 0?c.resolve(d[1]=a[7]):c.sequence([function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))&&c.i64.eq(a.backupTenancy,c.i64.cast([0,2]))}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){b=a.done;a=a.value;return b?d[26]=!1:(a.item,d[26]=!0)})},function(a){return d[26]?d[28]=c.i64.or_(c.i64.cast([0,82]),c.i64.cast([0,128])):d[28]=c.i64.cast([0,82]),c.sequence([function(a){return c.nativeOperation(b("LSCreateDataTraceID.nop")).then(function(a){return a=a,d[30]=a[0],a})},function(a){return c.sequence([function(a){return d[34]="EncryptedBackups MCD Trace ID",d[35]=c.i64.to_string(d[28]),d[33]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][MEBTraceUtils] ",d[33],d[34],d[33],d[35]].join("")),c.resolve()},function(a){return c.storedProcedure(b("LSCreateDataTrace"),d[30],void 0,void 0,"media_restore",d[28])}])},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[31]=a[0],a})},function(a){return d[31]?d[32]=!0:d[32]=!1,d[32]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[33]=c.createArray(),void 0!==void 0?d[34]=(d[33].push(void 0),d[33]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[33],c.i64.cast([0,3]))):c.resolve()},function(a){return d[29]=d[30]}])},function(a){return d[1]=d[29]}])},function(a){return c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,1829]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[26]=a[0],a})},function(a){return d[26]?d[27]=!0:d[27]=!1,d[27]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[28]=c.createArray(),void 0!==void 0?d[29]=(d[28].push(void 0),d[28]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[28],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,e){var f=a.done;a=a.value;return f?(f=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,20])],d[2]=f[0],d[3]=f[1],d[4]=f[2],d[5]=f[3],d[6]=f[4],d[7]=f[5],d[8]=f[6],d[9]=f[7],d[10]=f[8],d[11]=f[9],d[12]=f[10],d[13]=f[11],d[14]=f[12],d[15]=f[13],d[16]=f[14],d[17]=f[15],f):(e=a.item,c.sequence([function(a){return d[31]=e.backupTenancy,d[30]=e.encryptionVersion,d[26]=void 0,c.i64.neq(d[26],void 0)?c.resolve(d[27]=d[26]):c.sequence([function(a){return d[32]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[33]=a[0],a})},function(a){return d[33]?d[42]=(d[32].push(c.i64.cast([0,0])),d[32]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[34]=a[0],a})},function(a){return d[34]?d[42]=(d[32].push(c.i64.cast([0,2])),d[32]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[35]=a[0],a})},function(a){return d[35]?d[42]=(d[32].push(c.i64.cast([0,3])),d[32]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[36]=a[0],a})},function(a){return d[36]?d[42]=(d[32].push(c.i64.cast([0,4])),d[32]):0,d[37]=c.createArray(),d[38]=c.i64.of_int32(d[32].length),c.i64.gt(d[38],c.i64.cast([0,0]))?c.loopAsync(d[38],function(a){return d[42]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[32],d[42]).then(function(a){return a=a,d[43]=a[0],d[44]=a[1],a})},function(a){return d[45]=(d[37].push(d[43]),d[37])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[42]=c.createArray(),d[43]=c.i64.of_int32(d[37].length),c.i64.gt(d[43],c.i64.cast([0,0]))?c.loopAsync(d[43],function(a){return d[45]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[37],d[45]).then(function(a){return a=a,d[46]=a[0],d[47]=a[1],a})},function(a){return d[48]=(d[42].push(c.i64.to_string(d[46])),d[42])}])}):c.resolve()},function(a){return d[44]=d[42].join(","),d[39]=d[44]}])},function(a){return d[37].some(function(a){return c.i64.eq(d[30],a)})?d[40]=d[30]:d[40]=void 0,c.i64.neq(d[40],void 0)?d[41]=d[40]:d[41]=void 0,d[27]=d[41]}])},function(a){return c.i64.neq(d[27],void 0)?d[28]=d[27]:d[28]=c.i64.cast([0,0]),c.i64.neq(d[31],void 0)?d[29]=d[31]:d[29]=c.i64.cast([0,1]),a=[e.backupId,e.deviceId,e.mailboxRootKeyBlob,e.ocmfClientStateBlob,void 0,void 0,d[28],d[29],e.epochAuthPublicKeyBlob,e.epochAuthPrivateKeyBlob,e.devicePublicKeyBlob,e.devicePrivateKeyBlob,e.epochStoragePublicKeyBlob,e.epochStoragePrivateKeyBlob,e.obliviousValidationTokenBlob,e.authorityLevel],d[2]=a[0],d[3]=a[1],d[4]=a[2],d[5]=a[3],d[6]=a[4],d[7]=a[5],d[8]=a[6],d[9]=a[7],d[10]=a[8],d[11]=a[9],d[12]=a[10],d[13]=a[11],d[14]=a[12],d[15]=a[13],d[16]=a[14],d[17]=a[15],a}]))})},function(a){return c.storedProcedure(b("LSFindBackup")).then(function(a){return a=a,d[19]=a[0],a})},function(e){return c.blobs.neq(d[5],void 0)?c.i64.neq(d[3],void 0)?d[19]!==void 0?c.blobs.neq(d[4],void 0)?c.sequence([function(e){return d[26]=c.createArray(),d[33]=(d[26].push(d[19]),d[26]),d[33]=(d[26].push(a[1]),d[26]),d[27]=c.toJSON(d[26]),d[28]=c.createArray(),d[33]=(d[28].push(c.i64.cast([0,32])),d[28]),c.nativeOperation(b("LSGetBlobFromString.nop"),["thread_ope_key","_",a[5]].join("")).then(function(a){return a=a,d[29]=a[0],a})},function(a){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),d[29],void 0,d[4],d[28]).then(function(a){return a=a,d[30]=a[0],a})},function(a){return d[30]?d[31]=!1:d[31]=!0,d[31]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] Got null keys while deriving message list OPE key. Returning null blobish"),d[33]=c.createArray(),void 0!==void 0?d[34]=(d[33].push(void 0),d[33]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","Got null keys while deriving message list OPE key. Returning null blobish",d[33],c.i64.cast([0,3]))},function(a){return d[32]=void 0}]):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[30],c.i64.cast([0,0])).then(function(a){return a=a,d[33]=a[0],d[34]=a[1],a})},function(a){return d[32]=d[33]}])},function(e){return c.blobs.neq(d[32],void 0)?c.sequence([function(e){return c.i64.neq(a[9],void 0)?d[33]=a[9]:d[33]=c.i64.cast([-1,4294967295]),c.nativeOperation(b("LSGetBlobFromInt64BE.nop"),a[6]).then(function(a){return a=a,d[34]=a[0],a})},function(a){return c.nativeOperation(b("LSTruncateSortKey.nop"),d[34]).then(function(a){return a=a,d[35]=a[0],a})},function(a){return c.nativeOperation(b("LSOpeEncrypt.nop"),d[32],d[35],c.i64.cast([0,16])).then(function(a){return a=a,d[36]=a[0],a})},function(a){return c.nativeOperation(b("LSBinaryToHex.nop"),d[36]).then(function(a){return a=a,d[37]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),d[27]).then(function(a){return a=a,d[38]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2NvcGU="),d[38]).then(function(a){return a=a,d[39]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[39]).then(function(a){return a=a,d[40]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[40]).then(function(a){return a=a,d[41]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),d[19]).then(function(a){return a=a,d[42]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWFpbGJveF9pZF9zY29wZQ=="),d[42]).then(function(a){return a=a,d[43]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[43]).then(function(a){return a=a,d[44]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[44]).then(function(a){return a=a,d[45]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[4]).then(function(a){return a=a,d[46]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWVzc2FnZV9pZF9zY29wZQ=="),d[46]).then(function(a){return a=a,d[47]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[47]).then(function(a){return a=a,d[48]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[48]).then(function(a){return a=a,d[49]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[4]).then(function(a){return a=a,d[50]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[50]).then(function(a){return a=a,d[51]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[51]).then(function(a){return a=a,d[52]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[52]).then(function(a){return a=a,d[53]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[5]).then(function(a){return a=a,d[54]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("dGhyZWFkX2lkX3Njb3Bl"),d[54]).then(function(a){return a=a,d[55]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[55]).then(function(a){return a=a,d[56]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[56]).then(function(a){return a=a,d[57]=a[0],a})},function(e){return d[58]=new c.Map(),d[58].set("attachment_index_key",d[41]==null?"":d[41]),d[58].set("backup_ent_fbid",a[0]),d[58].set("delivery_object_id",a[1]),d[58].set("device_id",d[3]),d[58].set("mailbox_partial_id",d[45]==null?"":d[45]),d[58].set("media_type",a[3]),d[58].set("message_partial_id",d[49]==null?"":d[49]),d[58].set("product_type",a[2]),d[58].set("salt_partial_id",d[53]==null?"":d[53]),d[58].set("sort_key",d[37]==null?"":d[37]),d[58].set("thread_partial_id",d[57]==null?"":d[57]),d[58].set("trace_id",d[1]),d[58].set("source",d[33]),d[59]=new c.Map(),d[59].set("otid",a[4]),d[59].set("server_thread_key",a[8]),d[59].set("timestamp",c.i64.to_string(a[6])),c.nativeOperation(b("LSBase64Encode.nop"),d[5]).then(function(a){return a=a,d[60]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[4]).then(function(a){return a=a,d[61]=a[0],a})},function(e){return d[62]=new c.Map(),d[62].set("ocmf_client_state_blob",d[60]==null?"":d[60]),d[62].set("mailbox_root_key",d[61]==null?"":d[61]),d[63]=c.createArray(),d[75]=(d[63].push(a[4]),d[63]),d[75]=(d[63].push(a[1]),d[63]),d[64]=c.toJSON(d[63]),d[58].set("raw_identifiers",d[59]),d[58].set("backup_id",d[19]),d[58].set("thread_id",a[5]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[64]).then(function(a){return a=a,d[65]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[65]).then(function(a){return a=a,d[66]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[66]).then(function(a){return a=a,d[67]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[67]).then(function(a){return a=a,d[68]=a[0],a})},function(a){return d[58].set("salt_partial_access_token",d[68]==null?"":d[68]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[27]).then(function(a){return a=a,d[69]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2FsdF9zY29wZQ=="),d[69]).then(function(a){return a=a,d[70]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[70]).then(function(a){return a=a,d[71]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[71]).then(function(a){return a=a,d[72]=a[0],a})},function(a){return d[58].set("salt_partial_attachment_index_key",d[72]==null?"":d[72]),d[58].set("raw_tokens",d[62]),d[73]=c.toJSON(d[58]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_attachment_restore",c.i64.cast([0,50020]),d[73],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),d[1],c.i64.cast([0,0])).then(function(a){return a=a,d[74]=a[0],a})}]):(d[33]="OPE key is null for IssueAttachmentRestoreTask",d[33]!==void 0?c.sequence([function(a){return d[35]=["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",d[33]].join(""),function(a){c.logger(a).mustfix(a)}(d[35]),d[34]=c.createArray(),d[1]!==void 0?d[36]=(d[34].push(d[1]),d[34]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure",d[33],d[34],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),d[35],void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[38]=a[0],a})},function(a){return d[38]?d[39]=!0:d[39]=!1,d[39]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[40]=c.createArray(),void 0!==void 0?d[41]=(d[40].push(void 0),d[40]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[40],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[36]=a[0],a})},function(a){return d[36]?d[37]=!0:d[37]=!1,d[37]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[38]=c.createArray(),void 0!==void 0?d[39]=(d[38].push(void 0),d[38]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[38],c.i64.cast([0,3]))):c.resolve()}])}]):c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",""].join(""),void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[36]=a[0],a})},function(a){return d[36]?d[37]=!0:d[37]=!1,d[37]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[38]=c.createArray(),void 0!==void 0?d[39]=(d[38].push(void 0),d[38]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[38],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[34]=a[0],a})},function(a){return d[34]?d[35]=!0:d[35]=!1,d[35]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[36]=c.createArray(),void 0!==void 0?d[37]=(d[36].push(void 0),d[36]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[36],c.i64.cast([0,3]))):c.resolve()}]))}]):(d[26]="Missing mailbox_root_key for IssueAttachmentRestoreTask",d[26]!==void 0?c.sequence([function(a){return d[28]=["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",d[26]].join(""),function(a){c.logger(a).mustfix(a)}(d[28]),d[27]=c.createArray(),d[1]!==void 0?d[29]=(d[27].push(d[1]),d[27]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure",d[26],d[27],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),d[28],void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[31]=a[0],a})},function(a){return d[31]?d[32]=!0:d[32]=!1,d[32]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[33]=c.createArray(),void 0!==void 0?d[34]=(d[33].push(void 0),d[33]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[33],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[29]=a[0],a})},function(a){return d[29]?d[30]=!0:d[30]=!1,d[30]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[31]=c.createArray(),void 0!==void 0?d[32]=(d[31].push(void 0),d[31]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[31],c.i64.cast([0,3]))):c.resolve()}])}]):c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",""].join(""),void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[29]=a[0],a})},function(a){return d[29]?d[30]=!0:d[30]=!1,d[30]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[31]=c.createArray(),void 0!==void 0?d[32]=(d[31].push(void 0),d[31]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[31],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[27]=a[0],a})},function(a){return d[27]?d[28]=!0:d[28]=!1,d[28]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[29]=c.createArray(),void 0!==void 0?d[30]=(d[29].push(void 0),d[29]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[29],c.i64.cast([0,3]))):c.resolve()}])):(d[26]="Missing backup_id for IssueAttachmentRestoreTask",d[26]!==void 0?c.sequence([function(a){return d[28]=["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",d[26]].join(""),function(a){c.logger(a).mustfix(a)}(d[28]),d[27]=c.createArray(),d[1]!==void 0?d[29]=(d[27].push(d[1]),d[27]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure",d[26],d[27],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),d[28],void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[31]=a[0],a})},function(a){return d[31]?d[32]=!0:d[32]=!1,d[32]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[33]=c.createArray(),void 0!==void 0?d[34]=(d[33].push(void 0),d[33]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[33],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[29]=a[0],a})},function(a){return d[29]?d[30]=!0:d[30]=!1,d[30]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[31]=c.createArray(),void 0!==void 0?d[32]=(d[31].push(void 0),d[31]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[31],c.i64.cast([0,3]))):c.resolve()}])}]):c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",""].join(""),void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[29]=a[0],a})},function(a){return d[29]?d[30]=!0:d[30]=!1,d[30]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[31]=c.createArray(),void 0!==void 0?d[32]=(d[31].push(void 0),d[31]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[31],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[27]=a[0],a})},function(a){return d[27]?d[28]=!0:d[28]=!1,d[28]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[29]=c.createArray(),void 0!==void 0?d[30]=(d[29].push(void 0),d[29]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[29],c.i64.cast([0,3]))):c.resolve()}])):(d[26]="Missing device_id for IssueAttachmentRestoreTask",d[26]!==void 0?c.sequence([function(a){return d[28]=["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",d[26]].join(""),function(a){c.logger(a).mustfix(a)}(d[28]),d[27]=c.createArray(),d[1]!==void 0?d[29]=(d[27].push(d[1]),d[27]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure",d[26],d[27],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),d[28],void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[31]=a[0],a})},function(a){return d[31]?d[32]=!0:d[32]=!1,d[32]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[33]=c.createArray(),void 0!==void 0?d[34]=(d[33].push(void 0),d[33]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[33],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[29]=a[0],a})},function(a){return d[29]?d[30]=!0:d[30]=!1,d[30]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[31]=c.createArray(),void 0!==void 0?d[32]=(d[31].push(void 0),d[31]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[31],c.i64.cast([0,3]))):c.resolve()}])}]):c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",""].join(""),void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[29]=a[0],a})},function(a){return d[29]?d[30]=!0:d[30]=!1,d[30]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[31]=c.createArray(),void 0!==void 0?d[32]=(d[31].push(void 0),d[31]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[31],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[27]=a[0],a})},function(a){return d[27]?d[28]=!0:d[28]=!1,d[28]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[29]=c.createArray(),void 0!==void 0?d[30]=(d[29].push(void 0),d[29]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[29],c.i64.cast([0,3]))):c.resolve()}])):(d[26]="Missing ocmf_client_state_blob for IssueAttachmentRestoreTask",d[26]!==void 0?c.sequence([function(a){return d[28]=["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",d[26]].join(""),function(a){c.logger(a).mustfix(a)}(d[28]),d[27]=c.createArray(),d[1]!==void 0?d[29]=(d[27].push(d[1]),d[27]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure",d[26],d[27],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),d[28],void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[31]=a[0],a})},function(a){return d[31]?d[32]=!0:d[32]=!1,d[32]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[33]=c.createArray(),void 0!==void 0?d[34]=(d[33].push(void 0),d[33]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[33],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[29]=a[0],a})},function(a){return d[29]?d[30]=!0:d[30]=!1,d[30]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[31]=c.createArray(),void 0!==void 0?d[32]=(d[31].push(void 0),d[31]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[31],c.i64.cast([0,3]))):c.resolve()}])}]):c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",""].join(""),void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[29]=a[0],a})},function(a){return d[29]?d[30]=!0:d[30]=!1,d[30]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[31]=c.createArray(),void 0!==void 0?d[32]=(d[31].push(void 0),d[31]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[31],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[27]=a[0],a})},function(a){return d[27]?d[28]=!0:d[28]=!1,d[28]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[29]=c.createArray(),void 0!==void 0?d[30]=(d[29].push(void 0),d[29]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[29],c.i64.cast([0,3]))):c.resolve()}]))},function(a){return d[20]=c.i64.of_float(Date.now()),d[21]=c.i64.random(),d[23]="Finishing execution. Execution time: ",d[24]=c.i64.to_string(c.i64.sub(d[20],d[0])),d[25]=" ms",d[22]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ",d[22],d[23],d[22],d[24],d[22],d[25]].join("")),c.i64.eq(c.i64.mod_(d[21],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[26]=",",d[27]=c.createArray(),void 0!==void 0?d[28]=(d[27].push(void 0),d[27]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure",[d[23],d[26],d[24],d[26],d[25]].join(""),d[27],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure";e.exports=a}),null);
__d("LSIssueAttachmentRestoreTaskStoredProcedure",["LSIssueAttachmentRestoreTask","cr:8709"],(function(a,b,c,d,e,f,g){function a(a,b){var d=[];d[0]=b.backupEntFbid;d[1]=b.deliveryObjectId;d[2]=b.productType;d[3]=b.mediaType;d[4]=b.messageId;d[5]=b.threadId;d[6]=b.sortOrder;d[7]=b.traceId;d[8]=b.serverThreadKey;d[9]=b.source;return c("LSIssueAttachmentRestoreTask").apply(void 0,d.concat([a]))}g["default"]=a}),98);
__d("MAWBridgeResignAttachmentCDNUrlHandler",["I64","LSFactory","LSIssueAttachmentRestoreTaskStoredProcedure","MAWMiActOnMiThreadReadyForJid","Promise","QPLUserFlow","WAHashStringToNumber","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j="-8";function a(a,e){return d("MAWMiActOnMiThreadReadyForJid").onMiThreadReadyForJid(a,e.threadJid,"MAWBridgeResignAttachmentCDNUrlHandler",function(a,f){var g=j;if(g==null)return(i||(i=b("Promise"))).resolve();g=(h||(h=d("I64"))).of_string(g);f=h.to_string(f);var k=e.traceId;g={backupEntFbid:g,deliveryObjectId:e.deliveryObjectId,mediaType:e.mediaType,messageId:e.messageId,productType:e.productType,serverThreadKey:f,sortOrder:h.of_float(e.sortOrder),threadId:e.threadId};if(k!=null){f=d("WAHashStringToNumber").hashStringToNumber(k);c("QPLUserFlow").addPoint(c("qpl")._(521485815,"2166"),"issue_attachment_task",{instanceKey:f});return c("LSIssueAttachmentRestoreTaskStoredProcedure")(c("LSFactory")(a),babelHelpers["extends"]({},g,{traceId:k}))}else return c("LSIssueAttachmentRestoreTaskStoredProcedure")(c("LSFactory")(a),g)})}g.call=a}),98);/*FB_PKG_DELIM*/
__d("GroupsCometCoverPhotoPickerDialogQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="7192251780826661"}),null);
__d("WAAPIDeferred",["WAAPIMetrics","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h=(a=c("requireDeferred"))("WABulkSetRotateSenderKeyToTrueApi").__setRef("WAAPIDeferred"),i=a("WADbRegistrationApi").__setRef("WAAPIDeferred"),j=a("WADownloadMedia").__setRef("WAAPIDeferred"),k=a("WAGenerateAndUploadPreKeys").__setRef("WAAPIDeferred"),l=a("WAGetCurrentUserDeviceList").__setRef("WAAPIDeferred"),m=a("WAGetDevices").__setRef("WAAPIDeferred"),n=a("WANotifyDeviceChange").__setRef("WAAPIDeferred"),o=a("WAPreEstablishOutgoingSessionForGroup").__setRef("WAAPIDeferred"),p=a("WAQueryGroups").__setRef("WAAPIDeferred"),q=a("WARemoveCurrentDevice").__setRef("WAAPIDeferred"),r=a("WARemoveDevice").__setRef("WAAPIDeferred"),s=a("WASendAppDataFanoutProtocol").__setRef("WAAPIDeferred"),t=a("WASendMsgUtilV2").__setRef("WAAPIDeferred"),u=a("WASendPing").__setRef("WAAPIDeferred"),v=a("WASyncAbProps").__setRef("WAAPIDeferred"),w=a("WAUploadMedia").__setRef("WAAPIDeferred");b={getCurrentUserDeviceList:function(){return l.load().then(function(a){return d("WAAPIMetrics").withMetrics(a.getCurrentUserDeviceList,"getCurrentUserDeviceList")()})},syncAbProps:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return v.load().then(function(a){return d("WAAPIMetrics").withMetrics(a.syncAbProps,"syncAbProps").apply(void 0,b)})},generateAndUploadPreKeys:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return k.load().then(function(a){return d("WAAPIMetrics").withMetrics(a.generateAndUploadPreKeys,"generateAndUploadPreKeys",{bool:{deferred_load:!0}}).apply(void 0,b)})},getDevicesBeforeSend:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return t.load().then(function(a){a=a.getDevicesBeforeSend;return d("WAAPIMetrics").withMetrics(a,"getDevicesBeforeSend",{bool:{deferred_load:!0}}).apply(void 0,b)})},preEstablishSession:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return o.load().then(function(a){return d("WAAPIMetrics").withMetrics(a.preEstablishSession,"preEstablishSession",{bool:{deferred_load:!0}}).apply(void 0,b)})},sendChatMessage:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return t.load().then(function(a){a=a.sendChatMessage;return d("WAAPIMetrics").withMetrics(a,"sendChatMessage",{bool:{deferred_load:!0}}).apply(void 0,b)})},updateClockSkew:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return u.load().then(function(a){return d("WAAPIMetrics").withMetrics(a.updateClockSkew,"updateClockSkew",{bool:{deferred_load:!0}}).apply(void 0,b)})},queryGroups:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return p.load().then(function(a){return d("WAAPIMetrics").withMetrics(a.queryGroups,"queryGroups",{bool:{deferred_load:!0}}).apply(void 0,b)})},getDevices:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return m.load().then(function(a){return d("WAAPIMetrics").withMetrics(a.getDevices,"getDevices",{bool:{deferred_load:!0}}).apply(void 0,b)})},removeDevice:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return r.load().then(function(a){return d("WAAPIMetrics").withMetrics(a.removeDevice,"=>",{bool:{deferred_load:!0}}).apply(void 0,b)})},removeCurrentDevice:function(){return q.load().then(function(a){return d("WAAPIMetrics").withMetrics(a.removeCurrentDevice,"removeCurrentDevice",{bool:{deferred_load:!0}})()})},notifyDeviceChange:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return n.load().then(function(a){return d("WAAPIMetrics").withMetrics(a.notifyDeviceChange,"notifyDeviceChange",{bool:{deferred_load:!0}}).apply(void 0,b)})},saveLastSessionDeviceWasLinkedTo:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return i.load().then(function(a){return d("WAAPIMetrics").withMetrics(a.saveLastSessionDeviceWasLinkedTo,"saveLastSessionDeviceWasLinkedTo").apply(void 0,b)})},sendAppData:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return s.load().then(function(a){return d("WAAPIMetrics").withMetrics(a.sendAppDataToDevicesProtocol,"sendAppData",{bool:{deferred_load:!0}}).apply(void 0,b)})},setRotateSenderKeyToTrue:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return h.load().then(function(a){return d("WAAPIMetrics").withMetrics(a.bulkSetRotateSenderKeyToTrue,"setRotateSenderKeyToTrue").apply(void 0,b)})},uploadMedia:function(a){return w.load().then(function(b){return b.uploadMedia(a)})},downloadMedia:function(a){return j.load().then(function(b){return b.downloadMedia(a)})},cachedDownloadFullMediaOnly:function(a){return j.load().then(function(b){return b.cachedDownloadFullMediaOnly(a)})}};e=b;g["default"]=e}),98);/*FB_PKG_DELIM*/
__d("MAWHandleXmaTransactionUtil",["MAWBridgeXMA","MAWDbChunkTxns","MAWDexieCastToPromise","MAWIndexedDb","MAWTransactionMode","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=!1;a!=null&&b.defaultPreviewMediaId===a.mediaId&&(c=(yield l(a)));return d("MAWBridgeXMA").createBridgeXMA(a,b,c)});return h.apply(this,arguments)}function c(a,b,c){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){a=(yield j(a,b,c));d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:a})});return i.apply(this,arguments)}function j(a,b,c){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){var e=!1;a!=null&&(e=(yield d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDbChunkTxns").hasMediaChunk(c,a.hashedPlaintextHash))));return d("MAWBridgeXMA").createBridgeXMA(a,b,e)});return k.apply(this,arguments)}var l=d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY},"MAWHandleXmaTransactionUtil.hasMediaChunkTransaction",function(a){return function(b){return d("MAWDbChunkTxns").hasMediaChunk(a,b.hashedPlaintextHash)}});g.checkMediaChunkTransactionAndCreatedBridgeXma=a;g.checkMediaChunkAndHandleXmaAfterTransaction=c;g.checkMediaChunkAndCreatedBridgeXma=j}),98);
__d("WAGetPlatformFromStanzaId",["I64","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to parse stanza id "," for platform: ",""]);i=function(){return a};return a}function a(a){try{var b=(h||(h=d("I64"))).of_float(4063232),c=h.of_float(0),e=h.of_float(131072);b=h.and_(h.of_string(a),b);if((h||(h=d("I64"))).equal(b,c))return"web";return(h||(h=d("I64"))).equal(b,e)?"mobile":"unknown"}catch(b){d("WALogger").ERROR(i(),a,b);return"error"}}g.getPlatformFromStanzaId=a}),98);